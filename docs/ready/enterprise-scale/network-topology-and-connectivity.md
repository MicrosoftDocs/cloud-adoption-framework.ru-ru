---
title: Топология сети и возможности подключения
description: Изучите ключевые вопросы и рекомендации по проектированию сети и подключения к Microsoft Azure.
author: BrianBlanchard
ms.author: brblanch
ms.date: 06/15/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: ready
ms.custom: think-tank
ms.openlocfilehash: 81ab318f69a67baa00a9e55c230e8fb443354ae7
ms.sourcegitcommit: d957bfc1fa8dc81168ce9c7d801a8dca6254c6eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2020
ms.locfileid: "95446867"
---
<!-- docutune:casing "Azure VPN Gateway" L7 -->
<!-- cSpell:ignore autoregistration BGPs MACsec MPLS MSEE onprem privatelink VPNs -->

# <a name="network-topology-and-connectivity"></a>Топология сети и возможности подключения

В этой статье рассматриваются основные вопросы и рекомендации по проектированию сети и подключения к Microsoft Azure.

## <a name="plan-for-ip-addressing"></a>Планирование IP-адресации

Важно, чтобы ваша организация запланировать IP-адресацию в Azure, чтобы пространство IP-адресов не перекрывались между локальными расположениями и регионами Azure.

**Рекомендации по проектированию:**

- Перекрывающиеся пространства IP-адресов в локальной среде и регионах Azure будут создавать серьезные проблемы с состязанием.

- Вы можете добавить адресное пространство после создания виртуальной сети. Этот процесс требует сбоя, если виртуальная сеть уже подключена к другой виртуальной сети через пиринг виртуальных сетей, так как пиринг необходимо удалить и создать заново.

- Azure резервирует пять IP-адресов в каждой подсети. Учитывайте эти адреса при определении размера виртуальных сетей и охватывающих подсетей.

- Для некоторых служб Azure требуются [выделенные подсети](/azure/virtual-network/virtual-network-for-azure-services#services-that-can-be-deployed-into-a-virtual-network). К этим службам относятся брандмауэр Azure и VPN-шлюз Azure.

- Вы можете делегировать подсети определенным службам для создания экземпляров службы в подсети.

**Рекомендации по проектированию:**

- Заранее спланируйте непересекающиеся пространства IP-адресов в регионах Azure и локальных расположениях.

- Используйте IP-адреса из выделения адресов для частных Интернета (RFC 1918).

- Для сред с ограниченным доступом к частным IP-адресам (RFC 1918) рекомендуется использовать IPv6.

- Не создавайте ненужные большие виртуальные сети (например, `/16` ), чтобы гарантировать, что пространство IP-адресов не будет занято.

- Не Создавайте виртуальные сети, не планируя требуемое адресное пространство заранее. Добавление адресного пространства приведет к сбою после подключения виртуальной сети через пиринг виртуальных сетей.

- Не используйте общедоступные IP-адреса для виртуальных сетей, особенно если общедоступные IP-адреса не принадлежат вашей организации.

## <a name="configure-dns-and-name-resolution-for-on-premises-and-azure-resources"></a>Настройка DNS и разрешения имен для локальных и ресурсов Azure

Служба доменных имен (DNS) является важнейшим разделом разработки в общей архитектуре корпоративного масштаба. Некоторым организациям может потребоваться использовать существующие вложения в DNS. Другие могут видеть внедрение облака как возможность модернизировать свою внутреннюю инфраструктуру DNS и использовать собственные возможности Azure.

**Рекомендации по проектированию:**

- Вы можете использовать сопоставитель DNS в сочетании с Azure Частная зона DNS для разрешения имен в нескольких локальных средах.

- Вам может потребоваться использовать существующие решения DNS в локальной среде и Azure.

- Максимальное число частных зон DNS, с которыми виртуальная сеть может связаться с автоматической регистрацией, — это один из них.

- Максимальное число частных зон DNS, с которыми может быть связана виртуальная сеть, — 1 000 без автоматической регистрации.

**Рекомендации по проектированию:**

- Для сред, где разрешение имен в Azure является обязательным, используйте Частная зона DNS Azure для разрешения. Создайте делегированную зону для разрешения имен (например, `azure.contoso.com` ).

- Для сред, где требуется разрешение имен в Azure и локальную среду, используйте существующую инфраструктуру DNS (например, Active Directory интегрированную службу DNS), развернутую по крайней мере на двух виртуальных машинах (ВМ). Настройте параметры DNS в виртуальных сетях, чтобы использовать эти DNS-серверы.

- Вы по-прежнему можете связать зону Частная зона DNS Azure с виртуальными сетями и использовать DNS-серверы в качестве гибридных арбитров конфликтов с условным перенаправлением в локальные DNS-имена, такие как `onprem.contoso.com` , с помощью локальных DNS-серверов. Вы можете настроить локальные серверы с условными пересылками на виртуальные машины сопоставителя в Azure для зоны Частная зона DNS Azure (например, `azure.contoso.com` ).

- Особые рабочие нагрузки, требующие и развертывающие собственные DNS (например, Red Hat OpenShift), должны использовать предпочтительное решение DNS.

- Включите автоматическую регистрацию для Azure DNS, чтобы автоматически управлять жизненным циклом записей DNS для виртуальных машин, развернутых в виртуальной сети.

- Используйте виртуальную машину как сопоставитель для междоменного разрешения имен DNS с помощью Azure Частная зона DNS.

- Создайте зону Частная зона DNS Azure в глобальной подписке с подключением. Вы можете создать другие зоны Частная зона DNS Azure (например, `privatelink.database.windows.net` или `privatelink.blob.core.windows.net` для частной связи Azure).

## <a name="define-an-azure-network-topology"></a>Определение топологии сети Azure

Топология сети является важнейшим элементом архитектуры корпоративного уровня, так как он определяет, как приложения могут взаимодействовать друг с другом. В этом разделе рассматриваются технологии и подходы к топологии для развертываний Azure Enterprise. Он посвящен двум основным подходам: топологии на основе виртуальной глобальной сети Azure и традиционных топологий.

Используйте топологию сети на основе виртуальной глобальной сети Azure, если выполняется одно из следующих условий.

- Ваша организация планирует развертывать ресурсы в нескольких регионах Azure и подключать свои глобальные расположения как к Azure, так и к локальной среде.
- Ваша организация намеревается использовать программно-определяемые развертывания глобальной сети (SD-WAN), полностью интегрированные с Azure.
- Вы планируете развернуть до 2 000 рабочих нагрузок виртуальных машин во всех виртуальных сетей, подключенных к одному виртуальному концентратору глобальной сети Azure.

Виртуальная глобальная сеть используется для удовлетворения требований к крупномасштабному взаимосоединению. Поскольку это служба, управляемая корпорацией Майкрософт, она также сокращает общую сложность сети и помогает модернизировать сеть Организации.

Используйте традиционную топологию сети Azure, если выполняется одно из следующих условий.

- Ваша организация планирует развертывать ресурсы в нескольких регионах Azure.
- Вы можете использовать пиринг глобальной виртуальной сети для подключения виртуальных сетей между регионами Azure.
- У вас малое количество удаленных или филиалов по регионам. То есть требуется менее 30 туннелей IP-безопасности (IPsec).
- Для ручной настройки сети Azure требуется полный контроль и детализация.

Традиционная топология сети помогает создать безопасную сеть крупного масштаба в Azure.

## <a name="virtual-wan-network-topology-microsoft-managed"></a>Топология сети виртуальной глобальной сети (под управлением Майкрософт)

![Схема, иллюстрирующая топологию виртуальной глобальной сети. ](./media/virtual-wan-topology.png)
 _Рис. 1. топология ВИРТУАЛЬНОЙ глобальной сети._

**Рекомендации по проектированию:**

- [Виртуальная глобальная сеть Azure](/azure/virtual-wan/virtual-wan-about) — это решение, управляемое корпорацией Майкрософт, которое по умолчанию обеспечивает сквозное глобальное транзитное подключение. Концентраторы Виртуальной глобальной сети позволяют не настраивать сетевое подключение вручную. Например, вам не нужно настраивать определяемую пользователем маршрутизацию (UDR) или сетевые виртуальные устройства (NVA), чтобы обеспечить возможность глобального транзитного подключения.

- Виртуальная глобальная сеть значительно упрощает сквозное сетевое подключение в Azure и распределенное развертывание, создавая [архитектуру сети](/azure/virtual-wan/virtual-wan-global-transit-network-architecture)типа "звезда". Архитектура охватывает несколько регионов Azure и локальных расположений (любое подключение), как показано на рисунке ниже.

  ![Схема, иллюстрирующая глобальную транзитную сеть с виртуальной глобальной сетью. ](./media/global-transit.png)
   _Рис. 2. Глобальная транзитная сеть с ВИРТУАЛЬНОЙ глобальной сетью._

- Виртуальная глобальная сеть с любыми транзитивными подключениями поддерживает следующие пути (в одном и том же регионе и в разных регионах):

  - Виртуальная сеть с виртуальной сетью
  - Виртуальная сеть — ветвь
  - Переход к виртуальной сети
  - Ветвь к ветви

- Виртуальные концентраторы глобальной сети заблокированы. Единственными развертываемыми в них ресурсами являются шлюзы виртуальной сети (VPN типа "точка — сеть", VPN-подключение типа "сеть — сеть" и Azure ExpressRoute), брандмауэр Azure через диспетчер брандмауэра и таблицы маршрутов.

- Виртуальная глобальная сеть увеличивает ограничение до 200 префиксов, объявленных из Azure в локальную среду с помощью частного пиринга ExpressRoute, до префиксов 10 000 на виртуальный концентратор глобальной сети. В число префиксов 10 000 также входит VPN типа "сеть — сеть" и VPN-подключение "точка — сеть".

- Теперь в общем доступе доступно транзитивное подключение "сеть — сеть" (в регионе и в разных регионах).

- Подключение между концентраторами виртуальных глобальных сетей теперь находится в общем доступе.

- Транзитное подключение между виртуальными сетями в стандартной виртуальной глобальной сети включено из-за наличия маршрутизатора в каждом виртуальном концентраторе. Каждый маршрутизатор виртуального концентратора поддерживает общую пропускную способность до 50 Гбит/с.

- В одном виртуальном концентраторе глобальной сети можно подключить не более 2 000 рабочих нагрузок виртуальных машин ко всем виртуальных сетей.

- Виртуальная глобальная сеть интегрируется с различными [поставщиками SD-WAN](/azure/virtual-wan/virtual-wan-locations-partners).

- Многие поставщики управляемых служб предлагают [управляемые службы](/azure/networking/networking-partners-msp) для виртуальной глобальной сети.

- VPN-шлюзы в виртуальной глобальной сети могут масштабировать до 20 Гбит/с и 20 000 подключений на виртуальный концентратор.

- Требуются каналы ExpressRoute с надстройкой "Премиум". Они должны быть из расположения Global Reach ExpressRoute.

- Теперь Диспетчер брандмауэра Azure в общем доступе позволяет развернуть брандмауэр Azure в виртуальном концентраторе глобальной сети.

- Трафик концентратора виртуальной глобальной сети через брандмауэр Azure в настоящее время не поддерживается. В качестве альтернативы можно использовать собственные возможности маршрутизации транзитного концентратора в виртуальную глобальную сеть. Используйте группы безопасности сети (группы безопасности сети), чтобы разрешить или заблокировать трафик виртуальной сети между концентраторами.

**Рекомендации по проектированию:**

- Мы рекомендуем виртуальную глобальную сеть Azure для новых крупномасштабных или глобальных сетевых развертываний в Azure, где требуется глобальное транзитное подключение между регионами Azure и локальными расположениями. Таким образом, вам не нужно вручную настраивать транзитную маршрутизацию для сетей Azure.

  На следующем рисунке показан пример глобального корпоративного развертывания с центрами обработки данных, распределенными по Европе и США. Развертывание также имеет большое количество филиалов в обоих регионах. Окружение глобально подключено через виртуальную сеть WAN и Global Reach ExpressRoute.

  ![Схема примера топологии сети. ](./media/global-reach-topology.png)
   _Рис. 3. Пример топологии сети._

- Используйте виртуальную глобальную сеть в качестве глобального ресурса подключения. Используйте виртуальный концентратор глобальной сети для каждого региона Azure, чтобы подключить несколько целевых зон между регионами Azure через локальный виртуальный концентратор глобальной сети.

- Подключите виртуальные глобальные концентраторы к локальным центрам обработки данных с помощью ExpressRoute.

- Развертывание требуемых общих служб, таких как DNS-серверы, в выделенной целевой зоне. Требуемые общие ресурсы нельзя развернуть в виртуальном концентраторе глобальной сети.

- Подключите ветви и удаленные расположения к ближайшему виртуальному концентратору глобальной сети через VPN типа "сеть — сеть" или включите подключение филиала к виртуальной глобальной сети через партнерское решение SD-WAN.

- Подключите пользователей к виртуальному концентратору глобальной сети через VPN-подключение типа "точка — сеть".

- Следуйте принципу "трафик в Azure остается в Azure", чтобы обмен данными между ресурсами в Azure осуществляется через магистральную сеть Майкрософт, даже если ресурсы находятся в разных регионах.

- Разверните брандмауэр Azure в виртуальном глобальном концентраторе для защиты трафика Восточной/Западной и Южной/северных сетей и фильтрацию в регионе Azure.

- Если партнер NVA требуется для защиты трафика Восточной и Западной стран, а также для фильтрации в Южной/Северной сети, разверните NVA в отдельную виртуальную сеть, например виртуальную сеть NVA. Подключите его к региональному виртуальному концентратору глобальной сети и зонам размещения, которым требуется доступ к NVA. Дополнительные сведения см. [в статье Создание таблицы маршрутов для NVA в виртуальной глобальной сети](/azure/virtual-wan/virtual-wan-route-table-portal).

- При развертывании технологий сетевых сетей и NVA, следуйте указаниям поставщика партнеров, чтобы убедиться в отсутствии конфликтующих конфигураций с сетью Azure.

- Не создавайте транзитную сеть поверх виртуальной глобальной сети Azure. Виртуальная глобальная сеть удовлетворяет требованиям к топологии сети, таким как возможность использовать сторонние NVA. Создание транзитной сети поверх виртуальной глобальной сети Azure будет избыточным и повысить сложность.

- Не используйте существующие локальные сети, такие как многопротокольное переключение меток (MPLS), для подключения ресурсов Azure между регионами Azure, так как сетевые технологии Azure поддерживают взаимодействие ресурсов Azure между регионами через Microsoft магистраль. Это обусловлено характеристиками производительности и бесперебойной работы магистрали Майкрософт, а также простотой маршрутизации. В этом предложении рассматриваются характеристики производительности и работоспособности магистрали Майкрософт. Он также способствует простоте маршрутизации.

- Сведения о сценариях серия статей Brownfield, в которых выполняется миграция из топологии сети типа "звезда", не основанной на виртуальной глобальной сети, см. [в статье миграция в виртуальную глобальную сеть Azure](/azure/virtual-wan/migrate-from-hub-spoke-topology).

- Создание виртуальной глобальной сети Azure и ресурсов брандмауэра Azure в рамках подписки на подключение.

- Не создавайте более 500 виртуальных сетевых подключений на виртуальный концентратор глобальной сети.

- Тщательно спланируйте развертывание и убедитесь, что архитектура сети находится в пределах [ограничений виртуальной глобальной сети Azure](/azure/azure-resource-manager/management/azure-subscription-service-limits#virtual-wan-limits).

## <a name="traditional-azure-networking-topology"></a>Традиционная топология сетей Azure

Хотя Виртуальная глобальная сеть предоставляет широкий спектр мощных возможностей, в некоторых случаях может быть оптимальным подходом к работе в сети Azure.

- Если глобальная транзитная сеть в нескольких регионах Azure или распределенная между организациями не требуется. Примером является ветвь в США, для которой требуется подключение к виртуальной сети в Европе.

- Если необходимо развернуть глобальную сеть в нескольких регионах Azure, можно использовать глобальную пиринг виртуальной сети для подключения виртуальных сетей между регионами.

- Если нет необходимости подключаться к большому количеству удаленных расположений через VPN или интеграцию с решением SD-WAN.

- Если в вашей организации требуется детальный контроль и настройка при настройке топологии сети в Azure.

![Схема, иллюстрирующая традиционную топологию сети Azure.](./media/customer-managed-topology.png)

_Рис. 4. Традиционная топология сети Azure._

**Рекомендации по проектированию:**

- Различные сетевые топологии могут подключаться к нескольким виртуальным сетям целевой зоны. Примерами могут служить одна крупная плоская виртуальная сеть, несколько виртуальных сетей, подключенных к нескольким каналам ExpressRoute или соединениям, центральную и периферийную, полную сеть и гибридные.

- Виртуальные сети не проходят через границы подписки. Однако можно обеспечить подключение между виртуальными сетями в разных подписках с помощью пиринга виртуальных сетей, канала ExpressRoute или VPN-шлюзов.

- Пиринг виртуальных сетей можно использовать для подключения виртуальных сетей в одном регионе, в разных регионах Azure, а также в разных клиентах Azure Active Directory (Azure AD).

- Пиринг виртуальной сети и пиринг глобальных виртуальных сетей не являются транзитивными. Определяемые пользователем маршруты и NVA необходимы для включения транзитной сети. Дополнительные сведения см. [в статье топология сети звезды в Azure](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke).

- Каналы ExpressRoute можно использовать для установления подключения между виртуальными сетями в рамках одного региона или с помощью надстройки уровня "Премиум" для подключения через геоэлектрические регионы. Учитывайте следующие моменты:

  - Сетевой трафик может столкнуться с большей задержкой, так как трафик должен хаирпин на маршрутизаторах Microsoft Enterprise (MSEE).

  - Пропускная способность будет ограничена номером SKU шлюза ExpressRoute.

  - Вы по-прежнему должны развертывать определяемые пользователем маршруты и управлять ими, если им требуется проверка или ведение журнала для трафика в виртуальных сетях.

- VPN-шлюзы с протоколом BGP являются транзитивными в Azure и локальной среде, но не перемещаются между шлюзами ExpressRoute.

- Если несколько каналов ExpressRoute подключены к одной виртуальной сети, используйте весовые коэффициенты подключений и методы BGP, чтобы обеспечить оптимальный путь для трафика между локальной средой и Azure. Дополнительные сведения см. в разделе [Оптимизация маршрутизации ExpressRoute](/azure/expressroute/expressroute-optimize-routing).

- Использование методик BGP для повлиять на маршрутизацию ExpressRoute — это конфигурация за пределами платформы Azure. Ваша организация или поставщик услуг подключения должны соответствующим образом настроить локальные маршрутизаторы.

- Каналы ExpressRoute с дополнительными компонентами уровня "Премиум" обеспечивают глобальную связь. Однако максимальное число подключений ExpressRoute на шлюз ExpressRoute равно четырем.

- Хотя максимальное число подключений пиринга к виртуальной сети на виртуальную сеть равно 500, максимальное число маршрутов, которые могут быть объявлены из Azure в локальную среду через частный пиринг ExpressRoute, — 200.

- Максимальная суммарная пропускная способность VPN-шлюза составляет 10 Гбит/с. Он поддерживает до 30 туннелей "сеть — сеть" или "между сетями".

**Рекомендации по проектированию:**

- Рассмотрим архитектуру сети, основанную на топологии сети hub-and-лучевой, с технологиями, не являющимися виртуальными WAN, в следующих сценариях:

  - Граница трафика в развертывании Azure находится в регионе Azure.

  - Сетевая архитектура охватывает несколько регионов Azure, и нет необходимости в транзитном подключении между виртуальными сетями для размещения зон в разных регионах.

  - Сетевая архитектура охватывает несколько регионов Azure, и пиринг глобальной виртуальной сети можно использовать для подключения виртуальных сетей между регионами Azure.

  - Нет необходимости в транзитном подключении между подключениями VPN и ExpressRoute.

  - Основной канал подключения между организациями — ExpressRoute, а число VPN-подключений — менее 30 на VPN-шлюз.

  - Существует зависимость от централизованного NVA и детальной маршрутизации.

- Для региональных развертываний в основном используется топология "звезда". Используйте виртуальные сети, размещенные в зоне размещения, которые подключаются с помощью пиринга виртуальных сетей к центральной виртуальной сети для распределенного подключения через ExpressRoute, VPN для подключения филиалов, периферийного подключения через NVA и определяемые пользователем маршруты и защиту исходящего трафика через Интернет через NVA. Эта топология показана на следующем рисунке. Это обеспечивает соответствующий контроль трафика для удовлетворения большинства требований к сегментации и проверке.

  ![Схема, на которой показана топология сети типа "звезда". ](./media/hub-and-spoke-topology.png)
   _Рис. 5. топология сети hub-and-лучевой._

- Используйте топологию нескольких виртуальных сетей, подключенных с несколькими каналами ExpressRoute, если выполняется одно из следующих условий.

  - Требуется высокий уровень изоляции.

  - Для конкретных подразделений требуется выделенная пропускная способность ExpressRoute.

  - Достигнуто максимальное число подключений на шлюз ExpressRoute (до четырех).

Эта топология показана на следующем рисунке.

  ![Схема, на которой показано несколько виртуальных сетей, подключенных с помощью нескольких каналов ExpressRoute.](./media/vnet-multiple-circuits.png)
  _Рис. 6. несколько виртуальных сетей, подключенных с несколькими каналами ExpressRoute._

- Разверните набор минимальных общих служб, включая шлюзы ExpressRoute, VPN-шлюзы (при необходимости), а также брандмауэр Azure или партнерскую NVA (при необходимости) в Центральной виртуальной сети. При необходимости также разверните Active Directory контроллеры домена и DNS-серверы.

- Разверните брандмауэр Azure или Партнерский NVA для защиты трафика "Восток/Западная" или "Южная/Северная", а также фильтрацию в Центральной виртуальной сети.

- При развертывании сетевых технологий или NVA партнерских сетей следуйте указаниям поставщика партнеров, чтобы убедиться в том, что:

  - Поставщик поддерживает развертывание.

  - Руководство предназначено для обеспечения высокой доступности и максимальной производительности.

  - Нет конфликтующих конфигураций с сетью Azure.

- Не развертывайте входящие NVA уровня 7, такие как шлюз приложений Azure, в качестве общей службы в Центральной виртуальной сети. Вместо этого разверните их вместе с приложением в соответствующих зонах размещения.

- Используйте существующую сеть, MPLS и SD-WAN для подключения расположений ветвей к корпоративному офису. Транзит в Azure между ExpressRoute и VPN-шлюзами не поддерживается.

- Для сетевых архитектур с несколькими топологиями "звезда" в регионах Azure используйте глобальную пиринг виртуальной сети для подключения виртуальных сетей "Главная — зона", когда небольшому количеству целевых зон требуется обмен данными между регионами. Этот подход обеспечивает такие преимущества, как высокая пропускная способность сети с помощью пиринга глобальных виртуальных сетей, как это разрешено SKU виртуальной машины. Однако он будет обходить Центральный NVA, если требуется проверка трафика или фильтрация. Это также регулируется [ограничениями для пиринга глобальных виртуальных сетей](/azure/virtual-network/virtual-network-peering-overview#constraints-for-peered-virtual-networks).

- При развертывании сетевой архитектуры с двумя и периферийными сетями в двух регионах Azure требуется транзитное подключение между всеми зонами в разных регионах. Используйте ExpressRoute с сдвоенными каналами, чтобы обеспечить транзитное подключение для виртуальных сетей в разных регионах Azure. В этом сценарии целевые зоны могут передаваться в пределах региона через NVA в виртуальной сети с локальным концентратором и в разных регионах через канал ExpressRoute. Трафик должен хаирпин на маршрутизаторах MSEE. На следующем рисунке показана эта схема.

  ![Схема, иллюстрирующая проектирование подключения к целевой зоне. ](./media/vnet-dual-circuits.png)
   _Рис. 7. Проектирование подключения к начальной зоне._

- Если вашей организации требуются сетевые архитектуры в более чем двух регионах Azure, а для подключения между зонами требуется глобальное транзитное подключение, виртуальные сети в разных регионах Azure являются обязательными. Эту архитектуру можно реализовать путем подключения виртуальных сетей центрального концентратора к глобальному пирингу виртуальных сетей и использования определяемые пользователем маршруты и NVA для реализации глобальной транзитной маршрутизации. Так как затраты на сложность и управление очень высоки, мы рекомендуем оценить глобальную транзитную архитектуру сети с помощью виртуальной глобальной сети.

- Используйте [Azure Monitor для сетей (Предварительная версия)](/azure/azure-monitor/insights/network-insights-overview) для мониторинга сквозного состояния сетей в Azure.

- Не создавайте более 200 подключений пиринга на виртуальную сеть центрального концентратора. Хотя виртуальные сети поддерживают до 500 одноранговых подключений, ExpressRoute с частным пирингом поддерживает объявление до 200 префиксов из Azure в локальную среду.

## <a name="connectivity-to-azure"></a>Подключение к Azure

Этот раздел расширяет топологию сети, чтобы рассмотреть Рекомендуемые модели для подключения локальных расположений к Azure.

**Рекомендации по проектированию:**

- Azure ExpressRoute предоставляет выделенное частное подключение к функции "инфраструктура как услуга" (IaaS) и "платформа как услуга" (PaaS) из локальных расположений.

- С помощью частной ссылки можно установить подключение к службам PaaS через ExpressRoute с помощью частного пиринга.

- Если несколько виртуальных сетей подключены к одному каналу ExpressRoute, они станут частью одного домена маршрутизации, и все виртуальные сети будут совместно использовать пропускную способность.

- Вы можете использовать ExpressRoute Global Reach, если это возможно, для подключения локальных расположений через каналы ExpressRoute для транзитного трафика через магистральную сеть Майкрософт.

- Global Reach ExpressRoute доступна во многих [расположениях пиринга expressroute](/azure/expressroute/expressroute-global-reach#availability).

- ExpressRoute Direct позволяет создавать несколько каналов ExpressRoute без дополнительных затрат, вплоть до емкости прямого порта ExpressRoute (10 Гбит/с и 100 Гбит/с). Кроме того, он позволяет напрямую подключаться к маршрутизаторам ExpressRoute корпорации Майкрософт. Для SKU с 100 Гбит/с, Минимальная пропускная способность — 5 Гбит/с. Для SKU с номером 10 Гбит/с минимальная скорость канала составляет 1 Гбит/с.

**Рекомендации по проектированию:**

- Используйте ExpressRoute в качестве основного канала подключения для подключения локальной сети к Azure. VPN можно использовать в качестве источника резервного подключения для повышения отказоустойчивости подключения.

- Используйте двойные каналы ExpressRoute из разных расположений пиринга при подключении локального расположения к виртуальным сетям в Azure. Эта программа установки обеспечит избыточные пути к Azure, удалив единые точки сбоя между локальной средой и Azure.

- При использовании нескольких каналов ExpressRoute [Оптимизируйте маршрутизацию expressroute с помощью локальной настройки BGP и пути в порядке ожидания](/azure/expressroute/expressroute-optimize-routing#solution-use-as-path-prepending).

- Убедитесь, что вы используете правильный номер SKU для шлюзов ExpressRoute или VPN на основе требований к пропускной способности и производительности.

- Развертывание избыточного в зону шлюза ExpressRoute в поддерживаемых регионах Azure.

- Для сценариев, требующих пропускной способности выше 10 Гбит/с или выделенных 10/100 Гбит/с, используйте ExpressRoute Direct.

- Если требуется низкая задержка или пропускная способность из локальной среды в Azure должна быть больше 10 Гбит/с, включите Фастпас для обхода шлюза ExpressRoute по пути к данным.

- Используйте VPN-шлюзы для подключения ветвей или удаленных расположений к Azure. Чтобы повысить устойчивость, разверните избыточные зоны (если они доступны).

- Используйте Global Reach ExpressRoute для подключения крупных офисов, региональных головных отделений или центров обработки данных, подключенных к Azure через ExpressRoute.

- Если требуется изоляция трафика или выделенная пропускная способность, например для разделения производственных и непроизводственных сред, используйте разные каналы ExpressRoute. Это поможет обеспечить изолированные домены маршрутизации и снизить риски с помехами.

- Упреждающий мониторинг каналов ExpressRoute с помощью Монитора производительности сети.

- Не используйте явно каналы ExpressRoute в одном расположении пиринга. Это создает единую точку отказа и делает вашу организацию уязвимой для сбоев в связи с одноранговым расположением.

- Не используйте один и тот же канал ExpressRoute для подключения нескольких сред, требующих изоляции или выделенной пропускной способности, чтобы избежать проблем с "шумными соседями"

## <a name="connectivity-to-azure-paas-services"></a>Подключение к службам PaaS Azure

Основываясь на предыдущих разделах подключения, в этом разделе рассматриваются рекомендуемые подходы к подключению для использования служб PaaS Azure.

**Рекомендации по проектированию:**

- Обычно доступ к службам Azure PaaS осуществляется через общедоступные конечные точки. Однако Платформа Azure предоставляет возможности для защиты таких конечных точек или даже сделать их полностью закрытыми:

  - Внедрение виртуальной сети предоставляет выделенные частные развертывания для поддерживаемых служб. Но трафик в плоскости управления проходит через общедоступные IP-адреса.

  - [Частная ссылка](/azure/private-link/private-endpoint-overview#private-link-resource) предоставляет выделенный доступ, используя частные IP-адреса для экземпляров Azure PaaS или пользовательских служб за Azure Load Balancer уровня "Стандартный".

  - Конечные точки службы виртуальной сети обеспечивают доступ на уровне службы из выбранных подсетей к выбранным службам PaaS.

- Предприятия часто сталкиваются с проблемами общедоступных конечных точек для служб PaaS, которые должны быть соответствующим образом устранены.

- Для [поддерживаемых служб](/azure/private-link/private-link-overview#availability)частная ссылка решает проблемы утечка данных, связанные с конечными точками службы. В качестве альтернативы можно использовать фильтрацию исходящего трафика через NVA, чтобы указать шаги по устранению утечка данных.

**Рекомендации по проектированию:**

- Используйте внедрение виртуальной сети для поддерживаемых служб Azure, чтобы сделать их доступными в вашей виртуальной сети.

- Службы PaaS Azure, которые были добавлены в виртуальную сеть, по-прежнему выполняют операции плоскости управления с помощью общедоступных IP-адресов. Убедитесь, что это взаимодействие заблокировано в виртуальной сети с помощью определяемые пользователем маршруты и группы безопасности сети.

- Используйте ссылку частная ссылка, [если она доступна](/azure/private-link/private-link-overview#availability), для общих служб Azure PaaS. Частная ссылка общедоступна для нескольких служб и доступна в общедоступной предварительной версии для многих из них.

- Доступ к службам Azure PaaS из локальной среды через частный пиринг ExpressRoute. Используйте внедрение виртуальной сети для выделенных служб Azure или частной ссылки Azure для доступных общих служб Azure. Чтобы получить доступ к службам Azure PaaS из локальной среды при недоступной вставке виртуальной сети или закрытой ссылке, используйте ExpressRoute с пирингом Майкрософт. Этот метод позволяет избежать передачи через общедоступный Интернет.

- Используйте конечные точки службы виртуальной сети для защиты доступа к службам Azure PaaS из виртуальной сети, но только если частная связь недоступна и нет проблем с утечка данных. Чтобы устранить проблемы утечка данных с конечными точками службы, используйте фильтрацию NVA или используйте политики конечной точки службы виртуальной сети для хранилища Azure.

- Не включайте конечные точки службы виртуальной сети по умолчанию во всех подсетях.

- Не используйте конечные точки службы виртуальной сети, если есть проблемы с утечка данных, если не используется фильтрация NVA.

- Мы не рекомендуем реализовать принудительное туннелирование, чтобы обеспечить подключение из Azure к ресурсам Azure.

## <a name="plan-for-inbound-and-outbound-internet-connectivity"></a>Планирование входящего и исходящего подключения к Интернету

В этом разделе описываются рекомендуемые модели подключения для входящего и исходящего подключения к общедоступному Интернету.

**Рекомендации по проектированию:**

- Собственные службы безопасности сети Azure, такие как Брандмауэр Azure, Брандмауэр веб-приложения Azure (WAF) в Шлюзе приложений Azure, а также Azure Front Door — это полностью управляемые службы. Таким образом, вы не берете на себя затраты на эксплуатацию и управление, связанные с развертыванием инфраструктуры, которые могут стать сложными в крупных масштабах.

- Архитектура корпоративного уровня полностью совместима с партнером NVA, если ваша организация предпочитает использовать NVA или в ситуациях, когда собственные службы не соответствуют конкретным требованиям Организации.

**Рекомендации по проектированию:**

- Используйте брандмауэр Azure, чтобы управлять:

  - Исходящий трафик Azure в Интернете.

  - Входящие подключения, отличные от HTTP/S.

  - Фильтрация трафика «Восточная/Западная» (если ваша организация требует ее).

- Используйте диспетчер брандмауэра с виртуальной глобальной сетью для развертывания и управления брандмауэрами Azure через виртуальные глобальные концентраторы или в виртуальных сетях концентраторов. Диспетчер брандмауэров теперь доступен как для виртуальной глобальной сети, так и для обычных виртуальных сетей.

- Создайте глобальную политику брандмауэра Azure для управления уровнем безопасности в глобальной сетевой среде и назначьте его всем экземплярам брандмауэра Azure. Разрешите детальные политики для удовлетворения требований конкретных регионов, делегируя добавочные политики брандмауэра локальным группам безопасности с помощью управления доступом на основе ролей.

- Настройте поддерживаемые поставщики безопасности SaaS партнеров в диспетчере брандмауэра, если вашей организации требуется использовать такие решения для защиты исходящих подключений.

- Используйте WAF в виртуальной сети с целевой зоной для защиты входящего трафика HTTP/S из Интернета.

- Используйте переднюю дверцу Azure и политики WAF, чтобы обеспечить глобальную защиту в регионах Azure для входящих подключений HTTP/S к целевой зоне.

- Если вы используете переднюю дверцу Azure и шлюз приложений Azure для защиты приложений HTTP/S, используйте политики WAF в передней дверце Azure. Блокировка шлюза приложений Azure для получения трафика только из передней дверцы Azure.

- Если для защиты трафика в Восточной/Западная или Южной и Северной сети требуются NVA партнера, необходимо выполнить фильтрацию:

  - Для топологий сетей виртуальной глобальной сети разверните NVA в отдельной виртуальной сети (например, в виртуальной сети NVA). Затем подключите его к региональному виртуальному концентратору глобальной сети и зонам размещения, которым требуется доступ к NVA. В [этой статье](/azure/virtual-wan/virtual-wan-route-table-portal) описывается процесс.
  - Для топологий невиртуальной глобальной сети разверните NVA партнера в виртуальной сети центрального концентратора.

- Если партнер NVA требуется для входящих подключений HTTP/S, разверните их в виртуальной сети с целевой зоной, а также с приложениями, которые защищаются и предоставляют доступ к Интернету.

- Используйте [планы защиты Azure от атак DDoS Protection Standard](/azure/virtual-network/ddos-protection-overview) для защиты всех общедоступных конечных точек, размещенных в виртуальных сетях.

- Не следует переносить концепции и архитектуры локальной сети периметра в Azure. Аналогичные возможности безопасности доступны в Azure, но реализация и архитектура должны быть адаптированы к облаку.

## <a name="plan-for-app-delivery"></a>Планирование доставки приложений

В этом разделе рассматриваются основные рекомендации по обеспечению безопасности, высокой масштабируемости и высокой доступности внешних приложений с внешними приложениями.

**Рекомендации по проектированию:**

- Azure Load Balancer (внутренний и общедоступный) обеспечивает высокий уровень доступности для доставки приложений на региональном уровне.

- Шлюз приложений Azure обеспечивает безопасную доставку приложений HTTP/S на региональном уровне.

- Передняя дверца обеспечивает безопасную доставку высокодоступных приложений HTTP/S в регионах Azure.

- Диспетчер трафика Azure позволяет доставлять глобальные приложения.

**Рекомендации по проектированию:**

- Выполняйте доставку приложений в зонах размещения как для внутренних, так и для внешних приложений.

- Для безопасной доставки приложений HTTP/S используйте шлюз приложений версии 2 и убедитесь, что включена защита и политики WAF.

- Используйте NVA партнера, если вы не можете использовать шлюз приложений версии 2 для обеспечения безопасности приложений HTTP/S.

- Выполните развертывание шлюза приложений Azure версии 2 или партнера NVA, используемого для входящих подключений HTTP/S в виртуальной сети с целевой зоной, а также с приложениями, для которых они используются.

- Используйте стандартный план защиты от атак DDoS для всех общедоступных IP-адресов в целевой зоне.

- Используйте переднюю дверцу Azure с политиками WAF для предоставления и защиты глобальных приложений HTTP/S, охватывающих регионы Azure.

- При использовании передней дверцы и шлюза приложений для защиты приложений HTTP/S используйте политики WAF в передней дверце. Блокировка шлюза приложений для получения трафика только с передней дверцы.

- Используйте диспетчер трафика для доставки глобальных приложений, которые охватывают протоколы, отличные от HTTP/S.

## <a name="plan-for-landing-zone-network-segmentation"></a>Планирование сегментации сети для целевой зоны

В этом разделе рассматриваются ключевые рекомендации по обеспечению высоконадежной сегментации внутренних сетей в целевой зоне для обеспечения реализации бесконечных сетей без доверия.

**Рекомендации по проектированию:**

- Модель с нулевым доверием предполагает нарушение состояния и проверяет каждый запрос, как будто он происходит из неуправляемой сети.

- Расширенная реализация сети с нулевым доверием использует полностью распределенные входные и исходящие облачные микросети и более глубокое Micro-сегментацию.

- Группы безопасности сети могут использовать теги службы Azure для упрощения подключения к службам Azure PaaS.

- Группы безопасности приложений не охватывают или не обеспечивают защиту между виртуальными сетями.

- Журналы потоков NSG теперь поддерживаются с помощью шаблонов Azure Resource Manager.

**Рекомендации по проектированию:**

- Делегируйте создание подсети владельцу целевой зоны. Это позволит им определять сегментирование рабочих нагрузок между подсетями (например, с помощью одной большой подсети, многоуровневого приложения или приложения, которое было вставлено в сеть). Группа платформы может использовать политику Azure, чтобы гарантировать, что NSG с определенными правилами (например, запретить входящий SSH или RDP из Интернета или разрешить/блокировать трафик между зонами) всегда будет связан с подсетями, имеющими политики только для запретов.

- Используйте группы безопасности сети для защиты трафика между подсетями, а также с трафиком "Восток/Западная" по всей платформе (трафик между зонами).

- Для защиты многоуровневых виртуальных машин в целевой зоне группа разработчиков приложений должна использовать группы безопасности приложений на уровне подсети группы безопасности сети.

- Используйте группы безопасности сети и группы безопасности приложений для микросегментного трафика в целевой зоне и Избегайте использования центрального NVA для фильтрации потоков трафика.

- Включите журналы потоков NSG и переносите их в Аналитика трафика, чтобы получить представление о внутреннем и внешнем потоке трафика.

- Используйте группы безопасности сети, чтобы выборочно разрешить подключение между зонами.

- Для топологий виртуальных глобальных сетей направьте трафик между зонами с помощью брандмауэра Azure, если вашей организации требуются возможности фильтрации и ведения журнала для трафика, передаваемого между зонами.

## <a name="define-network-encryption-requirements"></a>Определение требований к шифрованию сети

В этом разделе рассматриваются основные рекомендации по обеспечению шифрования сети между локальной средой и Azure, а также между регионами Azure.

**Рекомендации по проектированию:**

- Стоимость и доступная пропускная способность обратно пропорционально длине туннеля шифрования между конечными точками.

- Если вы используете VPN для подключения к Azure, трафик шифруется через туннель IPsec через Интернет.

- При использовании ExpressRoute с частным пиринг трафика в настоящее время не шифруется.

- Настройка VPN-подключения типа "сеть — сеть" через частный пиринг ExpressRoute теперь находится [на этапе предварительной версии](/azure/vpn-gateway/site-to-site-vpn-private-peering).

- Вы можете применить шифрование [системы управления доступом к носителю (максек)](/azure/expressroute/expressroute-howto-MACsec) к ExpressRoute Direct, чтобы обеспечить шифрование сети.

- Когда трафик Azure перемещается между центрами обработки данных (за пределами физических границ, не контролируемых корпорацией Майкрософт или от имени корпорации Майкрософт), в базовом сетевом оборудовании используется [максек шифрование уровня связи](/azure/security/fundamentals/encryption-overview#encryption-of-data-in-transit) . Это применимо к трафику пиринга виртуальной сети.

**Рекомендации по проектированию:**

![Схема, иллюстрирующая потоки шифрования.](./media/enc-flows.png)

_Рис. 8. потоки шифрования._

- При установке VPN-подключений из локальной среды в Azure с помощью VPN-шлюзов трафик шифруется на уровне протокола через туннели IPsec. На предыдущей схеме показано шифрование в последовательности `A` .

- Если вы используете ExpressRoute Direct, настройте [максек](/azure/expressroute/expressroute-howto-MACsec) для шифрования трафика на двух уровнях между маршрутизаторами Организации и MSEE. На схеме показано это шифрование в последовательности `B` .

- В сценариях виртуальной глобальной сети, где Максек не является параметром (например, не используйте функцию ExpressRoute Direct), используйте VPN-шлюз виртуальной глобальной сети для установки [туннелей IPSec через частный пиринг ExpressRoute](/azure/virtual-wan/vpn-over-expressroute). На схеме показано это шифрование в последовательности `C` .

- Для сценариев невиртуальной глобальной сети и там, где Максек не является параметром (например, не используется протокол ExpressRoute Direct), доступны следующие параметры.

  - Используйте Partner NVA для установки туннелей IPsec через частный пиринг ExpressRoute.
  - Установите VPN-туннель через ExpressRoute с помощью пиринга Майкрософт.
  - Оцените возможность настройки VPN-подключения типа "сеть — сеть" через частный пиринг ExpressRoute ([Предварительная версия](/azure/vpn-gateway/site-to-site-vpn-private-peering)).

- Если трафик между регионами Azure должен быть зашифрован, используйте глобальную пиринг виртуальной сети для подключения виртуальных сетей между регионами.

- Если собственные решения Azure (как показано в последовательностях `B` и `C` на схеме) не соответствуют вашим требованиям, используйте партнерскую NVA в Azure для шифрования трафика через частный пиринг ExpressRoute.

## <a name="plan-for-traffic-inspection"></a>Планирование проверки трафика

Во многих отраслях организация требует, чтобы трафик в Azure был зеркально отражен в сборщик сетевых пакетов для глубокой проверки и анализа. Это требование обычно посвящено входящему и исходящему интернет – трафику. В этом разделе рассматриваются ключевые моменты и Рекомендуемые подходы к зеркальному отображению или касанию трафика в виртуальной сети Azure.

**Рекомендации по проектированию:**

<!-- docutune:ignore TAP -->

- [Точка доступа к терминалу виртуальной сети Azure (TAP)](/azure/virtual-network/virtual-network-tap-overview) находится на этапе предварительной версии. Обратитесь к `azurevnettap@microsoft.com` сведениям о доступности.

- Запись пакетов в наблюдатель за сетями Azure доступна в общедоступной версии, но количество записей ограничено максимальным сроком пять часов.

**Рекомендации по проектированию:**

В качестве альтернативы отводам виртуальной сети Azure следует оценить следующие параметры.

- Используйте пакеты наблюдателя за сетями для захвата, несмотря на ограниченное окно записи.

- Оцените, что последняя версия журналов потоков NSG предоставляет необходимый уровень детализации.

- Используйте решения партнеров для сценариев, требующих глубокой проверки пакетов.

- Не Разрабатывайте пользовательское решение для зеркального отображения трафика. Хотя этот подход может быть приемлемым для небольших сценариев, мы не рекомендуем его масштабировать из-за сложности и проблем, связанных с поддержкой, которые могут возникнуть.
