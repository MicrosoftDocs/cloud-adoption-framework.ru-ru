---
title: Топология сети и возможности подключения
description: Изучите ключевые вопросы и рекомендации по проектированию сети и подключения к Microsoft Azure.
author: BrianBlanchard
ms.author: brblanch
ms.date: 06/15/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: ready
ms.openlocfilehash: 405bbe81d2243b01aca45700e68007f8e6c18243
ms.sourcegitcommit: a6c9643986acf33524f17bbd01c71e3fccc03805
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2020
ms.locfileid: "86403533"
---
<!-- cSpell:ignore autoregistration BGPs MACsec MPLS MSEE onprem privatelink VPNs -->

# <a name="network-topology-and-connectivity"></a>Топология сети и возможности подключения

В этом разделе рассматриваются основные вопросы и рекомендации по проектированию сети и подключения к Microsoft Azure.

## <a name="planning-for-ip-addressing"></a>Планирование IP-адресации

Крайне важно, чтобы ваша организация запланировать IP-адресацию в Azure, чтобы не перекрывать пространство IP-адресов в рамках локальных расположений и регионов Azure.

**Рекомендации по проектированию:**

- Перекрывающиеся пространства IP-адресов в локальной среде и регионах Azure будут создавать серьезные проблемы с состязанием.

- Хотя адресное пространство виртуальной сети (VNet) можно добавить после создания, этот процесс требует сбоя, если виртуальная сеть уже подключена к другой виртуальной сети через пиринг виртуальных сетей, так как пиринг необходимо удалить и создать заново.

- Azure резервирует пять IP-адресов в каждой подсети, которые следует учитывать при определении размера виртуальных сетей и охватываемых подсетей.

- Для некоторых служб Azure требуются [выделенные подсети](https://docs.microsoft.com/azure/virtual-network/virtual-network-for-azure-services#services-that-can-be-deployed-into-a-virtual-network) , такие как брандмауэр Azure или шлюз виртуальной сети.

- Подсети могут быть делегированы определенным службам для создания экземпляров этой службы в подсети.

**Рекомендации по проектированию:**

- Заранее спланируйте непересекающиеся пространства IP-адресов в регионах Azure и локальных расположениях.

- Используйте IP-адреса из выделения адресов для частных Интернета (RFC 1918).

- Для сред с ограниченным доступом к частным IP-адресам (RFC 1918) рекомендуется использовать IPv6.

- Не создавайте ненужные крупные виртуальных сетей (например `/16` ,), чтобы гарантировать, что пространство IP-адресов не будет излишним.

- Не создавайте виртуальных сетей, не планируя требуемое адресное пространство заранее, так как Добавление адресного пространства приведет к сбою после подключения виртуальной сети через пиринг виртуальных сетей.

- Не используйте общедоступные IP-адреса для виртуальных сетей, особенно если общедоступные IP-адреса не принадлежат вашей организации.

## <a name="configure-the-domain-name-system-dns-and-name-resolution-for-on-premises-and-azure-resources"></a>Настройка системы доменных имен (DNS) и разрешения имен для локальных и ресурсов Azure

DNS является важнейшим разделом проектирования в общей архитектуре корпоративного уровня, а в некоторых организациях может потребоваться использовать существующие инвестиции в DNS, другие могут видеть внедрение облака как возможность модернизировать свою внутреннюю инфраструктуру DNS и использовать собственные возможности Azure.

**Рекомендации по проектированию:**

- Сопоставитель DNS можно использовать в сочетании с Azure Частная зона DNS для разрешения имен в нескольких локальных.

- Вам может потребоваться использовать существующие решения DNS в локальной среде и Azure.

- Максимальное число частных зон DNS, к которым виртуальная сеть может связываться с помощью авторегистрации, — это один из них.

- Максимальное число частных зон DNS, с которыми может быть связана виртуальная сеть, — 1000 без автоматической регистрации.

**Рекомендации по проектированию:**

- Для сред, где разрешение имен в Azure является обязательным, используйте Частная зона DNS Azure для разрешения, создав делегированную зону для разрешения имен (например, `azure.contoso.com` ).

- Для сред, где требуется разрешение имен в Azure и локальную среду, используйте существующую инфраструктуру DNS (например, Active Directory интегрированную службу DNS), развернутую по крайней мере на двух виртуальных машинах Azure, и настройте параметры DNS в виртуальных сетей для использования этих DNS-серверов.

- Частная зона DNS Azure по-прежнему можно использовать, когда зона Частная зона DNS Azure связана с виртуальных сетей, а DNS-серверы используются в качестве гибридных арбитров конфликтов с условным перенаправлением в локальные DNS-имена (например, `onprem.contoso.com` ) с помощью локальных DNS-серверов. Локальные серверы можно настроить с помощью условных серверов пересылки для виртуальных машин сопоставителя в Azure для зоны Частная зона DNS Azure (например, `azure.contoso.com` ).

- Особые рабочие нагрузки, требующие и развертывающие собственные DNS (например, Red Hat OpenShift), должны использовать предпочтительное решение DNS.

- Автоматическая регистрация должна быть включена Azure DNS для автоматического управления жизненным циклом записей DNS для виртуальных машин, развернутых в виртуальной сети.

- Используйте виртуальную машину как сопоставитель для междоменного разрешения имен DNS с помощью Azure Частная зона DNS.

- Создайте зону Частная зона DNS Azure в глобальной подписке с подключением. Могут быть созданы дополнительные зоны Частная зона DNS Azure (например, `privatelink.database.windows.net` или `privatelink.blob.core.windows.net` для частной связи Azure).

## <a name="define-an-azure-network-topology"></a>Определение топологии сети Azure

Топология сети — важный базовый элемент архитектуры корпоративного уровня, так как в конечном итоге он определяет, как приложения могут взаимодействовать друг с другом. В этом разделе рассматриваются соответствующие технологии и подходы к топологии для корпоративных развертываний Azure, сосредоточенные на двух основных подходах: топологии на основе виртуальной глобальной сети Azure и традиционных топологий.

Сетевая топология, основанная на виртуальной глобальной сети Azure, является предпочтительным подходом корпоративного масштаба для крупномасштабных развертываний в масштабах регионов, где вашей организации необходимо подключать глобальные расположения как к Azure, так и к локальной среде. Топологию виртуальной сети WAN также следует использовать всякий раз, когда ваша организация планирует использовать полностью интегрированные в Azure развертывания по для глобальной сети (SD-WAN). Виртуальная глобальная сеть используется для удовлетворения требований к крупномасштабному взаимосоединению. Поскольку это служба, управляемая корпорацией Майкрософт, она также сокращает общую сложность сети и помогает модернизировать сеть Организации.

Рекомендуется использовать традиционную топологию сети Azure, если ваша организация планирует развертывать ресурсы только в нескольких регионах Azure, вам не нужна глобальная взаимосвязь, у вас есть небольшое количество удаленных или филиалов по регионам (менее 30 туннелей IPsec) или требуется полный контроль и гранулярность для ручной настройки сети Azure. Эта традиционная топология помогает создать защищенную сетевую основу в Azure.

## <a name="virtual-wan-network-topology-microsoft-managed"></a>Топология сети виртуальной глобальной сети (под управлением Майкрософт)

![Сетевая топология и подключение ](./media/virtual-wan-topology.png)
 _рис. 1. топология виртуальной глобальной сети._

**Рекомендации по проектированию:**

- [Виртуальная глобальная сеть Azure](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-about) — это управляемое корпорацией Майкрософт решение, в котором по умолчанию предоставляется сквозное глобальное транзитное подключение. Виртуальные глобальные концентраторы исключают необходимость ручной настройки сетевого подключения. Например, вам не нужно настраивать определяемую пользователем маршрутизацию (UDR) или сетевые виртуальные устройства (NVA), чтобы обеспечить возможность глобального транзитного подключения.

- Виртуальная глобальная сеть значительно упрощает сквозное сетевое подключение в Azure и распределенное развертывание, создавая [архитектуру сети](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-global-transit-network-architecture) с одной и той же топологией, которая охватывает несколько регионов Azure и локальных расположений (любое подключение), как показано на рисунке ниже.

![Топология сети и подключение ](./media/global-transit.png)
 _рис. 2. Глобальная транзитная сеть с виртуальной глобальной сетью._

- Виртуальная глобальная сеть с любыми транзитивными подключениями поддерживает следующие пути (в одном и том же регионе и в разных регионах):

  - Виртуальная сеть с виртуальной сетью
  - Виртуальная сеть — ветвь
  - Переход к виртуальной сети
  - Ветвь к ветви

- Виртуальные концентраторы глобальной сети заблокированы, и единственные ресурсы, которые можно развернуть в них, являются шлюзами виртуальной сети (VPN типа "точка — сеть", VPN-подключением типа "сеть — сеть" и ExpressRoute), брандмауэром Azure через диспетчер брандмауэра и таблицами маршрутов.

- Виртуальная глобальная сеть увеличивает ограничение до 200 префиксов, объявленных из Azure в локальную среду с помощью частного пиринга ExpressRoute, до префиксов 10 000 на виртуальный концентратор глобальной сети. В число префиксов 10 000 также входит VPN типа "сеть — сеть" и VPN-подключение "точка — сеть".

- Возможность подключения между виртуальными сетями (в пределах региона и между регионами) теперь находится в общедоступной версии.

- Подключение концентратора виртуальной глобальной сети к концентратору теперь находится в общедоступной версии.

- Транзитное подключение между виртуальными сетями в Виртуальной глобальной сети уровня "Стандартный" обеспечивается за счет маршрутизатора в каждом виртуальном концентраторе. Каждый маршрутизатор виртуального концентратора поддерживает общую пропускную способность до 50 Гбит/с.

- Виртуальная глобальная сеть интегрируется с различными [поставщиками SD-WAN](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-locations-partners).

- Многие поставщики управляемых служб предлагают [управляемые службы](https://docs.microsoft.com/azure/networking/networking-partners-msp) для виртуальной глобальной сети.

- VPN-шлюзы в виртуальной глобальной сети могут масштабировать до 20 Гбит/с и 20 000 подключений на виртуальный концентратор.

- Каналы ExpressRoute с надстройкой "Премиум" являются обязательными, и они должны быть из расположения Global Reach ExpressRoute.

- Теперь Диспетчер брандмауэра Azure в общедоступной версии позволяет развернуть брандмауэр Azure в виртуальном концентраторе глобальной сети.

- Трафик концентратора виртуальной глобальной сети через брандмауэр Azure в настоящее время не поддерживается. В качестве альтернативы используйте собственный концентратор для маршрутизации транзитных функций в виртуальной глобальной сети и используйте группы безопасности сети, чтобы разрешить или заблокировать трафик виртуальной сети между концентраторами.

**Рекомендации по проектированию:**

- Виртуальную ГЛОБАЛЬную сеть настоятельно рекомендуется использовать для новых крупных или глобальных сетевых развертываний в Azure, где требуется глобальное транзитное подключение между регионами Azure и локальными расположениями, без необходимости вручную настраивать транзитивное маршрутизацию сети Azure.

  На следующем рисунке показан пример глобального корпоративного развертывания с центрами обработки данных, распределенными по Европе и США, а также большое количество филиалов в обоих регионах. Окружение глобально подключено через виртуальную сеть WAN и Global Reach ExpressRoute.

![Пример топологии сети ](./media/global-reach-topology.png)
 _рис. 3. Пример топологии сети._

- Используйте виртуальную глобальную сеть в качестве глобального ресурса подключения с виртуальным концентратором глобальной сети на регион Azure для подключения нескольких целевых зон между регионами Azure через локальный виртуальный концентратор глобальной сети.

- Подключите виртуальные глобальные концентраторы к локальным центрам обработки данных с помощью ExpressRoute.

- Подключите ветви и удаленные расположения к ближайшему виртуальному концентратору глобальной сети через VPN типа "сеть — сеть" или включите подключение филиала к виртуальной глобальной сети через партнерское решение SD-WAN.

- Подключите конечных пользователей к виртуальному концентратору глобальной сети через VPN-подключение типа "точка — сеть".

- Следуйте принципу: "трафик в Azure остается в Azure", поэтому связь между ресурсами в Azure осуществляется через магистральную сеть Майкрософт, даже если ресурсы находятся в разных регионах.

- Разверните брандмауэр Azure в виртуальном ГЛОБАЛЬном концентраторе для защиты и фильтрации трафика в регионе Azure.

- Если требуются сторонние NVA для защиты и фильтрации трафика Восточной и Юго-Западной регионов, разверните NVA в отдельной виртуальной сети (например, в виртуальной сети NVA) и подключите ее к региональному виртуальному концентратору глобальной сети и зонам, которым требуется доступ к NVA. Дополнительные сведения см. [в статье Создание таблицы маршрутов для NVA в виртуальной глобальной сети](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-route-table-portal).

- При развертывании сетевых технологий и NVA сторонних поставщиков следуйте рекомендациям стороннего поставщика, чтобы убедиться в отсутствии конфликтующих конфигураций с сетью Azure.

- Не создавайте транзитную сеть поверх виртуальной глобальной сети Azure, так как виртуальная Глобальная сеть удовлетворяет всем требованиям к топологии сети, в том числе возможность использовать сторонние NVA.

- Не используйте существующие локальные сети, такие как многопротокольное переключение меток (MPLS), для подключения ресурсов Azure между регионами Azure, так как сетевые технологии Azure поддерживают взаимодействие ресурсов Azure между регионами через Microsoft магистраль.

- Сведения о сценариях серия статей Brownfield, в которых выполняется миграция из топологии сети типа "звезда", не основанной на виртуальной глобальной сети, см. [в статье миграция в виртуальную глобальную сеть Azure](https://docs.microsoft.com/azure/virtual-wan/migrate-from-hub-spoke-topology).

- Виртуальные глобальные сети Azure и ресурсы брандмауэра Azure должны создаваться в рамках подписки на подключение.

- Не создавайте более 500 подключений к виртуальной сети в виртуальном концентраторе глобальной сети.

## <a name="traditional-azure-networking-topology"></a>Традиционная топология сетей Azure

Хотя Виртуальная глобальная сеть предоставляет широкий спектр мощных возможностей, в некоторых случаях рекомендуется использовать традиционный подход к работе в сети Azure.

- Если глобальная транзитная сеть в нескольких регионах Azure или распределенная между организациями не требуется, например ветвь в США требуется подключение к виртуальной сети в Европе.

- Если нет необходимости подключаться к большому количеству удаленных расположений через VPN или интеграцию с решением SD-WAN.

- Если в вашей организации требуется детальный контроль и настройка при настройке топологии сети в Azure.

![Топология сети и подключение ](./media/customer-managed-topology.png)
 _рис. 4. Традиционная топология сети Azure._

**Рекомендации по проектированию:**

- Существует несколько сетевых топологий для подключения нескольких виртуальных сетейных зон: одну крупную плоскую виртуальную сеть, несколько виртуальных сетей, подключенных с несколькими каналами или соединениями ExpressRoute, концентраторы, полные сети и гибридные.

- Виртуальных сетей не проходят через границы подписки, но связь между виртуальных сетей в разных подписках может быть достигнута с помощью пиринга виртуальной сети, канала ExpressRoute или VPN-шлюзов.

- Пиринг виртуальных сетей можно использовать для подключения виртуальных сетей в одном регионе, в разных регионах Azure и в разных клиентах Azure AD.

- Пиринг виртуальных сетей и пиринг глобальной виртуальной сети не являются транзитивными. Поэтому определяемые пользователем маршруты и NVA необходимы для включения транзитной сети. Дополнительные сведения см. [в статье топология сети звезды в Azure](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/hub-spoke).

- Каналы ExpressRoute можно использовать для установления подключения между виртуальных сетей в одном географическом регионе или с помощью надстройки уровня "Премиум" для подключения между географическими регионами.

  - Трафик между виртуальными сетями может столкнуться с дополнительной задержкой, так как трафик должен хаирпин на маршрутизаторах Microsoft Enterprise (MSEE).

  - Пропускная способность будет ограничена номером SKU шлюза ExpressRoute.

  - Вы по-прежнему должны развертывать определяемые пользователем маршруты и управлять ими, если им требуется проверка и ведение журнала для трафика между виртуальными сетями.

- VPN-шлюзы с протоколом BGP являются транзитивными в пределах Azure и в локальной среде, но не перемещаются между шлюзами ExpressRoute.

- Если несколько каналов ExpressRoute подключены к одной виртуальной сети, необходимо использовать весовые коэффициенты подключений и методы BGP, чтобы обеспечить оптимальный путь для трафика между локальной сетью и Azure. Дополнительные сведения см. в разделе [Оптимизация маршрутизации ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing).

- Использование методик BGP для повлиять на маршрутизацию ExpressRoute — это конфигурация за пределами облака Azure. Поэтому ваша организация или поставщик услуг подключения должны соответствующим образом настроить локальные маршрутизаторы.

- Каналы ExpressRoute с надстройками уровня "Премиум" обеспечивают глобальную связь. Однако максимальное число подключений ExpressRoute на шлюз ExpressRoute равно четырем.

- Максимальное число подключений пиринга виртуальной сети на виртуальную сеть — 500, максимальное число маршрутов, которые могут быть объявлены из Azure в локальную среду через частный пиринг ExpressRoute, — 200.

- Максимальная суммарная пропускная способность VPN-шлюза составляет 10 Гбит/с и поддерживает до 30 туннелей "сеть — сеть" или "Виртуальная сеть — виртуальная сети".

**Рекомендации по проектированию:**

- В следующих сценариях следует учитывать архитектуру сети, основанную на проектировании в топологиях концентратора и звезды с технологиями, отличными от виртуальных сетей WAN.

  - Развертывания Azure, в которых граница трафика находится в регионе Azure.

  - Сетевая архитектура с двумя регионами Azure, в которых требуется транзитное подключение между виртуальных сетей зонами в разных регионах.

  - Сетевая архитектура, охватывающая несколько регионов Azure и не требующая транзитного подключения между виртуальных сетей зонами в разных регионах.

  - Нет необходимости в транзитном подключении между подключениями VPN и ExpressRoute.

  - Основной канал подключения между организациями — ExpressRoute, а число VPN-подключений — менее 30 на VPN-шлюз.

  - Существует большая зависимость от централизованного NVA и сложной или детализированной маршрутизации.

- Для региональных развертываний в основном используется топология hub-and-лучевой, с основными зонами виртуальных сетей подключение с помощью пиринга виртуальной сети к центральной виртуальной сети для распределенного подключения через ExpressRoute, VPN для подключения филиала, подключение периферийного сервера через NVA и определяемые пользователем маршруты, а также защита исходящего трафика через Интернет через NVA, как показано на рисунке ниже.

![Топология сети и возможности подключения](./media/hub-and-spoke-topology.png)

_Рис. 5. топология сети hub-and-лучевой._

- Если требуется высокий уровень изоляции, для конкретных подразделений требуется выделенная пропускная способность ExpressRoute или максимальное число подключений на шлюз ExpressRoute (до четырех). Используйте несколько виртуальных сетей, подключенных с помощью топологии каналов ExpressRoute, как показано на рисунке ниже.

![Топология сети и подключение ](./media/vnet-multiple-circuits.png)
 _рис. 6. несколько виртуальных сетей, подключенных с несколькими каналами ExpressRoute._

- Разверните набор минимальных общих служб, включая шлюзы ExpressRoute, VPN-шлюзы (при необходимости) и брандмауэр Azure или NVA стороннего производителя (при необходимости) в Центральной виртуальной сети центра. При необходимости также Active Directory контроллеры домена и DNS-серверы.

- Разверните брандмауэр Azure или NVA стороннего производителя для защиты и фильтрации трафика "Восток-Западная" и/или "Южная-Северный" в Центральной виртуальной сети центра.

- При развертывании сетевых технологий и NVA сторонних поставщиков следуйте рекомендациям стороннего поставщика, чтобы убедиться, что развертывание поддерживается поставщиком, предназначено для обеспечения высокой доступности и максимальной производительности, а также в отсутствии конфликтующих конфигураций с сетью Azure.

- Входящий NVA уровня 7 (например, шлюз приложений Azure) не должен быть развернут как общая служба в Центральной виртуальной сети концентратора. Вместо этого они должны быть развернуты вместе с приложением в соответствующей целевой зоне.

- Используйте существующую сеть (MPLS и SD-WAN) для подключения расположений ветвей к корпоративному офису. Транзит в Azure между ExpressRoute и VPN-шлюзами не поддерживается.

- Для сетевых архитектур с несколькими топологиями типа "звезда" в регионах Azure используйте глобальную пиринг виртуальных сетей для подключения к главной зоне виртуальных сетей, когда небольшому числу целевых зон требуется обмен данными между регионами. Этот подход обеспечивает такие преимущества, как высокая пропускная способность сети с глобальным пирингом виртуальных сетей (как это разрешено номером SKU виртуальной машины), но обходит Центральный NVA (если требуется проверка трафика или фильтрация). Это также может привести к [ограничениям пиринга глобальной виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview#constraints-for-peered-virtual-networks).

- При развертывании архитектуры сети hub-and-лучевой в двух регионах Azure требуется транзитное подключение между всеми зонами в разных регионах. Используйте ExpressRoute с сдвоенными каналами, чтобы обеспечить транзитное подключение для виртуальных сетей зон в регионах Azure. В этом сценарии целевые зоны могут передаваться в пределах региона через NVA в локальной виртуальной сети концентратора и в разных регионах через канал ExpressRoute, а трафик должен хаирпин на маршрутизаторах Microsoft Enterprise (MSEE). Эта схема показана на рисунке ниже.

![Топология сети и подключение ](./media/vnet-dual-circuits.png)
 _рис. 7. Проектирование подключения к целевой зоне._

- Если для Организации требуются сетевые архитектуры в более чем двух регионах Azure, и требуется глобальное транзитное подключение между зонами размещения виртуальных сетей в регионах Azure. Хотя эту архитектуру можно реализовать путем соединения центрального концентратора виртуальных сетей с глобальным пирингом виртуальных сетей и использованием определяемые пользователем маршруты и NVA для реализации глобальной транзитной маршрутизации, затраты на сложность и управление очень высоки. Вместо этого рекомендуется развернуть глобальную транзитную архитектуру сети с помощью виртуальной глобальной сети.

- Используйте [Azure Monitor Network Insights](https://docs.microsoft.com/azure/azure-monitor/insights/network-insights-overview) (в настоящее время в предварительной версии) для мониторинга сквозного состояния сетей в Azure.

- Не создавайте более 200 подключений пиринга для каждой виртуальной сети центрального концентратора. Хотя виртуальных сетей поддерживает до 500 одноранговых подключений, ExpressRoute с частным пирингом поддерживает объявление до 200 префиксов из Azure в локальную среду.

## <a name="connectivity-to-azure"></a>Подключение к Azure

В этом разделе будет расширена топология сети, в которой рекомендуется использовать рекомендуемые модели для подключения локальных расположений к Azure.

**Рекомендации по проектированию:**

- Azure ExpressRoute предоставляет выделенное частное подключение для Microsoft Azure инфраструктуры как услуги (IaaS) и платформы как услуги (PaaS) из локальных расположений.

- Частную ссылку можно использовать для установления подключения к службам PaaS через ExpressRoute с частными пиринга.

- Если несколько виртуальных сетей подключены к одному каналу ExpressRoute, они станут частью одного домена маршрутизации, и все виртуальных сетей будут совместно использовать пропускную способность.

- ExpressRoute Global Reach (если доступно) позволяет подключать локальные расположения вместе с помощью каналов ExpressRoute для транзитного трафика через магистральную сеть Майкрософт.

- Global Reach ExpressRoute доступна во многих [расположениях пиринга expressroute](https://docs.microsoft.com/azure/expressroute/expressroute-global-reach#availability).

- ExpressRoute Direct позволяет создавать несколько каналов ExpressRoute без дополнительных затрат, вплоть до емкости прямого порта ExpressRoute (10 Гбит/с 100 Гбит/с) и позволяет подключаться непосредственно к маршрутизаторам ExpressRoute Майкрософт. Для SKU 100 Гбит/с минимальная скорость канала составляет 5 Гбит/с. Для SKU с номером 10 Гбит/с минимальная скорость канала составляет 1 Гбит/с.

<!-- cSpell:ignore prepending -->
<!-- docsTest:ignore "AS PATH prepending -->

**Рекомендации по проектированию:**

- Используйте ExpressRoute в качестве основного канала подключения для подключения локальной сети к Microsoft Azure. VPN можно использовать в качестве источника резервного подключения для повышения отказоустойчивости подключения.

- Используйте двойные каналы ExpressRoute из разных расположений пиринга при подключении локального расположения к виртуальных сетей в Azure. Эта программа установки обеспечит избыточность путей к Azure, удаляя единые точки сбоя между локальной средой и Azure.

- При использовании нескольких каналов ExpressRoute [Оптимизируйте маршрутизацию expressroute с помощью локальной настройки BGP и пути в порядке ожидания](https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing#solution-use-as-path-prepending).

- Убедитесь, что для шлюзов ExpressRoute и VPN используется правильный номер SKU на основе требований к пропускной способности и производительности.

- Развертывание шлюза ExpressRoute, избыточного в зоне, в поддерживаемых регионах Azure.

- Для сценариев, требующих пропускной способности выше 10 Гбит/с или выделенных 10/100 Гбит/с, используйте ExpressRoute Direct.

- Если требуется низкая задержка или пропускная способность из локальной среды в Azure должна быть больше 10 Гбит/с, включите Фастпас для обхода шлюза ExpressRoute по пути к данным.

- Используйте VPN-шлюзы для подключения ветвей или удаленных расположений к Azure. Чтобы повысить устойчивость, разверните избыточные зоны (если они доступны).

- Используйте Global Reach ExpressRoute для подключения крупных офисов, региональных офисов и центров обработки данных, подключенных к Azure через ExpressRoute.

- Если требуется изоляция трафика или выделенная пропускная способность (например, для разделения рабочих и непроизводственных сред), следует использовать разные каналы ExpressRoute, чтобы обеспечить изолированные домены маршрутизации и устранить риски с помехами.

- Упреждающий мониторинг каналов ExpressRoute с помощью Монитор производительности сети.

- Не используйте явно каналы ExpressRoute в одном расположении пиринга, так как это создает единую точку отказа и делает вашу организацию уязвимой для сбоев в связи с одноранговым расположением.

- Не используйте один и тот же канал ExpressRoute для подключения нескольких сред, требующих изоляции или выделенной пропускной способности, чтобы избежать рисков, связанных с помехами.

## <a name="connectivity-to-azure-paas-services"></a>Подключение к службам PaaS Azure

Основываясь на предыдущих разделах подключения, в этом разделе рассматриваются рекомендуемые подходы к подключению при использовании служб PaaS Azure.

**Рекомендации по проектированию:**

- Службы Azure PaaS обычно обращаются к общедоступным конечным точкам. Однако Платформа Azure предоставляет возможности для защиты таких конечных точек или даже сделать их полностью закрытыми.

  - Внедрение виртуальной сети предоставляет выделенные частные развертывания для поддерживаемых служб. Но трафик в плоскости управления проходит через общедоступные IP-адреса.

  - [Частная ссылка](https://docs.microsoft.com/azure/private-link/private-endpoint-overview#private-link-resource) обеспечивает выделенный доступ с помощью частных IP-адресов к экземплярам PaaS Azure или настраиваемым службам за Azure Load Balancer стандарт.

  - Конечные точки службы виртуальной сети обеспечивают доступ на уровне служб из выбранных подсетей к выбранным службам PaaS.

- Предприятия часто сталкиваются с проблемами в отношении общедоступных конечных точек для служб PaaS, которые должны быть соответствующим образом устранены.

- Для [поддерживаемых служб](https://docs.microsoft.com/azure/private-link/private-link-overview#availability)частная ссылка решает проблемы утечка данных, связанные с конечными точками службы. Кроме того, фильтрацию исходящего трафика через NVA можно использовать для предоставления шагов по устранению утечка данных.

**Рекомендации по проектированию:**

- Используйте внедрение виртуальной сети для поддерживаемых служб Azure, чтобы сделать их доступными в виртуальной сети.

- Службы PaaS Azure, которые были добавлены в виртуальную сеть, по-прежнему выполняют операции плоскости управления с использованием общедоступных IP-адресов. Убедитесь, что это взаимодействие заблокировано в виртуальной сети с помощью определяемые пользователем маршруты и группы безопасности сети.

- Используйте ссылку частная ссылка, если она доступна, для общих служб Azure PaaS. Частная ссылка общедоступна для нескольких служб и доступна в общедоступной предварительной версии для многих из них. Доступность частной ссылки подробно описана [здесь](https://docs.microsoft.com/azure/private-link/private-link-overview#availability).

- Доступ к службам Azure PaaS из локальной среды через частный пиринг ExpressRoute с помощью внедрения виртуальной сети для выделенных служб Azure или частной ссылки Azure для доступных общих служб Azure. Чтобы получить доступ к службам Azure PaaS из локальной среды, если внедрение виртуальной сети или закрытая ссылка недоступны, используйте ExpressRoute с пирингом Майкрософт. Это позволит избежать пересылки через общедоступный Интернет.

- Используйте конечные точки службы виртуальной сети для защиты доступа к службам PaaS Azure из виртуальной сети, но только если частная связь недоступна и нет проблем с утечка данных. Чтобы устранить проблемы утечка данных с конечными точками службы, используйте фильтрацию NVA или используйте политики конечных точек службы виртуальной сети для хранилища Azure.

- Не включайте конечные точки службы виртуальной сети по умолчанию во всех подсетях.

- Не используйте конечные точки службы виртуальной сети, если есть проблемы с утечка данных, если не используется фильтрация NVA.

- Не рекомендуется реализовывать принудительное туннелирование, чтобы обеспечить подключение из Azure к ресурсам Azure.

## <a name="planning-for-inbound-and-outbound-internet-connectivity"></a>Планирование входящего и исходящего подключения к Интернету

В этом разделе описываются рекомендуемые модели подключения для входящего и исходящего подключения к общедоступному Интернету.

**Рекомендации по проектированию:**

- Собственные службы безопасности сети Azure, такие как брандмауэр Azure, брандмауэр веб-приложения Azure (WAF) в шлюзе приложений Azure, а также передняя дверца Azure — это полностью управляемые службы, поэтому вы не будете тратить затраты на операционные ресурсы и управление, связанные с развертываниями инфраструктуры, которые могут быть сложными в масштабе.

- Архитектура корпоративного уровня полностью совместима с Nvaами сторонних производителей, если ваша организация предпочитает использовать NVA или в ситуациях, когда собственные службы не удовлетворяют конкретным требованиям Организации.

**Рекомендации по проектированию:**

- Используйте брандмауэр Azure, чтобы управлять:

  - Исходящий трафик Azure в Интернете

  - Входящие подключения, отличные от HTTP/S

  - Фильтрация трафика "Восток-Западная" (если это требуется для организации)

- Используйте диспетчер брандмауэра с виртуальной глобальной сетью для развертывания и управления брандмауэрами Azure через виртуальные глобальные сети или концентраторы виртуальных сетей. Диспетчер брандмауэра теперь находится в общедоступной версии для виртуальной глобальной сети и регулярного виртуальных сетей.

- Создайте глобальную политику брандмауэра Azure для управления уровнем безопасности в глобальной сетевой среде и назначьте его всем экземплярам брандмауэра Azure. Разрешите детальные политики для удовлетворения требований конкретных регионов, делегируя добавочные политики брандмауэра локальным группам безопасности через RBAC.

- Настройка поддерживаемых сторонних поставщиков безопасности SaaS в диспетчере брандмауэра, если вашей организации требуется использовать такие решения для защиты исходящих соединений.

- Используйте WAF в виртуальной сети целевой зоны для защиты входящего трафика HTTP/S из Интернета.

- Используйте переднюю дверцу Azure и политики WAF, чтобы обеспечить глобальную защиту в регионах Azure для входящих подключений HTTP/S к целевой зоне.

- При использовании передней дверцы Azure и шлюза приложений Azure для защиты приложений HTTP/S используйте политики WAF в передней дверце Azure и заблокируйте шлюз приложений Azure, чтобы получать трафик только из передней дверцы Azure.

- Если требуются сторонние NVA для защиты и фильтрации трафика "Восток-Западная" и "Южная-Северный":

   - Для топологий сетей виртуальной глобальной сети разверните NVA в отдельной виртуальной сети (например, NVA VNet) и подключите ее к региональному виртуальному концентратору глобальной сети и зонам размещения, которым требуется доступ к NVA, как описано в этой [статье](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-route-table-portal).
   - Для топологий невиртуальной глобальной сети разверните NVA стороннего производителя в центральном виртуальном концентраторе.

- Если для входящих подключений HTTP/S требуются сторонние NVA, они должны быть развернуты в виртуальной сети целевой зоны и вместе с приложениями, которые защищаются и предоставляют доступ к Интернету.

- Используйте [планы защиты Azure от атак DDoS Protection Standard](https://docs.microsoft.com/azure/virtual-network/ddos-protection-overview) для защиты всех общедоступных конечных точек, размещенных в виртуальных сетей.

- Не следует выполнять репликацию локальных концепций и архитектур ДЕМИЛИТАРИЗОВАНной зоны в Azure, так как вы можете использовать аналогичные возможности безопасности в Azure, как и в локальной среде, но реализация и архитектура должны быть адаптированы в облако.

## <a name="planning-for-app-delivery"></a>Планирование доставки приложений

В этом разделе рассматриваются основные рекомендации по обеспечению безопасности, высокой масштабируемости и высокой доступности внутренних и внешних приложений.

**Рекомендации по проектированию:**

- Azure Load Balancer (внутренний и общедоступный) обеспечивает высокий уровень доступности для доставки приложений на региональном уровне.

- Шлюз приложений Azure обеспечивает безопасную доставку приложений HTTP/S на региональном уровне.

- Передняя дверца Azure обеспечивает безопасную доставку высокодоступных приложений HTTP/S в регионах Azure.

- Диспетчер трафика Azure позволяет доставлять глобальные приложения.

**Рекомендации по проектированию:**

- Доставка приложений для внутренних и внешних приложений должна выполняться в зонах размещения.

- Для безопасной доставки приложений HTTP/S используйте шлюз приложений версии 2 и убедитесь, что включены WAF защита и политики.

- Используйте NVA стороннего производителя, если не удается использовать шлюз приложений версии 2 для обеспечения безопасности приложений HTTP/S.

- Шлюз приложений Azure версии 2 или сторонние NVA, используемые для входящих подключений HTTP/S, следует развертывать в виртуальной сети целевой зоны и с приложениями, которые они защищать.

- Все общедоступные IP-адреса в целевой зоне должны быть защищены с помощью стандартного плана защиты от атак DDoS.

- Глобальные приложения HTTP/S, которые охватывают регионы Azure, должны доставляться и защищаться с помощью передней дверцы Azure с политиками WAF.

- При использовании передней дверцы и шлюза приложений для защиты приложений HTTP/S используйте политики WAF в передней дверце Azure и заблокируйте шлюз приложений, чтобы получать трафик только от передней дверцы.

- Глобальные приложения, охватывающие протоколы, отличные от HTTP/S, должны доставляться с помощью диспетчера трафика.

## <a name="planning-for-landing-zone-network-segmentation"></a>Планирование сегментации сети для целевой зоны

В этом разделе рассматриваются ключевые рекомендации по обеспечению высоконадежной сегментации внутренних сетей в целевой зоне для обеспечения реализации бесконечных сетей без доверия.

**Рекомендации по проектированию:**

- Модель с нулевым доверием предполагает нарушение состояния и проверяет каждый запрос, как будто он происходит из неуправляемой сети.

- Расширенная реализация сети с нулевым доверием использует полностью распределенные входные и исходящие облачные микросети и более глубокое Micro-сегментацию.

- Группы безопасности сети могут использовать теги службы Azure для упрощения подключения к службам Azure PaaS.

- Группы безопасности приложений не охватывают или не обеспечивают защиту в виртуальных сетей.

- Журналы потоков NSG теперь поддерживаются с помощью шаблонов Azure Resource Manager.

**Рекомендации по проектированию:**

- Делегирование создания подсети владельцу целевой зоны. Это позволит им определять сегментирование рабочих нагрузок между подсетями (например, с помощью одной большой подсети, многоуровневого приложения или приложения, встраиваемого в виртуальную сеть). Группа платформы может использовать политику Azure, чтобы гарантировать, что NSG с определенными правилами (например, запретить входящий SSH или RDP из Интернета или разрешить или заблокировать трафик между зонами) всегда будет связан с подсетями с политиками только для запретов.

- Группы безопасности сети должен использоваться для защиты трафика между подсетями, а также трафиком "Восток-Западная" между платформой (трафик между зонами).

- Для защиты многоуровневых виртуальных машин в целевой зоне группа приложений должна использовать группы безопасности приложений на уровне подсети группы безопасности сети.

- Используйте группы безопасности группы безопасности сети и приложений для микросегментного трафика в целевой зоне и Избегайте использования центрального NVA для фильтрации потоков трафика.

- Включите журналы потоков NSG и переносите их в Аналитика трафика, чтобы получить представление о внутреннем и внешнем потоке трафика.

- Используйте группы безопасности сети, чтобы выборочно разрешить подключение между зонами.

- Для топологий виртуальных глобальных сетей направьте трафик между зонами с помощью брандмауэра Azure, если вашей организации требуются возможности фильтрации и ведения журнала для трафика, передаваемого между зонами.

## <a name="define-network-encryption-requirements"></a>Определение требований к шифрованию сети

В этом разделе рассматриваются основные рекомендации по обеспечению шифрования сети между локальной средой и Azure, а также между регионами Azure.

**Рекомендации по проектированию:**

- Стоимость и доступная пропускная способность обратно пропорциональны длине туннеля шифрования между конечными точками.

- При использовании VPN для подключения к Azure трафик шифруется через туннели IP-безопасности (IPsec).

- При использовании ExpressRoute с частным пиринг трафика в настоящее время не шифруется.

- Шифрование Максек можно применить к ExpressRoute Direct для обеспечения шифрования сети.

- В настоящее время Azure не поддерживает собственное шифрование через пиринг глобальной виртуальной сети. Если на сегодняшний день требуется шифрование между регионами Azure, виртуальных сетей можно подключить с помощью VPN-шлюзов, а не глобальной виртуальной сети.

**Рекомендации по проектированию:** ![ Потоки шифрования ](./media/enc-flows.png)
 _рис. 8. потоки шифрования._

- При установке VPN-подключений из локальной среды в Azure с помощью VPN-шлюзов трафик шифруется на уровне протокола с помощью туннелей IPsec, как показано на `Flow A` схеме выше.

- При использовании ExpressRoute Direct настройте [безопасность управления доступом к носителю (максек)](https://docs.microsoft.com/azure/expressroute/expressroute-howto-MACsec) , чтобы зашифровать трафик на уровне 2 между маршрутизаторами Организации и MSEE, как показано на `Flow B` схеме выше.

- В сценариях виртуальной глобальной сети, где Максек не является параметром (например, не используйте протокол ExpressRoute Direct), используйте VPN-шлюз виртуальной глобальной сети для установки туннелей IPsec через частный пиринг ExpressRoute. Это показано на `Flow C` схеме выше.

- В сценариях, не использующих виртуальную сеть, и где Максек не является параметром (например, не используйте протокол ExpressRoute Direct), сегодня единственными вариантами является использование NVA сторонних производителей для установки туннелей IPsec через частный пиринг ExpressRoute или установления VPN-туннеля через ExpressRoute с пиринг Майкрософт.

- Если необходимо зашифровать трафик между регионами Azure, используйте VPN-шлюзы для подключения виртуальных сетей между регионами.

- Используйте сторонние NVA в Azure для шифрования трафика через частный пиринг ExpressRoute на случай, если собственные решения, предлагаемые в Azure (как показано в последовательностях B и C выше), не соответствуют вашим требованиям.

## <a name="planning-for-traffic-inspection"></a>Планирование проверки трафика

Во многих отраслях организация требует, чтобы трафик в Azure, в частности входящий и исходящий Интернет-трафик, был зеркально отражен в сборщик сетевых пакетов для глубокой проверки и анализа. В этом разделе рассматриваются ключевые моменты и Рекомендуемые подходы к зеркальному отображению или касанию трафика в виртуальной сети Azure.

**Рекомендации по проектированию:**

<!-- docsTest:ignore TAP -->

- Кнопка " [Виртуальная сеть Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-tap-overview) " находится на этапе предварительной версии, но вам необходимо обратиться к `azurevnettap@microsoft.com` сведениям о доступности.

- Запись пакетов в наблюдатель за сетями общедоступна, но записи ограничены максимальным периодом в 5 часов.

**Рекомендации по проектированию:**

В качестве альтернативы отводам виртуальной сети Azure необходимо оценить следующие параметры.

- Используйте пакет наблюдателя за сетями для захвата, несмотря на ограниченное окно записи.

- Оцените, должны ли журналы потоков NSG v2 предоставлять необходимый уровень детализации.

- Используйте сторонние решения для сценариев, где требуется устойчивая проверка глубоких пакетов.

- Не Разрабатывайте пользовательское решение для зеркального отображения трафика. Хотя это и может быть приемлемым для небольших сценариев, такой подход не рекомендуется масштабировать из-за сложности и проблем, связанных с поддержкой, которые могут возникнуть.
