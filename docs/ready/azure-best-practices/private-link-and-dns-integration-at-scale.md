---
title: Частная ссылка и интеграция DNS в масштабе
description: Частная ссылка и интеграция DNS в масштабе
author: JefferyMitchell
ms.author: brblanch
ms.date: 02/18/2021
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: ready
ms.custom: think-tank
ms.openlocfilehash: 2d7afeca3547f5880e743b82c221f1ab58fdab11
ms.sourcegitcommit: b8f8b7631aabaab28e9705934bf67dad15e3a179
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101797988"
---
# <a name="private-link-and-dns-integration-at-scale"></a>Частная ссылка и интеграция DNS в масштабе

> В этой статье описывается, как интегрировать частную связь Azure для служб PaaS с зонами Частная зона DNS Azure в архитектурах центральных и периферийных сетей.

## <a name="introduction"></a>Введение

Многие клиенты создают свою сетевую инфраструктуру в Azure с помощью архитектуры концентратора и периферийной сети, где:

- Общие сетевые службы (такие как сетевые виртуальные устройства, шлюзы ExpressRoute и VPN или DNS-серверы) развертываются в виртуальной сети **концентратора** (VNet).
- **Лучевой** Виртуальных сетей используют эти общие службы через пиринг виртуальной сети.

В архитектурах центральных и периферийных сетей владельцы приложений обычно предоставляются с подпиской Azure, которая включает виртуальную сеть (*периферийную*), подключенную к виртуальной сети *концентратора* . В этой архитектуре они могут развертывать виртуальные машины и иметь частное подключение к другим виртуальных сетей или локальным сетям через ExpressRoute или VPN.

Интернет — исходящее подключение предоставляется через Центральный виртуальный сетевой модуль (NVA), например брандмауэр Azure.

Многие группы приложений создают свои решения с помощью сочетания ресурсов Azure IaaS и PaaS. Некоторые службы Azure PaaS (например, SQL Управляемый экземпляр) можно развернуть в клиенте виртуальных сетей. В результате трафик будет оставаться частным в сети Azure и будет полностью маршрутизироваться из локальной среды.

Однако некоторые службы Azure PaaS (например, служба хранилища Azure или Azure Cosmos DB) невозможно развернуть в виртуальных сетей клиента и доступны через общедоступную конечную точку. В некоторых случаях это может вызвать состязание с политиками безопасности клиента, так как корпоративный трафик может не допускать развертывания или доступа к корпоративным ресурсам (например, базе данных SQL) через общедоступные конечные точки.

[Частная связь Azure][link-1] предоставляет доступ к [списку служб Azure][link-2] через частные конечные точки, но это требует, чтобы эти записи закрытых конечных точек регистрировались в соответствующей [частной зоне DNS][link-3].

В этой статье описывается, как группы приложений могут развертывать службы PaaS Azure в своих подписках, которые доступны только через частные конечные точки.

В этой статье также описывается, как группы приложений могут обеспечить автоматическую интеграцию служб с частными зонами DNS через Azure Частная зона DNS. Удаление необходимости создавать или удалять записи вручную в DNS.

## <a name="private-link-and-dns-integration-in-hub-and-spoke-network-architectures"></a>Частная связь и интеграция DNS в архитектурах центральных и периферийных сетей

Зоны Частная зона DNS обычно размещаются централизованно в той же подписке Azure, в которой развернута виртуальная сеть концентратора. Этот центральный способ размещения основан на распределенном [разрешении][link-4] DNS-имен и других требованиях к централизованному разрешению DNS, например Active Directory. В большинстве случаев только администраторы сети или удостоверения имеют разрешения на управление записями DNS в этих зонах.

Группы приложений имеют разрешения на создание ресурсов Azure в собственной подписке. У них нет разрешений в подписке на централизованное подключение к сети, которая включает в себя управление записями DNS в частных зонах DNS. Это ограничение доступа означает, что у них нет возможности [создавать записи DNS, необходимые][link-4] при развертывании служб PaaS Azure с частными конечными точками.

На следующей схеме показана типичная высокоуровневая архитектура для корпоративных сред с централизованным разрешением DNS и разрешение имен для ресурсов закрытой ссылки с помощью Azure Частная зона DNS:

![изображение 1][image-1]

На предыдущей схеме важно выделить следующее:

- На локальных DNS-серверах имеются условные серверы пересылки, настроенные для каждого [общедоступного сервера пересылки зоны DNS][link-3] в частной конечной точке, указывающего на серверы пересылки DNS ( `10.100.2.4` и `10.100.2.5` ), размещенные в виртуальной сети концентратора.
- Все виртуальных сетей Azure имеют DNS-серверы пересылки ( `10.100.2.4` и `10.100.2.5` ), настроенные в качестве основного и дополнительного DNS-серверов.

Есть два условия, которые должны быть истинными, чтобы группы разработчиков приложений могли создавать необходимые ресурсы Azure PaaS в своей подписке:

- Централизованная сеть и (или) Группа центральной платформы должны гарантировать, что группы приложений могут развертывать и получать доступ к службам Azure PaaS только через частные конечные точки.
- Централизованная сеть и (или) группы центральной платформы должны гарантировать, что при создании частных конечных точек соответствующие записи автоматически создаются в централизованной частной зоне DNS, соответствующей созданной службе.
  - Запись DNS должна следовать за жизненным циклом частной конечной точки и автоматически удалять запись DNS при удалении частной конечной точки.

В следующих разделах описывается, как группы приложений могут включать эти условия с помощью [политики Azure][link-10]. Мы будем использовать службу хранилища Azure в качестве службы Azure, которую группы разработчиков должны развернуть в нашем примере ниже, но этот же принцип можно применить к большинству служб Azure, [поддерживающих][link-2] частную связь.

## <a name="configuration-required-by-platform-team"></a>Конфигурация, необходимая для команды платформы

### <a name="create-private-dns-zones"></a>Создание частных зон DNS

Создайте частные зоны DNS в подписке на центральное подключение для поддерживаемых служб частной связи в соответствии с [документацией][link-4].

В нашем случае, так как мы будем использовать **учетную запись хранения с BLOB-объектом** в качестве примера, она преобразуется в создание `privatelink.blob.core.windows.net` частной зоны DNS в подписке на подключение.

![изображение 2][image-2]

### <a name="policy-definitions"></a>Определения политик

Помимо частных зон DNS, нам также нужно [создать набор определений настраиваемых политик Azure][link-5] , чтобы принудительно использовать частные конечные точки и автоматизировать создание записей DNS в созданной зоне DNS.

1. **Запретить** общедоступную конечную точку для политики служб PaaS

   Эта политика не позволит пользователям создавать службы PaaS Azure с общедоступными конечными точками и выдаст сообщение об ошибке, если частная конечная точка не выбрана при создании ресурса.

   ![изображение 3][image-3]

   ![изображение 4][image-4]

   ![изображение 5][image-5]

   Точное правило политики может отличаться от служб PaaS. Для учетных записей хранения Azure мы рассмотрим свойство **networkAcls. defaultAction** , которое определяет, разрешены ли запросы из общедоступной сети. В нашем случае мы зададим условие, запрещающее создание типа ресурса **Microsoft. Storage/storageAccounts** , если свойство **networkAcls. defaultAction** имеет значение Not `Deny` . Это определение политики приведено ниже.

   ```json
   {
     "mode": "All",
     "policyRule": {
       "if": {
         "allOf": [
           {
             "field": "type",
             "equals": "Microsoft.Storage/storageAccounts"
           },
           {
             "field": "Microsoft.Storage/storageAccounts/networkAcls.defaultAction",
             "notequals": "Deny"
           }
         ]
       },
       "then": {
         "effect": "Deny"
       }
     }
   }
   ```

2. **Запретить** создание частной зоны DNS с помощью `privatelink` политики префикса

   Поскольку мы используем централизованную архитектуру DNS с условным сервером пересылки и частными зонами DNS, размещенными в подписках, управляемых платформой платформы, нам нужно запретить владельцам групп приложений создавать собственные частные зоны DNS и связывать службы с их подписками.

   Для этого необходимо убедиться, что когда группы приложений создают закрытую конечную точку, для параметра `Integrate with private DNS zone` необходимо задать значение `No` при использовании портал Azure.

   ![изображение 6][image-6]

   Если `Yes` выбрано значение, политика Azure не позволит создать закрытую конечную точку. В нашем определении политики мы отклоним создание типа ресурса **Microsoft. Network/приватеднсзонес** , если зона имеет `privatelink` префикс. Это определение политики описано ниже.

   ```json
   {
     "description": "This policy restricts creation of private DNS zones with the `privatelink` prefix",
     "displayName": "Deny-PrivateDNSZone-PrivateLink",
     "mode": "All",
     "parameters": null,
     "policyRule": {
       "if": {
         "allOf": [
           {
             "field": "type",
             "equals": "Microsoft.Network/privateDnsZones"
           },
           {
             "field": "name",
             "like": "privatelink*"
           }
         ]
       },
       "then": {
         "effect": "Deny"
       }
     }
   }
   ```

3. Политика **DeployIfNotExists** для автоматического создания требуемой записи DNS в Центральной частной зоне DNS

   Эта политика будет активирована, если ресурс закрытой конечной точки создается с учетом конкретной службы `groupId` . `groupId`— Это идентификатор группы, полученной от удаленного ресурса (службы), к которому должна подключаться эта частная конечная точка. Затем мы активируем развертывание в [`privateDNSZoneGroup`][link-6] частной конечной точке, которое используется для связывания частной конечной точки с нашей частной зоной DNS. В нашем примере для `groupId` больших двоичных объектов службы хранилища Azure `blob` ( `groupId` для других служб Azure можно найти в статье о **подресурсе в столбце подресурсов** ). [][link-4] Когда политика обнаружит, что `groupId` в созданной закрытой конечной точке она будет развертываться в частной [`privateDNSZoneGroup`][link-6] конечной точке, она будет связана с идентификатором ресурса частной зоны DNS, который указан в качестве параметра. В нашем примере идентификатор ресурса частной зоны DNS будет выглядеть следующим образом:

   `/subscriptions/<subscription-id>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/privateDnsZones/privatelink.blob.core.windows.net`

   Это определение политики приведено ниже.

   ```json
   {
     "mode": "Indexed",
     "policyRule": {
       "if": {
         "allOf": [
           {
             "field": "type",
             "equals": "Microsoft.Network/privateEndpoints"
           },
           {
             "count": {
               "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
               "where": {
                 "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                 "equals": "blob"
               }
             },
             "greaterOrEquals": 1
           }
         ]
       },
       "then": {
         "effect": "deployIfNotExists",
         "details": {
           "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
           "roleDefinitionIds": [
             "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
           ],
           "existenceCondition": {
             "allOf": [
               {
                 "field": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups/privateDnsZoneConfigs[*].privateDnsZoneId",
                 "equals": "[parameters('privateDnsZoneId')]"
               }
             ]
           },
           "deployment": {
             "properties": {
               "mode": "incremental",
               "template": {
                 "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                 "contentVersion": "1.0.0.0",
                 "parameters": {
                   "privateDnsZoneId": {
                     "type": "string"
                   },
                   "privateEndpointName": {
                     "type": "string"
                   },
                   "location": {
                     "type": "string"
                   }
                 },
                 "resources": [
                   {
                     "name": "[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                     "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                     "apiVersion": "2020-03-01",
                     "location": "[parameters('location')]",
                     "properties": {
                       "privateDnsZoneConfigs": [
                         {
                           "name": "storageBlob-privateDnsZone",
                           "properties": {
                             "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                           }
                         }
                       ]
                     }
                   }
                 ]
               },
               "parameters": {
                 "privateDnsZoneId": {
                   "value": "[parameters('privateDnsZoneId')]"
                 },
                 "privateEndpointName": {
                   "value": "[field('name')]"
                 },
                 "location": {
                   "value": "[field('location')]"
                 }
               }
             }
           }
         }
       }
     },
     "parameters": {
       "privateDnsZoneId": {
         "type": "String",
         "metadata": {
           "displayName": "privateDnsZoneId",
           "strongType": "Microsoft.Network/privateDnsZones"
         }
       }
     }
   }
   ```

### <a name="policy-assignments"></a>Назначения политик

После развертывания определений политик [назначьте политики][link-7] в нужной области иерархии группы управления. Убедитесь, что назначения политик предназначены для подписок Azure, которые будут использоваться группами приложений для развертывания служб PaaS с монопольным доступом к закрытым конечным точкам.

> [!IMPORTANT]
> Не забудьте назначить роль [роли участника зоны частная зона DNS][link-8] в подписке или группе ресурсов, где частные зоны DNS размещаются в [управляемом удостоверении, созданном `DeployIfNotExists` назначением политики][link-9] , которое будет отвечать за создание записи DNS частной конечной точки и управление ей в частной зоне DNS. Это связано с тем, что частная конечная точка находится в подписке Azure владелец приложения, а частная зона DNS находится в другой подписке (например, в подписке на центральное подключение).

После того как группа разработчиков завершит эту настройку, подписки Azure от групп приложений будут готовы к созданию служб PaaS Azure с монопольным доступом к закрытой конечной точке и обеспечению автоматической регистрации записей DNS для частных конечных точек (и их удаления после удаления частной конечной точки) из соответствующих частных зон DNS.

## <a name="application-owner-experience"></a>Взаимодействие с владельцем приложения

После того как группа разработки платформы развернула компоненты инфраструктуры платформы (частные зоны и политики DNS), описанные в предыдущем разделе, когда владелец приложения пытается развернуть службу PaaS Azure в подписке Azure, владелец приложения будет иметь следующий интерфейс, который будет таким же, если он выполняет действия через портал Azure или через другие клиенты, например PowerShell или CLI. , так как их подписки управляются политиками Azure.

1. Создайте учетную запись хранения с помощью портал Azure. На вкладке "основные" укажите имя и нужные параметры и нажмите кнопку **Далее**.

   ![Image-7][image-7]

2. В разделе Сетевые подключения убедитесь, что выбрана **Частная конечная точка** . Если выбран параметр, отличный от **закрытой конечной точки** , портал Azure не позволит создать учетную запись хранения в разделе " **Проверка и создание** " мастера развертывания, так как политика препятствует созданию этой службы, если включена общедоступная конечная точка.

   ![изображение 8][image-8]

3. Можно создать частную конечную точку на этом экране или выполнить ее после создания учетной записи хранения. В этом упражнении будет создана частная конечная точка после создания учетной записи хранения. Щелкните **Проверка + создать** и завершите создание учетной записи хранения.

4. После создания учетной записи хранения создайте закрытую конечную точку с помощью портал Azure

   ![изображение 9][image-9]

5. В разделе **ресурс** найдите учетную запись хранения, созданную на предыдущем шаге, и для пункта целевой подресурс выберите **большой двоичный объект**, а затем нажмите кнопку **Далее**.

   ![изображение-10][image-10]

6. В разделе **Конфигурация** после выбора виртуальной сети и подсетей убедитесь, что для параметра **Интеграция с частной зоной DNS** установлено значение **нет**. В противном случае портал Azure не позволит создать закрытую конечную точку, так как политика Azure не позволит создать частную зону DNS с `privatelink` префиксом.

   ![изображение 11][image-11]

7. Выберите **проверить и создать**, а затем щелкните **создать** , чтобы развернуть закрытую конечную точку.

8. Через несколько минут `DeployIfNotExists` будет активирована политика, и последующее `dnsZoneGroup` развертывание добавит необходимые записи DNS для частной конечной точки в централизованно управляемой зоне DNS.

9. После создания частной конечной точки выберите ее и проверьте ее полное доменное имя и частный IP-адрес:

   ![изображение 12][image-12]

10. Проверьте журнал действий для группы ресурсов, в которой была создана частная конечная точка, или проверьте журнал действий самой частной конечной точки. Вы заметите, что через несколько минут будет `DeployIfNotExist` выполнено действие политики, которое настраивает группу зон DNS в частной конечной точке:

    ![изображение-13][image-13]

11. Если группа Центральной сети перейдет в `privatelink.blob.core.windows.net` частную зону DNS, она подтвердит, что создана запись DNS для созданной закрытой конечной точки, а имя и IP-адрес совпадают со значениями в частной конечной точке.

    ![изображение — 14][image-14]

На этом этапе группы приложений могут использовать учетную запись хранения через частную конечную точку из любой виртуальной сети в центрально-лучевой сети и в локальной среде, так как запись DNS была автоматически записана в частной зоне DNS.

Если владелец приложения удаляет закрытую конечную точку, соответствующие записи в частной зоне DNS будут автоматически удалены.

[link-1]: /azure/private-link/private-link-overview
[link-2]: /azure/private-link/private-link-overview#availability
[link-3]: /azure/private-link/private-endpoint-dns#azure-services-dns-zone-configuration
[link-4]: /azure/private-link/private-endpoint-dns
[link-5]: /azure/governance/policy/tutorials/create-custom-policy-definition
[link-6]: /azure/templates/microsoft.network/2020-05-01/privateendpoints/privatednszonegroups
[link-7]: /azure/governance/policy/assign-policy-portal
[link-8]: /azure/dns/dns-protect-private-zones-recordsets
[link-9]: /azure/governance/policy/how-to/remediate-resources
[link-10]: /azure/governance/policy/overview
[image-1]: ./media/private-link-example-central-dns.png
[image-2]: ./media/private-link-storage-with-blob.jpg
[image-3]: ./media/private-link-storage-policy-step-1.jpg
[image-4]: ./media/private-link-storage-policy-step-2.jpg
[image-5]: ./media/private-link-storage-policy-step-3.jpg
[image-6]: ./media/private-link-private-dns-set-no.jpg
[image-7]: ./media/private-link-create-storage.jpg
[image-8]: ./media/private-link-network-private.jpg
[image-9]: ./media/private-link-create-private.jpg
[image-10]: ./media/private-link-target-blob.jpg
[image-11]: ./media/private-link-integrate-with-private.jpg
[image-12]: ./media/private-link-fqdn-private-ip.jpg
[image-13]: ./media/private-link-activity-log.jpg
[image-14]: ./media/private-link-check-private-dns.jpg
