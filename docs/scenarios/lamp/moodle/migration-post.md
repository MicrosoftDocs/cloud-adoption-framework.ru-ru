---
title: Дальнейшие действия после Moodle миграции
description: Узнайте, как выполнять дальнейшие действия после Moodle миграции.
author: BrianBlanchard
ms.author: brblanch
ms.date: 11/06/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: plan
ms.openlocfilehash: 8594919772cfccf3dd02769a14d62f64cb1ad995
ms.sourcegitcommit: a7eb2f6c4465527cca2d479edbfc9d93d1e44bf1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94714686"
---
# <a name="how-to-follow-up-after-a-moodle-migration"></a>Дальнейшие действия после Moodle миграции

## <a name="post-migration-tasks"></a>Задачи после переноса данных

Задачи, выполняемые после миграции, — это окончательные конфигурации приложений, включая настройку назначений журналов, SSL-сертификаты и задания запланированных задач/cron. Этот диапазон задач включает:

- Настройка приложений.
- Обновление путей к журналам в экземплярах масштабируемого набора виртуальных машин.
- Перезапуск серверов в экземплярах масштабируемого набора виртуальных машин.
- Обновление сертификатов.
- Обновление расположений сертификатов.
- Обновление локальной копии HTML.
- Перезапуск серверов PHP и nginx.
- Сопоставление DNS-имени с Azure Load Balancer IP.

## <a name="controller-virtual-machine-scale-set"></a>Масштабируемый набор виртуальных машин контроллера

### <a name="log-paths"></a>Пути к журналам

Локальная среда может иметь разные расположения путей к журналам, которые необходимо обновить с помощью путей к журналам Azure. Например,/Вар/лог/сислогс/мудле/акцесс.лог и/Вар/лог/сислогс/мудле/еррор.лог.

- Обновите расположение файла журнала. Эта команда открывает файл конфигурации:

  ```bash
  nano /etc/nginx/nginx.conf
  ```

- Измените расположение пути к журналу.

- Найдите `access_log` и и `error_log` обновите путь к журналу.

- Нажмите `CTRL+O` , чтобы сохранить и `CTRL+X` выйти.

### <a name="restart-servers"></a>Перезапустить серверы

Перезапустите серверы nginx и PHP-FPM:

  ```bash
  sudo systemctl restart nginx
  sudo systemctl restart php<phpVersion>-fpm
  ```

## <a name="controller-virtual-machine"></a>Виртуальная машина контроллера

### <a name="certificates"></a>Сертификаты

- Чтобы получить доступ к сертификатам, войдите в виртуальную машину контроллера.

- Сертификаты для приложения Moodle находятся в/мудле/цертс.

- Скопируйте файлы. CRT и. key в/мудле/цертс/. Имена файлов следует изменить на nginx. CRT и nginx. key, чтобы они были распознаны настроенными серверами nginx. В зависимости от локальной среды вы можете использовать SCP служебной программы или такой инструмент, как WinSCP, чтобы скопировать эти файлы на виртуальную машину контроллера.

- Команда для изменения имени сертификата.

  ```bash
  cd /path/to/certs/location
  mv /path/to/certs/location/*.key /moodle/certs/nginx.key
  mv /path/to/certs/location/*.crt /moodle/certs/nginx.crt
  ```

- Можно также создать самозаверяющий сертификат, который удобен только для тестирования.

  ```bash
  openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /moodle/certs/nginx.key \
   -out /moodle/certs/nginx.crt \
  -subj "/C=US/ST=WA/L=Redmond/O=IT/CN=mydomain.com"
  ```

- Рекомендуется, чтобы файлы сертификатов были доступны только для чтения владельцу и для этих файлов, которыми они принадлежат `www-data:www-data` .

  ```bash
  chown www-data:www-data /moodle/certs/nginx.*
   chmod 400 /moodle/certs/nginx.*
  ```

- Чтобы обновить расположение сертификата и открыть файл конфигурации, выполните следующие действия.

  ```bash
  nano /etc/nginx/sites-enabled/*.conf
  ```

- Чтобы изменить расположение пути сертификата, найдите `ssl_certificate` . Обновите путь к сертификату следующим образом:

```bash
   /moodle/certs/moodle/certs/nginx.crt;
   /moodle/certs/nginx.key;
```

- Нажмите `CTRL+O` , чтобы сохранить файл и `CTRL+X` выйти.

### <a name="update-the-local-html-copy"></a>Обновление локальной копии HTML

Локальная копия содержимого HTML-сайта Moodle ( `/moodle/html/moodle` ) создается в масштабируемом наборе виртуальных машин по адресу `/var/www/html/moodle` . Локальная копия обновляется только при наличии обновления в отметке времени. Выполните следующую команду из виртуальной машины контроллера, чтобы обновить отметку времени.

  ```bash
  sudo -s
  /usr/local/bin/update_last_modified_time.moodle_on_azure.sh
  ```

- Каждый раз, когда выполняется скрипт в последнем измененном файле метки времени ( `/moodle/html/moodle/last_modified_time.moodle_on_azure` ), `/moodle/html/moodle` содержимое каталога обновляется в локальной копии ( `/var/www/html` ).

### <a name="restart-servers"></a>Перезапустить серверы

- Перезапустите `nginx` `php-fpm` серверы и.

  ```bash
  sudo systemctl restart nginx
  sudo systemctl restart php<phpVersion>-fpm
  ```

### <a name="map-the-dns-name-to-the-azure-load-balancer-ip"></a>Сопоставьте имя DNS с Azure Load Balancerным IP-адресом.

- Сопоставление имен DNS с Azure Load Balancerным IP-адресом должно выполняться на уровне поставщика услуг размещения.

- Отключите **режим обслуживания** на веб-сайте Moodle.

- Выполните следующую команду в виртуальной машине контроллера:

  ```bash
  sudo /usr/bin/php admin/cli/maintenance.php --disable
  ```

- Чтобы проверить состояние сайта Moodle, выполните следующую команду:

  ```bash
  sudo /usr/bin/php admin/cli/maintenance.php
  ```

- Чтобы получить перенесенную веб-страницу Moodle, нажмите DNS-имя.

## <a name="frequently-asked-questions-and-troubleshooting"></a>Часто задаваемые вопросы и устранение неполадок

1. Ошибка: сбой подключения к базе данных: для таких ошибок, как _Подключение к базе данных_ , не _удалось подключиться к указанной базе данных_, по следующим причинам и решениям:

    - Сервер базы данных не установлен или не работает. Чтобы проверить это на наличие MySQL, попробуйте ввести следующую команду:

      ```bash
      $telnet database_host_name 3306
      ```

    - Вы должны получить зашифрованный ответ, который включает номер версии сервера MySQL.

    - Если вы пытаетесь запустить два экземпляра Moodle на разных портах, используйте IP-адрес узла (не localhost) в `$CFG->dbhost` параметре, например `$CFG->dbhost = 127.0.0.1:3308` .

    - Вы не создали базу данных Moodle или назначили пользователю необходимые привилегии для доступа к ней.

    - Параметры базы данных Moodle неверны. Имя базы данных, пользователь базы данных или пароль пользователя базы данных в файле конфигурации Moodle `config.php` неверны.

    - Убедитесь, что в имени пользователя или пароля MySQL отсутствуют апострофы или буквы, отличные от букв.

2. Ошибка: _500: Внутренняя ошибка сервера_: существует несколько возможных причин этой ошибки. Сначала проверьте журнал ошибок веб-сервера, который должен иметь более подробное объяснение. Ниже приведены некоторые известные возможности.

    - Синтаксическая ошибка в `.htaccess` `httpd.conf` файлах или. Способ написания директив зависит от того, какой файл используется. Для проверки ошибок конфигурации в файлах nginx можно использовать следующую команду:

      `nginx -t`

    - Веб-сервер выполняется под вашим именем пользователя, а все файлы имеют максимальный уровень разрешений 755. Убедитесь, что этот параметр задан для каталога Moodle на панели управления, или используйте эту команду, если у вас есть доступ к оболочке:

      ```bash
      chmod -R 755 moodle
      ```

3. Ошибка: _403: запрещено_.

    Эта ошибка означает, что значение memory_limit PHP недостаточно для скрипта PHP. Значение memory_limit — это допустимый объем памяти, который находится `64M` в приведенном выше примере (67108864 байт/1024 = 65536 КБ). 65536 КБ/1024 = 64 МБ). Необходимо увеличить значение PHP memory_limit, пока не исчезнет это сообщение. Это делается двумя способами:

    Метод 1. для размещенной установки следует обратиться в службу поддержки вашего узла, как это сделать. Множество разрешенных `.htaccess` файлов. Если это так, добавьте следующую строку в `.htaccess` файл или создайте ее в каталоге Moodle, если он еще не создан:

      ```bash
      php_value memory_limit <value>M
      Example: php_value memory_limit 40M
      ```

    Метод 2. Если у вас есть собственный сервер с доступом к оболочке, измените `php.ini` файл. Убедитесь, что он является правильным, путем возврата `phpinfo` выходных данных:

      ```bash
      memory_limit <value>M
      Example: memory_limit 40M
      ```

    Помните, что для внесения изменений в силу необходимо перезапустить веб-сервер `php.ini` . Альтернативой является отключение с `memory_limit` помощью команды "memory_limit 0".

4. Не удается войти в систему; зависнуть на экране входа.

    Это также может быть применено, если _время ожидания сеанса истекло. Выполните вход еще раз._ или _обнаружена ошибка сервера, влияющая на сеанс входа. Выполните вход повторно или перезапустите браузер._ Ниже приведены возможные причины и действия, которые можно предпринять для решения этой проблемы.

    - Во-первых, проверьте, является ли также проблемой основная учетная запись администратора, другая учетная запись вручную. Если пользователи используют внешний метод проверки подлинности (например, LDAP), то это может быть проблемой. Изолируйте причину и убедитесь, что она имеет значение Moodle, прежде чем продолжить.

    - Убедитесь, что жесткий диск не полон, что сервер находится в общем размещении и что вы не достигли квоты на дисковое пространство. Это предотвратит создание новых сеансов и не сможет войти в систему.

    - Внимательно проверьте разрешения в вашем `moodledata` регионе. Веб-сервер должен иметь возможность записи в `sessions` подкаталог.

5. Неустранимая ошибка: _$CFG->корневой элемент недоступен для записи. Администратор должен исправить разрешения для каталога! Выполняется выход._

    - Убедитесь, что разрешения Moodle и мудледата являются веб-данными: www-data. В противном случае измените разрешения группы и владельца. Следующая команда обновляет разрешения:

      ```bash
      sudo chown -R /moodle/moodledata
      ```

6. Не удалось найти курс верхнего уровня.

    - Если это происходит сразу после попытки установить Moodle, скорее всего это означает, что установка не завершена. Полная установка запросит у вас профиль администратора и назначит имя сайта непосредственно перед его завершением. Проверьте журналы на наличие ошибок, а затем удалите базу данных, чтобы снова запустить ее. Если вы использовали веб-установщик, попробуйте выполнить команду из командной строки.

7. Ссылка для входа не меняется при входе в систему. Я вошел в систему, но не сможет свободно перемещаться. Убедитесь, что URL-адрес в параметре совпадает с тем, который действительно `$CFG->wwwroot` используется для доступа к сайту.

8. Ошибки при отправке файла:

    - Если при отправке файла получено сообщение об ошибке " _файл не найден_ ", это означает, что на веб-сервере не включены аргументы косой черты. Попробуйте включить его.

    - Если веб-сервер не поддерживает аргументы косой черты, их можно отключить в Moodle, сняв флажок **использовать аргументы косой черты** в > администрирования сайта > сервере > HTTP.

      > [!WARNING]
      > Отключение аргументов косой черты приведет к тому, что пакеты SCORM не будут работать и отображаются предупреждения о аргументах косой черты!

9. Сайт находится в **режиме обслуживания**. Иногда Moodle зависает в **режиме обслуживания** и сообщение, что _этот сайт находится в состоянии обслуживания и сейчас недоступен_ , несмотря на попытки его отключить. При переводе Moodle в **режим обслуживания** он создает `maintenance.html` файл в `moodledata/maintenance.html` каталоге файла сайта. Чтобы устранить эту проблему, попробуйте выполнить следующие действия.

    - Убедитесь, что у пользователя веб-сервера есть разрешения на запись в каталог мудледата.
    - Удалите файл вручную `maintenance.html` .

10. Где найти журналы:

    - Системный журнал:
      - Во время обращения к странице создается журнал ошибок или доступа.
      - Они регистрируются в этом расположении: `/var/log/nginx/` .

    - Журнал cron:
      - Задание cron будет выполняться и будет обновлять локальную копию в экземпляре.
      - Путь имеет значение `/var/log/sitelogs/moodle/cron.log` .
