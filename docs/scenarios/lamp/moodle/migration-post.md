---
title: Дальнейшие действия после Moodle миграции
description: Узнайте, как выполнить Moodle миграцию. См. статью Обновление путей к журналам, перезагрузка серверов и выполнение других действий, необходимых для завершения миграции.
author: BrianBlanchard
ms.author: brblanch
ms.date: 11/30/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: plan
ms.openlocfilehash: 4975037dc30aa95bcb4bc58d69914970769e3183
ms.sourcegitcommit: 32e8e7a835a688eea602f2af1074aa926ab150c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/18/2020
ms.locfileid: "97687734"
---
# <a name="how-to-follow-up-after-a-moodle-migration"></a>Дальнейшие действия после Moodle миграции

## <a name="post-migration-tasks"></a>Задачи после переноса данных

После миграции Moodle необходимо выполнить некоторые задачи, выполняемые после миграции, чтобы завершить настройку. Ниже перечислены эти задачи.

- Обновление путей к журналам в экземплярах масштабируемых наборов виртуальных машин.
- Перезапуск серверов в экземплярах масштабируемых наборов виртуальных машин.
- Обновление сертификатов.
- Обновление расположений сертификатов.
- Обновление локальной копии HTML.
- Перезапуск серверов PHP и nginx.
- Сопоставление DNS-имени с адресом Azure Load Balancer.

## <a name="controller-virtual-machine-scale-set"></a>Масштабируемый набор виртуальных машин контроллера

Выполните следующие действия, чтобы завершить настройку масштабируемого набора виртуальных машин. Вам потребуется SSH-подключение к экземпляру масштабируемого набора виртуальных машин, используя частный IP адрес, как описано в разделе [доступ к масштабируемому набору виртуальных машин](azure-infra-config.md#access-the-virtual-machine-scale-set).

### <a name="update-log-paths"></a>Обновление путей к журналам

Локальная среда и Azure могут хранить файлы журналов в разных местах. Например, может потребоваться обновить следующие пути к журналам:

- `/var/log/syslogs/moodle/access.log`
- `/var/log/syslogs/moodle/error.log`

Чтобы обновить расположение файла журнала, выполните следующие действия.

1. Введите следующую команду, чтобы открыть файл конфигурации:

   ```bash
   nano /etc/nginx/nginx.conf
   ```

2. Поиск `access_log` и `error_log` Обновление путей к журналам.

3. Нажмите клавиши CTRL + O, чтобы сохранить изменения, и CTRL + X, чтобы закрыть файл.

### <a name="restart-servers"></a>Перезапустить серверы

Введите следующие команды, чтобы перезапустить серверы nginx и PHP-FPM:

```bash
sudo systemctl restart nginx
sudo systemctl restart php<php version>-fpm
```

## <a name="controller-virtual-machine"></a>Виртуальная машина контроллера

Выполните следующие действия, чтобы завершить настройку виртуальной машины контроллера.

### <a name="update-security-certificates"></a>Обновление сертификатов безопасности

1. Войдите в виртуальную машину контроллера. Сертификаты для приложения Moodle можно найти в `/moodle/certs` папке.

1. Скопируйте `.crt` файлы и `.key` в `/moodle/certs/` . Измените имена файлов на `nginx.crt` и `nginx.key` соответственно, чтобы настроенные серверы nginx распознали их. Если локальная среда поддерживает служебную программу SCP или такое средство, как WinSCP, эти файлы можно скопировать на виртуальную машину контроллера с помощью этих средств. В противном случае используйте следующие команды:

   ```bash
   cd /<path to certs location>
   mv /<path to certs location>/*.key /moodle/certs/nginx.key
   mv /<path to certs location>/*.crt /moodle/certs/nginx.crt
   ```

   В качестве альтернативы копированию файлов используйте следующие команды для создания самозаверяющего сертификата.

   ```bash
   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
   -keyout /moodle/certs/nginx.key \
   -out /moodle/certs/nginx.crt \
   -subj "/C=US/ST=WA/L=Redmond/O=IT/CN=mydomain.com"
   ```

   Для тестирования можно использовать только самозаверяющий сертификат.

1. Рекомендуется, чтобы файлы сертификатов принадлежали `www-data:www-data` и были доступны только для чтения владельцу. Введите следующие команды, чтобы внести эти изменения:

   ```bash
   chown www-data:www-data /moodle/certs/nginx.*
   chmod 400 /moodle/certs/nginx.*
   ```

1. Обновите расположение сертификата, выполнив следующие действия.

   1. Введите следующую команду, чтобы открыть файл конфигурации:

      ```bash
      nano /etc/nginx/sites-enabled/*.conf
      ```

   1. Найдите `ssl_certificate` в файле.

   1. Замените пути к сертификату следующими значениями:

      ```bash
      /moodle/certs/moodle/certs/nginx.crt;
      /moodle/certs/nginx.key;
      ```

    1. Нажмите клавиши CTRL + O, чтобы сохранить изменения, и CTRL + X, чтобы закрыть файл.

### <a name="update-local-html-copy"></a>Обновить локальную копию HTML

Локальная копия содержимого Moodle HTML-сайта `/moodle/html/moodle` создается в масштабируемом наборе виртуальных машин в этой папке: `/var/www/html/moodle` . Локальная копия обновляется только при изменении отметки времени. Введите эту команду в виртуальную машину контроллера, чтобы обновить отметку времени:

```bash
sudo -s
/usr/local/bin/update_last_modified_time.moodle_on_azure.sh
```

Файл метки времени последнего изменения `/moodle/html/moodle/last_modified_time.moodle_on_azure` содержит скрипт. При каждом запуске скрипта `/moodle/html/moodle` содержимое каталога обновляется в локальной копии `/var/www/html` .

### <a name="restart-servers"></a>Перезапустить серверы

Введите следующие команды, чтобы перезапустить `nginx` `php-fpm` серверы и:

```bash
sudo systemctl restart nginx
sudo systemctl restart php<php version>-fpm
```

### <a name="map-the-dns-name-to-the-azure-load-balancer-ip-address"></a>Сопоставьте DNS-имя с адресом Azure Load Balancer.

Выполните следующие действия на уровне поставщика услуг размещения, чтобы связать DNS-имя с Azure Load Balancerным IP:

1. Введите следующую команду на виртуальной машине контроллера, чтобы отключить режим обслуживания на веб-сайте Moodle:


   ```bash
   sudo /usr/bin/php admin/cli/maintenance.php --disable
   ```

1. Введите эту команду, чтобы проверить состояние сайта Moodle:

   ```bash
   sudo /usr/bin/php admin/cli/maintenance.php
   ```

1. Перейдите по имени DNS, чтобы просмотреть перенесенную веб-страницу Moodle.

## <a name="frequently-asked-questions-and-troubleshooting"></a>Часто задаваемые вопросы и устранение неполадок

Если у вас возникли вопросы о миграции Moodle, ознакомьтесь со следующими сведениями. Эти файлы журналов также могут помочь при устранении неполадок.

- Syslog-файлы:

  - Каждый раз, когда пользователь переходит на веб-страницу, система создает журнал ошибок или журнал доступа.
  - Их можно найти в этой папке: `/var/log/nginx/` .

- Файл журнала cron:
  - При запуске задания cron обновляет локальную копию файла журнала.
  - Файл можно найти в этой папке: `/var/log/sitelogs/moodle/cron.log` .

### <a name="database-connection-failure"></a>Сбой подключения к базе данных

Для таких ошибок, как *Подключение к базе данных завершилось сбоем* или *не удалось подключиться к указанной базе данных*, ниже приведены некоторые возможные причины и решения.

- Сервер базы данных не установлен или не работает. Чтобы проверить это условие в MySQL, введите следующую команду:

  ```bash
  $telnet database_host_name 3306
  ```

  Если база данных работает, вы должны получить ответ, включающий номер версии сервера MySQL.

- Адрес узла настроен неправильно. Если вы используете два экземпляра Moodle на разных портах, используйте IP-адрес узла, а не `localhost` в `$CFG->dbhost` параметре. Например, вы можете использовать следующие службы.

  `$CFG->dbhost = 127.0.0.1:3308`

- Вы не создали базу данных Moodle. Или вы не назначили достаточных разрешений для доступа к базе данных. Проверьте базу данных и предоставленные разрешения.

- Параметры базы данных Moodle неверны. Например, имя базы данных, имя пользователя или пароль в файле конфигурации Moodle `config.php` неверны. Убедитесь, что имя пользователя и пароль MySQL не содержат апострофы или символы, отличные от буквенно-цифровых.

### <a name="internal-server-error"></a>Внутренняя ошибка сервера

Существует несколько возможных причин возникновения этой ошибки: *500: Внутренняя ошибка сервера*. Начните с проверки журнала ошибок веб-сервера, который должен содержать подробное описание. Ниже приведены некоторые возможности.

- Синтаксическая ошибка в `.htaccess` `httpd.conf` файле или. Правильный синтаксис директив зависит от того, какой файл вы используете. Используйте следующую команду для проверки ошибок конфигурации в файлах nginx:

  ```bash
  `nginx -t`
  ```

- Веб-сервер работает под вашим именем пользователя, а разрешения на доступ неверны. В этом случае всем файлам требуется максимальный уровень разрешений 755. Убедитесь, что этот уровень задан для каталога Moodle на панели управления. Или используйте эту команду, чтобы задать уровень при наличии доступа к оболочке:

  ```bash
  chmod -R 755 moodle
  ```

### <a name="memory-limit-error"></a>Ошибка ограничения памяти

Если возникает ошибка *403: запрещено* , `memory_limit` значение PHP недостаточно велико для скрипта PHP. `memory_limit`Значение — это допустимый объем памяти. Увеличьте значение PHP `memory_limit` на небольшие величины, пока сообщение не исчезнет. Используйте один из следующих методов:

- Для размещенной установки попросите службу поддержки вашего узла увеличить значение. Во многих средах используются `.htaccess` файлы. Если установка выполняется, добавьте в файл следующую строку `.htaccess` :

  ```bash
  php_value memory_limit <value>M
  ```

  Например, чтобы увеличить значение до 40 МБ, введите:

  `php_value memory_limit 40M`

  Если `.htaccess` файл не существует, создайте его в каталоге Moodle с этой строкой.

- Если у вас есть собственный сервер с доступом к оболочке, измените `php.ini` файл. Затем перезапустите веб-сервер, чтобы применить изменения, внесенные в `php.ini` . Чтобы убедиться, что значение Обновлено правильно, введите следующую команду:

  ```bash
  `phpinfo`
  ```

  Выходные данные `phpinfo` должны содержать строку, аналогичную следующей:

  ```bash
  memory_limit <value>M
  ```

  Например, он может содержать следующую строку:

  `memory_limit 40M`

Альтернативой увеличению `memory_limit` значения является отключение ограничения памяти, введя следующую команду:

  ```bash
memory_limit 0
```

### <a name="sign-in-errors"></a>Ошибки входа

Иногда вы не можете войти в систему или видите одно из следующих сообщений:

- *Время ожидания сеанса истекло. Выполните вход еще раз.*

- *Обнаружена ошибка сервера, влияющая на сеанс входа. Выполните вход повторно или перезапустите браузер.*

Возможно, возникла проблема с методом проверки подлинности, особенно если для проверки подлинности пользователей используется внешний метод, такой как LDAP. Попробуйте войти в другую учетную запись вручную, например основную учетную запись администратора. Если вы не можете войти в систему, проверьте свою проверку подлинности. Если вы можете войти в другую учетную запись, Вот возможные причины и способы решения проблемы входа в Moodle:

- Возможно, ваш жесткий диск заполнен. В этом случае Moodle не может создать новые сеансы, и пользователи не смогут войти в систему. Убедитесь, что жесткий диск не полон, что сервер находится в общем размещении и что вы не достигли квоты на дисковое пространство.

- Веб-сервер не может выполнить запись в `sessions` подкаталог. Внимательно проверьте разрешения в вашем `moodledata` регионе.

### <a name="fatal-errors"></a>Неустранимые ошибки

Разрешения Moodle и мудледата могут быть неправильными, если возникла эта ошибка: *Неустранимая ошибка: $cfg->корневой элемент недоступен для записи. Администратор должен исправить разрешения для каталога! Выполняется выход.*

Убедитесь, что эти разрешения являются допустимыми `www-data:www-data` . Если разрешения находятся на другом уровне, используйте эту команду, чтобы изменить разрешения группы и владельца.

```bash
sudo chown -R /moodle/moodledata
```

### <a name="top-level-course-errors"></a>Ошибки курса верхнего уровня

Если не удается найти курс верхнего уровня сразу после установки Moodle, вероятно, установка не была завершена. Непосредственно перед завершением полной установки Moodle запросит у вас профиль администратора и запросит имя сайта. Если эти действия отсутствуют, проверьте журналы на наличие ошибок. Затем перезапустите базу данных. Если вы использовали веб-установщик, установите Moodle еще раз с помощью командной строки.

### <a name="navigation-errors"></a>Ошибки навигации

Если после входа в Moodle вы не сможете свободно перемещаться по адресу, конфигурация URL-адреса может быть неверной. Убедитесь, что URL-адрес в `$CFG->wwwroot` параметре совпадает с тем, который используется для доступа к сайту.

### <a name="file-upload-errors"></a>Ошибки передачи файлов

Если при отправке файла появляется сообщение об ошибке « *файл не найден* », возможно, ваш веб-сервер не включил аргументы косой черты.

- Если веб-сервер поддерживает аргументы косой черты, включите их.

- Если веб-сервер не поддерживает аргументы косой черты, отключите их в Moodle, сняв флажок **использовать аргументы косой черты** в окне **Администрирование**  >    >  **сервер** администрирование  >  **http**. Это сообщение может появиться.

  > [!WARNING]
  > Отключение аргументов косой черты приведет к тому, что пакеты SCORM не будут работать и отображаются предупреждения о аргументах косой черты!

### <a name="maintenance-mode-errors"></a>Ошибки режима обслуживания

Когда Moodle находится в режиме обслуживания и вы пытаетесь выйти из этого режима, иногда вы видите это сообщение: *этот сайт находится в состоянии обслуживания и сейчас недоступен*. Эта ситуация возникает при возникновении проблемы с `maintenance.html` файлом, который Moodle создает в `moodledata` папке при переходе в режим обслуживания. В этом случае выполните следующие действия.

- Убедитесь, что у пользователя веб-сервера есть разрешения на запись в `moodledata` каталоге.
- Удалите файл вручную `maintenance.html` .

## <a name="next-steps"></a>Дальнейшие действия

- [Документация по Базе данных Azure для MySQL](/azure/mysql/)
- [Что такое масштабируемый набор виртуальных машин?](/azure/virtual-machine-scale-sets/overview)
- [Общие сведения об учетной записи хранения](/azure/storage/common/storage-account-overview)
