---
title: Создание шлюза виртуальной сети и подключение через частный IP-адрес
description: Узнайте, как создать шлюз виртуальной сети и подключиться через частный IP-адрес.
author: BrianBlanchard
ms.author: brblanch
ms.date: 11/06/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: plan
ms.openlocfilehash: f4b3c36fcbebda0501a05f4b0751832202be9bd2
ms.sourcegitcommit: a7eb2f6c4465527cca2d479edbfc9d93d1e44bf1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94714691"
---
# <a name="how-to-create-a-virtual-network-gateway-and-connect-through-a-private-ip"></a>Создание шлюза виртуальной сети и подключение через частный IP-адрес

В этом документе объясняется, как настроить шлюз виртуальной сети в Azure.

## <a name="getting-started"></a>Начало работы

Создайте шлюз виртуальной сети в портал Azure, выполнив следующие действия.

- Найдите и выберите **шлюз виртуальной сети**.
- Нажмите кнопку **создать** , чтобы открыть окно.
- Заполните все поля, такие как **имя, регион, тип шлюза, номер SKU** и **Виртуальная сеть**. Сохранять остальные значения по умолчанию.
- Выберите виртуальную сеть, связанную с виртуальными машинами, созданными в той же группе ресурсов.
- Выберите **создать** , чтобы начать развертывание.

![Создание шлюза виртуальной сети.](images/vpn-gateway.png)

- Создайте шлюз виртуальной сети с помощью следующей Azure CLI команды:

    ```bash
    az network vnet-gateway create -g MyResourceGroup -n MyVnetGateway --public-ip-address MyGatewayIp --vnet MyVnet --gateway-type Vpn --sku VpnGw1 --vpn-type RouteBased --no-wait
    ```

## <a name="generate-certificates"></a>Создайте сертификаты.

- Откройте интегрированную среду сценариев Windows PowerShell с корневыми и дочерними сертификатами.

- Команда для создания корневых сертификатов:

  ```bash
  $cert = New-SelfSignedCertificate -Type Custom -KeySpec Signature `
  -Subject "CN=P2SRootCert" -KeyExportPolicy Exportable `
  -HashAlgorithm sha256 -KeyLength 2048 `
   -CertStoreLocation "Cert:\CurrentUser\My" -KeyUsageProperty Sign -KeyUsage CertSign
  ```

- Команда для создания дочернего сертификата:

  ```bash
  New-SelfSignedCertificate -Type Custom -DnsName P2SChildCert -KeySpec Signature `
  -Subject "CN=P2SChildCert" -KeyExportPolicy Exportable `
  -HashAlgorithm sha256 -KeyLength 2048 `
  -CertStoreLocation "Cert:\CurrentUser\My" `
  -Signer $cert -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.2")
  ```

## <a name="export-certificates"></a>Экспорт сертификатов

Выполните следующие действия, чтобы можно было успешно установить сертификаты в локальных системах.

- Откройте консоль управления (MMC), чтобы экспортировать сертификаты.
- Перейдите к **выполнению**. Введите **MMC** , чтобы открыть сертификаты.
- Выберите **Сертификаты** в папке **Личные** , чтобы открыть страницу.
- Обновите страницу, чтобы найти **корневые и дочерние сертификаты**.

Типы сертификатов:

**Чтобы экспортировать корневые сертификаты, выполните следующие действия.**

- Выберите корневой сертификат, щелкните и удерживайте (или щелкните правой кнопкой мыши) в сертификате, а затем выберите **все задачи**.
- Выберите **Экспорт** для нового окна, а затем нажмите кнопку **Далее**.
- Выберите **нет, не экспортировать закрытый ключ** , а затем нажмите кнопку **Далее**.
- Выберите **base-64 Encoded X. 509 (. cer)** , а затем нажмите кнопку **Далее**.
- Нажмите кнопку **Обзор и выберите путь**, введите имя и нажмите кнопку **Далее**.
- Это сообщение появится: **Экспорт выполнен успешно**.

**Чтобы экспортировать дочерние сертификаты, выполните следующие действия.**

- Выберите сертификат клиента, выберите и удерживайте (или щелкните правой кнопкой мыши) в сертификате, а затем выберите **все задачи**.
- Выберите **Экспорт** для нового окна, а затем нажмите кнопку **Далее**.
- Выберите **Да**, **экспортировать закрытый ключ**, а затем нажмите кнопку **Далее**.
- Выберите файл **обмена личной информацией**, **PKCS**, а затем нажмите кнопку **Далее**.
- Установите флажок пароль и укажите пароль.
- Задайте для параметра шифрование TripleDES-SHA1 и нажмите кнопку **Далее**.
- Нажмите кнопку **Обзор и выберите путь**, введите имя и нажмите кнопку **Далее**.
- Это сообщение появится: **Экспорт выполнен успешно**.
- Откройте файл корневого сертификата в редакторе выбора и скопируйте код.

## <a name="configure-the-virtual-network-gateway"></a>Настройка шлюза виртуальной сети

- Перейдите к группе ресурсов, в которой создан шлюз виртуальной сети.
- Перейдите к конфигурации "точка — сеть" на панели слева.
- Щелкните настроить сейчас на центральной панели.
- Добавьте пул адресов (например, 192.168. XX. 0/24).
- В качестве **типа туннеля** выберите **IKEv2**.
- Задайте тип проверки подлинности **сертификация Azure**.
- Вставьте скопированный код корневого сертификата на портал, присвойте ему имя **root** и выберите **сохранить**.

## <a name="download-and-connect-to-the-vpn-client"></a>Скачайте VPN-клиент и подключитесь к нему.

- Скачайте VPN-клиент после сохранения конфигурации на портале.
- Откройте ZIP-файл скачанного клиента VPN, откройте `WindowsAMD64` папку и установите `VPNClinetsetupAMD64` файл.
- Перейдите в раздел **Управление подключениями панел\нетворк и интернет\нетворк** , чтобы увидеть установленную виртуальную частную сеть.
- Щелкните VPN правой кнопкой мыши и выберите **подключить**.
- Откроется новое окно. Нажмите кнопку **подключить** , чтобы установить подключение.

Подключение к VPN-шлюзу установлено.

## <a name="log-in-to-the-virtual-machine"></a>Войдите на виртуальную машину.

- Войдите в виртуальную машину с частным IP-адресом с помощью ключа SSH.

- Выполните следующую команду, чтобы задать пароль для проверки подлинности:

  ```bash
  sudo vi /etc/ssh/sshd_config
  ```

- Обновите эти параметры. Измените тип проверки подлинности с **"нет" на "Да"**, найдите UserLogin с комментариями, удалите **no** **#** комментарий и измените на **"Да"**.

- Нажмите клавишу `ESC` и введите, `:wq!` чтобы сохранить изменения.

- Перезапустите SSHD:

  ```bash
  sudo systemctl restart sshd
  ```

- Длина пароля должна составлять 14 символов. Задайте пароль с помощью следующей команды:

  ```bash
  sudo passwd <username>
  ```

  Пример: `sudo passwd azureadmin`

Проверка подлинности пароля завершена.

## <a name="log-in-to-virtual-machine-instance-from-a-controller-virtual-machine"></a>Вход в экземпляр виртуальной машины из виртуальной машины контроллера

- Войдите на виртуальную машину клиента.

- Выполните следующие команды для подключения к частной виртуальной машине:

  ```bash
  sudo ssh <username>@<private_IP>
  ```

Пример: `sudo ssh azureadmin@102.xx.xx.xx`

- Выполните запрос, чтобы ввести пароль.

## <a name="next-steps"></a>Следующие шаги

Перейдите к статье [Запуск ручного Moodle миграции](./migration-start.md) для получения сведений о дальнейших действиях в процессе миграции Moodle.
