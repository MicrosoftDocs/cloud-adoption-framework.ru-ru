---
title: Создание шлюза виртуальной сети и подключение к виртуальным машинам
description: Создайте шлюз виртуальной сети, сертификаты и VPN, а затем подключитесь к экземплярам масштабируемых наборов виртуальных машин с помощью SSH, используя частный IP-адрес и пароль.
author: UmakanthOS
ms.author: brblanch
ms.date: 11/30/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: plan
ms.custom: internal
ms.openlocfilehash: 0853343e96436c257ae9c621942a2843d5323cd1
ms.sourcegitcommit: b6f2b4f8db6c3b1157299ece1f044cff56895919
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "97025679"
---
# <a name="create-a-virtual-network-gateway-and-connect-to-vms"></a>Создание шлюза виртуальной сети и подключение к виртуальным машинам

После развертывания ресурсов Azure Moodle создайте шлюз виртуальной сети Azure, чтобы можно было подключиться к экземплярам масштабируемого набора виртуальных машин Moodle через частные IP-адреса.

## <a name="create-a-virtual-network-gateway"></a>Создание шлюза виртуальной сети

Шлюз виртуальной сети можно создать с помощью портал Azure или интерфейса командной строки Azure (Azure CLI).

[На портале Azure](https://portal.azure.com)

1. Найдите и выберите **шлюзы виртуальной сети**.

1. Выберите **создать шлюз виртуальной сети**.

1. На странице **Создание шлюза виртуальной сети** заполните следующие поля.
   - Выберите свою **подписку**.
   - Введите **имя** шлюза.
   - Выберите **виртуальную сеть** , развернутую с помощью шаблона Moodle Azure Resource Manager (ARM).
   - Введите **имя общедоступного IP-адреса**.

1. Оставьте остальные поля со значениями, заданные по умолчанию.

1. Выберите **Проверка + создать** и при прохождении проверки выберите **создать**.

![Снимок экрана, показывающий портал Azure создания шлюза виртуальной сети.](images/vpn-gateway.png)

Чтобы создать шлюз, выполните следующую команду Azure CLI:

```azurecli
az network vnet-gateway create -g <moodle resource group> -n <new virtual network gateway name> --public-ip-address <new gateway public ip address name> --vnet <moodle virtual network> --gateway-type Vpn --sku VpnGw1 --vpn-type RouteBased --no-wait
```

## <a name="generate-certificates"></a>Создайте сертификаты.

Используйте интегрированную среду сценариев Windows PowerShell для создания корневых и дочерних сертификатов.

- Выполните следующую команду, чтобы создать корневой сертификат:

  ```powershell
  $cert = New-SelfSignedCertificate -Type Custom -KeySpec Signature `
  -Subject "CN=P2SRootCert" -KeyExportPolicy Exportable `
  -HashAlgorithm sha256 -KeyLength 2048 `
  -CertStoreLocation "Cert:\CurrentUser\My" -KeyUsageProperty Sign -KeyUsage CertSign
  ```

- Выполните следующую команду, чтобы создать дочерний сертификат:

  ```powershell
  New-SelfSignedCertificate -Type Custom -DnsName P2SChildCert -KeySpec Signature `
  -Subject "CN=P2SChildCert" -KeyExportPolicy Exportable `
  -HashAlgorithm sha256 -KeyLength 2048 `
  -CertStoreLocation "Cert:\CurrentUser\My" `
  -Signer $cert -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.2")
  ```

## <a name="export-the-certificates"></a>Экспорт сертификатов

Экспортируйте сертификаты, чтобы установить их в системах.

1. В меню Пуск Windows выберите пункт **выполнить** и введите **MMC**.

1. В левой области навигации консоли управления (MMC) в папке **Личные** выберите **Сертификаты**. Найдите сертификаты **P2SRootCert** и **P2SChildCert** .

Чтобы экспортировать корневой сертификат, выполните следующие действия.

1. Щелкните правой кнопкой мыши или нажмите и удерживайте **P2SRootCert**, укажите **все задачи**, а затем выберите **Экспорт**.
1. В **мастере экспорта сертификатов** щелкните **Далее**.
1. Выберите **нет, не экспортировать закрытый ключ**, а затем нажмите кнопку **Далее**.
1. Выберите **base-64 Encoded X. 509 (. cer)** и нажмите кнопку **Далее**.
1. Введите имя файла и нажмите кнопку **Далее**.
1. Нажмите кнопку **Готово**.
1. Появится сообщение об **успешном экспорте** . Щелкните **ОК**.

Чтобы экспортировать дочерний сертификат, выполните следующие действия.

1. Щелкните правой кнопкой мыши или нажмите и удерживайте **P2SChildCert**, укажите **все задачи**, а затем выберите **Экспорт**.
1. В **мастере экспорта сертификатов** щелкните **Далее**.
1. Выберите **Да, экспортировать закрытый ключ**, а затем нажмите кнопку **Далее**.
1. Выберите **файл обмена личной информацией — PKCS #12 (. PFX)**, а затем нажмите кнопку **Далее**.
1. Установите флажок **пароль** и укажите и подтвердите пароль.
1. В разделе **Шифрование** выберите **TripleDES-SHA1**, а затем нажмите кнопку **Далее**.
1. Введите имя файла и нажмите кнопку **Далее**.
1. Нажмите кнопку **Готово**.
1. Появится сообщение об **успешном экспорте** . Щелкните **ОК**.

## <a name="configure-the-virtual-network-gateway"></a>Настройка шлюза виртуальной сети

1. Откройте файл экспортированного корневого сертификата в текстовом редакторе и скопируйте его содержимое.
1. В портал Azure перейдите к шлюзу виртуальной сети.
1. В области навигации слева выберите **Конфигурация "точка — сеть**".
1. Выберите **настроить сейчас**.
1. В разделе **пул адресов** введите пул адресов GatewaySubnet, например `192.168.xx.0/24` .
1. В разделе **Тип туннеля** выберите **IKEv2**.
1. В разделе **тип проверки подлинности** выберите **сертификация Azure**.
1. В разделе **корневые сертификаты**:
   - Введите **корневой** элемент для **имени**.
   - Вставьте скопированный код корневого сертификата в раздел **данные общедоступного сертификата**.
1. Щелкните **Сохранить**.

## <a name="download-and-connect-through-the-vpn-client"></a>Скачивание и подключение через VPN-клиент

Чтобы установить подключение к VPN-шлюзу, выполните следующие действия.

1. После сохранения конфигурации виртуальной частной сети в строке меню выберите **скачать VPN-клиент** .
1. Извлеките содержимое скачанного ZIP-файла клиента VPN, откройте `WindowsAMD64` папку и запустите `VpnClientSetupAmd64.exe` файл, чтобы установить VPN-клиент.
1. В Windows последовательно выберите **Панель управления**  >  **сеть и**  >  **Сетевые подключения** , чтобы просмотреть установленную виртуальную частную сеть.
1. Щелкните VPN правой кнопкой мыши и выберите **подключить**.
1. В окне **VPN** выберите **подключить**.

## <a name="configure-ssh-password-authentication"></a>Настройка проверки подлинности по паролю SSH

Чтобы настроить проверку подлинности с помощью пароля, на виртуальной машине контроллера выполните следующие действия.

1. Откройте `sshd` файл конфигурации для редактирования:

   ```bash
   sudo vi /etc/ssh/sshd_config
   ```

1. Обновите следующие параметры:

   - Измените `PasswordAuthentication` с `no` на `yes` .
   - Найдите комментарий `UseLogin` , удалите `#` и измените значение на `yes` .

1. Нажмите клавишу ESC и введите, `:wq!` чтобы сохранить изменения.

1. Перезапустите `sshd` , выполнив следующую команду:

   ```bash
   sudo systemctl restart sshd
   ```

1. Чтобы задать пароль, выполните следующую команду:

   ```bash
   sudo passwd <username>
   ```

Например, команда `sudo passwd azureadmin` задает пароль для пользователя `azureadmin` .

1. Введите пароль в приглашении и введите его снова.

## <a name="sign-in-to-vms-from-the-controller-vm"></a>Вход в виртуальные машины из виртуальной машины контроллера

Войдите в виртуальные машины масштабируемого набора с частными IP-адресами через SSH.

1. Войдите в виртуальную машину контроллера.

1. Выполните следующую команду, чтобы подключиться к частной виртуальной машине:

   ```bash
   sudo ssh <username>@<private IP address>
   ```

Пример: `sudo ssh azureadmin@102.xx.xx.xx`.

1. В командной строке введите пароль.

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте [Moodle шаги миграции вручную](migration-start.md) для дальнейших действий в процессе миграции Moodle.
