---
title: Топология сети корпоративного уровня и подключение для AKS
description: Узнайте, как этот сценарий корпоративного уровня может улучшить топологию сети и подключение службы Kubernetes Azure (AKS).
author: BrianBlanchard
ms.author: brblanch
ms.date: 03/01/2021
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: ready
ms.openlocfilehash: 695d46a7641ec300aaf7956537f2b8cd2a3363fa
ms.sourcegitcommit: b8f8b7631aabaab28e9705934bf67dad15e3a179
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101797510"
---
# <a name="network-topology-and-connectivity-for-azure-kubernetes-service-aks-enterprise-scale-scenario"></a>Топология сети и подключение для сценария корпоративного масштабирования службы Azure Kubernetes Service (AKS)

<!-- docutune:casing "Basic and Standard" -->

## <a name="design-considerations"></a>Рекомендации по проектированию

- AKS поддерживает две сетевые модели: кубенет и сетевой интерфейс контейнера Azure (CNI).
  - Для CNI требуется дополнительное планирование IP-адресов.
  - Только CNI поддерживает пул узлов и сетевых политик Windows Server.
  - для кубенет необходимо вручную применить определяемые пользователем маршруты (определяемые пользователем маршруты).
  - Проверьте [текущий список](/azure/aks/concepts-network#compare-network-models) поддерживаемых возможностей для каждого подключаемого модуля CNI.
- Для поддержки масштабирования кластера необходимо тщательно запланировать IP-адреса и размер подсети виртуальной сети. Например, можно добавить дополнительные узлы.
- Виртуальные узлы можно использовать для быстрого масштабирования кластера, но существуют некоторые [Известные ограничения](/azure/aks/virtual-nodes-portal).
- Кластеры AKS поддерживают номера SKU "базовый" и "Стандартный" Azure Load Balancer.
- AKS Services можно предоставлять с помощью общедоступных или внутренних подсистем балансировки нагрузки. Внутренние подсистемы балансировки нагрузки можно настроить в той же подсети, что и узлы Kubernetes, или в выделенной подсети.
- Политика Azure и [надстройка политики Azure для AKS](/azure/governance/policy/concepts/policy-for-kubernetes "Политика Azure для AKS") могут управлять и ограничивать объекты, созданные в кластере AKS, например, запрещая создание общедоступных IP-адресов в кластере.
- AKS использует Кореднс для обеспечения разрешения имен для модулей Pod, выполняющихся в кластере.
  - Кореднс будет разрешать внутренние домены непосредственно в кластере.
  - Другие домены будут перенаправляться на DNS-серверы, настроенные в виртуальной сети Azure, которые будут либо распознавательм Azure DNS по умолчанию, либо пользовательскими DNS-серверами, настроенными на уровне виртуальной сети.
- Исходящий сетевой трафик может быть отправлен через брандмауэр Azure или кластер сетевого виртуального устройства.
  - По умолчанию кластеры AKS имеют неограниченный исходящий доступ к Интернету.
  - Трафик исходящего трафика из кластера AKS можно отправить через брандмауэр Azure или кластер виртуального устройства сети, настроив определяемые пользователем маршруты в подсети AKS.
- По умолчанию все контейнеры pod в кластере AKS могут отправлять и получать трафик без ограничений. Политики сети Kubernetes можно использовать для повышения безопасности и фильтрации сетевого трафика между модулями Pod в кластере AKS. Для AKS доступны две [модели политики сети](/azure/aks/use-network-policies#network-policy-options-in-aks) .
- Сетка служб предоставляет такие возможности, как управление трафиком, устойчивость, политика, безопасность, надежная идентификация и наблюдаемость. Дополнительные сведения см. в разделе [критерии выбора](/azure/aks/servicemesh-about#selection-criteria).
- Механизмы глобальной балансировки нагрузки, такие как [диспетчер трафика Azure](/azure/traffic-manager/traffic-manager-overview) и [Передняя дверца Azure](/azure/frontdoor/front-door-overview) , увеличивают устойчивость, направляя трафик между несколькими кластерами, потенциально в разных регионах Azure.

### <a name="private-clusters"></a>Частные кластеры

Видимость IP-адресов кластера AKS может быть либо общедоступной, либо частной. [Частные кластеры](/azure/aks/private-clusters) предоставляют API Kubernetes через частный IP-адрес, но не через открытый. Этот частный IP-адрес фактически представлен в виртуальной сети AKS с помощью [частной конечной точки](/azure/private-link/private-endpoint-overview). Доступ к API Kubernetes через его IP-адрес невозможен, а через его полное доменное имя (FQDN). Разрешение полного доменного имени API Kubernetes в IP-адрес обычно выполняется [зоной Azure частная зона DNS](/azure/dns/private-dns-overview). Эта зона DNS может быть создана Azure в [группе ресурсов узла AKS](/azure/aks/faq#why-are-two-resource-groups-created-with-aks). Кроме того, можно указать [существующую зону DNS](/azure/aks/private-clusters#no-private-dns-zone-prerequisites).

Ниже приведены проверенные рекомендации корпоративного уровня. разрешение DNS для рабочих нагрузок Azure предоставляется централизованными DNS-серверами, развернутыми в подписке на подключение, в виртуальной сети концентратора или в виртуальной сети общих служб, подключенной к виртуальной глобальной сети Azure. Эти серверы будут условно разрешать конкретные и общедоступные имена Azure с помощью Azure DNS (IP-адреса `168.63.129.16` ), а также закрытых имен с помощью корпоративных DNS-серверов. Однако эти централизованные DNS-серверы не смогут разрешить полное доменное имя API AKS, пока они не будут подключены к частной зоне DNS, созданной для кластера AKS. Обратите внимание, что каждый AKS будет иметь уникальную частную зону DNS, так как случайный идентификатор GUID добавляется в начало имени зоны. Следовательно, для каждого нового кластера AKS соответствующая частная зона DNS должна быть подключена к виртуальной сети, где расположены Центральные DNS-серверы.

Все виртуальные сети должны быть настроены на использование этих центральных DNS-серверов для разрешения имен. Однако если виртуальная сеть AKS настроена для использования центральных DNS-серверов, но они не подключены к частной зоне DNS, то узлы AKS не смогут разрешить полное доменное имя API Kubernetes, и создание кластера AKS завершится сбоем. Виртуальная сеть AKS должна быть настроена для использования центральных DNS-серверов только после создания кластера.

После создания кластера подключение будет создано между частной зоной DNS и виртуальной сетью, в которой развернуты центральные DNS-серверы. Виртуальная сеть AKS также настроена на использование центральных DNS-серверов в подписке на подключение, и доступ администратора к API AKS Kubernetes будет осуществляться следующим образом:

![Частный кластер](./media/network-private-cluster.png)

> [!NOTE]
> Изображения в этой статье отразится на проектировании с использованием традиционной модели подключения концентратора и звезды. Корпоративные зоны корпоративного уровня могут использовать модель подключения виртуальной глобальной сети, в которой центральные DNS-серверы будут находиться в виртуальной сети общих служб, подключенной к виртуальному концентратору глобальной сети.

1. Администратор будет разрешать полное доменное имя API Kubernetes. Локальные DNS-серверы перенаправляют запрос к полномочным серверам — разрешениям DNS в Azure. Эти серверы перенаправляют запрос на сервер Azure DNS ( `168.63.129.16` ), который выполнит поиск IP-адреса из зоны частная зона DNS Azure.
2. После разрешения IP-адреса трафик к API Kubernetes направляется из локальной среды в шлюз VPN или ExpressRoute в Azure в зависимости от модели подключения.
3. Частная конечная точка будет содержать `/32` маршрут в виртуальной сети концентратора, поэтому шлюзы VPN и ExpressRoute будут отсылать трафик прямо в закрытую конечную точку API Kubernetes, развернутую в виртуальной сети AKS.

### <a name="traffic-from-application-users-to-the-cluster"></a>Трафик от пользователей приложения к кластеру

Поступающие (входящие) контроллеры можно использовать для предоставления приложений, работающих в кластерах AKS.

- Входящие контроллеры обеспечивают маршрутизацию на уровне приложений за счет незначительного увеличения сложности.
- Входящие контроллеры могут включать функции брандмауэра веб-приложения (WAF).
- Контроллеры входящего трафика могут выполняться в автономном кластере и в кластере:
  - Входящий в состав кластера входящий контроллер разгружает вычисление (например, маршрутизацию трафика HTTP или завершение TLS) в другую службу за пределами AKS, например [надстройку шлюза приложений Azure (агик)](/azure/application-gateway/ingress-controller-overview).
  - Решение в кластере потребляет ресурсы кластера AKS для вычислений (например, маршрутизацию трафика HTTP или завершение TLS). Контроллеры входящего трафика кластера могут предоставлять более низкие затраты, но они нуждаются в тщательном планировании и обслуживании ресурсов.
- Основная надстройка маршрутизации приложений HTTP очень проста в использовании, но имеет некоторые ограничения, описанные в статье [Маршрутизация приложений HTTP](/azure/aks/http-application-routing).

Входящие контроллеры могут предоставлять приложениям и API общедоступный или частный IP-адрес.

- Конфигурация должна быть согласована с макетом фильтрации исходящего трафика, чтобы избежать асимметричной маршрутизации.
- Если требуется завершение TLS, следует учитывать необходимость управления сертификатами TLS.

Трафик приложения может быть получен из локального или общедоступного Интернета. На следующем рисунке приведен пример, в котором [шлюз приложений Azure](/azure/application-gateway/overview) настроен для обратного прокси-подключения к кластерам как из локальной среды, так и из общедоступного Интернета.

![Трафик приложения](./media/network-app-access.png)

Трафик из локальной среды соответствует потоку нумерованных синих выносок на предыдущей схеме.

1. Клиент будет разрешать полное доменное имя, назначенное приложению, либо с помощью DNS-серверов, развернутых в подписке для подключения, либо на локальных DNS-серверах.
2. После разрешения полного доменного имени приложения на IP-адрес (частный IP-адрес шлюза приложений) трафик направляется через шлюз VPN или ExpressRoute.
3. Маршрутизация в подсети шлюза настраивается для отправки запроса в брандмауэр веб-приложения.
4. Брандмауэр веб-приложения отправляет допустимые запросы к рабочей нагрузке, работающей в кластере AKS.

Шлюз приложений Azure в этом примере можно развернуть в той же подписке, что и кластер AKS, так как ее конфигурация очень тесно связана с рабочими нагрузками, развернутыми в AKS, и поэтому управляется той же группой приложений. Доступ из Интернета следует за потоком нумерованных зеленых выносок на предыдущей схеме.

1. Клиенты из общедоступного Интернета разрешают DNS-имя для приложения с помощью [диспетчера трафика Azure](/azure/traffic-manager/traffic-manager-overview). Кроме того, можно использовать другие технологии глобальной балансировки нагрузки, такие как [Передняя дверца Azure](/azure/frontdoor/front-door-overview) .
2. Общедоступное полное доменное имя приложения будет разрешаться диспетчером трафика на общедоступный IP-адрес шлюза приложений, к которому клиенты обращаются через общедоступный Интернет.
3. Шлюз приложений будет обращаться к рабочей нагрузке, развернутой в AKS.

> [!NOTE]
> Эти потоки действительны только для веб-приложений. Приложения, не являющиеся веб-приложениями, выходят за рамки этой статьи. они могут быть предоставлены через брандмауэр Azure в виртуальной сети HUB или в защищенном виртуальном концентраторе при использовании модели подключения виртуальной глобальной сети.

Кроме того, трафик для веб-приложений можно использовать для обхода брандмауэра Azure в подписке подключения и WAF в виртуальной сети AKS. Этот подход имеет преимущество предоставления дополнительной защиты, например использование [фильтрации на основе логики брандмауэра Azure](/azure/firewall/threat-intel) для удаления трафика из известных вредоносных IP-адресов в Интернете. Однако у него тоже есть недостатки. Например, потерян исходный IP-адрес клиента, а также дополнительная координация, необходимая между брандмауэром и группами приложений при предоставлении приложений. Это связано с тем, что в брандмауэре Azure должны быть необходимы правила преобразования сетевых адресов назначения (ДНАТ).

### <a name="traffic-from-the-aks-pods-to-backend-services"></a>Трафик из модулей AKS в серверные службы

Для модулей Pod, выполняющихся в кластере AKS, может потребоваться доступ к серверным службам, таким как служба хранилища Azure, базы данных SQL Azure или базы данных NoSQL Azure Cosmos DB. [Конечные точки службы виртуальной сети](/azure/virtual-network/virtual-network-service-endpoints-overview) и [Частная ссылка](/azure/private-link/private-link-overview) могут использоваться для безопасного подключения к этим управляемым службам Azure.

Если вы используете частные конечные точки Azure для внутреннего трафика, разрешение DNS для служб Azure можно выполнить с помощью зон Частная зона DNS Azure. Так как арбитры DNS для всей среды находятся в виртуальной сети Hub (или в виртуальной сети общих служб при использовании модели подключения виртуальной глобальной сети), эти частные зоны должны быть созданы в подписке на подключение. Чтобы создать запись A, необходимую для разрешения полного доменного имени частной службы, можно связать частную зону DNS (в подписке подключения) с частной конечной точкой (в подписке приложения). Для этой операции требуются определенные права в каждой из этих подписок.

A-записи можно создать вручную, но связывание частной зоны DNS с частной конечной точкой приведет к снижению вероятности невозможности настройки.

Ниже приведена последовательность внутренних возможностей подключения из AKS Pod к службам Azure PaaS, предоставляемых через частные конечные точки.

![Внутренний трафик](./media/network-backend-access.png)

1. Модули AKS Pod будут разрешать полное доменное имя платформы Azure как службы (PaaS) с помощью центральных DNS-серверов в подписке на подключение, которые определены как пользовательские DNS-серверы в виртуальной сети AKS.
2. В качестве разрешенного IP-адреса будет использоваться частный IP-адрес частных конечных точек, доступ к которым осуществляется напрямую из модулей AKS.

Трафик между модулями Pod AKS и частными конечными точками по умолчанию не будет проходить через брандмауэр Azure в виртуальной сети концентратора (или в безопасном виртуальном концентраторе при использовании виртуальной глобальной сети), даже если в кластере AKS настроена фильтрация исходящего трафика [с помощью брандмауэра Azure](/azure/aks/limit-egress-traffic). Причина заключается в том, что частная конечная точка создаст `/32` маршрут в подсетях виртуальной сети приложения, где развернут AKS.

## <a name="design-recommendations"></a>Рекомендации по проектированию

- Если политика безопасности требует, чтобы API Kubernetes был частным IP-адресом (а не общедоступным IP-адресом), [разверните частный кластер AKS](/azure/aks/private-clusters).
  - Используйте пользовательские частные зоны DNS при создании частного кластера вместо того, чтобы позволить процессу создания использовать [закрытую зону DNS системы](/azure/aks/private-clusters#configure-private-dns-zone).
- Используйте интерфейс сетевого контейнера Azure (CNI) в качестве сетевой модели, если не существует ограниченного диапазона IP-адресов, которые можно назначить кластеру AKS.
  - Следуйте инструкциям по [планированию IP-адресов](/azure/aks/configure-azure-cni#plan-ip-addressing-for-your-cluster) с помощью CNI.
  - Чтобы проверить конечные ограничения с помощью пулов узлов Windows Server и виртуальных узлов, обратитесь к разделу [часто задаваемые вопросы о поддержке Windows AKS](/azure/aks/windows-faq).
- Используйте стандарт защиты Azure от атак DDoS для защиты виртуальной сети, используемой для кластера AKS.
- Используйте конфигурацию DNS, связанную с общей сетевой конфигурацией, с помощью виртуальной глобальной сети Azure или архитектуры HUB и периферийного сервера, Azure DNS зон и собственной инфраструктуры DNS.
- Используйте ссылку частная связь для защиты сетевых подключений и используйте частные подключения на основе IP к другим управляемым службам Azure, которые поддерживают частные ссылки, такие как служба хранилища Azure, реестр контейнеров Azure, база данных SQL Azure и Azure Key Vault.
- Используйте входной контроллер для обеспечения расширенной маршрутизации и безопасности HTTP, а затем предоставьте одну конечную точку для приложений.
- Чтобы сэкономить ресурсы вычислений и хранения в кластере AKS, используйте входной контроллер вне кластера.
  - Используйте надстройку "входящий [контроллер шлюза приложений Azure" (агик)](/azure/application-gateway/ingress-controller-overview) , которая является сторонней управляемой службой Azure.
  - С помощью АГИК разверните выделенный шлюз приложений Azure для каждого кластера AKS и не предоставляйте общий доступ к одному шлюзу приложений в нескольких кластерах AKS.
  - Если отсутствуют ресурсы или операционные ограничения, или АГИК не предоставляет необходимые функции, используйте встроенное решение контроллера входящего трафика, например NGINX, Траефик или любое другое решение, поддерживаемое Kubernetes.
- Для внутренних веб-приложений с доступом к Интернету и безопасности используйте брандмауэр веб-приложения с контроллером входящего трафика.
  - Шлюз приложений Azure и передняя дверца Azure интегрируют [WAF Azure](/azure/web-application-firewall/ag/ag-overview) для защиты веб-приложений.
- Если ваша политика безопасности требует проверки всего исходящего Интернет-трафика, созданного в кластере AKS, обеспечьте безопасный исходящий трафик с помощью брандмауэра Azure или сетевого виртуального модуля стороннего производителя (NVA), развернутого в виртуальной сети (управляемом) концентратора. Дополнительные сведения см. в разделе [ограничение исходящего трафика](/azure/aks/limit-egress-traffic).
