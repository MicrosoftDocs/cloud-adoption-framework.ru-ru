---
title: Разработка системы управления в Azure для нескольких команд
titleSuffix: Microsoft Cloud Adoption Framework for Azure
description: Руководство по настройке элементов управления Azure для нескольких команд, нескольких рабочих нагрузок и нескольких сред.
author: alexbuckgit
ms.author: abuck
ms.date: 09/17/2019
ms.topic: guide
ms.service: cloud-adoption-framework
ms.subservice: govern
ms.custom: governance
ms.openlocfilehash: caa9d3ced70ce15eacf37b4bcbb653efae9da1ef
ms.sourcegitcommit: 3669614902627f0ca61ee64d97621b2cfa585199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/06/2019
ms.locfileid: "73656687"
---
# <a name="governance-design-for-multiple-teams"></a>Разработка системы управления для нескольких команд

Цель этого руководства — помочь вам ознакомиться с разработкой модели системы управления ресурсами в Azure с поддержкой нескольких команд, рабочих нагрузок и сред. Сначала вы рассмотрите набор гипотетических требований к управлению, а затем рассмотрите несколько примеров реализации, которые отвечают этим требованиям.

Для этого необходимы следующие компоненты:

- Организация планирует назначить новые роли и обязанности по работе с облаком ряду пользователей, поэтому ей требуется возможность управлять удостоверениями нескольких команд с различными потребностями в доступе к ресурсам в Azure. В этой системе управления удостоверениями должны храниться удостоверения следующих пользователей:
  - Сотрудник организации, являющийся владельцем **подписок**.
  - Сотрудник организации, отвечающий за **ресурсы общей инфраструктуры**, которые используются для подключения локальной сети организации к виртуальной сети Azure.
  - Два сотрудника организации, отвечающих за управление **рабочей нагрузкой**.
- Поддержка нескольких **сред**. Среда — это логическое объединение ресурсов, например виртуальных машин, виртуальных сетей и служб маршрутизации сетевого трафика. К этим группам ресурсов предъявляются схожие требования к управлению и безопасности, а сами они обычно используются для определенных задач в тестовых или рабочих средах. В этом примере требование относится к четырем средам:
  - **Среда общей инфраструктуры**, которая включает общие ресурсы, разделяемые рабочими нагрузками в других средах. Например, виртуальная сеть с подсетью шлюза, обеспечивающая подключение к локальной сети.
  - **Рабочая среда** с наиболее строгими политиками безопасности. Может включать внутренние или внешние рабочие нагрузки.
  - Предварительная **Среда** для разработки и тестирования. Эта среда имеет политики безопасности, соответствий и затрат, которые отличаются от политик производственной среды. В Azure это принимает форму подписки Enterprise — разработка и тестирование.
  - **Среда "песочницы"** для подтверждения концепции и образовательных целей. Эта среда обычно назначается для каждого сотрудника, участвующего в действиях по разработке, и имеет ограниченную процедурную и операционную безопасность, чтобы предотвратить размещение корпоративных данных здесь. В Azure они принимают форму подписок Visual Studio. Эти подписки также _не_ должны быть привязаны к корпоративным Azure Active Directory.
- **Модель разрешений с наименьшими привилегиями**, при которой пользователи не имеют разрешений по умолчанию. Модель должна поддерживать следующее.
  - Один доверенный пользователь (рассматривается как учетная запись службы) в области действия подписки с разрешением на назначение прав доступа к ресурсам.
  - Каждому владельцу рабочей нагрузки по умолчанию запрещен доступ к ресурсам. Права доступа к ресурсам предоставляются явным образом одним доверенным пользователем в области группы ресурсов.
  - Доступ управления для общих ресурсов инфраструктуры, ограниченных владельцами общей инфраструктуры.
  - Доступ к управлению для каждой рабочей нагрузки, ограниченный владельцем рабочей нагрузки (в рабочей среде), и повышение уровня управления по мере роста разработки до промежуточного развертывания.
  - Предприятие не хочет управлять ролями независимо в каждой из трех основных сред, и поэтому требует использования только [встроенных ролей](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles) , доступных в управлении доступом на основе ролей Azure (RBAC). Если для предприятия абсолютно требуются пользовательские роли RBAC, для синхронизации пользовательских ролей в трех средах потребуются дополнительные процессы.
- Отслеживание затрат по имени владельца рабочей среды, по среде или по обоим.

## <a name="identity-management"></a>Управление удостоверениями

Прежде чем разрабатывать систему управления удостоверениями для модели системы управления, необходимо ознакомиться с четырьмя основными областями, которые она охватывает.

- **Администрирование:** Процессы и средства для создания, изменения и удаления удостоверений пользователей.
- **Проверка подлинности:** Проверка удостоверения пользователя путем проверки учетных данных, например имени пользователя и пароля.
- **Авторизация:** Определение ресурсов, к которым разрешен доступ пользователям, прошедшим проверку подлинности, или к каким операциям имеет разрешение на выполнение.
- **Аудит:** Периодически изучайте журналы и другие сведения для обнаружения проблем безопасности, связанных с удостоверением пользователя. Он включает проверку подозрительных шаблонов использования, периодический просмотр разрешений пользователей для проверки их точности и другие функции.

Существует только одна служба управления удостоверениями, являющаяся доверенной в Azure, — Azure Active Directory (Azure AD). Вы будете добавлять пользователей в Azure AD и использовать их для всех перечисленных выше функций. Но прежде чем посмотреть, как настроить Azure AD, важно понять суть привилегированных учетных записей, которые используются для управления доступом к этим службам.

При регистрации учетной записи организации в Azure назначается по крайней мере один **владелец учетной записи** Azure. При этом также создается **клиент** Azure AD. Исключением является ситуация, когда уже существует клиент, с помощью которого организация использует другие службы Майкрософт, например Office 365. Microsoft Azure Active Directory**Глобальный администратор** с полными правами при создании был связан с клиентом Microsoft Azure Active Directory.

Удостоверения пользователей — как владельца учетной записи Azure, так и глобального администратора Azure AD, — хранятся в надежной системе идентификации, управляемой корпорацией Майкрософт. Владелец учетной записи Azure имеет право создавать, обновлять и удалять подписки. Глобальный администратор Azure AD уполномочен выполнять множество действий в Azure AD, но в этом руководстве по проектированию рассматривается только создание и удаление удостоверения пользователя.

> [!NOTE]
> Возможно, у вашей организации уже есть клиент Azure AD, имеющий лицензию Office 365, Intune или Dynamics, связанную с вашей учетной записью.

У владельца учетной записи Azure есть разрешение на создание, обновление и удаление подписок.

![учетной записи Azure с помощью диспетчера учетных записей Azure и глобального администратора Azure AD](../../_images/govern/design/governance-3-0.png)
*рис. 1. учетная запись Azure с диспетчером учетных записей и глобальным администратором Azure AD.*

**Глобальный администратор** Microsoft Azure Active Directory имеет разрешение на создание учетных записей пользователей.

![учетной записи Azure с помощью диспетчера учетных записей Azure и глобального администратора Azure AD](../../_images/govern/design/governance-3-0a.png)
*рис. 2. Глобальный администратор Azure AD создает необходимые учетные записи пользователей в клиенте.*

Первые две учетные записи — **App1 Workload Owner** и **App2 Workload Owner** — связаны с сотрудником организации, отвечающим за управление рабочей нагрузкой. Учетная запись **пользователя сетевых операций** принадлежит лицу, ответственному за ресурсы общей инфраструктуры. Наконец, учетная запись **владельца подписок** связана с лицом, ответственным за право собственности на подписки.

## <a name="resource-access-permissions-model-of-least-privilege"></a>Модель разрешений доступа с наименьшими привилегиями

Теперь, когда создана система управления удостоверениями и учетные записи пользователей, вам необходимо решить, как применять управление доступом на основе ролей (RBAC) к каждой учетной записи для поддержки модели разрешений с наименьшими привилегиями.

Другое требование состоит в том, чтобы ресурсы, связанные с каждой рабочей нагрузкой, были изолированы друг от друга, так чтобы ни один владелец рабочей нагрузки не мог управлять доступом к любой другой рабочей нагрузке, которой он не владеет. Также необходимо реализовать эту модель, используя только встроенные роли для управления доступом на основе ролей в Azure.

Каждая роль RBAC применяется в одной из трех областей в Azure: **подписка**, **группа ресурсов** и отдельный **ресурс**. Роли наследуются в более низких областях. Например, если пользователю назначена [роль "владелец](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#owner) " на уровне подписки, эта роль также назначается этому пользователю в группе ресурсов и на уровне отдельных ресурсов, если не переопределен.

Таким образом, чтобы создать модель доступа с минимальными полномочиями, необходимо решить, какие действия разрешено выполнять определенному типу пользователя в каждой из этих трех областей. Например, существует требование, чтобы владелец рабочей нагрузки имел разрешение управлять доступом только к ресурсам, связанным с его рабочей нагрузкой, и никаким другим. При назначении встроенной роли владельца в области действия подписки у каждого владельца рабочей нагрузки будет доступ к управлению всеми рабочими нагрузками.

Давайте рассмотрим два примера моделей разрешений, чтобы лучше понять эту концепцию. В первом примере модель позволяет создавать группы ресурсов только администратору служб. Во втором примере модель назначает встроенную роль владельца каждому владельцу рабочей нагрузки в области подписки.

В обоих примерах имеется администратор службы подписки, которому назначена роль встроенной роли владельца в области действия подписки. Вспомним, что встроенная роль владельца предоставляет все разрешения, включая управление доступом к ресурсам.
Администратор службы подписки ![с ролью владельца](../../_images/govern/design/governance-2-1.png)
*рис. 3. в подписке с администратором службы была назначена роль владельца со встроенным владельцем.*

1. В первом примере есть **владелец рабочей нагрузки A** без разрешений в области подписки. По умолчанию он не имеет прав управления доступом к ресурсам. Этот пользователь хочет развернуть ресурсы для своей рабочей нагрузки и управлять ими. Ему необходимо обратиться к **администратору служб** с запросом о создании группы ресурсов.
    ![запрос владельца рабочей нагрузки о создании группы ресурсов A](../../_images/govern/design/governance-2-2.png)
2. **Администратор службы** просматривает свой запрос и создает **группу ресурсов A**. На этом этапе **Владелец рабочей нагрузки,** по-прежнему, не имеет разрешения на все действия.
    ![администратор служб создает группу ресурсов А](../../_images/govern/design/governance-2-3.png)
3. **Администратор служб** добавляет **владельца рабочей нагрузки A** к **группе ресурсов A** и назначает [встроенную роль участника](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#contributor). Роль участника предоставляет все разрешения в **группе ресурсов A**, за исключением разрешения на доступ к управлению.
    ![администратор служб добавляет владельца рабочей нагрузки к группе ресурсов А](../../_images/govern/design/governance-2-4.png)
4. Предположим, что **владельцу рабочей нагрузки A** необходимо добавить в группу двух членов команды для просмотра данных мониторинга ЦП и сетевого трафика в рамках планирования мощности для рабочей нагрузки. Так как **владельцу рабочей нагрузки** назначена роль участника, у них нет разрешения на добавление пользователя в **группу ресурсов A**. Они должны отправить этот запрос **администратору службы**.
    ![владелец рабочей нагрузки запрашивает добавление участников рабочей нагрузки к группе ресурсов](../../_images/govern/design/governance-2-5.png)
5. **Администратор службы** просматривает запрос и добавляет двух пользователей **участника рабочей нагрузки** в **группу ресурсов A**. Ни один из этих двух пользователей не требует разрешения на управление ресурсами, поэтому им назначается [Встроенная роль читателя](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#contributor).
    ![администратор служб добавляет участников рабочей нагрузки к группе ресурсов А](../../_images/govern/design/governance-2-6.png)
6. Далее, **владелец рабочей нагрузки Б** также требует группу ресурсов для ресурсов своей рабочей нагрузки. Как и в случае с **владельцем рабочей нагрузки A**, **владелец рабочей нагрузки Б** изначально не имеет разрешения принимать какие-либо действия в области подписки, поэтому ему необходимо отправить запрос **администратору служб**
    ![владелец рабочей нагрузки Б запрашивает создание группы ресурсов Б](../../_images/govern/design/governance-2-7.png)
7. **Администратор службы** просматривает запрос и создает **группу ресурсов B**.  Администратор службы ![создает группу ресурсов B](../../_images/govern/design/governance-2-8.png)
8. Затем **администратор службы** добавляет **владельца рабочей нагрузки b** в **группу ресурсов b** и назначает встроенную роль участника.
    ![Администратор служб добавляет владельца рабочей нагрузки Б к группе ресурсов Б](../../_images/govern/design/governance-2-9.png)

На этом этапе каждый владелец рабочей нагрузки изолирован в своей собственной группе ресурсов. Ни один из владельцев рабочей нагрузки или члены их команд не имеют доступа к управлению ресурсами в любой другой группе ресурсов.

![подписка с группами ресурсов A и B](../../_images/govern/design/governance-2-10.png)
*рис. 4 — Подписка с двумя владельцами рабочей нагрузки, изолированными от их собственной группы ресурсов.*

Эта модель является моделью с минимальными правами доступа,&mdash;каждому пользователю назначается правильное разрешение в отношении правильной области управления ресурсами.

Однако учтите, что каждая задача в этом примере выполнялась **администратором служб**. Это простой пример, и здесь не возникают проблемы, возможно потому, что есть только два владельца рабочей нагрузки. Но легко представить себе типы проблем, которые могут возникнуть в большой организации. Например, **администратор служб** может стать узким местом с большим количеством невыполненных запросов, которые приводят к задержкам.

Давайте рассмотрим второй пример, который уменьшает количество задач, выполняемых **администратором служб**.

1. В этой модели **владельцу рабочей нагрузки A** назначается встроенная роль владельца в области действия подписки, что позволяет им создавать собственные группы ресурсов: **Группа ресурсов а**.  Администратор ![служб добавляет владельца рабочей нагрузки A в подписку](../../_images/govern/design/governance-2-11.png)
2. При создании **группы ресурсов a** **Владелец рабочей нагрузки** по умолчанию добавляется и наследует встроенную роль владельца из области действия подписки.
    ![Владелец рабочей нагрузки А создает группу ресурсов А](../../_images/govern/design/governance-2-12.png)
3. Встроенная роль владельца предоставляет **владельцу рабочей нагрузки** разрешение на управление доступом к группе ресурсов. **Владелец рабочей нагрузки а** добавляет двух **участников рабочей нагрузки** и назначает каждому из них встроенную роль читателя.
    ![Владелец рабочей нагрузки A добавляет участников рабочей нагрузки](../../_images/govern/design/governance-2-13.png)
4. **Администратор служб** теперь добавляет **владельца рабочей нагрузки Б** к подписке с встроенной ролью владельца.
    ![Администратор служб добавляет владельца рабочей нагрузки Б к подписке](../../_images/govern/design/governance-2-14.png)
5. **Владелец рабочей нагрузки Б** создает **группы ресурсов Б** и добавляется по умолчанию. Опять же, **владелец рабочей нагрузки Б** наследует встроенную роль владельца из области подписки.
    ![Владелец рабочей нагрузки Б создает группу ресурсов Б](../../_images/govern/design/governance-2-15.png)

Обратите внимание, что в этой модели **администратор служб** выполнял меньше действий, чем в первом примере, путем делегирования управления доступом каждому из отдельных владельцев рабочей нагрузки.

![подписке с группами ресурсов A и B](../../_images/govern/design/governance-2-16.png)
*рис. 5. Подписка с администратором службы и двумя владельцами рабочей нагрузки, которым назначена роль «владелец».*

Тем не менее, поскольку **владельцу рабочей нагрузки A** и **владельцу рабочей нагрузки Б** присваивается встроенная роль владельца в области подписки, каждая из них унаследовала роль встроенного владельца групп ресурсов друг друга. Это означает, что они не только имеют полный доступ к ресурсам друг друга, но также могут делегировать доступ управления к группам ресурсов друг друга. Например, владелец **рабочей нагрузки Б** имеет разрешение добавлять любого другого пользователя в **группу ресурсов A** и может назначать ему какую-либо роль, включая встроенную роль владельца.

Если сравнивать примеры с требованиями, вы увидите, что в обоих примерах фигурирует один доверенный пользователь в области подписки с разрешением на предоставление прав доступа к ресурсам двум владельцам рабочей нагрузки. Каждый из двух владельцев рабочей нагрузки не имел доступа к управлению ресурсами по умолчанию и требовал, чтобы **администратор служб** явно назначил ему права. Однако только первый пример поддерживает требование, чтобы ресурсы, связанные с отдельной рабочей нагрузкой, были изолированы друг от друга таким образом, что владелец рабочей нагрузки не имеет доступа к ресурсам любой другой рабочей нагрузки.

## <a name="resource-management-model"></a>Модель управления ресурсами

Теперь, когда модель разрешений с наименьшими привилегиями разработана, давайте перейдем к рассмотрению некоторых практических приложений для этих моделей системы управления. Напомним, что требования предусматривают поддержку трех сред.

1. **Среда общей инфраструктуры:** Группа ресурсов, совместно используемых всеми рабочими нагрузками. Это такие ресурсы, как сетевые шлюзы, брандмауэры и службы безопасности.
2. **Рабочая среда:** Несколько групп ресурсов, представляющих несколько рабочих нагрузок. Эти ресурсы используются для размещения частных и публичных артефактов приложений. Эти ресурсы обычно имеют самые жесткие модели системы управления и безопасности для защиты ресурсов, кода приложений и данных от несанкционированного доступа.
3. Предварительная **Среда:** Несколько групп ресурсов, представляющих несколько рабочих нагрузок, готовых к непродуктивной работе. Эти ресурсы, используемые для разработки и тестирования этих ресурсов, могут иметь более ослабленную модель управления для повышения гибкости разработчиков. Безопасность в этих группах должна увеличиться ближе к рабочему процессу разработки приложения.

Для каждой из этих трех сред есть требования по отслеживанию данных о расходах **владельца рабочей нагрузки**, **среды** или обоих. То есть вам нужно будет оценить текущие затраты на **общую инфраструктуру**, затраты, которые являются сотрудниками в предварительной и **производственной** средах, и, наконец, Общая стоимость предварительного **производства** и  **рабочие** среды.

Вы уже знаете, что ресурсы ограничиваются только двумя уровнями: **подпиской** и **группой ресурсов**. Поэтому первое решение — организовать среду с использованием **подписки**. Есть только две возможности: единая подписка или несколько подписок.

Прежде чем перейти к примерам каждой из этих моделей, давайте рассмотрим структуру управления подписками в Azure.

Следует напомнить, что в организации есть сотрудник, отвечающий за подписки, и он распоряжается учетной записью **владельца подписок** в клиенте Azure AD. Однако эта учетная запись не имеет разрешения на создание подписок. Только **владелец учетной записи Azure** имеет на это право:

![владелец учетной записи Azure создает подписку](../../_images/govern/design/governance-3-0b.png)
*рис. 6. Владелец учетной записи Azure создает подписку.*

После создания подписки **владелец учетной записи Azure** может добавить учетную запись **владельца подписки** к подписке с ролью **владельца**.

![владелец учетной записи Azure добавляет учетную запись владельца подписки в подписку с ролью владельца.](../../_images/govern/design/governance-3-0c.png)
*рис. 7. Владелец учетной записи Azure добавляет учетную запись **владельца подписки** в подписку с ролью **владельца** .*

**Владелец подписки** теперь может создать **группу ресурсов** и делегировать управление доступом к ресурсам.

Сначала давайте рассмотрим пример модели управления ресурсами, используя единую подписку. Первое решение касается выравнивания групп ресурсов в трех средах. Существует два варианта.

1. Совместите каждую среду с одной группой ресурсов. Все ресурсы общей инфраструктуры развертываются в единую группу ресурсов **общей инфраструктуры**. Все ресурсы, связанные с рабочими нагрузками разработки, развертываются в единую группу ресурсов **разработки**. Все ресурсы, связанные с производственными рабочими нагрузками, развертываются в единую **производственную** группу ресурсов для **рабочей** среды.
2. Создайте отдельные группы ресурсов для каждой рабочей нагрузки, используя соглашение об именовании и теги для выравнивания групп ресурсов в каждой из трех сред.

Начнем с оценки первого способа. Воспользуйтесь моделью разрешений, о которой шла речь в предыдущем разделе, когда администратор служб одной подписки создает группы ресурсов и добавляет к ним пользователей со встроенной ролью **участника** или **читателя**.

1. Первая развернутая группа ресурсов представляет собой среду **общей инфраструктуры**. **Владелец подписки** создает группу ресурсов для ресурсов общей инфраструктуры с именем `netops-shared-rg`.
    ![создание группы ресурсов](../../_images/govern/design/governance-3-0d.png)
2. **Владелец подписки** добавляет учетную запись **пользователя сетевых операций** для группы ресурсов и назначает роль **участника**.
    ![Добавление пользователя сетевых операций](../../_images/govern/design/governance-3-0e.png)
3. **Пользователь сетевых операций** создает [VPN-шлюз](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways) и настраивает его для подключения к VPN-устройству в локальной среде. Пользователь **сетевых операций** также применяет пару [тегов](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-using-tags) для каждого из ресурсов: *environment:shared* и *managedBy:netOps*. Когда **администратор служб подписки** экспортирует отчет о затратах, затраты будут выровнены по каждому из этих тегов. Это позволяет **администратору служб подписки** сводить затраты с помощью тега *environment* и тега *managedBy*. Обратите внимание на счетчик **границ ресурсов** в верхней правой части рисунка. Каждая подписка Azure имеет [границы обслуживания](https://docs.microsoft.com/azure/azure-subscription-service-limits), и чтобы понять эффект этих ограничений, придерживайтесь границ виртуальной сети для каждой подписки. Ограничение составляет 1000 виртуальных сетей на подписку, а после развертывания первой виртуальной сети остаются доступными 999 виртуальных сетей.
    ![создания VPN-шлюза](../../_images/govern/design/governance-3-1.png)
4. Были развернуты еще две группы ресурсов. Первая называется `prod-rg`. Эта группа ресурсов сопоставлена с рабочей средой. Вторая называется `dev-rg` и сопоставлена со средой разработки. Все ресурсы, связанные с производственными рабочими нагрузками, развертываются в рабочей среде, а все ресурсы, связанные с рабочими нагрузками разработки, развертываются в среде разработки. В этом примере вы развернете только две рабочие нагрузки для каждой из этих двух сред, чтобы не превысить пределы абонентской подписки Azure. Однако учтите, что каждая группа ресурсов имеет ограничение в 800 ресурсов. Если добавлять рабочие нагрузки для каждой группы ресурсов, в конечном итоге этот предел будет достигнут.
    ![создание групп ресурсов](../../_images/govern/design/governance-3-2.png)
5. Первый **владелец рабочей нагрузки** отправляет запрос **администратору служб подписки** и добавляется к каждой из сред групп ресурсов (к среде разработки и к рабочей среде) с ролью **участника**. Как упоминалось ранее, роль **участника** позволяет пользователю выполнять любую операцию, отличную от назначения роли другому пользователю. Первый **владелец рабочей нагрузки** теперь может создавать ресурсы, связанные со своей рабочей нагрузкой.
    ![Добавление участников](../../_images/govern/design/governance-3-3.png)
6. Первый **владелец рабочей нагрузки** создает виртуальную сеть в каждой из двух групп ресурсов с парой виртуальных машин в каждой. Первый **владелец рабочей нагрузки** применяет теги *environment* и *managedBy* ко всем ресурсам. Обратите внимание, что счетчик границ обслуживания Azure теперь показывает оставшиеся 997 виртуальных сетей.
    ![создания виртуальных сетей](../../_images/govern/design/governance-3-4.png)
7. При создании каждой виртуальной сети нет возможности подключения к локальным сетям. В этом типе архитектуры каждая виртуальная сеть должна быть привязана к *hub-vnet* в среде **общей инфраструктуры**. Пиринг виртуальной сети создает соединение между двумя отдельными виртуальными сетями и позволяет сетевому трафику перемещаться между ними. Обратите внимание, что пиринг виртуальной сети не является по своей сути транзитивным. В каждой из двух подключенных виртуальных сетей должен быть указан пиринг, и если только в одной из виртуальных сетей указан пиринг, соединение является неполным. Чтобы проиллюстрировать этот эффект, пусть первый **владелец рабочей нагрузки** укажет пиринг между **prod-vnet** и **hub-vnet**. Создается первый пиринг, но нет потоков трафика, потому что еще не был указан взаимодополняющий пиринг из **hub-vnet** к **prod-vnet**. Первый **владелец рабочей нагрузки** связывается с пользователем **сетевых операций** и запрашивает это взаимодополняющее пиринговое подключение.
    ![создание однорангового соединения](../../_images/govern/design/governance-3-5.png)
8. Пользователь **сетевых операций** просматривает запрос, утверждает его, а затем указывает пиринг в параметрах **hub-vnet**. Теперь пиринговое соединение полное и сетевой трафик проходит между двумя виртуальными сетями.
    ![создание однорангового соединения](../../_images/govern/design/governance-3-6.png)
9. Теперь второй **владелец рабочей нагрузки** отправляет запрос **администратору служб подписки** и добавляется к каждой из существующих сред групп ресурсов (к среде **разработки** и к **рабочей** среде) с ролью **участника**. Второй **владелец рабочей нагрузки** имеет те же разрешения, что и первый **владелец рабочей нагрузки**, для всех ресурсов в каждой группе ресурсов.
    ![Добавление участников](../../_images/govern/design/governance-3-7.png)
10. Второй **владелец рабочей нагрузки** создает подсеть в виртуальной сети **prod-vnet**, а затем добавляет две виртуальные машины. Второй **владелец рабочей нагрузки** применяет теги *environment* и *managedBy* для каждого ресурса.
    ![создание подсетей](../../_images/govern/design/governance-3-8.png)

Этот пример модели управления ресурсами позволяет управлять ресурсами в трех требуемых средах. Ресурсы общей инфраструктуры защищены, так как в подписке есть только один пользователь с правом доступа к этим ресурсам. Каждый из владельцев рабочей нагрузки может использовать ресурсы общей инфраструктуры, не имея каких-либо разрешений на эти общие ресурсы. Но эта модель управления не отвечает требованию к изоляции рабочей нагрузки, так как оба **владельца рабочей нагрузки** имеют доступ к ресурсам друг друга.

Есть еще одно важное замечание к этой модели, которое может быть не сразу очевидно. В примере **владелец рабочей нагрузки аpp1** запросил сетевое пиринговое соединение с **hub-vnet**, чтобы обеспечить возможность подключения к локальной сети. Пользователь **сетевых операций** оценил этот запрос на основании ресурсов, развертываемых с этой рабочей нагрузкой. Когда **владелец подписки** добавил **владельца рабочей нагрузки app2** с ролью **участника**, у этого пользователя были права доступа к управлению всеми ресурсами в группе ресурсов **prod-rg**.

![Схема, демонстрирующая права на доступ к управлению](../../_images/govern/design/governance-3-10.png)

Это значит, что **владелец рабочей нагрузки app2** имел разрешение на развертывание своей собственной подсети с виртуальными машинами в виртуальной сети **prod-vnet**. По умолчанию эти виртуальные машины теперь имеют доступ к локальной сети. Пользователь **сетевых операций** не имеет сведений о компьютерах и не утвердил их подключение к локальной сети.

Затем давайте рассмотрим единую подписку с несколькими группами ресурсов для разных сред и рабочих нагрузок. Обратите внимание, что в предыдущем примере ресурсы для каждой среды были легко идентифицируемы, поскольку они находились в одной группе ресурсов. Теперь, когда вы больше не имеете этого группирования, для обеспечения этой функциональности придется полагаться на соглашение об именовании группы ресурсов.

1. Ресурсы **общей инфраструктуры** в этой модели все еще имеют отдельную группу ресурсов, поэтому она останется прежней. Для каждой рабочей нагрузки требуются две группы ресурсов — по одной для среды **разработки** и для **рабочей** среды. Для первой рабочей нагрузки **владелец подписки** создает две группы ресурсов. Первый элемент называется **APP1-RG** , а второй — **APP1-dev-RG**. Как обсуждалось ранее, это соглашение об именовании идентифицирует ресурсы как связанные с первой рабочей нагрузкой **app1** и либо со средой **dev**, либо со средой **prod**. Опять же, владелец *подписки* добавляет **владельца рабочей нагрузки APP1** в группу ресурсов с ролью **участника** .
    ![Добавление участников](../../_images/govern/design/governance-3-12.png)
2. Как и в первом примере **владелец рабочей нагрузки аpp1** развертывает виртуальную сеть с именем **app1-prod-vnet** в **рабочей** среде, а другой — виртуальную сеть **app1- dev-vnet** в среде **разработки**. Опять же, **владелец рабочей нагрузки аpp1** отправляет запрос пользователю **сетевых операций** для создания пирингового соединения. Обратите внимание, что **владелец рабочей нагрузки аpp1** добавляет те же теги, что и в первом примере, а счетчик границ был уменьшен до 997 виртуальных сетей, оставшихся в подписке.
    ![создание однорангового соединения](../../_images/govern/design/governance-3-13.png)
3. **Владелец подписки** теперь создает две группы ресурсов для **владельца рабочей нагрузки app2**. Следуя тем же соглашениям, что и для **владельца рабочей нагрузки app1**, группы ресурсов называются **app2-prod-rg** и **app2-dev-rg**. **Владелец подписки** добавляет **владельца рабочей нагрузки app2** к каждой из групп ресурсов с ролью **участника**.
    ![Добавление участников](../../_images/govern/design/governance-3-14.png)
4. *Владелец рабочей нагрузки App2* развертывает виртуальные сети и виртуальные машины в группе ресурсов с теми же соглашениями об именовании. Добавляются теги, а счетчик границ уменьшается до 995 виртуальных сетей, оставшихся в *подписке*.
    ![развертывание виртуальных сетей и виртуальных машин](../../_images/govern/design/governance-3-15.png)
5. *Владелец рабочей нагрузки App2* отправляет запрос пользователю *сетевых операций* для установки кэширующего узла *app2-prod-vnet* с *hub-vnet*. Пользователь *сетевых операций* создает пиринговое соединение.
    ![создание однорангового соединения](../../_images/govern/design/governance-3-16.png)

Полученная модель управления похожа на первый пример с несколькими ключевыми отличиями.

- Каждая из двух рабочих нагрузок является изолированной рабочей нагрузкой и средой.
- Этой модели требуются две дополнительные виртуальные сети, по сравнению с первым примером модели. Теоретический предел числа рабочих нагрузок для этой модели равен 24, хотя это не является важным отличием для модели только с двумя рабочими нагрузками.
- Ресурсы больше не группируются в одну группу ресурсов для каждой среды. Для группирования ресурсов требуется понимание соглашений об именовании, используемых для каждой среды.
- Каждое из подключенных виртуальных сетевых соединений было рассмотрено и одобрено пользователем *сетевых операций*.

Теперь давайте рассмотрим модель управления ресурсами, использующую несколько подписок. В этой модели вы сопоставляете каждую из трех сред с отдельной подпиской: подписка **общих служб**, **рабочая** подписка и, наконец, подписка **разработки**. Соображения для этой модели аналогичны модели, использующей единую подписку, в которой вам необходимо решить, как сопоставить группы ресурсов с рабочими нагрузками. Как выяснилось, создание группы ресурсов для каждой рабочей нагрузки отвечает требованию к изоляции рабочей нагрузки, поэтому в примере будем придерживаться этой модели.

1. В этой модели существуют три *подписки*: *общая инфраструктура*, *рабочая* и *разработка*. Для каждой из этих трех подписок требуется *владелец подписки*. В простейшем случае будем использовать одну учетную запись для всех трех подписок. Ресурсы *общей инфраструктуры* управляются аналогично первым двум приведенным выше примерам, а первая рабочая нагрузка связана с *app1-rg* в *рабочей* среде и с так же называемой группой ресурсов в среде *разработки*. *Владелец рабочей нагрузки аpp1* добавляется в каждую группу ресурсов с ролью *участника*.
    ![Добавление участников](../../_images/govern/design/governance-3-17.png)
2. Как и в предыдущих примерах, *владелец рабочей нагрузки аpp1* создает ресурсы и запрашивает пиринговое подключение с виртуальной сетью *общей инфраструктуры*. *Владелец рабочей нагрузки App1* добавляет только тег *managedBy*, так как тег *environment* больше не требуется. То есть, ресурсы для каждой среды теперь сгруппированы в одну и ту же *подписку*, а тэг *environment* является избыточным. Счетчик ограничений уменьшается до 999 виртуальных сетей.
    ![создание однорангового соединения](../../_images/govern/design/governance-3-18.png)
3. Наконец *владелец подписки* повторяет процесс для второй рабочей нагрузки, добавляя группы ресурсов *владельцу рабочей нагрузки аpp2* в *роли участника. Счетчик ограничений для каждой подписки на среду уменьшается до 998 виртуальных сетей.

Эта модель управления имеет преимущества по сравнению со вторым примером. Однако ключевое различие заключается в том, что границы являются менее значимыми так как они распределены по двум *подпискам*. Недостатком является то, что данные по затратам, отслеживаемые с помощью тегов, должны быть агрегированы по всем трем *подпискам*.

Таким образом можно выбрать любой из этих двух примеров моделей управления ресурсами в зависимости от приоритета требований. Если предполагается, что ваша организация не достигнет ограничения для служб для одной подписки, можно использовать одну подписку с несколькими группами ресурсов. И наоборот — если ваша организация планирует использовать много рабочих нагрузок, несколько подписок для каждой среды будет лучшим решением.

## <a name="implement-the-resource-management-model"></a>Реализация модели управления ресурсами

Вы изучили несколько моделей управления доступом к ресурсам Azure. Давайте рассмотрим шаги, необходимые для реализации модели управления ресурсами с одной подпиской для каждой **общей инфраструктуры**, **рабочей среды** и среды **разработки**, описанных в руководстве по проектированию. **Владельцем подписки** для всех трех сред будет один человек. Каждая рабочая нагрузка будет изолирована в **группе ресурсов** с помощью **владельца рабочей нагрузки**, которому при добавлении назначается роль **участника**.

> [!NOTE]
> Дополнительные сведения о связи между учетными записями Azure и подписками см. в статье Общие сведения о [доступе к ресурсам в Azure](https://docs.microsoft.com/azure/role-based-access-control/rbac-and-directory-admin-roles) .

Выполните следующие действия:

1. Если у вашей организации нет учетной записи Azure, создайте [ее](https://docs.microsoft.com/azure/active-directory/sign-up-organization). Пользователь, зарегистрировавший учетную запись Azure, становится ее администратором, поэтому руководство организации должно выбрать человека, который возьмет на себя эту роль. Он будет отвечать за:
    - Создание подписок.
    - Создание и администрирование клиентов [Azure Active Directory (Azure AD)](https://docs.microsoft.com/azure/active-directory/active-directory-whatis) , в которых хранятся удостоверения пользователей для этих подписок.
2. Руководство организации определяет, кто из сотрудников несет ответственность за следующие аспекты:
    - Управление удостоверением пользователя. [Клиент Microsoft Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-howto-tenant) создается по умолчанию при создании учетной записи Azure для организации, а администратор учетной записи по умолчанию добавляется в качестве [глобального администратора Microsoft Azure Active Directory](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles). Ваша организация может выбрать другого пользователя для управления удостоверением пользователя, [назначив ему роль глобального администратора Microsoft Azure Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-users-assign-role-azure-portal).
    - Подписки. Благодаря этому такие пользователи могут:
        - Управление затратами, связанными с использованием ресурсов в этой подписке.
        - Реализуйте и обслуживайте модель минимальных разрешений для доступа к ресурсам.
        - отслеживать ограничения служб.
    - Общие службы инфраструктуры (при использовании вашей организацией этой модели). Вследствие этого такие пользователи несут ответственность за:
        - Подключение из локальной среды к сети Azure.
        - владение сетевым подключением в Azure через пиринг виртуальной сети.
    - Владельцы рабочих нагрузок.
3. Глобальный администратор Microsoft Azure Active Directory [создает учетные записи пользователей](https://docs.microsoft.com/azure/active-directory/add-users-azure-active-directory) для:
    - сотрудников, которые будут выступать в роли **владельцев подписки** для каждой подписки, связанной со средой (обратите внимание, что это необходимо, только если на **администратора служб** подписки не будут возложены функции по управлению доступом к ресурсам для каждой подписки или среды);
    - Пользователь, который будет **пользователем сетевых операций**.
    - сотрудников, которые будут **владельцами рабочих нагрузок**.
4. Администратор учетной записи Azure с помощью [портала управления учетными записями Azure](https://account.azure.com) создает следующие три подписки:
    - Подписка для среды **общей инфраструктуры** .
    - Подписка для **рабочей** среды.
    - подписку для среды **разработки**.
5. Администратор учетных записей Azure [добавляет к каждой подписке ее владельца](https://docs.microsoft.com/azure/billing/billing-add-change-azure-subscription-administrator#to-assign-a-user-as-an-administrator).
6. Чтобы запросить создание групп ресурсов, создайте процесс утверждения для **владельцев рабочей нагрузки**. Процесс утверждения может быть реализован по-разному, например по электронной почте или с помощью инструмента управления рабочими процессами, к примеру [рабочие процессы SharePoint](https://support.office.com/article/introduction-to-sharepoint-workflow-07982276-54e8-4e17-8699-5056eff4d9e3). Процесс утверждения может состоять из следующих шагов:
    - **Владелец рабочей нагрузки** готовит спецификацию необходимых ресурсов Azure для среды **разработки** или **рабочей** среды (или из обеих) и отправляет ее **владельцу подписки**.
    - **Владелец подписки** проверяет спецификацию и запрашиваемые ресурсы, чтобы убедиться в их применимости для запланированного использования. Например, он проверяет, верны ли запрошенные [размеры виртуальных машин](https://docs.microsoft.com/azure/virtual-machines/windows/sizes).
    - Если запрос не будет подтвержден, **владелец рабочей нагрузки** получит уведомление. Если запрос подтвержден, **владелец подписки** [создает запрашиваемую группу ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/manage-resource-groups-portal#create-resource-groups), следуя [соглашению об именовании](https://docs.microsoft.com/azure/architecture/best-practices/resource-naming) в организации, [добавляет **владельца рабочей нагрузки**](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal#add-a-role-assignment) с [ролью **участник**](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#contributor) и отправляет уведомление **владельцу рабочей нагрузки** о том, что группа ресурсов создана.
7. Чтобы запросить пиринговое соединение с виртуальной сетью у владельца общей инфраструктуры, для владельцев рабочей нагрузки создается процесс утверждения. Как и на предыдущем этапе, этот процесс утверждения может быть реализован с использованием электронной почты или инструмента управления процессами.

После внедрения своей модели управления можно развернуть службы общей инфраструктуры.

## <a name="related-resources"></a>Связанные ресурсы

[Встроенные роли управления доступом на основе ролей в Azure](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles)

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Сведения о развертывании базовой инфраструктуры](../../infrastructure/virtual-machines/basic-workload.md)
