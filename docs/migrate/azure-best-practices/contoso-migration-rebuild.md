---
title: Повторное создание локального приложения в Azure
description: Узнайте, как компания Contoso перестраивает приложение для запуска в Azure с помощью Службы приложений Azure, Службы Azure Kubernetes, Cosmos DB, Функций Azure и Azure Cognitive Services.
author: BrianBlanchard
ms.author: brblanch
ms.date: 10/11/2018
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: site-recovery
ms.openlocfilehash: 089533e9bff66fb355fb0ae720aa868bce67bd89
ms.sourcegitcommit: 60d8b863d431b5d7c005f2f14488620b6c4c49be
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2020
ms.locfileid: "83223853"
---
<!-- docsTest:ignore SmartHotel360 SmartHotel360-Backend Pet.Checker vcenter.contoso.com contoso-datacenter git aks ContosoRG PetCheckerFunction -->

<!-- cSpell:ignore givenscj WEBVM SQLVM contosohost vcenter contosodc smarthotel contososmarthotel smarthotelcontoso smarthotelpetchecker petchecker smarthotelakseus smarthotelacreus smarthotelpets kubectl contosodevops visualstudio azuredeploy cloudapp smarthotelsettingsurl appsettings -->

# <a name="rebuild-an-on-premises-app-on-azure"></a>Перестроение локального приложения в Azure

В этой статье показано, как вымышленная компания Contoso перестраивает двухуровневое приложение .NET для Windows, работающее на виртуальных машинах VMware, в процессе миграции на платформу Azure. Специалисты компании переносят интерфейсную виртуальную машину приложения в веб-приложение Службы приложений Azure. Серверная часть приложения создана с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Веб-сайт взаимодействует со службой "Функции Azure", предоставляя функцию фотографирования животных.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** По мере развития компания Contoso хочет предоставлять клиентам различные возможности для работы на веб-сайтах.
- **Гибкость.** Компания Contoso должна эффективно прогнозировать изменения на рынке для успешной деятельности в рамках глобальной экономики.
- **Измените.** По мере успешного развития бизнеса ИТ-отдел компании Contoso должен предоставить системы, которые могут расти в одном темпе.
- **Сократите затраты.** Компании Contoso требуется минимизировать затраты на лицензирование.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила требования к приложению для этой миграции. Эти требования использовались для определения оптимального метода миграции:

- Сейчас потребность выполнять приложение в Azure особенно важна. Оно должно хорошо работать и легко масштабироваться.
- Приложение должно использовать компоненты IaaS. Все должно быть создано для использования с PaaS или бессерверных служб.
- Приложения должны запускаться в облачных службах, а контейнеры — находиться в частном реестре контейнеров всего предприятия в облаке.
- Служба API, используемая для фотографирования домашних животных, должна быть точной и надежной в реальной среде, так как решения, принимаемые приложением, должны соблюдать работники отелей. Любой одобренный питомец может остаться в гостинице.
- Чтобы удовлетворить требования для конвейера DevOps, Contoso будет использовать репозиторий Git в Azure Repos для управления исходным кодом. Автоматические выполняемые сборки и выпуски будут использоваться для компиляции кода и его развертывания в Службе приложений Azure, Функциях Azure и AKS.
- Для микрослужб в серверной части и веб-сайта во внешнем интерфейсе требуются разные конвейеры CI/CD.
- Цикл выпуска внутренних служб отличается от цикла выпуска интерфейсного веб-приложения. Для удовлетворения этого требования они будут развертывать два разных конвейера.
- Contoso необходимо утвердить все развертывание интерфейсного веб-сайта, и конвейер CI/CD должен обеспечить это.

## <a name="solution-design"></a>Архитектура решения

Определив цели и требования, специалисты Contoso начинают разработку и анализ решения развертывания и идентифицируют процесс миграции, включая службы Azure, которые будут использоваться при миграции.

### <a name="current-app"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на VMware ESXi узле **contosohost1.contoso.com** (версия 6,5).
- Управление средой VMware осуществляется с помощью vCenter Server 6,5 (**vCenter.contoso.com**), выполняющегося на виртуальной машине.
- Contoso имеет локальный центр обработки данных (**contoso-Datacenter**) с локальным контроллером домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

### <a name="proposed-architecture"></a>Предлагаемая архитектура

- Внешний интерфейс приложения развертывается как веб-приложение службы приложений Azure в основном регионе Azure.
- Служба "Функции Azure" обеспечит передачу фотографий домашних животных, и веб-сайт будет взаимодействовать с этой функцией.
- Функция фото в Pet использует API компьютерного зрения Cognitive Services Azure вместе с Cosmos DB.
- Серверная часть сайта создается с использованием микрослужб. Они будут развернуты в контейнерах, управляемых в AKS.
- Контейнеры будут созданы с помощью Azure DevOps и отправлены в реестр контейнеров Azure.
- Сейчас специалисты Contoso вручную развернут веб-приложение и код функции с помощью Visual Studio.
- Микрослужбы развертываются с помощью сценария PowerShell, который вызывает программы командной строки Kubernetes.

    ![Архитектура сценария](./media/contoso-migration-rebuild/architecture.png)

### <a name="solution-review"></a>Проверка решения

Специалисты Contoso оценивают предлагаемый дизайн, составляя список плюсов и минусов.

<!-- markdownlint-disable MD033 -->

**Оценка** | **Сведения**
--- | ---
**Плюсы** | Использование PaaS и бессерверных решений для полного развертывания значительно сокращает время управления со стороны Contoso. <br><br> Переход на архитектуру на основе микрослужб позволяет компании Contoso легко расширять решение с течением времени. <br><br> Новая функциональность может быть подключена к Интернету, не нарушая ни одной из имеющихся баз кода решений. <br><br> Для веб-приложения будет настроено несколько экземпляров, что гарантирует отсутствие единой точки отказа. <br><br> Чтобы приложение могло обработать разные объемы трафика, включается автоматическое масштабирование. <br><br> В связи с переходом к службам PaaS компания Contoso может прекратить использовать устаревшие решения под управлением операционной системы Windows Server 2008 R2. <br><br> Cosmos DB обладает встроенной отказоустойчивостью, которой не требуется настройка специалистами Contoso. Это означает, что уровень данных больше не является единой точкой отказа.
**Минусы** | По сравнению с другими вариантами миграции контейнеры более сложные. Для Contoso длительное изучение может стать проблемой. Они представляют новый уровень сложности, который обеспечивает значение, несмотря на кривую. <br><br> Рабочей группе в Contoso необходимо будет заполнить пробелы в знаниях, чтобы разобраться с Azure, контейнерами и микрослужбами приложения и обеспечить их обслуживание. <br><br> Компания Contoso не полностью реализовала DevOps для всего решения. Специалистам компании нужно подумать об этом при развертывании служб в AKS, Функциях Azure и Службе приложений Azure.

<!-- markdownlint-enable MD033 -->

### <a name="migration-process"></a>Процесс миграции

1. Компания Contoso подготавливает реестр контейнеров Azure, AKS и Cosmos DB.
2. Компания Contoso подготавливает инфраструктуру для развертывания, включая веб-приложение службы приложений Azure, учетную запись хранения, функцию и API.
3. После создания инфраструктуры они будут создавать свои образы контейнеров микрослужб с помощью Azure DevOps, которая передает их в реестр контейнеров.
4. Специалисты Contoso развернут большинство этих микрослужб в ASK с помощью сценария PowerShell.
5. Наконец, они развернут функцию и веб-приложение.

    ![Процесс миграции](./media/contoso-migration-rebuild/migration-process.png)

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[AKS](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | Упрощает развертывание, администрирование и использование Kubernetes. Предоставляет полностью управляемую службу оркестрации контейнеров Kubernetes. | AKS — это бесплатная служба. Вы платите только за виртуальные машины, связанное хранилище и потребляемые сетевые ресурсы. [Подробнее](https://azure.microsoft.com/pricing/details/kubernetes-service).
[Функции Azure](https://azure.microsoft.com/services/functions) | Ускорьте процесс разработки с помощью управляемых событиями и независимыми от сервера вычислительных средств. Выполняйте масштабирование по необходимости. | Платите только за использованные ресурсы. Плата по плану начисляется в зависимости от потребления ресурсов и числа выполнений в секунду. [Подробнее](https://azure.microsoft.com/pricing/details/functions).
[Реестр контейнеров Azure](https://azure.microsoft.com/services/container-registry) | Хранит образы для всех типов развертываний контейнеров. | Стоимость зависит от функций, типа хранилища и длительности использования. [Подробнее](https://azure.microsoft.com/pricing/details/container-registry).
[служба приложений Azure](https://azure.microsoft.com/services/app-service/containers); | Оперативно создавайте, развертывайте и масштабируйте веб-приложения, мобильные приложения и приложения API на любой платформе. | Плата за план службы приложений начисляется посекундно. [Подробнее](https://azure.microsoft.com/pricing/details/app-service/windows).

## <a name="prerequisites"></a>Предварительные требования

Ниже приведены действия компании Contoso, необходимые для этого сценария.

<!-- markdownlint-disable MD033 -->

**Требования** | **Сведения**
--- | ---
Подписка Azure | <li> Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial). <li> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <li> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.
Инфраструктура Azure | <li> Узнайте [, как Contoso настраивает инфраструктуру Azure](./contoso-migration-infrastructure.md).
Предварительные требования для разработчика | Contoso необходимы следующие средства на рабочей станции разработчика: <li>  [выпуск Visual Studio Community 2017 15.5](https://visualstudio.microsoft.com); <li> включенная рабочая нагрузка .NET; <li> [Git](https://git-scm.com); <li> [Azure PowerShell](https://azure.microsoft.com/downloads) <li> [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest) <li> [Docker CE (Windows 10) или Docker EE (Windows Server)](https://docs.docker.com/docker-for-windows/install), настроенные на использование контейнеров Windows.

<!-- markdownlint-enable MD033 -->

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. подготавливает AKS и реестр контейнеров Azure.** Компания Contoso подготавливает управляемый кластер AKS и реестр контейнеров с помощью PowerShell.
> - **Шаг 2. Создание контейнеров DOCKER.** Они настроили непрерывную интеграцию (CI) для контейнеров DOCKER с помощью Azure DevOps и принудительно отправляют их в реестр контейнеров.
> - **Шаг 3. Развертывание серверных микрослужб.** Специалисты компании развертывают остальную часть инфраструктуры, которая будет использоваться внутренними микрослужбами.
> - **Шаг 4. Развертывание интерфейсной инфраструктуры.** Они развертывают интерфейсную инфраструктуру, включая хранилище BLOB-объектов для домашних телефонов, Cosmos DB и API компьютерного зрения.
> - **Шаг 5. Перенос серверной части.** Специалисты компании развертывают микрослужбы и запускают их в AKS для переноса серверной части.
> - **Шаг 6. Публикация внешнего интерфейса.** Специалисты компании публикуют приложение SmartHotel360 в Службе приложений Azure и приложение-функцию, которое будет вызываться службой домашних животных.

## <a name="step-1-provision-back-end-resources"></a>Шаг 1. Подготовка ресурсов серверной части

Администраторы Contoso выполняют скрипт развертывания для создания управляемого кластера Kubernetes с помощью AKS и реестра контейнеров Azure.

- В инструкциях для этого раздела используется репозиторий **SmartHotel360-Серверная** часть.
- **SmartHotel360** репозиторий GitHub содержит все программное обеспечение для данной части развертывания.

### <a name="ensure-prerequisites"></a>Обеспечение предварительных требований

1. Прежде чем начать, администраторы Contoso гарантируют, что все необходимое программное обеспечение устанавливается на компьютере разработки, используемом для развертывания.
2. С помощью Git специалисты компании клонируют репозиторий локально на компьютер разработки: 

    `git clone https://github.com/Microsoft/SmartHotel360-Backend.git`

### <a name="provision-aks-and-azure-container-registry"></a>Подготавливает AKS и реестр контейнеров Azure

Администраторы Contoso выполняют подготовку следующим образом:

1. Они открывают папку с помощью Visual Studio Code и переходят в каталог **/deploy/K8S** , содержащий скрипт **жен-АКС-ЕНВ. ps1**.

2. Они запускают скрипт для создания управляемого кластера Kubernetes с помощью AKS и реестра контейнеров Azure.

   ![AKS](./media/contoso-migration-rebuild/aks1.png)

3. В открытом файле специалисты компании устанавливают для параметра $location значение **eastus2** и сохраняют изменения.

   ![AKS](./media/contoso-migration-rebuild/aks2.png)

4. Выберите **вид**  >  **интегрированный терминал** , чтобы открыть интегрированный терминал в Visual Studio Code.

   ![AKS](./media/contoso-migration-rebuild/aks3.png)

5. В интегрированном терминале PowerShell они входят в Azure с помощью команды Connect-AzureRmAccount. Дополнительные сведения см. в [статье](https://docs.microsoft.com/powershell/azure/get-started-azureps) Приступая к работе с PowerShell.

   ![AKS](./media/contoso-migration-rebuild/aks4.png)

6. Они выполняют проверку подлинности Azure CLI, выполняя `az login` команду и следуя инструкциям по проверке подлинности с помощью веб-браузера. Дополнительные сведения о входе с помощью Azure CLI см. в [этой статье](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

   ![AKS](./media/contoso-migration-rebuild/aks5.png)

7. Они выполняют следующую команду, передавая имя группы ресурсов **ContosoRG**, имя кластера AKS **смарсотел-AKS-eus2**и новое имя реестра.

   ```PowerShell
   .\gen-aks-env.ps1  -resourceGroupName ContosoRg -orchestratorName smarthotelakseus2 -registryName smarthotelacreus2
   ```

   ![AKS](./media/contoso-migration-rebuild/aks6.png)

8. Azure создает другую группу ресурсов, содержащую ресурсы для кластера AKS.

   ![AKS](./media/contoso-migration-rebuild/aks7.png)

9. После завершения развертывания устанавливается `kubectl` программа командной строки. Средство уже установлено на Azure Cloud Shell.

   ```azurecli
   az aks install-cli
   ```

10. Они проверяют подключение к кластеру, выполняя `kubectl get nodes` команду. Узел имеет то же имя, что и виртуальная машина в автоматически созданной группе ресурсов.

    ![AKS](./media/contoso-migration-rebuild/aks8.png)

11. Специалисты компании выполняют следующую команду для запуска панели мониторинга Kubernetes:

    ```azurecli
    az aks browse --resource-group ContosoRG --name smarthotelakseus2
    ```

12. На вкладке браузера откроется панель мониторинга. Это туннельное подключение, использующее Azure CLI.

    ![AKS](./media/contoso-migration-rebuild/aks9.png)

## <a name="step-2-configure-the-back-end-pipeline"></a>Шаг 2. Настройка серверного конвейера

### <a name="create-an-azure-devops-project-and-build"></a>Создание проекта и сборки Azure DevOps

Contoso создает проект Azure DevOps и настраивает сборку CI для создания контейнера и помещает его в реестр контейнеров. В инструкциях этого раздела используется репозиторий [SmartHotel360-серверной части](https://github.com/Microsoft/SmartHotel360-Backend) .

1. На visualstudio.com специалисты компании создают новую организацию (**contosodevops360.visualstudio.com**) и настраивают ее для использования Git.

2. Специалисты компании создают новый проект (**SmartHotelBackend**), используя Git для системы управления версиями и Agile для рабочего процесса.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts1.png)

3. Специалисты компании импортируют [репозиторий GitHub](https://github.com/Microsoft/SmartHotel360-Backend).

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts2.png)

4. В разделе **Конвейеры** они выбирают **Сборка** и создают конвейер, используя Git Azure Repos в качестве источника.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts3.png)

5. Специалисты компании решили начать с пустого задания.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts4.png)

6. Они выбирают **Hosted Linux Preview** (Размещенная предварительная версия Linux) для конвейера сборки.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts5.png)

7. На **этапе 1** добавляется задача **Docker Compose**. Эта задача создает Docker Compose.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts6.png)

8. Специалисты компании повторяют и добавляют еще одну задачу **Docker Compose**. Он передает контейнеры в реестр контейнеров.

     ![Azure DevOps](./media/contoso-migration-rebuild/vsts7.png)

9. Они выбирают первую задачу (для построения) и настраивают сборку с помощью подписки Azure, авторизации и реестра контейнеров.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts8.png)

10. Они указывают путь к файлу **docker-compose.yaml** в папке **src** репозитория. Специалисты компании выбирают создание образов служб и включают последний тег. Когда действие меняется на **Build service images** (Создание образов служб), имя задачи Azure DevOps меняется на **Build services automatically** (Автоматическое создание служб).

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts9.png)

11. Теперь они настраивают вторую задачу Docker (для отправки). Они выбирают подписку и реестр контейнеров **smarthotelacreus2** .

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts10.png)

12. Опять же, они вводят файл в файл DOCKER-сформируйте. YAML, а затем выбирают **образы службы отправки** и включают последний тег. Когда действие меняется на **Push service images** (Отправка образов служб), имя задачи Azure DevOps меняется на **Push services automatically** (Автоматическая отправка служб).

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts11.png)

13. Настроив задачи Azure DevOps, Contoso сохраняет конвейер сборки и запускает процесс сборки.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts12.png)

14. Они отслеживают ход выполнения, перейдя к заданию сборки.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts13.png)

15. После завершения сборки в реестре контейнеров отобразятся новые репозиториев, которые заполняются контейнерами, используемыми микрослужбами.

    ![Azure DevOps](./media/contoso-migration-rebuild/vsts14.png)

### <a name="deploy-the-back-end-infrastructure"></a>Развертывание серверной инфраструктуры

Создав кластер AKS и выполнив сборку образов Docker, администраторы Contoso развертывают остальную инфраструктуру, которая будет использоваться внутренними микрослужбами.

- Инструкции в разделе используют репозиторий [SmartHotel360-серверной части](https://github.com/Microsoft/SmartHotel360-Backend) .
- В папке **/deploy/k8s/arm** есть один сценарий для создания всех элементов.

Специалисты компании выполняют развертывание следующим образом:

1. Они открывают командную строку разработчика и используют команду `az login` для подписки Azure.

2. Они используют файл deploy. cmd для развертывания ресурсов Azure в группе ресурсов **ContosoRG** и регионе **EUS2** . для этого введите следующую команду:

    ```azurecli
    .\deploy.cmd azuredeploy ContosoRG -c eastus2
    ```

    ![Развертывание серверной части](./media/contoso-migration-rebuild/backend1.png)

3. На портале Azure специалисты компании записывают строки подключения для каждой базы данных. Они понадобятся позже.

    ![Развертывание серверной части](./media/contoso-migration-rebuild/backend2.png)

### <a name="create-the-back-end-release-pipeline"></a>Создание конвейера выпуска серверной части

Теперь администраторам Contoso потребуется предпринять следующее:

- Развернуть контроллер входящего трафика NGINX, чтобы разрешить входящий трафик к службам.
- Развернуть микрослужбы в кластере AKS.
- В первую очередь они обновляют строки подключения к микрослужбам с помощью Azure DevOps. Затем настраивают новый конвейер выпуска DevOps Azure для развертывания микрослужб.
- В инструкциях этого раздела используется репозиторий [SmartHotel360-серверной части](https://github.com/Microsoft/SmartHotel360-Backend) .
- Некоторые параметры конфигурации (например, Active Directory B2C) не рассматриваются в этой статье. Дополнительные сведения об этих параметрах см. в репозитории выше.

Далее создается конвейер:

1. С помощью Visual Studio они указывают в файле **/deploy/k8s/config_local.yml** записанные ранее сведения о подключении к базам данных.

    ![Подключения к базам данных](./media/contoso-migration-rebuild/back-pipe1.png)

2. Они открывают Azure DevOps и в проекте SmartHotel360 в разделе **Выпуски** щелкают **+ Новый конвейер**.

    ![Новый конвейер](./media/contoso-migration-rebuild/back-pipe2.png)

3. Специалисты компании щелкают **Пустое задание** для запуска конвейера без шаблона.
4. Они указывают имена рабочей области и конвейера.

      ![Название этапа](./media/contoso-migration-rebuild/back-pipe4.png)

      ![Имя конвейера](./media/contoso-migration-rebuild/back-pipe5.png)

5. Специалисты добавляют артефакт.

     ![Добавление артефакта](./media/contoso-migration-rebuild/back-pipe6.png)

6. Они выбирают **Git** в качестве источника и указывают проект, источник и главную ветвь для приложения SmartHotel360.

    ![Параметры артефакта](./media/contoso-migration-rebuild/back-pipe7.png)

7. Они выбирают ссылку на задачу.

    ![Ссылка на задачу](./media/contoso-migration-rebuild/back-pipe8.png)

8. Они добавляют новую задачу Azure PowerShell, чтобы можно было запускать сценарий PowerShell в среде Azure.

    ![PowerShell в Azure](./media/contoso-migration-rebuild/back-pipe9.png)

9. Специалисты выбирают подписку Azure для задачи и сценарий **deploy.ps1** из репозитория Git.

    ![Запуск сценария](./media/contoso-migration-rebuild/back-pipe10.png)

10. Они добавляют аргументы в сценарий. Сценарий удаляет все содержимое кластера (за исключением **входящего трафика** и **контроллера входящего трафика**) и развертывает микрослужбы.

    ![Аргументы сценария](./media/contoso-migration-rebuild/back-pipe11.png)

11. Специалисты настраивают как предпочтительную последнюю версию Azure PowerShell и сохраняют конвейер.

12. На странице **Выпуск** вручную создают новый выпуск.

    ![Новый выпуск](./media/contoso-migration-rebuild/back-pipe12.png)

13. Они выбирают созданный выпуск и на вкладке **Действия** щелкают **Развернуть**.

      ![Развертывание выпуска](./media/contoso-migration-rebuild/back-pipe13.png)

14. После завершения развертывания выполните следующую команду, чтобы проверить состояние служб с помощью Azure Cloud Shell: `kubectl get services` .

## <a name="step-3-provision-front-end-services"></a>Шаг 3. Подготовка интерфейсных служб

Администраторам Contoso необходимо развернуть инфраструктуру, которая будет использоваться интерфейсными приложениями. Они создают:

- Контейнер хранилища BLOB-объектов для хранения образов Pet
- База данных Cosmos DB для хранения документов, содержащих сведения об Pet
- API компьютерного зрения для веб-сайта.

В инструкциях для этого раздела используется репозиторий [SmartHotel360-website](https://github.com/microsoft/smartHotel360-website) .

### <a name="create-blob-storage-containers"></a>Создание контейнеров хранилища BLOB-объектов

1. В портал Azure они открывают созданную учетную запись хранения, а затем выбирают **большие двоичные объекты**.
2. Они создают новый контейнер с именем **pets** и общим уровнем доступа, установленным в Container. Пользователи отправляют фотографии своих домашних животных в этот контейнер.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob1.png)

3. Специалисты компании создают второй контейнер с именем **settings**. В нем будет размещен файл со всеми параметрами интерфейсного приложения.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob2.png)

4. Специалисты компании получают сведения о доступе для учетной записи хранения в текстовом файле для дальнейшего использования.

    ![Большой двоичный объект службы хранилища](./media/contoso-migration-rebuild/blob2.png)

### <a name="provision-a-cosmos-db-atabase"></a>Подготавливает Cosmos DB Аза данных

Администраторы Contoso подготавливают Cosmos DBную базу данных для использования с информацией Pet.

1. Специалисты компании создают **Azure Cosmos DB** в Azure Marketplace.

    ![Cosmos DB](./media/contoso-migration-rebuild/cosmos1.png)

2. Они указывают имя (**контососмарсотел**), выберите API SQL и поместите его в рабочую группу ресурсов **ContosoRG**в главном регионе "Восточная часть США 2".

    ![Cosmos DB](./media/contoso-migration-rebuild/cosmos2.png)

3. Специалисты компании добавляют новую коллекцию в базу данных с емкостью и пропускной способностью по умолчанию.

    ![Cosmos DB](./media/contoso-migration-rebuild/cosmos3.png)

4. Они сохраняют информацию о подключении к базе данных для дальнейшего использования.

    ![Cosmos DB](./media/contoso-migration-rebuild/cosmos4.png)

### <a name="provision-computer-vision"></a>Подготовка API компьютерного зрения

Администраторы Contoso подготавливают API компьютерного зрения. API будет вызываться с помощью функции для оценки изображений, отправленных пользователями.

1. Специалисты компании Contoso создают экземпляр **API компьютерного зрения** в Azure Marketplace.

     ![API Компьютерного зрения](./media/contoso-migration-rebuild/vision1.png)

2. Они подготавливают API (**смарсотелпетс**) в Рабочей группе ресурсов **ContosoRG**в главном регионе "Восточная часть США 2".

    ![API Компьютерного зрения](./media/contoso-migration-rebuild/vision2.png)

3. Специалисты компании сохраняют параметры подключения API в текстовый файл для последующего использования.

     ![API Компьютерного зрения](./media/contoso-migration-rebuild/vision3.png)

### <a name="provision-the-azure-web-app"></a>Подготовка веб-приложения Azure

Администраторы Contoso подготавливают веб-приложение с помощью портала Azure.

1. На портале специалисты компании выбирают **Веб-приложение**.

    ![Веб-приложение](./media/contoso-migration-rebuild/web-app1.png)

2. Они указывают имя приложения (**smarthotelcontoso**), запускают его в Windows и помещают в рабочую группу ресурсов **ContosoRG**. Они создают новый экземпляр Application Insights для наблюдения за приложениями.

    ![Имя веб-приложения](./media/contoso-migration-rebuild/web-app2.png)

3. По завершении создания специалисты компании перейдут по адресу приложения, чтобы проверить, что оно создано успешно.

4. Теперь на портале Azure они создают промежуточный слот для кода. В нем будет развернут конвейер. Это гарантирует, что код не помещается в рабочую среду, пока администраторы выполняют выпуск.

    ![Промежуточный слот веб-приложения](./media/contoso-migration-rebuild/web-app3.png)

### <a name="provision-the-azure-function-app"></a>Подготовка приложения-функции Azure

На портале Azure администраторы Contoso подготавливают приложение-функцию.

1. Они щелкают **Приложение-функция**.

   ![Создание приложения-функции](./media/contoso-migration-rebuild/function-app1.png)

2. Они предоставляют имя приложения (**smarthotelpetchecker**). Они размещают приложение в Рабочей группе ресурсов **ContosoRG**. Они задают размещение в **плане потребления**и размещают приложение в регионе "Восточная часть США 2". Создается учетная запись хранения, а также экземпляр Application Insights для мониторинга.

   ![Параметры приложения-функции](./media/contoso-migration-rebuild/function-app2.png)

3. По завершении развертывания приложения специалисты компании перейдут по его адресу, чтобы проверить, что оно создано успешно.

## <a name="step-4-set-up-the-front-end-pipeline"></a>Шаг 4. Настройка конвейера внешнего интерфейса

Администраторы Contoso создают два различных проекта для сайта внешнего интерфейса.

1. В Azure DevOps они создают проект **SmartHotelFrontend**.

   ![Проект внешнего интерфейса](./media/contoso-migration-rebuild/function-app1.png)

2. Администраторы импортируют репозиторий Git [SmartHotel360 front-end](https://github.com/Microsoft/SmartHotel360-Website) в новый проект.

3. Для приложения-функции они создают другой проект Azure DevOps (**смарсотелпетчеккер**) и импортируют репозиторий [петчеккер](https://github.com/sonahander/SmartHotel360-PetCheckerFunction) Git в этот проект.

### <a name="configure-the-web-app"></a>Настройка веб-приложения

Теперь администраторы Contoso настраивают веб-приложение для использования ресурсов Contoso.

1. Они подключаются к проекту Azure DevOps и клонируют репозиторий локально на компьютер разработки.
2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.

    ![Файлы репозитория](./media/contoso-migration-rebuild/configure-webapp1.png)

3. Они вносят необходимые изменения конфигурации.

    - При запуске веб-приложение ищет параметр приложения **SettingsUrl**.
    - Данная переменная должна содержать URL-адрес файла конфигурации.
    - По умолчанию используется общедоступная конечная точка.

4. Специалисты компании обновляют файл /config-sample.json/sample.json.

    - Это файл конфигурации веб-приложения при использовании общедоступной конечной точки.
    - Они изменяют **URL-адреса** и **pets_config** разделы значениями для конечных точек API AKS, учетных записей хранения и базы данных Cosmos DB.
    - URL-адреса должны соответствовать DNS-имени нового веб-приложения, которое создает Contoso.
    - Для Contoso это **smarthotelcontoso.eastus2.cloudapp.azure.com**.

    ![Параметры JSON](./media/contoso-migration-rebuild/configure-webapp2.png)

5. После обновления файла специалисты компании переименуют его в **smarthotelsettingsurl** и отправят в хранилище BLOB-объектов, которое было создано ранее.

    ![Переименование и отправка](./media/contoso-migration-rebuild/configure-webapp3.png)

6. Администраторы выбирают файл, чтобы получить URL-адрес. Этот URL-адрес используется приложением, когда оно начинает извлекать файлы конфигурации.

    ![URL-адрес приложения](./media/contoso-migration-rebuild/configure-webapp4.png)

7. Специалисты компании указывают URL-адрес нового файла для параметра **SettingsUrl** в файле **appsettings.Production.json**.

    ![Обновление URL-адреса](./media/contoso-migration-rebuild/configure-webapp5.png)

### <a name="deploy-the-website-to-azure-app-service"></a>Развертывание веб-сайта в Службе приложений Azure

Администраторы Contoso теперь могут опубликовать веб-сайт.

1. Они открывают Azure DevOps и в проекте **SmartHotelFrontend** в разделе **Builds and Releases** (Сборки и выпуски) выбирают **+ Новый конвейер**.
2. Администраторы выбирают **Azure DevOps Git** как источник.
3. Затем они выбирают шаблон **ASP.NET Core**.
4. Они просматривают конвейер и проверяют, что выбраны **Публикация веб-проектов** и **Упаковать опубликованные проекты**.

    ![Параметры конвейера](./media/contoso-migration-rebuild/vsts-publish-front2.png)

5. В разделе **Триггеры** они включают непрерывную интеграцию и добавляют главную ветвь. Это гарантирует, что каждый раз, когда решение содержит новый код, зафиксированный в главной ветви, запускается конвейер сборки.

    ![Непрерывная интеграция](./media/contoso-migration-rebuild/vsts-publish-front3.png)

6. Они выбирают **Сохранить и поместить в очередь**, чтобы начать выполнение сборки.
7. После завершения сборки они настраивают конвейер выпуска, используя параметр **Развертывание службы приложений Azure**.
8. Они указывают имя этапа как **Промежуточный**.

    ![Имя среды](./media/contoso-migration-rebuild/vsts-publish-front4.png)

9. Они добавляют артефакт и выбирают сборку, которую они настроили.

     ![Добавление артефакта](./media/contoso-migration-rebuild/vsts-publish-front5.png)

10. Они щелкают значок молнии на артефакте, чтобы включить непрерывное развертывание.

    ![Непрерывное развертывание](./media/contoso-migration-rebuild/vsts-publish-front6.png)
11. На вкладке **Среда** они щелкают **1 задание, 1 задача** в разделе **Промежуточный**.
12. После выбора подписки и имени приложения администраторы открывают задачу **Развертывание службы приложений Azure**. Развертывание настроено для использования **промежуточного** слота развертывания. В результате код будет автоматически создан для проверки и утверждения в этом слоте.

     ![Слот](./media/contoso-migration-rebuild/vsts-publish-front7.png)

13. На вкладке **Конвейер** администраторы добавляют новый этап.

    ![Новая среда](./media/contoso-migration-rebuild/vsts-publish-front8.png)

14. Они выбирают **Развертывание службы приложений Azure с помощью слота** и называют среду **Prod**.
15. Они выбирают **1 задание, 2 задачи**, затем выберите подписку, имя службы приложений и **промежуточный** слот.

    ![Имя среды](./media/contoso-migration-rebuild/vsts-publish-front10.png)

16. Они удаляют этап **развертывания службы приложений Azure в слот** из конвейера. Он был помещен туда на предыдущих шагах.

    ![Удаление из конвейера](./media/contoso-migration-rebuild/vsts-publish-front11.png)

17. Они сохраняют конвейер. В конвейере администраторы щелкают **Условия после развертывания**.

    ![После развертывания](./media/contoso-migration-rebuild/vsts-publish-front12.png)

18. Они включают **Утверждения после развертывания** и добавляют руководителя разработки в качестве утверждающего.

    ![Утверждение после развертывания](./media/contoso-migration-rebuild/vsts-publish-front13.png)

19. В конвейере сборки они вручную запускают сборку. При этом запускается новый конвейер выпуска, который используется для развертывания сайта в промежуточном слоте. Для Contoso URL-адресом слота является `https://smarthotelcontoso-staging.azurewebsites.net/`.

20. После завершения сборки и развертывания выпуска в слоте Azure DevOps отправляет электронное письмо руководителю разработки для утверждения.

21. Руководитель разработки щелкает **Просмотреть утверждение** и может утвердить или отклонить запрос на портале Azure DevOps.

    ![Письмо для утверждения](./media/contoso-migration-rebuild/vsts-publish-front14.png)

22. Руководитель оставляет комментарий, а затем утверждает. Это запустит переключение между **промежуточными** и **рабочими слотами и** переместит сборку в рабочую среду.

    ![Утверждение и переключение](./media/contoso-migration-rebuild/vsts-publish-front15.png)

23. Конвейер завершает переключение.

    ![Полное переключение](./media/contoso-migration-rebuild/vsts-publish-front16.png)

24. Команда проверяет слот **prod**, чтобы убедиться, что веб-приложение находится в рабочей среде по адресу `https://smarthotelcontoso.azurewebsites.net/`.

### <a name="deploy-the-petchecker-function-app"></a>Развертывание приложения-функции PetChecker

Администраторы Contoso развертывают приложение следующим образом.

1. Они подключаются к проекту Azure DevOps и клонируют репозиторий локально на компьютер разработки.
2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.
3. Они открывают файл **src/петчеккерфунктион/Local. Settings. JSON** и добавляют параметры приложения для хранилища, базы данных Cosmos DB и API компьютерного зрения.

    ![Развертывание функции](./media/contoso-migration-rebuild/function5.png)

4. Администраторы фиксируют код и синхронизируют его с Azure DevOps, передав изменения.
5. Они добавляют новый конвейер сборки, а затем выбирают **Azure DevOps Git** для источника.
6. Затем они выбирают шаблон **ASP.NET Core (.NET Framework)**.
7. Администраторы принимают значения по умолчанию для шаблона.
8. В **триггерах**выберите **включить непрерывную интеграцию**, а затем выберите **сохранить & очередь** , чтобы начать сборку.
9. По завершении сборки они создают конвейер выпуска, добавив **Развертывание службы приложений Azure с помощью слота**.
10. Они наименают **рабочую среду**среды, а затем выбирают подписку. Они указывают в качестве **типа приложения****Приложение-функция** и вводят имя службы приложений **smarthotelpetchecker**.

    ![Приложение-функция](./media/contoso-migration-rebuild/petchecker2.png)

11. Затем они добавляют артефакт **Сборка**.

    ![Артефакт](./media/contoso-migration-rebuild/petchecker3.png)

12. Они включают **Триггер непрерывного развертывания**, а затем нажмите кнопку **сохранить**.
13. Они щелкают **Поставить новую сборку в очередь** для запуска полного конвейера CI/CD.
14. После развертывания функции она отображается на портале Azure с состоянием **Выполняется**.

    ![Развертывание функции](./media/contoso-migration-rebuild/function6.png)

15. Специалисты компании переходят к приложению по адресу `http://smarthotel360public.azurewebsites.net/pets`, чтобы проверить, работает ли функция проверки домашних животных надлежащим образом.

16. Специалисты компании щелкают аватар, чтобы передать изображение.

    ![Развертывание функции](./media/contoso-migration-rebuild/function7.png)

17. Сначала проверяется фотография небольшой собаки.

    ![Развертывание функции](./media/contoso-migration-rebuild/function8.png)

18. Приложение возвращает сообщение о принятии.

    ![Развертывание функции](./media/contoso-migration-rebuild/function9.png)

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Компания Contoso должна гарантировать, что их новые базы данных безопасны. [Подробнее](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview).
- Приложение должно быть обновлено для использования SSL с сертификатами. Экземпляр контейнера должен быть повторно развернут для ответа через порт 443.
- Компании Contoso необходимо рассмотреть возможность использования Key Vault для защиты секретов для приложений Service Fabric. [Подробнее](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-secret-management).

### <a name="backups-and-disaster-recovery"></a>Резервное копирование и аварийное восстановление

- Contoso необходимо проверить [требования к резервному копированию для базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).
- Компания Contoso должна рассмотреть возможность реализации [групп отработки отказа SQL для обеспечения региональной отработки отказа для базы данных](https://docs.microsoft.com/azure/sql-database/sql-database-auto-failover-group).
- Contoso может использовать [георепликацию для SKU реестра контейнеров Azure Premium](https://docs.microsoft.com/azure/container-registry/container-registry-geo-replication).
- Cosmos DB автоматически архивируется. [Здесь](https://docs.microsoft.com/azure/cosmos-db/online-backup-and-restore) можно узнать больше об этом процессе.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](./contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Компания Contoso включит службу " [Управление затратами Azure](https://docs.microsoft.com/azure/cost-management-billing/cost-management-billing-overview) " для мониторинга ресурсов Azure и управления ими.

## <a name="conclusion"></a>Заключение

В этой статье специалисты компании Contoso повторно создали приложение SmartHotel360 в Azure. Они перестроили интерфейсную виртуальную машину локального приложения для использования веб-приложений Службы приложений Azure. Серверная часть приложения создана с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Специалисты компании улучшили возможности приложения с помощью приложения для фотографирования домашних животных.

## <a name="suggested-skills"></a>Предлагаемые навыки

Microsoft Learn — это новый подход к изучению. Готовность к работе с новыми навыками и обязанностями, связанными с внедрением облачных технологий, дается нелегко. Microsoft Learn предоставляет более результативный подход к практическим занятиям, которые помогают быстрее достичь целей. Получайте баллы, проходите уровни и достигайте более высоких результатов.

Ниже приведено несколько примеров настроенных путей обучения на Microsoft Learn, которые соответствуют приложению Contoso SmartHotel360 в Azure.

- ** [Развертывание веб-сайта в Azure с помощью службы приложений Azure](https://docs.microsoft.com/learn/paths/deploy-a-website-with-azure-app-service).** Веб-приложения в Azure позволяют легко публиковать веб-сайт и управлять им без необходимости работы с базовыми серверами, хранилищами или сетевыми ресурсами. Вместо этого вы можете сосредоточиться на функционале сайта, положившись на надежную платформу Azure, которая обеспечит безопасный доступ к нему.

- ** [Обработайте и классифицируйте образы с помощью служб "самовидение" Azure](https://docs.microsoft.com/learn/paths/classify-images-with-vision-services):** Azure Cognitive Services предлагает предварительно созданные функции для обеспечения функциональных возможностей компьютерных концепций в приложениях. Узнайте, как использовать службы Cognitive Vision Services для обнаружения лиц, пометки и классификации изображений, а также идентификации объектов.
