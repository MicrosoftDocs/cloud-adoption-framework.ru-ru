---
title: Перестроение локального приложения в Azure
description: Узнайте, как Contoso перестраивает приложение в Azure с помощью службы приложений Azure, службы Kubernetes, Cosmos DB, функций и Cognitive Services.
author: BrianBlanchard
ms.author: brblanch
ms.date: 7/1/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: site-recovery
ms.openlocfilehash: a0592177a3a7bd08b8f29ad632a0bf61b6294e6a
ms.sourcegitcommit: 9163a60a28ffce78ceb5dc8dc4fa1b83d7f56e6d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/17/2020
ms.locfileid: "86449546"
---
<!-- docsTest:ignore "Enable .NET" SmartHotel360 SmartHotel360-Backend Pet.Checker contoso-datacenter git aks PetCheckerFunction -->

<!-- cSpell:ignore givenscj SQLVM WEBVM contosohost vcenter contosodc smarthotel contososmarthotel smarthotelcontoso smarthotelpetchecker petchecker smarthotelakseus smarthotelacreus smarthotelpets kubectl contosodevops visualstudio azuredeploy cloudapp smarthotelsettingsurl appsettings -->

# <a name="rebuild-an-on-premises-application-in-azure"></a>Перестроение локального приложения в Azure

В этой статье показано, как вымышленная компания Contoso перестраивает двухстороннее приложение Windows .NET, работающее на виртуальных машинах VMware, в рамках миграции в Azure. Компания Contoso переносит клиентскую виртуальную машину в веб-приложение службы приложений Azure. Серверная часть приложения создана с использованием микрослужб, развернутых в контейнерах, управляемых Службой Azure Kubernetes (AKS). Веб-сайт взаимодействует со службой "Функции Azure", предоставляя функцию фотографирования животных.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** Компания Contoso растет и хочет получить дифференцированные возможности для клиентов на веб-сайтах contoso.
- **Гибкость.** Компания Contoso должна иметь возможность реагировать быстрее, чем изменения в Marketplace, чтобы обеспечить успешную работу в глобальной экономике.
- **Измените.** По мере успешного развития бизнеса ИТ-отдел компании Contoso должен предоставить системы, которые могут расти в одном темпе.
- **Сократите затраты.** Компании Contoso требуется минимизировать затраты на лицензирование.

## <a name="migration-goals"></a>Цели миграции

Группа разработчиков Contoso Cloud заблокировала требования к приложениям для этой миграции. Эти требования использовались для определения оптимального метода миграции:

- Приложение в Azure по-прежнему является критически важным, как сегодня. Оно должно хорошо работать и легко масштабироваться.
- Приложение не должно использовать компоненты IaaS. Все должно быть создано для использования с PaaS или бессерверных служб.
- Сборки приложений должны выполняться в облачных службах, а контейнеры должны находиться в частном корпоративном реестре в облаке.
- Служба API, используемая для фотографий Pet, должна быть точной и надежной в реальном мире, так как решения, принятые приложением, должны учитываться в своих гостиницах. Любой одобренный питомец может остаться в гостинице.
- Чтобы удовлетворить требования для конвейера DevOps, Contoso будет использовать репозиторий Git в Azure Repos для управления исходным кодом. Автоматические выполняемые сборки и выпуски будут использоваться для компиляции кода и его развертывания в Службе приложений Azure, Функциях Azure и AKS.
- Различные конвейеры непрерывной интеграции и непрерывной разработки (CI/CD) необходимы для микрослужб в серверной части и для веб-сайта на стороне внешнего интерфейса.
- Цикл выпуска внутренних служб отличается от цикла выпуска интерфейсного веб-приложения. Для удовлетворения этого требования они будут развертывать два разных конвейера.
- Contoso необходимо утвердить все развертывание интерфейсного веб-сайта, и конвейер CI/CD должен обеспечить это.

## <a name="solution-design"></a>Архитектура решения

Определив цели и требования, специалисты Contoso начинают разработку и анализ решения развертывания и идентифицируют процесс миграции, включая службы Azure, которые будут использоваться при миграции.

### <a name="current-application"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено между двумя виртуальными машинами ( `WEBVM` и `SQLVM` ).
- Виртуальные машины расположены на узле VMware ESXi `contosohost1.contoso.com` (версии 6.5).
- Среда VMware находится под управлением сервера vCenter Server 6.5 (`vcenter.contoso.com`), запущенного на виртуальной машине.
- Компания Contoso использует локальный центр обработки данных (`contoso-datacenter`) с локальным контроллером домена (`contosodc1`).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

### <a name="proposed-architecture"></a>Предлагаемая архитектура

- Внешний интерфейс приложения развертывается как веб-приложение службы приложений Azure в основном регионе Azure.
- Служба "Функции Azure" обеспечит передачу фотографий домашних животных, и веб-сайт будет взаимодействовать с этой функцией.
- Функция фото в Pet использует API компьютерного зрения Cognitive Services Azure вместе с Azure Cosmos DB.
- Серверная часть сайта создается с использованием микрослужб. Они будут развернуты в контейнерах, управляемых в AKS.
- Контейнеры будут созданы с помощью Azure DevOps и отправлены в реестр контейнеров Azure.
- Сейчас специалисты Contoso вручную развернут веб-приложение и код функции с помощью Visual Studio.
- Микрослужбы развертываются с помощью сценария PowerShell, который вызывает программы командной строки Kubernetes.

    ![Архитектура сценария ](./media/contoso-migration-rebuild/architecture.png) _рис. 1. Архитектура сценария._

### <a name="solution-review"></a>Проверка решения

Специалисты Contoso оценивают предлагаемый дизайн, составляя список плюсов и минусов.

| Рассматриваемый вопрос | Сведения |
| --- | --- |
| **Преимущества** | Использование PaaS и бессерверных решений для полного развертывания значительно сокращает время управления со стороны Contoso. <br><br> Переход на архитектуру на основе микрослужб позволяет компании Contoso легко расширять решение с течением времени. <br><br> Новая функциональность может быть подключена к Интернету, не нарушая ни одной из имеющихся баз кода решений. <br><br> Для веб-приложения будет настроено несколько экземпляров, что гарантирует отсутствие единой точки отказа. <br><br> Автоматическое масштабирование будет включено, чтобы приложение могла обрабатывать разные объемы трафика. <br><br> В связи с переходом к службам PaaS компания Contoso может прекратить использовать устаревшие решения под управлением операционной системы Windows Server 2008 R2. <br><br> Azure Cosmos DB имеет встроенную отказоустойчивость, которая не требует настройки компанией Contoso. Это означает, что уровень данных больше не является единой точкой отказа. |
| **Недостатки** | По сравнению с другими вариантами миграции контейнеры более сложные. Для Contoso длительное изучение может стать проблемой. Они представляют новый уровень сложности, который обеспечивает значение, несмотря на кривую. <br><br> Группа эксплуатации в компании Contoso должна освоиться для понимания и поддержки Azure, контейнеров и микрослужб для приложения. <br><br> Компания Contoso не полностью реализовала DevOps для всего решения. Специалистам компании нужно подумать об этом при развертывании служб в AKS, Функциях Azure и Службе приложений Azure. |

### <a name="migration-process"></a>Процесс миграции

1. Компания Contoso подготавливает реестр контейнеров Azure, AKS и Azure Cosmos DB.
2. Компания Contoso подготавливает инфраструктуру для развертывания, включая веб-приложение службы приложений Azure, учетную запись хранения, функцию и API.
3. После создания инфраструктуры они будут создавать свои образы контейнеров микрослужб с помощью Azure DevOps, которая передает их в реестр контейнеров.
4. Специалисты Contoso развернут большинство этих микрослужб в ASK с помощью сценария PowerShell.
5. Наконец, они развернут функцию и веб-приложение.

    ![Процесс миграции ](./media/contoso-migration-rebuild/migration-process.png) _рис. 2. процесс миграции._

### <a name="azure-services"></a>Службы Azure

| Служба | Описание | Стоимость |
|---|---|---|
| [AKS](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | Упрощает развертывание, администрирование и использование Kubernetes. Предоставляет полностью управляемую службу оркестрации контейнеров Kubernetes. | AKS — это бесплатная служба. Платите только за виртуальные машины, связанные хранилища и сетевые ресурсы, используемые. [Подробнее](https://azure.microsoft.com/pricing/details/kubernetes-service). |
| [Функции Azure](https://azure.microsoft.com/services/functions) | Ускорьте процесс разработки с помощью управляемых событиями и независимыми от сервера вычислительных средств. Выполняйте масштабирование по необходимости. | Платите только за использованные ресурсы. Плата по плану начисляется в зависимости от потребления ресурсов и числа выполнений в секунду. [Подробнее](https://azure.microsoft.com/pricing/details/functions). |
| [Реестр контейнеров Azure](https://azure.microsoft.com/services/container-registry) | Хранит образы для всех типов развертываний контейнеров. | Стоимость зависит от функций, типа хранилища и длительности использования. [Подробнее](https://azure.microsoft.com/pricing/details/container-registry). |
| [Служба приложений Azure](https://azure.microsoft.com/services/app-service/containers) | Оперативно создавайте, развертывайте и масштабируйте веб-приложения, мобильные приложения и приложения API на любой платформе. | Счета за планы службы приложений выставляются за секунду. [Подробнее](https://azure.microsoft.com/pricing/details/app-service/windows). |

## <a name="prerequisites"></a>Предварительные требования

Ниже приведены действия компании Contoso, необходимые для этого сценария.

| Требования | Сведения |
| --- | --- |
| Подписка Azure | <li> Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/free). <li> Если вы создаете бесплатную учетную запись, вы являетесь администратором подписки и можете выполнять все действия. <li> Если вы используете существующую подписку и вы не являетесь администратором, вам нужно обратиться к администратору, чтобы назначить вам разрешения владельца или участника. |
| Инфраструктура Azure | <li> Узнайте [, как Contoso настраивает инфраструктуру Azure](./contoso-migration-infrastructure.md). |
| Предварительные требования для разработчика | Contoso необходимы следующие средства на рабочей станции разработчика: <li>  [Visual Studio Community 2017: версия 15,5](https://visualstudio.microsoft.com) <li> Включите рабочую нагрузку .NET. <li> [Git](https://git-scm.com); <li> [Azure PowerShell](https://azure.microsoft.com/downloads) <li> [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest) <li> [DOCKER Community Edition (Windows 10) или DOCKER Enterprise Edition (Windows Server)](https://docs.docker.com/docker-for-windows/install) настроен для использования контейнеров Windows. |

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. подготавливает AKS и реестр контейнеров Azure.** Компания Contoso подготавливает управляемый кластер AKS и реестр контейнеров с помощью PowerShell.
> - **Шаг 2. Создание контейнеров DOCKER.** Они настроили непрерывную интеграцию (CI) для контейнеров DOCKER с помощью Azure DevOps и принудительно отправляют их в реестр контейнеров.
> - **Шаг 3. Развертывание серверных микрослужб.** Специалисты компании развертывают остальную часть инфраструктуры, которая будет использоваться внутренними микрослужбами.
> - **Шаг 4. Развертывание интерфейсной инфраструктуры.** Они развертывают интерфейсную инфраструктуру, включая хранилище BLOB-объектов для домашних телефонов, Azure Cosmos DB и API компьютерного зрения.
> - **Шаг 5. Перенос серверной части.** Они развертывают микрослужбы и запускаются в AKS для переноса серверной части.
> - **Шаг 6. Публикация внешнего интерфейса.** Они публикуют приложение SmartHotel360 в службе приложений Azure вместе с приложением функции, которое вызывается службой Pet.

## <a name="step-1-provision-back-end-resources"></a>Шаг 1. Подготовка ресурсов серверной части

Администраторы Contoso выполняют скрипт развертывания для создания управляемого кластера Kubernetes с помощью AKS и реестра контейнеров Azure. В инструкциях для этого раздела используется репозиторий GitHub [SmartHotel360-](https://github.com/Microsoft/SmartHotel360-Backend) The. Репозиторий содержит все программное обеспечение для данной части развертывания.

### <a name="ensure-prerequisites"></a>Обеспечение предварительных требований

Прежде чем начать, администраторы Contoso гарантируют, что все необходимое программное обеспечение устанавливается на компьютере разработки, используемом для развертывания. С помощью Git специалисты компании клонируют репозиторий локально на компьютер разработки: 

`git clone https://github.com/Microsoft/SmartHotel360-Backend.git`

### <a name="provision-aks-and-azure-container-registry"></a>Подготавливает AKS и реестр контейнеров Azure

Администраторы Contoso выполняют подготовку следующим образом:

1. Они открывают папку с помощью Visual Studio Code и переходят в `/deploy/k8s` каталог, содержащий скрипт `gen-aks-env.ps1` .

2. Они запускают скрипт для создания управляемого кластера Kubernetes с помощью AKS и реестра контейнеров Azure.

    ![AKS ](./media/contoso-migration-rebuild/aks1.png) _рис. 3. Создание управляемого кластера Kubernetes._

3. После открытия файла он обновит параметр $location на `eastus2` и сохранит файл.

    ![AKS ](./media/contoso-migration-rebuild/aks2.png) _рис. 4. Сохранение файла._

4. Они выбирают пункт **Просмотреть**  >  **терминал** , чтобы открыть интегрированный терминал в Visual Studio Code.

    ![AKS ](./media/contoso-migration-rebuild/aks3.png) _рис. 5. терминал в Visual Studio Code._

5. В интегрированном терминале PowerShell они входят в Azure с помощью `Connect-AzureRmAccount` команды. Дополнительные сведения см. в статье [Приступая к работе с PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

    ![AKS ](./media/contoso-migration-rebuild/aks4.png) _рис. 6. Встроенный терминал PowerShell._

6. Они выполняют проверку подлинности Azure CLI, выполняя `az login` команду и следуя инструкциям по проверке подлинности с помощью веб-браузера. Дополнительные сведения о входе с помощью Azure CLI см. в [этой статье](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

    ![AKS ](./media/contoso-migration-rebuild/aks5.png) _рис. 7. Проверка подлинности Azure CLI._

7. При передаче имени группы ресурсов `ContosoRG` , имени кластера AKS `smarthotel-aks-eus2` и нового имени реестра они выполняют следующую команду.

    `.\gen-aks-env.ps1  -resourceGroupName ContosoRg -orchestratorName smarthotelakseus2 -registryName smarthotelacreus2`

    ![AKS ](./media/contoso-migration-rebuild/aks6.png) _рис. 8. выполнение команды._

8. Azure создает другую группу ресурсов, содержащую ресурсы для кластера AKS.

    ![AKS ](./media/contoso-migration-rebuild/aks7.png) _рис. 9. Создание группы ресурсов в Azure._

9. После завершения развертывания устанавливается `kubectl` программа командной строки. Средство уже установлено на Azure Cloud Shell.

    `az aks install-cli`

10. Они проверяют подключение к кластеру, выполняя `kubectl get nodes` команду. Узел имеет то же имя, что и виртуальная машина в автоматически созданной группе ресурсов.

    ![AKS ](./media/contoso-migration-rebuild/aks8.png)
     _рис. 10. Проверка подключения к кластеру._

11. Чтобы запустить панель мониторинга Kubernetes, выполните следующую команду:

    `az aks browse --resource-group ContosoRG --name smarthotelakseus2`

12. Откроется вкладка браузер на панели мониторинга. Это туннельное подключение, использующее Azure CLI.

    ![AKS ](./media/contoso-migration-rebuild/aks9.png)
     _рис. 11. туннельное соединение._

## <a name="step-2-configure-the-back-end-pipeline"></a>Шаг 2. Настройка серверного конвейера

### <a name="create-an-azure-devops-project-and-build"></a>Создание проекта и сборки Azure DevOps

Contoso создает проект Azure DevOps и настраивает сборку CI для создания контейнера и помещает его в реестр контейнеров. В инструкциях этого раздела используется репозиторий [SmartHotel360-серверной части](https://github.com/Microsoft/SmartHotel360-Backend) .

1. В `visualstudio.com` они создают новую организацию ( `contosodevops360.visualstudio.com` ) и настраивают ее для использования Git.

2. Они создают новый проект ( `SmartHotelBackend` ), выбирая **Git** для управления версиями и **Agile** для рабочего процесса.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts1.png) _рис. 12. Создание нового проекта._

3. Специалисты компании импортируют [репозиторий GitHub](https://github.com/Microsoft/SmartHotel360-Backend).

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts2.png) _рис. 13. Импорт репозитория GitHub._

4. В **конвейерах**они выбирают **сборку** и создают новый конвейер, используя Azure Repos Git в качестве источника из репозитория.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts3.png) _рис. 14. Создание нового конвейера._

5. Специалисты компании решили начать с пустого задания.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts4.png) _рис. 15. Начиная с пустого задания._

6. Они выбирают **Hosted Linux Preview** (Размещенная предварительная версия Linux) для конвейера сборки.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts5.png) _рис. 16. Настройка конвейера сборки._

7. На **этапе 1** добавляется задача **Docker Compose**. Эта задача создает Docker Compose.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts6.png) _рис. 17. Создание DOCKER Compose._

8. Специалисты компании повторяют и добавляют еще одну задачу **Docker Compose**. Он передает контейнеры в реестр контейнеров.

     ![Azure DevOps ](./media/contoso-migration-rebuild/vsts7.png) _рис. 18. Добавление еще одной задачи DOCKER Compose._

9. Они выбирают первую задачу для сборки и настройки сборки с помощью подписки Azure, авторизации и реестра контейнеров.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts8.png) _рис. 19. сборка и Настройка сборки._

10. Они указывают путь к `docker-compose.yaml` файлу в `src` папке репозитория. Специалисты компании выбирают создание образов служб и включают последний тег. Когда действие меняется на **Build service images** (Создание образов служб), имя задачи Azure DevOps меняется на **Build services automatically** (Автоматическое создание служб).

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts9.png)
     _рис. 20. особенности задачи._

11. Теперь они настраивают вторую задачу Docker (для отправки). Они выбирают подписку и реестр контейнеров ( `smarthotelacreus2` ).

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts10.png)
     _рис. 21. Настройка второй задачи DOCKER._

12. Они вводят файл в `docker-compose.yaml` файл и выбирают **образы службы push-уведомлений**, включая последний тег. Когда действие меняется на **Push service images** (Отправка образов служб), имя задачи Azure DevOps меняется на **Push services automatically** (Автоматическая отправка служб).

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts11.png)
     _рис. 22. изменение имени задачи DevOps для Azure._

13. После настройки задач DevOps Azure компания Contoso сохраняет конвейер сборки и запускает процесс сборки.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts12.png)
     _рис. 23. Запуск процесса сборки._

14. Они отслеживают ход выполнения, перейдя к заданию сборки.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts13.png)
     _рис. 24. Проверка хода выполнения._

15. После завершения сборки в реестре контейнеров отобразятся новые репозиториев, которые заполняются контейнерами, используемыми микрослужбами.

    ![Azure DevOps ](./media/contoso-migration-rebuild/vsts14.png)
     _рис. 25. Просмотр новых репозиториев после завершения сборки._

### <a name="deploy-the-back-end-infrastructure"></a>Развертывание серверной инфраструктуры

Создав кластер AKS и выполнив сборку образов Docker, администраторы Contoso развертывают остальную инфраструктуру, которая будет использоваться внутренними микрослужбами.

- В инструкциях этого раздела используется репозиторий [SmartHotel360-серверной части](https://github.com/Microsoft/SmartHotel360-Backend) .
- В `/deploy/k8s/arm` папке есть один сценарий для создания всех элементов.

Специалисты компании выполняют развертывание следующим образом:

1. Они открывают командную строку разработчика и используют команду `az login` для подписки Azure.

2. Они используют `deploy.cmd` файл для развертывания ресурсов Azure в `ContosoRG` группе ресурсов и `East US 2` регионе. для этого введите следующую команду:

    `.\deploy.cmd azuredeploy ContosoRG -c eastus2`

    ![Развертывание серверной части ](./media/contoso-migration-rebuild/backend1.png) _рис. 26. Развертывание серверной части._

3. В портал Azure они записывают строку подключения для каждой базы данных, которая будет использоваться позднее.

    ![Развертывание серверной части на ](./media/contoso-migration-rebuild/backend2.png) _рис. 27. запись строки подключения для каждой базы данных._

### <a name="create-the-back-end-release-pipeline"></a>Создание конвейера выпуска серверной части

Теперь администраторам Contoso потребуется предпринять следующее:

- Развернуть контроллер входящего трафика NGINX, чтобы разрешить входящий трафик к службам.
- Развернуть микрослужбы в кластере AKS.
- В первую очередь они обновляют строки подключения к микрослужбам с помощью Azure DevOps. Затем они настраивают новый конвейер выпуска Azure DevOps для развертывания микрослужб.
- В инструкциях этого раздела используется репозиторий [SmartHotel360-серверной части](https://github.com/Microsoft/SmartHotel360-Backend) .
- Некоторые параметры конфигурации (например, Active Directory B2C) не рассматриваются в этой статье. Дополнительные сведения об этих параметрах см. в репозитории выше.

Далее создается конвейер:

1. С помощью Visual Studio обновите `/deploy/k8s/config_local.yml` файл с помощью сведений о подключении к базе данных, упомянутых выше.

    ![Подключения к базам данных ](./media/contoso-migration-rebuild/back-pipe1.png) _рис. 28. подключения к базе данных._

2. Они открывают Azure DevOps, и в проекте SmartHotel360 они выбирают **+ New конвейер** в **выпусках**.

    ![Новый конвейер ](./media/contoso-migration-rebuild/back-pipe2.png) _Figure 29: Новый конвейер.

3. Специалисты компании щелкают **Пустое задание** для запуска конвейера без шаблона.
4. Они указывают имена рабочей области и конвейера.

      ![Название этапа ](./media/contoso-migration-rebuild/back-pipe4.png) _рис. 30. имя этапа._

      ![Имя конвейера ](./media/contoso-migration-rebuild/back-pipe5.png) _рис. 31. имя конвейера._

5. Специалисты добавляют артефакт.

     ![Добавление артефакта ](./media/contoso-migration-rebuild/back-pipe6.png) _рис. 32. Добавление артефакта._

6. Они выбирают **Git** в качестве исходного типа и указывают проект, источник и главную ветвь для приложения SmartHotel360.

    ![Параметры артефактов ](./media/contoso-migration-rebuild/back-pipe7.png) _рис. 33. параметры артефактов._

7. Они выбирают ссылку на задачу.

    ![Ссылка ](./media/contoso-migration-rebuild/back-pipe8.png) _на задачу рис. 34. ссылка на задачу._

8. Они добавляют новую задачу Azure PowerShell, чтобы можно было запускать сценарий PowerShell в среде Azure.

    ![PowerShell в Azure ](./media/contoso-migration-rebuild/back-pipe9.png) _рис. 35. Добавление новой задачи PowerShell._

9. Они выбирают подписку Azure для задачи и выбирают `deploy.ps1` скрипт из репозитория Git.

    ![Запуск сценария ](./media/contoso-migration-rebuild/back-pipe10.png) _рис. 36. Запуск скрипта._

10. Они добавляют аргументы в сценарий. Сценарий удаляет все содержимое кластера (за исключением **входящего трафика** и **контроллера входящего трафика**) и развертывает микрослужбы.

    ![Аргументы сценария ](./media/contoso-migration-rebuild/back-pipe11.png)
     _рис. 37. Добавление аргументов в скрипт._

11. Специалисты настраивают как предпочтительную последнюю версию Azure PowerShell и сохраняют конвейер.

12. Они переходят на страницу **выпуска** и вручную создают новый выпуск.

    ![Новый выпуск ](./media/contoso-migration-rebuild/back-pipe12.png)
     _рис. 38. Создание нового выпуска вручную._

13. Они выбирают созданный выпуск и на вкладке **Действия** щелкают **Развернуть**.

      ![Развертывание выпуска ](./media/contoso-migration-rebuild/back-pipe13.png)
     _. рис. 39. Развертывание выпуска._

14. После завершения развертывания выполните следующую команду, чтобы проверить состояние служб с помощью Azure Cloud Shell: `kubectl get services` .

## <a name="step-3-provision-front-end-services"></a>Шаг 3. Подготовка интерфейсных служб

Администраторам Contoso необходимо развернуть инфраструктуру, которая будет использоваться интерфейсными приложениями. Они создают:

- Контейнер хранилища BLOB-объектов для хранения образов Pet
- База данных Azure Cosmos DB для хранения документов, содержащих сведения об Pet
- API компьютерного зрения для веб-сайта.

В инструкциях для этого раздела используется репозиторий [SmartHotel360-website](https://github.com/microsoft/smartHotel360-website) .

### <a name="create-blob-storage-containers"></a>Создание контейнеров хранилища BLOB-объектов

1. В портал Azure они открывают созданную учетную запись хранения, а затем выбирают **большие двоичные объекты**.
2. Они создают новый контейнер с именем, `Pets` установленным для контейнера с общим доступом. Пользователи отправляют фотографии своих домашних животных в этот контейнер.

    ![Большой двоичный объект хранилища ](./media/contoso-migration-rebuild/blob1.png) _рис. 40. Создание нового контейнера._

3. Они создают второй новый контейнер с именем `settings` . В нем будет размещен файл со всеми параметрами интерфейсного приложения.

    ![Большой двоичный объект хранилища ](./media/contoso-migration-rebuild/blob2.png) _рис. 41. Создание второго контейнера._

4. Они захватывают сведения о доступе для учетной записи хранения в текстовом файле для последующего использования.

    ![Большой двоичный объект хранилища ](./media/contoso-migration-rebuild/blob2.png) _рис. 42. текстовый файл, записывающий сведения о доступе._

### <a name="provision-an-azure-cosmos-db-database"></a>Подготавливает базу данных Azure Cosmos DB

Администраторы Contoso подготавливают Azure Cosmos DBную базу данных для использования с информацией Pet.

1. Они создают базу данных **Azure Cosmos DB** с помощью Azure Marketplace.

    ![Azure Cosmos DB ](./media/contoso-migration-rebuild/cosmos1.png) _рис. 43. Создание базы данных Azure Cosmos DB._

2. Они указывают имя ( `contososmarthotel` ), выберите API SQL и поместите его в рабочую группу ресурсов `ContosoRG` в основном регионе ( `East US 2` ).

    ![Azure Cosmos DB ](./media/contoso-migration-rebuild/cosmos2.png) _рис. 44. Именование базы данных Azure Cosmos DB._

3. Специалисты компании добавляют новую коллекцию в базу данных с емкостью и пропускной способностью по умолчанию.

    ![Azure Cosmos DB ](./media/contoso-migration-rebuild/cosmos3.png) _рис. 45. Добавление новой коллекции в базу данных._

4. Они запомните сведения о соединении для базы данных для последующего использования.

    ![Azure Cosmos DB ](./media/contoso-migration-rebuild/cosmos4.png) _рис. 46. сведения о соединении для базы данных._

### <a name="provision-the-computer-vision-api"></a>Подготавливает API компьютерного зрения

Администраторы Contoso подготавливают API компьютерного зрения. API будет вызываться с помощью функции для оценки изображений, отправленных пользователями.

1. Специалисты компании Contoso создают экземпляр **API компьютерного зрения** в Azure Marketplace.

     ![Компьютерное зрение ](./media/contoso-migration-rebuild/vision1.png) _рис. 47. новый экземпляр в Azure Marketplace._

2. Они подготавливают API ( `smarthotelpets` ) в Рабочей группе ресурсов `ContosoRG` в основном регионе ( `East US 2` ).

    ![Компьютерное зрение ](./media/contoso-migration-rebuild/vision2.png) _рис. 48. Подготовка API в Рабочей группе ресурсов._

3. Специалисты компании сохраняют параметры подключения API в текстовый файл для последующего использования.

     ![Компьютерное зрение ](./media/contoso-migration-rebuild/vision3.png) _рис. 49. Сохранение параметров коннектион'с API._

### <a name="provision-the-azure-web-app"></a>Подготовка веб-приложения Azure

Администраторы Contoso подготавливают веб-приложение с помощью портала Azure.

1. На портале специалисты компании выбирают **Веб-приложение**.

    ![Веб-приложение ](./media/contoso-migration-rebuild/web-app1.png) _рис. 50. Выбор веб-приложения._

2. Они предоставляют имя веб-приложения ( `smarthotelcontoso` ), запускают его в Windows и размещают в Рабочей группе ресурсов `ContosoRG` . Они создают новый экземпляр Application Insights для наблюдения за приложениями.

    ![Имя веб-приложения ](./media/contoso-migration-rebuild/web-app2.png) _рис. 51. имя веб-приложения._

3. После этого они будут просматривать адрес приложения, чтобы убедиться, что оно успешно создано.

4. В портал Azure они создают промежуточный слот для кода. В нем будет развернут конвейер. Это гарантирует, что код не помещается в рабочую среду, пока администраторы выполняют выпуск.

    ![Промежуточный слот веб-приложения ](./media/contoso-migration-rebuild/web-app3.png) _рис. 52. промежуточный слот веб-приложения._

### <a name="provision-the-function-app"></a>Подготавливает приложение функции

В портал Azure администраторы Contoso подготавливают приложение функции.

1. Они щелкают **Приложение-функция**.

    ![Создание приложения-функции ](./media/contoso-migration-rebuild/function-app1.png) _рис. 53. Выбор приложения-функции._

2. Они предоставляют имя для приложения-функции ( `smarthotelpetchecker` ). Они размещают приложение-функцию в Рабочей группе ресурсов ( `ContosoRG` ). Они задают размещение в **плане потребления**и размещают приложение функции в `East US 2` регионе. Новая учетная запись хранения создается вместе с экземпляром Application Insights для мониторинга.

    ![Параметры приложения функции ](./media/contoso-migration-rebuild/function-app2.png) _рис. 54. параметры приложения функции._

3. После развертывания приложения-функции он переходит по его адресу, чтобы убедиться, что он успешно создан.

## <a name="step-4-set-up-the-front-end-pipeline"></a>Шаг 4. Настройка конвейера внешнего интерфейса

Администраторы Contoso создают два различных проекта для сайта внешнего интерфейса.

1. В Azure DevOps они создают проект `SmartHotelFrontend` .

    ![Интерфейсный проект ](./media/contoso-migration-rebuild/function-app1.png) _рис. 55. Проект внешнего интерфейса._

2. Администраторы импортируют репозиторий Git [SmartHotel360 front-end](https://github.com/Microsoft/SmartHotel360-Website) в новый проект.

3. Для приложения-функции они создают другой проект Azure DevOps ( `SmartHotelPetChecker` ) и импортируют репозиторий [петчеккер](https://github.com/sonahander/SmartHotel360-PetCheckerFunction) Git в этот проект.

### <a name="configure-the-web-app"></a>Настройка веб-приложения

Теперь администраторы Contoso настраивают веб-приложение для использования ресурсов Contoso.

1. Они подключаются к проекту Azure DevOps и копируют репозиторий локально на компьютер разработки.
2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.

    ![Файлы репозитория ](./media/contoso-migration-rebuild/configure-webapp1.png) _рис. 56. Просмотр всех файлов в репозитории._

3. Они вносят необходимые изменения конфигурации.

    - При запуске веб-приложение ищет `SettingsUrl` параметр приложения.
    - Данная переменная должна содержать URL-адрес файла конфигурации.
    - По умолчанию используется общедоступная конечная точка.

4. Они обновляют `/config-sample.json/sample.json` файл.

    - Это файл конфигурации веб-приложения при использовании общедоступной конечной точки.
    - Они редактируют `urls` `pets_config` разделы и со значениями для конечных точек API AKS, учетных записей хранения и базы данных Azure Cosmos DB.
    - URL-адреса должны соответствовать DNS-имени нового веб-приложения, которое создает Contoso.
    - Для contoso это `smarthotelcontoso.eastus2.cloudapp.azure.com` .

    ![Параметры JSON ](./media/contoso-migration-rebuild/configure-webapp2.png) _рис. 57. параметры JSON._

5. После обновления файла он переименовывается `smarthotelsettingsurl` и загружается в хранилище BLOB-объектов, которое они создали ранее.

    ![Переименование и загрузка ](./media/contoso-migration-rebuild/configure-webapp3.png) _рис. 58. Переименование и отправка файла._

6. Администраторы выбирают файл, чтобы получить URL-адрес. Этот URL-адрес используется приложением при извлекать файлы конфигурации.

    ![URL-адрес приложения ](./media/contoso-migration-rebuild/configure-webapp4.png) _рис. 59. URL-адрес приложения._

7. В `appsettings.Production.json` файле они обновляют значение на `SettingsURL` URL-адрес нового файла.

    ![URL-адрес обновления ](./media/contoso-migration-rebuild/configure-webapp5.png) _рис. 60. Обновление URL-адреса на новый файл._

### <a name="deploy-the-website-to-azure-app-service"></a>Развертывание веб-сайта в Службе приложений Azure

Администраторы Contoso теперь могут опубликовать веб-сайт.

1. Они открывают Azure DevOps, и в `SmartHotelFrontend` проекте в **сборках и выпусках**они выбирают **+ New конвейер**.
2. Администраторы выбирают **Azure DevOps Git** как источник.
3. Затем они выбирают шаблон **ASP.NET Core**.
4. Они просматривают конвейер и проверяют, что выбран параметр **Публикация веб-проектов** и **ZIP published** .

    ![Параметры конвейера ](./media/contoso-migration-rebuild/vsts-publish-front2.png) _рис. 61. параметры конвейера._

5. В **триггерах**они обеспечивают непрерывную интеграцию и Добавление главной ветви. Это гарантирует, что конвейер сборки будет запускаться каждый раз, когда в решении будет зафиксирован новый код в главной ветви.

    ![Непрерывная интеграция ](./media/contoso-migration-rebuild/vsts-publish-front3.png) _рис. 62. Непрерывная интеграция._

6. Они выбирают **Сохранить и поместить в очередь**, чтобы начать выполнение сборки.
7. После завершения сборки они настраивают конвейер выпуска, используя параметр **Развертывание службы приложений Azure**.
8. Они предоставляют **промежуточное**имя этапа.

    ![Имя окружения ](./media/contoso-migration-rebuild/vsts-publish-front4.png) _рис. 63. Именование среды._

9. Они добавляют артефакт и выбирают сборку, которую они настроили.

    ![Добавление артефакта ](./media/contoso-migration-rebuild/vsts-publish-front5.png) _рис. 64. Добавление артефакта._

10. Они выбирают значок с молнией на артефакте и обеспечивают непрерывное развертывание.

    ![Непрерывное развертывание ](./media/contoso-migration-rebuild/vsts-publish-front6.png)
     _рис. 65. Включение непрерывного развертывания._

11. На вкладке **Среда** они щелкают **1 задание, 1 задача** в разделе **Промежуточный**.
12. После выбора подписки и имени веб-приложения откроется задача **развертывание службы приложений Azure** . Развертывание настроено для использования **промежуточного** слота развертывания. В результате код будет автоматически создан для проверки и утверждения в этом слоте.

     ![Слот ](./media/contoso-migration-rebuild/vsts-publish-front7.png)
     _рис. 66. Использование слота._

13. На вкладке **Конвейер** администраторы добавляют новый этап.

    ![Новая среда ](./media/contoso-migration-rebuild/vsts-publish-front8.png)
     _рис. 67. Добавление нового этапа._

14. Они выбирают **Развертывание службы приложений Azure с помощью слота** и называют среду **Prod**.
15. Они выбирают **1 задание, 2 задачи**, затем выберите подписку, имя службы приложений и **промежуточный** слот.

    ![Имя окружения ](./media/contoso-migration-rebuild/vsts-publish-front10.png)
     _рис. 68. имя среды._

16. Они удаляют этап **развертывания службы приложений Azure в слот** из конвейера. Он был помещен туда на предыдущих шагах.

    ![Удаление из конвейера ](./media/contoso-migration-rebuild/vsts-publish-front11.png)
     _рис. 69. Удаление слота из конвейера._

17. Они сохраняют конвейер. В конвейере администраторы щелкают **Условия после развертывания**.

    ![](./media/contoso-migration-rebuild/vsts-publish-front12.png)
    _Рис. 70 после развертывания: условия, выполняемые после развертывания._

18. Они включают **утверждения после развертывания** и добавляют ведущего разработчика в качестве утверждающего.

    ![Утверждение после развертывания ](./media/contoso-migration-rebuild/vsts-publish-front13.png)
     _рис. 71. Добавление утверждающего._

19. В конвейере сборки они вручную запускают сборку. При этом запускается новый конвейер выпуска, который используется для развертывания сайта в промежуточном слоте. Для Contoso URL-адресом слота является `https://smarthotelcontoso-staging.azurewebsites.net/`.

20. После завершения сборки и развертывания выпуска в слоте Azure DevOps по электронной почте специалисту по разработке на утверждение.

21. Руководитель разработки выбирает **Просмотр утверждения** и может утвердить или отклонить запрос на портале Azure DevOps.

    ![Почта утверждения ](./media/contoso-migration-rebuild/vsts-publish-front14.png)
     _рис. 72. Руководитель-разработчик, утверждающий запрос._

22. Руководитель оставляет комментарий, а затем утверждает. Это запустит обмен **промежуточными** и рабочими **слотами и** переместит сборку в рабочую среду.

    ![Утверждение и замена ](./media/contoso-migration-rebuild/vsts-publish-front15.png)
     _рис. 73. Перемещение сборки в рабочую среду._

23. Конвейер завершает переключение.

    ![Завершение подкачки ](./media/contoso-migration-rebuild/vsts-publish-front16.png)
     _рис. 74. Завершение переключения._

24. Команда проверяет слот **prod**, чтобы убедиться, что веб-приложение находится в рабочей среде по адресу `https://smarthotelcontoso.azurewebsites.net/`.

### <a name="deploy-the-petchecker-function-app"></a>Развертывание приложения функции Петчеккер

Администраторы Contoso развертывают приложение:

1. Они подключаются к проекту Azure DevOps и клонируют репозиторий локально на компьютер разработки.
2. В Visual Studio специалисты компании открывают папку, чтобы просмотреть все файлы в репозитории.
3. Они открывают `src/PetCheckerFunction/local.settings.json` файл и добавляют параметры приложения для хранилища, базы данных Azure Cosmos DB и API компьютерного зрения.

    ![Разверните функцию ](./media/contoso-migration-rebuild/function5.png) _рис. 75. Развертывание функции._

4. Они фиксируют код и синхронизируют его с Azure DevOps, отправляя свои изменения.
5. Они добавляют новый конвейер сборки, а затем выбирают **Azure DevOps Git** для источника.
6. Затем они выбирают шаблон **ASP.NET Core (.NET Framework)**.
7. Администраторы принимают значения по умолчанию для шаблона.
8. В **триггерах**выберите **включить непрерывную интеграцию**, а затем выберите **сохранить & очередь** , чтобы начать сборку.
9. После завершения сборки они создают конвейер выпуска, добавляя **развертывание службы приложений Azure с помощью слота**.
10. Они наименают **рабочую среду**среды, а затем выбирают подписку. В качестве **типа приложения** укажите **приложение-функция** и имя службы приложений в формате `smarthotelpetchecker` .

    ![Приложение функции ](./media/contoso-migration-rebuild/petchecker2.png)
     _рис. 76. приложение функции._

11. Затем они добавляют артефакт **Сборка**.

    ![Добавление артефакта ](./media/contoso-migration-rebuild/petchecker3.png)
     _рис. 77. Добавление артефакта._

12. Они включают **Триггер непрерывного развертывания**, а затем нажмите кнопку **сохранить**.
13. Они щелкают **Поставить новую сборку в очередь** для запуска полного конвейера CI/CD.
14. После развертывания функции она отображается в портал Azure с состоянием **выполняется** .

    ![Обновление состояния функции ](./media/contoso-migration-rebuild/function6.png)
     _рис. 78. Обновление состояния функции._

15. Они просматривают приложение "шашка Pet", чтобы убедиться, что оно работает правильно, по адресу `http://smarthotel360public.azurewebsites.net/pets` .

16. Специалисты компании щелкают аватар, чтобы передать изображение.

    ![Назначение рисунка аватару ](./media/contoso-migration-rebuild/function7.png)
     _79: назначение изображения аватару._

17. Сначала проверяется фотография небольшой собаки.

    ![Проверьте фотографию ](./media/contoso-migration-rebuild/function8.png)
     _Рисунок 80. Проверьте фотографию._

18. Приложение возвращает сообщение о принятии.

    ![Сообщение о принятии сообщения, ](./media/contoso-migration-rebuild/function9.png)
     _рис. 81. сообщение о принятии запроса._

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Компания Contoso должна гарантировать, что их новые базы данных безопасны. [Подробнее](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview).
- Приложение должно быть обновлено для использования SSL с сертификатами. Экземпляр контейнера должен быть повторно развернут для ответа через порт 443.
- Компания Contoso должна рассмотреть возможность использования Key Vault для защиты секретов в своих Service Fabric приложениях. [Подробнее](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-secret-management).

### <a name="backups-and-disaster-recovery"></a>Резервное копирование и аварийное восстановление

- Contoso необходимо проверить [требования к резервному копированию для базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).
- Компания Contoso должна рассмотреть возможность реализации [групп отработки отказа SQL для обеспечения региональной отработки отказа для базы данных](https://docs.microsoft.com/azure/sql-database/sql-database-auto-failover-group).
- Contoso может использовать [георепликацию для SKU реестра контейнеров Azure Premium](https://docs.microsoft.com/azure/container-registry/container-registry-geo-replication).
- Azure Cosmos DB автоматически архивируется. [Здесь](https://docs.microsoft.com/azure/cosmos-db/online-backup-and-restore) можно узнать больше об этом процессе.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](./contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Компания Contoso включит службу [управления затратами Azure и выставления счетов](https://docs.microsoft.com/azure/cost-management-billing/cost-management-billing-overview) для помощи в мониторинге ресурсов Azure и управлении ими.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso перестраивает приложение SmartHotel360 в Azure. Локальная виртуальная машина внешнего приложения перестраивается в веб-приложения службы приложений Azure. Серверная части приложения создается с использованием микрослужб, развернутых в контейнерах, управляемых AKS. Улучшенная функциональность contoso с фотографией приложения Pet.

## <a name="suggested-skills"></a>Предлагаемые навыки

Microsoft Learn — это новый подход к изучению. Готовность к работе с новыми навыками и обязанностями, связанными с внедрением облачных технологий, дается нелегко. Microsoft Learn предоставляет более результативный подход к практическим занятиям, которые помогают быстрее достичь целей. Получайте баллы, проходите уровни и достигайте более высоких результатов.

Ниже приведено несколько примеров настроенных путей обучения на Microsoft Learn, которые соответствуют приложению Contoso SmartHotel360 в Azure.

<!--docsTest:ignore "Azure Cognitive Vision Services" -->

- ** [Развертывание веб-сайта в Azure с помощью службы приложений Azure](https://docs.microsoft.com/learn/paths/deploy-a-website-with-azure-app-service).** Веб-приложения в Azure позволяют легко публиковать веб-сайт и управлять им без необходимости работы с базовыми серверами, хранилищами или сетевыми ресурсами. Вместо этого вы можете сосредоточиться на функционале сайта, положившись на надежную платформу Azure, которая обеспечит безопасный доступ к нему.

- ** [Обработайте и классифицируйте образы с помощью служб "самовидение" Azure](https://docs.microsoft.com/learn/paths/classify-images-with-vision-services):** Azure Cognitive Services предлагает предварительно созданные функции для обеспечения функциональных возможностей компьютерных концепций в приложениях. Узнайте, как использовать службы распознавания концепций для обнаружения лиц, тегов и классификации изображений, а также для идентификации объектов.
