---
title: Повторное размещение приложения путем его переноса на виртуальные машины Azure и SQL Server группы доступности Always On
description: Узнайте, как Contoso перемещает локальное приложение, переносит его на виртуальные машины Azure и SQL Server группы доступности Always On.
author: deltadan
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
ms.custom: think-tank
ms.openlocfilehash: fd499e02dd5a76ed2908a48fa26d96bfa8a7834b
ms.sourcegitcommit: b8f8b7631aabaab28e9705934bf67dad15e3a179
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101787575"
---
<!-- cSpell:ignore WEBVM SQLVM contosohost vcenter contosodc AOAG SQLAOG SQLAOGAVSET contosoadmin contosocloudwitness MSSQLSERVER BEPOOL contosovmsacc SHAOG NSGs inetpub iisreset -->

# <a name="rehost-an-on-premises-application-with-azure-vms-and-sql-server-always-on-availability-groups"></a>Повторное размещение локального приложения с помощью виртуальных машин Azure и SQL Server группы доступности Always On

В этой статье показано, как вымышленная компания Contoso в процессе миграции в Azure повторно размещает двухуровневый приложение Windows .NET, работающее на виртуальных машинах VMware. Компания Contoso переносит клиентскую виртуальную машину приложения на ВИРТУАЛЬную машину Azure и базу данных приложения на другую виртуальную машину Azure с SQL Server, работающей в отказоустойчивом кластере Windows Server с SQL Server группы доступности Always On.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде программного обеспечения с открытым исходным кодом. Если вы хотите использовать его в своих целях тестирования, скачайте его с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Группа специалистов по ИТ тесно работала с бизнес-партнерами, чтобы понять, что они хотят достичь при миграции. Они хотят:

- **Устраните бизнес-рост.** Компания Contoso растет и в итоге найдет давление на локальные системы и инфраструктуру.
- **Повышение эффективности.** Компании Contoso необходимо удалить ненужные процедуры и упростить процессы для разработчиков и пользователей. Бизнес требует, чтобы он был быстрым и не тратит время или деньги, чтобы ускорить выполнение требований клиентов.
- **Повышение гибкости.** ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Он должен реагировать быстрее, чем изменения в Marketplace, чтобы обеспечить успешную работу в глобальной экономике. ИТ-не должныся как или стать заблокированным.
- **Измените.** По мере успешного развития бизнеса компания Contoso должна предоставлять системы, которые увеличиваются в том же темпе.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

- После миграции приложение в Azure должно иметь те же возможности производительности, что и сегодня в VMware. Приложение будет оставаться критически важным в облаке, как и локально.
- Компания Contoso не хочет вкладываться в это приложение. Это важно для бизнеса, но в его текущей форме Contoso просто хочет безопасно переместить его в облако.
- Локальная база данных для приложения имела проблемы с доступностью. Компания Contoso хочет развернуть ее в Azure как высокодоступный кластер с возможностями отработки отказа.
- Компания Contoso хочет перейти с текущей платформы SQL Server 2008 R2 на SQL Server 2017.
- Contoso не хочет использовать базу данных SQL Azure для этого приложения и ищет альтернативы.

## <a name="solution-design"></a>Архитектура решения

После фиксации целей и требований компании Contoso проектирует и изучает решение для развертывания и определяет процесс миграции. Также идентифицируются службы Azure, которые будут использоваться для миграции.

### <a name="current-architecture"></a>Текущая архитектура

- Приложение распределено между двумя виртуальными машинами ( `WEBVM` и `SQLVM` ).
- Виртуальные машины расположены на узле VMware ESXi `contosohost1.contoso.com` (версии 6.5).
- Управление средой VMware осуществляется с vCenter Server 6,5 ( `vcenter.contoso.com` ), которая выполняется на виртуальной машине.
- Contoso имеет локальный центр обработки данных ( `contoso-datacenter` ) с локальным контроллером домена ( `contosodc1` ).

### <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Компания Contoso перенесет внешний интерфейс приложения `WEBVM` в виртуальную машину Azure "инфраструктура как услуга" (IaaS).
  - Клиентская виртуальная машина в Azure будет развернута в `ContosoRG` группе ресурсов (используемой для рабочих ресурсов).
  - Он будет расположен в рабочей сети Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
- База данных приложения будет перенесена на виртуальную машину Azure с SQL Server.
  - Он будет находиться в сети Contoso базы данных Azure ( `PROD-DB-EUS2` ) в основном регионе ( `East US 2` ).
  - Он будет помещен в отказоустойчивый кластер Windows Server с двумя узлами, использующими SQL Server группы доступности Always On.
  - В Azure два SQL Server узлов виртуальных машин в кластере будут развернуты в `ContosoRG` группе ресурсов.
  - Узлы виртуальной машины будут находиться в рабочей сети Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
  - Виртуальные машины будут работать под управлением Windows Server 2016 с SQL Server 2017 Enterprise Edition. Компания Contoso не имеет лицензий для этой операционной системы. Он будет использовать образ в Azure Marketplace, который предоставляет лицензию в соответствии с обязательствами Azure Соглашение Enterprise компании.
  - Помимо уникальных имен обе виртуальные машины используют те же параметры.
- Компания Contoso развернет внутреннюю подсистему балансировки нагрузки, которая прослушивает трафик в кластере и направляет его соответствующему узлу кластера.
  - Внутренняя подсистема балансировки нагрузки будет развернута в `ContosoNetworkingRG` (используется для сетевых ресурсов).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

    ![Снимок экрана, на котором показана схема архитектуры сценария.](./media/contoso-migration-rehost-vm-sql-ag/architecture.png)

### <a name="database-considerations"></a>Рекомендации по базе данных

В ходе проектирования решения специалисты Contoso сравнили функции Базы данных Azure SQL и SQL Server. Следующие рекомендации помогли компании принять решение об использовании виртуальной машины Azure IaaS с SQL Server.

- Использование виртуальной машины Azure, работающей SQL Server, кажется оптимальным решением, если компании Contoso требуется настроить операционную систему или сервер базы данных или разместить и запустить сторонние приложения на одной виртуальной машине.

### <a name="solution-review"></a>Проверка решения

Компания Contoso оценивает предлагаемую конструкцию, помещая вместе со списком достоинств и недостатков.

| Оценка | Сведения |
| --- | --- |
| **Преимущества** | `WEBVM` будет перемещен в Azure без изменений, что делает миграцию простой. <br><br> SQL Server уровень будет выполняться на SQL Server 2017 и Windows Server 2016, который выполнит текущую операционную систему Windows Server 2008 R2. Выполнение SQL Server 2017 поддерживает технические требования и цели компании Contoso. Она обеспечивает совместимость на 100% при переходе от SQL Server 2008 R2. <br><br> Компания Contoso может воспользоваться преимуществами инвестиций в Software Assurance с помощью Преимущество гибридного использования Azure. <br><br> Развертывание SQL Server высокого уровня доступности в Azure обеспечивает отказоустойчивость, поэтому уровень данных приложения больше не является единой точкой отработки отказа. |
| **Недостатки** | `WEBVM` работает под Windows Server 2008 R2. Операционная система поддерживается средой Azure для определенных ролей (июль 2018 г.). Дополнительные сведения см. в статье [Поддержка серверного программного обеспечения Майкрософт для виртуальных машин Azure](/troubleshoot/azure/virtual-machines/server-software-support). <br><br> Веб-уровень приложения остается единой точкой отработки отказа. <br><br> Contoso необходимо продолжить поддержку веб-уровня в качестве виртуальной машины Azure, а не переходить к управляемой службе, такой как служба приложений Azure. <br><br> Если выбрано решение, компании Contoso потребуется продолжить управление двумя SQL Server виртуальными машинами, а не переход на управляемую платформу, например Azure SQL Управляемый экземпляр. Кроме того, в рамках программы Software Assurance Contoso может обмениваться существующими лицензиями на Управляемый экземпляр Azure SQL. |

### <a name="azure-services"></a>Службы Azure

| Служба | Описание | Стоимость |
| --- | --- | --- |
| [Azure Database Migration Service](/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает простой перенос из нескольких источников базы данных в платформы данных Azure с минимальным временем простоя. | Узнайте о [поддерживаемых регионах](/azure/dms/dms-overview#regional-availability) и [ценах на Azure Database Migration Service](https://azure.microsoft.com/pricing/details/database-migration/). |
| [Миграция Azure](/azure/migrate/migrate-services-overview) | Contoso использует службу "миграция Azure" для оценки виртуальных машин VMware. Служба "Миграция Azure" оценивает миграционную пригодность компьютеров. Она обеспечивает оценку размера и стоимости для работы в Azure. | За использование службы "Миграция Azure" не нужно дополнительно платить. На них могут взиматься платежи в зависимости от средств (от поставщика первого или независимого программного обеспечения), которые они решили использовать для оценки и миграции. Дополнительные сведения о [ценах на миграцию Azure](https://azure.microsoft.com/pricing/details/azure-migrate/). |

## <a name="migration-process"></a>Процесс миграции

Администраторы Contoso будут переносить виртуальные машины приложений в Azure.

- Они переносят клиентскую виртуальную машину на виртуальную машину Azure с помощью службы "миграция Azure":
  - В качестве первого шага они подготавливают и настраиваются компоненты Azure и подготавливают локальную инфраструктуру VMware.
  - После завершения подготовки они смогут начать репликацию виртуальных машин.
  - После включения и работы репликации выполняется перенос виртуальной машины с помощью службы "миграция Azure".
- После проверки базы данных она переносит базу данных в кластер SQL Server в Azure с помощью Azure Database Migration Service.
  - В качестве первого шага им потребуется подготавливать SQL Server виртуальные машины в Azure, настроить кластер и внутреннюю подсистему балансировки нагрузки, а также настроить группы доступности Always On.
  - После этого они могут перенести базу данных.
- После миграции он включит группы доступности Always On для базы данных.

    ![Снимок экрана, на котором показана схема процесса миграции.](./media/contoso-migration-rehost-vm-sql-ag/migration-process.png)

## <a name="prerequisites"></a>Предварительные требования

Ниже указано, что необходимо сделать компании Contoso в этом сценарии.

| Требования | Сведения |
| --- | --- |
| **Подписка Azure.** | Компания Contoso уже создала подписку в более ранней статье этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/free/). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку и вы не являетесь администратором, обратитесь к администратору, чтобы назначить вам разрешения владельца или участника. <br><br> |
| **Инфраструктура Azure** | Компания Contoso настраивает инфраструктуру Azure, как описано в статье [Развертывание инфраструктуры Azure для миграции в Contoso](./contoso-migration-infrastructure.md). <br><br> Дополнительные сведения о требованиях к [предварительным](./contoso-migration-devtest-to-iaas.md#prerequisites) требованиям для службы "миграция Azure": миграция сервера. |
| **Локальные серверы** | Локальная vCenter Server должна работать под управлением версии 5,5, 6,0, 6,5 или 6,7. <br><br> Узел ESXi с версией 5,5, 6,0, 6,5 или 6,7. <br><br> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi. |
| **Локальные виртуальные машины** | [Ознакомьтесь со списком виртуальных машин Linux](/azure/virtual-machines/linux/endorsed-distros), которые рекомендованы к использованию в Azure. |

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Подготовка кластера группы доступности SQL Server Always On.** Создание кластера для развертывания двух узлов виртуальных машин SQL Server в Azure.
> - **Шаг 2. Развертывание и настройка кластера.** Подготовьте кластер SQL Server в Azure. Базы данных переносятся в этот имеющийся кластер.
> - **Шаг 3. Развертывание Azure Load Balancer.** Развертывание подсистемы для балансировки трафика на узлы SQL Server.
> - **Шаг 4. Подготовка Azure для миграции Azure.** Создайте учетную запись хранения Azure для хранения реплицированных данных.
> - **Шаг 5. Подготовка локальной среды VMware для службы "миграция Azure".** Подготовка учетных записей для обнаружения виртуальных машин и установки агента. Подготовка локальных виртуальных машин для того, чтобы пользователи могли подключаться к виртуальным машинам Azure после миграции.
> - **Шаг 6. репликация локальных виртуальных машин в Azure.** Включение репликации виртуальных машин в Azure.
> - **Шаг 7. Перенос базы данных с помощью Azure Database Migration Service.** Перенесите базу данных в Azure с помощью Azure Database Migration Service.
> - **Шаг 8. Защита базы данных с помощью SQL Server Always On.** Создание группы доступности AlwaysOn для кластера.
> - **Шаг 9. Перенос виртуальной машины с помощью службы "миграция Azure".** Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов. Затем запустите миграцию в Azure.

## <a name="step-1-prepare-a-sql-server-always-on-availability-group-cluster"></a>Шаг 1. Подготовка кластера группы доступности SQL Server Always On

Чтобы настроить кластер, администраторы Contoso:

1. Создайте две SQL Server виртуальные машины, выбрав SQL Server 2017 корпоративный образ Windows Server 2016 в Azure Marketplace.

    ![Снимок экрана, на котором показан номер SKU виртуальной машины SQL.](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-sku.png)

1. Основные сведения о **мастере создания виртуальных машин**  >  настраивают:

    - Имена виртуальных машин: `SQLAOG1` и `SQLAOG2` .
    - Так как компьютеры являются критически важными для бизнеса, включите SSD для типа диска виртуальной машины.
    - Укажите учетные данные компьютера.
    - Они развертывают виртуальные машины в основном регионе ( `East US 2` ) в `ContosoRG` группе ресурсов.

1. В **размерах** они начинаются с `D2S v3` экземпляров для обеих виртуальных машин. Они будут масштабироваться позже по мере необходимости.
1. В **параметрах** они выполняют следующие действия:

    - Так как эти виртуальные машины являются важными базами данных для приложения, они используют управляемые диски.
    - Они размещают компьютеры в подсети базы данных () `PROD-DB-EUS2` рабочей сети ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
    - Они создают новую группу доступности ( `SQLAOGAVSET` ) с двумя доменами сбоя и пятью доменами обновления.

      ![Снимок экрана, показывающий новую группу доступности.](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-settings.png)

1. В **SQL Server параметров** они ограничивают возможности подключения SQL к виртуальной сети (частной) по умолчанию — порт 1433. Для проверки подлинности они используют те же учетные данные, что используются на месте ( `contosoadmin` ).

    ![Снимок экрана, на котором показаны параметры SQL Server.](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-db.png)

**Требуется дополнительная помощь?**

- Получите помощь в [подготовке SQL Server виртуальной машины](/azure/azure-sql/virtual-machines/windows/create-sql-vm-portal#1-configure-basic-settings).
- Узнайте, как [настроить виртуальные машины для разных номеров sku SQL Server](/azure/azure-sql/virtual-machines/windows/availability-group-manually-configure-prerequisites-tutorial#create-sql-server-vms).

## <a name="step-2-deploy-and-set-up-the-cluster"></a>Шаг 2. Развертывание и настройка кластера

Чтобы настроить кластер, администраторы Contoso:

1. Настройте учетную запись хранения Azure, которая будет использоваться в качестве облачного следящего сервера.
1. Добавьте SQL Server виртуальные машины в домен Active Directory в локальном центре обработки данных Contoso.
1. Создайте кластер в Azure.
1. Настройте облачный свидетель.
1. Включить группы доступности Always On SQL.

### <a name="set-up-a-storage-account-as-a-cloud-witness"></a>Настройка учетной записи хранения в качестве облачного следящего сервера

Чтобы настроить облако-свидетеля, Contoso необходима учетная запись Azure Storage, которая будет содержать файл большого двоичного объекта, используемого для арбитража кластера. Эту же учетную запись можно использовать для настройки облака-свидетеля для нескольких кластеров.

Чтобы создать учетную запись хранения, администраторы Contoso:

1. Укажите понятное имя для учетной записи ( `contosocloudwitness` ).
1. Разверните общую учетную запись с помощью LRS.
1. Поместите учетную запись в третий регион ( `South Central US` ). Они размещаются за пределами основного и дополнительного регионов, чтобы она оставалась доступной во время региональных сбоев.
1. Поместите его в группу ресурсов, содержащую ресурсы инфраструктуры, `ContosoInfraRG` .

    ![Снимок экрана, на котором показано имя учетной записи-свидетеля облака.](./media/contoso-migration-rehost-vm-sql-ag/witness-storage.png)

1. Когда они создают учетную запись хранения, для нее генерируются первичные и вторичные ключи доступа. Им нужен первичный ключ доступа для создания облака-свидетеля. Ключ отображается в имени учетной записи хранения > **ключи доступа**.

    ![Снимок экрана, на котором показан ключ доступа.](./media/contoso-migration-rehost-vm-sql-ag/access-key.png)

<!-- docutune:casing "Failover Cluster feature" -->

### <a name="add-sql-server-vms-to-contoso-domain"></a>Добавление виртуальных машин SQL Server в домене Contoso

1. Contoso добавляет `SQLAOG1` и `SQLAOG2` в `contoso.com` домен.
1. На каждой виртуальной машине администраторы устанавливают компонент и средства отказоустойчивого кластера Windows.

### <a name="set-up-the-cluster"></a>Настройка кластера

Прежде чем администраторы Contoso настроили кластер, они получают моментальный снимок диска операционной системы на каждом компьютере.

![Снимок экрана, на котором показана панель создания моментального снимка.](./media/contoso-migration-rehost-vm-sql-ag/snapshot.png)

1. Они запускают скрипт для создания отказоустойчивого кластера Windows.

    ![Снимок экрана, на котором показан сценарий для создания отказоустойчивого кластера Windows.](./media/contoso-migration-rehost-vm-sql-ag/create-cluster1.png)

1. После создания кластера они проверяют, отображаются ли виртуальные машины в виде узлов кластера.

     ![Снимок экрана, на котором показаны кластеры.](./media/contoso-migration-rehost-vm-sql-ag/create-cluster2.png)

<!-- docsTest:casing "Failover Cluster Manager" -->

### <a name="configure-the-cloud-witness"></a>Настройка облака-свидетеля.

1. Администраторы Contoso настраивают облако-свидетель с помощью **мастера настройки кворума** в Диспетчер отказоустойчивости кластеров.
1. В мастере они выбирают создание облачного следящего сервера с учетной записью хранения.
1. После настройки облака-свидетеля оно появится в оснастка диспетчера отказоустойчивости кластеров.

    ![Снимок экрана, на котором показана настройка облака-свидетеля.](./media/contoso-migration-rehost-vm-sql-ag/cloud-witness.png)

### <a name="enable-sql-server-always-on-availability-groups"></a>Включение групп доступности AlwaysOn SQL Server

Теперь администраторы Contoso могут включить группы доступности Always On:

1. В диспетчере конфигурации SQL Server они включают функцию **Группы доступности AlwaysOn** для службы **SQL Server (MSSQLSERVER)**.

    ![Снимок экрана, на котором показан флажок "включить Always On группы доступности".](./media/contoso-migration-rehost-vm-sql-ag/enable-always-on.png)

1. Они перезагружают службу, чтобы изменения вступили в силу.

После включения группы доступности Always On Contoso может настроить Always On группу доступности, которая будет защищать базу данных SmartHotel360.

**Требуется дополнительная помощь?**

- Узнайте о [облачном свидетеле и настройке учетной записи хранения](/windows-server/failover-clustering/deploy-cloud-witness).

- Получите инструкции по [настройке кластера и созданию группы доступности](/azure/azure-sql/virtual-machines/windows/availability-group-manually-configure-tutorial).

## <a name="step-3-deploy-azure-load-balancer"></a>Шаг 3. Развертывание Azure Load Balancer

Администраторам Contoso теперь требуется развернуть внутренний балансировщик нагрузки, расположенный перед узлами кластера. Балансировщик нагрузки прослушивает трафик и направляет его соответствующему узлу.

![Схема, показывающая балансировку нагрузки.](./media/contoso-migration-rehost-vm-sql-ag/architecture-lb.png)

Чтобы создать подсистему балансировки нагрузки, администраторы Contoso:

1. В портал Azure перейдите к   >  **подсистеме балансировки сетевой нагрузки** и настройте новую внутреннюю подсистему балансировки нагрузки: `ILB-PROD-DB-EUS2-SQLAOG` .
1. Поместите подсистему балансировки нагрузки в подсеть базы данных ( `PROD-DB-EUS2` ) рабочей сети ( `VNET-PROD-EUS2` ).
1. Назначьте ему статический IP-адрес ( `10.245.40.100` ).
1. В качестве элемента сети разверните подсистему балансировки нагрузки в группе ресурсов сети `ContosoNetworkingRG` .

    ![Снимок экрана, на котором показана панель создания балансировщика нагрузки.](./media/contoso-migration-rehost-vm-sql-ag/lb-create.png)

После развертывания внутренней подсистемы балансировки нагрузки администраторы Contoso должны настроить ее. Они создают пул внутренних адресов, настраивают проверку работоспособности и настраивают правило балансировки нагрузки.

### <a name="add-a-back-end-pool"></a>Добавление внутреннего пула

Чтобы распределить трафик между виртуальными машинами в кластере, администраторы Contoso настроили пул внутренних адресов, содержащий IP-адреса сетевых карт для виртуальных машин, которые будут принимать сетевой трафик от балансировщика нагрузки.

1. В параметрах подсистемы балансировки нагрузки на портале Contoso добавляет пул серверной части: `ILB-PROD-DB-EUS-SQLAOG-BEPOOL` .
1. Администраторы связывают пул с группой доступности `SQLAOGAVSET` . Виртуальные машины в наборе ( `SQLAOG1` и `SQLAOG2` ) добавляются в пул.

    ![Снимок экрана, на котором показан экран добавления серверного пула.](./media/contoso-migration-rehost-vm-sql-ag/backend-pool.png)

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Администраторы Contoso создают проверку работоспособности, чтобы подсистема балансировки нагрузки могла отслеживать работоспособность приложения. Проба динамически добавляет или удаляет виртуальные машины из вращения балансировщика нагрузки в зависимости от того, как они реагируют на проверки работоспособности.

Для создания пробы администраторы Contoso:

1. В параметрах подсистемы балансировки нагрузки на портале создайте зонд работоспособности: **склалвайсонендпоинтпробе**.
1. Настройте зонд для мониторинга виртуальных машин через TCP-порт 59999.
1. Задайте интервал в 5 секунд между зондами и пороговое значение 2. При сбое двух проб виртуальная машина будет считаться неработоспособной.

    ![Снимок экрана, на котором показан экран "Добавление пробы работоспособности".](./media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

### <a name="configure-the-load-balancer-to-receive-traffic"></a>Настройка распределителя нагрузки для приема трафика

Теперь администраторы Contoso настроили правило подсистемы балансировки нагрузки, чтобы определить, как трафик будет распространяться на виртуальные машины.

- Интерфейсный IP-адрес обрабатывает входящий трафик.
- Серверный IP-пул получает трафик.

Чтобы создать правило, администраторы Contoso:

1. В параметрах подсистемы балансировки нагрузки на портале добавьте новое правило: `SQLAlwaysOnEndPointListener` .
1. Настройте интерфейсный прослушиватель для получения входящего трафика клиента SQL через TCP-порт 1433.
1. Укажите серверный пул, на который будет маршрутизироваться трафик, и порт, на котором виртуальные машины прослушивают трафик.
1. Включите плавающий IP-адрес (прямой возврат к серверу), который всегда требуется для SQL Server Always On.

    ![Снимок экрана, на котором показаны параметры проверки работоспособности.](./media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

**Требуется дополнительная помощь?**

- Ознакомьтесь с обзором [Azure Load Balancer](/azure/load-balancer/load-balancer-overview).
- Узнайте [, как создать подсистему балансировки нагрузки](/azure/load-balancer/quickstart-load-balancer-standard-internal-portal).

## <a name="step-4-prepare-azure-for-azure-migrate"></a>Шаг 4. Подготовка Azure для миграции Azure

Ниже приведены компоненты Azure Contoso, необходимые для развертывания службы "миграция Azure".

- Виртуальная сеть, в которой будут находиться виртуальные машины при миграции.
- Учетная запись хранения Azure для хранения реплицированных данных.

Администраторы Contoso настроили эти компоненты:

1. Компания Contoso уже создала сеть или подсеть, которую можно использовать для миграции Azure при [развертывании инфраструктуры Azure](./contoso-migration-rehost-vm-sql-ag.md).

    - Приложение SmartHotel360 — это рабочее приложение, `WEBVM` которое будет перенесено в рабочую сеть Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
    - `WEBVM` будет помещен в `ContosoRG` группу ресурсов, которая используется для рабочих ресурсов и в рабочей подсети ( `PROD-FE-EUS2` ).

1. Администраторы Contoso создают учетную запись хранения Azure ( `contosovmsacc20180528` ) в основном регионе.

    - Используйте учетную запись общего назначения со стандартным хранилищем и репликацией LRS.

## <a name="step-5-prepare-on-premises-vmware-for-azure-migrate"></a>Шаг 5. Подготовка локальной среды VMware для миграции Azure

Вот как администраторы Contoso подготавливаются в локальной среде:

- Учетная запись на узле vCenter Server или vSphere ESXi для автоматизации обнаружения виртуальных машин.
- Локальные параметры виртуальной машины, чтобы компания Contoso могла подключаться к реплицированной виртуальной машине Azure после миграции.

### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Службе "миграция Azure" требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины.
- Управление репликацией и миграцией.
- Требуется по крайней мере учетная запись только для чтения. Им необходима учетная запись, которая может выполнять такие операции, как создание и удаление дисков и включение виртуальных машин.

Чтобы настроить учетную запись, администраторы Contoso:

1. Создайте роль на уровне vCenter.
1. Назначьте этой роли необходимые разрешения.

### <a name="prepare-to-connect-to-azure-vms-after-migration"></a>Подготовка к подключению к виртуальным машинам Azure после миграции

После миграции компания Contoso хочет подключиться к виртуальным машинам Azure и разрешить Azure управлять виртуальными машинами. Для этого перед миграцией администраторы Contoso выполняют следующие задачи:

1. Для доступа через Интернет они делают следующее.

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Проверяют, добавлены ли правила TCP и UDP для профиля **Общедоступный**.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.

1. Для доступа через VPN типа "сеть — сеть":

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.
    - Для Windows задайте для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

1. Установите агент для Azure:

    - [Агент Linux для Azure](/azure/virtual-machines/extensions/agent-linux)
    - [Агент Azure для Windows](/azure/virtual-machines/extensions/agent-windows)

1. Прочее

   - Для Windows на виртуальной машине не должно быть ожидающих обновлений Windows при активации миграции. Если это так, администраторы Contoso не смогут войти в виртуальную машину до завершения обновления.
   - После миграции они могут проверить **диагностику загрузки** , чтобы просмотреть снимок экрана виртуальной машины. Если она не работает, убедитесь, что виртуальная машина запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

**Требуется дополнительная помощь?**

Узнайте, как [подготовить виртуальные машины для миграции](/azure/migrate/prepare-for-migration).

## <a name="step-6-replicate-the-on-premises-vms-to-azure"></a>Шаг 6. репликация локальных виртуальных машин в Azure

Прежде чем администраторы Contoso смогут выполнить миграцию в Azure, необходимо настроить и включить репликацию.

После завершения обнаружения они могут начать репликацию виртуальных машин VMware в Azure.

1. В проекте службы "миграция Azure" они переходят в раздел **серверы**  >  **Миграция Azure: миграция сервера** и выберите **репликация**.

    ![Снимок экрана, на котором показан параметр репликации.](./media/contoso-migration-rehost-vm/select-replicate.png)

1. В разделе  >  "Параметры репликации **исходных файлов**  >  "**— виртуальные машины?** они выбирают **"Да" с VMware vSphere**.

1. В **локальном устройстве** они выбирают имя настроенного устройства "миграция Azure", а затем нажмите кнопку **ОК**.

    ![Снимок экрана, на котором показана вкладка "Параметры источника".](./media/contoso-migration-rehost-vm/source-settings.png)

1. На **виртуальных машинах** они выбирают компьютеры для репликации.
    - Если администраторы Contoso выполняют оценку виртуальных машин, они могут применять рекомендации по выбору размера виртуальных машин и типов дисков (Premium или Standard) в результатах оценки. В разделе **Импорт параметров миграции из оценки миграции Azure** выберите параметр **Да** .
    - Если они не выполняли оценку или не хотят использовать параметры оценки, они выбирают параметр **нет** .
    - Если выбрано использование оценки, они выбирают группу виртуальных машин и имя оценки.

    ![Снимок экрана, показывающий выбор оценок.](./media/contoso-migration-rehost-vm/select-assessment.png)

1. На **виртуальных машинах** они выполняют поиск виртуальных машин по мере необходимости и проверяют каждую виртуальную машину для миграции. Затем выберите пункт **Далее: целевые параметры**.

1. В **параметрах целевого объекта** выберите подписку и целевой регион, в которые они будут перенесены, и укажите группу ресурсов, в которой будут размещаться виртуальные машины Azure после миграции. В **виртуальной сети** они выбирают виртуальную сеть или подсеть Azure, к которой будут присоединены виртуальные машины Azure после миграции.

1. В **преимущество гибридного использования Azure** администраторы Contoso:

    - Выберите **нет** , если они не нужно применять преимущество гибридного использования Azure. Затем нажмите кнопку **Далее**.
    - Выберите **Да** , если у них есть компьютеры Windows Server, на которых включены активные программы Software Assurance или подписки Windows Server, и они хотят применить преимущества к компьютерам, которые они переносят. Затем нажмите кнопку **Далее**.

1. В области **вычислений** они просматривают имя виртуальной машины, размер, тип диска ОС и группу доступности. Виртуальные машины должны соответствовать [требованиям Azure](/azure/migrate/migrate-support-matrix-vmware#vmware-requirements).

    - **Размер виртуальной машины:** Если они используют рекомендации по оценке, раскрывающийся список размер виртуальной машины содержит рекомендуемый размер. В противном случае служба "миграция Azure" выбирает размер на основе ближайшей соответствия в подписке Azure. Кроме того, они могут выбрать размер вручную в **виртуальной машине Azure.**
    - **Диск ОС:** Они указывают диск операционной системы (загрузочный) для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком.
    - **Группа доступности:** Если после миграции виртуальная машина должна находиться в группе доступности Azure, укажите набор. Набор должен находиться в Целевой группе ресурсов, указанной для миграции.

1. На **дисках** они указывают, следует ли реплицировать диски виртуальной машины в Azure. Затем они выбирают тип диска (Стандартный диск SSD/HDD или управляемые диски уровня "Премиум") в Azure и нажмите кнопку **Далее**.
    - Они могут исключать диски из репликации.
    - Если диски исключены, они не будут присутствовать на виртуальной машине Azure после миграции.

1. На странице **Проверка и запуск репликации** проверьте параметры. Затем они выбирают **репликацию** , чтобы запустить начальную репликацию для серверов.

> [!NOTE]
> Параметры репликации можно обновить в любое время, прежде чем репликация начнется в **управлении**  >  **реплицируемыми компьютерами**. Настройки невозможно изменить после начала репликации.

## <a name="step-7-migrate-the-database-via-azure-database-migration-service"></a>Шаг 7. Перенос базы данных с помощью Azure Database Migration Service

Администраторы Contoso переходят базу данных с помощью Azure Database Migration Service, выполнив пошаговое [руководство по миграции](/azure/dms/tutorial-sql-server-to-azure-sql). Они могут выполнять интерактивные, автономные и гибридные (предварительные) миграции.

В качестве сводки они должны выполнять следующие задачи:

- Используйте ценовую категорию "Премиум", чтобы создать экземпляр Azure Database Migration Service, который подключается к виртуальной сети.
- Убедитесь, что экземпляр может получить доступ к удаленным SQL Server через виртуальную сеть. Убедитесь, что все входящие порты разрешены в Azure для SQL Server на уровне виртуальной сети, в сети VPN и на компьютере, на котором размещается SQL Server.
- Настройте экземпляр:
  - создание проекта миграции;
  - Добавьте источник (локальная база данных).
  - Выберите целевой объект.
  - Выберите базы данных для миграции.
  - Настройка дополнительных параметров.
  - Запустите репликацию.
  - Устраните возможные ошибки.
  - Выполните окончательный прямую миграцию.

## <a name="step-8-protect-the-database-with-sql-server-always-on"></a>Шаг 8. Защита базы данных с помощью SQL Server Always On

Теперь, когда база данных приложения работает в `SQLAOG1` , администраторы Contoso могут защитить ее с помощью группы доступности Always on. Они настраивают SQL Server Always On с помощью SQL Server Management Studio, а затем назначают прослушиватель с помощью кластеризации Windows.

### <a name="create-an-always-on-availability-group"></a>Создание группы доступности AlwaysOn

1. В SQL Server Management Studio они выбирают и сохраняют (или щелкают правой кнопкой мыши) **Always on высокий уровень доступности** для запуска **мастера создания групп доступности**.
1. В поле **Параметры укажите** имя группы доступности `SHAOG` . В окне **Выбор баз данных** они выбирают `SmartHotel360` базу данных.

    ![Снимок экрана, на котором показана панель "Выбор баз данных".](./media/contoso-migration-rehost-vm-sql-ag/aog-1.png)

1. В поле **Укажите реплики** они добавляют два узла SQL в качестве реплик доступности и настраивают их для обеспечения автоматической отработки отказа с помощью синхронной фиксации.

     ![Снимок экрана, на котором показана вкладка "реплики".](./media/contoso-migration-rehost-vm-sql-ag/aog-2.png)

1. Они настраивают прослушиватель для группы ( `SHAOG` ) и порта. IP-адрес внутренней подсистемы балансировки нагрузки добавляется как статический IP-адрес ( `10.245.40.100` ).

    ![Снимок экрана, на котором показан параметр "создать прослушиватель группы доступности".](./media/contoso-migration-rehost-vm-sql-ag/aog-3.png)

1. В **Выбор синхронизации данных**, они включают автоматическое заполнение. При использовании этого параметра SQL Server автоматически создает вторичные реплики для каждой базы данных в группе, поэтому Contoso не придется вручную выполнять резервное копирование и восстановление. После проверки создается группа доступности.

    ![Снимок экрана, на котором показана группа доступности Always On.](./media/contoso-migration-rehost-vm-sql-ag/aog-4.png)

1. У Contoso возникли проблемы при создании группы. Он не использует Active Directory встроенной безопасности Windows и должен предоставлять разрешения имени входа SQL для создания ролей отказоустойчивого кластера Windows.

    ![Снимок экрана, показывающий предоставление разрешений имени входа SQL.](./media/contoso-migration-rehost-vm-sql-ag/aog-5.png)

1. После создания группы она появится в SQL Server Management Studio.

### <a name="configure-a-listener-on-the-cluster"></a>Настройка прослушивателя в кластере

В качестве последнего шага при настройке развертывания SQL администраторы Contoso настраивают внутреннюю подсистему балансировки нагрузки в качестве прослушивателя в кластере и переносят прослушиватель в режим «в сети». Для выполнения этой задачи используются сценарии.

![Снимок экрана, на котором показан прослушиватель кластера.](./media/contoso-migration-rehost-vm-sql-ag/cluster-listener.png)

### <a name="verify-the-configuration"></a>Проверка конфигурации

Теперь, когда все настроено, у компании Contoso есть действующая группа доступности в Azure, использующая перенесенную базу данных. Администраторы проверяют конфигурацию, подключившись к внутренней подсистеме балансировки нагрузки в SQL Server Management Studio.

![Снимок экрана, на котором показано соединение внутреннего балансировщика нагрузки.](./media/contoso-migration-rehost-vm-sql-ag/ilb-connect.png)

**Требуется дополнительная помощь?**

- Узнайте, как создать [группу доступности](/azure/azure-sql/virtual-machines/windows/availability-group-manually-configure-tutorial#create-the-availability-group) и [прослушиватель](/azure/azure-sql/virtual-machines/windows/availability-group-manually-configure-tutorial#configure-listener).
- [Настройка использования IP-адреса балансировщика нагрузки для кластера](/azure/azure-sql/virtual-machines/windows/availability-group-load-balancer-portal-configure#configure-the-cluster-to-use-the-load-balancer-ip-address) вручную.
- Дополнительные сведения о [создании и использовании SAS](/azure/storage/common/storage-sas-overview).

## <a name="step-9-migrate-the-vm-with-azure-migrate"></a>Шаг 9. Миграция виртуальной машины с помощью службы "миграция Azure"

Администраторы Contoso выполняют быструю тестовую отработку отказа, а затем переносят виртуальную машину.

### <a name="run-a-test-migration"></a>Выполнение тестовой миграции

Выполнение тестовой миграции позволяет убедиться, что все работает правильно перед миграцией. Администраторы Contoso:

1. Выполните тестовую отработку отказа на последнюю доступную точку во времени ( `Latest processed` ).
1. Выберите **завершить работу компьютера перед отработкой отказа** , чтобы служба Azure Migrate попыталась завершить работу исходной виртуальной машины перед активацией отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить.
1. Тестовая отработка отказа выполняется:

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - обрабатываются данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе этих данных создается точка восстановления;
    - Виртуальная машина Azure создается с использованием данных, обработанных на предыдущем шаге.

1. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Специалисты убеждаются, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
1. После проверки они выполняют очистку отработки отказа, а также записывают и сохраняют все наблюдения.

### <a name="run-a-failover"></a>Запуск отработки отказа

1. Убедившись, что тестовая отработка отказа работала должным образом, он создает план восстановления для миграции и добавляет его `WEBVM` в план.

     ![Снимок экрана, показывающий создание плана восстановления](./media/contoso-migration-rehost-vm-sql-ag/recovery-plan.png)

1. Специалисты компании выполняют для этого плана отработку отказа. Они выбирают последнюю точку восстановления. Они указывают, что служба "миграция Azure" должна попытаться завершить работу локальной виртуальной машины перед активацией отработки отказа.

    ![Снимок экрана, на котором показана панель отработки отказа.](./media/contoso-migration-rehost-vm-sql-ag/failover1.png)

1. После отработки отказа специалисты компании проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![Снимок экрана, на котором показана область обзора виртуальной машины.](./media/contoso-migration-rehost-vm-sql-ag/failover2.png)

1. После проверки виртуальной машины в Azure они завершат миграцию, чтобы завершить процесс миграции, приостановили репликацию для виртуальной машины и приостановили выставление счетов на миграцию Azure для виртуальной машины.

    ![Снимок экрана, на котором показан полный элемент миграции.](./media/contoso-migration-rehost-vm-sql-ag/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

В качестве последнего шага процесса миграции администраторы Contoso обновляют строку подключения приложения, чтобы она указывала на перенесенную базу данных, работающую на `SHAOG` прослушивателе. Эта конфигурация будет изменена на `WEBVM` компьютере, работающем в Azure. Эта конфигурация находится в `web.config` приложении ASP.NET.

1. Администраторы Contoso находят файл по адресу `C:\inetpub\SmartHotelWeb\web.config` и изменить имя сервера, чтобы оно отражало полное доменное имя группы доступности Always On: `shaog.contoso.com` .

    ![Снимок экрана, на котором показано полное доменное имя группы доступности Always On.](./media/contoso-migration-rehost-vm-sql-ag/failover4.png)

1. После обновления файла и его сохранения перезапускаются службы IIS `WEBVM` . Они используют `iisreset /restart` из командной строки.
1. После перезапуска IIS приложение будет использовать базу данных, запущенную на управляемом экземпляре.

**Требуется дополнительная помощь?**

- Узнайте, как [выполнить тестовую отработку отказа](/azure/site-recovery/tutorial-dr-drill-azure).
- Узнайте, как [создать план восстановления](/azure/site-recovery/site-recovery-create-recovery-plans).
- Сведения об [отработки отказа в Azure](/azure/site-recovery/site-recovery-failover).

### <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции приложение SmartHotel360 работает на виртуальной машине Azure. База данных SmartHotel360 находится в кластере SQL Server в Azure.

Теперь Contoso необходимо завершить следующие шаги очистки:

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновить внутренние документы и отразить в них новое расположение и IP-адреса виртуальных машин.
- Просмотреть все ресурсы, которые взаимодействуют с выведенными из эксплуатации виртуальными машинами. Обновить все соответствующие параметры или документы согласно новой конфигурации.
- Добавьте две новые виртуальные машины ( `SQLAOG1` и `SQLAOG2` ) в системы мониторинга рабочей среды.

### <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Группа безопасности Contoso рассматривает виртуальные машины `WEBVM` , `SQLAOG1` а `SQLAOG2` также определяет проблемы безопасности. Они должны:

- Проверьте группы безопасности сети (группы безопасности сети) для виртуальной машины, чтобы управлять доступом. NSG позволяют пропускать только разрешенный для приложения трафик.
- Рассмотрите возможность защиты данных на диске с помощью шифрования дисков Azure и Azure Key Vault.
- Оцените прозрачное шифрование данных. Затем включите его в базе данных SmartHotel360, работающей в новой группе доступности Always On. Дополнительные сведения о [прозрачном шифровании данных](/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017).

Дополнительные сведения см. в статье рекомендации [по обеспечению безопасности для рабочих нагрузок IaaS в Azure](/azure/security/fundamentals/iaas).

## <a name="business-continuity-and-disaster-recovery"></a>Непрерывность бизнес-процессов и аварийное восстановление

Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление, специалисты компании Contoso выполняют указанные ниже действия.

- Для защиты данных компания Contoso создает резервные копии данных на `WEBVM` `SQLAOG1` `SQLAOG2` виртуальных машинах, и с помощью [резервного копирования виртуальных машин Azure](/azure/backup/backup-azure-vms-introduction).
- Contoso также узнает, как использовать службу хранилища Azure для резервного копирования SQL Server непосредственно в хранилище BLOB-объектов Azure. Узнайте больше о том, как [использовать службу хранилища Azure для SQL Server резервного копирования и восстановления](/azure/azure-sql/virtual-machines/windows/azure-storage-sql-server-backup-restore-use).
- Чтобы приложения продолжали работать, компания Contoso реплицирует виртуальные машины приложений в Azure в дополнительный регион с помощью Site Recovery. Узнайте больше о [настройке аварийного восстановления в дополнительном регионе Azure для виртуальной машины Azure](/azure/site-recovery/azure-to-azure-quickstart).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- Компания Contoso обладает лицензией на лицензирование `WEBVM` и будет использовать преимущества преимущество гибридного использования Azure. Contoso преобразует имеющиеся виртуальные машины Azure, чтобы использовать льготные расценки.
- Contoso будет использовать службу [управления затратами Azure и выставления счетов](/azure/cost-management-billing/cost-management-billing-overview) , чтобы гарантировать, что компания останется в бюджете, установленном ИТ – лидером.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso повторно размещает приложение SmartHotel360 в Azure, переключая клиентскую виртуальную машину приложения в Azure с помощью функции миграции Azure. Компания Contoso перенеса базу данных приложений в кластер SQL Server, подготовленный в Azure, используя Azure Database Migration Service и защитил его в группе доступности SQL Server Always On.
