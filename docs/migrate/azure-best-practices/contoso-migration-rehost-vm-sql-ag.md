---
title: Повторное размещение приложения путем его переноса на виртуальные машины Azure и SQL Server групп доступности Always-on
description: Узнайте, как компания Contoso повторно размещает локальное приложение, перемещая его на виртуальные машины Azure и в группы доступности SQL Server AlwaysOn
author: deltadan
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 5bb7edc6b44f12e4fd463f20ec70b735f4035249
ms.sourcegitcommit: bcc73d194c6d00c16ae2e3c7fb2453ac7dbf2526
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86192085"
---
<!-- cSpell:ignore WEBVM SQLVM contosohost vcenter contosodc AOAG SQLAOG SQLAOGAVSET contosoadmin contosocloudwitness MSSQLSERVER BEPOOL contosovmsacc SHAOG NSGs inetpub iisreset -->

# <a name="rehost-an-on-premises-application-with-azure-vms-and-sql-server-always-on-availability-groups"></a>Повторное размещение локального приложения с помощью виртуальных машин Azure и SQL Server группы доступности Always On

В этой статье показано, как вымышленная компания Contoso в процессе миграции в Azure повторно размещает двухуровневый приложение Windows .NET, работающее на виртуальных машинах VMware. Contoso переносит клиентскую виртуальную машину приложения на ВИРТУАЛЬную машину Azure и базу данных приложения на ВИРТУАЛЬную машину Azure SQL Server, работающую в отказоустойчивом кластере Windows Server с SQL Server группы доступности Always On.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.

- **Повышение эффективности.** Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.

- **Повышение гибкости.** ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования. Он не должен становиться помехой для бизнеса.

- **Измените.** По мере успешного роста бизнеса ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

- После миграции приложение в Azure должно иметь те же возможности производительности, что и сегодня в VMware. Приложение будет оставаться критически важным в облаке, как и локально.

- Компания Contoso не хочет вкладываться в это приложение. Оно важно для бизнеса, но компании Contoso просто нужно безопасно переместить его в облако в его текущей форме.

- Локальная база данных для приложения имела проблемы с доступностью. Специалисты Contoso хотели бы развернуть ее в Azure в качестве кластера с высокой степенью доступности и возможностью отработки отказа.

- Компания Contoso планирует провести обновление текущей платформы SQL Server 2008 R2 до SQL Server 2017.

- Contoso не хочет использовать базу данных SQL Azure для этого приложения и ищет альтернативы.

## <a name="solution-design"></a>Архитектура решения

Определив свои цели и требования, специалисты компании Contoso начинают разработку и анализ решения для развертывания и планируют процесс миграции, включая службы Azure, которые будут использоваться в ходе этой миграции.

### <a name="current-architecture"></a>Текущая архитектура

- Приложение распределено между двумя виртуальными машинами ( `WEBVM` и `SQLVM` ).
- Виртуальные машины расположены на узле VMware ESXi `contosohost1.contoso.com` (версии 6.5).
- Среда VMware находится под управлением сервера vCenter Server 6.5 (`vcenter.contoso.com`), запущенного на виртуальной машине.
- Компания Contoso использует локальный центр обработки данных (`contoso-datacenter`) с локальным контроллером домена (`contosodc1`).

### <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Компания Contoso перенесет внешний интерфейс приложения `WEBVM` на виртуальную машину Azure IaaS.
  - Клиентская виртуальная машина в Azure будет развернута в `ContosoRG` группе ресурсов (используемой для рабочих ресурсов).
  - Он будет расположен в рабочей сети Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
- База данных приложения будет перенесена на виртуальную машину Azure SQL Server.
  - Он будет находиться в сети Contoso базы данных Azure ( `PROD-DB-EUS2` ) в основном регионе ( `East US 2` ).
  - Она будет помещена в отказоустойчивый кластер Windows Server с двумя узлами, использующий группы доступности SQL Server AlwaysOn.
  - В Azure два SQL Server узлов виртуальных машин в кластере будут развернуты в `ContosoRG` группе ресурсов.
  - Узлы виртуальной машины будут находиться в рабочей сети Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
  - Виртуальные машины будут работать под управлением Windows Server 2016 с SQL Server 2017 Enterprise Edition. У Contoso нет лицензий для этой операционной системы, поэтому специалисты компании будут использовать образ из Azure Marketplace, предоставляющий лицензию в качестве платежа для своих обязательств Azure EA.
  - Помимо уникальных имен обе виртуальные машины используют те же параметры.
- Компания Contoso развернет внутреннюю подсистему балансировки нагрузки, которая прослушивает трафик в кластере, и направляет ее на соответствующий узел кластера.
  - Внутренняя подсистема балансировки нагрузки будет развернута в `ContosoNetworkingRG` (используется для сетевых ресурсов).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

    ![Архитектура сценария](./media/contoso-migration-rehost-vm-sql-ag/architecture.png)

### <a name="database-considerations"></a>Рекомендации по базе данных

В ходе проектирования решения специалисты Contoso сравнили функции Базы данных Azure SQL и SQL Server. Следующие рекомендации помогли вам решить, как использовать виртуальную машину Azure IaaS с SQL Server.

- Использование виртуальной машины Azure, работающей SQL Server, кажется оптимальным решением, если компании Contoso требуется настроить операционную систему или сервер базы данных или разместить и запустить сторонние приложения на одной виртуальной машине.

### <a name="solution-review"></a>Проверка решения

Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

| Рассматриваемый вопрос | Сведения |
| --- | --- |
| **Преимущества** | `WEBVM`будут перемещены в Azure без изменений, что сделает миграцию простой. <br><br> Уровень SQL Server будет работать под управлением SQL Server 2017 и Windows Server 2016. Это позволяет прекратить использование операционной системы Windows Server 2008 R2, а SQL Server 2017 соответствует техническим требованиям и целям компании Contoso. Обеспечивается 100-процентная совместимость, и в то же время прекращается использование SQL Server 2008 R2. <br><br> Contoso может воспользоваться преимуществами своих инвестиций в программу Software Assurance, используя Преимущество гибридного использования Azure. <br><br> Развертывание SQL Server высокой доступности в Azure обеспечивает отказоустойчивость, поэтому уровень данных приложения больше не является единой точкой отработки отказа. |
| **Недостатки** | `WEBVM`работает под Windows Server 2008 R2. Операционная система поддерживается средой Azure для определенных ролей (июль 2018 г.). [Подробнее](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines). <br><br> Веб-уровень приложения остается единой точкой отработки отказа. <br><br> Contoso необходимо продолжить поддержку веб-уровня в качестве виртуальной машины Azure, а не переходить к управляемой службе, такой как служба приложений Azure. <br><br> С помощью выбранного решения компании Contoso потребуется и дальше управлять двумя виртуальными машинами SQL Server, а не переходить на управляемую платформу, такую как Управляемый экземпляр SQL Azure. Кроме того, в рамках программы Software Assurance компания Contoso может обменять свои имеющиеся лицензии на сниженные тарифы при использовании Управляемого экземпляра SQL Azure. |

### <a name="azure-services"></a>Службы Azure

| Служба | Описание | Стоимость |
| --- | --- | --- |
| [Миграция баз данных Azure](https://docs.microsoft.com/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает простой перенос из нескольких источников базы данных в платформы данных Azure с минимальным временем простоя. | Узнайте о [поддерживаемых регионах](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) и [ценах на Azure Database Migration Service](https://azure.microsoft.com/pricing/details/database-migration). |
| [Миграция Azure](https://docs.microsoft.com/azure/migrate/migrate-overview) | Компания Contoso использует службу "Миграция Azure" для оценки виртуальных машин VMware. Служба "Миграция Azure" оценивает миграционную пригодность компьютеров. Она обеспечивает оценку размера и стоимости для работы в Azure. | За использование службы "Миграция Azure" не нужно дополнительно платить. Однако оплата может взиматься в зависимости от средств (от первой стороны или ISV), которые вы решили использовать для оценки и миграции. Дополнительные сведения о [ценах на миграцию Azure](https://azure.microsoft.com/pricing/details/azure-migrate). |

## <a name="migration-process"></a>Процесс миграции

Администраторы Contoso будут переносить виртуальные машины приложений в Azure.

- Они переносят клиентскую виртуальную машину на виртуальную машину Azure с помощью службы "миграция Azure":
  - В качестве первого шага они подготовят и настроят компоненты Azure , а также подготовят локальную инфраструктуру VMware.
  - После завершения подготовки они смогут начать репликацию виртуальных машин.
  - После включения и работы репликации выполняется перенос виртуальной машины с помощью службы "миграция Azure".
- После проверки базы данных они будут перенесены в кластер SQL Server в Azure с помощью Azure Database Migration Service.
  - В качестве первого шага специалистам компании необходимо будет предоставить виртуальные машины SQL Server в Azure, настроить кластер и подсистему балансировки нагрузки и настроить группы доступности AlwaysOn.
  - После этого они могут перенести базу данных.
- После миграции он включит группы доступности Always On для базы данных.

    ![Процесс миграции](./media/contoso-migration-rehost-vm-sql-ag/migration-process.png)

## <a name="prerequisites"></a>Предварительные требования

Ниже указано, что необходимо сделать компании Contoso в этом сценарии.

| Требования | Сведения |
| --- | --- |
| **Подписка Azure.** | Специалисты Contoso уже создали подписку в более ранней статье из этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника. <br><br> |
| **Инфраструктура Azure** | Компания Contoso настраивает инфраструктуру Azure, как описано в статье [Развертывание инфраструктуры Azure для миграции в Contoso](./contoso-migration-infrastructure.md). <br><br> Дополнительные сведения о требованиях к [предварительным](./contoso-migration-devtest-to-iaas.md#prerequisites) требованиям для службы "миграция Azure": миграция сервера. |
| **Локальные серверы** | Локальная vCenter Server должна работать под управлением версии 5,5, 6,0, 6,5 или 6,7. <br><br> Узел ESXi с версией 5,5, 6,0, 6,5 или 6,7. <br><br> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi. |
| **Локальные виртуальные машины** | [Ознакомьтесь со списком виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros), которые рекомендованы к использованию в Azure. |

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Подготовка кластера АОАГ.** Создание кластера для развертывания двух узлов виртуальных машин SQL Server в Azure.
> - **Шаг 2. Развертывание и настройка кластера.** Подготовка кластера Azure SQL Server. Базы данных переносятся в этот имеющийся кластер.
> - **Шаг 3. Развертывание Azure Load Balancer.** Развертывание подсистемы для балансировки трафика на узлы SQL Server.
> - **Шаг 4. Подготовка Azure для миграции Azure.** Создайте учетную запись хранения Azure для хранения реплицированных данных.
> - **Шаг 5. Подготовка локальной среды VMware для службы "миграция Azure".** Подготовка учетных записей для обнаружения виртуальных машин и установки агента. Подготовка локальных виртуальных машин для того, чтобы пользователи могли подключаться к виртуальным машинам Azure после миграции.
> - **Шаг 6. репликация виртуальных машин.** Включение репликации виртуальных машин в Azure.
> - **Шаг 7. Перенос базы данных с помощью Azure Database Migration Service.** Перенесите базу данных в Azure с помощью Azure Database Migration Service.
> - **Шаг 8. Защита базы данных.** Создание группы доступности AlwaysOn для кластера.
> - **Шаг 9. Миграция виртуальных машин с помощью службы "миграция Azure".** Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов. Затем запустите миграцию в Azure.

## <a name="step-1-prepare-a-sql-server-always-on-availability-group-cluster"></a>Шаг 1. Подготовка кластера группы доступности SQL Server Always On

Администраторы Contoso настраивают кластер следующим образом:

1. Специалисты компании создают две виртуальные машины SQL Server, выбрав образ SQL Server 2017 Enterprise Windows Server 2016 в Azure Marketplace.

    ![SKU виртуальной машины SQL](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-sku.png)

2. В **мастере создания виртуальных машин**  >  **Basics**они настраивают:

    - Имена виртуальных машин: `SQLAOG1` и `SQLAOG2` .
    - Поскольку компьютеры критически важны для бизнеса, они обеспечивают SSD для типа диска виртуальной машины.
    - Они определяют учетные данные компьютера.
    - Они развертывают виртуальные машины в основном регионе ( `East US 2` ) в `ContosoRG` группе ресурсов.

3. В **размерах**они начинаются с `D2S v3` экземпляров для обеих виртуальных машин. Они будут масштабироваться позже, когда потребуется.
4. В разделе **Параметры** выполняются следующие действия.

    - Так как эти виртуальные машины являются важными базами данных для приложения, они используют управляемые диски.
    - Они размещают компьютеры в подсети базы данных () `PROD-DB-EUS2` рабочей сети ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
    - Они создают новую группу доступности ( `SQLAOGAVSET` ) с двумя доменами сбоя и пятью доменами обновления.

      ![Виртуальная машина SQL](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-settings.png)

5. В **Параметры SQL Server** они ограничивают возможность подключения SQL к виртуальной сети (закрытой), по умолчанию порт 1433. Для проверки подлинности используются те же учетные данные, что и при использовании onsite ( `contosoadmin` ).

    ![Виртуальная машина SQL](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-db.png)

**Требуется дополнительная помощь?**

- Получите справку по [подготовке виртуальной машины SQL Server](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision#1-configure-basic-settings).
- Дополнительные сведения о [настройке виртуальных машин для разных номеров sku SQL Server](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-prereq#create-sql-server-vms).

## <a name="step-2-deploy-and-set-up-the-cluster"></a>Шаг 2. Развертывание и настройка кластера

Вот как администраторы Contoso настраивают кластер:

1. Они настроили учетную запись хранения Azure в качестве облачного следящего сервера.
2. Они добавляют виртуальные машины SQL Server в домен Active Directory в локальном центре данных Contoso.
3. Они создают кластер в Azure.
4. Они настраивают облако-свидетеля.
5. Наконец они включают группы доступности AlwaysOn.

### <a name="set-up-a-storage-account-as-cloud-witness"></a>Настройка учетной записи хранилища как облако-свидетель.

Чтобы настроить облако-свидетеля, Contoso необходима учетная запись Azure Storage, которая будет содержать файл большого двоичного объекта, используемого для арбитража кластера. Эту же учетную запись можно использовать для настройки облака-свидетеля для нескольких кластеров.

Администраторы компании Contoso создают учетную запись хранения следующим образом:

1. Они указывают понятное имя для учетной записи ( `contosocloudwitness` ).
2. Они развертывают общую универсальную учетную запись с LRS.
3. Они размещают учетную запись в третьем регионе ( `South Central US` ). Они размещаются за пределами основного и дополнительного регионов, чтобы она оставалась доступной во время региональных сбоев.
4. Они размещаются в группе ресурсов, в которой хранятся ресурсы инфраструктуры `ContosoInfraRG` .

    ![Облако-свидетель](./media/contoso-migration-rehost-vm-sql-ag/witness-storage.png)

5. Когда они создают учетную запись хранения, для нее генерируются первичные и вторичные ключи доступа. Им нужен первичный ключ доступа для создания облака-свидетеля. Ключ отображается в имени учетной записи хранения > **ключи доступа**.

    ![Ключ доступа](./media/contoso-migration-rehost-vm-sql-ag/access-key.png)

<!-- docsTest:ignore "Failover Cluster feature -->

### <a name="add-sql-server-vms-to-contoso-domain"></a>Добавление виртуальных машин SQL Server в домене Contoso

1. Contoso добавляет `SQLAOG1` и `SQLAOG2` в `contoso.com` домен.
2. Затем на каждой виртуальной машине устанавливаются функции и средства отказоустойчивого кластера Windows.

### <a name="set-up-the-cluster"></a>Настройка кластера

Перед настройкой кластера администраторы Contoso создают теневую копию диска операционной системы на каждом компьютере.

![Create snapshot](./media/contoso-migration-rehost-vm-sql-ag/snapshot.png)

1. Затем они выполняют сценарий, который они создали для создания отказоустойчивого кластера Windows.

    ![Создание кластера](./media/contoso-migration-rehost-vm-sql-ag/create-cluster1.png)

2. После создания кластера они подтверждают, что виртуальные машины отображаются как узлы кластера.

     ![Создание кластера](./media/contoso-migration-rehost-vm-sql-ag/create-cluster2.png)

<!--docsTest:ignore "Failover Cluster Manager" -->

### <a name="configure-the-cloud-witness"></a>Настройка облака-свидетеля.

1. Администраторы Contoso настраивают облако-свидетеля с помощью **мастера конфигурации кворума** в диспетчере отказоустойчивости кластеров.
2. В мастере они выбирают создание облачного следящего сервера с учетной записью хранения.
3. После настройки облака-свидетеля, оно отображается в оснастке диспетчера отказоустойчивости кластеров.

    ![Облако-свидетель](./media/contoso-migration-rehost-vm-sql-ag/cloud-witness.png)

### <a name="enable-sql-server-always-on-availability-groups"></a>Включение групп доступности AlwaysOn SQL Server

Администраторы Contoso теперь могут включать группы доступности Always On:

1. В диспетчере конфигурации SQL Server они включают функцию **Группы доступности AlwaysOn** для службы **SQL Server (MSSQLSERVER)**.

    ![Включение решения Always On](./media/contoso-migration-rehost-vm-sql-ag/enable-always-on.png)

2. Они перезагружают службу, чтобы изменения вступили в силу.

После включения группы доступности Always On Contoso может настроить Always On группу доступности, которая будет защищать базу данных SmartHotel360.

**Требуется дополнительная помощь?**

- [Узнайте об](https://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness) облаке-свидетеле и настройке учетной записи хранения для него.
- [Получите инструкции](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial) для настройки кластера и создания группы доступности.

## <a name="step-3-deploy-the-azure-load-balancer"></a>Шаг 3. Развертывание балансировщика нагрузки Azure

Администраторам Contoso необходимо развернуть внутреннюю подсистему балансировки нагрузки, расположенную перед узлами кластера. Подсистема балансировки нагрузки ожидает передачу данных и направляет ее на соответствующий узел.

![Балансировка нагрузки](./media/contoso-migration-rehost-vm-sql-ag/architecture-lb.png)

Они создают подсистему балансировки нагрузки следующим образом.

1. В портал Azure > **Сетевая**  >  **подсистема балансировки нагрузки**настроена новая внутренняя подсистема балансировки нагрузки: `ILB-PROD-DB-EUS2-SQLAOG` .
2. Они размещают подсистему балансировки нагрузки в подсети базы данных ( `PROD-DB-EUS2` ) рабочей сети ( `VNET-PROD-EUS2` ).
3. Им назначается статический IP-адрес ( `10.245.40.100` ).
4. В качестве элемента сети они развертывают подсистему балансировки нагрузки в группе сетевых ресурсов `ContosoNetworkingRG` .

    ![Балансировка нагрузки](./media/contoso-migration-rehost-vm-sql-ag/lb-create.png)

После развертывания внутренней подсистемы балансировки нагрузки им необходимо настроить ее. Они создают пул внутренних адресов, настраивают проверку работоспособности и настраивают правило балансировки нагрузки.

### <a name="add-a-back-end-pool"></a>Добавление внутреннего пула

Чтобы распределить трафик между виртуальными машинами в кластере, администраторы Contoso настраивают внутренний пул адресов, содержащий IP-адреса сетевых карт для виртуальных машин, которые будут получать сетевой трафик от подсистемы балансировки нагрузки.

1. В параметрах подсистемы балансировки нагрузки на портале Contoso добавляет пул серверной части: `ILB-PROD-DB-EUS-SQLAOG-BEPOOL` .
2. Они связывают пул с группой доступности `SQLAOGAVSET` . Виртуальные машины в наборе ( `SQLAOG1` и `SQLAOG2` ) добавляются в пул.

    ![Внутренний пул](./media/contoso-migration-rehost-vm-sql-ag/backend-pool.png)

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Администраторы Contoso создают проверку работоспособности, чтобы подсистема балансировки нагрузки могла отслеживать работоспособность приложения. Проба динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности.

Они создают пробы следующим образом:

1. В параметрах балансировки нагрузки на портале Contoso создает пробу работоспособности: **SQLAlwaysOnEndPointProbe**.
2. Они устанавливают пробу для мониторинга виртуальных машин на TCP-порте 59999.
3. Они устанавливают интервал 5 секунд между пробами и пороговое значение 2. При сбое двух проб виртуальная машина будет считаться неработоспособной.

    ![Проба](./media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

### <a name="configure-the-load-balancer-to-receive-traffic"></a>Настройка распределителя нагрузки для приема трафика

Теперь администраторы Contoso настраивают правило подсистемы балансировки нагрузки, определяющее, как трафик распределяется между виртуальными машинами.

- Интерфейсный IP-адрес обрабатывает входящий трафик.
- Серверный IP-пул получает трафик.

Они создают правило следующим образом:

1. В параметрах подсистемы балансировки нагрузки на портале они добавляют новое правило: `SQLAlwaysOnEndPointListener` .
2. Они устанавливают интерфейсный прослушиватель для получения входящего трафика клиента SQL через TCP-порт 1433.
3. Они определяют внутренний пул, в который будет передаваться трафик, и порт, на котором виртуальные машины ожидают передачи данных трафика.
4. Они включают плавающий IP-адрес (прямой ответ от сервера). Это всегда требуется для SQL Server Always On.

    ![Проба](./media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

**Требуется дополнительная помощь?**

- [Ознакомление с общими сведениями](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview) об Azure Load Balancer.
- [Дополнительные сведения о](https://docs.microsoft.com/azure/load-balancer/tutorial-load-balancer-basic-internal-portal) создании подсистем балансировки нагрузки.

## <a name="step-4-prepare-azure-for-azure-migrate"></a>Шаг 4. Подготовка Azure для миграции Azure

Ниже приведены компоненты Azure Contoso, необходимые для развертывания службы "миграция Azure".

- Виртуальная сеть, в которой будут находиться виртуальные машины при миграции.
- Учетная запись хранения Azure для хранения реплицированных данных.

Администраторы Contoso настроили их следующим образом:

1. Компания Contoso уже создала сеть или подсеть, которые они могут использовать для миграции Azure при [развертывании инфраструктуры Azure](./contoso-migration-rehost-vm-sql-ag.md).

    - Приложение SmartHotel360 — это рабочее приложение, `WEBVM` которое будет перенесено в рабочую сеть Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
    - `WEBVM`будет помещен в `ContosoRG` группу ресурсов, которая используется для рабочих ресурсов и в рабочей подсети ( `PROD-FE-EUS2` ).

2. Администраторы Contoso создают учетную запись хранения Azure ( `contosovmsacc20180528` ) в основном регионе.

    - Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS.

## <a name="step-5-prepare-on-premises-vmware-for-azure-migrate"></a>Шаг 5. Подготовка локальной среды VMware для миграции Azure

Ниже перечислены элементы, которые администраторам Contoso необходимо подготовить в локальной среде.

- Учетная запись на узле vCenter Server или vSphere ESXi для автоматизации обнаружения виртуальных машин.
- Локальные параметры виртуальной машины, чтобы компания Contoso могла подключаться к реплицированной виртуальной машине Azure после миграции.

### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Службе "миграция Azure" требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины.
- Управление репликацией и миграцией.
- Требуется по крайней мере учетная запись только для чтения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Администраторы компании Contoso настраивают учетную запись следующим образом:

1. Специалисты компании создают роль на уровне vCenter.
2. Затем они назначают этой роли необходимые разрешения.

### <a name="prepare-to-connect-to-azure-vms-after-migration"></a>Подготовка к подключению к виртуальным машинам Azure после миграции

После миграции компания Contoso хочет подключиться к виртуальным машинам Azure и разрешить Azure управлять виртуальными машинами. Для этого перед миграцией администраторы компании Contoso выполняют указанные ниже действия.

1. Для доступа через Интернет они делают следующее.

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Проверяют, добавлены ли правила TCP и UDP для профиля **Общедоступный**.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.

2. Для доступа через VPN типа "сеть — сеть":

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.
    - Для Windows задайте для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

3. Установите агент для Azure:

    - [Агент Linux для Azure](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux)
    - [Агент Azure для Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-windows)

4. Прочие вещества

   - Для Windows на виртуальной машине не должно быть ожидающих обновлений Windows при активации миграции. Если есть такие обновления, не удастся войти в систему на виртуальной машине до их завершения.
   - После миграции они могут проверить **диагностику загрузки** , чтобы просмотреть снимок экрана виртуальной машины. Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

**Требуется дополнительная помощь?**

- Дополнительные сведения о [подготовке виртуальных машин к миграции](https://docs.microsoft.com/azure/migrate/prepare-for-migration).

## <a name="step-6-replicate-the-on-premises-vms-to-azure"></a>Шаг 6. репликация локальных виртуальных машин в Azure

Чтобы можно было запустить миграцию в Azure, администраторам компании Contoso потребуется настроить и включить репликацию.

По завершении обнаружения можно начать репликацию виртуальных машин VMware в Azure.

1. В проекте "миграция Azure" > **серверы**, служба **"миграция Azure": миграция сервера**выберите **репликация**.

    ![Репликация виртуальных машин](./media/contoso-migration-rehost-vm/select-replicate.png)

2. В разделе Параметры **репликации**  >  **источника**  >  **виртуальные машины виртуализированы?** выберите **Да, с VMware vSphere**.

3. В разделе **Локальное устройство** выберите имя устройства Миграции Azure, которое вы настроили, и нажмите кнопку **ОК**.

    ![Параметры источника](./media/contoso-migration-rehost-vm/source-settings.png)

4. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не выполняли оценку или вы не хотите использовать параметры оценки, выберите параметр **нет** .
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.

    ![Выбор оценки](./media/contoso-migration-rehost-vm/select-assessment.png)

5. В разделе **Виртуальные машины** найдите виртуальные машины и отметьте каждую виртуальную машину, которую вы хотите перенести. Затем нажмите кнопку **Далее: целевые параметры**.

6. В разделе **Целевые параметры** выберите подписку и целевой регион, в который вы хотите выполнить миграцию, а также укажите группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.

7. В **преимущество гибридного использования Azure**выберите следующее:

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем нажмите кнопку **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

8. В разделе **Вычисления** просмотрите имя виртуальной машины, размер, тип диска ОС и группу доступности. Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/migrate/migrate-support-matrix-vmware#vmware-requirements).

    - **Размер виртуальной машины:** Если вы используете рекомендации по оценке, раскрывающийся список размер виртуальной машины будет содержать рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. Кроме того, можно выбрать размер вручную в качестве **размера виртуальной машины Azure.**
    - **Диск ОС:** Укажите диск операционной системы (загрузочный) для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком.
    - **Группа доступности:** Если после миграции виртуальная машина должна находиться в группе доступности Azure, укажите набор. Группа должна находиться в целевой группе ресурсов, которую вы указываете для миграции.

9. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции.

10. В окне **Проверка и запуск репликации**проверьте параметры и выберите **репликация** , чтобы запустить начальную репликацию для серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

## <a name="step-7-migrate-the-database-via-azure-database-migration-service"></a>Шаг 7. Перенос базы данных с помощью Azure Database Migration Service

Администраторы Contoso переходят с помощью Azure Database Migration Service, выполнив пошаговое [руководство по миграции](https://docs.microsoft.com/azure/dms/tutorial-sql-server-azure-sql-online). Они могут выполнять интерактивные, автономные и гибридные (предварительные) миграции.

В качестве сводки необходимо выполнить следующие действия.

- Создайте экземпляр Azure Database Migration Service, подключенный к виртуальной сети с помощью ценовой категории "Премиум".
- Убедитесь, что экземпляр может получить доступ к удаленным SQL Server через виртуальную сеть. Это гарантирует, что все входящие порты будут разрешены в Azure для SQL Server на уровне виртуальной сети, в сети VPN и на компьютере, на котором размещается SQL Server.
- Настройте экземпляр:
  - Создайте проект миграции.
  - Добавьте источник (локальная база данных).
  - Выберите целевой объект.
  - Выберите базы данных для миграции.
  - Настройка дополнительных параметров.
  - Запустите репликацию.
  - Устраните возможные ошибки.
  - Выполните окончательный прямую миграцию.

## <a name="step-8-protect-the-database-with-sql-server-always-on"></a>Шаг 8. Защита базы данных с помощью SQL Server Always On

Теперь, когда база данных приложения работает в `SQLAOG1` , администраторы Contoso могут защитить ее с помощью группы доступности Always on. Они настраивают SQL Server Always On с помощью SQL Server Management Studio, а затем назначают прослушиватель с помощью кластеризации Windows.

### <a name="create-an-always-on-availability-group"></a>Создание группы доступности AlwaysOn

1. В SQL Server Management Studio они выбирают и сохраняют (или щелкают правой кнопкой мыши) **Always on высокий уровень доступности** для запуска **мастера создания групп доступности**.
2. В поле **Параметры укажите**имя группы доступности `SHAOG` . В окне **Выбор баз данных**они выбирают `SmartHotel360` базу данных.

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-1.png)

3. В **Выбор реплик**, они добавляют два узла SQL как реплики доступности и настраивают их для обеспечения автоматической отработки отказа с синхронной фиксацией.

     ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-2.png)

4. Они настраивают прослушиватель для группы ( `SHAOG` ) и порта. IP-адрес внутренней подсистемы балансировки нагрузки добавляется как статический IP-адрес ( `10.245.40.100` ).

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-3.png)

5. В **Выбор синхронизации данных**, они включают автоматическое заполнение. С помощью этой опции SQL Server автоматически создает вторичные реплики для каждой базы данных в группе, поэтому Contoso не нужно вручную создавать резервные копии и восстанавливать их. После проверки создается группа доступности.

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-4.png)

6. У Contoso возникли проблемы при создании группы. Они не используют Active Directory встроенной безопасности Windows, поэтому необходимо предоставить разрешения имени входа SQL для создания ролей отказоустойчивого кластера Windows.

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-5.png)

7. После создания группы Contoso может увидеть ее в SQL Server Management Studio.

### <a name="configure-a-listener-on-the-cluster"></a>Настройка прослушивателя в кластере

В качестве последнего этапа настройки развертывания SQL администраторы Contoso настраивают внутреннюю подсистему балансировки нагрузки как прослушиватель в кластере и переводят прослушиватель в оперативный режим. Для этого они используют сценарий.

![Прослушиватель кластера](./media/contoso-migration-rehost-vm-sql-ag/cluster-listener.png)

### <a name="verify-the-configuration"></a>Проверка конфигурации

Теперь, когда все настроено, у компании Contoso есть действующая группа доступности в Azure, использующая перенесенную базу данных. Администраторы проверяют это, подключившись к внутренней подсистеме балансировки нагрузки в SQL Server Management Studio.

![Подключение ILB](./media/contoso-migration-rehost-vm-sql-ag/ilb-connect.png)

**Требуется дополнительная помощь?**

- Дополнительные сведения о создании [группы доступности](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#create-the-availability-group) и [прослушивателя](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#configure-listener).
- [Настройка использования IP-адреса балансировщика нагрузки для кластера](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener#configure-the-cluster-to-use-the-load-balancer-ip-address) вручную.
- Дополнительные сведения о [создании и использовании SAS](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2).

## <a name="step-9-migrate-the-vm-with-azure-migrate"></a>Шаг 9. Миграция виртуальной машины с помощью службы "миграция Azure"

Администраторы Contoso выполняют быструю тестовую отработку отказа, а затем — миграцию виртуальной машины.

### <a name="run-a-test-migration"></a>Выполнение тестовой миграции

Выполнение тестовой миграции позволяет убедиться, что все работает правильно перед миграцией.

1. Они выполняют тестовую отработку отказа до последней доступной точки во времени ( `Latest processed` ).
2. Прежде чем **начать отработку отказа, выберите завершить работу компьютера**, чтобы служба Azure Migrate попыталась завершить работу исходной виртуальной машины перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить.
3. При тестировании отработки отказа происходит следующее:

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; Если выбрать последнюю точку восстановления, на основе данных будет создана точка восстановления.
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

4. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Специалисты убеждаются, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
5. После проверки они выполняют очистку отработки отказа, а также записывают и сохраняют все наблюдения.

### <a name="run-a-failover"></a>Запуск отработки отказа

1. Убедившись, что тестовая отработка отказа работала должным образом, администраторы Contoso создают план восстановления для миграции и добавляют `WEBVM` его в план.

     ![План восстановления](./media/contoso-migration-rehost-vm-sql-ag/recovery-plan.png)

2. Специалисты компании выполняют для этого плана отработку отказа. Они выбирают последнюю точку восстановления и указывают, что служба "миграция Azure" должна попытаться завершить работу локальной виртуальной машины перед активацией отработки отказа.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover1.png)

3. После отработки отказа специалисты компании проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![План восстановления](./media/contoso-migration-rehost-vm-sql-ag/failover2.png)

4. После проверки виртуальной машины в Azure они завершат миграцию, чтобы завершить процесс миграции, приостановили репликацию для виртуальной машины и приостановили выставление счетов на миграцию Azure для виртуальной машины.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

В качестве последнего шага процесса миграции администраторы Contoso обновляют строку подключения приложения, чтобы она указывала на перенесенную базу данных, работающую на `SHAOG` прослушивателе. Эта конфигурация будет изменена на `WEBVM` компьютере, работающем в Azure. Эта конфигурация находится в `web.config` приложении ASP.NET.

1. Нахождение файла по адресу `C:\inetpub\SmartHotelWeb\web.config` . Измените имя сервера, чтобы оно отражало полное доменное имя группы доступности Always On: `shaog.contoso.com` .

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover4.png)

2. После обновления файла и его сохранения перезапускаются службы IIS `WEBVM` . Это делается с помощью `iisreset /restart` из командной строки.
3. После перезапуска IIS приложение теперь использует базу данных, запущенную на управляемом экземпляре.

**Требуется дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) выполнить тестовую отработку отказа.
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) выполнить отработку отказа в Azure.

### <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции приложение SmartHotel360 выполняется на виртуальной машине Azure, а база данных SmartHotel360 находится в кластере SQL Azure.

Теперь специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновить внутренние документы и отразить в них новое расположение и IP-адреса виртуальных машин.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.
- Добавьте две новые виртуальные машины ( `SQLAOG1` и `SQLAOG2` ) в системы мониторинга рабочей среды.

### <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Группа безопасности Contoso рассматривает виртуальные машины `WEBVM` , `SQLAOG1` а `SQLAOG2` также определяет проблемы безопасности.

- Чтобы можно было управлять доступом, команда проверяет группы безопасности сети (NSG) для виртуальной машины. NSG позволяют пропускать только разрешенный для приложения трафик.
- Команда рассматривает возможность защиты данных на диске с использованием функций шифрования дисков Azure и Key Vault.
- Команда должна оценить прозрачное шифрование данных (TDE), а затем включить его в базе данных SmartHotel360, работающей в новой группе доступности Always On. [Подробнее](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017).

Дополнительные сведения см. в статье рекомендации [по обеспечению безопасности для рабочих нагрузок IaaS в Azure](https://docs.microsoft.com/azure/security/fundamentals/iaas).

## <a name="business-continuity-and-disaster-recovery"></a>Непрерывность бизнес-процессов и аварийное восстановление

Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление (BCDR), Contoso выполняет следующие действия:

- Для защиты данных компания Contoso создает резервные копии данных на `WEBVM` `SQLAOG1` `SQLAOG2` виртуальных машинах, и с помощью [резервного копирования виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-introduction).
- Contoso также узнает, как использовать службу хранилища Azure для резервного копирования SQL Server непосредственно в хранилище BLOB-объектов. [Подробнее](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-use-storage-sql-server-backup-restore).
- Чтобы приложения продолжали работать, компания Contoso реплицирует виртуальные машины приложений в Azure в дополнительный регион с помощью Site Recovery. [Подробнее](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- У компании Contoso имеются лицензии на виртуальные машины WEBVM, и она воспользуется Преимуществом гибридного использования Azure. Contoso преобразует имеющиеся виртуальные машины Azure, чтобы использовать льготные расценки.
- Компания Contoso будет использовать службу " [Управление затратами Azure" и выставление счетов](https://docs.microsoft.com/azure/cost-management-billing/cost-management-billing-overview) , чтобы гарантировать, что они останутся в бюджетах, установленных по ИТ.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso повторно размещает приложение SmartHotel360 в Azure, переключая клиентскую виртуальную машину приложения в Azure с помощью службы "миграция Azure". Компания Contoso перенеса базу данных приложений в кластер SQL Server, подготовленный в Azure с помощью Azure Database Migration Service, и защитил его в группе доступности SQL Server Always On.
