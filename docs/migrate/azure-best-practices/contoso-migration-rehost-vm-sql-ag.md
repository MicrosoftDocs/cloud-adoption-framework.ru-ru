---
title: Повторное размещение приложения путем его переноса на виртуальные машины Azure и SQL Server группы доступности Always On
description: Узнайте, как компания Contoso повторно размещает локальное приложение, перемещая его на виртуальные машины Azure и в группы доступности SQL Server AlwaysOn
author: givenscj
ms.author: abuck
ms.date: 04/02/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 7682617184f7b9bcb3ffda775097163e4fac2716
ms.sourcegitcommit: 2794cab8eb925103ae22babc704d89f7f7d4f6f4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/18/2020
ms.locfileid: "84993865"
---
<!-- cSpell:ignore givenscj WEBVM SQLVM contosohost vcenter contosodc AOAG SQLAOG SQLAOGAVSET contosoadmin contosocloudwitness MSSQLSERVER BEPOOL contosovmsacc SHAOG NSGs inetpub iisreset -->

# <a name="rehost-an-on-premises-app-with-azure-virtual-machines-and-sql-server-always-on-availability-groups"></a>Повторное размещение локального приложения с помощью виртуальных машин Azure и SQL Server группы доступности Always On

В этой статье показано, как вымышленная компания Contoso в процессе миграции в Azure повторно размещает двухуровневый приложение Windows .NET, работающее на виртуальных машинах VMware. Компания Contoso переносит интерфейсную виртуальную машину приложения на виртуальную машину Azure, а базу данных приложений — на виртуальную машину SQL Server в Azure, запущенную в отказоустойчивом кластере Windows Server с группами доступности SQL Server AlwaysOn.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.

- **Повышение эффективности.** Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.

- **Повышение гибкости.** ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования. Он не должен становиться помехой для бизнеса.

- **Измените.** По мере успешного роста бизнеса ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

- После миграции в Azure приложение должно работать так же эффективно, как оно работает в VMWare. В облаке приложение будет играть такую же критически важную роль, как в локальной среде.

- Компания Contoso не хочет вкладываться в это приложение. Оно важно для бизнеса, но компании Contoso просто нужно безопасно переместить его в облако в его текущей форме.

- В локальной базе данных для приложения были проблемы с доступностью. Специалисты Contoso хотели бы развернуть ее в Azure в качестве кластера с высокой степенью доступности и возможностью отработки отказа.

- Компания Contoso планирует провести обновление текущей платформы SQL Server 2008 R2 до SQL Server 2017.

- Компания Contoso не хочет использовать базу данных SQL Azure для этого приложения и ищет альтернативы.

## <a name="solution-design"></a>Архитектура решения

Определив свои цели и требования, специалисты компании Contoso начинают разработку и анализ решения для развертывания и планируют процесс миграции, включая службы Azure, которые будут использоваться в ходе этой миграции.

### <a name="current-architecture"></a>Текущая архитектура

- Приложение разбито на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на VMware ESXi узле **contosohost1.contoso.com** (версия 6,5).
- Управление средой VMware осуществляется с помощью vCenter Server 6,5 (**vCenter.contoso.com**), выполняющегося на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).

### <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Contoso перенесет интерфейсную виртуальную машину WEBVM приложения на виртуальную машину IaaS Azure.
  - Интерфейсная виртуальная машина в Azure будет развернута в группе ресурсов ContosoRG, которая используется для рабочих ресурсов.
  - Она будет находиться в рабочей среде Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
- База данных приложения будет перенесена на виртуальную машину SQL Server в Azure.
  - Она будет располагаться в сети баз данных Azure компании Contoso (PROD-DB-EUS2) в основном регионе "Восточная часть США 2".
  - Она будет помещена в отказоустойчивый кластер Windows Server с двумя узлами, использующий группы доступности SQL Server AlwaysOn.
  - В Azure два SQL Server узлов виртуальных машин в кластере будут развернуты в группе ресурсов ContosoRG.
  - Узлы виртуальных машин будут находиться в рабочей среде Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
  - Виртуальные машины работают Windows Server 2016 с SQL Server 2017 г Enterprise Edition. У Contoso нет лицензий для этой операционной системы, поэтому специалисты компании будут использовать образ из Azure Marketplace, предоставляющий лицензию в качестве платежа для своих обязательств Azure EA.
  - Помимо уникальных имен обе виртуальные машины используют те же параметры.
- Компания Contoso развернет внутреннюю подсистему балансировки нагрузки, которая прослушивает трафик в кластере, и направляет ее на соответствующий узел кластера.
  - Внутренний распределитель нагрузки будет развернут в ContosoNetworkingRG (используется для сетевых ресурсов).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

    ![Архитектура сценария](./media/contoso-migration-rehost-vm-sql-ag/architecture.png)

### <a name="database-considerations"></a>Рекомендации по базе данных

В ходе проектирования решения специалисты Contoso сравнили функции Базы данных Azure SQL и SQL Server. На принятие решения об использовании виртуальной машины Azure по модели IaaS под управлением SQL Server повлияли следующие соображения:

- Использование виртуальной машины Azure под управлением SQL Server выглядит оптимальным решением, если нужно настроить операционную систему или сервер базы данных либо использовать сторонние приложения на той же виртуальной машине.

### <a name="solution-review"></a>Проверка решения

Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

<!-- markdownlint-disable MD033 -->

**Рассматриваемый вопрос** | **Сведения**
--- | ---
**Преимущества** | Интерфейс WEBVM будет перемещен в Azure без изменений, упрощая миграцию. <br><br> Уровень SQL Server будет работать под управлением SQL Server 2017 и Windows Server 2016. Это позволяет прекратить использование операционной системы Windows Server 2008 R2, а SQL Server 2017 соответствует техническим требованиям и целям компании Contoso. Обеспечивается 100-процентная совместимость, и в то же время прекращается использование SQL Server 2008 R2. <br><br> Contoso может воспользоваться преимуществами своих инвестиций в программу Software Assurance, используя Преимущество гибридного использования Azure. <br><br> Развертывание SQL Server с высоким уровнем доступности в Azure обеспечивает отказоустойчивость, благодаря чему уровень данных приложения больше не является единственной точкой отработки отказа.
**Недостатки** | WEBVM работает под управлением Windows Server 2008 R2. Операционная система поддерживается средой Azure для определенных ролей (июль 2018 г.). [Подробнее](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines). <br><br> Веб-уровень приложения останется единственной точкой отработки отказа. <br><br> Компании Contoso потребуется и дальше поддерживать веб-уровень как виртуальную машину Azure, а не переходить на управляемую службу, такую как Служба приложений Azure. <br><br> С помощью выбранного решения компании Contoso потребуется и дальше управлять двумя виртуальными машинами SQL Server, а не переходить на управляемую платформу, такую как управляемый экземпляр Базы данных SQL Azure. Кроме того, в рамках программы Software Assurance компания Contoso может обменять свои имеющиеся лицензии на сниженные тарифы при использовании управляемого экземпляра Базы данных SQL Azure.

<!-- markdownlint-enable MD033 -->

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает прозрачную миграцию из нескольких источников баз данных на платформы данных Azure с минимальным временем простоя. | Дополнительные сведения о [поддерживаемых регионах](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) см. на странице [цен на Database Migration Service](https://azure.microsoft.com/pricing/details/database-migration).
[Служба "Миграция Azure"](https://docs.microsoft.com/azure/migrate/migrate-services-overview) | Компания Contoso использует службу "Миграция Azure" для оценки виртуальных машин VMware. Служба "Миграция Azure" оценивает миграционную пригодность компьютеров. Она обеспечивает оценку размера и стоимости для работы в Azure. | Начиная с мая 2018 года "Миграция Azure" — это бесплатная служба.

## <a name="migration-process"></a>Процесс миграции

Администраторы Contoso перенесут виртуальные машины приложения в Azure.

- Они переносят клиентскую виртуальную машину на виртуальную машину Azure с помощью службы "миграция Azure":
  - В качестве первого шага они подготовят и настроят компоненты Azure , а также подготовят локальную инфраструктуру VMware.
  - После завершения подготовки они смогут начать репликацию виртуальных машин.
  - После того как репликация будет включена и начнет работать, они перенесут виртуальную машину путем отработки отказа в Azure.
- После проверки базы данных они будут перенесены в кластер SQL Server в Azure с помощью службы переноса данных (DMS).
  - В качестве первого шага специалистам компании необходимо будет предоставить виртуальные машины SQL Server в Azure, настроить кластер и подсистему балансировки нагрузки и настроить группы доступности AlwaysOn.
  - После этого они могут перенести базу данных.
- После переноса они активируют защиту AlwaysOn для базы данных.

    ![Процесс миграции](./media/contoso-migration-rehost-vm-sql-ag/migration-process.png)

## <a name="prerequisites"></a>Предварительные требования

Ниже указано, что необходимо сделать компании Contoso в этом сценарии.

<!-- markdownlint-disable MD033 -->

| **Требования** | **Сведения** |
| --- | --- |
| **Подписка Azure.** | Специалисты Contoso уже создали подписку в более ранней статье из этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника. |
| **Инфраструктура Azure** | Компания Contoso настраивает инфраструктуру Azure, как описано в статье [Развертывание инфраструктуры Azure для миграции в Contoso](./contoso-migration-infrastructure.md). <br><br> Дополнительные сведения о требованиях к [предварительным](https://docs.microsoft.com/azure/migrate/contoso-migration-rehost-linux-vm#prerequisites) требованиям для службы "миграция Azure": миграция сервера. |
| **Локальные серверы** | На локальном сервере vCenter Server должна быть установлена версия 5,5, 6,0, 6,5 или 6,7. <br><br> Узел ESXi с версией 5,5, 6,0, 6,5 или 6,7. <br><br> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi. |
| **Локальные виртуальные машины** | [Ознакомьтесь со списком виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros), которые рекомендованы к использованию в Azure. |

<!-- markdownlint-enable MD033 -->

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Подготовка кластера АОАГ.** Создание кластера для развертывания двух узлов виртуальных машин SQL Server в Azure.
> - **Шаг 2. Развертывание и настройка кластера.** Подготовка кластера Azure SQL Server. Базы данных переносятся в этот имеющийся кластер.
> - **Шаг 3. Развертывание Azure Load Balancer.** Развертывание подсистемы для балансировки трафика на узлы SQL Server.
> - **Шаг 4. Подготовка Azure для миграции Azure.** Создайте учетную запись хранения Azure для хранения реплицированных данных.
> - **Шаг 5. Подготовка локальной среды VMware для службы "миграция Azure".** Подготовка учетных записей для обнаружения виртуальных машин и установки агента. Подготовка локальных виртуальных машин для того, чтобы пользователи могли подключаться к виртуальным машинам Azure после миграции.
> - **Шаг 6. репликация виртуальных машин.** Включение репликации виртуальных машин в Azure.
> - **Шаг 7. Перенос базы данных с помощью службы миграции данных (DMS).** Перенесите базу данных в Azure с помощью службы переноса данных.
> - **Шаг 8. Защита базы данных.** Создание группы доступности AlwaysOn для кластера.
> - **Шаг 9. Миграция виртуальных машин с помощью службы "миграция Azure"** Запустите тестовую отработку отказа, чтобы убедиться, что все работает правильно. Затем выполняется полная отработка отказа в Azure.

## <a name="step-1-prepare-a-sql-server-always-on-availability-group-cluster"></a>Шаг 1. Подготовка кластера группы доступности SQL Server Always On

Администраторы Contoso настраивают кластер следующим образом:

1. Специалисты компании создают две виртуальные машины SQL Server, выбрав образ SQL Server 2017 Enterprise Windows Server 2016 в Azure Marketplace.

    ![SKU виртуальной машины SQL](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-sku.png)

2. В **мастере создания виртуальных машин**  >  **Basics**они настраивают:

    - Имена для виртуальных машин: **SQLAOG1** и **SQLAOG2**.
    - Поскольку компьютеры критически важны для бизнеса, они обеспечивают SSD для типа диска виртуальной машины.
    - Они определяют учетные данные компьютера.
    - Они развертывают виртуальные машины в основном восточном регионе США 2 в группе ресурсов ContosoRG.

3. В разделе **Размер** они запускаются с D2s_V3 SKU для обеих виртуальных машин. Они будут масштабироваться позже, когда потребуется.
4. В разделе **Параметры** выполняются следующие действия.

    - Поскольку эти виртуальные машины являются критическими базами данных для приложения, для них используются управляемые диски.
    - Компьютеры размещаются в производственной сети первичного восточного региона США 2 (**VNET-PROD-EUS2**), в подсети базы данных (**PROD-DB-EUS2**).
    - Для них создается новая группа доступности: **SQLAOGAVSET** с двумя доменами сбоя и пятью доменами обновления.

      ![Виртуальная машина SQL](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-settings.png)

5. В **Параметры SQL Server** они ограничивают возможность подключения SQL к виртуальной сети (закрытой), по умолчанию порт 1433. Для проверки подлинности используются те же учетные данные, что и при использовании onsite (**contosoadmin**).

    ![Виртуальная машина SQL](./media/contoso-migration-rehost-vm-sql-ag/sql-vm-db.png)

**Требуется дополнительная помощь?**

- [Получение справки](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision#1-configure-basic-settings) о подготовке виртуальной машины SQL Server.
- Дополнительные сведения о [настройке виртуальных машин для разных номеров sku SQL Server](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-prereq#create-sql-server-vms).

## <a name="step-2-deploy-and-set-up-the-cluster"></a>Шаг 2. Развертывание и настройка кластера

Вот как администраторы Contoso настраивают кластер:

1. Они настраивают учетную запись хранилища Azure в качестве свидетеля облака.
2. Они добавляют виртуальные машины SQL Server в домен Active Directory в локальном центре данных Contoso.
3. Они создают кластер в Azure.
4. Они настраивают облако-свидетеля.
5. Наконец они включают группы доступности AlwaysOn.

### <a name="set-up-a-storage-account-as-cloud-witness"></a>Настройка учетной записи хранилища как облако-свидетель.

Чтобы настроить облако-свидетеля, Contoso необходима учетная запись Azure Storage, которая будет содержать файл большого двоичного объекта, используемого для арбитража кластера. Эту же учетную запись можно использовать для настройки облака-свидетеля для нескольких кластеров.

Администраторы компании Contoso создают учетную запись хранения следующим образом:

1. Они указывают узнаваемое название для учетной записи (**contosocloudwitness**).
2. Они развертывают общую универсальную учетную запись с LRS.
3. Они размещают учетную запись в третьем регионе: Юго-Центральный регион США. Они размещаются за пределами основного и дополнительного регионов, чтобы она оставалась доступной во время региональных сбоев.
4. Они размещают ее в группе ресурсов, содержащей ресурсы инфраструктуры, **ContosoInfraRG**.

    ![Облако-свидетель](./media/contoso-migration-rehost-vm-sql-ag/witness-storage.png)

5. Когда они создают учетную запись хранения, для нее генерируются первичные и вторичные ключи доступа. Им нужен первичный ключ доступа для создания облака-свидетеля. Под именем учетной записи хранения отобразится ключ > **Ключи доступа**.

    ![Ключ доступа](./media/contoso-migration-rehost-vm-sql-ag/access-key.png)

### <a name="add-sql-server-vms-to-contoso-domain"></a>Добавление виртуальных машин SQL Server в домене Contoso

1. Contoso добавляет SQLAOG1 и SQLAOG2 в домене contoso.com.
2. Затем на каждой виртуальной машине устанавливаются Компоненты и Инструменты отказоустойчивого кластера Windows.

### <a name="set-up-the-cluster"></a>Настройка кластера

Перед настройкой кластера администраторы Contoso создают теневую копию диска операционной системы на каждом компьютере.

![Create snapshot](./media/contoso-migration-rehost-vm-sql-ag/snapshot.png)

1. Затем они запускают скрипт, который они составили для создания отказоустойчивого кластера Windows.

    ![Создание кластера](./media/contoso-migration-rehost-vm-sql-ag/create-cluster1.png)

2. После создания кластера они подтверждают, что виртуальные машины отображаются как узлы кластера.

     ![Создание кластера](./media/contoso-migration-rehost-vm-sql-ag/create-cluster2.png)

### <a name="configure-the-cloud-witness"></a>Настройка облака-свидетеля.

1. Администраторы Contoso настраивают облако-свидетеля с помощью **мастера конфигурации кворума** в диспетчере отказоустойчивости кластеров.
2. В мастере они выбирают создание облачного следящего сервера с учетной записью хранения.
3. После настройки облака-свидетеля, оно отображается в оснастке диспетчера отказоустойчивости кластеров.

    ![Облако-свидетель](./media/contoso-migration-rehost-vm-sql-ag/cloud-witness.png)

### <a name="enable-sql-server-always-on-availability-groups"></a>Включение групп доступности AlwaysOn SQL Server

Теперь администраторы Contoso могут включить Always On:

1. В диспетчере конфигурации SQL Server они включают функцию **Группы доступности AlwaysOn** для службы **SQL Server (MSSQLSERVER)**.

    ![Включение решения Always On](./media/contoso-migration-rehost-vm-sql-ag/enable-always-on.png)

2. Они перезагружают службу, чтобы изменения вступили в силу.

Полсе включения AlwaysOn компания Contoso может настроить группу доступности AlwaysOn, которая защитит базу данных SmartHotel360.

**Требуется дополнительная помощь?**

- [Узнайте об](https://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness) облаке-свидетеле и настройке учетной записи хранения для него.
- [Получите инструкции](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial) для настройки кластера и создания группы доступности.

## <a name="step-3-deploy-the-azure-load-balancer"></a>Шаг 3. Развертывание балансировщика нагрузки Azure

Администраторам Contoso теперь требуется развернуть внутреннюю подсистему балансировки нагрузки перед узлами кластера. Подсистема балансировки нагрузки ожидает передачу данных и направляет ее на соответствующий узел.

![балансировка нагрузки;](./media/contoso-migration-rehost-vm-sql-ag/architecture-lb.png)

Они создают подсистему балансировки нагрузки следующим образом.

1. В портал Azure > **сети**  >  **Load Balancer**, они настроили новый внутренний балансировщик нагрузки: **ilB-ведомо-DB-EUS2-склаог**.
2. Подсистема балансировки нагрузки размещается в производственной сети **VNET-PROD-EUS2**, в подсети базы данных **PROD-DB-EUS2**.
3. Они назначают статический IP-адрес: 10.245.40.100.
4. В качестве сетевого элемента они развертывают балансировщик нагрузки в группе сетевых ресурсов **ContosoNetworkingRG**.

    ![балансировка нагрузки;](./media/contoso-migration-rehost-vm-sql-ag/lb-create.png)

После развертывания внутренней подсистемы балансировки нагрузки им необходимо настроить ее. Они создают пул внутренних адресов, настраивают проверку работоспособности и настраивают правило балансировки нагрузки.

### <a name="add-a-back-end-pool"></a>Добавление серверного пула

Чтобы распределить трафик между виртуальными машинами в кластере, администраторы Contoso настраивают внутренний пул адресов, содержащий IP-адреса сетевых карт для виртуальных машин, которые будут получать сетевой трафик от подсистемы балансировки нагрузки.

1. В параметрах подсистемы балансировки нагрузки на портале Contoso добавляет пул серверной части: **ilB-ведомо-DB-ЕУС-склаог-**".
2. Они сопоставляют пул с группой доступности SQLAOGAVSET. Виртуальные машины в группе (**SQLAOG1** и **SQLAOG2**) добавляются в пул.

    ![Внутренний пул](./media/contoso-migration-rehost-vm-sql-ag/backend-pool.png)

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Администраторы Contoso создают пробу работоспособности, чтобы подсистема балансировки нагрузки могла следить за работоспособностью приложения. Проба динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности.

Они создают пробы следующим образом:

1. В параметрах балансировки нагрузки на портале Contoso создает пробу работоспособности: **SQLAlwaysOnEndPointProbe**.
2. Они устанавливают пробу для мониторинга виртуальных машин на TCP-порте 59999.
3. Они устанавливают интервал 5 секунд между пробами и пороговое значение 2. При сбое двух проб виртуальная машина будет считаться неработоспособной.

    ![Проба](./media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

### <a name="configure-the-load-balancer-to-receive-traffic"></a>Настройка распределителя нагрузки для приема трафика

Теперь администраторы Contoso настраивают правило подсистемы балансировки нагрузки, определяющее, как трафик распределяется между виртуальными машинами.

- Интерфейсный IP-адрес обрабатывает входящий трафик.
- Серверный IP-пул получает трафик.

Они создают правило следующим образом:

1. В параметрах подсистемы балансировки нагрузки на портале они добавляют новое правило: **склалвайсонендпоинтлистенер**.
2. Они устанавливают внешний прослушиватель для получения входящего трафика клиента SQL на TCP-порту 1433.
3. Они определяют внутренний пул, в который будет передаваться трафик, и порт, на котором виртуальные машины ожидают передачи данных трафика.
4. Они включают плавающий IP-адрес (прямой ответ от сервера). Это всегда необходимо для SQL AlwaysOn.

    ![Проба](./media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

**Требуется дополнительная помощь?**

- Ознакомьтесь с [обзором Azure Load Balancer](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview).
- Узнайте [, как создать подсистему балансировки нагрузки](https://docs.microsoft.com/azure/load-balancer/tutorial-load-balancer-basic-internal-portal).

## <a name="step-4-prepare-azure-for-azure-migrate"></a>Шаг 4. Подготовка Azure для миграции Azure

Ниже приведены компоненты Azure Contoso, необходимые для развертывания службы "миграция Azure".

- Виртуальная сеть, в которой будут размещены виртуальные машины, созданные в результате отработки отказа.
- Учетная запись хранения Azure для размещения реплицируемых данных.

Администраторы Contoso настроили их следующим образом:

1. Компания Contoso уже создала сеть или подсеть, которые они могут использовать для миграции Azure при [развертывании инфраструктуры Azure](./contoso-migration-rehost-vm-sql-ag.md).

    - SmartHotel360 — это рабочее приложение, и виртуальная машина будет перенесена в рабочую сеть Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
    - Виртуальная машина будет размещена в группе ресурсов ContosoRG, которая используется для рабочих ресурсов и в рабочей подсети (PROD-FE-EUS2).

2. Администраторы Contoso создают учетную запись хранения (contosovmsacc20180528) в основном регионе Azure.

    - Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS.

## <a name="step-5-prepare-on-premises-vmware-for-azure-migrate"></a>Шаг 5. Подготовка локальной среды VMware для миграции Azure

Ниже перечислены элементы, которые администраторам Contoso необходимо подготовить в локальной среде.

- Учетная запись на сервере vCenter или узле vSphere ESXi для автоматизации обнаружения виртуальных машин.
- Параметры локальных виртуальных машин, чтобы компания Contoso могла подключаться к реплицированным виртуальным машинам Azure после отработки отказа.

### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Службе "миграция Azure" требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины.
- Управлять репликацией, отработкой отказа и восстановлением размещения.
- Требуется по крайней мере учетная запись только для чтения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Администраторы компании Contoso настраивают учетную запись следующим образом:

1. Специалисты компании создают роль на уровне vCenter.
2. Затем они назначают этой роли необходимые разрешения.

### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

После миграции компания Contoso хочет подключиться к виртуальным машинам Azure и разрешить Azure управлять виртуальными машинами. Для этого перед миграцией администраторы компании Contoso выполняют указанные ниже действия.

1. Для доступа через Интернет они делают следующее.

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Проверяют, добавлены ли правила TCP и UDP для профиля **Общедоступный**.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.

2. Для доступа через межсайтовый VPN они делают указанное ниже.

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.
    - Для Windows задайте для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

3. Установите агент для Azure:

    - [Агент Linux для Azure](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux)
    - [Агент Azure для Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-windows)

4. Прочее

   - Для Windows на виртуальной машине не должно быть ожидающих обновлений Windows при активации миграции. Если есть такие обновления, не удастся войти в систему на виртуальной машине до их завершения.
   - После миграции они могут проверить **диагностику загрузки** , чтобы просмотреть снимок экрана виртуальной машины. Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

5. Требуется дополнительная помощь?

   - Дополнительные сведения о [подготовке виртуальных машин к миграции](https://docs.microsoft.com/azure/migrate/contoso-migration-rehost-vm#prepare-vms-for-migration).

## <a name="step-6-replicate-the-on-premises-vms-to-azure"></a>Шаг 6. репликация локальных виртуальных машин в Azure

Чтобы можно было запустить миграцию в Azure, администраторам компании Contoso потребуется настроить и включить репликацию.

По завершении обнаружения можно начать репликацию виртуальных машин VMware в Azure.

1. В проекте службы "Миграция Azure" щелкните **Серверы** и в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) выберите **Репликация**.

    ![Репликация виртуальных машин](./media/contoso-migration-rehost-vm/select-replicate.png)

2. В разделе **Реплицировать** выберите **Параметры исходного кода** > **Ваши компьютеры виртуализированы?** и **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere).

3. В разделе **Локальное устройство** выберите имя устройства Миграции Azure, которое вы настроили, и нажмите кнопку **ОК**.

    ![Параметры источника](./media/contoso-migration-rehost-vm/source-settings.png)

4. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не проводили оценку или не хотите использовать параметры оценки, выберите вариант **Нет**.
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.

    ![Выбор оценки](./media/contoso-migration-rehost-vm/select-assessment.png)

5. В разделе **Виртуальные машины** найдите виртуальные машины и отметьте каждую виртуальную машину, которую вы хотите перенести. Выберите **Next: Целевые параметры**.

6. В разделе **Целевые параметры** выберите подписку и целевой регион, в который вы хотите выполнить миграцию, а также укажите группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.

7. В **преимущество гибридного использования Azure**выберите следующее:

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем нажмите кнопку **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

8. В разделе **Вычисления** просмотрите имя виртуальной машины, размер, тип диска ОС и группу доступности. Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/migrate/migrate-support-matrix-vmware#vmware-requirements).

    - **Размер виртуальной машины:** Если вы используете рекомендации по оценке, раскрывающийся список размер виртуальной машины будет содержать рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. В качестве альтернативы выберите размер вручную в разделе **Размер виртуальной машины Azure**.
    - **Диск ОС:** Укажите диск операционной системы (загрузочный) для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком.
    - **Группа доступности:** Если после миграции виртуальная машина должна находиться в группе доступности Azure, укажите набор. Группа должна находиться в целевой группе ресурсов, которую вы указываете для миграции.

9. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции.

10. В разделе **Review and start replication** (Просмотр и запуск репликации) просмотрите параметры и нажмите кнопку **Реплицировать**, чтобы начать первоначальную репликацию серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

## <a name="step-7-migrate-the-database-with-azure-database-migration-service-dms"></a>Шаг 7. Перенос базы данных с помощью Azure Database Migration Service (DMS)

Администраторы Contoso переходят с помощью служб Azure Database Migration Services (DMS), используя пошаговое [руководство по миграции](https://docs.microsoft.com/azure/dms/tutorial-sql-server-azure-sql-online). Они могут выполнять интерактивные, автономные и гибридные (предварительные) миграции.

В качестве сводки необходимо выполнить следующие действия.

- Создайте Azure Database Migration Service (DMS) с `Premium` номером SKU, подключенным к виртуальной сети.
- Убедитесь, что Azure Database Migration Service (DMS) имеет доступ к удаленным SQL Server через виртуальную сеть. Это гарантирует, что все входящие порты будут разрешены в Azure для SQL Server на уровне виртуальной сети, в сети VPN и на компьютере, на котором размещается SQL Server.
- Настройте Azure Database Migration Service.
  - Создайте проект миграции.
  - Добавьте источник (локальная база данных).
  - Выберите целевой объект.
  - Выберите базы данных для миграции.
  - Настройка дополнительных параметров.
  - Запустите репликацию.
  - Устраните возможные ошибки.
  - Выполните окончательный прямую миграцию.

## <a name="step-8-protect-the-database-with-always-on"></a>Шаг 8. Защита базы данных с помощью Always On

Обеспечив выполнение базы данных приложения на виртуальной машине **SQLAOG1**, администраторы Contoso теперь могут защитить ее с помощью групп доступности AlwaysOn. Они настраивают AlwaysOn с помощью SQL Management Studio, а затем назначают слушателя с использованием кластеризации Windows.

### <a name="create-an-always-on-availability-group"></a>Создание группы доступности AlwaysOn

1. В SQL Management Studio они щелкают правой кнопкой мыши **Всегда на высокой доступности**, чтобы запустить **мастер создания группы доступности**.
2. В **Указание параметров**, они указывают название группы доступности **SHAOG**. В разделе **Выбор баз данных** они выбирают базу данных SmartHotel360.

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-1.png)

3. В **Выбор реплик**, они добавляют два узла SQL как реплики доступности и настраивают их для обеспечения автоматической отработки отказа с синхронной фиксацией.

     ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-2.png)

4. Они настраивают прослушиватель для группы (**SHAOG**) и порт. IP-адрес внутренней подсистемы балансировки нагрузки добавляется как статический IP-адрес (10.245.40.100).

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-3.png)

5. В **Выбор синхронизации данных**, они включают автоматическое заполнение. С помощью этой опции SQL Server автоматически создает вторичные реплики для каждой базы данных в группе, поэтому Contoso не нужно вручную создавать резервные копии и восстанавливать их. После проверки создается группа доступности.

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-4.png)

6. У Contoso возникли проблемы при создании группы. Они не используют встроенную систему безопасности Windows Active Directory и поэтому должны предоставить разрешения для входа в SQL для создания ролей отказоустойчивого кластера Windows.

    ![Группа доступности AlwaysOn](./media/contoso-migration-rehost-vm-sql-ag/aog-5.png)

7. После создания группы Contoso может увидеть ее в SQL Management Studio.

### <a name="configure-a-listener-on-the-cluster"></a>Настройка прослушивателя в кластере

В качестве последнего этапа настройки развертывания SQL администраторы Contoso настраивают внутреннюю подсистему балансировки нагрузки как прослушиватель в кластере и переводят прослушиватель в оперативный режим. Для этого они используют сценарий.

![Прослушиватель кластера](./media/contoso-migration-rehost-vm-sql-ag/cluster-listener.png)

### <a name="verify-the-configuration"></a>Проверка конфигурации

Теперь, когда все настроено, у компании Contoso есть действующая группа доступности в Azure, использующая перенесенную базу данных. Администраторы проверяют это, подключившись к внутренней подсистеме балансировки нагрузки в SQL Management Studio.

![Подключение ILB](./media/contoso-migration-rehost-vm-sql-ag/ilb-connect.png)

**Требуется дополнительная помощь?**

- Дополнительные сведения о создании [группы доступности](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#create-the-availability-group) и [прослушивателя](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#configure-listener).
- [Настройка использования IP-адреса балансировщика нагрузки для кластера](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener#configure-the-cluster-to-use-the-load-balancer-ip-address) вручную.
- Дополнительные сведения о [создании и использовании SAS](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2).

## <a name="step-9-migrate-the-vm-with-azure-migrate"></a>Шаг 9. Миграция виртуальной машины с помощью службы "миграция Azure"

Администраторы Contoso выполняют быструю тестовую отработку отказа, а затем — миграцию виртуальной машины.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Тестовая отработка отказа позволяет убедиться перед миграцией в том, что все работает как надо.

1. Они выполняют тестовую отработку отказа до последней доступной точки во времени (**Последняя обработанная**).
2. Прежде чем **начать отработку отказа, выберите завершить работу компьютера**, чтобы служба Azure Migrate попыталась завершить работу исходной виртуальной машины перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить.
3. При тестировании отработки отказа происходит следующее:

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; Если выбрать последнюю точку восстановления, на основе данных будет создана точка восстановления.
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

4. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Специалисты убеждаются, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
5. После проверки они удаляют результаты отработки отказа, записывают и сохраняют все наблюдения.

### <a name="run-a-failover"></a>Запуск отработки отказа

1. Убедившись, что тестовая отработка отказа выполнена правильно, администраторы Contoso составляют план восстановления для миграции и добавляют к нему WEBVM.

     ![План восстановления](./media/contoso-migration-rehost-vm-sql-ag/recovery-plan.png)

2. Специалисты компании выполняют для этого плана отработку отказа. Они выбирают последнюю точку восстановления и указывают, что служба "миграция Azure" должна попытаться завершить работу локальной виртуальной машины перед активацией отработки отказа.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover1.png)

3. После отработки отказа специалисты компании проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![План восстановления](./media/contoso-migration-rehost-vm-sql-ag/failover2.png)

4. После проверки виртуальной машины в Azure они завершат миграцию, чтобы завершить процесс миграции, приостановили репликацию для виртуальной машины и приостановили выставление счетов на миграцию Azure для виртуальной машины.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

На последнем этапе миграции администраторы Contoso обновляют строку подключения приложения, чтобы указать на перенесенную базу данных, запущенную в прослушивателе SHAOG. Эта конфигурация будет изменяться на WEBVM, который теперь работает в Azure. Эта конфигурация находится в файле web.config приложения ASP.

1. Нахождение файла по адресу `C:\inetpub\SmartHotelWeb\web.config` . Измените имя сервера, чтобы указать полное доменное имя AOG: shaog.contoso.com.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover4.png)

2. После обновления файла и его сохранения они перезапускают IIS на WEBVM. Это делается с помощью `iisreset /restart` из командной строки.
3. После перезапуска IIS приложение использует базу данных, выполняющуюся на управляемом экземпляре SQL.

**Требуется дополнительная помощь?**

- Дополнительные сведения о [выполнении тестовой отработки отказа](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure).
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- Сведения об [отработки отказа в Azure](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover).

### <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции приложения SmartHotel360, которое выполнялось на виртуальной машине Azure, база данных SmartHotel360 находится на кластере SQL Azure.

Теперь специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновить внутренние документы и отразить в них новое расположение и IP-адреса виртуальных машин.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.
- Добавьте две новые виртуальные машины (SQLAOG1 и SQLAOG2), которые необходимо добавить в системы контроля производства.

### <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Специалисты по безопасности компании Contoso проверяют виртуальные машины Azure, WEBVM, SQLAOG1 и SQLAOG2, чтобы выявить любые проблемы безопасности.

- Чтобы можно было управлять доступом, команда проверяет группы безопасности сети (NSG) для виртуальной машины. NSG позволяют пропускать только разрешенный для приложения трафик.
- Команда рассматривает возможность защиты данных на диске с использованием функций шифрования дисков Azure и Key Vault.
- Команда должна оценить прозрачное шифрование данных (TDE), а затем включить его в базе данных SmartHotel360, работающей на новой виртуальной машине SQL AOG. [Подробнее](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017).

Дополнительные сведения см. в статье рекомендации [по обеспечению безопасности для рабочих нагрузок IaaS в Azure](https://docs.microsoft.com/azure/security/fundamentals/iaas).

## <a name="business-continuity-and-disaster-recovery"></a>Непрерывность бизнес-процессов и аварийное восстановление

Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление (BCDR), Contoso выполняет следующие действия:

- Для защиты данных компания Contoso создает резервные копии данных на виртуальных машинах WEBVM, SQLAOG1 и SQLAOG2 с помощью службы Azure Backup. [Подробнее](https://docs.microsoft.com/azure/backup/backup-overview).
- Сотрудники Contoso также научаться использовать службу хранилища Azure для резервного копирования SQL Server непосредственно в хранилище BLOB-объектов. [Подробнее](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-use-storage-sql-server-backup-restore).
- Чтобы приложения продолжали работать, компания Contoso реплицирует виртуальные машины приложений в Azure в дополнительный регион с помощью Site Recovery. [Подробнее](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- У компании Contoso имеются лицензии на виртуальные машины WEBVM, и она воспользуется Преимуществом гибридного использования Azure. Contoso преобразует имеющиеся виртуальные машины Azure, чтобы использовать льготные расценки.
- Contoso будет использовать службу " [Управление затратами Azure](https://azure.microsoft.com/services/cost-management) ", чтобы убедиться, что они находятся в бюджете, УСТАНОВЛЕНном ИТ – лидером.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso повторно размещает приложение SmartHotel360 в Azure, переключая клиентскую виртуальную машину приложения в Azure с помощью службы "миграция Azure". Компания Contoso перенеса базу данных приложений в кластер SQL Server, подготовленный в Azure с помощью Azure Database Migration Service, и защитил его в группе доступности SQL Server Always On.
