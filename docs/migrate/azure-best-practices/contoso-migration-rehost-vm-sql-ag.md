---
title: Повторное размещение приложения путем его переноса на виртуальные машины Azure и в группы доступности SQL Server AlwaysOn
titleSuffix: Microsoft Cloud Adoption Framework for Azure
description: Узнайте, как компания Contoso повторно размещает локальное приложение, перемещая его на виртуальные машины Azure и в группы доступности SQL Server AlwaysOn
author: BrianBlanchard
ms.author: brblanch
ms.date: 10/11/2018
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: site-recovery
ms.openlocfilehash: fbcb06b671b13b48fe5063e5efd8ba72c3071667
ms.sourcegitcommit: 443c28f3afeedfbfe8b9980875a54afdbebd83a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "71024335"
---
# <a name="rehost-an-on-premises-app-on-azure-vms-and-sql-server-always-on-availability-group"></a>Повторное размещение локального приложения на виртуальных машинах Azure и в группе доступности SQL Server AlwaysOn

В этой статье показано, как вымышленная компания Contoso повторно размещает двухуровневое приложение .NET для Windows, работающее на виртуальных машинах VMware, в процессе миграции на платформу Azure. Компания Contoso переносит интерфейсную виртуальную машину приложения на виртуальную машину Azure, а базу данных приложений — на виртуальную машину SQL Server в Azure, запущенную в отказоустойчивом кластере Windows Server с группами доступности SQL Server AlwaysOn.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Адаптация к расширению бизнеса.** По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуры.
- **Повышение эффективности**. Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости.** ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования. Он не должен становиться помехой для бизнеса.
- **Масштабирование.** По мере успешного роста бизнеса ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

- После миграции в Azure приложение должно работать так же эффективно, как оно работает в VMWare. В облаке приложение будет играть такую же критически важную роль, как и в локальной среде.
- Contoso не считает нужным вкладывать средства в это приложение. Оно важно для бизнеса, но компании Contoso просто нужно безопасно переместить его в облако в его текущей форме.
- В локальной базе данных для приложения были проблемы с доступностью. Специалисты Contoso хотели бы развернуть ее в Azure в качестве кластера с высокой степенью доступности и возможностью отработки отказа.
- Компания Contoso планирует провести обновление текущей платформы SQL Server 2008 R2 до SQL Server 2017.
- Компания Contoso не хочет использовать базу данных SQL Azure для этого приложения и ищет альтернативы.

## <a name="solution-design"></a>Архитектура решения

Определив свои цели и требования, специалисты компании Contoso начинают разработку и анализ решения для развертывания и планируют процесс миграции, включая службы Azure, которые будут использоваться в ходе этой миграции.

### <a name="current-architecture"></a>Текущая архитектура

- Приложение разбито на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на узле VMware ESXi **contosohost1.contoso.com** (версии 6.5).
- Средой VMware управляет сервер vCenter Server 6.5 (**vcenter.contoso.com**), который запущен на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).

### <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Contoso перенесет интерфейсную виртуальную машину WEBVM приложения на виртуальную машину IaaS Azure.
  - Интерфейсная виртуальная машина в Azure будет развернута в группе ресурсов ContosoRG, которая используется для рабочих ресурсов.
  - Она будет находиться в рабочей среде Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
- База данных приложения будет перенесена на виртуальную машину SQL Server в Azure.
  - Она будет располагаться в сети баз данных Azure компании Contoso (PROD-DB-EUS2) в основном регионе "Восточная часть США 2".
  - Она будет помещена в отказоустойчивый кластер Windows Server с двумя узлами, использующий группы доступности SQL Server AlwaysOn.
  - В Azure два узла виртуальных машин SQL Server из кластера будут развернуты в группе ресурсов ContosoRG.
  - Узлы виртуальных машин будут находиться в рабочей среде Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
  - Виртуальные машины работают Windows Server 2016 с SQL Server 2017 г Enterprise Edition. У Contoso нет лицензий для этой операционной системы, поэтому специалисты компании будут использовать образ из Azure Marketplace, предоставляющий лицензию в качестве платежа для своих обязательств Azure EA.
  - Помимо уникальных имен обе виртуальные машины используют те же параметры.
- В компании Contoso будет развернута внутренняя подсистема балансировки нагрузки, которая прослушивает трафик в кластере и направляет его в соответствующий узел кластера.
  - Внутренний распределитель нагрузки будет развернут в ContosoNetworkingRG (используется для сетевых ресурсов).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](media/contoso-migration-rehost-vm-sql-ag/architecture.png)

### <a name="database-considerations"></a>Рекомендации по базе данных

В ходе проектирования решения специалисты Contoso сравнили функции Базы данных Azure SQL и SQL Server. На принятие решения об использовании виртуальной машины Azure по модели IaaS под управлением SQL Server повлияли следующие соображения:

- Использование виртуальной машины Azure под управлением SQL Server выглядит оптимальным решением, если нужно настроить операционную систему или сервер базы данных либо использовать сторонние приложения на той же виртуальной машине.
- Используя Помощник по миграции данных, компания Contoso может легко получать доступ к базе данных SQL Azure и выполнять миграцию в нее.

### <a name="solution-review"></a>Проверка решения

Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

<!-- markdownlint-disable MD033 -->

**Рассмотрение** | **Сведения**
--- | ---
**Преимущества** | Интерфейс WEBVM будет перемещен в Azure без изменений, упрощая миграцию.<br/><br/> Уровень SQL Server будет работать под управлением SQL Server 2017 и Windows Server 2016. Это позволяет прекратить использование операционной системы Windows Server 2008 R2, а SQL Server 2017 соответствует техническим требованиям и целям компании Contoso. Обеспечивается 100-процентная совместимость, и в то же время прекращается использование SQL Server 2008 R2.<br/><br/> Contoso может воспользоваться преимуществами своих инвестиций в программу Software Assurance, используя Преимущество гибридного использования Azure.<br/><br/> Развертывание SQL Server с высоким уровнем доступности в Azure обеспечивает отказоустойчивость, благодаря чему уровень данных приложения больше не является единственной точкой отработки отказа.
**Недостатки** | WEBVM работает под управлением Windows Server 2008 R2. Операционная система поддерживается средой Azure для определенных ролей (июль 2018 г.). [Узнайте больше](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines).<br/><br/> Веб-уровень приложения останется единственной точкой отработки отказа.<br/><br/> Компании Contoso потребуется и дальше поддерживать веб-уровень как виртуальную машину Azure, а не переходить на управляемую службу, такую как Служба приложений Azure.<br/><br/> С помощью выбранного решения компании Contoso потребуется и дальше управлять двумя виртуальными машинами SQL Server, а не переходить на управляемую платформу, такую как управляемый экземпляр Базы данных SQL Azure. Кроме того, в рамках программы Software Assurance компания Contoso может обменять свои имеющиеся лицензии на сниженные тарифы при использовании управляемого экземпляра Базы данных SQL Azure.

<!-- markdownlint-enable MD033 -->

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Помощник по миграции данных](/sql/dma/dma-overview?view=ssdt-18vs2017) | DMA работает на локальном компьютере с SQL Server и переносит базу данных через VPN типа "сеть-сеть" в Azure. | DMA — это бесплатный инструмент, доступный для скачивания.
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery) | Site Recovery организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов. | Во время репликации в Azure взимается плата за службу хранилища Azure. При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительные сведения о ценах см. на [этой странице](https://azure.microsoft.com/pricing/details/site-recovery).

## <a name="migration-process"></a>Процесс миграции

Администраторы Contoso перенесут виртуальные машины приложения в Azure.

- Специалисты компании перенесут интерфейсную виртуальную машину на виртуальную машину Azure с помощью Site Recovery.
  - В качестве первого шага они подготовят и настроят компоненты Azure , а также подготовят локальную инфраструктуру VMware.
  - После завершения подготовки они смогут начать репликацию виртуальных машин.
  - После того как репликация будет включена и начнет работать, они перенесут виртуальную машину путем отработки отказа в Azure.
- Они перенесут базу данных в кластер SQL Server в Azure, используя Помощник по миграции данных (DMA).
  - В качестве первого шага специалистам компании необходимо будет предоставить виртуальные машины SQL Server в Azure, настроить кластер и подсистему балансировки нагрузки и настроить группы доступности AlwaysOn.
  - При этом они могут переносить базу данных
- После переноса они активируют защиту AlwaysOn для базы данных.

![Процесс миграции](media/contoso-migration-rehost-vm-sql-ag/migration-process.png)

## <a name="prerequisites"></a>Предварительные требования

Ниже указано, что необходимо сделать компании Contoso в этом сценарии.

<!-- markdownlint-disable MD033 -->

**Требования** | **Сведения**
--- | ---
**Подписка Azure.** | Специалисты Contoso уже создали подписку в более ранней статье из этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](https://docs.microsoft.com/azure/site-recovery/site-recovery-role-based-linked-access-control).
**Инфраструктура Azure** | [Узнайте, как](./contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure.<br/><br/> Просмотрите дополнительные сведения о конкретных требованиях к [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилищу](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) для Site Recovery.
**Site Recovery (локальный экземпляр)** | Потребуется локальный сервер vCenter Server версии 5.5, 6.0 или 6.5.<br/><br/> Узел ESXi под управлением версии 5.5, 6.0 или 6.5.<br/><br/> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi.<br/><br/> Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).<br/><br/> Поддерживаемая конфигурация [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилища](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage).<br/><br/> Виртуальные машины, которые необходимо реплицировать, должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).

<!-- markdownlint-enable MD033 -->

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Подготовка кластера.** Создание кластера для развертывания двух узлов виртуальных машин SQL Server в Azure.
> - **Шаг 2. Развертывание и настройка кластера.** Подготовка кластера Azure SQL Server. Базы данных переносятся в этот имеющийся кластер.
> - **Шаг 3. Развертывание подсистемы балансировки нагрузки.** Развертывание подсистемы для балансировки трафика на узлы SQL Server.
> - **Шаг 4. Подготовка Azure для Site Recovery.** Создание учетной записи хранения в Azure для хранения реплицируемых данных, а также хранилища Служб восстановления.
> - **Шаг 5. Подготовка локальных ресурсов VMware для Site Recovery.** Подготовка учетных записей для обнаружения виртуальных машин и установки агента. Подготовка локальных виртуальных машин для того, чтобы пользователи могли подключаться к виртуальным машинам Azure после миграции.
> - **Шаг 6. Репликация виртуальных машин.** Включение репликации виртуальных машин в Azure.
> - **Шаг 7. Установка DMA.** Скачивание и установка Помощника по миграции данных.
> - **Шаг 7. Перенос данных с помощью DMA.** Миграция базы данных в Azure.
> - **Шаг 9. Защита базы данных.** Создание группы доступности AlwaysOn для кластера.
> - **Шаг 10. Миграция виртуальной машины веб-приложения.** Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов. Затем выполняется полная отработка отказа в Azure.

## <a name="step-1-prepare-a-sql-server-always-on-availability-group-cluster"></a>Шаг 1. Подготовка кластера группы доступности SQL Server AlwaysOn

Администраторы Contoso настраивают кластер следующим образом:

1. Специалисты компании создают две виртуальные машины SQL Server, выбрав образ SQL Server 2017 Enterprise Windows Server 2016 в Azure Marketplace.

    ![SKU виртуальной машины SQL](media/contoso-migration-rehost-vm-sql-ag/sql-vm-sku.png)

2. В **Создание мастера виртуальной машины** > **Базовый** они настраивают:

    - Имена для виртуальных машин. **SQLAOG1** и **SQLAOG2**.
    - Поскольку компьютеры критически важны для бизнеса, они обеспечивают SSD для типа диска виртуальной машины.
    - Они определяют учетные данные компьютера.
    - Они развертывают виртуальные машины в основном восточном регионе США 2 в группе ресурсов ContosoRG.

3. В разделе **Размер** они запускаются с D2s_V3 SKU для обеих виртуальных машин. Они будут масштабироваться позже, когда потребуется.
4. В разделе **Параметры** выполняются следующие действия.

    - Поскольку эти виртуальные машины являются критическими базами данных для приложения, для них используются управляемые диски.
    - Компьютеры размещаются в производственной сети первичного восточного региона США 2 (**VNET-PROD-EUS2**), в подсети базы данных (**PROD-DB-EUS2**).
    - Для них создается новая группа доступности. **SQLAOGAVSET** с двумя доменами сбоя и пятью доменами обновления.

      ![Виртуальная машина SQL](media/contoso-migration-rehost-vm-sql-ag/sql-vm-settings.png)

5. В **Параметры SQL Server** они ограничивают возможность подключения SQL к виртуальной сети (закрытой), по умолчанию порт 1433. Для проверки подлинности они используют те же учетные данные, что и на месте (**contosoadmin**).

    ![ВМ SQL](media/contoso-migration-rehost-vm-sql-ag/sql-vm-db.png)

**Нужна дополнительная помощь?**

- [Получение справки](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision#1-configure-basic-settings) о подготовке виртуальной машины SQL Server.
- [Дополнительные сведения о](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-prereq#create-sql-server-vms) настройке виртуальных машин для различных номеров SKU SQL Server.

## <a name="step-2-deploy-and-set-up-the-cluster"></a>Шаг 2. Развертывание и настройка кластера

Вот как администраторы Contoso настраивают кластер:

1. Они настраивают учетную запись хранилища Azure в качестве свидетеля облака.
2. Они добавляют виртуальные машины SQL Server в домен Active Directory в локальном центре данных Contoso.
3. Они создают кластер в Azure.
4. Они настраивают облако-свидетеля.
5. Наконец они включают группы доступности AlwaysOn.

### <a name="set-up-a-storage-account-as-cloud-witness"></a>Настройка учетной записи хранилища как облако-свидетель.

Чтобы настроить облако-свидетеля, Contoso необходима учетная запись Azure Storage, которая будет содержать файл большого двоичного объекта, используемого для арбитража кластера. Эту же учетную запись можно использовать для настройки облака-свидетеля для нескольких кластеров.

Администраторы компании Contoso создают учетную запись хранения следующим образом:

1. Они указывают узнаваемое название для учетной записи (**contosocloudwitness**).
2. Они развертывают общую универсальную учетную запись с LRS.
3. Они размещают учетную запись в третьем регионе — центрально-южной части США. Они размещают его за пределами первичного и вторичного регионов, чтобы они оставались доступными в случае регионального отказа.
4. Они размещают ее в группе ресурсов, содержащей ресурсы инфраструктуры, **ContosoInfraRG**.

    ![Облако-свидетель](media/contoso-migration-rehost-vm-sql-ag/witness-storage.png)

5. Когда они создают учетную запись хранения, для нее генерируются первичные и вторичные ключи доступа. Им нужен первичный ключ доступа для создания облака-свидетеля. Под именем учетной записи хранения отобразится ключ > **Ключи доступа**.

    ![Ключ доступа](media/contoso-migration-rehost-vm-sql-ag/access-key.png)

### <a name="add-sql-server-vms-to-contoso-domain"></a>Добавление виртуальных машин SQL Server в домене Contoso

1. Contoso добавляет SQLAOG1 и SQLAOG2 в домене contoso.com.
2. Затем на каждой виртуальной машине устанавливаются Компоненты и Инструменты отказоустойчивого кластера Windows.

### <a name="set-up-the-cluster"></a>Настройка кластера

Перед настройкой кластера администраторы Contoso создают теневую копию диска операционной системы на каждом компьютере.

![snapshot](media/contoso-migration-rehost-vm-sql-ag/snapshot.png)

1. Затем они запускают скрипт, который они составили для создания отказоустойчивого кластера Windows.

    ![Создание кластера](media/contoso-migration-rehost-vm-sql-ag/create-cluster1.png)

2. После создания кластера они подтверждают, что виртуальные машины отображаются как узлы кластера.

     ![Создание кластера](media/contoso-migration-rehost-vm-sql-ag/create-cluster2.png)

## <a name="configure-the-cloud-witness"></a>Настройка облака-свидетеля.

1. Администраторы Contoso настраивают облако-свидетеля с помощью **мастера конфигурации кворума** в диспетчере отказоустойчивости кластеров.
2. В мастере они выбирают создание облака-свидетеля с учетной записью хранения.
3. После настройки облака-свидетеля, оно отображается в оснастке диспетчера отказоустойчивости кластеров.

    ![Облако-свидетель](media/contoso-migration-rehost-vm-sql-ag/cloud-witness.png)

### <a name="enable-sql-server-always-on-availability-groups"></a>Включение групп доступности AlwaysOn SQL Server

Теперь администраторы Contoso могут включить Always On:

1. В диспетчере конфигурации SQL Server они включают функцию **Группы доступности AlwaysOn** для службы **SQL Server (MSSQLSERVER)** .

    ![Включение решения Always On](media/contoso-migration-rehost-vm-sql-ag/enable-alwayson.png)

2. Они перезагружают службу, чтобы изменения вступили в силу.

Полсе включения AlwaysOn компания Contoso может настроить группу доступности AlwaysOn, которая защитит базу данных SmartHotel360.

**Нужна дополнительная помощь?**

- [Узнайте об](https://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness) облаке-свидетеле и настройке учетной записи хранения для него.
- [Получите инструкции](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial) для настройки кластера и создания группы доступности.

## <a name="step-3-deploy-the-azure-load-balancer"></a>Шаг 3. Развертывание Azure Load Balancer

Администраторам Contoso необходимо развернуть внутреннюю подсистему балансировки нагрузки, расположенную перед узлами кластера. Подсистема балансировки нагрузки ожидает передачу данных и направляет ее на соответствующий узел.

![Балансировка нагрузки](media/contoso-migration-rehost-vm-sql-ag/architecture-lb.png)

Они создают подсистему балансировки нагрузки следующим образом.

1. На портале Azure они выбирают **Сеть** > **Load Balancer** и настраивают новую внутреннюю подсистему балансировки нагрузки: **ILB-PROD-DB-EUS2-SQLAOG**.
2. Подсистема балансировки нагрузки размещается в производственной сети **VNET-PROD-EUS2**, в подсети базы данных **PROD-DB-EUS2**.
3. Они назначают статический IP-адрес: 10.245.40.100.
4. В качестве сетевого элемента они развертывают балансировщик нагрузки в группе сетевых ресурсов **ContosoNetworkingRG**.

    ![Балансировка нагрузки](media/contoso-migration-rehost-vm-sql-ag/lb-create.png)

После развертывания внутренней подсистемы балансировки нагрузки им необходимо настроить ее. Они создают внутренний пул адресов, настраивают пробу работоспособности и правило балансировки нагрузки.

### <a name="add-a-back-end-pool"></a>Добавление серверного пула

Чтобы распределить трафик между виртуальными машинами в кластере, администраторы Contoso настраивают внутренний пул адресов, содержащий IP-адреса сетевых карт для виртуальных машин, которые будут получать сетевой трафик от подсистемы балансировки нагрузки.

1. В параметрах подсистемы балансировки нагрузки на портале специалисты Contoso добавляют внутренний пул. **ILB-PROD-DB-EUS-SQLAOG-BEPOOL**.
2. Они сопоставляют пул с группой доступности SQLAOGAVSET. Виртуальные машины в группе (**SQLAOG1** и **SQLAOG2**) добавляются в пул.

    ![Внутренний пул](media/contoso-migration-rehost-vm-sql-ag/backend-pool.png)

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Администраторы Contoso создают пробу работоспособности, чтобы подсистема балансировки нагрузки могла следить за работоспособностью приложения. Проба динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности.

Они создают пробы следующим образом:

1. В параметрах подсистемы балансировки нагрузки на портале Contoso создает пробу работоспособности. **SQLAlwaysOnEndPointProbe**.
2. Они устанавливают пробу для мониторинга виртуальных машин на TCP-порте 59999.
3. Они устанавливают интервал 5 секунд между пробами и пороговое значение 2. При сбое двух проб виртуальная машина будет считаться неработоспособной.

    ![Проба](media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

### <a name="configure-the-load-balancer-to-receive-traffic"></a>Настройка распределителя нагрузки для приема трафика

Теперь администраторы Contoso настраивают правило подсистемы балансировки нагрузки, определяющее, как трафик распределяется между виртуальными машинами.

- Интерфейсный IP-адрес обрабатывает входящий трафик.
- Серверный IP-пул получает трафик.

Они создают правило следующим образом:

1. В параметрах подсистемы балансировки нагрузки на портале они добавляют новые правила балансировки нагрузки. **SQLAlwaysOnEndPointListener**.
2. Они устанавливают внешний прослушиватель для получения входящего трафика клиента SQL на TCP-порту 1433.
3. Они определяют внутренний пул, в который будет передаваться трафик, и порт, на котором виртуальные машины ожидают передачи данных трафика.
4. Они включают плавающий IP-адрес (прямой ответ от сервера). Это всегда необходимо для SQL AlwaysOn.

    ![Проба](media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

**Нужна дополнительная помощь?**

- [Ознакомление с общими сведениями](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview) об Azure Load Balancer.
- [Дополнительные сведения о](https://docs.microsoft.com/azure/load-balancer/tutorial-load-balancer-basic-internal-portal) создании подсистем балансировки нагрузки.

## <a name="step-4-prepare-azure-for-the-site-recovery-service"></a>Шаг 4. Подготовка Azure для службы Site Recovery

Ниже перечислены компоненты Azure, которые необходимы для развертывания Site Recovery.

- Виртуальная сеть, в которой будут размещены виртуальные машины, созданные в результате отработки отказа.
- Учетная запись хранения Azure для размещения реплицируемых данных.
- хранилище служб восстановления в Azure.

Администраторы Contoso настроили их следующим образом:

1. В процессе [развертывания инфраструктуры Azure](./contoso-migration-rehost-vm-sql-ag.md) специалисты компании Contoso уже создали сеть/подсеть, которую они могут использовать для Site Recovery.

    - SmartHotel360 — это рабочее приложение, и виртуальная машина будет перенесена в рабочую сеть Azure (VNET-PROD-EUS2) в основном регионе "Восточная часть США 2".
    - Виртуальная машина будет размещена в группе ресурсов ContosoRG, которая используется для рабочих ресурсов и в рабочей подсети (PROD-FE-EUS2).

2. Администраторы Contoso создают учетную запись хранения (contosovmsacc20180528) в основном регионе Azure.

    - Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS.
    - Учетная запись должна находиться в том же регионе, что и хранилище.

      ![Хранилище Site Recovery](media/contoso-migration-rehost-vm-sql-ag/asr-storage.png)

3. Специалисты компании Сontoso настроили сеть и учетную запись хранения. Теперь они создают хранилище служб восстановления (**ContosoMigrationVault**) и размещают его в группе ресурсов **ContosoFailoverRG** в основном регионе East US 2 (Восток США 2).

    ![Хранилище служб восстановления](media/contoso-migration-rehost-vm-sql-ag/asr-vault.png)

**Нужна дополнительная помощь?**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) о настройке Azure для Site Recovery.

## <a name="step-5-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 5. Подготовка локальных ресурсов VMware для Site Recovery

Ниже перечислены элементы, которые администраторам Contoso необходимо подготовить в локальной среде.

- Учетная запись на сервере vCenter или узле vSphere ESXi для автоматизации обнаружения виртуальных машин.
- Учетная запись для автоматической установки службы Mobility Service на каждой виртуальной машине, которую требуется реплицировать.
- Параметры локальных виртуальных машин, чтобы компания Contoso могла подключаться к реплицированным виртуальным машинам Azure после отработки отказа.

### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины.
- Управлять репликацией, отработкой отказа и восстановлением размещения.
- Требуется по крайней мере учетная запись только для чтения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Администраторы компании Contoso настраивают учетную запись следующим образом:

1. Специалисты компании создают роль на уровне vCenter.
2. Затем они назначают этой роли необходимые разрешения.

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Необходимо установить Mobility Service на каждой виртуальной машине.

- Site Recovery может автоматически принудительно устанавливать этот компонент при включении репликации для виртуальной машины.
- Для принудительной установки необходима учетная запись, которую Site Recovery сможет использовать для доступа к виртуальной машине. Укажите эту учетную запись при настройке репликации в консоли Azure.
- Учетная запись может относиться к домену или быть локальной; у нее должны быть разрешения на установку программного обеспечения на виртуальных машинах.

### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

После отработки отказа компании Contoso потребуется подключаться к виртуальным машинам Azure. Для этого перед миграцией администраторы компании Contoso выполняют указанные ниже действия.

1. Для доступа через Интернет они делают указанное ниже.

   - Перед отработкой отказа включают RDP на локальной виртуальной машине.
   - Проверяют, добавлены ли правила TCP и UDP для профиля **Общедоступный**.
   - Проверяют, разрешен ли RDP в разделе **Брандмауэр Windows** > **Разрешенные приложения** для всех профилей.

2. Для доступа через межсайтовый VPN они делают указанное ниже.

   - Включают RDP на локальной машине.
   - Разрешают RDP в разделе **Брандмауэр Windows** -> **Разрешенные приложения и компоненты** для **доменных и частных** сетей.
   - Задают для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

Кроме того, при запуске отработки отказа им необходимо проверить указанные ниже аспекты.

- При запуске отработки отказа на виртуальной машине не должно быть обновлений Windows, ожидающих установки. Если такие обновления имеются, пользователи не смогут входить в систему на виртуальной машине до завершения обновления.
- После отработки отказа специалисты компании могут просмотреть снимок экрана виртуальной машины в разделе **Диагностика загрузки**. Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

**Нужна дополнительная помощь?**

- Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) о создании и назначении роли для автоматического обнаружения.
- Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) о создании учетной записи для принудительной установки службы Mobility Service.

## <a name="step-6-replicate-the-on-premises-vms-to-azure-with-site-recovery"></a>Шаг 6. Репликация локальных виртуальных машин в Azure с помощью Site Recovery

Чтобы можно было запустить миграцию в Azure, администраторам Contoso потребуется настроить и включить репликацию.

### <a name="set-a-replication-goal"></a>Выбор цели репликации

1. В хранилище в разделе с именем хранилища (ContosoVMVault) специалисты компании выбирают цель репликации (**Начало работы** > **Site Recovery** > **Подготовка инфраструктуры**.
2. Они указывают, что их машины расположены в локальной среде, работают в VMware, и их необходимо реплицировать в Azure.

    ![Цель репликации](./media/contoso-migration-rehost-vm-sql-ag/replication-goal.png)

### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Для продолжения они должны подтвердить, что они завершили планирование развертывания. Для этого им необходимо щелкнуть пункт **Да, выполнено**. В этом сценарии компания Contoso переносит только виртуальную машину, поэтому ей не нужно планировать развертывание.

### <a name="set-up-the-source-environment"></a>Настройка исходной среды

Теперь администраторы Contoso должны настроить свою исходную среду. Для этого специалисты скачивают шаблон OVF и с его помощью развертывают сервер конфигурации Site Recovery в качестве локальной виртуальной машины VMware с высокой доступностью. После настройки и запуска сервера конфигурации сотрудники компании должны зарегистрировать его в хранилище.

На сервере конфигурации выполняется несколько компонентов.

- Компонент сервера конфигурации, который используется для координации обмена данными между локальным источником и Azure, а также для управления репликацией данных.
- Сервер обработки, который действует как шлюз репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.

Администраторы Contoso делают это следующим образом:

1. В хранилище они скачивают шаблон OVF в разделе **Подготовка инфраструктуры** > **Источник** > **Сервер конфигурации**.

    ![Скачивание OVF](./media/contoso-migration-rehost-vm-sql-ag/add-cs.png)

2. Они импортируют шаблон в VMware, чтобы создать и развернуть виртуальную машину.

    ![Шаблон OVF](./media/contoso-migration-rehost-vm-sql-ag/vcenter-wizard.png)

3. При первом включении виртуальная машина загружается в среду установки Windows Server 2016. Специалисты компании принимают условия лицензионного соглашения и вводят пароль администратора.
4. После установки они входят в виртуальную машину от имени администратора. При первом входе в систему по умолчанию будет запущено средство настройки Azure Site Recovery.
5. В этом средстве они указывают имя, используемое для регистрации сервера конфигурации в хранилище.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После создания подключения они входят систему в подписке Azure. Учетные данные должны иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации.

    ![Регистрация сервера конфигурации](./media/contoso-migration-rehost-vm-sql-ag/config-server-register2.png)

7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. После этого специалисты выполняют повторный вход на компьютер, и мастер управления сервером конфигурации запускается автоматически.
9. В мастере необходимо выбрать сетевой адаптер для приема трафика репликации. Этот параметр нельзя изменить после настройки.
10. Далее они выбирают подписку, группу ресурсов и хранилище для регистрации сервера конфигурации.
        ![Хранилище](./media/contoso-migration-rehost-vm-sql-ag/cswiz1.png)

11. Затем специалисты компании скачивают и устанавливают MySQL Server и VMWare PowerCLI.
12. После проверки они указывают полное доменное имя или IP-адрес сервера vCenter Server. Они оставляют порт по умолчанию и указывают понятное имя для сервера vCenter Server.
13. Они указывают учетную запись, которую они создали для автоматического обнаружения, и учетные данные, которые они использовали для автоматической установки Mobility Service. Чтобы можно было работать с компьютерами с ОС Windows, у учетной записи должны быть права локального администратора на виртуальных машинах.

    ![vCenter](./media/contoso-migration-rehost-vm-sql-ag/cswiz2.png)

14. По окончании регистрации на портале Azure сотрудники компании тщательно проверяют, указаны ли серверы конфигурации и VMware на странице **Источник** в хранилище. Обнаружение может занять 15 минут или более.
15. Затем Site Recovery подключается к серверам VMware, используя указанные параметры, и обнаруживает виртуальные машины.

### <a name="set-up-the-target"></a>Настройка цели

Теперь администраторы компании Contoso задают параметры репликации для целевой среды.

1. Они выбирают **Подготовка инфраструктуры** > **Цель** и задают параметры целевой среды.
2. Site Recovery проверяет наличие учетной записи хранения Azure и сети в указанной целевой среде.

### <a name="create-a-replication-policy"></a>Создание политики репликации

Теперь администраторы Contoso могут создать политику репликации.

1. В разделе **Подготовка инфраструктуры**  >  **Параметры репликации**  >  **Политика репликации**  >   **Создать и связать** специалисты компании создают политику **ContosoMigrationPolicy**.
2. При этом они используют параметр по умолчанию.
    - **Пороговое значение RPO:** 60 минут по умолчанию. Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
    - **Хранение точки восстановления:** По умолчанию используется значение 24 часа. Этим значением определяется продолжительность периода хранения для каждой точки восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
    - **Периодичность создания моментальных снимков с согласованием приложений:** Значение по умолчанию — час. Это значение указывает частоту, с которой система создает моментальные снимки приложений.

        ![Создание политики репликации](./media/contoso-migration-rehost-vm-sql-ag/replication-policy.png)

3. Политика автоматически сопоставляется с сервером конфигурации.

    ![Связывание политики репликации](./media/contoso-migration-rehost-vm-sql-ag/replication-policy2.png)

### <a name="enable-replication"></a>Включение репликации

Теперь администраторы Contoso могут запустить репликацию WebVM.

1. В разделе **Репликация приложений** > **Источник** >  **+Выполнить репликацию** они настраивают параметры источника.
2. Они указывают, что они хотят включить виртуальные машины, выбрать сервер vCenter и сервер конфигурации.

    ![Включение репликации](./media/contoso-migration-rehost-vm-sql-ag/enable-replication1.png)

3. Теперь специалисты задают параметры цели, включая группу ресурсов и виртуальную сеть, а также учетную запись хранения, где будут храниться реплицированные данные.

     ![Включение репликации](./media/contoso-migration-rehost-vm-sql-ag/enable-replication2.png)

4. Они выбирают виртуальную машину WebVM для репликации, проверяют ее политику и включают репликацию. Site Recovery установит службу Mobility Service на виртуальную машину, если репликация включена.

    ![Включение репликации](./media/contoso-migration-rehost-vm-sql-ag/enable-replication3.png)

5. Они отслеживают ход репликации в разделе **Задания**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.
6. В разделе **Основные компоненты** на портале Azure они могут просматривать структуру виртуальных машин, реплицируемых в Azure.

    ![Представление инфраструктуры](./media/contoso-migration-rehost-vm-sql-ag/essentials.png)

**Нужна дополнительная помощь?**

- Полное пошаговое руководство для этих трех шагов см. в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).
- Вы можете получить дополнительные сведения о том, как [включить репликацию](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).

## <a name="step-7-install-the-data-migration-assistant-dma"></a>Шаг 7. Установка Помощника по миграции данных (DMA)

Администраторы Contoso перенесут базу данных SmartHotel360 на виртуальную машину Azure **SQLAOG1** с помощью DMA. Они настраивают DMA следующим образом:

1. Они загружают инструмент с [центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=53595) к локальной виртуальной машине SQL Server (**SQLVM**).
2. Они запускают установку (DownloadMigrationAssistant.msi) на виртуальной машине.
3. Перед закрытием мастера на странице **Готово** необходимо выбрать **Launch Microsoft Data Migration Assistant** (Запустить помощник по миграции данных Майкрософт).

## <a name="step-8-migrate-the-database-with-dma"></a>Шаг 8. Миграция базы данных с помощью DMA

1. В DMA они запускают новую миграцию — **SmartHotel**.
2. Выберите **Target server type** (Тип исходного сервера) в качестве параметра**SQL Server на виртуальных машинах Azure**.

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-1.png)

3. В деталях миграции, они добавляют **SQLVM** как исходный сервер и **SQLAOG1** как целевой объект. Они определяют учетные данные для каждого компьютера.

     ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-2.png)

4. Они создают локальный общий доступ для базы данных и сведений о конфигурации. Он должен быть доступен для доступа к записи учетной записи SQL Service на SQLVM и SQLAOG1.

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-3.png)

5. Contoso выбирает логины, которые необходимо перенести, и запускает миграцию. После ее завершения DMA показывает успешный статус миграции.

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-4.png)

6. Они убеждаются, что база данных работает на **SQLAOG1**.

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-5.png)

DMA подключается к локальной виртуальной машине SQL Server через VPN-подключение типа "сеть — сеть", установленное между центром обработки данных Contoso и Azure, а затем выполняет перенос базы данных.

## <a name="step-7-protect-the-database-with-always-on"></a>Шаг 7. Защита базы данных с помощью AlwaysOn

Обеспечив выполнение базы данных приложения на виртуальной машине **SQLAOG1**, администраторы Contoso теперь могут защитить ее с помощью групп доступности AlwaysOn. Они настраивают AlwaysOn с помощью SQL Management Studio, а затем назначают слушателя с использованием кластеризации Windows.

### <a name="create-an-always-on-availability-group"></a>Создание группы доступности AlwaysOn

1. В SQL Management Studio они щелкают правой кнопкой мыши **Всегда на высокой доступности**, чтобы запустить **мастер создания группы доступности**.
2. В **Указание параметров**, они указывают название группы доступности **SHAOG**. В разделе **Выбор баз данных** они выбирают базу данных SmartHotel360.

    ![Группа доступности AlwaysOn](media/contoso-migration-rehost-vm-sql-ag/aog-1.png)

3. В **Выбор реплик**, они добавляют два узла SQL как реплики доступности и настраивают их для обеспечения автоматической отработки отказа с синхронной фиксацией.

     ![Группа доступности AlwaysOn](media/contoso-migration-rehost-vm-sql-ag/aog-2.png)

4. Они настраивают прослушиватель для группы (**SHAOG**) и порт. IP-адрес внутренней подсистемы балансировки нагрузки добавляется как статический IP-адрес (10.245.40.100).

    ![Группа доступности AlwaysOn](media/contoso-migration-rehost-vm-sql-ag/aog-3.png)

5. В **Выбор синхронизации данных**, они включают автоматическое заполнение. С помощью этой опции SQL Server автоматически создает вторичные реплики для каждой базы данных в группе, поэтому Contoso не нужно вручную создавать резервные копии и восстанавливать их. После проверки создается группа доступности.

    ![Группа доступности AlwaysOn](media/contoso-migration-rehost-vm-sql-ag/aog-4.png)

6. У Contoso возникли проблемы при создании группы. Они не используют встроенную систему безопасности Windows Active Directory и поэтому должны предоставить разрешения для входа в SQL для создания ролей отказоустойчивого кластера Windows.

    ![Группа доступности AlwaysOn](media/contoso-migration-rehost-vm-sql-ag/aog-5.png)

7. После создания группы Contoso может увидеть ее в SQL Management Studio.

### <a name="configure-a-listener-on-the-cluster"></a>Настройка прослушивателя в кластере

В качестве последнего этапа настройки развертывания SQL администраторы Contoso настраивают внутреннюю подсистему балансировки нагрузки как прослушиватель в кластере и переводят прослушиватель в оперативный режим. Для этого они используют сценарий.

![Прослушиватель кластера](media/contoso-migration-rehost-vm-sql-ag/cluster-listener.png)

### <a name="verify-the-configuration"></a>Проверьте конфигурацию

Теперь, когда все настроено, у компании Contoso есть действующая группа доступности в Azure, использующая перенесенную базу данных. Администраторы проверяют это, подключившись к внутренней подсистеме балансировки нагрузки в SQL Management Studio.

![Подключение ILB](media/contoso-migration-rehost-vm-sql-ag/ilb-connect.png)

**Нужна дополнительная помощь?**

- Дополнительные сведения о создании [группы доступности](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#create-the-availability-group) и [прослушивателя](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#configure-listener).
- [Настройка использования IP-адреса балансировщика нагрузки для кластера](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener#configure-the-cluster-to-use-the-load-balancer-ip-address) вручную.
- [Дополнительные сведения](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2) о создании и использовании SAS.

## <a name="step-8-migrate-the-vm-with-site-recovery"></a>Шаг 8. Миграция виртуальной машины с помощью Site Recovery

Администраторы Contoso выполняют быструю тестовую отработку отказа, а затем — миграцию виртуальной машины.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Тестовая отработка отказа позволяет убедиться перед миграцией в том, что все работает как надо.

1. Специалисты компании Contoso запускают тестовую отработку отказа для последнего доступного момента времени: **Latest processed** (Последняя обработанная).
2. Они выбирают **Shut down machine before beginning failover** (Завершить работу машины перед началом отработки отказа), поэтому перед запуском отработки отказа Site Recovery пытается завершить работу исходной виртуальной машины. Отработка отказа продолжится, даже если их не удастся отключить.
3. При тестировании отработки отказа происходит следующее:

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе данных создается точка восстановления;
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

4. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Специалисты убеждаются, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
5. После проверки они удаляют результаты отработки отказа, записывают и сохраняют все наблюдения.

### <a name="run-a-failover"></a>Запуск отработки отказа

1. Убедившись, что тестовая отработка отказа выполнена правильно, администраторы Contoso составляют план восстановления для миграции и добавляют к нему WEBVM.

     ![План восстановления](./media/contoso-migration-rehost-vm-sql-ag/recovery-plan.png)

2. Специалисты компании выполняют для этого плана отработку отказа. Они выбирают последнюю точку восстановления и указывают, что Site Recovery следует попытаться завершить работу виртуальных машин, прежде чем запустить отработку отказа.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover1.png)

3. После отработки отказа специалисты компании проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![План восстановления](./media/contoso-migration-rehost-vm-sql-ag/failover2.png)

4. После проверки виртуальной машины в Azure, они завершают процесс миграции, останавливают репликацию и выставление счетов Site Recovery для виртуальной машины и останавливают.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover3.png)

### <a name="update-the-connection-string"></a>Обновление строки подключения

На последнем этапе миграции администраторы Contoso обновляют строку подключения приложения, чтобы указать на перенесенную базу данных, запущенную в прослушивателе SHAOG. Эта конфигурация будет изменяться на WEBVM, который теперь работает в Azure. Эта конфигурация находится в файле web.config приложения ASP.

1. Найдите файл в C:\inetpub\SmartHotelWeb\web.config. Измените имя сервера, чтобы указать полное доменное имя AOG: shaog.contoso.com.

    ![Отработка отказа](./media/contoso-migration-rehost-vm-sql-ag/failover4.png)

2. После обновления файла и его сохранения они перезапускают IIS на WEBVM. Они делают это из командной строки с помощью команды IISRESET/RESTART.
3. После перезапуска IIS приложение использует базу данных, выполняющуюся на управляемом экземпляре SQL.

**Нужна дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) выполнить тестовую отработку отказа.
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) выполнить отработку отказа в Azure.

## <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции приложения SmartHotel360, которое выполнялось на виртуальной машине Azure, база данных SmartHotel360 находится на кластере SQL Azure.

Теперь специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновить внутренние документы и отразить в них новое расположение и IP-адреса виртуальных машин.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.
- Добавьте две новые виртуальные машины (SQLAOG1 и SQLAOG2), которые необходимо добавить в системы контроля производства.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Специалисты по безопасности компании Contoso проверяют виртуальные машины Azure, WEBVM, SQLAOG1 и SQLAOG2, чтобы выявить любые проблемы безопасности.

- Чтобы можно было управлять доступом, команда проверяет группы безопасности сети (NSG) для виртуальной машины. NSG позволяют пропускать только разрешенный для приложения трафик.
- Команда рассматривает возможность защиты данных на диске с использованием функций шифрования дисков Azure и Key Vault.
- Команда должна оценить прозрачное шифрование данных (TDE), а затем включить его в базе данных SmartHotel360, работающей на новой виртуальной машине SQL AOG. [Узнайте больше](/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017).

[Узнайте больше](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms) о рекомендациях по обеспечению безопасности виртуальных машин.

## <a name="bcdr"></a>Непрерывность бизнес-процессов и аварийное восстановление

 Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление (BCDR), Contoso выполняет следующие действия:

- Безопасное хранение данных. Contoso выполняет резервное копирование данных на виртуальных машинах WEBVM, SQLAOG1 и SQLAOG2, используя службу Azure Backup. [Узнайте больше](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
- Сотрудники Contoso также научаться использовать службу хранилища Azure для резервного копирования SQL Server непосредственно в хранилище BLOB-объектов. [Узнайте больше](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-use-storage-sql-server-backup-restore).
- Поддержание работы приложений. Специалисты компании Contoso реплицируют виртуальные машины приложения в дополнительный регион Azure с помощью Site Recovery. [Узнайте больше](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

1. У компании Contoso имеются лицензии на виртуальные машины WEBVM, и она воспользуется Преимуществом гибридного использования Azure. Contoso преобразует имеющиеся виртуальные машины Azure, чтобы использовать льготные расценки.
2. Компания будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение корпорации Майкрософт). Это решение по управлению затратами для нескольких облаков, которое позволяет использовать облака Azure и другие облачные ресурсы, а также управлять ими. Дополнительные сведения об управлении расходами см. [на этой странице](https://docs.microsoft.com/azure/cost-management/overview).

## <a name="conclusion"></a>Заключение

В этой статье рассказано, как компания Contoso повторно разместила приложение SmartHotel360 в Azure, выполнив миграцию интерфейсных виртуальных машин приложения в Azure с помощью службы Site Recovery. Компания Contoso перенесла базу данных приложения в кластер SQL Server, подготовленный в Azure, и защитила его в группе доступности SQL Server AlwaysOn.
