---
title: Миграция баз данных PostgreSQL в Azure
description: Узнайте, как компания Contoso перенеса свои локальные базы данных PostgreSQL в Azure.
author: deltadan
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
ms.openlocfilehash: 9f9dfee1aca21acbbf0f840b79d61501ad90c73a
ms.sourcegitcommit: 8b82889dca0091f3cc64116f998a3a878943c6a1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2020
ms.locfileid: "89603872"
---
<!-- cSpell:ignore BYOK postgres psql dvdrental vpngateways -->

# <a name="migrate-postgresql-databases-to-azure"></a>Миграция баз данных PostgreSQL в Azure

В этой статье показано, как вымышленная компания Contoso планирует и перенеса свою локальную платформу базы данных PostgreSQL с открытым кодом в Azure.

## <a name="business-drivers"></a>Бизнес-факторы

Группа специалистов по ИТ тесно работала с бизнес-партнерами, чтобы понять, что они хотят достичь при миграции. Они хотят:

- **Автоматизируйте большие данные.** Contoso использует PostgreSQL для работы с большими объемами данных и ИСКУССТВЕНными инициативами. Компании требуется создать масштабируемые повторяемые конвейеры для автоматизации многих из этих аналитических рабочих нагрузок.
- **Повышение эффективности.** Компании Contoso необходимо удалить ненужные процедуры и упростить процессы для разработчиков и пользователей. Бизнес требует, чтобы он был быстрым и не тратит время или деньги, чтобы обеспечить более быстрое соответствие требованиям клиентов.
- **Повышение гибкости.** ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Он должен реагировать быстрее, чем изменения в Marketplace, чтобы обеспечить успешную работу в глобальной экономике и не стать блокированием бизнеса.
- **Измените.** По мере успешного развития бизнеса компания Contoso должна предоставлять системы, которые могут расти в том же темпе.
- **Повышение безопасности.** Компания Contoso осознает, что нормативные проблемы приведут к тому, что компания настроит свою локальную стратегию на основе аудита, ведения журнала и требований соответствия.

## <a name="migration-goals"></a>Цели миграции

Группа Contoso Cloud заблокировала цели для этой миграции и будет использовать их для определения лучшего метода переноса.

| Требования | Сведения |
| --- | --- |
| **Обновления** | Компания Contoso хочет убедиться, что в ней установлены последние исправления, если они доступны, но компании не требуется управлять этими обновлениями. |
| **Интеграции** | Contoso хочет интегрировать данные в базу данных с конвейерами данных и AI для машинного обучения. |
| **Резервное копирование и восстановление** | Компания Contoso ищет возможность восстановления на момент времени, если обновления данных завершаются сбоем или по какой-либо причине повреждены. |
| **Azure** | Компания Contoso хочет отслеживать систему и запускать оповещения на основе производительности и безопасности. |
| **Производительность** | В некоторых случаях компания Contoso будет иметь параллельные конвейеры обработки данных в разных географических регионах и должна считывать данные из этих регионов. |

## <a name="solution-design"></a>Архитектура решения

После фиксации целей и требований компания Contoso проектирует и изучает решение для развертывания и определяет процесс миграции. Также определяются средства и службы, которые будут использоваться для миграции.

### <a name="current-environment"></a>Текущая среда

PostgreSQL 9.6.7 работает на физическом компьютере Linux ( `sql-pg-01.contoso.com` ) в центре обработки данных Contoso. Компания Contoso уже имеет подписку Azure с шлюзом виртуальной сети "сеть — сеть" в локальную сеть центра обработки данных.

### <a name="proposed-solution"></a>Предлагаемое решение

- Используйте Azure Database Migration Service, чтобы перенести базу данных в экземпляр базы данных Azure для PostgreSQL.
- Измените все приложения и процессы, чтобы они использовали новый экземпляр базы данных Azure для PostgreSQL.
- Создайте новый конвейер обработки данных с помощью фабрики данных Azure, который подключается к экземпляру базы данных Azure для PostgreSQL.

### <a name="database-considerations"></a>Рекомендации по базе данных

В рамках процесса разработки решения компания Contoso проверила возможности в Azure для размещения своих данных PostgreSQL. Следующие рекомендации помогли компании принять решение об использовании Azure.

- Как и база данных SQL Azure, база данных Azure для PostgreSQL поддерживает правила брандмауэра.
- Базу данных Azure для PostgreSQL можно использовать с виртуальными сетями, чтобы не допустить публичного доступа к экземпляру.
- База данных Azure для PostgreSQL имеет необходимые сертификаты соответствия требованиям, которые должны соответствовать компании Contoso.
- Интеграция с DevOps и фабрикой данных Azure позволяет создавать конвейеры автоматической обработки данных.
- Производительность обработки можно повысить, используя реплики чтения.
- Поддержка переноса собственных ключей (BYOK) для шифрования данных.
- Возможность предоставлять доступ к службе только для внутреннего сетевого трафика (без общего доступа) с помощью частной связи Azure.
- [Пропускная способность и задержка](/azure/vpn-gateway/vpn-gateway-about-vpngateways) от приложения к базе данных достаточно достаточны на основе выбранного шлюза (Azure ExpressRoute или VPN типа "сеть — сеть").

### <a name="solution-review"></a>Проверка решения

Компания Contoso оценивает предлагаемую конструкцию, помещая вместе со списком достоинств и недостатков.

| Рассматриваемый вопрос | Сведения |
|--- | --- |
| **Преимущества** | Все необходимые и используемые функции доступны в базе данных Azure для PostgreSQL. <br><br> |
| **Недостатки** | Компании Contoso по-прежнему потребуется выполнить перенос вручную из основной версии PostgreSQL. |

## <a name="proposed-architecture"></a>Предлагаемая архитектура

![Схема архитектуры сценария.](./media/contoso-migration-postgresql-to-azure/architecture.png)

_Рис. 1. Архитектура сценария._

### <a name="migration-process"></a>Процесс миграции

#### <a name="preparation"></a>Подготовка

Прежде чем компания Contoso сможет перенести свои базы данных PostgreSQL, она гарантирует, что экземпляры Contoso отвечают всем предварительным требованиям Azure для успешной миграции.

#### <a name="supported-versions"></a>Поддерживаемые версии

Поддерживаются только миграции на ту же или более позднюю версию. Миграция PostgreSQL 9,5 в базу данных Azure для PostgreSQL 9,6 или 10 поддерживается, но миграция с PostgreSQL 11 на PostgreSQL 9,6 не поддерживается.

Корпорация Майкрософт нацелена на поддержку _n-2_ версий подсистемы PostgreSQL в базе данных Azure для PostgreSQL-Single Server. Версии будут соответствовать текущей основной версии в Azure (_n_) и двум предыдущим основным версиям (_-2_).

Последние обновления поддерживаемых версий см. в разделе [Supported PostgreSQL Major Versions](/azure/postgresql/concepts-supported-versions).

> [!NOTE]
> Автоматическое обновление основной версии не поддерживается. Например, автоматическое обновление с PostgreSQL 9,5 до PostgreSQL 9,6 не предусмотрено. Чтобы выполнить обновление до следующей основной версии, выведите дамп базы данных и восстановите ее на сервере, созданном с использованием целевой версии подсистемы.

#### <a name="network"></a>Сеть

Contoso потребуется настроить подключение шлюза виртуальной сети из локальной среды к виртуальной сети, в которой находится база данных Azure для базы данных PostgreSQL. Это подключение позволяет локальному приложению получить доступ к базе данных, но не может быть перенесена в облако.

#### <a name="assessment"></a>Оценка

Contoso потребуется оценить текущую базу данных на наличие проблем репликации. К этим проблемам относятся:

- Версия базы данных-источника совместима для миграции в целевую версию базы данных.
- Первичные ключи должны существовать во всех таблицах для репликации.
- Имена баз данных не могут содержать точку с запятой ( `;` ).
- Перенос нескольких таблиц с одним и тем же именем, но другой случай может привести к непредсказуемому поведению.

  ![Схема процесса миграции. ](./media/contoso-migration-postgresql-to-azure/migration-process.png)
   _Рис. 2. процесс миграции._

#### <a name="migration"></a>Миграция

Компания Contoso может выполнять миграцию несколькими способами:

- [Дамп и восстановление](/azure/postgresql/howto-migrate-using-dump-and-restore)
- [Миграция баз данных Azure](/azure/dms/tutorial-postgresql-azure-postgresql-online)
- [Импорт и экспорт](/azure/postgresql/howto-migrate-using-export-and-import)

Компания Contoso выбрала Azure Database Migration Service, чтобы позволить компании повторно использовать проект миграции при необходимости выполнять основные обновления. Поскольку одно действие Database Migration Service поддерживает только до четырех баз данных, Contoso настраивает несколько заданий, выполнив следующие действия.

Чтобы подготовить, настройте виртуальную сеть для доступа к базе данных. Создайте подключение к виртуальной сети с помощью [VPN-шлюзов](/azure/vpn-gateway/vpn-gateway-about-vpngateways) различными способами.

### <a name="create-an-azure-database-migration-service-instance"></a>Создание экземпляра Azure Database Migration Service

1. В [портал Azure](https://portal.azure.com)выберите **Добавить ресурс**.
1. Выполните поиск по запросу **службы миграции баз данных Azure**и выберите их.
1. Щелкните **+ Добавить**.
1. Выберите подписку и группу ресурсов для службы.
1. Введите имя для экземпляра.
1. Выберите ближайшее расположение для центра обработки данных Contoso или VPN-шлюза.
1. Выберите **Azure** для режима обслуживания.
1. Выберите ценовую категорию.
1. Выберите **Review + create** (Просмотреть и создать).

    ![Снимок экрана с экраном "Создание службы миграции".](./media/contoso-migration-postgresql-to-azure/azure_migration_service_create.png)
    _Рис. 3. Проверка и создание._

1. Нажмите кнопку **создания**.

### <a name="create-an-azure-database-for-postgresql-instance"></a>Создание экземпляра Базы данных Azure для PostgreSQL

1. На локальном сервере настройте `postgresql.conf` файл.

1. Настройте сервер на прослушивание по правильному IP-адресу, который Azure Database Migration Service будет использовать для доступа к серверу и базам данных.
    - Задайте `listen_addresses` переменную.
1. Включите SSL.
    1. Задайте `ssl=on` переменную.
    1. Убедитесь, что Contoso использует открытый подписанный SSL-сертификат для сервера, который поддерживает TLS 1,2. В противном случае средство Database Migration Service вызовет ошибку.
1. Обновите файл `pg_hba.conf`.
    - Добавьте записи, относящиеся к экземпляру Database Migration Service.
1. Логическая репликация должна быть включена на исходном сервере путем изменения значений в `postgresql.conf` файле для каждого сервера.
    1. `wal_level` = `logical`
    1. `max_replication_slots` = [по крайней мере максимальное число баз данных для миграции]
        - Например, если компания Contoso хочет перенести четыре базы данных, ей присваивается значение 4.
    1. `max_wal_senders` = [число баз данных, выполняемых параллельно]
        - Рекомендуемое значение — 10.

1. Миграция `User` должна иметь `REPLICATION` роль в базе данных источника.

1. Добавьте в файл IP-адрес экземпляра Database Migration Service `PostgreSQLpg_hba.conf` .

1. Чтобы экспортировать схемы базы данных, выполните следующие команды:

    ```cmd
    pg_dump -U postgres -s dvdrental > dvdrental_schema.sql
    ```

1. Скопируйте файл, присвойте ему имя `dvdrental_schema_foreign.sql` и удалите все элементы, не являющиеся внешними, и связанные с триггерами.
1. Удалите из файла все элементы, связанные с внешним ключом и триггером `dvdrental_schema.sql` .

1. Импортируйте схему базы данных (шаг 1):

      ```cmd
        psql -h {host}.postgres.database.azure.com -d dvdrental -U username -f dvdrental_schema.sql
      ```

### <a name="migration"></a>Миграция

1. В портал Azure Contoso переходит к своему Database Migration Service ресурсу.
1. Если служба не запущена, выберите **запустить службу**.
1. Выберите **Новый проект миграции**.

    ![Снимок экрана, на котором показан выделенный параметр "новый проект миграции".](./media/contoso-migration-postgresql-to-azure/azure_migration_service_new_project.png)

    _Рис. 4. Запуск новой миграции._

1. Выберите **новое действие**  >  **Миграция данных в сети**.
1. Введите имя.
1. В качестве источника выберите **PostgreSQL** .
1. Для целевого объекта выберите **база данных Azure для PostgreSQL** и нажмите кнопку **сохранить**.

    ![Снимок экрана, на котором показана панель "новый проект миграции".](./media/contoso-migration-postgresql-to-azure/azure_migration_service_new_project02.png)

    _Рис. 5. выделен новый проект миграции._

1. Введите сведения об источнике и нажмите кнопку **сохранить**.

    ![Снимок экрана, показывающий ввод сведений об источнике.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_source.png)
    _Рис. 6. Ввод исходных данных._

1. Введите сведения о целевом объекте и нажмите кнопку **сохранить**.

    ![Снимок экрана, на котором показано, как выбрать целевую информацию.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_target.png)
    _Рис. 7. Выбор целевой информации._

1. Выберите базы данных для миграции. Схема для каждой базы данных должна быть перенесена ранее. Затем нажмите кнопку **Save** (Сохранить).

    ![Снимок экрана, на котором показаны выборки баз данных.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_db.png)
    _Рис. 8. Выбор баз данных._

1. Настройте дополнительные параметры и нажмите кнопку **сохранить**.

    ![Снимок экрана, на котором показано, как настроить дополнительные параметры.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_advanced.png)
    _Рис. 9. Настройка дополнительных параметров._

1. Присвойте действию имя и выберите **выполнить**.

    ![Снимок экрана, показывающий именование и выполнение действия.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_summary.png)
    _Рис. 10. Именование и запуск действия._

1. Мониторинг миграции. Повторите попытку, если что-то не удается. Например, в случае отсутствия ссылок на внешние ключи.
1. После `Full load completed` совпадения числа таблиц выберите **Start прямую миграцию**.

    ![Снимок экрана, на котором показан мониторинг миграции для запуска прямую миграцию.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_complete.png)
    _Рис. 11. Мониторинг миграции для запуска прямую миграцию._

1. Останавливает все транзакции с исходного сервера.
1. Установите флажок **подтвердить** и нажмите кнопку **Применить**.

    ![Снимок экрана, на котором показано выполнение прямую миграцию.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_cutover.png)
    _Рис. 12. Запуск прямую миграцию._

1. Дождитесь завершения прямую миграцию.

    ![Снимок экрана, показывающий завершение прямую миграцию.](./media/contoso-migration-postgresql-to-azure/azure_migration_service_finished.png)
    _Рис. 13. Завершение прямую миграцию._

      > [!NOTE]
      > Предыдущие Database Migration Service действия также можно выполнить с помощью [Azure CLI](/azure/dms/tutorial-postgresql-azure-postgresql-online).

1. Импортируйте схему базы данных (шаг 2):

      ```cmd
        psql -h {host}.postgres.database.azure.com -d dvdrental -U username -f dvdrental_schema_foreign.sql
      ```

1. Перенастройте все приложения или процессы, использующие локальную базу данных, чтобы указать новый экземпляр базы данных Azure для PostgreSQL.

1. При необходимости после миграции Contoso гарантирует, что после завершения миграции также будут настроены реплики чтения между регионами.

## <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции компания Contoso должна создать резервную копию локальной базы данных для хранения и снять с учета старый сервер PostgreSQL в рамках процесса очистки.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Компания Contoso должна:

- Убедитесь, что новые базы данных Azure для экземпляра и баз данных PostgreSQL защищены. Дополнительные сведения см. [в статье безопасность в базе данных Azure для PostgreSQL-Single Server](/azure/postgresql/concepts-security).
- Проверьте [правила брандмауэра](/azure/postgresql/concepts-firewall-rules) и конфигурации виртуальной сети, чтобы убедиться, что подключения ограничены только приложениями, которые им требуются.
- Реализуйте [BYOK](/azure/postgresql/concepts-data-encryption-postgresql) для шифрования данных.
- Обновите все приложения, чтобы они [затребовали SSL](/azure/postgresql/concepts-ssl-connection-security) -соединения с базами данных.
- Настройте [частную ссылку](/azure/postgresql/concepts-data-access-and-security-private-link) , чтобы весь трафик базы данных хранился в Azure и локальной сети.
- Включите [Azure Advanced Threat protection (ATP)](/azure/postgresql/concepts-data-access-and-security-threat-protection).
- Настройте Log Analytics для отслеживания и оповещения о записях безопасности и журналах, представляющих интерес.

### <a name="backups"></a>Резервные копии

Убедитесь, что резервное копирование базы данных Azure для PostgreSQL осуществляется с помощью геовосстановления. Таким образом, резервные копии можно использовать в парном регионе, если происходит региональный сбой.

> [!IMPORTANT]
> Убедитесь, что ресурс "база данных Azure для PostgreSQL" имеет блокировку ресурсов, чтобы предотвратить удаление. Невозможно восстановить удаленные серверы.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- Можно масштабировать базу данных Azure для PostgreSQL. Наблюдение за производительностью сервера и баз данных важно для того, чтобы обеспечить соблюдение требований, сохраняя затраты как минимум.
- Ресурсы ЦП и хранилища связаны с затратами. Для выбора доступны несколько ценовых категорий. Убедитесь, что для рабочих нагрузок данных выбран соответствующий ценовой план.
- Счета за каждую реплику чтения выставляются на основе выбранных вычислений и хранилища.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso перенеса свои базы данных PostgreSQL в экземпляр базы данных Azure для PostgreSQL.
