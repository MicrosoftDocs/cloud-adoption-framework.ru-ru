---
title: Миграция баз данных PostgreSQL в Microsoft Azure
description: Узнайте, как компания Contoso перенеса свои локальные базы данных PostgreSQL в Azure.
author: deltadan
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 8de202b5f6f8f0420541792898bf609360e79d28
ms.sourcegitcommit: bcc73d194c6d00c16ae2e3c7fb2453ac7dbf2526
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86198632"
---
<!-- cSpell:ignore BYOK postgres psql dvdrental -->

# <a name="migrate-postgresql-databases-to-microsoft-azure"></a>Миграция баз данных PostgreSQL в Microsoft Azure

В этой статье показано, как вымышленная компания Contoso планирует и перенеса свою локальную платформу базы данных PostgreSQL с открытым исходным кодом в Azure.

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Большие данные:** Компания Contoso использует PostgreSQL для работы с большими объемами данных и ИСКУССТВЕНными инициативами, они хотят иметь возможность создавать масштабируемые повторяемые конвейеры для автоматизации многих из этих аналитических рабочих нагрузок.
- **Повышение эффективности:** Компании Contoso необходимо удалить ненужные процедуры и упростить процессы для разработчиков и пользователей. Бизнесу требуется, чтобы он был быстрым и не тратить время или деньги, обеспечивая более быстрое соответствие требованиям клиентов.
- **Повышение гибкости:** Компания Contoso должна быть в большей мере реагировать на потребности бизнеса. Он должен иметь возможность реагировать быстрее, чем изменения в Marketplace, чтобы обеспечить успешную работу в глобальной экономике и не стать блоком.
- **Масштаб:** По мере успешного развития бизнеса компания Contoso должна предоставить системы, которые могут расти в одном темпе.
- **Повышенная безопасность:** Компания Contoso осознает, что нормативные проблемы приведут к корректировке локальной стратегии на основе аудита, ведения журнала и требований соответствия.

## <a name="migration-goals"></a>Цели миграции

Группа Contoso Cloud заблокировала цели для этой миграции и будет использовать их для определения лучшего метода переноса.

| Требования | Сведения |
| --- | --- |
| **Обновления** | Компания Contoso хочет убедиться, что у них установлены последние исправления, если они доступны, но не хотят управлять этими обновлениями. |
| **Интеграции** | Contoso хочет интегрировать данные в базу данных с конвейерами данных и AI для Машинное обучение. |
| **Архивация и восстановление** | Компания Contoso ищет возможность выполнения восстановления на момент времени, если обновления данных завершаются сбоем или по какой-либо причине повреждены. |
| **Azure** | Они хотели бы иметь возможность отслеживать систему и запускать оповещения на основе производительности и безопасности. |
| **Производительность** | В некоторых случаях они будут иметь параллельные конвейеры обработки данных в разных географических регионах и должны считывать данные из этих регионов. |

## <a name="solution-design"></a>Архитектура решения

После фиксации целей и требований компания Contoso проектирует и просматривает решение по развертыванию и определяет процесс миграции, включая средства и службы, которые они будут использовать для миграции.

### <a name="current-environment"></a>Текущая среда

PostgreSQL 9.6.7 работает на физическом компьютере Linux ( `sql-pg-01.contoso.com` ) в центре обработки данных Contoso. Компания Contoso уже имеет подписку Azure с шлюзом виртуальной сети "сеть — сеть" в локальную сеть центра обработки данных.

### <a name="proposed-solution"></a>Предлагаемое решение

- Используйте Azure Database Migration Service o перенесите базу данных в экземпляр базы данных Azure для PostgreSQL.
- Измените все приложения и процессы, чтобы они использовали новый экземпляр базы данных Azure для PostgreSQL.
- Создание конвейера обработки данных с помощью фабрики данных Azure, которая подключается к экземпляру базы данных Azure для PostgreSQL.

### <a name="database-considerations"></a>Рекомендации по базе данных

В рамках процесса разработки решения компания Contoso проверила возможности в Azure для размещения своих данных PostgreSQL. Следующие рекомендации помогли вам решить, как использовать Azure.

- Как и база данных SQL Azure, база данных Azure для PostgreSQL поддерживает правила брандмауэра.
- Базу данных Azure для PostgreSQL можно использовать с виртуальными сетями, чтобы не допустить публичного доступа к экземпляру.
- База данных Azure для PostgreSQL имеет необходимые сертификаты соответствия требованиям, которые должны соответствовать компании Contoso.
- Интеграция с DevOps и фабрикой данных Azure позволяет создавать конвейеры автоматической обработки данных.
- Производительность обработки можно повысить, используя реплики чтения.
- Поддержка переноса собственных ключей (BYOK) для шифрования данных.
- Возможность предоставлять доступ к службе только внутреннему сетевому трафику (без общего доступа) с помощью частной ссылки.
- [Пропускная способность и задержка](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways) от приложения к базе данных достаточно достаточны в зависимости от выбранного шлюза (ExpressRoute или VPN-подключение типа "сеть — сеть").

### <a name="solution-review"></a>Проверка решения

Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

| Рассматриваемый вопрос | Сведения |
|--- | --- |
| **Преимущества** | Все необходимые и используемые функции доступны в базе данных Azure для PostgreSQL. <br><br> |
| **Недостатки** | Компании Contoso по-прежнему потребуется выполнить перенос вручную из основной версии PostgreSQL. |

## <a name="proposed-architecture"></a>Предлагаемая архитектура

![Архитектура сценария ](./media/contoso-migration-postgresql-to-azure/architecture.png)
 _рис. 1. Архитектура сценария._

### <a name="migration-process"></a>Процесс миграции

#### <a name="preparation"></a>Подготовка

Прежде чем можно будет перенести базы данных PostgreSQL, убедитесь, что эти экземпляры соответствуют всем предварительным требованиям Azure для успешной миграции.

#### <a name="supported-versions"></a>Поддерживаемые версии

Поддерживаются только миграции на ту же или более позднюю версию. Миграция PostgreSQL 9,5 в базу данных Azure для PostgreSQL 9,6 или 10 поддерживается, но миграция с PostgreSQL 11 на PostgreSQL 9,6 не поддерживается.

Корпорация Майкрософт нацелена на поддержку _n-2_ версий подсистемы PostgreSQL в базе данных Azure для PostgreSQL-Single Server. Версии будут соответствовать текущей основной версии в Azure (_n_) и двум предыдущим основным версиям (_-2_).

Последние обновления поддерживаемых версий [см. здесь](https://docs.microsoft.com/azure/postgresql/concepts-supported-versions).

> [!NOTE]
> Автоматическое обновление основной версии не поддерживается. Например, автоматическое обновление с PostgreSQL 9,5 до PostgreSQL 9,6 не предусмотрено. Чтобы выполнить обновление до следующей основной версии, выведите дамп базы данных и восстановите ее на сервере, созданном с использованием целевой версии подсистемы.

#### <a name="network"></a>Сеть

Contoso потребуется настроить подключение шлюза виртуальной сети из локальной среды к виртуальной сети, где находится база данных Azure для базы данных PostgreSQL. Это позволяет локальному приложению получать доступ к базе данных, но не может быть перенесена в облако.

#### <a name="assessment"></a>Оценка

Contoso потребуется оценить текущую базу данных на наличие проблем репликации. К этим проблемам относятся:

- Версия базы данных-источника совместима для миграции в целевую версию базы данных.
- Убедитесь, что первичные ключи существуют во всех таблицах для репликации.
- Имена баз данных не могут содержать точку с запятой ( `;` ).
- Миграция нескольких таблиц с одинаковым именем, но с разным регистром может привести к непредсказуемому поведению.

  ![Процесс миграции ](./media/contoso-migration-postgresql-to-azure/migration-process.png)
   _рис. 2. процесс миграции._

#### <a name="migration"></a>Миграция

Компания Contoso может выполнить миграцию несколькими способами, включая:

- [Дамп и восстановление](https://docs.microsoft.com/azure/postgresql/howto-migrate-using-dump-and-restore)

- [Миграция баз данных Azure](https://docs.microsoft.com/azure/dms/tutorial-postgresql-azure-postgresql-online)

- [Импорт и экспорт](https://docs.microsoft.com/azure/postgresql/howto-migrate-using-export-and-import)

Компания Contoso выбрала Azure Database Migration Service, чтобы позволить им повторно использовать проект миграции при необходимости выполнять основные обновления. Поскольку одно действие Database Migration Service поддерживает только до четырех баз данных, Contoso настраивает несколько заданий, выполнив следующие действия:

Чтобы подготовиться к работе, настройте виртуальную сеть (VNet) для доступа к базе данных. Вы можете создать подключение к виртуальной сети с помощью [VPN-шлюзов](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways) различными способами.

<!-- docsTest:ignore "Azure Database Migration Services" -->

- Создайте экземпляр Azure Database Migration Service:
  - В [портал Azure](https://portal.azure.com)выберите **Добавить ресурс**.
  - Выполните поиск **Azure Database Migration Service** и выберите его.
  - Щелкните **+ Добавить**.
  - Выберите подписку и группу ресурсов для службы.
  - Введите имя для экземпляра.
  - Выберите ближайшее расположение для центра обработки данных или VPN-шлюза.
  - Выберите **Azure** для режима обслуживания.
  - Выберите ценовую категорию.
  - Выберите **Просмотр и создание**.

    ![Процесс миграции ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_create.png)
     _рис. 3. Проверка и создание._

  - Нажмите кнопку **Создать**.

- Создайте экземпляр базы данных Azure для PostgreSQL.

- На локальном сервере настройте `postgresql.conf` файл.

  - Настройте сервер на прослушивание по правильному IP-адресу, который Azure Database Migration Service будет использовать для доступа к серверу и базам данных.
    - Задайте `listen_addresses` переменную.
  - Включите SSL.
    - Задайте `ssl=on` переменную.
    - Убедитесь, что вы используете открытый подписанный SSL-сертификат для сервера, который поддерживает TLS 1,2. В противном случае средство Database Migration Service вызовет ошибку.
  - Обновите файл `pg_hba.conf`.
    - Добавьте записи, относящиеся к экземпляру Database Migration Service.
  - Логическая репликация должна быть включена на исходном сервере, изменяя значения в `postgresql.conf` файле для каждого сервера.
    - `wal_level` = `logical`
    - `max_replication_slots`= [по крайней мере максимальное число баз данных для миграции]
      - Например, если требуется перенести четыре базы данных, установите значение 4.
    - `max_wal_senders`= [число баз данных, выполняемых параллельно]
      - Рекомендуемое значение — 10.

- Миграция `User` должна иметь `REPLICATION` роль в базе данных источника.

- Добавьте в файл IP-адрес экземпляра Database Migration Service `PostgreSQLpg_hba.conf` .

- Экспортируйте схемы базы данных.

  - Выполните следующие команды:

    ```cmd
    pg_dump -U postgres -s dvdrental > dvdrental_schema.sql
    ```

  - Скопируйте файл, присвойте ему имя `dvdrental_schema_foreign.sql` и удалите все элементы, не являющиеся внешними, и связанные с триггерами.
  - Удалите из файла все элементы, связанные с внешним ключом и триггером `dvdrental_schema.sql` .

- Импортируйте схему базы данных (шаг 1):

  ```cmd
    psql -h {host}.postgres.database.azure.com -d dvdrental -U username -f dvdrental_schema.sql
    ```

- Миграция.

  - В портал Azure перейдите к ресурсу Database Migration Service.
  - Если служба не запущена, выберите **запустить службу**.
  - Выберите **Новый проект миграции**.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_new_project.png)
     _рис. 4. Запуск новой миграции._

  - Выберите **новое действие**  >  **Миграция данных в сети**.
  - Введите имя.
  - В качестве источника выберите **PostgreSQL** .
  - Для целевого объекта выберите **база данных Azure для PostgreSQL**.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_new_project02.png)
     _рис. 5. выделен новый проект миграции._

  - Щелкните **Сохранить**.
  - Введите сведения об источнике.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_source.png)
     _рис. 6. Ввод исходных данных._

  - Щелкните **Сохранить**.
  - Введите сведения о целевом объекте.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_target.png)
     _рис. 7. Выбор целевой информации._

  - Щелкните **Сохранить**.
  - Выберите базы данных, которые вы хотите перенести. Схема для каждой базы данных должна быть перенесена ранее.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_db.png)
     _рис. 8. Выбор баз данных._

  - Щелкните **Сохранить**.
  - Настройте дополнительные параметры.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_advanced.png)
     _рис. 9. Настройка дополнительных параметров._

  - Щелкните **Сохранить**.
  - Присвойте действию имя и выберите **выполнить**.

    ![Новый проект миграции выделяется ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_summary.png)
     _на рис. 10: именование и запуск действия._

  - Мониторинг миграции. Может потребоваться повторить попытку, если что-то не удается (например, если отсутствуют ссылки на внешние ключи).
  - После `Full load completed` соответствия числа таблиц выберите **Start прямую миграцию (запустить**).

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_complete.png)
     _рис. 11. Мониторинг миграции для запуска прямую миграцию._

  - Останавливает все транзакции с исходного сервера.
  - Установите флажок **подтвердить** , а затем нажмите кнопку **Применить**.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_cutover.png)
     _рис. 12. Запуск прямую миграцию._

  - Дождитесь завершения прямую миграцию.

    ![Новый проект миграции выделен ](./media/contoso-migration-postgresql-to-azure/azure_migration_service_finished.png)
     _рис. 13. Завершение прямую миграцию._

  > [!NOTE]
  > Приведенные выше Database Migration Service шаги также можно выполнить с помощью [Azure CLI](https://docs.microsoft.com/azure/dms/tutorial-postgresql-azure-postgresql-online).

- Импортируйте схему базы данных (шаг 2):

  ```cmd
    psql -h {host}.postgres.database.azure.com -d dvdrental -U username -f dvdrental_schema_foreign.sql
    ```

- Перенастройте все приложения или процессы, использующие локальную базу данных, чтобы указать новый экземпляр базы данных Azure для PostgreSQL.

- При необходимости убедитесь, что вы также настроили реплики чтения между регионами, если это необходимо, после завершения миграции.

## <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции компания Contoso должна создать резервную копию локальной базы данных для хранения и снять с учета старый сервер PostgreSQL в рамках процесса очистки.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Contoso необходимо убедиться, что новые базы данных Azure для экземпляра PostgreSQL и базы данных защищены. [Подробнее](https://docs.microsoft.com/azure/postgresql/concepts-security).
- Компания Contoso должна проверить [правила брандмауэра](https://docs.microsoft.com/azure/postgresql/concepts-firewall-rules) и конфигурации виртуальной сети, чтобы убедиться, что подключения ограничены только приложениями, которые им требуются.
- Реализуйте [BYOK](https://docs.microsoft.com/azure/postgresql/concepts-data-encryption-postgresql) для шифрования данных.
- Обновите все приложения, чтобы они [затребовали SSL](https://docs.microsoft.com/azure/postgresql/concepts-ssl-connection-security) -соединения с базами данных.
- Настройте [частную ссылку](https://docs.microsoft.com/azure/postgresql/concepts-data-access-and-security-private-link) , чтобы весь трафик базы данных хранился в Azure и локальной сети.
- Включите [Azure Advanced Threat protection (ATP)](https://docs.microsoft.com/azure/postgresql/concepts-data-access-and-security-threat-protection).
- Настройте Log Analytics для отслеживания и оповещения о записях безопасности и журналах, представляющих интерес.

### <a name="backups"></a>Резервные копии

Убедитесь, что резервное копирование базы данных Azure для PostgreSQL выполняется с помощью геовосстановления. Это позволяет использовать резервные копии в парном регионе в случае регионального сбоя.

> [!IMPORTANT]
> Убедитесь, что ресурс "база данных Azure для PostgreSQL" имеет блокировку ресурсов, чтобы предотвратить удаление. Удаленные серверы нельзя восстановить.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- Можно масштабировать базу данных Azure для PostgreSQL. Наблюдение за производительностью сервера и баз данных важно для того, чтобы обеспечить соответствие вашим потребностям, сохраняя затраты как минимум.
- Ресурсы ЦП и хранилища связаны с затратами. Для выбора доступны несколько ценовых категорий. Убедитесь, что для рабочих нагрузок данных выбран соответствующий ценовой план.
- Счета за каждую реплику чтения выставляются на основе выбранных вычислений и хранилища.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso перенеса свои базы данных PostgreSQL в экземпляр базы данных Azure для PostgreSQL.
