---
title: Повторное размещение приложения службы поддержки для Linux в Azure и Базе данных Azure для MySQL
titleSuffix: Microsoft Cloud Adoption Framework for Azure
description: Узнайте, как компания Contoso повторно размещает приложение Linux, перенеся его на виртуальные машины Azure и в Базу данных Azure для MySQL.
author: BrianBlanchard
ms.author: brblanch
ms.date: 04/04/2019
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
ms.openlocfilehash: a2a695af758ae7e99a7c2257f3adf4ce5058ae3d
ms.sourcegitcommit: 50788e12bb744dd44da14184b3e884f9bddab828
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2019
ms.locfileid: "74160324"
---
# <a name="rehost-an-on-premises-linux-app-to-azure-vms-and-azure-database-for-mysql"></a>Повторное размещение локального приложения Linux на виртуальных машинах Azure и в Базе данных Azure для MySQL

В этой статье показано, как вымышленная компания Contoso повторно размещает двухуровневое приложение LAMP (Linux, Apache, MySQL, PHP), перенеся его из локальной среды в Azure, используя виртуальные машины Azure и Базу данных Azure для MySQL.

Приложение службы поддержки osTicket, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/osTicket/osTicket).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили следующие цели своей деятельности:

- **Адаптация к расширению бизнеса.** По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуру.
- **Ограничение рисков.** Приложение службы поддержки критически важно для деятельности бизнеса. Поэтому компания Contoso хочет переместить его в Azure с минимальными рисками.
- **Расширение.** В Contoso не намерены изменять приложение прямо сейчас. Компания просто хочет сохранить его стабильную работу.

## <a name="migration-goals"></a>Цели миграции

Для определения наилучшего способа миграции команда Contoso по работе в облаке определила ее цели.

- После миграции в Azure приложение должно иметь те же возможности с точки зрения производительности, что и в текущей локальной среде VMWare. В облаке приложение будет играть такую же критически важную роль, как в локальной среде.
- Компания Contoso не хочет вкладываться в это приложение. Оно очень важно для бизнеса, но компании просто нужно безопасно переместить его в облако в его текущей форме.
- После выполнения ряда переносов приложения Windows специалисты Contoso хотят освоить использование инфраструктуры на базе Linux в Azure.
- Компании необходимо свести к минимуму задачи администрирования баз данных после переноса приложения в облако.

## <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии:

- Приложение разбито на уровни на двух виртуальных машинах (`OSTICKETWEB` и `OSTICKETMYSQL`).
- Виртуальные машины расположены на узле VMware ESXi `contosohost1.contoso.com` (версии 6.5).
- Среда VMware находится под управлением сервера vCenter Server 6.5 (`vcenter.contoso.com`), запущенного на виртуальной машине.
- Компания Contoso использует локальный центр обработки данных (`contoso-datacenter`) с локальным контроллером домена (`contosodc1`).
- Приложение веб-уровня на `OSTICKETWEB` будет перенесено на виртуальную машину IaaS Azure.
- База данных приложения будет перенесена в Базу данных Azure для службы MySQL PaaS.
- Так как миграция в компании Contoso выполняется для рабочей нагрузки в рабочей среде, ресурсы будут находиться в рабочей группе ресурсов `ContosoRG`.
- Они будут реплицированы в основной регион (восточная часть США 2) и помещены в рабочую сеть (`VNET-PROD-EUS2`).
  - Виртуальная машина веб-уровня будет находиться в интерфейсной подсети (`PROD-FE-EUS2`).
  - Экземпляр базы данных будет находиться в подсети базы данных (`PROD-DB-EUS2`).
- База данных приложения будет перенесена в Базу данных Azure для MySQL с помощью инструментов MySQL.
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](./media/contoso-migration-rehost-linux-vm-mysql/architecture.png)

## <a name="migration-process"></a>Процесс миграции

Порядок миграции в Contoso будет следующим:

Миграция виртуальной машины веб-уровня

1. Для начала Contoso настроит Azure и локальную инфраструктуру, необходимые для развертывания Site Recovery.
2. После подготовки Azure и локальных компонентов компания Contoso настроит и включит репликацию для виртуальных машин веб-уровня.
3. После настройки и запуска репликации компания Contoso выполнит миграцию виртуальной машины путем отработки отказа в Azure.

Миграция базы данных

1. Contoso подготовит экземпляр MySQL в Azure.
2. Сотрудники компании Contoso настроят локально MySQL Workbench и резервное копирование базы данных.
3. После этого они восстановят базу данных из локальной резервной копии в Azure.

![Процесс миграции](./media/contoso-migration-rehost-linux-vm-mysql/migration-process.png)

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery) | Служба организует и контролирует миграцию и аварийное восстановление виртуальных машин Azure, а также локальных виртуальных машин и физических серверов. | Во время репликации в Azure взимается плата за службу хранилища Azure. При отработке отказа создаются виртуальные машины Azure, за которые взимается плата. Дополнительные сведения о ценах см. на [этой странице](https://azure.microsoft.com/pricing/details/site-recovery).
[База данных Azure для MySQL](https://docs.microsoft.com/azure/mysql) | База данных расположена на ядре сервера MySQL с открытым исходным кодом. Она предоставляет разработанную сообществом, полностью управляемую и готовую к использованию на предприятии базу данных MySQL как услугу для разработки и развертывания приложений.

## <a name="prerequisites"></a>предварительным требованиям

Ниже приведены действия компании Contoso, необходимые для этого сценария.

<!-- markdownlint-disable MD033 -->

**Требования** | **Дополнительные сведения**
--- | ---
**Подписка Azure.** | Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial).<br/><br/> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия.<br/><br/> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.<br/><br/> Если вам требуются более детализированные разрешения, ознакомьтесь с [этой статьей](https://docs.microsoft.com/azure/site-recovery/site-recovery-role-based-linked-access-control).
**Инфраструктура Azure** | Компания Contoso настраивает инфраструктуру Azure, как описано в статье [Развертывание инфраструктуры Azure для миграции в Contoso](./contoso-migration-infrastructure.md).<br/><br/> Изучите дополнительные сведения о конкретных требованиях к [сети](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) и [хранилищу](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) для Site Recovery.
**Локальные серверы** | Потребуется локальный сервер vCenter Server версии 5.5, 6.0 или 6.5.<br/><br/> Узел ESXi под управлением версии 5.5, 6.0 или 6.5.<br/><br/> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi.
**Локальные виртуальные машины** | [Ознакомьтесь с требованиями к виртуальной машине Linux](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#replicated-machines), которые необходимо выполнить для миграции с помощью Site Recovery.<br/><br/> Сверьтесь со списком поддерживаемых [систем хранения и файловых систем Linux](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#linux-file-systemsguest-storage).<br/><br/> Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).

<!-- markdownlint-enable MD033 -->

## <a name="scenario-steps"></a>Шаги выполнения сценария

Администраторы компании Contoso будут осуществлять миграцию следующим образом:

> [!div class="checklist"]
>
> - **Шаг 1. Подготовка Azure для Site Recovery.** Специалисты компании Contoso создают учетную запись хранения в Azure для хранения реплицируемых данных, а также хранилище Служб восстановления.
> - **Шаг 2. Подготовка локальной среды VMware для Site Recovery.** Специалисты компании Contoso подготавливают учетные записи для обнаружения виртуальных машин и установки агента и подключения к виртуальным машинам Azure после отработки отказа.
> - **Шаг 3. подготавливает базу данных.** Они подготавливают в Azure экземпляр Базы данных MySQL для Azure.
> - **Шаг 4. репликация виртуальных машин.** Специалисты компании Contoso настраивают исходную и целевую среды Site Recovery, устанавливают политику репликации и запускают репликацию виртуальных машин в хранилище Azure.
> - **Шаг 5. Перенос базы данных.** Специалисты компании Contoso настраивают миграцию с помощью инструментов MySQL.
> - **Шаг 6. Перенос виртуальных машин с Site Recovery.** Наконец, специалисты компании Contoso выполняют тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов, а затем выполняют полную отработку отказа для переноса виртуальных машин в Azure.

## <a name="step-1-prepare-azure-for-the-site-recovery-service"></a>Шаг 1. Подготовка Azure для службы Site Recovery

Contoso требуется несколько компонентов Azure для Site Recovery:

- Виртуальная сеть, в которой при выполнении отработки отказа находятся ресурсы. Специалисты компании Contoso уже создали виртуальную сеть во время [развертывания инфраструктуры Azure](./contoso-migration-infrastructure.md).
- новая учетная запись хранения Azure для размещения реплицируемых данных;
- хранилище служб восстановления в Azure.

Администраторы компании Contoso создают учетную запись хранения и хранилище следующим образом:

1. Они создают учетную запись хранения (**contosovmsacc20180528**) в регионе "Восточная часть США 2".

    - Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления.
    - Специалисты компании используют учетную запись общего назначения со стандартным хранилищем и репликацию LRS.

    ![Хранилище Site Recovery](./media/contoso-migration-rehost-linux-vm-mysql/asr-storage.png)

2. Теперь у специалистов есть сеть и учетная запись хранения, поэтому они могут приступать к созданию хранилища (ContosoMigrationVault) и поместить его в группу ресурсов **ContosoFailoverRG** в основном регионе "Восточная часть США 2".

    ![Хранилище служб восстановления](./media/contoso-migration-rehost-linux-vm-mysql/asr-vault.png)

**Требуется дополнительная помощь?**

Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) о настройке Azure для Site Recovery.

## <a name="step-2-prepare-on-premises-vmware-for-site-recovery"></a>Шаг 2. Подготовка локальных ресурсов VMware для Site Recovery

Администраторы компании Contoso подготавливают локальную инфраструктуру VMware следующим образом:

- Они создают учетную запись vCenter Server, чтобы автоматизировать обнаружение виртуальных машин.
- Они создают учетную запись для автоматической установки службы Mobility Service на каждой виртуальной машине VMware, которую нужно реплицировать.
- Специалисты компании подготавливают виртуальные машины в локальной среде, чтобы подключить их к виртуальным машинам Azure, когда они будут созданы после миграции.

### <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Администраторы компании Contoso настраивают учетную запись следующим образом:

1. Специалисты компании создают роль на уровне vCenter.
2. Затем они назначают этой роли необходимые разрешения.

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую Contoso хочет перенести.

- Site Recovery может автоматически принудительно устанавливать этот компонент при включении репликации для виртуальных машин.
- Для автоматической установки Site Recovery требуется учетная запись с разрешениями для доступа к виртуальной машине.
- Используются учетные данные, введенные при настройке репликации.
- Это может быть учетная запись домена или локальная учетная запись (при наличии у нее разрешения на установку).

### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Contoso необходимо, чтобы после отработки отказа в Azure была возможность подключения к виртуальным машинам Azure. Чтобы сделать это, администраторы компании Contoso выполняют следующие действия:

- Чтобы получить доступ к Интернету, следует включить SSH на локальных виртуальных машинах Linux перед миграцией. Для Ubuntu эту процедуру можно выполнить с помощью следующей команды: **Sudo apt-get ssh install -y**.
- После отработки отказа следует проверить данные **диагностики загрузки**, чтобы увидеть снимок виртуальной машины.
- Если возникли проблемы, следует убедиться, что виртуальная машина запущена, и ознакомиться с [рекомендациями по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

**Требуется дополнительная помощь?**

- Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) о создании и назначении роли для автоматического обнаружения.
- Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) о создании учетной записи для принудительной установки службы Mobility Service.

## <a name="step-3-provision-azure-database-for-mysql"></a>Шаг 3. Подготовка Базы данных Azure для MySQL

Администраторы компании Contoso подготавливают экземпляр базы данных MySQL в основном регионе "Восточная часть США 2".

1. Специалисты компании создают Базу данных Azure для ресурса MySQL на портале Azure.

    ![MySQL](./media/contoso-migration-rehost-linux-vm-mysql/mysql-1.png)

2. Они добавляют имя **contosoosticket** для базы данных Azure. Саму базу данных они добавляют в рабочую группу ресурсов **ContosoRG** и указывают для нее учетные данные.
3. В локальной среде используется база данных MySQL 5.7, поэтому для обеспечения совместимости выбрана именно эта версия. Для размера они выбирают значение по умолчанию, соответствующее требованиям компании для базы данных.

     ![MySQL](./media/contoso-migration-rehost-linux-vm-mysql/mysql-2.png)

4. В разделе **Варианты резервирования для архивации** специалисты выбирают **Геоизбыточное**. Этот вариант позволяет восстановить базу данных в дополнительном регионе "Центральная часть США" в случае сбоя. Данный параметр можно настроить только при подготовке базы данных.

     ![Избыточность](./media/contoso-migration-rehost-linux-vm-mysql/db-redundancy.png)

5. В сети **VNET-PROD-EUS2** сотрудники компании выбирают **Конечные точки службы**, чтобы добавить конечную точку службы (подсеть базы данных) для службы SQL.

    ![MySQL](./media/contoso-migration-rehost-linux-vm-mysql/mysql-3.png)

6. После добавления подсети они создают правило виртуальной сети, обеспечивающее доступ из подсети базы данных в рабочей сети.

    ![MySQL](./media/contoso-migration-rehost-linux-vm-mysql/mysql-4.png)

## <a name="step-4-replicate-the-on-premises-vms"></a>Шаг 4. Репликация локальных виртуальных машин

Прежде чем переносить виртуальную машину веб-уровня в Azure, администраторы компании Contoso должны настроить и включить репликацию.

### <a name="set-a-protection-goal"></a>Определение целевого объекта защиты

1. Целевой объект защиты задается в хранилище в разделе с его именем (ContosoVMVault) (**Приступая к работе** > **Site Recovery** > **Подготовка инфраструктуры**).
2. Специалисты Contoso указывают, что компьютеры размещены локально и являются виртуальными машинами VMware, а они хотят реплицировать их в Azure.

    ![Цель репликации](./media/contoso-migration-rehost-linux-vm-mysql/replication-goal.png)

### <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

Для продолжения они должны подтвердить, что планирование развертывания завершено, выбрав **Yes, I have done it** (Да, выполнено). В этом сценарии Contoso переносит только одну виртуальную машину, поэтому планирование развертывания не требуется.

### <a name="set-up-the-source-environment"></a>Настройка исходной среды

Теперь администраторы Contoso настраивают исходную среду. Для этого следует воспользоваться шаблоном OVF, чтобы развернуть на локальной виртуальной машине VMware сервер конфигурации Site Recovery с высоким уровнем доступности. После настройки и запуска сервера конфигурации сотрудники компании должны зарегистрировать его в хранилище.

На сервере конфигурации выполняется несколько компонентов.

- Компонент сервера конфигурации, который используется для координации обмена данными между локальным источником и Azure, а также для управления репликацией данных.
- Сервер обработки, который действует как шлюз репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure.
- Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.

Администраторы компании Contoso делают это следующим образом:

1. Загружают шаблон OVF из раздела **Подготовка инфраструктуры** > **Источник** > **Сервер конфигурации**.

    ![Скачивание OVF](./media/contoso-migration-rehost-linux-vm-mysql/add-cs.png)

2. Импортируют шаблон в VMware, чтобы создать и развернуть виртуальную машину.

    ![Шаблон OVF](./media/contoso-migration-rehost-linux-vm-mysql/vcenter-wizard.png)

3. При первом включении виртуальная машина загружается в среду установки Windows Server 2016. Специалисты компании принимают условия лицензионного соглашения и вводят пароль администратора.
4. После установки они входят в виртуальную машину от имени администратора. При первом входе в систему по умолчанию будет запущено средство настройки Azure Site Recovery.
5. В этом средстве они указывают имя, используемое для регистрации сервера конфигурации в хранилище.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure.
7. После создания подключения они входят систему в подписке Azure. У учетных данных должен быть разрешен доступ к хранилищу, в котором необходимо зарегистрировать сервер конфигурации.

    ![Регистрация сервера конфигурации](./media/contoso-migration-rehost-linux-vm-mysql/config-server-register2.png)

8. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
9. После этого специалисты выполняют повторный вход на компьютер, и мастер управления сервером конфигурации запускается автоматически.
10. В мастере необходимо выбрать сетевой адаптер для приема трафика репликации. Этот параметр нельзя изменить после настройки.
11. Далее специалисты выбирают подписку, группу ресурсов и хранилище для регистрации сервера конфигурации.

    ![Выбор хранилища Служб восстановления](./media/contoso-migration-rehost-linux-vm-mysql/cswiz1.png)

12. Теперь специалисты компании скачивают и устанавливают MySQL Server и VMWare PowerCLI.
13. После проверки они указывают FQDN или IP-адрес сервера vCenter либо узла vSphere. Они оставляют порт по умолчанию и указывают понятное имя для сервера vCenter Server.
14. Специалисты компании вводят учетную запись, созданную для автоматического обнаружения, и учетные данные, используемыми Site Recovery для автоматической установки службы Mobility Service.

    ![vCenter](./media/contoso-migration-rehost-linux-vm-mysql/cswiz2.png)

15. По окончании регистрации на портале Azure сотрудники компании проверяют, указаны ли серверы конфигурации и VMware на странице **Источник** в хранилище. Обнаружение может занять 15 минут или более.
16. Когда все готово, Site Recovery подключается к серверам VMware и обнаруживает виртуальные машины.

### <a name="set-up-the-target"></a>Настройка цели

Теперь администраторы компании Contoso вводят параметры репликации для целевой среды.

1. В разделе **Подготовка инфраструктуры** > **Цель** они задают параметры целевой среды.
2. Site Recovery проверяет наличие учетной записи хранения Azure и сети в указанной целевой среде.

### <a name="create-a-replication-policy"></a>Создание политики репликации

После настройки исходной и целевой среды администраторы компании Contoso готовы создать политику репликации.

1. В разделе **Подготовка инфраструктуры**  >  **Параметры репликации**  >  **Политика репликации**  >   **Создать и связать** специалисты компании создают политику **ContosoMigrationPolicy**.

2. При этом они используют параметр по умолчанию.
    - **Пороговое значение RPO:** Значение по умолчанию — 60 минут. Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
    - **Хранение точки восстановления:** Значение по умолчанию — 24 часа. Этим значением определяется продолжительность периода хранения для каждой точки восстановления. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
    - **Периодичность моментальных снимков с постоянными приложениями:** Значение по умолчанию — один час. Это значение указывает периодичность, с которой система создает моментальные снимки приложений.

        ![Создание политики репликации](./media/contoso-migration-rehost-linux-vm-mysql/replication-policy.png)

3. Политика автоматически сопоставляется с сервером конфигурации.

    ![Связывание политики репликации](./media/contoso-migration-rehost-linux-vm-mysql/replication-policy2.png)

**Требуется дополнительная помощь?**

- Полное пошаговое руководство для этих трех шагов см. в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).
- С помощью подробных инструкций вы можете [настроить исходную среду](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [развернуть сервер конфигурации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server) и [настроить параметры репликации](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).
- Дополнительные сведения о гостевом агенте Azure для Linux см. [на этой странице](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux).

### <a name="enable-replication-for-the-web-vm"></a>Включение репликации для виртуальной машины веб-уровня

Теперь администраторы Contoso могут запустить репликацию виртуальной машины **OSTICKETWEB**.

1. В разделе **Репликация приложений** > **Источник** >  **+Выполнить репликацию** они настраивают параметры источника.
2. Они указывают, что хотят включить виртуальные машины, и выбирают параметры исходной среды, в том числе сервер vCenter Server и сервер конфигурации.

    ![Включение репликации](./media/contoso-migration-rehost-linux-vm-mysql/enable-replication-source.png)

3. Теперь сотрудники компании указывают параметры целевой среды. В частности, они задают группу ресурсов и сеть, в которой будет размещена виртуальная машина Azure, созданная после отработки отказа, и учетную запись хранения, где будут храниться все реплицированные данные.

     ![Включение репликации](./media/contoso-migration-rehost-linux-vm-mysql/enable-replication2.png)

4. Они выбрали для репликации **OSTICKETWEB**.

    ![Включение репликации](./media/contoso-migration-rehost-linux-vm-mysql/enable-replication3.png)

5. В свойствах виртуальной машины сотрудники компании выбирают учетную запись, которая будет использоваться для автоматической установки службы Mobility Service на виртуальную машину.

     ![Служба мобильности](./media/contoso-migration-rehost-linux-vm-mysql/linux-mobility.png)

6. Они выбирают **Параметры репликации** > **Настройка параметров репликации**, проверяют правильность выбранной политики репликации и выбирают **Включить репликацию**. Служба Mobility Service установится автоматически.
7. Специалисты компании отслеживают ход репликации в разделе **Задания**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

**Требуется дополнительная помощь?**

Полное пошаговое руководство для всех этих шагов см. в статье [Включение репликации в Azure для виртуальных машин VMware](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).

## <a name="step-5-migrate-the-database"></a>Шаг5. Миграция базы данных

Администраторы компании Contoso выполняют миграцию базы данных с помощью функции резервного копирования и восстановления в инструментах MySQL. Специалисты установят MySQL Workbench, создадут резервную копию базы данных из OSTICKETMYSQL, а затем восстановят ее в Базе данных Azure для сервера MySQL.

### <a name="install-mysql-workbench"></a>Установка MySQL Workbench

1. Специалисты компании проверяют [предварительные условия и загружают MySQL Workbench](https://dev.mysql.com/downloads/workbench/?utm_source=tuicool).
2. Специалисты компании устанавливают MySQL Workbench для Windows в соответствии с [инструкциями по установке](https://dev.mysql.com/doc/workbench/en/wb-installing.html).
3. Они создают в среде MySQL Workbench подключение MySQL к OSTICKETMYSQL.

    ![MySQL Workbench](./media/contoso-migration-rehost-linux-vm-mysql/workbench1.png)

4. Они экспортируют базу данных в виде **osticket** в автономный файл.

    ![MySQL Workbench](./media/contoso-migration-rehost-linux-vm-mysql/workbench2.png)

5. После локальной архивации базы данных они создают подключения к Базе данных Azure для экземпляра MySQL.

    ![MySQL Workbench](./media/contoso-migration-rehost-linux-vm-mysql/workbench3.png)

6. Теперь специалисты компании могут импортировать (восстановить) базу данных в экземпляре Azure MySQL из автономного файла. Для экземпляра создается новая схема (osticket).

    ![MySQL Workbench](./media/contoso-migration-rehost-linux-vm-mysql/workbench4.png)

## <a name="step-6-migrate-the-vms-with-site-recovery"></a>Шаг 6. Миграция виртуальных машин с помощью Site Recovery

Наконец, администраторы компании Contoso выполняют быструю тестовую отработку отказа, а затем — миграцию виртуальной машины.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

Тестовая отработка отказа позволяет убедиться перед миграцией в том, что все работает как надо.

1. Специалисты компании Contoso запускают тестовую отработку отказа для последнего доступного момента времени: **Latest processed** (Последняя обработанная).
2. Они выбирают **Shut down machine before beginning failover** (Завершить работу машины перед началом отработки отказа), поэтому перед запуском отработки отказа Site Recovery пытается завершить работу исходной виртуальной машины. Отработка отказа продолжится, даже если их не удастся отключить.
3. При тестировании отработки отказа происходит следующее:

    - выполняется проверка на соблюдение всех необходимых условий для миграции;
    - операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе данных создается точка восстановления;
    - создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

4. По завершении отработки отказа на портале Azure появится реплика виртуальной машины Azure. Специалисты убеждаются, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
5. После проверки они выполняют очистку отработки отказа, а также записывают и сохраняют все наблюдения.

### <a name="migrate-the-vm"></a>Миграция виртуальной машины

Чтобы выполнить миграцию виртуальной машины, администраторы компании Contoso создают план восстановления, который включает виртуальную машину, и выполняют его путем отработки отказа в Azure.

1. Они создают план и добавляют в него **OSTICKETWEB**.

    ![План восстановления](./media/contoso-migration-rehost-linux-vm-mysql/recovery-plan.png)

2. Специалисты компании выполняют для этого плана отработку отказа. Они выбирают последнюю точку восстановления и указывают, что Site Recovery следует попытаться завершить работу виртуальных машин, прежде чем запустить отработку отказа. Специалисты компании могут отслеживать ход отработки отказа на странице **Задания**.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm-mysql/failover1.png)

3. Во время отработки отказа vCenter Server выдает команды для остановки на двух виртуальных машинах, запущенных на узле ESXi.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm-mysql/vcenter-failover.png)

4. После отработки отказа специалисты компании проверяют, отображается ли виртуальная машина Azure должным образом на портале Azure.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm-mysql/failover2.png)

5. После проверки виртуальной машины они завершают миграцию. В результате репликация виртуальных машин останавливается и плата за них в Site Recovery не начисляется.

    ![Отработка отказа](./media/contoso-migration-rehost-linux-vm-mysql/failover3.png)

**Требуется дополнительная помощь?**

- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) выполнить тестовую отработку отказа.
- [Узнайте](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans), как создать план восстановления.
- [Узнайте, как](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) выполнить отработку отказа в Azure.

### <a name="connect-the-vm-to-the-database"></a>Подключение виртуальной машины к базе данных

На последнем этапе процесса миграции администраторам компании Contoso необходимо обновить строку подключения приложения, чтобы она указывала на Базу данных Azure для MySQL.

1. Специалисты компании устанавливают SSH-подключения к виртуальной машине OSTICKETWEB с помощью Putty или другого клиента SSH. Виртуальная машина частная, поэтому для подключения к ней используется частный IP-адрес.

    ![Подключение к базе данных](./media/contoso-migration-rehost-linux-vm-mysql/db-connect.png)

    ![Подключение к базе данных](./media/contoso-migration-rehost-linux-vm-mysql/db-connect2.png)

2. Они обновляют параметры, чтобы виртуальная машина **OSTICKETWEB** могла взаимодействовать с базой данных **OSTICKETMYSQL**. Сейчас в конфигурации жестко закодирован локальный IP-адрес 172.16.0.43.

    **Перед обновлением**

    ![Обновление IP-адреса](./media/contoso-migration-rehost-linux-vm-mysql/update-ip1.png)

    **После обновления**

    ![Обновление IP-адреса](./media/contoso-migration-rehost-linux-vm-mysql/update-ip2.png)

    ![Обновление IP-адреса](./media/contoso-migration-rehost-linux-vm-mysql/update-ip3.png)

3. Специалисты компании перезапускают службу с помощью команды **systemctl перезапустите apache2**.

    ![Перезагрузить](./media/contoso-migration-rehost-linux-vm-mysql/restart.png)

4. Наконец, они обновляют записи DNS для **OSTICKETWEB** на одном из контроллеров домена Contoso.

    ![Обновление DNS](./media/contoso-migration-rehost-linux-vm-mysql/update-dns.png)

## <a name="clean-up-after-migration"></a>Очистка после миграции

По завершении миграции уровни приложения osTicket работают на виртуальных машинах Azure.

Для этого Contoso потребуется предпринять следующее:

- Удалить виртуальную машину VMware из перечня в vCenter.
- Удалить локальные виртуальные машины из локальных заданий резервного копирования.
- Обновить внутренние документы и указать в них новые расположения и IP-адреса.
- Проверить все ресурсы, взаимодействующие с локальными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.
- Специалисты Contoso использовали службу "Миграция Azure" с сопоставлением зависимостей для оценки пригодности виртуальной машины **OSTICKETWEB** для миграции. Теперь они должны удалить агенты (Microsoft Monitoring Agent и агент зависимостей Майкрософт), установленные для этой цели, с виртуальной машины.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда приложение работает, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Специалисты по безопасности компании Contoso проверяют виртуальную машину и базу данных на наличие любых проблем с безопасностью.

- Чтобы оценить возможность управления доступом, они проверяют группы безопасности сети (NSG) для виртуальной машины. NSG позволяют пропускать только разрешенный для приложения трафик.
- Специалисты компании анализируют возможность защиты данных на диске виртуальной машины с помощью шифрования дисков и Azure Key Vault.
- Поддержка SSL для обмена данными между экземпляром виртуальной машины и базой данных не настроена. Поэтому им необходимо будет сделать это, чтобы предотвратить взлом трафика, базы данных.

Дополнительные сведения см. в статье рекомендации [по обеспечению безопасности для рабочих нагрузок IaaS в Azure](https://docs.microsoft.com/azure/security/fundamentals/iaas).

### <a name="bcdr"></a>BCDR

Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление, специалисты компании Contoso выполняют указанные ниже действия.

- **Безопасное хранение данных.** Компания Contoso выполняет резервное копирование данных с виртуальных машин приложения при помощи службы Azure Backup. [Дополнительные сведения](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) Ее специалистам нет необходимости настраивать резервное копирование для базы данных. В службе "База данных Azure для MySQL" для сервера автоматически создаются и сохраняются резервные копии. Они решили использовать для базы данных геоизбыточное хранилище, поэтому она отказоустойчива и готова к внедрению в рабочую среду.
- **Поддержание бесперебойной работы приложений.** Специалисты компании Contoso реплицируют виртуальные машины приложения в дополнительный регион Azure с помощью Site Recovery. [Дополнительные сведения](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart)

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания ресурсов Contoso назначает теги Azure в соответствии с решениями, принятыми на этапе развертывания [инфраструктуры Azure](./contoso-migration-infrastructure.md#set-up-tagging).
- У Contoso нет проблем с лицензированием серверов Ubuntu.
- Компания Contoso будет использовать Управление затратами Azure по лицензии Cloudyn (дочернее подразделение Майкрософт). Это решение по управлению затратами для нескольких облаков, которое позволяет использовать облака Azure и другие облачные ресурсы, а также управлять ими. [Узнайте больше](https://docs.microsoft.com/azure/cost-management/overview) об Управлении затратами Azure.
