---
title: Рефакторинг приложения путем его переноса в службу приложений Azure и Управляемый экземпляр Базы данных SQL Azure
description: Сведения о том, как Contoso перемещает локальное приложение, переносит его в веб-приложение службы приложений Azure и Управляемый экземпляр Базы данных SQL Azure.
author: givenscj
ms.author: abuck
ms.date: 04/02/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 1de34dc3a37414a87bdc89b233af2e2564d44b10
ms.sourcegitcommit: 6fef15cc3a8af725dc743e19f127513bc58dd257
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2020
ms.locfileid: "84023497"
---
<!-- cSpell:ignore givenscj WEBVM SQLVM contosohost vcenter contosodc smarthotel SQLMI SHWCF SHWEB -->

# <a name="refactor-an-on-premises-app-to-an-azure-app-service-web-app-and-azure-sql-managed-instance"></a>Рефакторинг локального приложения в веб-приложение службы приложений Azure и Azure SQL Управляемый экземпляр

В этой статье показано, как вымышленная компания Contoso выполняет рефакторинг двухуровневого приложения .NET для Windows, работающего на виртуальных машинах VMware, в процессе миграции на платформу Azure. Они переносят клиентскую виртуальную машину приложения в веб-приложение службы приложений Azure. В ней также показано, как компания Contoso переносит базу данных приложения на Управляемый экземпляр Базы данных SQL Azure.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуру.
- **Повышение эффективности.** Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости.**  ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования. Он не должен мешать или становиться помехой для бизнеса.
- **Измените.** По мере успешного роста бизнеса ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.
- **Сократите затраты.** Компании Contoso требуется минимизировать затраты на лицензирование.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

<!-- markdownlint-disable MD033 -->

**Требования** | **Сведения**
--- | ---
**Приложение** | Потребность использовать приложение в Azure всегда будет критически важной. <br><br> Должны быть доступны те же возможности производительности, что и в настоящее время в VMware. <br><br> Команда не считает нужным вкладывать средства в это приложение. Сейчас администраторы будут просто безопасно перемещать приложение в облако. <br><br> Команда хочет прекратить поддержку ОС Windows Server 2008 R2, на которой в настоящее время работает приложение. <br><br> Команда также хочет перейти с SQL Server 2008 R2 на современную платформу баз данных PaaS, что снизит необходимость в управлении. <br><br> Contoso хочет использовать преимущества своих инвестиций в лицензирование SQL Server и Software Assurance по мере возможности. <br><br> Кроме того, компания Contoso хочет перенести единую точку отказа на веб-уровень.
**Ограничения** | Приложение состоит из приложения ASP.NET и службы WCF, работающей на той же виртуальной машине. С помощью Службы приложений Azure специалисты компании хотят разделить это приложение между двумя веб-приложениями.
**Azure** | Компания Contoso хочет перенести приложение в Azure, но не запускать его на виртуальных машинах. Компания хочет использовать службы PaaS Azure и для уровня данных, и для веб-уровня.
**DevOps** | Contoso хочет перейти на модель DevOps, используя Azure DevOps для конвейеров сборки и выпуска.

<!-- markdownlint-enable MD033 -->

## <a name="solution-design"></a>Архитектура решения

Определив цели и требования, специалисты Contoso начинают разработку и анализ решения развертывания и идентифицируют процесс миграции, включая службы Azure, которые будут использоваться при миграции.

### <a name="current-app"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено на уровни на двух виртуальных машинах (WEBVM и SQLVM).
- Виртуальные машины расположены на VMware ESXi узле **contosohost1.contoso.com** (версия 6,5).
- Управление средой VMware осуществляется с помощью vCenter Server 6,5 (**vCenter.contoso.com**), выполняющегося на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (**contosodc1**).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

### <a name="proposed-solution"></a>Предлагаемое решение

- Компания Contoso решила использовать Службу приложений Azure для веб-уровня приложения. Служба PaaS позволяет развернуть приложение, внеся лишь несколько изменений в конфигурацию. Contoso хочет использовать Visual Studio для внесения изменений и развертывания двух веб-приложений. Одно для веб-сайта, а другое для службы приложения WCF.
- Для удовлетворения требований к DevOps конвейеру компания Contoso выбрала DevOps Azure для управления исходным кодом с помощью git репозиториев. Автоматические сборки и выпуски будут использоваться для компиляции кода и развертывания его в Службе приложений Azure.

### <a name="database-considerations"></a>Рекомендации по базе данных

В ходе проектирования решения специалисты Contoso сравнили функции Базы данных Azure SQL и Управляемого экземпляра SQL Server. На выбор Управляемого экземпляра повлияли описанные ниже факторы.

- Управляемый экземпляр призван обеспечить практически 100-процентную совместимость с последней версией локального сервера SQL Server. Корпорация Майкрософт рекомендует Управляемый экземпляр тем клиентам, которые используют локальный сервер SQL Server или виртуальную машину IaaS и хотят перенести свои приложения в полностью управляемую службу с минимальными изменениями структуры.
- Компания Contoso планирует перенести большое количество приложений из локальной среды в IaaS. Многие из них предоставляются независимыми поставщиками программного обеспечения. Специалисты Contoso приходят к выводу, что использование Управляемого экземпляра поможет обеспечить совместимость этих приложений с базой данных, не используя службу "База данных SQL", которая может не поддерживаться.
- Компания Contoso может просто выполнить миграцию с переносом на Управляемый экземпляр с помощью полностью автоматизированных Azure Database Migration Service. Подготовив эту службу, Contoso сможет использовать ее при миграции баз данных в будущем.
- Управляемый экземпляр SQL поддерживает агент SQL Server, что важно для приложения SmartHotel360. Компании Contoso нужна эта совместимость, так как без нее придется заново проектировать планы обслуживания приложения.
- Software Assurance позволит Contoso приобрести Управляемый экземпляр Базы данных SQL по сниженной цене, воспользовавшись Преимуществом гибридного использования Azure для SQL Server. Это позволит компании Contoso сэкономить до 30 % на Управляемом экземпляре.
- SQL Управляемый экземпляр полностью содержится в виртуальной сети, поэтому обеспечивает более высокий уровень изоляции и безопасности данных Contoso. Компания Contoso может пользоваться преимуществами общедоступного облака, сохраняя изолированность среды от публичного сегмента Интернета.
- Управляемый экземпляр поддерживает множество функций безопасности, в том числе Always Encrypted, динамическую маскировку данных, защиту на уровне строк и обнаружение угроз.

### <a name="solution-review"></a>Проверка решения

Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

<!-- markdownlint-disable MD033 -->

**Оценка** | **Сведения**
--- | ---
**Плюсы** | Код приложения SmartHotel360 потребуется изменить для миграции в Azure. <br><br> Contoso может использовать преимущества своих инвестиций в программу Software Assurance, используя Преимущество гибридного использования Azure для SQL Server и Windows Server. <br><br> Windows Server 2008 R2 не нужно будет поддерживать после миграции. Дополнительные сведения см. в статье [Политика жизненного цикла Майкрософт](https://aka.ms/lifecycle). <br><br> Contoso может настроить веб-уровень приложения с несколькими экземплярами, после чего он больше не будет являться единой точкой отказа. <br><br> Исчезнет зависимость базы данных от устаревающей платформы SQL Server 2008 R2. <br><br> Управляемый экземпляр SQL соответствует техническим требованиям и целям компании Contoso. <br><br> Управляемый экземпляр обеспечит 100-процентную совместимость с текущим развертыванием, позволяя компании прекратить использование SQL Server 2008 R2. <br><br> Компания может задействовать свои инвестиции в программу Software Assurance, воспользовавшись Преимуществом гибридного использования Azure для SQL Server и Windows Server. <br><br> Службу Azure Database Migration Service можно будет повторно использовать для миграции в будущем. <br><br> В Управляемый экземпляр Базы данных SQL встроены средства обеспечения отказоустойчивости, которые специалистам Contoso не требуется настраивать. Это гарантия того, что уровень данных больше не является единой точкой отказа.
**Минусы** | Служба приложений Azure поддерживает только одно развертывание приложения для каждого веб-приложения. Это означает, что необходимо подготовить два веб-приложения (одно для веб-сайта, а другое для службы WCF). <br><br> На уровне данных Управляемый экземпляр может быть не лучшим решением, если компании Contoso требуется настраивать операционную систему или сервер базы данных либо запускать сторонние приложения наряду с SQL Server. Использование SQL Server на виртуальной машине IaaS может обеспечить такую гибкость.

<!-- markdownlint-enable MD033 -->

## <a name="proposed-architecture"></a>Предлагаемая архитектура

![Архитектура сценария](./media/contoso-migration-refactor-web-app-sql-managed-instance/architecture.png)

### <a name="migration-process"></a>Процесс миграции

1. Компания Contoso подготавливает Управляемый экземпляр Базы данных SQL Azure и переносит на нее базу данных SmartHotel360 с помощью Azure Database Migration Service (DMS).
2. Специалисты Contoso подготавливают и настраивают веб-приложения и развертывают в них приложение SmartHotel360.

    ![Процесс миграции](./media/contoso-migration-refactor-web-app-sql-managed-instance/migration-process.png)

### <a name="azure-services"></a>Службы Azure

**Служба** | **Описание** | **Стоимость**
--- | --- | ---
[Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает прозрачную миграцию из нескольких источников баз данных на платформы данных Azure с минимальным временем простоя. | Дополнительные сведения о [поддерживаемых регионах](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) см. на странице [цен на Database Migration Service](https://azure.microsoft.com/pricing/details/database-migration).
[Управляемый экземпляр Базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | Управляемый экземпляр — это служба управляемой базы данных, которая представляет полностью управляемый экземпляр SQL Server в облаке Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | За использование Управляемых экземпляров Базы данных SQL, выполняемых в Azure, взимается плата на основе емкости. Дополнительные сведения см. в статье [Цены на Базу данных SQL Azure ](https://azure.microsoft.com/pricing/details/sql-database/managed).
[служба приложений Azure](https://docs.microsoft.com/azure/app-service/overview); | Создавайте мощные облачные приложения с помощью полностью управляемой платформы. | Стоимость зависит от размера, расположения и длительности использования. [Подробнее.](https://azure.microsoft.com/pricing/details/app-service/windows)
[Azure Pipelines](https://docs.microsoft.com/azure/devops/pipelines/get-started/what-is-azure-pipelines) | Предоставляет конвейер непрерывной интеграции и непрерывного развертывания (CI/CD) для разработки приложений. Конвейер запускается с репозиторием Git для управления кодом приложения, системой сборки для создания пакетов и других артефактов сборки и системой управления выпусками для развертывания изменений в средах разработки, тестирования и рабочей среде.

## <a name="prerequisites"></a>Предварительные требования

Ниже показано, что необходимо сделать специалистам компании Contoso, чтобы реализовать этот сценарий.

<!-- markdownlint-disable MD033 -->

**Требования** | **Сведения**
--- | ---
**Подписка Azure.** | Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника.
**Инфраструктура Azure** | [Узнайте, как](./contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure.

<!--markdownlint-enable MD033 -->

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Настройка Управляемый экземпляр Базы данных SQL.** Компании Contoso необходим существующий управляемый экземпляр, в который будет перенесена локальная база данных SQL Server.
> - **Шаг 2. Миграция с помощью Azure Database Migration Service (DMS).** Компания Contoso переносит базу данных приложений в службу Azure Data Migration Service.
> - **Шаг 3. предоставление веб-приложений.** Специалисты компании Contoso выполняют подготовку двух веб-приложений.
> - **Шаг 4. Настройка Azure DevOps.** Специалисты компании Contoso создают новый проект Azure DevOps и импортируют репозитории Git.
> - **Шаг 5. Настройка строк подключения.** Специалисты компании Contoso настраивают строки подключения для обеспечения взаимодействия веб-приложения веб-уровня, веб-приложения службы WCF и экземпляра SQL.
> - **Шаг 6. Настройка конвейеров сборки и выпуска.** В качестве последнего шага компания Contoso настраивает конвейеры сборки и выпуска для создания приложения и развертывает их в двух отдельных веб-приложениях.

## <a name="step-1-set-up-a-sql-database-managed-instance"></a>Шаг 1. Настройка Управляемый экземпляр Базы данных SQL

Чтобы настроить управляемый экземпляр Базы данных SQL Azure, специалистам компании Contoso требуется подсеть, которая соответствует следующим требованиям.

- Подсеть должна быть выделенной. Она должна быть пустой и не содержать другие облачные службы. Подсеть не должна быть подсетью шлюза.
- После создания Управляемого экземпляра компания не должна добавлять ресурсы в подсеть.
- С подсетью не должна быть связана группа безопасности сети.
- Подсеть должна иметь определяемую пользователем таблицу маршрутов. Должен быть назначен единственный интернет-маршрут следующего прыжка 0.0.0.0/0.
- Если для виртуальной сети указан необязательный настраиваемый DNS-сервер, виртуальный IP-адрес `168.63.129.16` для рекурсивных арбитров конфликтов в Azure должен быть добавлен в список. Узнайте, как [настроить пользовательский DNS для управляемый экземпляр базы данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (служба хранилища или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. Дополнительные сведения см. в разделе [Определение размера подсети для управляемого экземпляра](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-configure-vnet-subnet).
- В гибридной среде Contoso требуются пользовательские параметры DNS. Компания Contoso настроит параметры DNS для использования одного или нескольких серверов DNS Azure компании. Дополнительные сведения о [настройке DNS](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a>Настройка виртуальной сети в управляемом экземпляре

Администраторы Contoso настраивают виртуальную сеть следующим образом:

1. Они создают виртуальную сеть (**VNET-SQLMI-EU2**) в основном регионе "Восточная часть США 2". Она добавит виртуальную сеть для группы ресурсов **ContosoNetworkingRG**.
2. Они назначают адресное пространство 10.235.0.0/24. Они гарантируют, что диапазон не пересекается с другими сетями в организации.
3. Они добавят к сети две подсети:
    - **Склми-DS-EUS2** (10.235.0.0.25).
    - **Склми-видели-EUS2** (10.235.0.128/29). Эта подсеть используется для присоединения каталога в Управляемом экземпляре.

      ![Управляемый экземпляр: создание виртуальной сети](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

4. После развертывания виртуальной сети и подсетей они назначают сетям ранги следующим образом:

    - Согласовывается ранг **VNET-SQLMI-EUS2** и **VNET-HUB-EUS2** (центр виртуальной сети для восточной части США 2).
    - Одноранговые узлы **vnet-склми-EUS2** с **vnet-Production-EUS2** (производственная сеть).

      ![Пиринг сетей](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

5. Они задают пользовательские параметры DNS. Служба доменных имен (DNS) сначала указывает на контроллеры домена Azure компании Contoso. Azure DNS является вторичной. Контроллеры домена Contoso Azure находятся в следующих расположениях.

    - Находится в подсети "Production **-DC-EUS2** " в рабочей сети восточной части США 2 (**vnet-произв-EUS2**).
    - **CONTOSODC3** адрес: 10.245.42.4.
    - **CONTOSODC4** адрес: 10.245.42.5.
    - Сопоставитель Azure DNS: 168.63.129.16.

      ![DNS-серверы сети](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

**Требуется дополнительная помощь?**

- Ознакомьтесь с [обзором управляемый экземпляр базы данных SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance).
- См. раздел [Создание виртуальной сети для управляемых экземпляров](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-configure-vnet-subnet).
- См. раздел [Создание, изменение и удаление пиринга в виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering).
- См. раздел [Включение доменных служб Azure Active Directory](https://docs.microsoft.com/azure/active-directory-domain-services/tutorial-create-instance).

### <a name="set-up-routing"></a>Настройка маршрутизации

Управляемый экземпляр помещается в закрытую виртуальную сеть. Компании Contoso необходима таблица маршрутов для виртуальной сети, чтобы взаимодействовать со службой управления Azure. Если виртуальная сеть не может связаться со службой, которая ею управляет, виртуальная сеть становится недоступной.

Компания Contoso принимает во внимание следующие факторы.

- Таблица маршрутизации с набором правил (маршрутов), указывающих, как отправляемые пакеты с Управляемого экземпляра должны маршрутизироваться в виртуальной сети.
- Таблица маршрутов связана с подсетями, в которых развернуты управляемые экземпляры. Каждый пакет, который оставляет подсеть, обрабатывается на основе связанной таблицы маршрутизации.
- Подсеть может быть связана только с одной таблицей маршрутизации.
- Никаких дополнительных затрат при создании таблицы маршрутизации в Microsoft Azure не требуется.

 Для настройки маршрутизации администраторы Contoso делают следующее:

1. Они создают определяемую пользователем таблицу маршрутов в группе ресурсов **ContosoNetworkingRG**.

    ![Таблица маршрутов](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

2. Чтобы соответствовать требованиям Управляемого экземпляра, после развертывания таблицы маршрутизации (**MIRouteTable**) они добавляют маршрут с префиксом адреса 0.0.0.0/0. Параметр **Тип следующего прыжка** установлен как **Интернет**.

    ![Префикс таблицы маршрутизации](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)

3. Они связывают таблицу маршрутов с подсетью **SQLMI-DB-EUS2** (в сети **VNET-SQLMI-EUS2**).

    ![Подсеть таблицы маршрутизации](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)

**Требуется дополнительная помощь?**

См. в разделе [Создание таблицы маршрутов и маршрута](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started).

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

Теперь администраторы Contoso могут подготовить Управляемый экземпляр Базы данных SQL.

1. Так как Управляемый экземпляр работает в качестве бизнес-приложения, они развертывают его в основном регионе "Восточная часть США 2". Они добавляют Управляемый экземпляр в группу ресурсов **ContosoRG**.
2. Они выбирают ценовую категорию и размер вычислений и хранилище для экземпляра. Дополнительные сведения см. в статье [Цены на Базу данных SQL Azure ](https://azure.microsoft.com/pricing/details/sql-database/managed).

    ![Базы данных SQL](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

3. После развертывания Управляемый экземпляр в группе ресурсов **ContosoRG** появятся два новых ресурса:

    - Виртуальный кластер, если у Contoso есть несколько Управляемых экземпляров.
    - Управляемый экземпляр Базы данных SQL Azure.

      ![Базы данных SQL](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

**Требуется дополнительная помощь?**

См. в разделе [Создание управляемого экземпляра базы данных SQL Azure на портале Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started).

## <a name="step-2-migrate-with-azure-database-migration-service-dms"></a>Шаг 2. Миграция с помощью Azure Database Migration Service (DMS)

Администраторы Contoso переходят с помощью служб Azure Database Migration Services (DMS), используя пошаговое [руководство по миграции](https://docs.microsoft.com/azure/dms/tutorial-sql-server-azure-sql-online). Они могут выполнять интерактивные, автономные и гибридные миграции (Предварительная версия).

В качестве сводки необходимо выполнить следующие действия.

- Создайте Azure Database Migration Service (DMS) с `Premium` номером SKU, подключенным к виртуальной сети.
- Убедитесь, что Azure Database Migration Service (DMS) имеет доступ к удаленным SQL Server через виртуальную сеть. Это гарантирует, что все входящие порты будут разрешены в Azure для SQL Server на уровне виртуальной сети, в сети VPN и на компьютере, на котором размещается SQL Server.
- Настройте Azure Database Migration Service.
  - Создайте проект миграции.
  - Добавьте источник (локальная база данных).
  - Выберите целевой объект.
  - Выберите базы данных для миграции.
  - Настройка дополнительных параметров.
  - Запустите репликацию.
  - Устраните возможные ошибки.
  - Выполните окончательный прямую миграцию.

## <a name="step-3-provision-web-apps"></a>Шаг 3. предоставление веб-приложений

Сейчас, когда база данных уже перенесена, администраторы Contoso могут подготовить два веб-приложения.

1. На портале специалисты компании выбирают **Веб-приложение**.

    ![Веб-приложение](./media/contoso-migration-refactor-web-app-sql-managed-instance/web-app1.png)

2. Они указывают имя приложения (**SHWEB EUS2**), запускают его в Windows и помещают в производственную группу ресурсов **ContosoRG**. Специалисты компании создают веб-приложение и план службы приложений Azure.

    ![Веб-приложение](./media/contoso-migration-refactor-web-app-sql-managed-instance/web-app2.png)

3. После подготовки веб-приложения специалисты компании повторяют процедуру для создания веб-приложения службы WCF (**SHWCF-EUS2**).

    ![Веб-приложение](./media/contoso-migration-refactor-web-app-sql-managed-instance/web-app3.png)

4. По завершении создания специалисты компании перейдут по адресам приложений, чтобы проверить, что они были созданы успешно.

## <a name="step-4-set-up-azure-devops"></a>Шаг 4. Настройка Azure DevOps

Компании Contoso необходимо создать инфраструктуру DevOps и конвейеры для приложения. Для этого администраторы Contoso создают проект DevOps, импортируют код, а затем настраивают конвейеры сборки и выпуска.

1. В учетной записи Azure DevOps Contoso они создают проект (**ContosoSmartHotelRefactor**) и выбирают **Git** для управления версиями.

    ![Новый проект](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts1.png)

2. Они импортируют репозиторий Git, в котором на данный момент хранится код их приложения. Он находится в [общедоступном репозитории GitHub](https://github.com/Microsoft/SmartHotel360-Registration) , и его можно скачать.

    ![Скачивание кода приложения](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts2.png)

3. После импорта кода они подключают Visual Studio к репозиторию и клонируют код с помощью Team Explorer.

    ![Подключение к проекту](./media/contoso-migration-refactor-web-app-sql-managed-instance/devops1.png)

4. После клонирования репозитория на компьютер для разработки они открывают файл решения для приложения. В этом файле у веб-приложения и службы WCF есть отдельные проекты.

    ![Файл решения](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts4.png)

## <a name="step-5-configure-connection-strings"></a>Шаг 5. Настройка строк подключения

Администраторы компании Contoso должны убедиться, что веб-приложения и база данных могут взаимодействовать. Чтобы сделать это, они настраивают строки подключения в коде и в веб-приложениях.

1. В веб-приложении для службы WCF (**SHWCF-EUS2**) > **Параметры** > **Параметры приложения** они добавляют новую строку подключения с именем **DefaultConnection**.
2. Строка подключения извлекается из базы данных **SmartHotel-Registration** и должна быть обновлена с правильными учетными данными.

    ![Строка подключения.](./media/contoso-migration-refactor-web-app-sql-managed-instance/string1.png)

3. С помощью Visual Studio специалисты компании открывают проект **SmartHotel.Registration.wcf** из файла решения. Раздел **connectionStrings** файла Web. config для службы WCF **смарсотел. Registration. WCF** следует обновить с помощью строки подключения.

     ![Строка подключения.](./media/contoso-migration-refactor-web-app-sql-managed-instance/string2.png)

4. Необходимо изменить **клиентский** раздел файла Web. config для **смарсотел. Registration. Web** , чтобы он указывал на новое расположение службы WCF. Это URL-адрес веб-приложения WCF, на котором размещена конечная точка службы.

    ![Строка подключения.](./media/contoso-migration-refactor-web-app-sql-managed-instance/strings3.png)

5. После внесения изменений в код администраторам необходимо зафиксировать их. С помощью Team Explorer в Visual Studio они выполняют фиксацию и синхронизацию.

## <a name="step-6-set-up-build-and-release-pipelines-in-azure-devops"></a>Шаг 6. Настройка конвейеров сборки и выпуска в Azure DevOps

Теперь администраторы Contoso настраивают Azure DevOps для сборки и выпуска.

1. В Azure DevOps выберите **Сборка и выпуск**  >  **нового конвейера**.

    ![Новый конвейер](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline1.png)

2. Они выбирают **Azure Repos Git** и соответствующий репозиторий.

    ![Git и репозиторий](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline2.png)

3. В разделе **Выбор шаблона** они выбирают шаблон ASP.NET для сборки.

     ![Шаблон ASP.NET](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline3.png)

4. Для сборки используется имя **ContosoSmartHotelRefactor-ASP.NET-CI**. Администраторы выбирают **Сохранить и поместить в очередь**.

     ![Сохранение и помещение в очередь](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline4.png)

5. После этого запускается их первая сборка. Они выбирают номер сборки для просмотра процесса. После завершения они могут увидеть итоговые сведения о процессе и выбирают **Артефакты**, чтобы просмотреть результаты сборки.

    ![Просмотр](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline5.png)

6. Результаты сборки находятся в папке **Drop**.

    - Два ZIP-файла являются пакетами, которые содержат приложения.
    - Эти файлы используются в конвейере выпуска для развертывания в Службе приложений Azure.

     ![Артефакт](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline6.png)

7. Они выбирают **выпуски**  >  **+ Новый конвейер**.

    ![Новый конвейер](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline7.png)

8. Они выбирают шаблон развертывания Службы приложений Azure.

    ![Шаблон развертывания для Службы приложений Azure](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline8.png)

9. Они присваивают конвейеру выпуска имя **ContosoSmartHotel360Refactor** и указывают имя веб-приложения WCF (SHWCF-EUS2) для имени **этапа**.

    ![Среда](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline9.png)

10. В разделе этапов они выбирают **1 задание, 1 задача**, чтобы настроить развертывание службы приложения WCF.

    ![Развертывание WCF](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline10.png)

11. Они проверяют, что подписка выбрана и авторизована, а затем выбирают **имя службы приложений**.

     ![Выбор имени службы приложений](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline11.png)

12. В конвейере в разделе **Артефакты** они выбирают **+ Добавить артефакт** и выбирают создание с конвейером **ContosoSmarthotel360Refactor**.

     ![Сборка](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline12.png)

13. Они щелкают молнию на артефакте, чтобы включить триггер непрерывного развертывания.

     ![Молния](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline13.png)

14. Триггер непрерывного развертывания должен быть в положении **Включено**.

    ![Непрерывное развертывание включено](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline14.png)

15. Теперь они переходят к заданию 1 задачи 1 этапа и щелкают **Развертывание службы приложений Azure**.

    ![развертывание Службы приложений Azure;](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline15.png)

16. В разделе **Выберите файл или папку** они находят файл **SmartHotel.Registration.Wcf.zip**, который был создан во время выполнения сборки, и щелкают **Сохранить**.

    ![Сохранение WCF](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline16.png)

17. Они выбирают **Этапы конвейера**  >  **Stages**, **+ Добавить** , чтобы добавить среду для **швеб-EUS2**. Они выбирают другое развертывание Службы приложений Azure.

    ![Добавление среды](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline17.png)

18. Специалисты компании повторяют действия для публикации файла веб-приложения (**SmartHotel.Registration.Web.zip**) для соответствующего веб-приложения.

    ![Публикация веб-приложения](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline18.png)

19. После сохранения конвейер выпуска будет отображаться следующим образом.

     ![Итоговое представление конвейера выпуска](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline19.png)

20. Специалисты компании возвращаются в раздел **Сборка** и выбирают **Триггеры** > **Включить непрерывную интеграцию**. Это активирует конвейер, чтобы во время фиксации изменений в коде, происходили полная сборка и выпуск.

    ![Включение непрерывной интеграции](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline20.png)

21. Они выбирают **Сохранить и поместить в очередь** для выполнения всего конвейера. Активируется новая сборка, которая, в свою очередь, создает первый выпуск приложения в Службе приложений Azure.

    ![Сохранение конвейера](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline21.png)

22. Администраторы компании Contoso могут выполнить конвейер сборки и выпуска из Azure DevOps. После завершения сборки начнется выпуск.

    ![Сборка и выпуск приложения](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline22.png)

23. По завершении работы конвейера оба сайта уже развернуты и приложение находится в сети и работает.

    ![Завершение выпуска](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline23.png)

На этом этапе приложение успешно перенесено в Azure.

## <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновите внутреннюю документацию, чтобы показать новые расположения приложения SmartHotel360. Отобразите базу данных как выполняемую в Управляемый экземпляр Azure SQL, а внешний интерфейс — в двух веб-приложениях.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Contoso необходимо обеспечить безопасность своей новой базы данных **SmartHotel-Registration**. [Подробнее.](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview)
- В частности, компании Contoso нужно обновить веб-приложения для использования SSL с сертификатами.

### <a name="backups"></a>Резервные копии

- Contoso необходимо проверить требования к резервному копированию для базы данных Управляемый экземпляр Azure SQL. [Подробнее.](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups)
- Contoso также потребуются дополнительные сведения об управлении резервным копированием и восстановлением Базы данных SQL. См. [дополнительные сведения](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups) об автоматическом резервном копировании.
- Компании Contoso нужно рассмотреть реализацию групп отработки отказа для обеспечения отказоустойчивости в регионе для базы данных. [Подробнее.](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview)
- Компании Contoso необходимо рассмотреть развертывание веб-приложения в основном регионе "Восточная часть США 2" и в регионе "Центральная часть США" для обеспечения отказоустойчивости. Компания Contoso может настроить диспетчер трафика, чтобы обеспечить отработку отказа при возникновении региональных стандартов.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](./contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Contoso будет использовать службу " [Управление затратами Azure](https://azure.microsoft.com/services/cost-management) ", чтобы убедиться, что они находятся в бюджете, УСТАНОВЛЕНном ИТ – лидером.

## <a name="conclusion"></a>Заключение

В этой статье специалисты компании Contoso выполнили рефакторинг приложения SmartHotel360 в Azure путем миграции интерфейсной виртуальной машины приложения в два веб-приложения Службы приложений Azure. База данных приложений была перенесена в Управляемый экземпляр Azure SQL.
