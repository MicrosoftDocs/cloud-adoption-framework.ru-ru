---
title: Рефакторинг локального приложения в веб-приложение службы приложений Azure и Управляемый экземпляр SQL
description: Узнайте, как Contoso перемещает локальное приложение, переносит его в веб-приложение службы приложений Azure и Управляемый экземпляр SQL.
author: givenscj
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: ec83bb83eb1b5d0643a5df1f006b7be32de7236b
ms.sourcegitcommit: bcc73d194c6d00c16ae2e3c7fb2453ac7dbf2526
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86192374"
---
<!-- cSpell:ignore givenscj WEBVM SQLVM contosohost vcenter contosodc smarthotel SQLMI SHWCF SHWEB -->

# <a name="refactor-an-on-premises-application-to-an-azure-app-service-web-app-and-an-sql-managed-instance"></a>Рефакторинг локального приложения в веб-приложение службы приложений Azure и Управляемый экземпляр SQL

В этой статье показано, как вымышленная компания Contoso представляет собой двухстороннее приложение Windows .NET, работающее на виртуальных машинах VMware, в рамках миграции в Azure. Они переносят клиентскую виртуальную машину приложения в веб-приложение службы приложений Azure. В нем также показано, как Contoso переносит базу данных приложения в Управляемый экземпляр Azure SQL.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** По мере развития компании Contoso растет нагрузка на локальные системы и инфраструктуру.
- **Повышение эффективности.** Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости.**  ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Должна реагировать быстрее, чем изменения на рынке, чтобы включить успех в глобальную экономику реагирования. Он не должен мешать или становиться помехой для бизнеса.
- **Измените.** По мере успешного роста бизнеса ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.
- **Сократите затраты.** Компании Contoso требуется минимизировать затраты на лицензирование.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Эти цели использовались для определения оптимального метода миграции.

| Требования | Сведения |
| --- | --- |
| **Приложения** | Приложение в Azure будет оставаться критически важным, как сегодня. <br><br> Должны быть доступны те же возможности производительности, что и в настоящее время в VMware. <br><br> Группа не хочет вкладываться в приложение. Сейчас администраторы будут просто перемещать приложение в облако. <br><br> Команда должна прерывать поддержку Windows Server 2008 R2, на котором приложение выполняется в данный момент. <br><br> Группа также хочет перейти от SQL Server 2008 R2 к современной платформе базы данных PaaS, что снизит потребность в управлении. <br><br> Contoso хочет использовать преимущества своих инвестиций в лицензирование SQL Server и Software Assurance по мере возможности. <br><br> Кроме того, компания Contoso хочет перенести единую точку отказа на веб-уровень. |
| **Ограничения** | Приложение состоит из приложения ASP.NET и службы WCF, работающей на одной виртуальной машине. С помощью Службы приложений Azure специалисты компании хотят разделить это приложение между двумя веб-приложениями. |
| **Azure** | Компания Contoso хочет переместить приложение в Azure, но не хочет его запускать на виртуальных машинах. Компания хочет использовать службы PaaS Azure и для уровня данных, и для веб-уровня. |
| **DevOps** | Contoso хочет перейти на модель DevOps, используя Azure DevOps для конвейеров сборки и выпуска. |

## <a name="solution-design"></a>Архитектура решения

Определив цели и требования, специалисты Contoso начинают разработку и анализ решения развертывания и идентифицируют процесс миграции, включая службы Azure, которые будут использоваться при миграции.

### <a name="current-application"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено между двумя виртуальными машинами ( `WEBVM` и `SQLVM` ).
- Виртуальные машины расположены на узле VMware ESXi `contosohost1.contoso.com` (версии 6.5).
- Среда VMware находится под управлением сервера vCenter Server 6.5 (`vcenter.contoso.com`), запущенного на виртуальной машине.
- Компания Contoso использует локальный центр обработки данных (`contoso-datacenter`) с локальным контроллером домена (`contosodc1`).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

### <a name="proposed-solution"></a>Предлагаемое решение

- Для веб-уровня приложения компания Contoso решила использовать службу приложений Azure. Эта служба PaaS позволяет развернуть приложение, используя лишь несколько изменений конфигурации. Contoso хочет использовать Visual Studio для внесения изменений и развертывания двух веб-приложений. Одно для веб-сайта, а другое для службы приложения WCF.
- Для удовлетворения требований к DevOps конвейеру компания Contoso выбрала DevOps Azure для управления исходным кодом с помощью git репозиториев. Автоматические сборки и выпуски будут использоваться для компиляции кода и развертывания его в Службе приложений Azure.

### <a name="database-considerations"></a>Рекомендации по базе данных

В рамках процесса разработки решения компания Contoso выполнила сравнение функций между базой данных SQL Azure и Управляемый экземпляр SQL. Приведенные ниже рекомендации помогли вам принять решение об использовании SQL Управляемый экземпляр.

- SQL Управляемый экземпляр предназначен для обеспечения совместимости почти 100% с последней локальной SQL Serverной версией. Корпорация Майкрософт рекомендует использовать SQL Управляемый экземпляр для клиентов, работающих SQL Server локально или на виртуальной машине IaaS, которые хотят перенести свои приложения в полностью управляемую службу с минимальными изменениями структуры.
- Компания Contoso планирует перенести большое количество приложений из локальной среды в IaaS. Многие из них предоставляются независимыми поставщиками программного обеспечения. Компания Contoso осознает, что использование SQL Управляемый экземпляр обеспечит совместимость базы данных для этих приложений, вместо использования базы данных SQL, которая может не поддерживаться.
- Компания Contoso может просто выполнить миграцию на SQL Управляемый экземпляр с помощью полностью автоматизированных Azure Database Migration Service. Подготовив эту службу, Contoso сможет использовать ее при миграции баз данных в будущем.
- SQL Управляемый экземпляр поддерживает агент SQL Server, важный компонент приложения SmartHotel360. Компании Contoso требуется такая совместимость, в противном случае потребуется переконструировать планы обслуживания, необходимые для приложения.
- С помощью программы Software Assurance Contoso может обмениваться существующими лицензиями на Управляемый экземпляр SQL, используя Преимущество гибридного использования Azure для SQL Server. Это позволяет компании Contoso сэкономить до 30% на Управляемый экземпляр SQL.
- SQL Управляемый экземпляр полностью содержится в виртуальной сети, поэтому обеспечивает более высокий уровень изоляции и безопасности данных Contoso. Компания Contoso может получить преимущества общедоступного облака, сохранив изолированную среду от общедоступного Интернета.
- SQL Управляемый экземпляр поддерживает множество функций безопасности, включая Always-encrypted, динамическое Маскирование данных, безопасность на уровне строк и обнаружение угроз.

### <a name="solution-review"></a>Проверка решения

Contoso оценивает предлагаемый дизайн, составляя список плюсов и минусов.

| Рассматриваемый вопрос | Сведения |
| --- | --- |
| **Преимущества** | Код приложения SmartHotel360 не нужно изменять для миграции в Azure. <br><br> Contoso может использовать преимущества своих инвестиций в программу Software Assurance, используя Преимущество гибридного использования Azure для SQL Server и Windows Server. <br><br> Windows Server 2008 R2 не нужно будет поддерживать после миграции. Дополнительные сведения см. в статье [Политика жизненного цикла Майкрософт](https://aka.ms/lifecycle). <br><br> Компания Contoso может настроить веб-уровень приложения с несколькими экземплярами, чтобы он больше не был единой точкой отказа. <br><br> Исчезнет зависимость базы данных от устаревающей платформы SQL Server 2008 R2. <br><br> Управляемый экземпляр SQL соответствует техническим требованиям и целям компании Contoso. <br><br> SQL Управляемый экземпляр обеспечит совместимость с текущим развертыванием на 100%, при этом не удаляя их из SQL Server 2008 R2. <br><br> Компания может задействовать свои инвестиции в программу Software Assurance, воспользовавшись Преимуществом гибридного использования Azure для SQL Server и Windows Server. <br><br> Они могут повторно использовать Azure Database Migration Service для дальнейших миграций. <br><br> В Управляемый экземпляр Базы данных SQL встроены средства обеспечения отказоустойчивости, которые специалистам Contoso не требуется настраивать. Это гарантия того, что уровень данных больше не является единой точкой отказа. |
| **Недостатки** | Служба приложений Azure поддерживает только одно развертывание приложений для каждого веб-приложения. Это означает, что необходимо подготовить два веб-приложения (одно для веб-сайта, а другое для службы WCF). <br><br> Для уровня данных SQL Управляемый экземпляр может быть не лучшим решением, если Contoso хочет настроить операционную систему или сервер базы данных или запускать сторонние приложения вместе с SQL Server. Использование SQL Server на виртуальной машине IaaS может обеспечить такую гибкость. |

## <a name="proposed-architecture"></a>Предлагаемая архитектура

![Архитектура сценария](./media/contoso-migration-refactor-web-app-sql-managed-instance/architecture.png)

### <a name="migration-process"></a>Процесс миграции

1. Компания Contoso подготавливает Управляемый экземпляр Azure SQL и переносит на нее базу данных SmartHotel360 с помощью Azure Database Migration Service.
2. Компания Contoso подготавливает и настраивает веб-приложения, а также развертывает в них приложение SmartHotel360.

    ![Процесс миграции](./media/contoso-migration-refactor-web-app-sql-managed-instance/migration-process.png)

### <a name="azure-services"></a>Службы Azure

| Служба | Описание | Стоимость |
| --- | --- | --- |
| [Миграция баз данных Azure](https://docs.microsoft.com/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает простой перенос из нескольких источников базы данных в платформы данных Azure с минимальным временем простоя. | Узнайте о [поддерживаемых регионах](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) и [ценах на Azure Database Migration Service](https://azure.microsoft.com/pricing/details/database-migration). |
| [Управляемый экземпляр SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | SQL Управляемый экземпляр — это управляемая служба базы данных, которая представляет собой полностью управляемый экземпляр SQL Server в облаке Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | При использовании Управляемый экземпляр SQL, выполняемого в Azure, взимается плата в зависимости от емкости. Дополнительные сведения о [ценах на SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/sql-database/managed). |
| [Служба приложений Azure](https://docs.microsoft.com/azure/app-service/overview) | Создание мощных облачных приложений с помощью полностью управляемой платформы | Стоимость зависит от размера, расположения и длительности использования. [Подробнее](https://azure.microsoft.com/pricing/details/app-service/windows). |
| [Azure Pipelines](https://docs.microsoft.com/azure/devops/pipelines/get-started/what-is-azure-pipelines) | Предоставляет конвейер непрерывной интеграции и непрерывного развертывания (CI/CD) для разработки приложений. Конвейер начинается с репозитория Git для управления кодом приложения, системы сборки для создания пакетов и других артефактов сборки, а также системы управления выпусками для развертывания изменений в средах разработки, тестирования и рабочей среде. |

## <a name="prerequisites"></a>Предварительные требования

Ниже показано, что необходимо сделать специалистам компании Contoso, чтобы реализовать этот сценарий.

| Требования | Сведения |
| --- | --- |
| **Подписка Azure.** | Компания Contoso уже создала подписки (это описывается в одной из предыдущих статей этой серии). Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника. |
| **Инфраструктура Azure** | [Узнайте, как](./contoso-migration-infrastructure.md) компания Contoso настраивает инфраструктуру Azure. |

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Настройка Управляемый экземпляр SQL.** Компании Contoso необходим существующий управляемый экземпляр, в который будет перенесена локальная база данных SQL Server.
> - **Шаг 2. Миграция с помощью Azure Database Migration Service.** Компания Contoso переносит базу данных приложений с помощью Azure Database Migration Service.
> - **Шаг 3. предоставление веб-приложений.** Специалисты компании Contoso выполняют подготовку двух веб-приложений.
> - **Шаг 4. Настройка Azure DevOps.** Специалисты компании Contoso создают новый проект Azure DevOps и импортируют репозитории Git.
> - **Шаг 5. Настройка строк подключения.** Специалисты компании Contoso настраивают строки подключения для обеспечения взаимодействия веб-приложения веб-уровня, веб-приложения службы WCF и экземпляра SQL.
> - **Шаг 6. Настройка конвейеров сборки и выпуска.** В качестве последнего шага компания Contoso настраивает конвейеры сборки и выпуска для создания приложения и развертывает их в двух отдельных веб-приложениях.

## <a name="step-1-set-up-a-sql-managed-instance"></a>Шаг 1. Настройка SQL Управляемый экземпляр

Чтобы настроить Управляемый экземпляр Azure SQL, Contoso требуется подсеть, которая соответствует следующим требованиям:

- Подсеть должна быть выделенной. Она должна быть пустой и не содержать другие облачные службы. Подсеть не должна быть подсетью шлюза.
- После создания управляемого экземпляра компания Contoso не должна добавлять ресурсы в подсеть.
- С подсетью не должна быть связана группа безопасности сети.
- Подсеть должна иметь определяемую пользователем таблицу маршрутов. Единственный назначенный маршрут должен быть `0.0.0.0/0` Интернетом следующего прыжка.
- Если для виртуальной сети указан необязательный настраиваемый DNS-сервер, виртуальный IP-адрес `168.63.129.16` для рекурсивных арбитров конфликтов в Azure должен быть добавлен в список. Узнайте, как [настроить пользовательский DNS для управляемый экземпляр Azure SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (служба хранилища или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. Узнайте, как [изменить размер подсети управляемого экземпляра](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-configure-vnet-subnet).
- В гибридной среде Contoso требуются пользовательские параметры DNS. Компания Contoso настроит параметры DNS для использования одного или нескольких серверов DNS Azure компании. Дополнительные сведения о [настройке DNS](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a>Настройка виртуальной сети в управляемом экземпляре

Администраторы Contoso настраивают виртуальную сеть следующим образом:

1. Они создают новую виртуальную сеть ( `VNET-SQLMI-EU2` ) в основном регионе ( `East US 2` ). Она добавляет виртуальную сеть в `ContosoNetworkingRG` группу ресурсов.
2. Они присваивают адресное пространство `10.235.0.0/24` . Они гарантируют, что диапазон не пересекается с другими сетями в организации.
3. Они добавят к сети две подсети:
    - `SQLMI-DS-EUS2` (`10.235.0.0/25`).
    - `SQLMI-SAW-EUS2` (`10.235.0.128/29`). Эта подсеть используется для присоединения каталога к управляемому экземпляру.

      ![Управляемый экземпляр: создание виртуальной сети](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

4. После развертывания виртуальной сети и подсетей они назначают сетям ранги следующим образом:

    - Пиринг `VNET-SQLMI-EUS2` с `VNET-HUB-EUS2` (виртуальная сеть концентратора для `East US 2` ).
    - Одноранговые узлы `VNET-SQLMI-EUS2` `VNET-PROD-EUS2` (Рабочая сеть).

      ![Пиринг сетей](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

5. Они задают пользовательские параметры DNS. Служба доменных имен (DNS) сначала указывает на контроллеры домена Azure компании Contoso. Azure DNS является вторичной. Контроллеры домена Contoso Azure находятся в следующих расположениях.

    - Находится в `PROD-DC-EUS2` подсети рабочей сети ( `VNET-PROD-EUS2` ) в `East US 2` регионе.
    - `CONTOSODC3`Адрес: `10.245.42.4` .
    - `CONTOSODC4`Адрес: `10.245.42.5` .
    - Сопоставитель Azure DNS: `168.63.129.16` .

      ![DNS-серверы сети](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

**Требуется дополнительная помощь?**

- Ознакомьтесь с [обзором управляемый экземпляр SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance).
- Узнайте, как [создать виртуальную сеть для управляемый экземпляр SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-configure-vnet-subnet).
- См. раздел [Создание, изменение и удаление пиринга в виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering).
- См. раздел [Включение доменных служб Azure Active Directory](https://docs.microsoft.com/azure/active-directory-domain-services/tutorial-create-instance).

### <a name="set-up-routing"></a>Настройка маршрутизации

Управляемый экземпляр помещается в закрытую виртуальную сеть. Компании Contoso требуется таблица маршрутов для связи между виртуальной сетью и службой управления Azure. Если виртуальная сеть не может связаться со службой, которая ею управляет, виртуальная сеть становится недоступной.

Компания Contoso принимает во внимание следующие факторы.

- Таблица маршрутов содержит набор правил (маршрутов), указывающих, как пакеты, отправляемые из управляемого экземпляра, должны маршрутизироваться в виртуальной сети.
- Таблица маршрутов связана с подсетями, в которых развернуты управляемые экземпляры. Каждый пакет, который оставляет подсеть, обрабатывается на основе связанной таблицы маршрутизации.
- Подсеть может быть связана только с одной таблицей маршрутизации.
- Никаких дополнительных затрат при создании таблицы маршрутизации в Microsoft Azure не требуется.

 Для настройки маршрутизации администраторы Contoso делают следующее:

1. Они создают определяемую пользователем таблицу маршрутов в `ContosoNetworkingRG` группе ресурсов.

    ![Таблица маршрутов](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

2. Чтобы обеспечить соответствие требованиям SQL Управляемый экземпляр, после развертывания таблицы маршрутов ( `MIRouteTable` ) они добавляют маршрут с префиксом адреса `0.0.0.0/0` . Параметр **Тип следующего прыжка** установлен как **Интернет**.

    ![Префикс таблицы маршрутизации](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)

3. Таблица маршрутов связывается с `SQLMI-DB-EUS2` подсетью (в `VNET-SQLMI-EUS2` сети).

    ![Подсеть таблицы маршрутизации](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)

**Требуется дополнительная помощь?**

Узнайте, как [настроить маршруты для управляемого экземпляра](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started).

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

Теперь администраторы Contoso могут подготавливать Управляемый экземпляр SQL:

1. Поскольку управляемый экземпляр обслуживает бизнес-приложение, он развертывает управляемый экземпляр в основном регионе компании ( `East US 2` ). Они добавляют управляемый экземпляр в `ContosoRG` группу ресурсов.
2. Они выбирают ценовую категорию и размер вычислений и хранилище для экземпляра. Дополнительные сведения о [ценах на SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/sql-database/managed).

    ![Базы данных SQL](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

3. После развертывания управляемого экземпляра в группе ресурсов появятся два новых ресурса `ContosoRG` :

    - Новый Управляемый экземпляр SQL.
    - Виртуальный кластер, в случае, если Contoso имеет несколько управляемых экземпляров.

      ![Базы данных SQL](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

**Требуется дополнительная помощь?**

Узнайте, как [подготавливать управляемый экземпляр](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started).

## <a name="step-2-migrate-via-azure-database-migration-service"></a>Шаг 2. Миграция с помощью Azure Database Migration Service

Администраторы Contoso переходят с помощью Azure Database Migration Service, выполнив пошаговое [руководство по миграции](https://docs.microsoft.com/azure/dms/tutorial-sql-server-azure-sql-online). Они могут выполнять интерактивные, автономные и гибридные миграции (Предварительная версия).

В качестве сводки необходимо выполнить следующие действия.

- Создайте экземпляр Azure Database Migration Service с `Premium` номером SKU, подключенным к виртуальной сети.
- Убедитесь, что Database Migration Service может получать доступ к удаленным SQL Server через виртуальную сеть. Это гарантирует, что все входящие порты будут разрешены в Azure для SQL Server на уровне виртуальной сети, в сети VPN и на компьютере, на котором размещается SQL Server.
- Настройка Azure Database Migration Service:
  - Создайте проект миграции.
  - Добавьте источник (локальная база данных).
  - Выберите целевой объект.
  - Выберите базы данных для миграции.
  - Настройка дополнительных параметров.
  - Запустите репликацию.
  - Устраните возможные ошибки.
  - Выполните окончательный прямую миграцию.

## <a name="step-3-provision-web-apps"></a>Шаг 3. предоставление веб-приложений

Сейчас, когда база данных уже перенесена, администраторы Contoso могут подготовить два веб-приложения.

1. На портале специалисты компании выбирают **Веб-приложение**.

    ![Веб-приложение](./media/contoso-migration-refactor-web-app-sql-managed-instance/web-app1.png)

2. Они предоставляют имя для веб-приложения ( `SHWEB-EUS2` ), запускайте его в Windows и размещают в Рабочей группе ресурсов `ContosoRG` . Специалисты компании создают веб-приложение и план службы приложений Azure.

    ![Веб-приложение](./media/contoso-migration-refactor-web-app-sql-managed-instance/web-app2.png)

3. После подготовки веб-приложения он повторяет процесс создания веб-приложения для службы WCF ( `SHWCF-EUS2` ).

    ![Веб-приложение](./media/contoso-migration-refactor-web-app-sql-managed-instance/web-app3.png)

4. После этого они будут просматривать адреса приложений, чтобы убедиться, что они были успешно созданы.

## <a name="step-4-set-up-azure-devops"></a>Шаг 4. Настройка Azure DevOps

Компании Contoso необходимо создать инфраструктуру DevOps и конвейеры для приложения. Для этого администраторы Contoso создают проект DevOps, импортируют код, а затем настраивают конвейеры сборки и выпуска.

1. В учетной записи Contoso Azure DevOps создайте новый проект ( `ContosoSmartHotelRefactor` ) и выберите **Git** для управления версиями.

    ![Новый проект](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts1.png)

2. Они импортируют репозиторий Git, в настоящее время содержащий код приложения. Он находится в [общедоступном репозитории GitHub](https://github.com/Microsoft/SmartHotel360-Registration) , и его можно скачать.

    ![Скачивание кода приложения](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts2.png)

3. После импорта кода они подключают Visual Studio к репозиторию и клонируют код с помощью Team Explorer.

    ![Подключение к проекту](./media/contoso-migration-refactor-web-app-sql-managed-instance/devops1.png)

4. После клонирования репозитория на компьютер разработчика он открывает файл решения для приложения. Веб-приложение и служба WCF имеют отдельный проект в файле.

    ![Файл решения](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts4.png)

## <a name="step-5-configure-connection-strings"></a>Шаг 5. Настройка строк подключения

Администраторы компании Contoso должны убедиться, что веб-приложения и база данных могут взаимодействовать. Чтобы сделать это, они настраивают строки подключения в коде и в веб-приложениях.

1. В веб-приложении для службы WCF ( `SHWCF-EUS2` ) > **Параметры**параметры  >  **приложения**, они добавляют новую строку подключения с именем `DefaultConnection` .
2. Строка подключения извлекается из `SmartHotel-Registration` базы данных и должна быть обновлена с использованием правильных учетных данных.

    ![Строка подключения](./media/contoso-migration-refactor-web-app-sql-managed-instance/string1.png)

3. С помощью Visual Studio они открывают `SmartHotel.Registration.wcf` проект из файла решения. `connectionStrings`Раздел `web.config` файла для службы WCF `SmartHotel.Registration.Wcf` должен быть обновлен с помощью строки подключения.

     ![Строка подключения](./media/contoso-migration-refactor-web-app-sql-managed-instance/string2.png)

4. `client` `web.config` Необходимо изменить раздел файла, `SmartHotel.Registration.Web` чтобы он указывал на новое расположение службы WCF. Это URL-адрес веб-приложения WCF, на котором размещена конечная точка службы.

    ![Строка подключения](./media/contoso-migration-refactor-web-app-sql-managed-instance/strings3.png)

5. После внесения изменений в код администраторам необходимо зафиксировать их. С помощью Team Explorer в Visual Studio они выполняют фиксацию и синхронизацию.

## <a name="step-6-set-up-build-and-release-pipelines-in-azure-devops"></a>Шаг 6. Настройка конвейеров сборки и выпуска в Azure DevOps

Теперь администраторы Contoso настраивают Azure DevOps для сборки и выпуска.

1. В Azure DevOps выберите **Сборка и выпуск**  >  **нового конвейера**.

    ![Новый конвейер](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline1.png)

2. Они выбирают **Azure Repos Git** и соответствующий репозиторий.

    ![Git и репозиторий](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline2.png)

3. В разделе **Выбор шаблона** они выбирают шаблон ASP.NET для сборки.

     ![Шаблон ASP.NET](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline3.png)

4. Имя `ContosoSmartHotelRefactor-ASP.NET-CI` используется для сборки. Администраторы выбирают **Сохранить и поместить в очередь**.

     ![Сохранение и помещение в очередь](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline4.png)

5. После этого запускается их первая сборка. Они выбирают номер сборки для просмотра процесса. После завершения они могут увидеть итоговые сведения о процессе и выбирают **Артефакты**, чтобы просмотреть результаты сборки.

    ![Проверка](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline5.png)

6. Результаты сборки находятся в папке **Drop**.

    - Два ZIP-файла — это пакеты, содержащие приложения.
    - Эти файлы используются в конвейере выпуска для развертывания в Службе приложений Azure.

     ![Артефакт](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline6.png)

7. Они выбирают **выпуски**  >  **+ Новый конвейер**.

    ![Новый конвейер](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline7.png)

8. Они выбирают шаблон развертывания Службы приложений Azure.

    ![Шаблон развертывания для Службы приложений Azure](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline8.png)

9. Они задают имя конвейера выпуска `ContosoSmartHotel360Refactor` и указывают имя веб-приложения WCF ( `SHWCF-EUS2` ) для имени **этапа** .

    ![Environment](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline9.png)

10. В разделе этапов они выбирают **1 задание, 1 задача**, чтобы настроить развертывание службы приложения WCF.

    ![Развертывание WCF](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline10.png)

11. Они подтверждают, что подписка выбрана и авторизация, и выбирает **имя службы приложений**.

     ![Выбор имени службы приложений](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline11.png)

12. В конвейере > **артефакты**выберите **+ Добавить артефакт**и выберите для построения с помощью `ContosoSmarthotel360Refactor` конвейера.

     ![Построение](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline12.png)

13. Они щелкают молнию на артефакте, чтобы включить триггер непрерывного развертывания.

     ![Молния](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline13.png)

14. Триггер непрерывного развертывания должен быть в положении **Включено**.

    ![Непрерывное развертывание включено](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline14.png)

15. Теперь они переходят на **Задание этапа 1, 1 задачу**и выберите пункт **развернуть службу приложений Azure**.

    ![развертывание Службы приложений Azure;](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline15.png)

16. В окне **Выбор файла или папки**они находят `SmartHotel.Registration.Wcf.zip` файл, который был создан во время сборки, и нажмите кнопку **сохранить**.

    ![Сохранение WCF](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline16.png)

17. Они выбирают **Этапы конвейера**  >  **Stages**, **+ Добавить** , чтобы добавить среду для `SHWEB-EUS2` . Они выбирают другое развертывание Службы приложений Azure.

    ![Добавление среды](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline17.png)

18. Они повторяют процесс, чтобы опубликовать файл веб-приложения ( `SmartHotel.Registration.Web.zip` ) в нужном веб-приложении.

    ![Публикация веб-приложения](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline18.png)

19. После сохранения конвейер выпуска будет отображаться следующим образом.

     ![Итоговое представление конвейера выпуска](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline19.png)

20. Специалисты компании возвращаются в раздел **Сборка** и выбирают **Триггеры** > **Включить непрерывную интеграцию**. Это активирует конвейер, чтобы во время фиксации изменений в коде, происходили полная сборка и выпуск.

    ![Включение непрерывной интеграции](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline20.png)

21. Они выбирают **Сохранить и поместить в очередь** для выполнения всего конвейера. Будет активирована новая сборка, которая, в свою очередь, создает первый выпуск приложения в службе приложений Azure.

    ![Сохранение конвейера](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline21.png)

22. Администраторы компании Contoso могут выполнить конвейер сборки и выпуска из Azure DevOps. После завершения сборки начнется выпуск.

    ![Сборка и выпуск приложения](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline22.png)

23. После завершения конвейера разворачиваются оба сайта, и приложение работает и запускается в режиме «в сети».

    ![Завершение выпуска](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline23.png)

На этом этапе приложение успешно перенесено в Azure.

## <a name="clean-up-after-migration"></a>Очистка после миграции

После миграции специалистам компании Contoso необходимо выполнить указанные ниже действия по очистке.

- Удалите локальные виртуальные машины из перечня в vCenter.
- Удалить виртуальные машины из локальных заданий резервного копирования.
- Обновите внутреннюю документацию, чтобы отобразить новые расположения для приложения SmartHotel360. Отобразите базу данных как выполняемую в Управляемый экземпляр Azure SQL, а внешний интерфейс — в двух веб-приложениях.
- Проверить все ресурсы, взаимодействующие с резервными виртуальными машинами, и обновить все соответствующие параметры или документы согласно новой конфигурации.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести его в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Компания Contoso должна обеспечить `SmartHotel-Registration` безопасность новой базы данных. [Подробнее](https://docs.microsoft.com/azure/sql-database/sql-database-security-overview).
- В частности, компании Contoso нужно обновить веб-приложения для использования SSL с сертификатами.

### <a name="backups"></a>Резервные копии

- Contoso необходимо проверить требования к резервному копированию для базы данных Управляемый экземпляр Azure SQL. [Подробнее](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).
- Contoso также потребуются дополнительные сведения об управлении резервным копированием и восстановлением Базы данных SQL. См. [дополнительные сведения](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups) об автоматическом резервном копировании.
- Компании Contoso нужно рассмотреть реализацию групп отработки отказа для обеспечения отказоустойчивости в регионе для базы данных. [Подробнее](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview).
- Компания Contoso должна рассмотреть возможность развертывания веб-приложения в основном регионе ( `East US 2` ) и в дополнительном регионе ( `Central US` ) для обеспечения устойчивости. Компания Contoso может настроить диспетчер трафика, чтобы обеспечить отработку отказа при возникновении региональных стандартов.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов специалисты компании Contoso должны назначить теги Azure в соответствии со своим [планированием инфраструктуры](./contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Это будет вычтено из EA.
- Компания Contoso будет использовать службу " [Управление затратами Azure" и выставление счетов](https://docs.microsoft.com/azure/cost-management-billing/cost-management-billing-overview) , чтобы гарантировать, что они останутся в бюджетах, установленных по ИТ.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso выполнила рефакторинг приложения SmartHotel360 в Azure путем переноса клиентской виртуальной машины приложения в два веб-приложения службы приложений Azure. База данных приложения была перенесена в Управляемый экземпляр Azure SQL.
