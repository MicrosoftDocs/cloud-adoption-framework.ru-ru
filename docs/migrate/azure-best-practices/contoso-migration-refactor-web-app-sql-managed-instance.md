---
title: Рефакторинг локального приложения в веб-приложение службы приложений Azure и управляемый экземпляр SQL
description: Сведения о том, как Contoso перемещает локальное приложение, переносит его в веб-приложение службы приложений Azure и управляемый экземпляр SQL.
author: givenscj
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 3d95604d9b12a5452853550a655a6c42034d8f23
ms.sourcegitcommit: 78fa714f964225cd5fc7a762e83fafe9b3f9dea1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/03/2020
ms.locfileid: "89427864"
---
<!-- cSpell:ignore contosohost vcenter contosodc smarthotel SQLMI SHWCF SHWEB -->

# <a name="refactor-an-on-premises-application-to-an-azure-app-service-web-app-and-a-sql-managed-instance"></a>Рефакторинг локального приложения в веб-приложение службы приложений Azure и управляемый экземпляр SQL

В этой статье показано, как вымышленная компания Contoso представляет собой двухстороннее приложение Windows .NET, которое работает на виртуальных машинах VMware (ВМ) в рамках миграции в Azure. Группа Contoso переносит клиентскую виртуальную машину приложения в веб-приложение службы приложений Azure. В статье также показано, как Contoso переносит базу данных приложения в управляемый экземпляр SQL Azure.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, вы можете скачать его с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство Contoso и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост**. Компания Contoso растет, и на локальных системах и в инфраструктуре возникает давление.
- **Повышение эффективности**. Компании Contoso необходимо удалить ненужные процедуры и упростить процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и чтобы не тратить время или деньги, обеспечивая более высокие требования клиентов.
- **Повышение гибкости**. ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Он должен иметь возможность реагировать быстрее, чем изменения в Marketplace, чтобы обеспечить успешную работу в глобальной экономике. Время реакции не должно быть таким образом или станет бизнес-блокировкой.
- **Масштабирование**. По мере успешного роста бизнеса ИТ-отдел компании Contoso должен предоставлять системы, способные расти в том же темпе.
- **Сокращение затрат**. Компании Contoso требуется минимизировать затраты на лицензирование.

## <a name="migration-goals"></a>Цели миграции

Чтобы определить наилучший способ переноса, группа Contoso Cloud закрепляет следующие цели:

| Требования | Сведения |
| --- | --- |
| **Приложение** | Приложение в Azure будет по-прежнему иметь важное значение, так как сегодня локально. <br><br> Должны быть доступны те же возможности производительности, что и в настоящее время в VMware. <br><br> Группа не хочет вкладываться в приложение. Сейчас администраторы будут просто перемещать приложение в облако. <br><br> Группа хочет прерывать поддержку Windows Server 2008 R2, на которой запущено приложение. <br><br> Группа также хочет перейти от SQL Server 2008 R2 к современной базе данных платформы как услуги (PaaS), что снизит потребность в управлении. <br><br> Contoso хочет использовать преимущества своих инвестиций в лицензирование SQL Server и Software Assurance по мере возможности. <br><br> Кроме того, компания Contoso хочет перенести единую точку отказа на веб-уровень. |
| **Ограничения** | Приложение состоит из приложения ASP.NET и службы Windows Communication Foundation (WCF), работающей на одной виртуальной машине. Они хотят распространить эти компоненты между двумя веб-приложениями с помощью службы приложений Azure. |
| **Azure** | Компания Contoso хочет переместить приложение в Azure, но не захочет его запускать на виртуальных машинах. Компания хочет использовать службы PaaS Azure и для уровня данных, и для веб-уровня. |
| **DevOps** | Contoso хочет перейти на модель DevOps, которая использует Azure DevOps для своих сборок и конвейеров выпуска. |

## <a name="solution-design"></a>Архитектура решения

После фиксации их целей и требований компания Contoso проектирует и изучает решение для развертывания. Они также указывают процесс миграции, включая службы Azure, которые они будут использовать для миграции.

### <a name="current-application"></a>Текущее приложение

- Локальное приложение SmartHotel360 распределено между двумя виртуальными машинами `WEBVM` и `SQLVM` .
- Виртуальные машины расположены на VMware ESXi узле contosohost1.contoso.com версии 6,5.
- Среда VMware управляется vCenter Server 6,5 (vcenter.contoso.com), которая выполняется на виртуальной машине.
- Contoso использует локальный центр обработки данных (contoso-datacenter) с локальным контроллером домена (contosodc1).
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

### <a name="proposed-solution"></a>Предлагаемое решение

- Для веб-уровня приложения компания Contoso решила использовать службу приложений Azure. Эта служба PaaS позволяет развертывать приложения с помощью всего лишь нескольких изменений конфигурации. Contoso будет использовать Visual Studio для внесения изменений и развернуть два веб-приложения: один для веб-сайта и один для службы WCF.
- Чтобы удовлетворить требования для конвейера DevOps, Contoso будет использовать Azure DevOps для управления исходным кодом с помощью git репозиториев. Они будут использовать автоматизированные сборки и выпуск для создания кода и его развертывания в службе приложений Azure.

### <a name="database-considerations"></a>Рекомендации по базе данных

В рамках процесса разработки решения компания Contoso выполнила сравнение функций между базой данных SQL Azure и Управляемый экземпляр SQL. Они решили использовать SQL Управляемый экземпляр в соответствии со следующими соображениями:

- SQL Управляемый экземпляр стремится обеспечить почти 100% на совместимость с последней локальной SQL Serverной версией. Корпорация Майкрософт рекомендует использовать SQL Управляемый экземпляр для клиентов, работающих SQL Server локально или на виртуальных машинах IaaS (инфраструктура как услуга), которые хотят перенести свои приложения в полностью управляемую службу с минимальными изменениями структуры.
- Компания Contoso планирует перенести большое количество приложений из локальной среды в виртуальные машины IaaS. Многие из этих виртуальных машин предоставляются независимыми поставщиками программного обеспечения. Компания Contoso осознает, что использование SQL Управляемый экземпляр поможет обеспечить совместимость баз данных для этих приложений. Они будут использовать SQL Управляемый экземпляр, а не базу данных SQL, которая может не поддерживаться.
- Компания Contoso может просто выполнить миграцию с переносом на SQL Управляемый экземпляр, используя полностью автоматизированные Azure Database Migration Service. Подготовив эту службу, Contoso сможет использовать ее при миграции баз данных в будущем.
- SQL Управляемый экземпляр поддерживает агент SQL Server, важный компонент приложения SmartHotel360. Компании Contoso требуется такая совместимость; в противном случае им придется переконструировать планы обслуживания, необходимые для приложения.
- С помощью программы Software Assurance компания Contoso может обмениваться существующими лицензиями по тарифам со скидкой на управляемом экземпляре SQL, используя Преимущество гибридного использования Azure для SQL Server. Это позволяет компании Contoso сэкономить до 30% с помощью Управляемый экземпляр SQL.
- Их управляемый экземпляр SQL полностью содержится в виртуальной сети, поэтому он обеспечивает более высокий уровень изоляции и безопасности данных Contoso. Компания Contoso может получить преимущества общедоступного облака, сохранив изолированную среду от общедоступного Интернета.
- SQL Управляемый экземпляр поддерживает множество функций безопасности, включая Always-encrypted, динамическое Маскирование данных, безопасность на уровне строк и обнаружение угроз.

### <a name="solution-review"></a>Проверка решения

Компания Contoso оценивает предлагаемую конструкцию, объединяя список «плюсы» и «минус», как показано в следующей таблице.

| Рассматриваемый вопрос | Сведения |
| --- | --- |
| **Преимущества** | Код приложения SmartHotel360 не требует изменений для миграции в Azure. <br><br> Компания Contoso может воспользоваться преимуществами своих инвестиций в Software Assurance, используя Преимущество гибридного использования Azure как для SQL Server, так и для Windows Server. <br><br> После переноса не потребуется поддерживать Windows Server 2008 R2. Дополнительные сведения см. в статье [Политика жизненного цикла Майкрософт](https://aka.ms/lifecycle). <br><br> Компания Contoso может настроить веб-уровень приложения с несколькими экземплярами, чтобы веб-уровень больше не был единой точкой отказа. <br><br> Исчезнет зависимость базы данных от устаревающей платформы SQL Server 2008 R2. <br><br> Управляемый экземпляр SQL соответствует техническим требованиям и целям компании Contoso. <br><br> Их управляемый экземпляр обеспечит совместимость с текущим развертыванием в 100% при их перемещении из SQL Server 2008 R2. <br><br> Компания Contoso может воспользоваться преимуществами своих инвестиций в Software Assurance и использовать Преимущество гибридного использования Azure для SQL Server и Windows Server. <br><br> Они могут повторно использовать Azure Database Migration Service для дальнейших миграций. <br><br> Их управляемый экземпляр имеет встроенную отказоустойчивость, которую Contoso не требуется настраивать. Это гарантия того, что уровень данных больше не является единой точкой отказа. |
| **Недостатки** | Служба приложений Azure поддерживает только одно развертывание приложений для каждого веб-приложения. Это означает, что необходимо подготовить два веб-приложения: одно для веб-сайта, а другое — для службы WCF. <br><br> Для уровня данных SQL Управляемый экземпляр может быть не лучшим решением, если Contoso хочет настроить операционную систему или сервер базы данных или запускать сторонние приложения вместе с SQL Server. Использование SQL Server на виртуальной машине IaaS может обеспечить такую гибкость. |

## <a name="proposed-architecture"></a>Предлагаемая архитектура

![Схема предлагаемой архитектуры.](./media/contoso-migration-refactor-web-app-sql-managed-instance/architecture.png)

### <a name="migration-process"></a>Процесс миграции

1. Компания Contoso подготавливает управляемый экземпляр SQL Azure, а затем переносит на него базу данных SmartHotel360 с помощью Azure Database Migration Service.
1. Компания Contoso подготавливает и настраивает веб-приложения и развертывает в них приложение SmartHotel360.

    ![Схема процесса миграции.](./media/contoso-migration-refactor-web-app-sql-managed-instance/migration-process.png)

### <a name="azure-services"></a>Службы Azure

| Служба | Описание | Стоимость |
| --- | --- | --- |
| [Помощник по миграции службы приложений Azure](/learn/paths/migrate-dotnet-apps-azure/) | Бесплатный и простой путь, позволяющий легко переносить веб-приложения .NET из локальной среды в облако с минимальными изменениями кода. | Это загружаемое средство бесплатно. |
| [Миграция баз данных Azure](/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает простой перенос из нескольких источников базы данных в платформы данных Azure с минимальным временем простоя. | Узнайте о [поддерживаемых регионах](/azure/dms/dms-overview#regional-availability) и [ценах на Azure Database Migration Service](https://azure.microsoft.com/pricing/details/database-migration). |
| [Управляемый экземпляр SQL Azure](/azure/sql-database/sql-database-managed-instance) | SQL Управляемый экземпляр — это управляемая служба базы данных, которая представляет собой полностью управляемый экземпляр SQL Server в Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | При использовании управляемого экземпляра SQL, работающего в Azure, взимается плата в зависимости от емкости. Дополнительные сведения о [ценах на SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/sql-database/managed). |
| [Служба приложений Azure](/azure/app-service/overview) | Помогает создавать мощные облачные приложения, использующие полностью управляемую платформу. | Цены основываются на размере, расположении и продолжительности использования. [Подробнее.](https://azure.microsoft.com/pricing/details/app-service/windows) |
| [Azure Pipelines](/azure/devops/pipelines/get-started/what-is-azure-pipelines) | Предоставляет конвейер непрерывной интеграции и непрерывного развертывания (CI/CD) для разработки приложений. Конвейер начинается с репозитория Git для управления кодом приложения, системы сборки для создания пакетов и других артефактов сборки, а также системы управления выпусками для развертывания изменений в средах разработки, тестирования и рабочей среде. |

## <a name="prerequisites"></a>Предварительные требования

Для выполнения этого сценария компания Contoso должна соответствовать следующим предварительным требованиям:

| Требования | Сведения |
| --- | --- |
| **Подписка Azure.** | Специалисты Contoso создали подписки ранее в этой серии статей. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/free). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку, в которой не являетесь администратором, администратор должен назначить вам права владельца или участника. |
| **Инфраструктура Azure** | Contoso настраивает свою инфраструктуру Azure, как описано в статье [Развертывание инфраструктуры Azure для миграции в Contoso](./contoso-migration-infrastructure.md). |

## <a name="scenario-steps"></a>Шаги выполнения сценария

Ниже рассказывается, как компания Contoso выполняет миграцию.

> [!div class="checklist"]
>
> - **Шаг 1. Оценка и миграция веб-приложений.**.. Contoso использует средство [Помощник по миграции службы приложений Azure](https://azure.microsoft.com/migration/web-applications/) для выполнения проверок совместимости перед миграцией и переноса своих веб-приложений в службу приложений Azure.
> - **Шаг 2. Настройка управляемого экземпляра SQL**. Компании Contoso необходим существующий управляемый экземпляр, в который будет перенесена локальная база данных SQL Server.
> - **Шаг 3. Миграция с помощью Azure Database Migration Service**. Компания Contoso переносит базу данных приложений с помощью Azure Database Migration Service.
> - **Шаг 4. Настройка Azure DevOps**. Специалисты компании Contoso создают новый проект Azure DevOps и импортируют репозитории Git.
> - **Шаг 5. Настройка строк подключения**. Contoso настраивает строки подключения таким образом, чтобы веб-приложение веб-уровня, веб-приложение службы WCF и управляемый экземпляр SQL могли обмениваться данными.
> - **Шаг 6. Настройка конвейеров сборки и выпуска в Azure DevOps**. В качестве последнего шага компания Contoso настраивает конвейеры сборки и выпуска в Azure DevOps для создания приложения. Затем команда развертывает конвейеры в два отдельных веб-приложения.

## <a name="step-1-assess-and-migrate-the-web-apps"></a>Шаг 1. Оценка и миграция веб-приложений

Администраторы Contoso оценивают и переносят свое веб-приложение с помощью средства [Помощник по миграции службы приложений Azure](https://azure.microsoft.com/migration/web-applications/) . В ходе этого процесса они используют [путь обучения Майкрософт](/learn/paths/migrate-dotnet-apps-azure/) в качестве рекомендации. Вкратце, администраторы выполняют следующие действия:

- Они используют средство [оценки миграции службы приложений](https://appmigration.microsoft.com/assessment/) Azure для оценки зависимостей между веб-приложениями и для определения наличия несовместимостей между локальными веб-приложениями и поддерживаемыми службами приложений Azure.

- Они загружают службу приложений Azure Помощник по миграции и входят в свою учетную запись Azure.

- Они выбирают подписку, группу ресурсов и доменное имя веб-сайта.

## <a name="step-2-set-up-a-sql-managed-instance"></a>Шаг 2. Настройка управляемого экземпляра SQL

Чтобы настроить управляемый экземпляр SQL Azure, Contoso требуется подсеть, которая соответствует следующим требованиям:

- Подсеть должна быть выделенной. Она должна быть пустой и не содержать другие облачные службы. Подсеть не должна быть подсетью шлюза.
- После создания управляемого экземпляра компания Contoso не должна добавлять ресурсы в подсеть.
- С подсетью не должна быть связана группа безопасности сети.
- Подсеть должна иметь определяемую пользователем таблицу маршрутов. Единственный назначенный маршрут должен быть `0.0.0.0/0` Интернетом следующего прыжка.
- Если для виртуальной сети указан необязательный настраиваемый DNS-сервер, виртуальный IP-адрес `168.63.129.16` для рекурсивных арбитров конфликтов в Azure должен быть добавлен в список. Узнайте, как [настроить пользовательский DNS для управляемого экземпляра SQL Azure](/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (служба хранилища или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. Узнайте, как [изменить размер подсети управляемого экземпляра](/azure/sql-database/sql-database-managed-instance-configure-vnet-subnet).
- В гибридной среде Contoso требуются пользовательские параметры DNS. Компания Contoso настроит параметры DNS для использования одного или нескольких серверов DNS Azure компании. Дополнительные сведения о [настройке DNS](/azure/sql-database/sql-database-managed-instance-custom-dns).

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a>Настройка виртуальной сети в управляемом экземпляре

Администраторы Contoso настраивают виртуальную сеть следующим образом:

1. Они создают новую виртуальную сеть (VNET-СКЛМИ-EU2) в основном регионе (Восточная часть США 2). Она добавит виртуальную сеть для группы ресурсов ContosoNetworkingRG.
1. Им назначается адресное пространство **10.235.0.0/24**. Они гарантируют, что диапазон не пересекается с другими сетями в организации.
1. Они добавят к сети две подсети:
    - `SQLMI-DS-EUS2` (`10.235.0.0/25`).
    - `SQLMI-SAW-EUS2` (`10.235.0.128/29`). Эта подсеть используется для присоединения каталога к управляемому экземпляру.

      ![Снимок экрана: область "Создание виртуальной сети" для управляемого экземпляра.](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

1. После развертывания виртуальной сети и подсетей они назначают сетям ранги следующим образом:

    - Пиринг `VNET-SQLMI-EUS2` с `VNET-HUB-EUS2` (виртуальная сеть концентратора для `East US 2` ).  
    - Одноранговые узлы `VNET-SQLMI-EUS2` `VNET-PROD-EUS2` (Рабочая сеть).

      ![Снимок экрана с одноранговыми сетями.](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

1. Они задают пользовательские параметры DNS. Сначала укажите точку настройки DNS для контроллеров домена Azure contoso. Azure DNS является вторичной. Контроллеры домена Contoso Azure находятся в следующих расположениях.

    - Находится в подсети "Production-DC-EUS2" рабочей сети (VNET-Production-EUS2) в регионе "Восточная часть США 2".  
    - `CONTOSODC3` Address `10.245.42.4`  
    - `CONTOSODC4` Address `10.245.42.5`  
    - Сопоставитель Azure DNS: `168.63.129.16`

    ![Снимок экрана: список DNS-серверов сети.](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

**Требуется дополнительная помощь?**

- Ознакомьтесь с [обзором управляемый экземпляр SQL](/azure/sql-database/sql-database-managed-instance).
- Узнайте, как [создать виртуальную сеть для управляемого экземпляра SQL](/azure/sql-database/sql-database-managed-instance-configure-vnet-subnet).
- См. раздел [Создание, изменение и удаление пиринга в виртуальной сети](/azure/virtual-network/virtual-network-manage-peering).
- См. раздел [Включение доменных служб Azure Active Directory](/azure/active-directory-domain-services/tutorial-create-instance).

### <a name="set-up-routing"></a>Настройка маршрутизации

Управляемый экземпляр помещается в закрытую виртуальную сеть. Компании Contoso требуется таблица маршрутов для связи между виртуальной сетью и службой управления Azure. Если виртуальная сеть не может связаться со службой, которая ею управляет, виртуальная сеть становится недоступной.

Компания Contoso принимает во внимание следующие факторы.

- Таблица маршрутов содержит набор правил (маршрутов), указывающих, как пакеты, отправляемые из управляемого экземпляра, должны маршрутизироваться в виртуальной сети.
- Таблица маршрутов связана с подсетями, в которых развернуты управляемые экземпляры. Каждый пакет, который оставляет подсеть, обрабатывается на основе связанной таблицы маршрутизации.
- Подсеть может быть связана только с одной таблицей маршрутизации.
- Никаких дополнительных затрат при создании таблицы маршрутизации в Microsoft Azure не требуется.

Чтобы настроить маршрутизацию, администраторы Contoso выполняют следующие действия:

1. Они создают определяемую пользователем таблицу маршрутов в группе ресурсов ContosoNetworkingRG.

    ![Снимок экрана: панель "Создание таблицы маршрутов".](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

1. Чтобы обеспечить соответствие требованиям SQL Управляемый экземпляр, после развертывания таблицы маршрутов администраторы добавляют маршрут с префиксом адреса **0.0.0.0/0**. Параметр **Тип следующего прыжка** установлен как **Интернет**.

    ![Снимок экрана: панель "Добавление маршрута" для добавления префикса адреса.](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)

1. Они связывают таблицу маршрутов с подсетью SQLMI-DB-EUS2 (в сети VNET-SQLMI-EUS2).

    ![Снимок экрана: панель "Сопоставление подсети" для маршрутизации подсети таблицы.](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)

**Требуется дополнительная помощь?**

Узнайте, как [настроить маршруты для управляемого экземпляра](/azure/sql-database/sql-database-managed-instance-get-started).

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

Теперь администраторы Contoso подготавливают управляемый экземпляр SQL, выполняя следующие действия.

1. Поскольку управляемый экземпляр обслуживает бизнес-приложение, администраторы развертывают управляемый экземпляр в основном регионе компании (Восточная часть США 2). Они добавляют управляемый экземпляр в группу ресурсов ContosoRG.
1. Они выбирают ценовую категорию и размер вычислений и хранилище для экземпляра. Дополнительные сведения о [ценах на SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/sql-database/managed).

    ![Снимок экрана: панель "Управляемый экземпляр SQL".](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

    После развертывания управляемого экземпляра в группе ресурсов ContosoRG появятся два новых ресурса:
    - Новый управляемый экземпляр SQL.  
    - Виртуальный кластер, в случае, если Contoso имеет несколько управляемых экземпляров.

      ![Снимок экрана с новыми ресурсами в группе ресурсов ContosoRG.](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

**Требуется дополнительная помощь?**

Узнайте, как [подготавливать управляемый экземпляр](/azure/sql-database/sql-database-managed-instance-get-started).

## <a name="step-3-migrate-via-azure-database-migration-service"></a>Шаг 3. Миграция с помощью Azure Database Migration Service

Администраторы Contoso переходят управляемый экземпляр с помощью Azure Database Migration Service, следуя инструкциям в [руководстве по пошаговому миграции](/azure/dms/tutorial-sql-server-azure-sql-online). Они могут выполнять интерактивные, автономные и гибридные (предварительные) миграции.

Вкратце, администраторы Contoso выполняют следующие действия:

- Они создают экземпляр Azure Database Migration Service с номером SKU уровня "Премиум", подключенным к виртуальной сети.
- Они гарантируют, что Database Migration Service может получить доступ к удаленным SQL Server через виртуальную сеть. Это гарантирует, что все входящие порты будут разрешены в Azure для SQL Server на уровне виртуальной сети, в сети VPN и на компьютере, на котором размещается SQL Server.
- Они настраивают Azure Database Migration Service:
  - Создайте проект миграции.
  - Добавьте источник (локальная база данных).
  - Выберите целевой объект.
  - Выберите базы данных для миграции.
  - Настройка дополнительных параметров.
  - Запустите репликацию.
  - Устраните возможные ошибки.
  - Выполните окончательный прямую миграцию.

## <a name="step-4-set-up-azure-devops"></a>Шаг 4. Настройка Azure DevOps

Компании Contoso необходимо создать инфраструктуру DevOps и конвейеры для приложения. Для этого администраторы Contoso создают новый проект DevOps, импортируют код, а затем настроили конвейеры сборки и выпуска.

1. В учетной записи Contoso Azure DevOps создайте новый проект Контососмарсотелрефактор, а затем выберите **Git** для управления версиями.

    ![Снимок экрана: область создания проекта.](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts1.png)

1. Они импортируют репозиторий Git, в настоящее время содержащий код приложения. Они загружаются из [общедоступного репозитория GitHub](https://github.com/Microsoft/SmartHotel360-Registration).

    ![Снимок экрана: панель "Импорт репозитория Git" для указания типа источника и URL-адреса клона.](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts2.png)

1. Они подключают Visual Studio к репозиторию, а затем клонировать код на компьютер разработчика с помощью Team Explorer.

    ![Снимок экрана: панель "подключение к проекту".](./media/contoso-migration-refactor-web-app-sql-managed-instance/devops1.png)

1. Они открывают файл решения для приложения. Веб-приложение и служба WCF имеют отдельные проекты в файле.

    ![Снимок экрана обозреватель решений, в котором перечислены проекты веб-приложения и службы WCF.](./media/contoso-migration-refactor-web-app-sql-managed-instance/vsts4.png)

## <a name="step-5-configure-connection-strings"></a>Шаг 5. Настройка строк подключения

Администраторы Contoso должны убедиться, что веб-приложения и база данных могут взаимодействовать друг с другом. Чтобы сделать это, они настраивают строки подключения в коде и в веб-приложениях.

1. В веб-приложении для службы WCF швкф-EUS2 в разделе **Параметры**  >  **приложения**параметры добавляют новую строку подключения с именем **DefaultConnection**.
1. Они извлекают строку подключения из базы данных Смарсотел-Registration, а затем обновляют ее с использованием правильных учетных данных.

    ![Снимок экрана: панель параметров строки подключения.](./media/contoso-migration-refactor-web-app-sql-managed-instance/string1.png)

1. В Visual Studio администраторы открывают `SmartHotel.Registration.wcf` проект из файла решения. В проекте они обновляют `connectionStrings` раздел файла *web.config* со строкой подключения.

     ![Снимок экрана раздела connectionString файла web.config в проекте Смарсотел. Registration. WCF.](./media/contoso-migration-refactor-web-app-sql-managed-instance/string2.png)

1. Они изменяют `client` раздел `web.config` файла для Смарсотел. Registration. Web, чтобы указать новое расположение службы WCF. Это URL веб-приложения WCF, в котором размещена конечная точка службы.

    ![Снимок экрана раздела "клиент" файла web.config в проекте Смарсотел. Registration. WCF.](./media/contoso-migration-refactor-web-app-sql-managed-instance/strings3.png)

1. После изменения кода администраторы зафиксируют и синхронизируют их с помощью Team Explorer в Visual Studio.

## <a name="step-6-set-up-build-and-release-pipelines-in-azure-devops"></a>Шаг 6. Настройка конвейеров сборки и выпуска в Azure DevOps

Администраторы Contoso теперь настраивают Azure DevOps для выполнения процесса сборки и выпуска.

1. В Azure DevOps выберите **Сборка и выпуск**  >  **нового конвейера**.

    ![Снимок экрана: ссылка "Новый конвейер" в Azure DevOps.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline1.png)

1. Они выбирают **Azure Repos Git** и соответствующий репозиторий.

    ![Снимок экрана с кнопкой "Azure Repos Git" и выбранным репозиторием.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline2.png)

1. В разделе **Выбор шаблона** они выбирают шаблон ASP.NET для сборки.

     ![Снимок экрана: панель "Выбор шаблона" для выбора шаблона ASP.NET.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline3.png)

1. Для сборки используются имя **контососмарсотелрефактор-ASP.NET-CI** , а затем выберите **сохранить & очередь**, которая запускает первую сборку.

     ![Снимок экрана кнопки "сохранить и поставить в очередь" для сборки.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline4.png)

1. Они выбирают номер сборки для просмотра процесса. По завершении администраторы могут увидеть отзывы о процессе и выбрать **артефакты** для просмотра результатов сборки.

    ![Снимок экрана со страницей "сборка" и ссылкой "артефакты" для просмотра результатов сборки.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline5.png)

    Откроется панель **Обозреватель артефактов** , а в папке **сброса** отобразятся результаты сборки.

    - Два ZIP-файла — это пакеты, содержащие приложения.
    - Эти ZIP-файлы используются в конвейере выпуска для развертывания в службе приложений Azure.

     ![Снимок экрана: панель "Обозреватель артефактов".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline6.png)

1. Они выбирают **выпуски**  >  **+ Новый конвейер**.

    ![Снимок экрана, показывающий ссылку "Новый конвейер".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline7.png)

1. Они выбирают шаблон развертывания Службы приложений Azure.

    ![Снимок экрана шаблона развертывания службы приложений Azure.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline8.png)

1. Они задают имя конвейера выпуска **ContosoSmartHotel360Refactor** , а в поле **имя этапа** укажите **швкф-EUS2** в качестве имени веб-приложения WCF.

    ![Снимок экрана с именем этапа веб-приложения WCF.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline9.png)

1. В разделе этапов они выбирают **1 задание, 1 задача**, чтобы настроить развертывание службы приложения WCF.

    ![Снимок экрана с параметром "1 задание, 1 задача".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline10.png)

1. Они подтверждают, что подписка выбрана и авторизация, а затем выбирает **имя службы приложений**.

     ![Снимок экрана выбора имени службы приложений.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline11.png)

1. В конвейере они выбирают **артефакты**, затем выберите **+ Добавить артефакт**, выберите **построить** как тип источника, а затем выполните сборку с помощью `ContosoSmarthotel360Refactor` конвейера.

     ![Снимок экрана: кнопка "построить" на панели "Добавление артефакта".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline12.png)

1. Чтобы включить триггер непрерывного развертывания, Администраторы выбирают значок с молнией на артефакте.

     ![Снимок экрана значка с молнией на артефакте.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline13.png)

1. Они устанавливают триггер непрерывного развертывания в значение **Enabled**.

    ![Снимок экрана, на котором показан триггер непрерывного развертывания со значением "включено".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline14.png)

1. Администраторы вернутся к **заданию этапа 1, 1 задаче,** а затем — **развернуть службу приложений Azure**.

    ![Снимок экрана с возможностью выбора параметра "развернуть службу приложений Azure".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline15.png)

1. В окне **Выбор файла или папки**они разворачивают папку **сброса** , выберите `SmartHotel.Registration.Wcf.zip` файл, созданный во время сборки, а затем нажмите кнопку **сохранить**.

    ![Снимок экрана: панель "Выбор файла или папки" для выбора файла WCF.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline16.png)

1. Выберите этапы **конвейера**  >  **Stages**, а затем щелкните **+ Добавить** , чтобы добавить среду для `SHWEB-EUS2` . Они выбирают другое развертывание Службы приложений Azure.

    ![Снимок экрана со ссылкой "1 задание, 1 задача" для добавления среды.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline17.png)

1. Они повторно позволяют опубликовать файл *SmartHotel.Registration.Web.zip* веб-приложения в нужном веб-приложении, а затем нажать кнопку **сохранить**.

    ![Снимок экрана: область "Выбор файла или папки" для выбора веб-файла.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline18.png)

    Отобразится конвейер выпуска, как показано ниже:

     ![Снимок экрана сводки по конвейеру выпуска.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline19.png)

1. Вернитесь к разделу **Сборка**, выберите **триггеры**и установите флажок **включить непрерывную интеграцию** . Это действие активирует конвейер таким образом, что при фиксации изменений в коде выполняется полная сборка и выпуск.

    ![Снимок экрана, покрывающий флажок "включить непрерывную интеграцию".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline20.png)

1. Они выбирают **Сохранить и поместить в очередь** для выполнения всего конвейера. Запускается новая сборка, которая, в свою очередь, создает первый выпуск приложения в службе приложений Azure.

    ![Снимок экрана кнопки "Сохранить очередь &".](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline21.png)

1. Администраторы компании Contoso могут выполнить конвейер сборки и выпуска из Azure DevOps. После завершения сборки запускается выпуск.

    ![Снимок экрана приложения сборки и выпуска.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline22.png)

1. После завершения конвейера разворачиваются оба сайта, и приложение работает и запускается в режиме «в сети».

    ![Снимок экрана, показывающий, что приложение работает.](./media/contoso-migration-refactor-web-app-sql-managed-instance/pipeline23.png)

    Приложение успешно перенесено в Azure.

## <a name="clean-up-after-the-migration"></a>Очистка после миграции

После миграции группа Contoso выполняет следующие действия по очистке:

- Удаление локальных виртуальных машин из перечня в vCenter.
- Они удаляют виртуальные машины из локальных заданий резервного копирования.
- Они обновляют внутреннюю документацию для отображения новых расположений для приложения SmartHotel360. В документации показана база данных, работающая в управляемом экземпляре SQL, а также внешний интерфейс, работающий в двух веб-приложениях.
- Они просматривают все ресурсы, которые взаимодействуют с списанными виртуальными машинами, и обновляют соответствующие параметры или документацию в соответствии с новой конфигурацией.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда ресурсы перенесены в Azure, Contoso необходимо полностью эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

- Компания Contoso помогает обеспечить безопасность новой `SmartHotel-Registration` базы данных. [Подробнее.](/azure/sql-database/sql-database-security-overview)
- В частности, компания Contoso обновляет веб-приложения для использования SSL с сертификатами.

### <a name="backups"></a>Резервные копии

- Группа Contoso просматривает требования к резервному копированию базы данных в Управляемый экземпляр Azure SQL. [Подробнее.](/azure/sql-database/sql-database-automated-backups)
- Они также изучит управление резервными копиями и восстановлением базы данных SQL. См. [дополнительные сведения](/azure/sql-database/sql-database-automated-backups) об автоматическом резервном копировании.
- Они считают реализацией групп отработки отказа для предоставления региональной отработки отказа для базы данных. [Подробнее.](/azure/sql-database/sql-database-geo-replication-overview)
- Рассмотрите возможность развертывания веб-приложения в основном регионе ( `East US 2` ) и в дополнительном регионе ( `Central US` ) для обеспечения устойчивости. Группа может настроить диспетчер трафика, чтобы обеспечить отработку отказа во время региональных сбоев.

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- После развертывания всех ресурсов компания Contoso назначает Теги Azure на основе [планирования инфраструктуры](./contoso-migration-infrastructure.md#set-up-tagging).
- Полное лицензирование входит в стоимость служб PaaS, которые использует Contoso. Эти затраты вычитаются из Соглашение Enterprise.
- Contoso будет использовать службу [управления затратами Azure и выставления счетов](/azure/cost-management-billing/cost-management-billing-overview) , чтобы гарантировать, что они останутся в пределах бюджетов, установленных ИТ.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso выполнила рефакторинг приложения SmartHotel360 в Azure путем переноса клиентской виртуальной машины приложения в два веб-приложения службы приложений Azure. База данных приложения была перенесена в управляемый экземпляр SQL Azure.
