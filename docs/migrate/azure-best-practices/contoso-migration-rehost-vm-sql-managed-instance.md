---
title: Повторное размещение локального приложения путем перехода на виртуальные машины Azure и Azure SQL Управляемый экземпляр
description: Узнайте, как Contoso перемещает локальное приложение на виртуальных машинах Azure и с помощью Управляемый экземпляр Azure SQL.
author: givenscj
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 1d1ce5018f9a955ead905c1401872c013842ed42
ms.sourcegitcommit: bcc73d194c6d00c16ae2e3c7fb2453ac7dbf2526
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86192068"
---
<!-- cSpell:ignore givenscj WEBVM SQLVM OSTICKETWEB OSTICKETMYSQL contosohost vcenter contosodc NSGs agentless SQLMI iisreset -->

# <a name="rehost-an-on-premises-application-by-migrating-to-azure-vms-and-azure-sql-managed-instance"></a>Повторное размещение локального приложения путем перехода на виртуальные машины Azure и Azure SQL Управляемый экземпляр

В этой статье показано, как вымышленная компания Contoso переносит двухстороннее приложение внешнего интерфейса Windows .NET, работающее на виртуальных машинах VMware, на виртуальную машину Azure с помощью службы "миграция Azure". В нем также показано, как Contoso переносит базу данных приложения в Управляемый экземпляр Azure SQL.

Приложение SmartHotel360, используемое в этом примере, предоставляется в виде открытого кода. Если вы хотите использовать его для тестирования, то можете скачать это приложение с сайта [GitHub](https://github.com/Microsoft/SmartHotel360).

## <a name="business-drivers"></a>Бизнес-факторы

Совместными усилиями ИТ-руководство компании Contoso и деловые партнеры определили указанные ниже цели этой миграции.

- **Устраните бизнес-рост.** Компания Contoso растет. В результате увеличилось давление на внутренние системы и инфраструктуру компании.
- **Повышение эффективности.** Компании Contoso необходимо удалить ненужные процедуры и оптимизировать процессы для разработчиков и пользователей. Бизнес нуждается в том, чтобы ИТ были быстрыми и не тратили время или деньги, поэтому компания может быстрее выполнять требования клиентов.
- **Повышение гибкости.** ИТ-отдел компании Contoso должен проявлять большую гибкость в отношении потребностей бизнеса. Он должен реагировать быстрее чем изменения, которые происходят на рынке, для достижение компанией успеха в глобальной экономике. ИТ-отдел в компании Contoso не должен мешать или становиться помехой для бизнеса.
- **Измените.** По мере роста бизнеса компании ИТ-отдел компании Contoso должен предоставлять системы, которые могут расти с той же скоростью.

## <a name="migration-goals"></a>Цели миграции

Группа, работающая над облачной инфраструктурой компании Contoso, определила цели этой миграции. Компания использует цели миграции, чтобы определить наилучший способ миграции.

- После миграции приложение в Azure должно иметь те же возможности производительности, что и приложение в локальной среде VMware для contoso. Переход в облако не означает, что производительность приложения менее важна.
- Компания Contoso не хочет вкладывать приложения в приложение. Приложение является важнейшим и важным для бизнеса, но Contoso просто хочет переместить приложение в своей текущей форме в облако.
- Задачи администрирования базы данных должны быть сведены к минимальному объему после переноса приложения.
- Contoso не хочет использовать базу данных SQL Azure для этого приложения. Она ищет альтернативные варианты.

## <a name="solution-design"></a>Архитектура решения

Определив свои цели и требования, специалисты компании Contoso начинают разработку и анализ решения для развертывания и планируют процесс миграции, включая службы Azure, которые будут использоваться в ходе этой миграции.

### <a name="current-architecture"></a>Текущая архитектура

- Contoso имеет один основной центр обработки данных ( `contoso-datacenter` ). Центр обработки данных находится в городе Нью-Йорк в Восточном США.
- У компании есть еще три местных филиала в других уголках США.
- Главный центр обработки данных подключен к Интернету по оптоволоконному соединению метро Ethernet (500 Мбит/с).
- Каждый филиал подключен локально к Интернету с помощью соединений бизнес-класса и применяет VPN-туннели IPSec для передачи данных в основной центр обработки данных. Эта настройка позволяет компании Contoso обеспечивать постоянство подключения всей сети и оптимизацию подключения к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. Компания использует два узла виртуализации ESXi 6.5 под управлением vCenter Server 6.5.
- Компания Contoso использует управление удостоверениями в Active Directory. Компания Contoso использует DNS-серверы внутренней сети.
- Contoso имеет локальный контроллер домена ( `contosodc1` ).
- Контроллеры домена работают на виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.
- Приложение SmartHotel360 распределяется между двумя виртуальными машинами ( `WEBVM` и `SQLVM` ), расположенными на узле VMware ESXi версии 6,5 ( `contosohost1.contoso.com` ).
- Управление средой VMware осуществляется с vCenter Server 6,5 ( `vcenter.contoso.com` ), работающей на виртуальной машине.

![Текущая архитектура Contoso](./media/contoso-migration-rehost-vm-sql-managed-instance/contoso-architecture.png)

### <a name="proposed-architecture"></a>Предлагаемая архитектура

В этом сценарии компания Contoso хочет перенести свое локальное приложение командировок следующим образом:

- Перенос базы данных приложения ( `SmartHotelDB` ) в управляемый экземпляр Azure SQL.
- Перенос внешнего интерфейса `WEBVM` на виртуальную машину Azure.
- После завершения миграции локальные виртуальные машины в центре обработки данных Contoso будут выведены из эксплуатации.

![Архитектура сценария](./media/contoso-migration-rehost-vm-sql-managed-instance/architecture.png)

### <a name="database-considerations"></a>Рекомендации по базе данных

В рамках процесса разработки решения компания Contoso выполнила сравнение функций между базой данных SQL Azure и Управляемый экземпляр SQL. Приведенные ниже рекомендации помогли вам принять решение об использовании SQL Управляемый экземпляр.

- SQL Управляемый экземпляр предназначен для обеспечения совместимости почти 100% с последней локальной SQL Serverной версией. Корпорация Майкрософт рекомендует использовать SQL Управляемый экземпляр для клиентов, работающих SQL Server локально или на виртуальных машинах IaaS и желающих перенести свои приложения в полностью управляемую службу с минимальными изменениями структуры.
- Компания Contoso планирует перенести большое количество приложений из локальной среды в IaaS. Многие из них предоставляются независимыми поставщиками программного обеспечения. Компания Contoso осознает, что использование SQL Управляемый экземпляр обеспечит совместимость базы данных для этих приложений, вместо использования базы данных SQL, которая может не поддерживаться.
- Компания Contoso может выполнить миграцию с переносом на SQL Управляемый экземпляр с помощью полностью автоматизированных Azure Database Migration Service. Подготовив эту службу, Contoso сможет использовать ее при миграции баз данных в будущем.
- SQL Управляемый экземпляр поддерживает агент SQL Server, важный компонент приложения SmartHotel360. Компании Contoso требуется такая совместимость, в противном случае потребуется переконструировать планы обслуживания, необходимые для приложения.
- С помощью программы Software Assurance Contoso может обмениваться существующими лицензиями на Управляемый экземпляр SQL, используя Преимущество гибридного использования Azure для SQL Server. Это позволяет компании Contoso сэкономить до 30% на Управляемый экземпляр SQL.
- SQL Управляемый экземпляр полностью содержится в виртуальной сети, поэтому обеспечивает более высокий уровень изоляции и безопасности данных Contoso. Компания Contoso может получить преимущества общедоступного облака, сохранив изолированную среду от общедоступного Интернета.
- SQL Управляемый экземпляр поддерживает множество функций безопасности, включая Always-encrypted, динамическое Маскирование данных, безопасность на уровне строк и обнаружение угроз.

### <a name="solution-review"></a>Проверка решения

Специалисты Contoso оценивают предлагаемый дизайн, составляя список плюсов и минусов.

| Рассматриваемый вопрос | Сведения |
| --- | --- |
| **Преимущества** | `WEBVM`будут перемещены в Azure без изменений, что сделает миграцию простой. <br><br> Управляемый экземпляр SQL соответствует техническим требованиям и целям компании Contoso. <br><br> SQL Управляемый экземпляр обеспечит совместимость с текущим развертыванием на 100%, при этом не удаляя их из SQL Server 2008 R2. <br><br> Компания может задействовать свои инвестиции в программу Software Assurance, воспользовавшись Преимуществом гибридного использования Azure для SQL Server и Windows Server. <br><br> Они могут повторно использовать Azure Database Migration Service для дальнейших миграций. <br><br> В Управляемый экземпляр Базы данных SQL встроены средства обеспечения отказоустойчивости, которые специалистам Contoso не требуется настраивать. Это гарантия того, что уровень данных больше не является единой точкой отказа. |
| **Недостатки** | Работает `WEBVM` под Windows Server 2008 R2. Эта операционная система поддерживается в Azure, но больше не является поддерживаемой платформой. [Подробнее](https://support.microsoft.com/help/956893). <br><br> Веб-уровень остается единственной точкой отработки отказа, `WEBVM` предоставляя только службы. <br><br> Contoso потребуется продолжить поддержку веб-уровня приложения в качестве виртуальной машины, а не переходить в управляемую службу, например службу приложений Azure. <br><br> Для уровня данных SQL Управляемый экземпляр может быть не лучшим решением, если Contoso хочет настроить операционную систему или сервер базы данных или запускать сторонние приложения вместе с SQL Server. Использование SQL Server на виртуальной машине IaaS может обеспечить такую гибкость. |

### <a name="migration-process"></a>Процесс миграции

Contoso перенесет веб-уровень и уровни данных своего приложения SmartHotel360 в Azure, выполнив следующие действия:

1. У компании уже есть инфраструктура Azure, поэтому ей необходимо добавить всего пару специальных компонентов Azure в свой сценарий.
2. Уровень данных будет перенесен с помощью Azure Database Migration Service. Эта служба подключается к локальной виртуальной машине SQL Server через VPN-подключение типа "сеть — сеть" между центром обработки данных Contoso и Azure. Затем служба перенесет базу данных.
3. Веб-уровень будет перенесен с помощью миграции с переносом и сдвигом с помощью службы "миграция Azure". Этот процесс подготовит локальную среду VMware, настроит и включит репликацию, а также осуществит миграцию виртуальных машин в Azure.

     ![Архитектура миграции](./media/contoso-migration-rehost-vm-sql-managed-instance/migration-architecture.png)

### <a name="azure-services"></a>Службы Azure

| Служба | Описание | Стоимость |
| --- | --- | --- |
| [Миграция баз данных Azure](https://docs.microsoft.com/azure/dms/dms-overview) | Azure Database Migration Service обеспечивает простой перенос из нескольких источников базы данных в платформы данных Azure с минимальным временем простоя. | Дополнительные сведения о [поддерживаемых регионах](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) и | [Azure Database Migration Service цены](https://azure.microsoft.com/pricing/details/database-migration). |
| [Управляемый экземпляр SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | SQL Управляемый экземпляр — это управляемая служба базы данных, которая представляет собой полностью управляемый экземпляр SQL Server в облаке Azure. Он использует тот же код, что и последняя версия ядра СУБД SQL Server, и имеет новейшие функции, улучшения производительности и исправления системы безопасности. | При использовании Управляемый экземпляр SQL, выполняемого в Azure, взимается плата в зависимости от емкости. Дополнительные сведения о [ценах на SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/sql-database/managed). |
| [Миграция Azure](https://docs.microsoft.com/azure/migrate/migrate-services-overview) | Компания Contoso использует службу "Миграция Azure" для оценки виртуальных машин VMware. Служба "Миграция Azure" оценивает миграционную пригодность компьютеров. Она обеспечивает оценку размера и стоимости для работы в Azure. | За использование службы "Миграция Azure" не нужно дополнительно платить. Однако оплата может взиматься в зависимости от средств (от первой стороны или ISV), которые вы решили использовать для оценки и миграции. Дополнительные сведения о [ценах на миграцию Azure](https://azure.microsoft.com/pricing/details/azure-migrate). |

## <a name="prerequisites"></a>Обязательные условия

Компания Contoso и другие пользователи должны отвечать следующим предварительным условиям этого сценария.

| Требования | Сведения |
| --- | --- |
| **Подписка Azure.** | Вы должны были создать подписку, когда выполняли оценку в первой статье этой серии. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free). <br><br> Если вы создаете бесплатную учетную запись, вы являетесь администратором своей подписки и можете выполнять любые действия. <br><br> Если вы используете существующую подписку и вы не являетесь администратором подписки, необходимо обратиться к администратору, чтобы назначить вам разрешения владельца или участника для необходимых групп ресурсов и ресурсов. |
| **Инфраструктура Azure** | Contoso настраивает свою инфраструктуру Azure, как описано в статье [Развертывание инфраструктуры Azure для миграции в Contoso](./contoso-migration-infrastructure.md). |
| **Локальные серверы** | Локальная vCenter Server должна работать под управлением версии 5,5, 6,0 или 6,5. <br><br> Узел ESXi с версией 5,5, 6,0 или 6,5. <br><br> Одна или несколько виртуальных машин VMware, которые выполняются на узле ESXi. |
| **Локальные виртуальные машины** | [Ознакомьтесь со списком виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros), которые рекомендованы к использованию в Azure. |
| **Database Migration Service** | Для Azure Database Migration Service требуется [совместимое локальное VPN-устройство](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices). <br><br> Необходимо настроить локальное VPN-устройство. Оно должно иметь внешний общедоступный IPv4-адрес. Этот адрес не может быть за устройством преобразования сетевых адресов (NAT). <br><br> Убедитесь, что у вас есть доступ к локальной базе данных SQL Server. <br><br> Брандмауэр Windows должен иметь доступ к ядру исходной СУБД. Узнайте, как [настроить брандмауэр Windows для доступа к ядру СУБД](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access). <br><br> Если перед вашим компьютером базы данных есть брандмауэр, добавьте правила, разрешающие доступ к базе данных и файлам через SMB-порт 445. <br><br> Учетные данные, используемые для подключения к исходному экземпляру SQL Server и целевому Управляемый экземпляр SQL, должны быть членами роли сервера sysadmin. <br><br> Вам потребуется сетевая папка в локальной базе данных, которую Azure Database Migration Service может использовать для резервного копирования базы данных-источника. <br><br> Убедитесь, что учетная запись службы, от имени которой выполняется исходный экземпляр SQL Server, имеет разрешения на запись для этой сетевой папки. <br><br> Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Azure Database Migration Service олицетворяет эти учетные данные пользователя для отправки файлов резервных копий в контейнер службы хранилища Azure. <br><br> В процессе установки SQL Server Express для протокола TCP/IP устанавливается **отключенное состояние** по умолчанию. Убедитесь, что он включен. |

## <a name="scenario-steps"></a>Шаги выполнения сценария

Настройку развертывания компания Contoso планирует осуществлять следующим образом.

> [!div class="checklist"]
>
> - **Шаг 1. Подготовка Управляемый экземпляр SQL.** Компании Contoso необходим существующий управляемый экземпляр, в который будет перенесена локальная база данных SQL Server.
> - **Шаг 2. Подготовка Azure Database Migration Service.** Компания Contoso должна зарегистрировать поставщик миграции баз данных, создать экземпляр, а затем создать проект Database Migration Service. Contoso также должен настроить универсальный код ресурса (URI) подписанного URL-идентификатора (SAS) для экземпляра Database Migration Service. URI SAS предоставляет делегированный доступ к ресурсам в учетной записи хранения компании Contoso, поэтому компания может предоставлять ограниченные разрешения к объектам в хранилище. Компания Contoso настраивает универсальный код ресурса (URI) SAS, поэтому Azure Database Migration Service может получить доступ к контейнеру учетной записи хранения, в который служба отправляет файлы резервных копий SQL Server.
> - **Шаг 3. Подготовка Azure для миграции Azure: миграция сервера.** Они добавляют средство миграции сервера в проект службы "миграция Azure".
> - **Шаг 4. Подготовка локальной среды VMware для миграции в Azure: миграция сервера.** Они подготавливают учетные записи для обнаружения ВМ и подготавливают подключение к виртуальным машинам Azure после миграции.
> - **Шаг 5. репликация виртуальных машин.** Они настроили репликацию и начинают репликацию виртуальных машин в службу хранилища Azure.
> - **Шаг 6. Перенос базы данных с помощью Azure Database Migration Service.** Contoso проводит миграцию базы данных.
> - **Шаг 7. Миграция виртуальной машины с помощью службы "миграция Azure": миграция сервера.** Они выполняют тестовую миграцию, чтобы убедиться, что все работает, а затем выполните полную миграцию, чтобы переместить виртуальные машины в Azure.

## <a name="step-1-prepare-a-sql-managed-instance"></a>Шаг 1. Подготовка SQL Управляемый экземпляр

Чтобы настроить Управляемый экземпляр Azure SQL, Contoso требуется подсеть, которая соответствует следующим требованиям:

- Подсеть должна быть выделенной. Она должна быть пустой и не содержать другие облачные службы. Подсеть не должна быть подсетью шлюза.
- После создания управляемого экземпляра компания Contoso не должна добавлять ресурсы в подсеть.
- С подсетью не должна быть связана группа безопасности сети.
- Подсеть должна иметь определяемую пользователем таблицу маршрутов. Единственный назначенный маршрут должен быть `0.0.0.0/0` Интернетом следующего прыжка.
- Если для виртуальной сети указан необязательный настраиваемый DNS-сервер, виртуальный IP-адрес `168.63.129.16` для рекурсивных арбитров конфликтов в Azure должен быть добавлен в список. Узнайте, как [настроить пользовательский DNS для управляемый экземпляр Azure SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).
- С подсетью не должна быть связана конечная точка службы (служба хранилища или база данных SQL). Конечные точки службы должны быть отключены в виртуальной сети.
- Для подсети необходимо как минимум 16 IP-адресов. Узнайте, как [изменить размер подсети управляемого экземпляра](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration).
- В гибридной среде Contoso требуются пользовательские параметры DNS. Компания Contoso настроит параметры DNS для использования одного или нескольких серверов DNS Azure компании. Дополнительные сведения о [настройке DNS](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a>Настройка виртуальной сети в управляемом экземпляре

Администраторы Contoso настраивают виртуальную сеть следующим образом:

1. Они создают новую виртуальную сеть ( `VNET-SQLMI-EU2` ) в основном регионе ( `East US 2` ). Она добавляет виртуальную сеть в `ContosoNetworkingRG` группу ресурсов.
2. Они присваивают адресное пространство `10.235.0.0/24` . Они гарантируют, что диапазон не пересекается с другими сетями в организации.
3. Они добавят к сети две подсети:
    - `SQLMI-DS-EUS2` (`10.235.0.0/25`).
    - `SQLMI-SAW-EUS2` (`10.235.0.128/29`). Эта подсеть используется для присоединения каталога к управляемому экземпляру.

      ![Управляемый экземпляр SQL: создание виртуальной сети](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

4. После развертывания виртуальной сети и подсетей они назначают сетям ранги следующим образом:

    - Пиринг `VNET-SQLMI-EUS2` с `VNET-HUB-EUS2` (виртуальная сеть концентратора в `East US 2` ).
    - Одноранговые узлы `VNET-SQLMI-EUS2` `VNET-PROD-EUS2` (Рабочая сеть).

      ![Пиринг сетей](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

5. Они задают пользовательские параметры DNS. Служба доменных имен (DNS) сначала указывает на контроллеры домена Azure компании Contoso. Azure DNS является вторичной. Контроллеры домена Contoso Azure находятся в следующих расположениях.

    - Находится в `PROD-DC-EUS2` подсети в `East US 2` рабочей сети ( `VNET-PROD-EUS2` ).
    - `CONTOSODC3`Адрес: `10.245.42.4` .
    - `CONTOSODC4`Адрес: `10.245.42.5` .
    - Сопоставитель Azure DNS: `168.63.129.16` .

      ![DNS-серверы сети](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

**Требуется дополнительная помощь?**

- Ознакомьтесь с [обзором управляемый экземпляр SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance).
- Узнайте, как [создать виртуальную сеть для управляемый экземпляр SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration).
- См. раздел [Создание, изменение и удаление пиринга в виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering).
- См. раздел [Включение доменных служб Azure Active Directory](https://docs.microsoft.com/azure/active-directory-domain-services/tutorial-create-instance).

### <a name="set-up-routing"></a>Настройка маршрутизации

Управляемый экземпляр помещается в закрытую виртуальную сеть. Компании Contoso требуется таблица маршрутов для связи между виртуальной сетью и службой управления Azure. Если виртуальная сеть не может связаться со службой, которая ею управляет, виртуальная сеть становится недоступной.

Компания Contoso принимает во внимание следующие факторы.

- Таблица маршрутов содержит набор правил (маршрутов), указывающих, как пакеты, отправляемые из управляемого экземпляра, должны маршрутизироваться в виртуальной сети.
- Таблица маршрутов связана с подсетями, в которых развернуты управляемые экземпляры. Каждый пакет, который оставляет подсеть, обрабатывается на основе связанной таблицы маршрутизации.
- Подсеть может быть связана только с одной таблицей маршрутизации.
- Никаких дополнительных затрат при создании таблицы маршрутизации в Microsoft Azure не требуется.

 Чтобы настроить маршрутизацию, администраторы Contoso выполняют следующие действия:

1. Они создают определяемую пользователем таблицу маршрутов в `ContosoNetworkingRG` группе ресурсов.

    ![Таблица маршрутов](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

2. Чтобы обеспечить соответствие требованиям SQL Управляемый экземпляр, после развертывания таблицы маршрутов ( `MIRouteTable` ) они добавляют маршрут с префиксом адреса `0.0.0.0/0` . Параметр **Тип следующего прыжка** установлен как **Интернет**.

    ![Префикс таблицы маршрутизации](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)

3. Таблица маршрутов связывается с `SQLMI-DB-EUS2` подсетью (в `VNET-SQLMI-EUS2` сети).

    ![Подсеть таблицы маршрутизации](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)

**Требуется дополнительная помощь?**

Узнайте, как [настроить маршруты для управляемого экземпляра](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started).

### <a name="create-a-managed-instance"></a>Создание управляемого экземпляра

Теперь администраторы Contoso могут подготавливать Управляемый экземпляр SQL:

1. Поскольку управляемый экземпляр обслуживает бизнес-приложение, он развертывает управляемый экземпляр в основном регионе компании ( `East US 2` ). Они добавляют управляемый экземпляр в `ContosoRG` группу ресурсов.
2. Они выбирают ценовую категорию и размер вычислений и хранилище для экземпляра. Дополнительные сведения о [ценах на SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/sql-database/managed).

    ![Базы данных SQL](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

3. После развертывания управляемого экземпляра в группе ресурсов появятся два новых ресурса `ContosoRG` :

    - Новый Управляемый экземпляр SQL.
    - Виртуальный кластер в случае, если Contoso имеет несколько управляемых экземпляров.

      ![Базы данных SQL](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

**Требуется дополнительная помощь?**

Узнайте, как [подготавливать управляемый экземпляр](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started).

## <a name="step-2-prepare-azure-database-migration-service"></a>Шаг 2. Подготовка Azure Database Migration Service

Чтобы подготовить Azure Database Migration Service, администраторы Contoso должны выполнить несколько действий:

- Зарегистрировать поставщик Database Migration Service в Azure.
- Предоставьте разрешение Database Migration Service доступ к службе хранилища Azure для отправки файлов резервных копий, которые используются для миграции базы данных. Чтобы предоставить доступ к службе хранилища Azure, они создают контейнер хранилища BLOB-объектов Azure. Они создают URI SAS для контейнера хранилища BLOB-объектов.
- Администраторы создают проект Azure Database Migration Service.

Затем выполняются указанные ниже действия.

1. Они регистрируют службу миграции баз данных в своей подписке. ![Database Migration Service: Register](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-subscription.png)

2. Они создают контейнер больших двоичных объектов. Contoso создает URI SAS, чтобы Azure Database Migration Service мог получить к нему доступ.

    ![Database Migration Service: Создание URI SAS](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-sas.png)

3. Они создают экземпляр Azure Database Migration Service.

    ![Database Migration Service: создание экземпляра](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-instance.png)

4. Они размещают Database Migration Service экземпляр в `PROD-DC-EUS2` подсети `VNET-PROD-DC-EUS2` виртуальной сети.
    - Экземпляр размещается здесь, так как служба должна находиться в виртуальной сети, которая может обращаться к локальной SQL Server виртуальной машине через VPN-шлюз.
    - `VNET-PROD-EUS2`является одноранговым `VNET-HUB-EUS2` и может использовать удаленные шлюзы. Параметр **использовать удаленные шлюзы** гарантирует, что экземпляр может взаимодействовать должным образом.

        ![Database Migration Service: Настройка сети](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-network.png)

**Требуется дополнительная помощь?**

- Узнайте, как [настроить Azure Database Migration Service](https://docs.microsoft.com/azure/dms/quickstart-create-data-migration-service-portal).
- Узнайте, как [создать и использовать подписанный URL-адрес](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2).

## <a name="step-3-prepare-azure-for-the-azure-migrate-server-migration-tool"></a>Шаг 3. Подготовка Azure к работе с миграцией Azure: средство миграции сервера

Ниже перечислены компоненты Azure, которые необходимы для миграции виртуальных машин компании Contoso в Azure.

- Виртуальная сеть, в которой будут находиться виртуальные машины Azure при их создании во время миграции.
- Средство миграции Azure: подготовка к переходу на сервер.

Специалисты компании Contoso настроили их указанным ниже образом.

1. **Настройка сети:** Компания Contoso уже настроила сеть, которая может быть для службы "миграция Azure": миграция сервера при [развертывании инфраструктуры Azure](./contoso-migration-infrastructure.md)

    - Приложение SmartHotel360 — это рабочее приложение, и виртуальные машины будут перенесены в рабочую сеть Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
    - Обе виртуальные машины будут помещены в `ContosoRG` группу ресурсов, которая будет использоваться для рабочих ресурсов.
    - Клиентская виртуальная машина приложения ( `WEBVM` ) будет перенесена в интерфейсную подсеть ( `PROD-FE-EUS2` ) рабочей сети.
    - Виртуальная машина базы данных приложений ( `SQLVM` ) будет перенесена в подсеть базы данных ( `PROD-DB-EUS2` ) рабочей сети.

## <a name="step-4-prepare-on-premises-vmware-for-azure-migrate-server-migration"></a>Шаг 4. Подготовка локальной среды VMware для миграции в Azure: миграция сервера

Ниже перечислены компоненты Azure, которые необходимы для миграции виртуальных машин компании Contoso в Azure.

- Виртуальная сеть, в которой будут находиться виртуальные машины Azure при их создании во время миграции.
- Устройство для миграции Azure, подготовленное и настроенное.

Специалисты компании Contoso настроили их указанным ниже образом.

1. Настройка сети — Contoso уже настроена сеть, которая может быть для службы "миграция Azure": миграция сервера при [развертывании инфраструктуры Azure](./contoso-migration-infrastructure.md)

    - Приложение SmartHotel360 — это рабочее приложение, и виртуальные машины будут перенесены в рабочую сеть Azure ( `VNET-PROD-EUS2` ) в основном регионе ( `East US 2` ).
    - Обе виртуальные машины будут помещены в `ContosoRG` группу ресурсов, которая будет использоваться для рабочих ресурсов.
    - Клиентская виртуальная машина приложения ( `WEBVM` ) будет перенесена в интерфейсную подсеть ( `PROD-FE-EUS2` ) в рабочей сети.
    - Виртуальная машина базы данных приложений ( `SQLVM` ) будет перенесена в подсеть базы данных ( `PROD-DB-EUS2` ) в рабочей сети.

2. Подготавливает устройство для миграции Azure.

    - В службе "миграция Azure" Скачайте образ OVA и импортируйте его в VMware.

        ![Скачивание файла OVA](./media/contoso-migration-rehost-vm/migration-download-ova.png)

    - Запустите импортированное изображение и настройте средство, включая следующие шаги:

      - Настройте необходимые компоненты.

        ![Настройка средства](./media/contoso-migration-rehost-vm/migration-setup-prerequisites.png)

      - Наведите указатель на инструмент на подписку Azure.

        ![Настройка средства](./media/contoso-migration-rehost-vm/migration-register-azure.png)

      - Задайте учетные данные VMware vCenter.

        ![Настройка средства](./media/contoso-migration-rehost-vm/migration-vcenter-server.png)

      - Добавьте учетные данные для обнаружения на основе Linux или Windows.

        ![Настройка средства](./media/contoso-migration-rehost-vm/migration-credentials.png)

3. После настройки для этого средства потребуется некоторое время для перечисления всех виртуальных машин. После завершения вы увидите, что они заполняются в средстве миграции Azure в Azure.

**Требуется дополнительная помощь?**

Узнайте, как настроить [устройство для миграции Azure](https://docs.microsoft.com/azure/migrate/migrate-services-overview#azure-migrate-server-migration-tool).

### <a name="prepare-on-premises-vms"></a>Подготовка локальных виртуальных машин

После миграции компания Contoso хочет подключиться к виртуальным машинам Azure и разрешить Azure управлять виртуальными машинами. Для этого перед миграцией администраторы компании Contoso выполняют указанные ниже действия.

1. Для доступа через Интернет они делают следующее.

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Проверяют, добавлены ли правила TCP и UDP для профиля **Общедоступный**.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.

2. Для доступа через VPN типа "сеть — сеть":

    - Включите RDP или SSH на локальной виртуальной машине перед миграцией.
    - Убедитесь, что протокол RDP или SSH разрешен в брандмауэре операционной системы.
    - Для Windows задайте для политики SAN операционной системы на локальной виртуальной машине значение **OnlineAll**.

3. Установите агент для Azure:

    - [Агент Linux для Azure](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux)
    - [Агент Azure для Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-windows)

4. Прочие вещества

   - Для Windows на виртуальной машине не должно быть ожидающих обновлений Windows при активации миграции. Если есть такие обновления, не удастся войти в систему на виртуальной машине до их завершения.
   - После миграции они могут проверить **диагностику загрузки** , чтобы просмотреть снимок экрана виртуальной машины. Если не удается сделать это, необходимо проверить, работает ли виртуальная машина, и изучить [советы по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

**Требуется дополнительная помощь?**

- Дополнительные сведения о [подготовке виртуальных машин к миграции](https://docs.microsoft.com/azure/migrate/prepare-for-migration).

## <a name="step-5-replicate-the-on-premises-vms"></a>Шаг 5. репликация локальных виртуальных машин

Чтобы можно было запустить миграцию в Azure, администраторам компании Contoso потребуется настроить и включить репликацию.

По завершении обнаружения можно начать репликацию виртуальных машин VMware в Azure.

1. В проекте "миграция Azure" > **серверы**, служба **"миграция Azure": миграция сервера**выберите **репликация**.

    ![Репликация виртуальных машин](./media/contoso-migration-rehost-vm/select-replicate.png)

2. В разделе Параметры **репликации**  >  **источника**  >  **виртуальные машины виртуализированы?** выберите **Да, с VMware vSphere**.

3. В разделе **Локальное устройство** выберите имя устройства Миграции Azure, которое вы настроили, и нажмите кнопку **ОК**.

    ![Параметры источника](./media/contoso-migration-rehost-vm/source-settings.png)

4. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не выполняли оценку или вы не хотите использовать параметры оценки, выберите параметр **нет** .
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.

    ![Выбор оценки](./media/contoso-migration-rehost-vm/select-assessment.png)

5. В разделе **Виртуальные машины** найдите виртуальные машины и отметьте каждую виртуальную машину, которую вы хотите перенести. Затем нажмите кнопку **Далее: целевые параметры**.

6. В разделе **Целевые параметры** выберите подписку и целевой регион, в который вы хотите выполнить миграцию, а также укажите группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.

7. В **преимущество гибридного использования Azure**выберите следующее:

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем нажмите кнопку **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

8. В разделе **Вычисления** просмотрите имя виртуальной машины, размер, тип диска ОС и группу доступности. Виртуальные машины должны соответствовать [требованиям Azure](https://docs.microsoft.com/azure/migrate/migrate-support-matrix-vmware#vmware-requirements).

    - **Размер виртуальной машины:** Если вы используете рекомендации по оценке, раскрывающийся список размер виртуальной машины будет содержать рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. Кроме того, можно выбрать размер вручную в качестве **размера виртуальной машины Azure.**
    - **Диск ОС:** Укажите диск операционной системы (загрузочный) для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком.
    - **Группа доступности:** Если после миграции виртуальная машина должна находиться в группе доступности Azure, укажите набор. Группа должна находиться в целевой группе ресурсов, которую вы указываете для миграции.

9. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции.

10. В окне **Проверка и запуск репликации**проверьте параметры и выберите **репликация** , чтобы запустить начальную репликацию для серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

## <a name="step-6-migrate-the-database-via-azure-database-migration-service"></a>Шаг 6. Перенос базы данных с помощью Azure Database Migration Service

Администраторам Contoso необходимо создать проект Database Migration Service, а затем перенести базу данных.

### <a name="create-an-azure-database-migration-service-project"></a>Создание проекта Azure Database Migration Service

1. Администраторы создают проект Database Migration Service. Они выбирают тип сервера источника **SQL Server** и **управляемый экземпляр SQL Azure** в качестве целевого объекта.

     ![Database Migration Service: новый проект миграции](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-project.png)

2. Откроется мастер миграции.

### <a name="migrate-the-database"></a>Миграция базы данных

1. В мастере миграции они указывают исходную виртуальную машину, на которой находится локальная база данных. Они вводят учетные данные для доступа к базе данных.

    ![Database Migration Service: сведения об источнике](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-source.png)

2. Они выбирают базу данных для миграции ( `SmartHotel.Registration` ):

    ![Database Migration Service: Выбор баз данных источника](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-source-db.png)

3. Для целевого объекта они вводят имя управляемого экземпляра в Azure, а также учетные данные доступа.

    ![Database Migration Service: сведения о целевом объекте](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-target-details.png)

4. В **новом действии**  >  **запустить миграцию**указываются параметры для запуска миграции:
    - Источник и цель учетных данных.
    - База данных для переноса.
    - Сетевая папка, созданная на локальной виртуальной машине. Azure Database Migration Service выполняет резервное копирование исходного кода в эту общую папку.
        - Учетная запись службы, которая выполняет исходный экземпляр SQL Server, должна иметь права записи для этой общей папки.
        - Должен использоваться полный путь FQDN к общей папке.
    - URI SAS, предоставляющий Azure Database Migration Service с доступом к контейнеру учетной записи хранения, в который служба отправляет файлы резервных копий для миграции.

        ![Database Migration Service: Настройка параметров миграции](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-migration-settings.png)

5. Они сохраняют параметры миграции и запускают ее.
6. В разделе **Обзор** они отслеживают состояние миграции.

    ![Database Migration Service: мониторинг](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor1.png)

7. По завершении миграции они проверяют, существуют ли целевые базы данных в управляемом экземпляре.

    ![Database Migration Service: Проверка миграции базы данных](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor2.png)

## <a name="step-7-migrate-the-vms-with-azure-migrate-server-migration"></a>Шаг 7. Миграция виртуальных машин с помощью службы "миграция Azure": миграция сервера

Администраторы Contoso выполняют быструю тестовую миграцию и проверяют, что виртуальная машина работает правильно, а затем переносит виртуальную машину.

### <a name="run-a-test-migration"></a>Выполнение тестовой миграции

1. В списке **цели миграции**  >  **серверы**  >  **Миграция Azure: миграция сервера**выберите **тестировать перенесенные серверы**.

     ![Тестовая миграция серверов](./media/contoso-migration-rehost-linux-vm/test-migrated-servers.png)

2. Выберите и удерживайте (или щелкните правой кнопкой мыши) виртуальную машину для тестирования и выберите пункт **Тестовая миграция**.

    ![Тестовая миграция](./media/contoso-migration-rehost-linux-vm/test-migrate.png)

3. В области **Тестовая миграция**выберите виртуальную сеть Azure, в которой будет расположена виртуальная машина Azure после миграции. Мы рекомендуем использовать непродукцию-виртуальную сеть.
4. Запустится задание **Тестовая миграция**. Отслеживайте задание и уведомления на портале.
5. После завершения миграции просмотрите перенастроенную виртуальную машину Azure в разделе **Виртуальные машины** на портале Azure. Имя машины содержит суффикс **-Test**.
6. После завершения теста выберите и удерживайте (или щелкните правой кнопкой мыши) виртуальную машину Azure в области **репликации компьютеров**и выберите **очистить тестовую миграцию**.

    ![Очистка миграции](./media/contoso-migration-rehost-linux-vm/clean-up.png)

### <a name="migrate-the-vms"></a>Миграция виртуальных машин

Теперь администраторы Contoso выполняют полную миграцию для завершения перемещения.

1. В проекте "миграция Azure" > **серверы**  >  **Миграция Azure: миграция сервера**выберите **репликация серверов**.

    ![Репликация серверов](./media/contoso-migration-rehost-linux-vm/replicating-servers.png)

2. В области **репликация компьютеров**выберите и удерживайте (или щелкните правой кнопкой мыши) виртуальную машину, > **выполнить миграцию**.
3. В разделе **Миграция** > **Shut down virtual machines and perform a planned migration with no data loss** (Завершить работу виртуальных машин и выполнить запланированную миграцию без потери данных?) выберите вариант **Да** > **ОК**.
    - По умолчанию Миграция Azure выключает локальную виртуальную машину и запускает репликацию по требованию для синхронизации любых изменений виртуальной машины, которые произошли с момента последней репликации. Это гарантирует отсутствие потери данных.
    - Если вы не хотите выключать виртуальную машину, выберите вариант **Нет**.
4. Запустится задание миграции виртуальной машины. Отслеживайте задание в уведомлениях Azure.
5. После завершения работы вы можете просматривать виртуальную машину и управлять ею на странице **Виртуальные машины**.
6. Наконец, они обновляют записи DNS для `WEBVM` на одном из контроллеров домена contoso.

### <a name="update-the-connection-string"></a>Обновление строки подключения

В качестве последнего шага процесса миграции администраторы Contoso обновляют строку подключения приложения, чтобы она указывала на перенесенную базу данных, которая выполняется в SQL Управляемый экземпляр компании Contoso.

1. В портал Azure они находят строку подключения, выбрав **Параметры**  >  **строки подключения**.

    ![Строки подключения](./media/contoso-migration-rehost-vm-sql-managed-instance/failover4.png)

2. Они обновляют строку с именем пользователя и пароль управляемого экземпляра SQL.
3. После настройки строки они заменяют текущую строку подключения в `web.config` файле приложения.
4. После обновления файла и его сохранения перезапустите IIS в `WEBVM` , запустив `iisreset /restart` в окне командной строки.
5. После перезапуска IIS приложение использует базу данных, которая работает на Управляемый экземпляр SQL.
6. На этом этапе они могут завершить работу локальной машины SQLVM. Миграция завершена.

**Требуется дополнительная помощь?**

- Узнайте, как [выполнить тестовую отработку отказа](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure).
- Узнайте, как [создать план восстановления](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans).
- См. в разделе [Отработка отказа в Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover).

## <a name="clean-up-after-migration"></a>Очистка после миграции

После завершения миграции приложение SmartHotel360 выполняется на виртуальной машине Azure, а база данных SmartHotel360 доступна в Управляемый экземпляр Azure SQL.

Теперь компании Contoso потребуется предпринять следующее задачи очистки.

- Удалите `WEBVM` компьютер из vCenter Server инвентаризации.
- Удалите `SQLVM` компьютер из vCenter Server инвентаризации.
- Удаление `WEBVM` и `SQLVM` из локальных заданий резервного копирования.
- Обновите внутреннюю документацию, чтобы отобразить новое расположение и IP-адрес для `WEBVM` .
- Удалить `SQLVM` из внутренней документации. Кроме того, Contoso может изменить документацию, чтобы `SQLVM` она отображалась как удаленная и больше не направляться в инвентаризации виртуальных машин.
- Просмотреть все ресурсы, которые взаимодействуют с выведенными из эксплуатации виртуальными машинами. Обновить все соответствующие параметры или документы согласно новой конфигурации.

## <a name="review-the-deployment"></a>Проверка развертывания

Теперь, когда выполняется миграция ресурсов в Azure, компании Contoso необходимо полностью ввести в эксплуатацию и защитить свою новую инфраструктуру.

### <a name="security"></a>Безопасность

Группа безопасности Contoso изучает виртуальные машины Azure и Управляемый экземпляр SQL, чтобы проверить наличие проблем безопасности, связанных с его реализацией.

- Участники команды проверяют группы безопасности сети, которые используются для управления доступом к виртуальной машине. Группы безопасности сети позволяют обеспечить передачу только трафика, разрешенного для приложения.
- Команда безопасности Contoso также анализирует возможность защиты данных на диске с помощью шифрования дисков Azure и Key Vault Azure.
- Группа включает обнаружение угроз на управляемом экземпляре. Обнаружение угроз передает оповещения в службу безопасности или службу поддержки Contoso для открытия билета, если обнаружена угроза. Дополнительные сведения об [обнаружении угроз для SQL управляемый экземпляр](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-threat-detection).

     ![Безопасность SQL Управляемый экземпляр: обнаружение угроз](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-security.png)

Дополнительные сведения см. в разделе [Рекомендации по безопасности для рабочих нагрузок IaaS в Azure](https://docs.microsoft.com/azure/security/fundamentals/iaas).

### <a name="bcdr"></a>Непрерывность бизнес-процессов и аварийное восстановление

Чтобы обеспечить непрерывность бизнес-процессов и аварийное восстановление (BCDR), Contoso выполняет следующие действия:

- Безопасное хранение данных. Специалисты Contoso выполняют резервное копирование данных, содержащихся в виртуальных машинах, с помощью службы Azure Backup. Дополнительные сведения см. [в обзоре резервного копирования виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-introduction).
- Обеспечьте работоспособность приложений: contoso реплицирует виртуальные машины приложений в Azure в дополнительный регион с помощью Site Recovery. [Подробнее](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).
- Специалисты Contoso узнают больше о том, как контролировать Управляемый экземпляр SQL, в том числе [резервное копирование баз данных](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).

### <a name="licensing-and-cost-optimization"></a>Лицензирование и оптимизация затрат

- Компания Contoso имеет существующие лицензирование для WEBVM. Чтобы воспользоваться преимуществами цен предложения "Преимущества гибридного использования Azure", компания Contoso преобразует существующую виртуальную машину Azure.
- Компания Contoso будет использовать службу " [Управление затратами Azure" и выставление счетов](https://docs.microsoft.com/azure/cost-management-billing/cost-management-billing-overview) , чтобы гарантировать, что они останутся в бюджетах, установленных по ИТ.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso повторно размещает приложение SmartHotel360 в Azure, переключая клиентскую виртуальную машину приложения в Azure с помощью службы "миграция Azure". Contoso переносит локальную базу данных в Управляемый экземпляр Azure SQL с помощью Azure Database Migration Service.
