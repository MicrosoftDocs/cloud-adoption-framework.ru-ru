---
title: Рекомендации по настройке сетей для рабочих нагрузок, перенесенных в Azure
description: Используйте инфраструктуру внедрения в облаке для Azure, чтобы изучить рекомендации по настройке сети для перенесенных рабочих нагрузок.
author: BrianBlanchard
ms.author: brblanch
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
ms.openlocfilehash: c3ca563579ea8879d944fb59372e213faa942f18
ms.sourcegitcommit: bcc73d194c6d00c16ae2e3c7fb2453ac7dbf2526
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86194533"
---
<!-- cSpell:ignore NSGs CIDR FQDNs BGP's ACLs WAFs -->

# <a name="best-practices-to-set-up-networking-for-workloads-migrated-to-azure"></a>Рекомендации по настройке сетей для рабочих нагрузок, перенесенных в Azure

При планировании и разработке миграции, кроме самой миграции одним из наиболее важных этапов является проектирование и реализация сетей Azure. В этой статье приведены рекомендации по настройке сетей при миграции в реализации IaaS и PaaS в Azure.

> [!IMPORTANT]
> Рекомендации и мнения, приведенные в этой статье, основаны на возможностях платформы Azure и служб, доступных на момент написания этого материала. Функции и возможности со временем меняются. Не все рекомендации могут быть применимы в вашем сценарии развертывания, поэтому выберите подходящие для вас.

## <a name="design-virtual-networks"></a>Проектирование виртуальных сетей

Azure предоставляет виртуальные сети с этими возможностями:

- Ресурсы Azure конфиденциально, непосредственно и безопасно обмениваются данными друг с другом в виртуальных сетях.
- Вы можете настроить подключения конечных точек в виртуальных сетях для виртуальных машин и служб, которым требуется подключение к Интернету.
- Виртуальная сеть — это логическая изоляция облака Azure, выделенная для вашей подписки.
- Вы можете реализовать несколько виртуальных сетей в пределах подписки и региона Azure.
- Виртуальные сети изолированы друг от друга.
- Виртуальные сети могут содержать частные и общедоступные IP-адреса, определенные в [RFC 1918](https://tools.ietf.org/html/rfc1918) и выраженные в нотации CIDR. Общедоступные IP-адреса, указанные в диапазоне адресов виртуальной сети, не доступны напрямую из Интернета.
- Виртуальных сетей может подключаться друг к другу с помощью пиринга виртуальной сети. Подключенные виртуальные сети могут находиться в одном или разных регионах. Таким образом, ресурсы в одной виртуальной сети могут подключаться к ресурсам в других виртуальных сетях.
- По умолчанию Azure маршрутизирует трафик между подсетями одной виртуальной сети, подключенными виртуальными сетями, локальными сетями и Интернетом.

При планировании топологии виртуальной сети следует учитывать, как упорядочивать пространства IP-адресов, как реализовать центральную и периферийную сеть, как сегментировать виртуальных сетей в подсети, настраивать DNS и реализовывать Зоны доступности Azure.

## <a name="best-practice-plan-ip-addressing"></a>Рекомендация: планирование IP-адресации

При создании виртуальных сетей в рамках миграции очень важно спланировать пространство IP-адресов виртуальных сетей.

- Необходимо назначить адресное пространство, которое не превышает диапазон CIDR `/16` для каждой виртуальной сети. Виртуальных сетей позволяют использовать IP-адреса 65 536 и назначать меньший префикс `/16` , чем, например, с `/15` адресом 131 072, приведет к тому, что ЛИШНИЕ IP-адреса станут непригодными для использования в других местах. Важно не терять IP-адреса, даже если они находятся в частных диапазонах, определенных в RFC 1918.
- Адресное пространство виртуальной сети не должно перекрываться диапазонами локальной сети.
- Не используйте преобразование сетевых адресов (NAT).
- Перекрывающиеся адреса могут вызывать проблемы с подключением сетей и нарушения в работе маршрутизации. Если сети перекрываются, необходимо перепроектировать сеть или использовать преобразование сетевых адресов (NAT).

**Подробнее:**

- Ознакомьтесь с [обзором виртуальной сети Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview).
- Ознакомьтесь с [вопросами и ответами на виртуальную сеть Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-faq).
- Сведения об [ограничениях сети Azure](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits).

## <a name="best-practice-implement-a-hub-and-spoke-network-topology"></a>Рекомендации. Реализация топологии сети и звезды

Топология сети типа "звезда" подразумевает изоляцию рабочих нагрузок и совместное использование служб, таких как службы идентификации и безопасности.

- В качестве центральной точки подключения выступает виртуальная сеть Azure (концентратор).
- Периферийные серверы — это виртуальных сетей, которые подключаются к виртуальной сети концентратора с помощью пиринга виртуальных сетей.
- Общие службы развертываются в концентраторе, а отдельные рабочие нагрузки — в периферийных зонах.

Примите во внимание следующее.

- Реализация звездообразной топологии в Azure позволяет централизовать такие функции, как подключения к локальным сетям, брандмауэры и изоляция между виртуальными сетями. Виртуальная сеть концентратора обеспечивает центральную точку подключения к локальным сетям и место для размещения служб узла, используемых рабочими нагрузками в периферийных виртуальных сетях.
- Звездообразная конфигурация зачастую применяется на крупных предприятиях. В меньших сетях можно организовать более простую и бюджетную топологию.
- Периферийные виртуальные сети можно использовать для изоляции рабочих нагрузок, когда каждая из периферийных зон управляется отдельно от других. Каждая рабочая нагрузка может содержать несколько уровней с несколькими подсетями, подключенными через подсистемы балансировки нагрузки Azure.
- Центральную и периферийные виртуальные сети можно реализовать в разных группах ресурсов и даже разных подписках. Если вы настраиваете пиринг виртуальных сетей в разных подписках, эти подписки могут быть связаны с одним и тем же или разными клиентами Azure Active Directory (Azure AD). Это позволяет осуществлять децентрализованное управление каждой рабочей нагрузкой при совместном использовании служб, поддерживаемых в центральной сети.

![Изменить ](./media/migrate-best-practices-networking/hub-spoke.png)
 _топологию концентратора управления и звезды._

**Подробнее:**

- Ознакомьтесь с [топологией HUB и лучевой топологии](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/hub-spoke).
- Получите рекомендации по сети для запуска [виртуальных машин Windows](https://docs.microsoft.com/azure/architecture/reference-architectures/n-tier/windows-vm) и [виртуальных машин Linux](https://docs.microsoft.com/azure/architecture/reference-architectures/n-tier/linux-vm) в Azure.
- Узнайте о [пиринга виртуальных сетей](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview).

## <a name="best-practice-design-subnets"></a>Рекомендации: проектирование подсетей

Для обеспечения изоляции в пределах одной виртуальной сети следует разделить ее на подсети и выделить каждой из них часть адресного пространства виртуальной сети.

- В каждой виртуальной сети можно создать несколько подсетей.
- По умолчанию Azure маршрутизирует трафик между всеми подсетями в виртуальной сети.
- Решения о подсетях должны основываться на технических и организационных требованиях, выдвигаемых вашим сценарием.
- Подсети создаются с использованием нотации CIDR.
- При определении сетевого диапазона для подсетей важно учитывать то, что для Azure выделяются пять IP-адресов из каждой подсети, которые не могут использоваться. Например, если вы создадите наименьшую доступную подсеть `/29` (с восемью IP-адресами), в Azure будет храниться пять адресов, поэтому можно назначить только три адреса, которые могут быть назначены узлам в подсети.
- В большинстве случаев используйте `/28` в качестве наименьшей подсети.

**Пример.**

В таблице показан пример виртуальной сети с адресным пространством `10.245.16.0/20` , сегментированным на подсети, для плановой миграции.

| Подсеть | CIDR | Адреса | Использование |
| --- | --- | --- | --- |
| `DEV-FE-EUS2` | `10.245.16.0/22` | 1019 | Интерфейсные виртуальные машины или виртуальные машины веб-уровня |
| `DEV-APP-EUS2` | `10.245.20.0/22` | 1019 | Виртуальные машины уровня приложения |
| `DEV-DB-EUS2` | `10.245.24.0/23` | 507 | Виртуальные машины баз данных |

**Подробнее:**

- Сведения о [проектировании подсетей](https://docs.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#segmentation).
- [Узнайте о том](https://docs.microsoft.com/azure/migrate/contoso-migration-infrastructure), как вымышленная компания (Contoso) подготовила сетевую инфраструктуру для миграции.

## <a name="best-practice-set-up-a-dns-server"></a>Рекомендации. Настройка DNS-сервера

Azure добавляет DNS-сервер по умолчанию при развертывании виртуальной сети. Это позволяет быстро создавать виртуальные сети и развертывать ресурсы. Но этот DNS-сервер предоставляет только службы для ресурсов в этой виртуальной сети. Если нужно подключить друг к другу несколько виртуальных сетей или подключиться к локальному серверу из виртуальных сетей, потребуются дополнительные возможности разрешения имен. Например, может потребоваться настроить в Active Directory разрешение DNS-имен между виртуальными сетями. Чтобы сделать это, следует развернуть собственный пользовательский DNS-сервер в Azure.

- DNS-серверы в виртуальной сети могут перенаправлять запросы DNS в рекурсивные арбитры конфликтов в Azure. Это обеспечивает разрешение имен узлов в этой виртуальной сети. Например, контроллер домена, запущенный в Azure, может отвечать на запросы DNS для своих доменов и перенаправлять все остальные запросы в Azure.
- Перенаправление DNS позволяет виртуальным машинам видеть имена локальных ресурсов (с помощью контроллера домена) и узлов, предоставленные Azure (с помощью сервера перенаправления). Доступ к рекурсивным арбитрам конфликтов в Azure предоставляется с помощью виртуального IP-адреса `168.63.129.16` .
- Перенаправление DNS включает разрешение DNS между виртуальными сетями, а также позволяет локальным компьютерам разрешать имена узлов, предоставляемых Azure.
  - Чтобы разрешить имя узла виртуальной машины, такая виртуальная машина DNS-сервера должна находиться в той же виртуальной сети и быть настроена для перенаправления запросов имен узлов в Azure.
  - Так как DNS-суффиксы в разных виртуальных сетях различаются, можно использовать правила условного перенаправления для отправки запросов DNS в правильную виртуальную сеть для разрешения.
- Если вы используете собственные DNS-серверы, можно указать несколько DNS-серверов для каждой виртуальной сети. Можно также указать несколько DNS-серверов для каждого сетевого интерфейса (для Azure Resource Manager) или каждой облачной службы (для классической модели развертывания).
- DNS-серверы, указанные для сетевого интерфейса или облачной службы, имеют более высокий приоритет по сравнению с DNS-серверами, указанными для виртуальной сети.
- В модели развертывания Azure Resource Manager можно указать DNS-серверы для виртуальной сети и сетевого интерфейса, но эту конфигурацию рекомендуется использовать только в виртуальных сетях.

    ![DNS-серверы DNS ](./media/migrate-best-practices-networking/dns2.png) _для виртуальной сети._

**Подробнее:**

- Сведения о [разрешении имен при использовании собственного DNS-сервера](https://docs.microsoft.com/azure/migrate/contoso-migration-infrastructure).
- Сведения о [правилах именования DNS и ограничениях](../../ready/azure-best-practices/naming-and-tagging.md).

## <a name="best-practice-set-up-availability-zones"></a>Рекомендации: Настройка Зоны доступности

Зоны доступности повысить уровень доступности, чтобы защитить приложения и данные от сбоев центров обработки данных.

- Зоны доступности — уникальные физические расположения в пределах одного региона Azure.
- Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия.
- Чтобы обеспечить устойчивость, во всех включенных областях используются минимум три отдельные зоны.
- Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных.
- Службы, избыточные в пределах зоны, реплицируют приложения и данные на Зоны доступности для защиты от отдельных точек отказа. С Зоны доступности Azure предлагает соглашение об уровне обслуживания на 99,99% времени работы виртуальной машины.

    ![](./media/migrate-best-practices-networking/availability-zone.png) _Зона доступности_ зоны доступности.

- Можно запланировать и внедрить высокий уровень доступности в архитектуру миграции за счет совместного размещения вычислительных ресурсов, ресурсов хранилища, сети и данных в пределах зоны, а также за счет репликации в другие зоны. Службы Azure с поддержкой зон доступности делятся на две категории.
  - **Зональные Services:** Вы связываете ресурс с определенной зоной, например виртуальными машинами, управляемыми дисками или IP-адресами.
  - **Службы, избыточные в зонах:** Ресурс автоматически реплицируется по зонам, таким как хранилище, избыточное в пределах зоны, или база данных SQL Azure.
- Вы можете развернуть стандартную балансировку нагрузки Azure с рабочими нагрузками с выходом в Интернет или уровнями приложений, чтобы обеспечить отказоустойчивость зональные.

    ![Балансировщик нагрузки подсистемы балансировки нагрузки ](./media/migrate-best-practices-networking/load-balancer.png) _._

**Подробнее:**

- Ознакомьтесь с [обзором зоны доступности](https://docs.microsoft.com/azure/availability-zones/az-overview).

## <a name="design-hybrid-cloud-networking"></a>Проектирование гибридных облачных сетей

Для успешной миграции очень важно подключить локальные корпоративные сети к Azure. При этом создается постоянное подключение, называемое гибридной облачной сетью, в рамках которого службы предоставляются из облака Azure корпоративным пользователям. Существует два варианта создания сети такого типа:

- **VPN типа "сеть — сеть":** Вы устанавливаете подключение типа "сеть — сеть" между совместимым локальным VPN-устройством и VPN-шлюзом Azure, развернутым в виртуальной сети. Любой авторизованный локальный ресурс может получить доступ к виртуальным сетям. Обмен данными между сайтами отправляется через зашифрованный туннель через Интернет.
- **Azure ExpressRoute:** Вы устанавливаете подключение Azure ExpressRoute между локальной сетью и Azure через партнера ExpressRoute. Это подключение является частным, и трафик не проходит через Интернет.

**Подробнее:**

- Дополнительные сведения о [гибридных облачных сетях](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/vpn).

## <a name="best-practice-implement-a-highly-available-site-to-site-vpn"></a>Рекомендации. Реализация высокодоступного VPN типа "сеть — сеть"

Чтобы реализовать VPN-подключение типа "сеть — сеть", Настройте VPN-шлюз в Azure.

- VPN-шлюз — это конкретный тип шлюза виртуальной сети, который отправляет зашифрованный трафик между виртуальной сетью Azure и локальным расположением через общедоступный Интернет.
- VPN-шлюз также может передавать зашифрованный трафик между Azure виртуальных сетей по сети Microsoft.
- Каждая виртуальная сеть может иметь только один VPN-шлюз.
- К одному VPN-шлюзу можно создать несколько подключений. При создании нескольких подключений все VPN-туннели совместно используют доступную пропускную способность шлюза.
- Каждый VPN-шлюз Azure состоит из двух экземпляров: активного и резервного.
  - При плановом обслуживании или незапланированном сбое активного экземпляра происходит отработка отказа, и резервный экземпляр переключается автоматически и возобновляет подключение "сеть — сеть" или "Виртуальная сеть — виртуальная сети".
  - Переключение сопровождается кратким перебоем в работе.
  - При плановом обслуживании подключение должно быть восстановлено в течение 10–15 секунд.
  - При внеплановом сбое на восстановление подключения потребуется больше времени — от 1 до 1,5 минут (в худшем случае).
  - Подключения VPN-клиентов типа "точка — сеть" к шлюзу будут отключены, а пользователям потребуется повторно подключиться с клиентских компьютеров.

При настройке VPN типа "сеть — сеть" выполните следующие действия.

- Требуется виртуальная сеть с диапазоном адресов, не перекрывающимся с локальной сетью, к которой будет подключаться VPN.
- Создайте подсеть шлюза в сети.
- Создайте VPN-шлюз, задайте тип шлюза (VPN) и укажите, будет ли этот шлюз основан на политике или на маршрутах. VPN на основе маршрутов считается более производительной и будущей.
- В локальной среде создайте шлюз локальной сети и настройте локальное VPN-устройство.
- Вы создаете отказоустойчивое VPN-подключение типа "сеть — сеть" между шлюзом виртуальной сети и локальным устройством. Использование VPN на основе маршрутов позволяет создавать подключения к Azure как в режиме "активный — пассивный", так и в режиме "активный — активный". На основе маршрутов также поддерживается параллельное подключение типа "сеть — сеть" (с любого компьютера) и "точка — сеть" (с одного компьютера).
- Укажите требуемый номер SKU шлюза. Это будет зависеть от требований к рабочей нагрузке, пропускной способности, функций и соглашений об уровне обслуживания.
- Протокол BGP — это дополнительная функция, которую можно использовать с Azure ExpressRoute и VPN-шлюзами на основе маршрутов, чтобы распространить локальные маршруты BGP на виртуальные сети.

![VPN-подключение типа " ](./media/migrate-best-practices-networking/vpn.png)
 _сеть —_ сеть" VPN.

**Подробнее:**

- Ознакомьтесь [с совместимыми локальными VPN-устройствами](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices).
- Ознакомьтесь с [обзором VPN-шлюзов Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways).
- Узнайте о [высокодоступных VPN-подключениях](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-highlyavailable).
- Узнайте о [планировании и проектировании VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-plan-design).
- Проверьте [параметры VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku).
- Проверьте [номера SKU шлюзов](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways#gwsku).
- [Сведения](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-overview) о настройке BGP с VPN-шлюзами Azure.

### <a name="best-practice-configure-a-gateway-for-vpn-gateways"></a>Рекомендации. Настройка шлюза для VPN-шлюзов

При создании VPN-шлюза в Azure необходимо использовать специальную подсеть с именем `GatewaySubnet` . При создании этой подсети учитывайте следующее:

- `GatewaySubnet`может иметь максимальную длину префикса 29 (например, `10.119.255.248/29` ). Текущая рекомендация заключается в том, что используется длина префикса 27 (например, `10.119.255.224/27` ).
- При определении адресного пространства подсети шлюза используйте самую последнюю часть адресного пространства виртуальной сети.
- При использовании подсети шлюза Azure не развертывайте виртуальные машины или другие устройства, такие как шлюз приложений, в подсети шлюза.
- Не назначайте группу безопасности сети в эту подсеть. Это приведет к прекращению работы шлюза.

**Подробнее:**

- [Использование средства](https://gallery.technet.microsoft.com/scriptcenter/Address-prefix-calculator-a94b6eed) для определения пространства IP-адресов.

## <a name="best-practice-implement-azure-virtual-wan-for-branch-offices"></a>Рекомендации. Реализация виртуальной глобальной сети Azure для филиалов

Используемая для большого количества VPN-подключений виртуальная глобальная сеть Azure — это сетевая служба, которая обеспечивает оптимизированное и автоматизированное подключение между филиалами через Azure.

- Виртуальная глобальная сеть позволяет подключать и настраивать устройства филиала для взаимодействия с Azure. Это можно сделать вручную или с помощью предпочтительных устройств поставщика через виртуальный WAN-партнер Azure.
- Использование предпочтительных устройств провайдеров упрощает использование и подключение, а также управление конфигурацией.
- Встроенная панель мониторинга Azure WAN обеспечивает мгновенную диагностику, которая позволяет экономить время, а также предоставляет простой способ отслеживания крупномасштабного подключения типа "сеть — сеть".

**Дополнительные сведения:** Дополнительные сведения о [виртуальной глобальной сети Azure](https://docs.microsoft.com/azure/virtual-wan/virtual-wan-about).

### <a name="best-practice-implement-expressroute-for-mission-critical-connections"></a>Рекомендации. Реализация ExpressRoute для критически важных соединений

Служба Azure ExpressRoute расширяет возможности локальной инфраструктуры за счет Microsoft Cloud, создавая частные подключения между виртуальным центром обработки данных Azure и локальными сетями.

- Подключения ExpressRoute можно устанавливать между любыми сетями (IP VPN), в сети Ethernet "точка — точка" или через поставщика услуг подключения. Обмен данными не выполняется через общедоступный сегмент Интернета.
- Подключения ExpressRoute обеспечивают повышенный уровень безопасности, надежности и быстродействия (до 10 Гбит/с) с прогнозируемой задержкой.
- ExpressRoute подходит для виртуальных центров обработки данных, так как клиенты могут использовать правила соответствия, связанные с частными подключениями.
- С помощью ExpressRoute Direct можно подключаться непосредственно к маршрутизаторам Майкрософт через 100 Гбит/с для большей пропускной способности.
- В ExpressRoute используется протокол BGP для обмена маршрутами между локальными сетями, экземплярами Azure и общедоступными адресами Майкрософт.

Развертывание подключений ExpressRoute обычно требует участия поставщика услуг ExpressRoute. Для быстрого запуска обычно используется VPN-подключение типа "сеть — сеть" для установления подключения между виртуальным центром обработки данных и локальными ресурсами, а затем выполняется миграция в подключения ExpressRoute при установленном физическом соединении с поставщиком услуг.

**Подробнее:**

- [Общие сведения](https://docs.microsoft.com/azure/expressroute/expressroute-introduction) об ExpressRoute.
- Дополнительные сведения о программе [ExpressRoute Direct](https://docs.microsoft.com/azure/expressroute/expressroute-erdirect-about).

### <a name="best-practice-optimize-expressroute-routing-with-bgp-communities"></a>Рекомендации. Оптимизация маршрутизации ExpressRoute с помощью сообществ BGP

При наличии нескольких каналов ExpressRoute к сети Майкрософт можно подключиться по нескольким маршрутам. В результате маршрутизация может быть неоптимальной, то есть трафик, передаваемый из вашей сети в сеть Майкрософт и наоборот, будет проходить по более длинному маршруту. Это, в свою очередь, может стать причиной возникновения длительной задержки, которая прямо влияет на производительность приложения и работу пользователей.

**Пример.**

Давайте рассмотрим пример.

- У вас есть два офиса в США: один в Лос-Анджелес и один в городе Нью-Йорк.
- Эти офисы подключены к глобальной сети: к вашей собственной магистральной или предоставленной поставщиком IP VPN.
- У вас есть две цепи ExpressRoute: один в `West US` и один в `East US` , которые также подключены к глобальной сети. Очевидно, что подключение к сети Майкрософт можно установить по двум каналам.

**Ошибк**

Теперь представьте, что у вас есть развертывание Azure (например, служба приложений Azure) как в `West US` , так и в `East US` .

- Пользователям в каждом офисе требуется получить доступ к ближайшим службам Azure для оптимальной работы.
- Поэтому вы хотите подключить пользователей из Лос-Анджелес к Azure `West US` и пользователей в Нью-Йорке в Azure `East US` .
- Это работает для пользователей восточной части США, но не для тех, кто находится в регионе Дальневосточный. Проблема заключается в следующем.
  - В каждом канале ExpressRoute мы объявляем оба префикса в Azure: `East US` ( `23.100.0.0/16` ) и Azure `West US` ( `13.100.0.0/16` ).
  - Без сведений о том, какой префикс принадлежит какому региону, префиксы не будут обрабатываться по-разному.
  - В глобальной сети можно предположить, что оба префикса ближе к `East US` `West US` , чем, и, таким образом, перенаправляют пользователей из обоих офисов в канал ExpressRoute в `East US` , предоставляя неоптимальные возможности для пользователей в офисе Лос-Анджелес.

![](./media/migrate-best-practices-networking/bgp1.png)
_Неоптимизированное подключение VPN-сообществ BGP._

**Решение**.

Чтобы оптимизировать маршрутизацию для пользователей Office, необходимо знать, какой префикс относится к Azure `West US` и что из Azure `East US` . Эти сведения можно закодировать с помощью значений сообществ BGP.

- Каждому региону Azure назначается уникальное значение сообщества BGP. Например, 12076:51004 для `East US` ; 12076:51006 для `West US` .
- Теперь, когда очевидно, какой префикс относится к какому региону Azure, можно настроить предпочтительный канал ExpressRoute.
- Так как для обмена данными маршрутизации используется протокол BGP, маршрутизацией можно управлять, используя значения локального предпочтения BGP.
- В нашем примере вы назначаете более высокое значение локального предпочтения `13.100.0.0/16` в `West US` `East US` , а не в, а также более высокое локальное значение предпочтения `23.100.0.0/16` в, `East US` чем в `West US` .
- Эта конфигурация гарантирует, что если оба пути к Майкрософт доступны, пользователи в Лос-Анджелес подключаются к `West US` региону с помощью зоны "Западная часть", а пользователи в Нью-Йорке подключаются к `East US` региону с помощью канала восточной сети. Это обеспечивает оптимальную маршрутизацию на обоих сторонах.

![](./media/migrate-best-practices-networking/bgp2.png)
_Оптимизированное подключение сообществ BGP VPN._

**Подробнее:**

- Узнайте, как [оптимизировать маршрутизацию](https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing).

## <a name="secure-vnets"></a>Защита виртуальных сетей

Ответственность за обеспечение безопасности виртуальных сетей распределяется между вами и корпорацией Майкрософт. Корпорация Майкрософт предоставляет множество сетевых компонентов, а также службы, которые помогают поддерживать безопасность ресурсов. Существует ряд рекомендаций по проектированию безопасности виртуальных сетей, которым необходимо следовать, включая реализацию сети периметра, использование фильтрации и групп безопасности, защиту доступа к ресурсам и IP-адресам, а также реализацию защиты от атак.

**Подробнее:**

- Ознакомьтесь с [обзором рекомендаций по безопасности сети](https://docs.microsoft.com/azure/security/fundamentals/network-best-practices).
- Научитесь [создавать защищенные сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#security).

<!-- docsTest:ignore "IDS/IPS" -->

## <a name="best-practice-implement-an-azure-perimeter-network"></a>Рекомендации. Реализация сети периметра Azure

Хотя корпорация Майкрософт вкладывает большие средства в защиту облачной инфраструктуры, вам тоже необходимо принимать меры для защиты облачных служб и групп ресурсов. Лучшим подходом к обеспечению безопасности является многоуровневый подход к безопасности. Важной частью этой стратегии защиты является реализация сети периметра.

- Сеть периметра защищает внутренние сетевые ресурсы от ненадежных сетей.
- Это самый внешний слой, который доступен из Интернета. Он обычно располагается между Интернетом и инфраструктурой предприятия, обычно с использованием некоторой защиты с обеих сторон.
- В обычной корпоративной сетевой топологии базовая инфраструктура хорошо защищена по всему периметру несколькими уровнями устройств безопасности. Граница каждого уровня состоит из устройств и точек реализации политики.
- Каждый уровень может включать в себя сочетание решений безопасности сети, включая брандмауэры, предотвращение отказа в обслуживании (DoS), обнаружение вторжений и системы защиты от вторжений (ИДЕНТИФИКАТОРы и IP-адреса) и VPN-устройства.
- Реализация политики в сети периметра может предусматривать использование политик брандмауэра, списков управления доступом или правил маршрутизации.
- Входящий трафик из Интернета перехватывается и обрабатывается несколькими средствами обеспечения безопасности для блокирования атак и вредоносного трафика. При этом допустимые запросы в сеть пропускаются.
- Входящий трафик может направляться непосредственно к ресурсам в сети периметра. Ресурс сети периметра затем может обмениваться данными с другими ресурсами, размещенными дальше в сети, перенаправляя трафик в сеть после проверки.

На следующем рисунке показан пример одиночной подсети для сети периметра в корпоративной сети, с двумя границами безопасности.

![](./media/migrate-best-practices-networking/perimeter.png)
_Развертывание сети периметра VPN._

**Подробнее:**

- Узнайте, как [развернуть сеть периметра между Azure и локальным центром обработки данных](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/secure-vnet-dmz).

## <a name="best-practice-filter-vnet-traffic-with-nsgs"></a>Рекомендации. Фильтрация трафика виртуальной сети с помощью группы безопасности сети

Группы безопасности сети (NSG) содержат ряд правил безопасности, которые управляют входящим и исходящим трафиком, а также фильтруют трафик, поступающий к ресурсам или передаваемый от них. Фильтрацию можно осуществлять по исходному и конечному IP-адресам, порту и протоколу.

- В группах NSG содержатся правила безопасности, которые разрешают или запрещают исходящий и входящий сетевой трафик нескольких типов ресурсов Azure. Для каждого правила можно указать источник и назначение, порт и протокол.
- Правила NSG оцениваются по приоритету и на основе кортежей из пяти элементов (источник, порт источника, назначение, порт назначения и протокол), что позволяет разрешить или запретить трафик.
- Запись потока создается для имеющихся подключений. Обмен данными разрешен или запрещен в зависимости от состояния подключения записи потока.
- Запись потока позволяет NSG отслеживать состояние. Например, если задать правило безопасности для исходящего трафика по любому адресу через порт 80, устанавливать правило безопасности входящего трафика в ответ на исходящий трафик не требуется. Если связь инициируется извне, достаточно задать правило безопасности для входящего трафика.
- Обратное также верно. Если через порт разрешено поступление входящего трафика, задавать правило безопасности исходящего трафика в ответ на трафик через этот порт не требуется.
- Существующие подключения не прерываются при отключении правила безопасности, разрешающего этот поток. Поток трафика прерывается, когда подключения разрываются, то есть в течение нескольких минут трафик не передается в обоих направлениях.
- Создавайте как можно меньше групп NSG, но столько, столько необходимо.

### <a name="best-practice-secure-northsouth-and-eastwest-traffic"></a>Рекомендации: защита трафика с Севером/Юго-Восток и налево/Западная

При защите виртуальных сетей важно учитывать векторы атак.

- Использование NSG только в подсетях упрощает среду, но защищает только трафик, поступающий в подсеть. Это называется трафиком "север — юг".
- Трафик между виртуальными машинами в одной и той же подсети называется трафиком "восток — запад".
- Важно использовать обе формы защиты, так как если злоумышленник получит доступ извне, он будет остановлен при попытке подключения к компьютерам, расположенным в той же подсети.

### <a name="use-service-tags-on-nsgs"></a>Использование тегов служб в NSG

Тег службы представляет группу префиксов IP-адресов. Использование тега службы упрощает создание правил NSG.

- Теги служб можно использовать вместо определенных IP-адресов при создании правил.
- Корпорация Майкрософт управляет префиксами адресов, связанными с тем или иным тегом службы, и автоматически обновляет этот тег при изменении адресов.
- Нельзя создать собственный тег службы или задать IP-адреса, которые будут входить в тег.

Теги служб позволяют избежать назначения правила группам служб Azure вручную. Например, если нужно разрешить подсети, содержащей веб-серверы, получать доступ к базе данных SQL Azure, можно создать правило исходящего трафика для порта 1433 и использовать тег службы **SQL** .

- Тег **Sql** определяет префиксы адресов для служб Базы данных SQL Azure и Хранилища данных SQL Azure.
- Если в качестве значения задано значение **SQL** , трафик разрешается или отклоняется для SQL.
- Чтобы разрешить доступ к **Sql** только в определенном регионе, можно указать этот регион. Например, если требуется разрешить доступ только к базе данных SQL Azure в регионе "Восточная часть США", можно указать **SQL. EastUS** для тега службы.
- Тег представляет службу, но не определенные экземпляры службы. Например, тег представляет службу базы данных SQL Azure, но не представляет конкретную базу данных или сервер SQL.
- Все префиксы адресов, представленные этим тегом, имеют также тег **Internet**.

**Подробнее:**

- Ознакомьтесь со сведениями о[группах безопасности сети (группы безопасности сети)](https://docs.microsoft.com/azure/virtual-network/security-overview).
- Проверьте [теги службы, доступные для группы безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags).

## <a name="best-practice-use-application-security-groups"></a>Рекомендации: использование групп безопасности приложений

Группы безопасности приложений позволяют настроить сетевую безопасность как естественное расширение структуры приложения.

- Можно сгруппировать виртуальные машины и определить политики безопасности сети на основе групп безопасности приложений.
- Группы безопасности приложений позволяют повторно использовать политику безопасности в нужном масштабе без обслуживания явных IP-адресов вручную.
- Эти группы сами обрабатывают явные IP-адреса и множество наборов правил, позволяя вам сосредоточиться на бизнес-логике.

**Пример.**

![Пример группы безопасности приложений группы безопасности приложений ](./media/migrate-best-practices-networking/asg.png)
 _._

| Сетевой интерфейс | Группа безопасности приложений |
| --- | --- |
| `NIC1` | `AsgWeb` |
| `NIC2` | `AsgWeb` |
| `NIC3` | `AsgLogic` |
| `NIC4` | `AsgDb` |

- В нашем примере каждый сетевой интерфейс принадлежит только к одной группе безопасности приложений, но в реальной ситуации интерфейс может принадлежать к нескольким группам с учетом ограничений Azure.
- Группа NSG не связана с сетевыми интерфейсами. `NSG1`связан с обеими подсетями и содержит следующие правила.

| Имя правила | Назначение | Сведения |
| --- | --- | --- |
| `Allow-HTTP-Inbound-Internet` | Разрешение трафика из Интернета на веб-серверы. Входящий трафик из Интернета отклоняется `DenyAllInbound` правилом безопасности по умолчанию, поэтому для `AsgLogic` групп безопасности приложений не требуется дополнительное правило `AsgDb` . | Приоритеты`100`<br><br> Источник: `internet` <br><br> Исходный порт:`*` <br><br> Местоназначение`AsgWeb` <br><br> Конечный порт:`80` <br><br> См`TCP` <br><br> Имеет`Allow` |
| `Deny-Database-All` | `AllowVNetInBound`правило безопасности по умолчанию разрешает весь обмен данными между ресурсами в одной виртуальной сети. это правило требуется для запрета трафика от всех ресурсов. | Приоритеты`120` <br><br> Источник: `*` <br><br> Исходный порт:`*` <br><br> Местоназначение`AsgDb` <br><br> Конечный порт:`1433` <br><br> См`All` <br><br> Имеет`Deny` |
| `Allow-Database-BusinessLogic` | Разрешите передачу трафика из `AsgLogic` группы безопасности приложений в `AsgDb` группу безопасности приложений. Приоритет этого правила выше `Deny-Database-All` , чем правило, поэтому сначала обрабатывается это правило. Таким образом, трафик из `AsgLogic` группы безопасности приложений разрешается, и весь остальной трафик блокируется. | Приоритеты`110` <br><br> Источник: `AsgLogic` <br><br> Исходный порт:`*` <br><br> Местоназначение`AsgDb` <br><br> Конечный порт:`1433` <br><br> См`TCP` <br><br> Имеет`Allow` |

- Правила, определяющие группу безопасности приложений в качестве источника или назначения, применяются только к сетевым интерфейсам, которые входят в ее состав. Если сетевой интерфейс не является членом группы безопасности приложений, правило не применяется к нему, несмотря на то, что группа безопасности сети связана с подсетью.

**Подробнее:**

- Сведения о [группах безопасности приложений](https://docs.microsoft.com/azure/virtual-network/security-overview#application-security-groups).

### <a name="best-practice-secure-access-to-paas-using-vnet-service-endpoints"></a>Рекомендации: безопасный доступ к PaaS с помощью конечных точек службы виртуальной сети

Конечные точки службы виртуальной сети расширяют пространство частных адресов виртуальной сети и возможности идентификации в службах Azure через прямое подключение.

- Конечные точки позволяют защитить критически важные ресурсы служб Azure только в пределах виртуальных сетей. Трафик из виртуальной сети в службу Azure всегда остается в магистральной сети Azure.
- Частное адресное пространство виртуальной сети может перекрываться, поэтому его нельзя использовать для уникальной идентификации трафика, поступающего из виртуальной сети.
- Включив конечные точки служб в виртуальной сети, вы можете защитить в ней ресурсы служб Azure, добавив правило виртуальной сети для ресурсов служб. Это повысит уровень безопасности за счет полного блокирования открытого доступа к ресурсам из Интернета и разрешения трафика только из виртуальной сети.

![Конечные точки службы конечных точек службы ](./media/migrate-best-practices-networking/endpoint.png)
 _._

**Подробнее:**

- Сведения о [конечных точках службы виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview).

## <a name="best-practice-control-public-ip-addresses"></a>Рекомендации: Управление общедоступными IP-адресами

Общедоступные IP-адреса в Azure можно связать с виртуальными машинами, подсистемами балансировки нагрузки, шлюзами приложений и VPN-шлюзами.

- Общедоступные IP-адреса позволяют интернет-ресурсам устанавливать входящие подключения к ресурсам Azure, а ресурсам Azure — исходящие подключения к Интернету.
- Общедоступные IP-адреса создаются с номерами SKU "базовый" или "Стандартный", которые имеют несколько отличий. Номера SKU уровня "Стандартный" можно назначить любой службе, но зачастую они используются на виртуальных машинах, а также в подсистемах балансировки нагрузки и шлюзах приложений.
- Важно отметить, что для общедоступного IP-адреса этого уровня группа безопасности сети не настраивается автоматически. Ее необходимо настроить самостоятельно и назначить правила для управления доступом. Для IP-адресов номеров SKU уровня "Стандартный" по умолчанию устанавливается группа безопасности сети и назначаются правила.
- Для виртуальных машин не следует настраивать общедоступный IP-адрес.
  - Если требуется открыть порт, он должен быть предназначен только для веб-служб, например порт 80 или 443.
  - Стандартные порты удаленного управления, например SSH (22) и RDP (3389), следует запретить с помощью групп безопасности сети, наряду со всеми остальными портами.
- Рекомендуется размещать виртуальные машины за Azure Load Balancer или шлюзом приложений. Тогда при необходимости доступа к портам удаленного управления можно использовать JIT-доступ к виртуальной машине в Центре безопасности Azure.

**Подробнее:**

- [Общедоступные IP-адреса в Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm#public-ip-addresses)
- [Manage virtual machine access using Just-in-time](https://docs.microsoft.com/azure/security-center/security-center-just-in-time) (Управление доступом к виртуальным машинам с помощью JIT)

## <a name="take-advantage-of-azure-security-features-for-networking"></a>Использование преимуществ функций безопасности Azure при настройке сетей

Azure содержит функции безопасности платформы, которые просты в использовании и предоставляют широкие возможности, направленные против распространенных сетевых атак. К ним относятся брандмауэр Azure, брандмауэр веб-приложения и служба "Наблюдатель за сетями".

## <a name="best-practice-deploy-azure-firewall"></a>Рекомендации. развертывание брандмауэра Azure

Брандмауэр Azure — это управляемая облачная служба сетевой безопасности, которая защищает ресурсы виртуальной сети Azure. Это управляемый брандмауэр с полным отслеживанием состояния, встроенными средствами обеспечения высокой доступности и неограниченными возможностями облачного масштабирования.

![Брандмауэр Azure конечных точек службы ](./media/migrate-best-practices-networking/firewall.png)
 _._

- В Брандмауэре Azure можно централизованно создавать, применять и регистрировать политики приложений и сетевых подключений в подписках и виртуальных сетях.
- Брандмауэр Azure использует статический общедоступный IP-адрес для виртуальных сетевых ресурсов, позволяя внешним брандмауэрам идентифицировать трафик, исходящий из виртуальной сети.
- Брандмауэр Azure полностью интегрирован с Azure Monitor для ведения журналов и аналитики.
- При создании правила брандмауэра Azure рекомендуется использовать теги полных доменных имен (FQDN).
  - Тег FQDN — это группа полных доменных имен, связанных с известными службами Майкрософт.
  - С помощью тега FQDN можно разрешить нужный исходящий сетевой трафик через брандмауэр.
- Например, чтобы вручную разрешить сетевой трафик центра обновления Windows через брандмауэр, необходимо создать несколько правил приложения. Используя теги полного доменного имени, вы создаете правило приложения и включаете тег Windows Updates. При таком правиле сетевой трафик к конечным точкам центра обновления Microsoft Windows может проходить через брандмауэр.

**Подробнее:**

- Ознакомьтесь с [обзором брандмауэра Azure](https://docs.microsoft.com/azure/firewall/overview).
- Сведения о [тегах полного доменного имени в брандмауэре Azure](https://docs.microsoft.com/azure/firewall/fqdn-tags).

## <a name="best-practice-deploy-a-web-application-firewall-waf"></a>Рекомендации. развертывание брандмауэра веб-приложения (WAF)

Веб-приложения все чаще подвергаются вредоносным атакам, использующим общеизвестные уязвимости. Сюда входят, например, атаки путем внедрения кода SQL и межсайтовых сценариев. Предотвращение таких атак в коде приложения может быть сложной задачей, требующей постоянного обслуживания, установки исправлений и мониторинга на разных уровнях топологии приложения. Централизованный брандмауэр веб-приложения помогает значительно упростить управление безопасностью и помогает администраторам приложений защищаться от угроз и вторжений. Брандмауэр веб-приложений может быстрее реагировать на угрозы безопасности по сравнению со средствами защиты каждого отдельного веб-приложения благодаря установке исправлений известных уязвимостей в центральном расположении. Существующие шлюзы приложений можно легко преобразовать в шлюз приложений с поддержкой брандмауэра веб-приложения.

Брандмауэр веб-приложения (WAF) является компонентом шлюза приложений Azure.

- WAF предоставляет централизованную защиту веб-приложений от распространенных эксплойтов и уязвимостей.
- WAF обеспечивает защиту без внесения изменений в код серверной части.
- Он может защищать несколько веб-приложений одновременно за шлюзом приложений.
- WAF интегрируется с центром безопасности Azure.
- Вы можете настроить правила WAF и группы правил в соответствии с требованиями приложения.
- Рекомендуется использовать WAF в начале любого веб-приложения, включая приложения на виртуальных машинах Azure или в качестве службы приложений Azure.

**Подробнее:**

- Дополнительные сведения о [WAF](https://docs.microsoft.com/azure/application-gateway/waf-overview).
- Ознакомьтесь [с ограничениями WAF и исключениями](https://docs.microsoft.com/azure/application-gateway/application-gateway-waf-configuration).

## <a name="best-practice-implement-azure-network-watcher"></a>Рекомендация: реализация наблюдателя за сетями Azure

Служба Azure "Наблюдатель за сетями" предоставляет средства для наблюдения за ресурсами и обменом данными в виртуальной сети Azure. Например, можно отслеживать обмен данными между виртуальной машиной и конечной точкой, например другой виртуальной машиной или полным доменным именем, просматривать ресурсы и связи между ресурсами в виртуальной сети, а также диагностировать проблемы с сетевым трафиком.

![Наблюдатель за сетями наблюдателя за сетями ](./media/migrate-best-practices-networking/network-watcher.png)
 _._

- С помощью службы "Наблюдатель за сетями" можно отслеживать и диагностировать проблемы с сетью, не входя в виртуальные машины.
- Можно активировать сбор пакетов, устанавливая оповещения, и получать доступ к сведениям о производительности в реальном времени на уровне пакетов. Обнаруженную проблему можно затем проанализировать.
- Рекомендуется использовать Наблюдатель за сетями для просмотра журналов потоков NSG.
  - Журналы потоков для групп безопасности сети (NSG) в службе "Наблюдатель за сетями" позволяют просматривать сведения о входящем и исходящем IP-трафике через NSG.
  - Запись в журналы потоков ведется в формате JSON.
  - В журналах потоков отображаются исходящие и входящие потоки на основе каждого правила, сетевой интерфейс, к которому применяется поток, сведения о потоке на основе пяти кортежей (IP-адрес источника и назначения, порт источника и назначения, протокол) и состояние трафика (разрешен или отклонен).

**Подробнее:**

- Ознакомьтесь с [обзором наблюдателя за сетями](https://docs.microsoft.com/azure/network-watcher).
- Дополнительные сведения о [журналах потоков NSG](https://docs.microsoft.com/azure/network-watcher/network-watcher-nsg-flow-logging-overview).

## <a name="use-partner-tools-in-the-azure-marketplace"></a>Использование партнерских средств в Azure Marketplace.

Для более сложных сетевых топологий можно использовать продукты безопасности от партнеров Майкрософт, в том числе виртуальные сетевые устройства.

- Виртуальное сетевое устройство — это виртуальная машина, которая выполняет сетевые функции, такие как защита с использованием брандмауэра, оптимизация доступа к глобальной сети и др.
- Виртуальные сетевые устройства повышают безопасность и расширяют функции виртуальных сетей. Их можно развертывать для реализации брандмауэров с высоким уровнем доступности, средств предотвращения и обнаружения вторжений, брандмауэров веб-приложения (WAF), а также для оптимизации доступа к глобальной сети, маршрутизации, балансировки нагрузки, установления VPN-подключений, управления сертификатами, применения Active Directory и многофакторной идентификации.
- NVA доступен из множества поставщиков в [Azure Marketplace](https://azuremarketplace.microsoft.com).

## <a name="best-practice-implement-firewalls-and-nvas-in-hub-networks"></a>Рекомендации. Реализация брандмауэров и NVA в Центральных сетях

В концентраторе сеть периметра (с доступом к Интернету) обычно управляется через брандмауэр Azure, ферму брандмауэра или брандмауэр веб-приложения (WAF). Рассмотрим следующие сравнения.

| Тип брандмауэра | Сведения |
| --- | --- |
| Брандмауэры веб-приложений (WAF) | Веб-приложения используются повсеместно, они склонны содержать уязвимости, открытые для потенциальных эксплойтов. <br><br> Брандмауэры веб-приложений предназначены для выявления атак на веб-приложения (HTTP/HTTPS) с большей точностью, чем позволяет универсальный брандмауэр. <br><br> По сравнению с традиционными брандмауэрами, WAF содержат набор специальных функций для защиты внутренних веб-серверов от угроз. |
| Брандмауэр Azure | Подобно фермам брандмауэров виртуальных сетевых устройств (NVA), в брандмауэре Azure применяется общий механизм администрирования и набор правил безопасности для защиты рабочих нагрузок, размещенных в периферийных сетях, а также для управления доступом к локальным сетям. <br><br> В Брандмауэре Azure встроены возможности масштабирования. |
| Брандмауэры виртуальных сетевых устройств (NVA) | Подобно брандмауэру Azure, в фермах брандмауэров виртуальных сетевых устройств (NVA) применяется общий механизм администрирования и набор правил безопасности для защиты рабочих нагрузок, размещенных в периферийных зонах, а также для управления доступом к локальным сетям. <br><br> Брандмауэры NVA можно вручную масштабировать за подсистемой балансировки нагрузки. <br><br> Хотя программное обеспечение брандмауэра NVA менее специализировано по сравнению с WAF, оно позволяет отфильтровывать больше приложений и проверять любой тип входящего и исходящего трафика. <br><br> Если вам нужно использовать виртуальные сетевые устройства, их можно найти в Azure Marketplace. |

Мы рекомендуем использовать один набор брандмауэров Azure (или NVA) для трафика, поступающих через Интернет, а другой — для локального трафика.

- Использование только одного набора брандмауэров в обоих случаях представляет угрозу безопасности, так как между двумя наборами сетевого трафика отсутствует периметр безопасности.
- Использование отдельных уровней брандмауэра упрощает проверку правил безопасности, а также помогает понять, какие правила соответствуют определенным входящим сетевым запросам.

**Подробнее:**

- Узнайте [, как использовать NVA в виртуальной сети Azure](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/secure-vnet-dmz).

## <a name="next-steps"></a>Дальнейшие действия

Просмотрите другие рекомендации:

- [Рекомендации по обеспечению безопасности рабочих нагрузок, перенесенных в Azure, и управлению ими](./migrate-best-practices-security-management.md).
- [Рекомендации](./migrate-best-practices-costs.md) по управлению затратами после миграции.
