---
title: Рекомендации по настройке сетей для рабочих нагрузок, перенесенных в Azure
description: Используйте платформу внедрения облаков для Azure, чтобы получить рекомендации по настройке сети для перенесенных рабочих нагрузок.
author: BrianBlanchard
ms.author: brblanch
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
ms.custom: internal
ms.openlocfilehash: 5914004310b660d42e961fa57152f07ecdcfd073
ms.sourcegitcommit: c167c45b66cc7324b60c88b8b7aac439f956b65d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102209141"
---
<!-- cSpell:ignore NSGs CIDR FQDNs BGP's ACLs WAFs -->

# <a name="best-practices-to-set-up-networking-for-workloads-migrated-to-azure"></a>Рекомендации по настройке сетей для рабочих нагрузок, перенесенных в Azure

При планировании и разработке миграции, кроме самой миграции одним из наиболее важных этапов является проектирование и реализация сетей Azure. В этой статье приводятся рекомендации по работе с сетью при переходе на реализации инфраструктуры "инфраструктура как услуга" (IaaS) и "платформа как услуга" (PaaS) в Azure.

> [!IMPORTANT]
> Рекомендации и мнения, приведенные в этой статье, основаны на возможностях платформы Azure и служб, доступных на момент написания этого материала. Функции и возможности со временем меняются. Не все рекомендации могут быть применимы в вашем сценарии развертывания, поэтому выберите подходящие для вас.

## <a name="design-virtual-networks"></a>Проектирование виртуальных сетей

Azure предоставляет виртуальные сети с этими возможностями:

- Ресурсы Azure прямо обмениваются данными, напрямую и безопасно друг с другом в виртуальных сетях.
- Вы можете настроить подключения к конечной точке в виртуальных сетях для виртуальных машин и служб, которым требуется подключение к Интернету.
- Виртуальная сеть — это логическая изоляция облака Azure, предназначенного для вашей подписки.
- Вы можете реализовать несколько виртуальных сетей в пределах подписки и региона Azure.
- Все виртуальные сети изолированы друг от друга.
- Виртуальные сети могут содержать частные и общедоступные IP-адреса, определенные в [RFC 1918](https://tools.ietf.org/html/rfc1918), выраженные в нотации с междоменной маршрутизацией (CIDR). Общедоступные IP-адреса, указанные в адресном пространстве виртуальной сети, недоступны из Интернета напрямую.
- Виртуальные сети могут подключаться друг к другу с помощью пиринга виртуальной сети. Подключенные виртуальные сети могут находиться в одном регионе или в разных регионах. ресурсы в одной виртуальной сети могут подключаться к ресурсам в других виртуальных сетях.
- По умолчанию Azure маршрутизирует трафик между подсетями в виртуальной сети, подключенными виртуальными сетями, локальными сетями и Интернетом.

При планировании топологии виртуальной сети следует учитывать, как упорядочивать пространства IP-адресов, как реализовать топологию концентратора и периферийной сети, как сегментирование виртуальных сетей в подсети, настроить DNS и реализовать Зоны доступности Azure.

## <a name="best-practice-plan-ip-addressing"></a>Рекомендация: планирование IP-адресации

При создании виртуальных сетей в процессе миграции важно спланировать пространство IP-адресов виртуальной сети.

Необходимо назначить адресное пространство, которое не превышает диапазон CIDR `/16` для каждой виртуальной сети. Виртуальные сети позволяют использовать IP-адреса 65 536. Назначение меньшего префикса `/16` , такого как `/15` , который имеет 131 072 адресов, приведет к тому, что ЛИШНИЕ IP-адреса станут непригодными для использования в других местах. Важно не терять IP-адреса, даже если они находятся в частных диапазонах, определенных в RFC 1918.

Другие советы по планированию:

- Адресное пространство виртуальной сети не должно пересекаться с диапазонами локальных сетей.
- Перекрывающиеся адреса могут вызвать сети, которые не могут быть подключены, и маршрутизация, которая не работает должным образом.
- Если сети перекрываются, потребуется переконструировать сеть.
- Если совершенно невозможно перепроектирование сети, преобразование сетевых адресов (NAT) может помочь, но следует избегать или ограничиваться максимально возможным.

**Подробнее:**

- Ознакомьтесь с [обзором виртуальной сети Azure](/azure/virtual-network/virtual-networks-overview).
- Ознакомьтесь с [вопросами и ответами на виртуальную сеть Azure](/azure/virtual-network/virtual-networks-faq).
- Сведения об [ограничениях сети Azure](/azure/azure-resource-manager/management/azure-subscription-service-limits).

## <a name="best-practice-implement-a-hub-and-spoke-network-topology"></a>Рекомендации. Реализация топологии сети и звезды

Топология сети концентратора и звезды изолирует рабочие нагрузки при совместном использовании служб, таких как идентификация и безопасность. Центр — это виртуальная сеть Azure, которая выступает в качестве центральной точки подключения. Периферийные серверы — это виртуальные сети, которые подключаются к виртуальной сети концентратора с помощью пиринга. Общие службы развертываются в концентраторе, а отдельные рабочие нагрузки — в периферийных зонах.

Рассмотрим следующий пример.

- Реализация топологии "звезда" в Azure централизует общие службы, такие как подключения к локальным сетям, брандмауэры и изоляция между виртуальными сетями. Виртуальная сеть концентратора предоставляет центральную точку подключения к локальным сетям и место для размещения служб, используемых рабочими нагрузками, размещенными в периферийных виртуальных сетях.
- Звездообразная конфигурация зачастую применяется на крупных предприятиях. В меньших сетях можно организовать более простую и бюджетную топологию.
- Вы можете использовать периферийные виртуальные сети для изоляции рабочих нагрузок, каждый из которых управляется отдельно от других периферийных серверов. Каждая рабочая нагрузка может содержать несколько уровней с несколькими подсетями, подключенными через подсистемы балансировки нагрузки Azure.
- Вы можете реализовать центральные и периферийные виртуальные сети в разных группах ресурсов и даже в разных подписках. Если вы настраиваете пиринг виртуальных сетей в разных подписках, эти подписки могут быть связаны с одним и тем же или разными клиентами Azure Active Directory (Azure AD). Это позволяет осуществлять децентрализованное управление каждой рабочей нагрузкой при совместном использовании служб, поддерживаемых в центральной сети.

![Схема топологии концентратора и звезды ](./media/migrate-best-practices-networking/hub-spoke.png)
 *рис. 1. топология HUB и лучевой топологии.*

**Подробнее:**

- Ознакомьтесь с [топологией HUB и лучевой топологии](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke).
- Получите рекомендации по сети для запуска [виртуальных машин Windows](/azure/architecture/reference-architectures/n-tier/windows-vm) и [виртуальных машин Linux](/azure/architecture/reference-architectures/n-tier/linux-vm) в Azure.
- Узнайте о [пиринга виртуальных сетей](/azure/virtual-network/virtual-network-peering-overview).

## <a name="best-practice-design-subnets"></a>Рекомендации: проектирование подсетей

Чтобы обеспечить изоляцию в виртуальной сети, разделите ее на одну или несколько подсетей и выделите часть адресного пространства виртуальной сети для каждой подсети.

- Каждая виртуальная сеть может иметь несколько подсетей.
- По умолчанию Azure маршрутизирует сетевой трафик между всеми подсетями в виртуальной сети.
- Решения о подсетях должны основываться на технических и организационных требованиях, выдвигаемых вашим сценарием.
- Подсети создаются с помощью нотации CIDR.

При выборе диапазона сетей для подсетей необходимо учитывать, что Azure содержит пять IP-адресов из каждой подсети, которую нельзя использовать. Например, если вы создадите наименьшую доступную подсеть `/29` (с восемью IP-адресами), в Azure будет храниться пять адресов. В этом случае у вас есть только три возможных адреса, которые могут быть назначены узлам в подсети. В большинстве случаев используйте `/28` в качестве наименьшей подсети.

**Пример**.

В таблице показан пример виртуальной сети с адресным пространством `10.245.16.0/20` сегментированного на подсети для плановой миграции.

| Подсеть | CIDR | Адреса | Использование |
| --- | --- | --- | --- |
| `DEV-FE-EUS2` | `10.245.16.0/22` | 1019 | Виртуальные машины внешнего интерфейса или веб-уровня |
| `DEV-APP-EUS2` | `10.245.20.0/22` | 1019 | Виртуальные машины уровня приложений |
| `DEV-DB-EUS2` | `10.245.24.0/23` | 507 | Виртуальные машины баз данных |

**Подробнее:**

- Сведения о [проектировании подсетей](/azure/virtual-network/virtual-network-vnet-plan-design-arm#segmentation).
- Узнайте, как компания Contoso, вымышленная компания, [подготовила свою сетевую инфраструктуру к миграции](../../migrate/index.md).

## <a name="best-practice-set-up-a-dns-server"></a>Рекомендации. Настройка DNS-сервера

По умолчанию Azure добавляет DNS-сервер при развертывании виртуальной сети. Это позволяет быстро создавать виртуальные сети и развертывать ресурсы. Но этот DNS-сервер предоставляет только службы для ресурсов в этой виртуальной сети. Если вы хотите подключить несколько виртуальных сетей или подключиться к локальному серверу из виртуальных сетей, вам потребуются дополнительные возможности разрешения имен. Например, может потребоваться настроить в Active Directory разрешение DNS-имен между виртуальными сетями. Чтобы сделать это, следует развернуть собственный пользовательский DNS-сервер в Azure.

- DNS-серверы в виртуальной сети могут перенаправлять запросы DNS в рекурсивные арбитры конфликтов в Azure. Это обеспечивает разрешение имен узлов в этой виртуальной сети. Например, контроллер домена, работающий в Azure, может отвечать на запросы DNS для собственных доменов и перенаправлять все остальные запросы в Azure.
- Перенаправление DNS позволяет виртуальным машинам видеть имена локальных ресурсов (с помощью контроллера домена) и узлов, предоставленные Azure (с помощью сервера перенаправления). Вы можете получить доступ к рекурсивным арбитрам конфликтов в Azure с помощью виртуального IP-адреса `168.63.129.16` .
- Пересылка DNS также обеспечивает разрешение DNS между виртуальными сетями и позволяет локальным компьютерам разрешать имена узлов, предоставляемые Azure.
  - Чтобы разрешить имя узла виртуальной машины, виртуальная машина DNS-сервера должна находиться в той же виртуальной сети и быть настроена для пересылки запросов имен узлов в Azure.
  - Так как DNS-суффиксы в разных виртуальных сетях различаются, можно использовать правила условного перенаправления для отправки запросов DNS в правильную виртуальную сеть для разрешения.
- При использовании собственных DNS-серверов можно указать несколько DNS-серверов для каждой виртуальной сети. Можно также указать несколько DNS-серверов для каждого сетевого интерфейса (для Azure Resource Manager) или каждой облачной службы (для классической модели развертывания).
- DNS-серверы, указанные для сетевого интерфейса или облачной службы, имеют приоритет над DNS-серверами, указанными для виртуальной сети.
- В Azure Resource Manager можно указать DNS-серверы для виртуальной сети и сетевого интерфейса, но рекомендуется использовать параметр только в виртуальных сетях.

    ![Снимок экрана DNS-серверов для виртуальной сети.](./media/migrate-best-practices-networking/dns2.png)
    *Рис. 2. DNS-серверы для виртуальной сети.*

**Подробнее:**

- Сведения о [разрешении имен при использовании собственного DNS-сервера](../../migrate/index.md).
- Сведения о [правилах именования DNS и ограничениях](../../ready/azure-best-practices/naming-and-tagging.md).

## <a name="best-practice-set-up-availability-zones"></a>Рекомендации: Настройка Зоны доступности

Зоны доступности повысить уровень доступности, чтобы защитить приложения и данные от сбоев центров обработки данных. Зоны доступности — уникальные физические расположения в пределах одного региона Azure. Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Чтобы обеспечить устойчивость, во всех включенных областях используются минимум три отдельные зоны. Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных.

Ниже приведены некоторые дополнительные моменты, о которых следует помнить при настройке Зоны доступности.

- Службы, избыточные в пределах зоны, реплицируют приложения и данные на Зоны доступности для защиты от отдельных точек отказа.

- С Зоны доступности Azure предлагает соглашение об уровне обслуживания на 99,99% для времени работы виртуальной машины.

    ![Схема Зоны доступности в регионе Azure.](./media/migrate-best-practices-networking/availability-zone.png)

    *Рис. 3. Зоны доступности.*

- Можно запланировать и внедрить высокий уровень доступности в архитектуру миграции за счет совместного размещения вычислительных ресурсов, ресурсов хранилища, сети и данных в пределах зоны, а также за счет репликации в другие зоны. Службы Azure с поддержкой зон доступности делятся на две категории.
  - **Зональные Services:** Вы связываете ресурс с определенной зоной, например виртуальными машинами, управляемыми дисками или IP-адресами.
  - **Службы, избыточные в зонах:** Ресурс автоматически реплицируется по зонам, таким как хранилище, избыточное в пределах зоны, или база данных SQL Azure.
- Чтобы обеспечить отказоустойчивость зональные, можно развернуть стандартный экземпляр Azure Load Balancer с рабочими нагрузками с выходом в Интернет или уровнями приложений.

    ![Схема стандартной подсистемы балансировки нагрузки Azure ](./media/migrate-best-practices-networking/load-balancer.png) *рис. 4. Подсистема балансировки нагрузки.*

**Подробнее:**

- Ознакомьтесь с [обзором зоны доступности](/azure/availability-zones/az-overview).

## <a name="design-hybrid-cloud-networking"></a>Проектирование гибридных облачных сетей

Для успешной миграции очень важно подключить локальные корпоративные сети к Azure. При этом создается постоянное подключение, называемое гибридной облачной сетью, в рамках которого службы предоставляются из облака Azure корпоративным пользователям. Существует два варианта создания сети такого типа:

- **VPN типа "сеть — сеть":** Вы устанавливаете VPN-подключение типа "сеть — сеть" между совместимым локальным VPN-устройством и VPN-шлюзом Azure, развернутым в виртуальной сети. Любой Полномочный локальный ресурс может получить доступ к виртуальным сетям. Обмен данными между сайтами отправляется через зашифрованный туннель через Интернет.
- **Azure ExpressRoute:** Вы устанавливаете подключение Azure ExpressRoute между локальной сетью и Azure через партнера ExpressRoute. Это подключение является частным, и трафик не проходит через Интернет.

**Подробнее:**

- Дополнительные сведения о [гибридных облачных сетях](/azure/architecture/reference-architectures/hybrid-networking/vpn).

## <a name="best-practice-implement-a-highly-available-site-to-site-vpn"></a>Рекомендации. Реализация высокодоступного VPN типа "сеть — сеть"

Чтобы реализовать VPN-подключение типа "сеть — сеть", Настройте VPN-шлюз в Azure.

- VPN-шлюз — это особый тип шлюза виртуальной сети. Он отправляет зашифрованный трафик между виртуальной сетью Azure и локальным расположением через общедоступный Интернет.
- VPN-шлюз также может передавать зашифрованный трафик между виртуальными сетями в Azure по сети Microsoft.
- Каждая виртуальная сеть может иметь только один VPN-шлюз.
- К одному VPN-шлюзу можно создать несколько подключений. При создании нескольких подключений все VPN-туннели совместно используют доступную пропускную способность шлюза.

Каждый VPN-шлюз Azure состоит из двух экземпляров в конфигурации "активный-резервный":

- При плановом обслуживании или незапланированном сбое активного экземпляра происходит отработка отказа, и резервный экземпляр переключается автоматически. Этот экземпляр возобновляет подключение "сеть — сеть" или "связь между сетями".
- Переключение сопровождается кратким перебоем в работе.
- При плановом обслуживании подключение должно быть восстановлено в течение 10–15 секунд.
- Для незапланированных проблем восстановление подключения занимает больше времени, до 1,5 минут в худшем случае.
- Подключения VPN-клиентов типа "точка — сеть" к шлюзу отключены, и пользователям необходимо повторно подключиться с клиентских компьютеров.

При настройке VPN типа "сеть — сеть":

- Вам потребуется виртуальная сеть, диапазон адресов которой не пересекается с локальной сетью, к которой будет подключаться VPN.
- Создайте подсеть шлюза в сети.
- Вы создаете VPN-шлюз, указываете тип шлюза (VPN), а также шлюз, основанный на политиках или маршрутах. VPN на основе маршрутов считается более производительной и будущей.
- В локальной среде создайте шлюз локальной сети и настройте локальное VPN-устройство.
- Вы создаете отказоустойчивое VPN-подключение типа "сеть — сеть" между шлюзом виртуальной сети и локальным устройством. Использование VPN на основе маршрутов позволяет создавать подключения к Azure как в режиме "активный — пассивный", так и в режиме "активный — активный". Параметр на основе маршрута также поддерживает подключения типа "сеть — сеть" (с любого компьютера) и "точка — сеть" (с одного компьютера) одновременно.
- Укажите требуемый номер SKU шлюза. Это зависит от требований к рабочей нагрузке, пропускной способности, функций и соглашений об уровне обслуживания.
- Протокол BGP (BGP) является необязательным компонентом. Его можно использовать с Azure ExpressRoute и VPN-шлюзами на основе маршрутов для распространения локальных маршрутов BGP в виртуальные сети.

![Схема VPN-подключения типа "сеть — сеть". ](./media/migrate-best-practices-networking/vpn.png)
 *Рис. 5. VPN-подключение типа "сеть — сеть".*

**Подробнее:**

- Ознакомьтесь [с совместимыми локальными VPN-устройствами](/azure/vpn-gateway/vpn-gateway-about-vpn-devices).
- Ознакомьтесь с [обзором VPN-шлюзов Azure](/azure/vpn-gateway/vpn-gateway-about-vpngateways).
- Узнайте о [высокодоступных VPN-подключениях](/azure/vpn-gateway/vpn-gateway-highlyavailable).
- Узнайте о [планировании и проектировании VPN-шлюза](/azure/vpn-gateway/vpn-gateway-about-vpngateways).
- Проверьте [параметры VPN-шлюза](/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku).
- Проверьте [номера SKU шлюзов](/azure/vpn-gateway/vpn-gateway-about-vpngateways#gwsku).
- Сведения о [настройке BGP с VPN-шлюзами Azure](/azure/vpn-gateway/vpn-gateway-bgp-overview).

### <a name="best-practice-configure-a-gateway-for-vpn-gateways"></a>Рекомендации. Настройка шлюза для VPN-шлюзов

При создании VPN-шлюза в Azure необходимо использовать специальную подсеть с именем `GatewaySubnet` . При создании этой подсети Обратите внимание на следующие рекомендации.

- `GatewaySubnet` может иметь максимальную длину префикса 29 (например, `10.119.255.248/29` ). Текущая рекомендация заключается в том, что используется длина префикса 27 (например, `10.119.255.224/27` ).
- При определении адресного пространства подсети шлюза используйте самую последнюю часть адресного пространства виртуальной сети.
- Если вы используете подсеть шлюза Azure, не развертывайте в подсети шлюза виртуальные машины или другие устройства, например шлюз приложений Azure.
- Не назначайте группу безопасности сети в эту подсеть. Это приведет к прекращению работы шлюза.

## <a name="best-practice-implement-azure-virtual-wan-for-branch-offices"></a>Рекомендации. Реализация виртуальной глобальной сети Azure для филиалов

Для нескольких VPN-подключений Виртуальная глобальная сеть Azure — это сетевая служба, которая обеспечивает оптимизированное и автоматизированное подключение между ветвями и филиалами через Azure.

- Виртуальная глобальная сеть позволяет подключать и настраивать устройства филиала для взаимодействия с Azure. Это можно сделать вручную или с помощью предпочтительных устройств поставщика через виртуальный WAN-партнер Azure.
- Использование предпочтительных устройств провайдеров упрощает использование и подключение, а также управление конфигурацией.
- Встроенная панель мониторинга виртуальной глобальной сети Azure обеспечивает возможность мгновенного устранения неполадок, позволяющих экономить время, а также предоставляет простой способ отслеживания крупномасштабных подключений типа "сеть — сеть".

**Дополнительные сведения:** Дополнительные сведения о [виртуальной глобальной сети Azure](/azure/virtual-wan/virtual-wan-about).

### <a name="best-practice-implement-expressroute-for-mission-critical-connections"></a>Рекомендации. Реализация ExpressRoute для критически важных соединений

Служба Azure ExpressRoute расширяет локальную инфраструктуру в Microsoft Cloud, создавая частные подключения между виртуальным центром обработки данных Azure и локальными сетями. Ниже приведены некоторые сведения о реализации.

- Подключения ExpressRoute можно устанавливать между любыми сетями (IP VPN), в сети Ethernet "точка — точка" или через поставщика услуг подключения. Обмен данными не выполняется через общедоступный сегмент Интернета.
- Подключения ExpressRoute обеспечивают повышенный уровень безопасности, надежности и быстродействия (до 10 Гбит/с) с прогнозируемой задержкой.
- ExpressRoute подходит для виртуальных центров обработки данных, так как клиенты могут использовать правила соответствия, связанные с частными подключениями.
- С помощью ExpressRoute Direct можно подключаться непосредственно к маршрутизаторам Майкрософт через 100 Гбит/с для большей пропускной способности.
- В ExpressRoute используется протокол BGP для обмена маршрутами между локальными сетями, экземплярами Azure и общедоступными адресами Майкрософт.

Развертывание подключений ExpressRoute обычно требует участия поставщика услуг ExpressRoute. Для быстрого запуска обычно используется VPN-подключение типа "сеть — сеть" для установления подключения между виртуальным центром обработки данных и локальными ресурсами. Затем выполняется миграция на подключение ExpressRoute при установлении физического подключения к поставщику услуг.

**Подробнее:**

- Ознакомьтесь с [обзором](/azure/expressroute/expressroute-introduction) ExpressRoute.
- Дополнительные сведения о программе [ExpressRoute Direct](/azure/expressroute/expressroute-erdirect-about).

### <a name="best-practice-optimize-expressroute-routing-with-bgp-communities"></a>Рекомендации. Оптимизация маршрутизации ExpressRoute с помощью сообществ BGP

При наличии нескольких каналов ExpressRoute к сети Майкрософт можно подключиться по нескольким маршрутам. В результате маршрутизация может быть неоптимальной, то есть трафик, передаваемый из вашей сети в сеть Майкрософт и наоборот, будет проходить по более длинному маршруту. А это, в свою очередь, может стать причиной возникновения длительной задержки, Задержка непосредственно влияет на производительность приложения и взаимодействие с пользователем.

**Пример**.

Давайте рассмотрим пример.

- У вас есть два офиса в США: один в Лос-Анджелес и один в городе Нью-Йорк.
- Эти офисы подключены к глобальной сети: к вашей собственной магистральной или предоставленной поставщиком IP VPN.
- У вас есть две цепи ExpressRoute: один в `West US` и один в `East US` , которые также подключены к глобальной сети. Очевидно, что подключение к сети Майкрософт можно установить по двум каналам.

**Проблема.**

Теперь представьте, что у вас есть развертывание Azure (например, служба приложений Azure) как в `West US` , так и в `East US` .

- Пользователям в каждом офисе требуется получить доступ к ближайшим службам Azure для оптимальной работы.
- Поэтому вы хотите подключить пользователей из Лос-Анджелес к Azure `West US` и пользователей в Нью-Йорке в Azure `East US` .
- Это работает для пользователей восточной части США, но не для тех, кто находится в регионе Дальневосточный. Проблема заключается в следующем.
  - В каждом канале ExpressRoute мы объявляем оба префикса в Azure: `East US` ( `23.100.0.0/16` ) и Azure `West US` ( `13.100.0.0/16` ).
  - Без сведений о том, какой префикс принадлежит какому региону, префиксы не будут обрабатываться по-разному.
  - В глобальной сети можно предположить, что оба префикса ближе к `East US` `West US` , и, таким же, перенаправляют пользователей из обоих офисов в канал ExpressRoute в `East US` . Это обеспечивает более серьезную работу пользователей в Лос-Анджелес офисе.

![Схема VPN с путем маршрута через неправильную цепь. ](./media/migrate-best-practices-networking/bgp1.png)
 *Рис. 6. сообщества BGP неоптимизированное подключение.*

**Решение:**

Чтобы оптимизировать маршрутизацию для обоих офисов, необходимо знать, какой префикс относится к Azure, `West US` а какой — из Azure `East US` . Эти сведения можно закодировать с помощью значений сообществ BGP.

- Каждому региону Azure назначается уникальное значение сообщества BGP. Например, 12076:51004 для `East US` ; 12076:51006 для `West US` .
- Теперь, когда очевидно, какой префикс относится к какому региону Azure, можно настроить предпочтительный канал ExpressRoute.
- Так как для обмена данными маршрутизации используется протокол BGP, маршрутизацией можно управлять, используя значения локального предпочтения BGP.
- В нашем примере вы назначаете более высокое значение локального предпочтения `13.100.0.0/16` в, `West US` чем в `East US` . Аналогичным образом можно назначить более высокое значение локального предпочтения `23.100.0.0/16` в, `East US` чем в `West US` .
- Эта конфигурация гарантирует, что если оба пути к Microsoft доступны, пользователи в Лос-Анджелес подключаются к `West US` региону с помощью зоны «Западная сеть», а пользователи в Нью-Йорке подключаются к `East US` региону с помощью канала восточной сети.

![Схема VPN с путем маршрута через правильную цепь. ](./media/migrate-best-practices-networking/bgp2.png)
 *Рис. 7. оптимизированное подключение сообществ BGP.*

**Подробнее:**

- Узнайте, как [оптимизировать маршрутизацию](/azure/expressroute/expressroute-optimize-routing).

## <a name="secure-virtual-networks"></a>Защита виртуальных сетей Azure

Ответственность за защиту виртуальных сетей предоставляется корпорацией Майкрософт и вами. Корпорация Майкрософт предоставляет множество сетевых компонентов, а также службы, которые помогают поддерживать безопасность ресурсов. При проектировании безопасности для виртуальных сетей лучше реализовать сеть периметра, использовать фильтрацию и группы безопасности, безопасный доступ к ресурсам и IP-адресам, а также реализовать защиту от атак.

**Подробнее:**

- Ознакомьтесь с [обзором рекомендаций по безопасности сети](/azure/security/fundamentals/network-best-practices).
- Научитесь [создавать защищенные сети](/azure/virtual-network/virtual-network-vnet-plan-design-arm#security).

<!-- docutune:casing "IDS/IPS" -->

## <a name="best-practice-implement-an-azure-perimeter-network"></a>Рекомендации. Реализация сети периметра Azure

Хотя корпорация Майкрософт вкладывает большие средства в защиту облачной инфраструктуры, вам тоже необходимо принимать меры для защиты облачных служб и групп ресурсов. Лучшим подходом к обеспечению безопасности является многоуровневый подход к безопасности. Важной частью этой стратегии защиты является реализация сети периметра.

- Сеть периметра защищает внутренние сетевые ресурсы от ненадежных сетей.
- Это самый внешний слой, который доступен из Интернета. Он обычно располагается между Интернетом и инфраструктурой предприятия, обычно с использованием некоторой защиты с обеих сторон.
- В обычной корпоративной сетевой топологии базовая инфраструктура хорошо защищена по всему периметру несколькими уровнями устройств безопасности. Граница каждого уровня состоит из устройств и точек реализации политики.
- Каждый уровень может включать в себя сочетание решений безопасности сети, таких как брандмауэры, предотвращение отказа в обслуживании (DoS), обнаружение вторжений и системы защиты от вторжений (ИДЕНТИФИКАТОРы и IP-адреса) и VPN-устройства.
- Реализация политики в сети периметра может предусматривать использование политик брандмауэра, списков управления доступом или правил маршрутизации.
- Поскольку входящий трафик поступает из Интернета, он перехватывается и обрабатывается сочетанием решений защиты. Решения блокируют атаки и опасный трафик, предоставляя допустимые запросы в сети.
- Входящий трафик может направляться непосредственно к ресурсам в сети периметра. Ресурс сети периметра затем может обмениваться данными с другими ресурсами, размещенными дальше в сети, перенаправляя трафик в сеть после проверки.

Ниже приведен пример отдельной сети периметра подсети в корпоративной сети с двумя границами безопасности.

![Схема развертывания сети периметра виртуальной сети Azure. ](./media/migrate-best-practices-networking/perimeter.png)
 *Рис. 8. Развертывание сети периметра.*

**Подробнее:**

- Узнайте, как [развернуть сеть периметра между Azure и локальным центром обработки данных](/azure/architecture/reference-architectures/dmz/secure-vnet-dmz).

## <a name="best-practice-filter-virtual-network-traffic-with-nsgs"></a>Рекомендации. Фильтрация трафика виртуальной сети с помощью группы безопасности сети

Группы безопасности сети (группы безопасности сети) содержат несколько правил безопасности для входящего и исходящего трафика, которые фильтруют трафик, который передается в ресурсы и из него. Фильтрацию можно осуществлять по исходному и конечному IP-адресам, порту и протоколу.

- В группах NSG содержатся правила безопасности, которые разрешают или запрещают исходящий и входящий сетевой трафик нескольких типов ресурсов Azure. Для каждого правила можно указать источник и назначение, порт и протокол.
- Правила NSG оцениваются по приоритету с использованием информации из пяти кортежей (источник, порт источника, назначение, порт назначения и протокол), чтобы разрешить или запретить трафик.
- Запись потока создается для имеющихся подключений. Обмен данными разрешен или запрещен в зависимости от состояния подключения записи потока.
- Запись потока позволяет NSG отслеживать состояние. Например, если задать правило безопасности для исходящего трафика по любому адресу через порт 80, устанавливать правило безопасности входящего трафика в ответ на исходящий трафик не требуется. Если связь инициируется извне, достаточно задать правило безопасности для входящего трафика.
- Обратное также верно. Если через порт разрешено поступление входящего трафика, задавать правило безопасности исходящего трафика в ответ на трафик через этот порт не требуется.
- Существующие подключения не прерываются при отключении правила безопасности, разрешающего этот поток. Поток трафика прерывается, когда подключения разрываются, то есть в течение нескольких минут трафик не передается в обоих направлениях.
- При создании группы безопасности сети создайте как можно меньшее количество, но столько, сколько необходимо.

### <a name="best-practice-secure-northsouth-and-eastwest-traffic"></a>Рекомендации: защита трафика с Севером/Юго-Восток и налево/Западная

Для защиты виртуальных сетей рассмотрите возможность направления атак. Обратите внимание на следующие моменты.

- Использование NSG только в подсетях упрощает среду, но защищает только трафик, поступающий в подсеть. Это называется трафиком "север — юг".
- Трафик между виртуальными машинами в одной и той же подсети называется трафиком "восток — запад".
- Важно использовать обе формы защиты, поэтому, если злоумышленник получает доступ извне, они будут остановлены при попытке атаковать компьютеры, находящиеся в той же подсети.

### <a name="use-service-tags-on-nsgs"></a>Использование тегов служб в NSG

Тег службы представляет группу префиксов IP-адресов. Использование тега службы упрощает создание правил NSG.

- Теги служб можно использовать вместо определенных IP-адресов при создании правил.
- Корпорация Майкрософт управляет префиксами адресов, связанными с тем или иным тегом службы, и автоматически обновляет этот тег при изменении адресов.
- Нельзя создать собственный тег службы или задать IP-адреса, которые будут входить в тег.

Теги служб позволяют избежать назначения правила группам служб Azure вручную. Например, если нужно разрешить подсети, содержащей веб-серверы, получать доступ к базе данных SQL Azure, можно создать правило исходящего трафика для порта 1433 и использовать тег службы **SQL** .

- Тег **Sql** определяет префиксы адресов для служб Базы данных SQL Azure и Хранилища данных SQL Azure.
- Если в качестве значения задано значение **SQL** , трафик разрешается или отклоняется для SQL.
- Чтобы разрешить доступ к **Sql** только в определенном регионе, можно указать этот регион. Например, если требуется разрешить доступ только к базе данных SQL Azure в регионе "Восточная часть США", можно указать **SQL. EastUS** для тега службы.
- Тег представляет службу, но не определенные экземпляры службы. Например, тег представляет службу базы данных SQL Azure, но не представляет конкретную базу данных или сервер SQL.
- Все префиксы адресов, представленные этим тегом, имеют также тег **Internet**.

**Подробнее:**

- Ознакомьтесь со сведениями о [группах безопасности сети (группы безопасности сети)](/azure/virtual-network/network-security-groups-overview).
- Проверьте [теги службы, доступные для группы безопасности сети](/azure/virtual-network/network-security-groups-overview#service-tags).

## <a name="best-practice-use-application-security-groups"></a>Рекомендации: использование групп безопасности приложений

Группы безопасности приложений позволяют настроить сетевую безопасность как естественное расширение структуры приложения.

- Можно сгруппировать виртуальные машины и определить политики безопасности сети на основе групп безопасности приложений.
- Группы безопасности приложений позволяют повторно использовать политику безопасности в нужном масштабе без ручного обслуживания явных IP-адресов.
- Эти группы сами обрабатывают явные IP-адреса и множество наборов правил, позволяя вам сосредоточиться на бизнес-логике.

**Пример**.

![Схема примера группы безопасности приложения. ](./media/migrate-best-practices-networking/asg.png)
 *Рис. 9. пример группы безопасности приложения.*

| Сетевой интерфейс | Группа безопасности приложений |
| --- | --- |
| `NIC1` | `AsgWeb` |
| `NIC2` | `AsgWeb` |
| `NIC3` | `AsgLogic` |
| `NIC4` | `AsgDb` |

В нашем примере каждый сетевой интерфейс принадлежит только к одной группе безопасности приложений, но в реальной ситуации интерфейс может принадлежать к нескольким группам с учетом ограничений Azure. Группа NSG не связана с сетевыми интерфейсами. `NSG1` связан с обеими подсетями и содержит следующие правила.

| Имя правила | Назначение | Подробнее |
| --- | --- | --- |
| `Allow-HTTP-Inbound-Internet` | Разрешение трафика из Интернета на веб-серверы. Входящий трафик из Интернета отклоняется `DenyAllInbound` правилом безопасности по умолчанию, поэтому для `AsgLogic` групп безопасности приложений не требуется дополнительное правило `AsgDb` . | Приоритет: `100`<br><br> Источник: `internet` <br><br> Исходный порт: `*` <br><br> Местоназначение `AsgWeb` <br><br> Конечный порт: `80` <br><br> См `TCP` <br><br> Имеет `Allow` |
| `Deny-Database-All` | `AllowVNetInBound` правило безопасности по умолчанию разрешает весь обмен данными между ресурсами в одной виртуальной сети. Это правило требуется для запрета трафика от всех ресурсов. | Приоритет: `120` <br><br> Источник: `*` <br><br> Исходный порт: `*` <br><br> Местоназначение `AsgDb` <br><br> Конечный порт: `1433` <br><br> См `All` <br><br> Имеет `Deny` |
| `Allow-Database-BusinessLogic` | Разрешите передачу трафика из `AsgLogic` группы безопасности приложений в `AsgDb` группу безопасности приложений. Приоритет этого правила выше `Deny-Database-All` , чем правило, поэтому сначала обрабатывается это правило. Таким образом, трафик из `AsgLogic` группы безопасности приложений разрешается, и весь остальной трафик блокируется. | Приоритет: `110` <br><br> Источник: `AsgLogic` <br><br> Исходный порт: `*` <br><br> Местоназначение `AsgDb` <br><br> Конечный порт: `1433` <br><br> См `TCP` <br><br> Имеет `Allow` |

Правила, определяющие группу безопасности приложений в качестве источника или назначения, применяются только к сетевым интерфейсам, которые входят в ее состав. Если сетевой интерфейс не является членом группы безопасности приложений, правило не применяется к сетевому интерфейсу, даже если группа безопасности сети связана с подсетью.

**Подробнее:**

- Сведения о [группах безопасности приложений](/azure/virtual-network/network-security-groups-overview#application-security-groups).

### <a name="best-practice-secure-access-to-paas-by-using-virtual-network-service-endpoints"></a>Рекомендации. Защита доступа к PaaS с помощью конечных точек службы виртуальной сети

Конечные точки службы виртуальной сети расширяют пространство частных адресов виртуальной сети и удостоверения служб Azure через прямое подключение.

- Конечные точки позволяют защищать важные ресурсы службы Azure только для виртуальных сетей. Трафик из виртуальной сети в службу Azure всегда остается в магистральной сети Azure.
- Закрытое адресное пространство виртуальной сети можно перекрывать, поэтому его нельзя использовать для уникальной идентификации трафика, поступающих из виртуальной сети.
- После включения конечных точек службы в виртуальной сети можно защитить ресурсы службы Azure, добавив правило виртуальной сети в ресурсы службы. Это обеспечивает повышенную безопасность за счет полного удаления общедоступного доступа в Интернет к ресурсам и разрешения трафика только из виртуальной сети.

![Схема конечных точек службы. ](./media/migrate-best-practices-networking/endpoint.png)
 *Рис. 10. конечные точки службы.*

**Подробнее:**

- Сведения о [конечных точках службы виртуальной сети](/azure/virtual-network/virtual-network-service-endpoints-overview).

## <a name="best-practice-control-public-ip-addresses"></a>Рекомендации: Управление общедоступными IP-адресами

Общедоступные IP-адреса в Azure можно связать с виртуальными машинами, подсистемами балансировки нагрузки, шлюзами приложений и VPN-шлюзами.

- Общедоступные IP-адреса позволяют интернет-ресурсам устанавливать входящие подключения к ресурсам Azure, а ресурсам Azure — исходящие подключения к Интернету.
- Общедоступные IP-адреса создаются с помощью SKU "базовый" или "Стандартный". Номера SKU категории "Стандартный" могут быть назначены любой службе, но обычно настраиваются на виртуальных машинах, подсистемах балансировки нагрузки и шлюзах приложений.
- В базовом общедоступном IP-адресе NSG не настроен автоматически. Необходимо настроить собственные и назначить правила для управления доступом. IP-адреса стандартного SKU имеют NSG и правила, назначенные по умолчанию.
- Для виртуальных машин не следует настраивать общедоступный IP-адрес.
  - Если требуется открыть порт, он должен быть только для веб-служб, таких как порт 80 или 443.
  - Для стандартных портов удаленного управления, таких как SSH (22) и RDP (3389), а также для всех остальных портов, следует задать значение Deny с помощью группы безопасности сети.
- Рекомендуется размещать виртуальные машины за Azure Load Balancer или шлюзом приложений Azure. Затем, если вам нужен доступ к портам удаленного управления, вы можете использовать JIT-доступ к виртуальной машине в центре безопасности Azure.

**Подробнее:**

- [Общедоступные IP-адреса в Azure](/azure/virtual-network/public-ip-addresses#public-ip-addresses)
- [Управление доступом к виртуальным машинам с помощью JIT](/azure/security-center/security-center-just-in-time)

## <a name="take-advantage-of-azure-security-features-for-networking"></a>Использование преимуществ функций безопасности Azure при настройке сетей

В Azure есть функции безопасности на уровне платформы, включая брандмауэр Azure, брандмауэр веб-приложения Azure (WAF) и наблюдатель за сетями Azure.

## <a name="best-practice-deploy-azure-firewall"></a>Рекомендации. развертывание брандмауэра Azure

Брандмауэр Azure — это управляемая облачная служба безопасности сети, которая помогает защищать ресурсы виртуальной сети. Это полностью управляемый брандмауэр с отслеживанием состояния, который имеет встроенную высокую доступность и масштабируемость в облаке.

![Схема брандмауэра Azure. ](./media/migrate-best-practices-networking/firewall.png)
 *Рис. 11. брандмауэр Azure.*

Ниже приведены несколько моментов, которые следует учитывать при развертывании службы.

- Брандмауэр Azure может централизованно создавать, применять и регистрировать политики приложений и сетевых подключений в подписках и виртуальных сетях.
- Брандмауэр Azure использует статический, общедоступный IP-адрес для ресурсов виртуальной сети. Это позволяет внешним брандмауэрам обнаруживать трафик, исходящий из виртуальной сети.
- Брандмауэр Azure полностью интегрирован с Azure Monitor для ведения журналов и аналитики.
- При создании правил брандмауэра Azure лучше использовать теги полного доменного имени.
  - Тег FQDN — это группа полных доменных имен, связанных с известными службами Майкрософт.
  - С помощью тега FQDN можно разрешить нужный исходящий сетевой трафик через брандмауэр.
- Например, чтобы вручную разрешить сетевой трафик для Центра обновления Windows через брандмауэр, нужно создать несколько правил приложений. Используя теги полного доменного имени, вы создаете правило приложения и включаете тег Центр обновления Windows. При установке этого правила сетевой трафик к конечным точкам Центра обновления Windows сможет проходить через брандмауэр.

**Подробнее:**

- Ознакомьтесь с [обзором брандмауэра Azure](/azure/firewall/overview).
- Сведения о [тегах полного доменного имени в брандмауэре Azure](/azure/firewall/fqdn-tags).

## <a name="best-practice-deploy-web-application-firewall"></a>Рекомендации: развертывание брандмауэра веб-приложения

Веб-приложения все чаще подвергаются вредоносным атакам, использующим общеизвестные уязвимости. Сюда входят, например, атаки путем внедрения кода SQL и межсайтовых сценариев. Предотвращение подобных атак в коде приложения может быть непростой задачей и может потребовать тщательного обслуживания, установки исправлений и мониторинга на нескольких уровнях топологии приложения.

Брандмауэр веб-приложения (WAF), компонент шлюза приложений Azure, помогает упростить управление безопасностью и помогает администраторам приложений защищаться от угроз и вторжений. Вы можете быстрее реагировать на угрозы безопасности за счет исправления известных уязвимостей в центральном расположении, а не для защиты отдельных веб-приложений. Вы можете легко преобразовать существующие шлюзы приложений в шлюз приложений, включенный для брандмауэра веб-приложения.

Ниже приведены некоторые дополнительные замечания о WAF.

- WAF обеспечивает централизованную защиту веб-приложений от распространенных эксплойтов и уязвимостей.
- Вам не нужно вносить изменения в код, чтобы использовать WAF.
- Он может защищать несколько веб-приложений одновременно, за шлюзом приложений.
- WAF интегрируется с центром безопасности Azure.
- Вы можете настроить правила WAF и группы правил в соответствии с требованиями приложения.
- Рекомендуется использовать WAF в начале любого веб-приложения, включая приложения на виртуальных машинах Azure или в службе приложений Azure.

**Подробнее:**

- Дополнительные сведения о [WAF](/azure/web-application-firewall/ag/ag-overview).
- Ознакомьтесь [с ограничениями WAF и исключениями](/azure/web-application-firewall/ag/application-gateway-waf-configuration).

## <a name="best-practice-implement-network-watcher"></a>Рекомендация: реализация наблюдателя за сетями

Наблюдатель за сетями предоставляет средства для мониторинга ресурсов и обмена данными в виртуальной сети Azure. Например, можно отслеживать обмен данными между виртуальной машиной и конечной точкой, например другой виртуальной машиной или полным доменным именем. Кроме того, можно просматривать ресурсы и связи ресурсов в виртуальной сети, а также диагностировать проблемы сетевого трафика.

![Снимок экрана: наблюдатель за сетями Azure.](./media/migrate-best-practices-networking/network-watcher.png)

![Снимок экрана: наблюдатель за сетями. ](./media/migrate-best-practices-networking/network-watcher.png)
 *Рис. 12. Наблюдатель за сетями.*

Ниже приведены некоторые дополнительные сведения.

- Наблюдатель за сетями позволяет отслеживать и диагностировать сетевые проблемы без входа на виртуальные машины.
- Можно активировать сбор пакетов, устанавливая оповещения, и получать доступ к сведениям о производительности в реальном времени на уровне пакетов. Обнаруженную проблему можно затем проанализировать.
- Рекомендуется использовать Наблюдатель за сетями для просмотра журналов потоков NSG.
  - Журналы потоков для групп безопасности сети (NSG) в службе "Наблюдатель за сетями" позволяют просматривать сведения о входящем и исходящем IP-трафике через NSG.
  - Запись в журналы потоков ведется в формате JSON.
  - Журналы потоков показывают исходящие и входящие потоки для каждого правила и сетевой интерфейс (NIC), к которому применяется поток. Они также отображают сведения о потоке (IP-адрес источника/назначения, порт источника и назначения и протокол) и указывает, был ли трафик разрешен или запрещен.

**Подробнее:**

- Ознакомьтесь с [обзором наблюдателя за сетями](/azure/network-watcher/).
- Дополнительные сведения о [журналах потоков NSG](/azure/network-watcher/network-watcher-nsg-flow-logging-overview).

## <a name="use-partner-tools-in-azure-marketplace"></a>Использование средств партнеров в Azure Marketplace

Для более сложных сетевых топологий можно использовать продукты безопасности от партнеров Майкрософт, в том числе виртуальные сетевые устройства.

- Виртуальное сетевое устройство — это виртуальная машина, которая выполняет сетевые функции, такие как защита с использованием брандмауэра, оптимизация доступа к глобальной сети и др.
- NVA более подробные безопасность виртуальной сети и сетевые функции. Они могут быть развернуты для высокодоступных брандмауэров, предотвращения вторжения, обнаружения вторжений, WAF, оптимизации глобальной сети, маршрутизации, балансировки нагрузки, VPN, управления сертификатами, Active Directory и многофакторной идентификации.
- NVA доступны у многочисленных поставщиков в [Azure Marketplace](https://azuremarketplace.microsoft.com).

## <a name="best-practice-implement-firewalls-and-nvas-in-hub-networks"></a>Рекомендации. Реализация брандмауэров и NVA в Центральных сетях

В концентраторе обычно осуществляется управление сетью периметра (с доступом к Интернету) через брандмауэр Azure, ферму брандмауэра или WAF. В следующей таблице приведены сравнения.

| Тип брандмауэра | Подробнее |
| --- | --- |
| Брандмауэры веб-приложений (WAF) | Веб-приложения используются повсеместно, они склонны содержать уязвимости, открытые для потенциальных эксплойтов. WAF предназначены для обнаружения атак на веб-приложения (HTTP/HTTPS). По сравнению с традиционными брандмауэрами, WAF содержат набор специальных функций для защиты внутренних веб-серверов от угроз. |
| Брандмауэр Azure | Подобно фермам брандмауэра NVA, брандмауэр Azure использует общий механизм администрирования и набор правил безопасности для защиты рабочих нагрузок, размещенных в периферийных сетях. Брандмауэр Azure также помогает управлять доступом к локальным сетям. Брандмауэр Azure имеет встроенную масштабируемость. |
| Брандмауэры виртуальных сетевых устройств (NVA) | Как и брандмауэр Azure, фермы брандмауэра NVA имеют общий механизм администрирования и набор правил безопасности для защиты рабочих нагрузок, размещенных в периферийных сетях. NVA брандмауэры также помогают управлять доступом к локальным сетям. Брандмауэры NVA можно вручную масштабировать за подсистемой балансировки нагрузки. <br><br> Хотя программное обеспечение брандмауэра NVA менее специализировано по сравнению с WAF, оно позволяет отфильтровывать больше приложений и проверять любой тип входящего и исходящего трафика. |

Мы рекомендуем использовать один набор брандмауэров Azure (или NVA) для трафика, поступающих через Интернет, а другой — для локального трафика. Использование только одного набора брандмауэров в обоих случаях представляет угрозу безопасности, так как между двумя наборами сетевого трафика отсутствует периметр безопасности. Использование отдельных уровней брандмауэра упрощает проверку правил безопасности, а также помогает понять, какие правила соответствуют определенным входящим сетевым запросам.

**Подробнее:**

- Узнайте [, как использовать NVA в виртуальной сети Azure](/azure/architecture/reference-architectures/dmz/secure-vnet-dmz).

## <a name="next-steps"></a>Дальнейшие действия

Просмотрите другие рекомендации:

- [Рекомендации по обеспечению безопасности рабочих нагрузок, перенесенных в Azure, и управлению ими](./migrate-best-practices-security-management.md).
- [Рекомендации](./migrate-best-practices-costs.md) по управлению затратами после миграции.
