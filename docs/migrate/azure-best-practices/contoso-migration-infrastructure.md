---
title: Развертывание инфраструктуры миграции
description: Узнайте, каким образом компания Contoso настраивает инфраструктуру Azure для миграции в Azure.
author: deltadan
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
ms.custom: think-tank
ms.openlocfilehash: 6729ff48934cd4e0471ff0ade338b3a10f94e6c4
ms.sourcegitcommit: a0ddde4afcc7d8c21559e79d406dc439ee4f38d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2020
ms.locfileid: "97712745"
---
<!-- cSpell:ignore untrust CIDR RRAS CONTOSODC SYSVOL ITIL NSGs ASGs -->

# <a name="deploy-a-migration-infrastructure"></a>Развертывание инфраструктуры миграции

В этой статье описывается, как вымышленная компания Contoso подготавливает свою локальную инфраструктуру к миграции, настраивает инфраструктуру Azure в ходе подготовки к миграции и ведет деловую деятельность в гибридной среде.

При использовании этого примера для планирования собственных усилий по миграции инфраструктуры следует помнить, что предоставленный пример архитектуры относится только к contoso. Изучите бизнес-потребности, структуру и технические требования вашей организации при принятии важных решений по инфраструктуре в отношении разработки подписки или сетевой архитектуры.

Возможно, вам понадобятся не все элементы, описанные в этой статье. Это зависит от стратегии миграции. Например, может потребоваться менее сложная структура сети, если вы создаете только облачные приложения в Azure.

## <a name="overview"></a>Обзор

Перед миграцией в Azure важно подготовить инфраструктуру Azure. Как правило, компания Contoso должна подумать об шести областях:

> [!div class="checklist"]
>
> - **Шаг 1. подписки Azure.** Как она будет покупать Azure и взаимодействовать с платформой и службами Azure?
> - **Шаг 2. Гибридная идентификация.** Как будет осуществляться управление доступом к ресурсам Azure и локальным ресурсам после миграции? Как она расширяет или перемещает управление удостоверениями в облако?
> - **Шаг 3. аварийное восстановление и устойчивость.** Как это обеспечит устойчивость приложений и инфраструктуры в случае сбоев и аварийных ситуаций?
> - **Шаг 4. сеть.** Как ИТ-инфраструктура должна разрабатывать сетевую инфраструктуру и устанавливать подключение между локальным центром обработки данных и Azure?
> - **Шаг 5. безопасность.** Как будет обеспечиваться безопасность гибридного развертывания?
> - **Шаг 6. Управление.** Как будет поддерживать развертывание в соответствии с требованиями к безопасности и управлению?

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать просмотр инфраструктуры, ознакомьтесь со сведениями о соответствующих возможностях Azure:

- Существует несколько вариантов приобретения доступа к Azure, включая подписки с оплатой по мере использования, Microsoft Соглашение Enterprise (EA), Open Licensing от торговых посредников Майкрософт или покупки партнеров Майкрософт в программе поставщика облачных решений (CSP). Узнайте больше о [вариантах приобретения](https://azure.microsoft.com/pricing/purchase-options/) и [структуре подписок Azure](https://azure.microsoft.com/blog/organizing-subscriptions-and-resource-groups-within-the-enterprise/).
- Ознакомьтесь с обзором [управления удостоверениями и доступом Azure (IAM)](https://www.microsoft.com/security/business/identity). Узнайте о [Azure Active Directory (Azure AD) и расширении локальной Active Directory в облако](/azure/active-directory/fundamentals/active-directory-whatis).
- Azure предоставляет надежную сетевую инфраструктуру с возможностями гибридного подключения. Получите общее представление о [сетевых возможностях и управлении доступом к сети](/azure/security/fundamentals/network-overview).
- Ознакомьтесь с [введением в систему безопасности Azure](/azure/security/fundamentals/overview) и Узнайте, как создать план для управления [Azure](/azure/governance/).

## <a name="on-premises-architecture"></a>Локальная архитектура

Ниже приведена схема, на которой показана текущая локальная инфраструктура contoso.

![Схема архитектуры contoso.](./media/contoso-migration-infrastructure/contoso-architecture.png)

_Рис. 1. локальная архитектура contoso._

- В Восточном США Contoso имеет один главный центр обработки данных, расположенный в городе Нью Йорк.
- У компании есть еще три местных филиала на территории США.
- Главный центр обработки данных подключен к Интернету с волоконно-оптическим подключением Metro Ethernet (500 Мбит/с).
- Каждая ветвь подключается локально к Интернету через подключения к бизнес-классам, при этом VPN-туннели IPsec возвращаются к основному центру обработки данных. Такой подход позволяет постоянно подключать всю сеть и оптимизировать подключение к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. В Contoso есть два узла виртуализации ESXi 6,5, управляемых vCenter Server 6,5.
- Contoso использует Active Directory для управления удостоверениями и DNS-серверами во внутренней сети.
- Контроллеры домена в центре обработки данных работают на виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.

## <a name="step-1-buy-and-subscribe-to-azure"></a>Шаг 1. Приобретение Azure и оформление подписки

Компании Contoso необходимо узнать, как купить Azure, как управлять подписками, а затем как лицензировать службы и ресурсы.

### <a name="buy-azure"></a>Приобретение Azure

Contoso регистрируется в [Соглашение Enterprise](https://azure.microsoft.com/overview/sales-number/). Это соглашение влечет за собой предварительные денежные обязательства в Azure. Он предоставляет компании Contoso право на получение таких преимуществ, как гибкие варианты выставления счетов и оптимизированные цены.

Дополнительные сведения:

- В Contoso оценили ежегодные затраты на Azure. При подписании соглашения компания Contoso заплатила за первый год в полном объеме.
- Компания Contoso должна использовать все обязательства до тех пор, пока год не отменяется или теряется значение этих долларов.
- Если по какой бы причине компания Contoso превышает свои обязательства и тратит больше времени, корпорация Майкрософт выставляет счет за разницу.
- Тарифы по всем расходам свыше авансовой суммы остаются такими же, как указано в контракте с Contoso. Штраф за превышение отсутствует.

### <a name="manage-subscriptions"></a>Управление подписками

После оплаты Azure Contoso необходимо разобраться, как управлять подписками Azure. Поскольку компания Contoso имеет соглашение EA, ограничение на количество создаваемых подписок Azure не ограничено. Регистрация Соглашение Enterprise Azure определяет, как фигуры компании и используют службы Azure, и определяет основную структуру управления.

В качестве первого шага компания Contoso определила структуру, известную как _Корпоративный механизм_ для регистрации. Компания Contoso использовала [руководство по формированию шаблонов Azure Enterprise](/azure/cloud-adoption-framework/reference/azure-scaffold) , чтобы помочь понять и спроектировать шаблон.

Сейчас компания Contoso решила использовать функциональный подход для управления подписками:

- Внутри предприятия будет использоваться один отдел ИТ, который управляет бюджетом Azure. Это будет единственная группа с подписками.
- Компания Contoso будет расширять эту модель в будущем, чтобы другие корпоративные группы могли присоединяться в качестве отделов в иерархии регистрации.
- Внутри ИТ-отдела компания Contoso имеет структурированные две подписки `Production` и `Development` .
- Если в будущем компании Contoso требуется больше подписок, для них также потребуется управление доступом, политиками и соответствием. Компания Contoso сделает это, представляя [группы управления Azure](/azure/governance/management-groups/overview) в качестве дополнительного уровня для подписок.

![Схема иерархии предприятия.](./media/contoso-migration-infrastructure/enterprise-structure.png)

_Рис. 2. Корпоративная иерархия._

### <a name="examine-licensing"></a>Изучение вариантов лицензирования

После настройки подписок Contoso может переходить к вопросу лицензирования продуктов корпорации Майкрософт. Стратегия лицензирования будет зависеть от ресурсов, которые компания Contoso хочет перенести в Azure, а также о том, как виртуальные машины и службы выбираются и развертываются в Azure.

#### <a name="azure-hybrid-benefit"></a>Преимущество гибридного использования Azure

Для развертывания виртуальных машин в Azure стандартные образы включают лицензию, которая будет взиматься в компанию Contoso по минуте использования используемого программного обеспечения. Однако компания Contoso была долгосрочным клиентом корпорации Майкрософт и поддерживала EAs и Open Licenses с Software Assurance.

Преимущество гибридного использования Azure предоставляет экономичный метод миграции. Это позволяет компании Contoso экономить на виртуальных машинах Azure и SQL Server рабочих нагрузках, преобразуя или повторно используя лицензии на выпуск Windows Server Datacenter и Standard Edition, которые попадают под действие Software Assurance. Это позволяет компании Contoso платить за нижнюю базовую частоту вычислений для виртуальных машин и SQL Server. Дополнительные сведения см. в разделе [преимущество гибридного использования Azure](https://azure.microsoft.com/pricing/hybrid-benefit/).

#### <a name="license-mobility"></a>Перемещение лицензий

Перемещение лицензий в рамках Software Assurance позволяет клиентам корпоративного лицензирования Майкрософт, таким как Contoso, гибко развертывать подходящие серверные приложения с активной программой Software Assurance в Azure. Это избавляет от необходимости приобрести новые лицензии. Поскольку за перемещение плата не взимается, имеющиеся лицензии можно легко развернуть в Azure. Дополнительные сведения см. в статье [Перемещение лицензий в рамках программы Software Assurance в Azure](https://azure.microsoft.com/pricing/license-mobility/).

#### <a name="reserved-instances-for-predictable-workloads"></a>Зарезервированные экземпляры для прогнозируемых рабочих нагрузок

Прогнозируемые рабочие нагрузки всегда должны быть доступны для виртуальных машин, работающих под управлением, таких как бизнес-приложения, такие как система SAP ERP. Непредсказуемые рабочие нагрузки — это переменные, такие как виртуальные машины, которые находятся в процессе высокой нагрузки и отключены при низкой потребности.

![Схема Azure Reserved Virtual Machine Instances.](./media/contoso-migration-infrastructure/reserved-instance.png)

_Рис. 3. Azure Reserved Virtual Machine Instances._

В Exchange для использования зарезервированных экземпляров для конкретных экземпляров виртуальных машин, которые должны храниться в течение длительного времени, Contoso может получить как скидку, так и приоритетную емкость. Использование [Azure reserved Virtual Machine Instances](https://azure.microsoft.com/pricing/reserved-vm-instances/) вместе с преимущество гибридного использования Azure может сэкономить Contoso до 82 процентов от обычных цен с оплатой по мере использования (по состоянию на апрель 2018).

## <a name="step-2-manage-hybrid-identity"></a>Шаг 2. Управление гибридными удостоверениями

Предоставление и управление доступом пользователей к ресурсам Azure с помощью управления удостоверениями и доступом — это важный шаг в извлечении инфраструктуры Azure.

В Contoso решают расширить свою локальную службу Active Directory для работы в облачной среде, а не создавать отдельную систему в Azure. Так как Contoso не использует Microsoft 365, ему нужно подготавливать экземпляр Azure AD. Если компания Contoso использовала Microsoft 365, у нее уже есть существующий клиент и каталог Azure AD, который может использоваться в качестве своего основного экземпляра Azure AD.

Дополнительные сведения о [моделях удостоверений Microsoft 365 и Azure Active Directory](/microsoft-365/enterprise/about-microsoft-365-identity?view=o365-worldwide). Вы также можете узнать, как [связать или добавить подписку Azure в клиент Azure Active Directory](/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory).

### <a name="create-an-azure-ad-directory"></a>Создание каталога Azure AD

Contoso использует выпуск Azure AD Free, который предоставляется вместе с подпиской Azure. Администраторы Contoso создают каталог Azure AD:

1. В [портал Azure](https://portal.azure.com)они переходят в раздел **Создание**  >  **удостоверения** ресурса  >  **Azure Active Directory**.

1. В поле **создать каталог** укажите имя каталога, исходное доменное имя и регион, в котором должен быть создан каталог.

   ![Снимок экрана выбора для создания каталога Azure AD.](./media/contoso-migration-infrastructure/azure-ad-create.png)

   _Рис. 4. Создание каталога Azure AD._

> [!NOTE]
> Созданный каталог имеет исходное доменное имя в форме `domain-name.onmicrosoft.com` . Это имя нельзя изменить или удалить. Вместо этого администраторам необходимо добавить зарегистрированное доменное имя в Azure AD.

### <a name="add-the-domain-name"></a>Добавление доменного имени

Чтобы использовать стандартное доменное имя, администраторы Contoso должны добавить его в качестве имени личного домена в Azure AD. Эта возможность позволяет им назначать привычные имена пользователей. Например, пользователь может войти, используя адрес электронной почты, `billg@contoso.com` а не `billg@contosomigration.onmicrosoft.com` .

Чтобы настроить пользовательское доменное имя, администратор добавляет его в каталог, добавляет запись DNS и проверяет имя в Azure AD.

1. В области **пользовательские доменные имена**  >  **добавьте личный домен**, чтобы добавить домен.
2. Чтобы использовать DNS-запись в Azure, необходимо зарегистрировать ее в регистраторе домена:

    - При этом они записывают сведения о DNS для этого имени, указанные в списке **Имена пользовательских доменов**. Он использует MX-запись.
    - Им требуется доступ к серверу имен. Они входят в `contoso.com` домен и создают новую MX-запись для записи DNS, предоставляемой Azure AD, с помощью указанных здесь сведений.

3. После распространения записей DNS выберите **проверить** , чтобы проверить имя личного домена в сведениях для домена.

    ![Снимок экрана, на котором показано выделение Azure Active Directory D N S.](./media/contoso-migration-infrastructure/azure-ad-dns.png)

    _Рис. 5. Проверка доменного имени._

### <a name="set-up-on-premises-and-azure-groups-and-users"></a>Настройка локальной среды, а также групп и пользователей Azure

Теперь, когда каталог Azure AD установлен, администраторам Contoso необходимо добавить сотрудников в локальные Active Directory группы, которые будут синхронизироваться с Azure AD. Им следует использовать имена локальных групп, которые соответствуют именам групп ресурсов в Azure. Это упрощает определение совпадений в целях синхронизации.

#### <a name="create-resource-groups-in-azure"></a>Создание групп ресурсов в Azure

Группы ресурсов Azure объединяют ресурсы Azure. Идентификатор группы ресурсов позволяет выполнять операции с ресурсами в пределах группы.

Подписка Azure может иметь несколько групп ресурсов. Группа ресурсов существует в одной подписке. Кроме того, одна группа ресурсов может иметь несколько ресурсов. Ресурс принадлежит к одной группе ресурсов.

Администраторы Contoso настроили группы ресурсов Azure, как показано в следующей таблице.

| Группа ресурсов | Сведения |
| --- | --- |
| `ContosoCobRG` | Эта группа содержит все ресурсы, связанные с непрерывностью бизнеса. Сюда входят хранилища, которые компания Contoso будет использовать для службы Azure Site Recovery и службы Azure Backup. <br><br> Сюда также входят ресурсы, используемые для миграции, включая Azure Migration and Azure Database Migration Service. |
| `ContosoDevRG` | Эта группа содержит ресурсы для разработки и тестирования. |
| `ContosoFailoverRG` | Эта группа выступает в качестве целевой зоны для ресурсов, для которых произошел сбой. |
| `ContosoNetworkingRG` | Эта группа содержит все сетевые ресурсы. |
| `ContosoRG` | Эта группа содержит ресурсы, связанные с рабочими приложениями и базами данных. |

Группы ресурсов в Azure создаются в соответствии с описанной ниже процедурой.

1. На портале Azure нужно выбрать **Группы ресурсов** и добавить группу.
2. Для каждой группы указываются имя, подписка, к которой принадлежит группа, и регион.
3. Группы ресурсов отображаются в списке **Группы ресурсов**.

   ![Снимок экрана, на котором показан список групп ресурсов](./media/contoso-migration-infrastructure/resource-groups.png)

   _Рис. 6. группы ресурсов._

##### <a name="scale-resource-groups"></a>Масштабирование групп ресурсов

В будущем специалисты Contoso будут добавлять другие группы ресурсов по мере необходимости. Например, он может определить группу ресурсов для каждого приложения или службы, чтобы каждый из них мог управляться и защищаться независимо друг от друга.

#### <a name="create-matching-security-groups-on-premises"></a>Создание соответствующих групп безопасности в локальной среде

В локальном экземпляре Active Directory администраторы Contoso настраиваются группы безопасности с именами, соответствующими именам групп ресурсов Azure.

![Снимок экрана, на котором показаны локальные Active Directory группы безопасности.](./media/contoso-migration-infrastructure/on-premises-ad.png)

_Рис. 7. локальные Active Directory группы безопасности._

Для управления создаются дополнительные группы, которые будут добавлены во все остальные группы. У этой группы будут права для всех групп ресурсов в Azure. В эту группу будет добавлено ограниченное число глобальных администраторов.

### <a name="synchronize-active-directory"></a>Синхронизация Active Directory

Contoso требуется предоставить общее удостоверение для доступа к ресурсам в локальной среде и в облаке. Для этого будет интегрирован локальный экземпляр Active Directory с Azure AD. Эта модель позволяет пользователям и организациям использовать единое удостоверение для доступа к локальным приложениям и облачным службам, таким как Microsoft 365 или тысячи других сайтов в Интернете. Администраторы могут использовать группы в Active Directory для реализации [управления доступом на основе ролей Azure (Azure RBAC)](/azure/role-based-access-control/role-assignments-portal).

Для упрощения интеграции Contoso использует [средство Azure AD Connect](/azure/active-directory/hybrid/whatis-hybrid-identity). При установке и настройке средства на контроллере домена он синхронизирует локальные удостоверения Active Directory с Azure AD.

### <a name="download-the-tool"></a>Скачивание средства

1. В портал Azure администраторы Contoso переходят на **Azure Active Directory**  >  **Azure AD Connect** и скачайте последнюю версию средства на сервер, который они используют для синхронизации.

    ![Снимок экрана, на котором показана ссылка для скачивания Azure A D Connect.](./media/contoso-migration-infrastructure/download-ad-connect.png)

    _Рис. 8. скачивание Azure AD Connect._

2. Они начинают `AzureADConnect.msi` установку с помощью стандартных **параметров**. Это наиболее распространенная установка, которую можно использовать для топологии с одним лесом с синхронизацией хэша паролей для проверки подлинности.

    ![Снимок экрана, на котором показан мастер Azure AD Connect.](./media/contoso-migration-infrastructure/ad-connect-wiz1.png)

    _Рис. 9. Мастер Azure AD Connect._

3. При **подключении к Azure AD** они указывают учетные данные для подключения к Azure AD (в форме `admin@contoso.com` или `admin@contoso.onmicrosoft.com` ).

    ![Снимок экрана, на котором показана страница "подключение к Azure A D" мастера Azure A D Connect.](./media/contoso-migration-infrastructure/ad-connect-wiz2.png)

    _Рис. 10. Мастер Azure AD Connect: подключение к Azure AD._

4. В окне **Подключение к AD DS** они указывают учетные данные для локального каталога (в форме `CONTOSO\admin` или `contoso.com\admin` ).

    ![Снимок экрана, на котором показана страница подключения к D D в мастере Azure A D Connect.](./media/contoso-migration-infrastructure/ad-connect-wiz3.png)

    _Рис. 11. Мастер Azure AD Connect: подключение к AD DS._

5. В окне **Готово к настройке** они выбирают **Запустить синхронизацию сразу после завершения настройки**, чтобы незамедлительно начать синхронизацию. Затем они устанавливают средство.

    Следует отметить следующее.

    - У Contoso есть прямое подключение к Azure. Если локальный экземпляр Active Directory находится за прокси-сервером, ознакомьтесь с [разрешениями устранение неполадок с подключением к Azure AD](/azure/active-directory/hybrid/tshoot-connect-connectivity).

    - После первой синхронизации локальные объекты Active Directory отображаются в каталоге Azure AD.

      ![Снимок экрана, на котором показаны локальные Active Directory объекты, видимые в Azure Active Directory.](./media/contoso-migration-infrastructure/on-premises-ad-groups.png)

      _Рис. 12. локальные Active Directory объекты, отображаемые в Azure AD._

    - Группа Contoso IT представлена в каждой группе и основана на ее роли.

      ![Снимок экрана, показывающий членство в группе.](./media/contoso-migration-infrastructure/on-premises-ad-group-members.png)

      _Рис. 13. членство в группе._

### <a name="set-up-azure-rbac"></a>Настройка Azure RBAC

[Azure RBAC](/azure/role-based-access-control/role-assignments-portal) обеспечивает детальное управление доступом для Azure. С помощью Azure RBAC можно предоставить пользователям доступ только для выполнения задач. Вы назначаете соответствующую роль Azure пользователям, группам и приложениям на уровне области. Областью назначения роли может быть подписка, группа ресурсов или отдельный ресурс.

Администраторы Contoso назначают роли группам Active Directory, которые они синхронизированы из локальной среды.

1. В `ControlCobRG` группе ресурсов они выбирают пункт **Управление доступом (IAM)**  >  **добавить назначение ролей**.
2. Участник роли **Добавить роль назначения ролей**  >    >  выбирает `ContosoCobRG` группу безопасности из списка. После этого группа появляется в списке **Выбранные элементы**.
3. Они повторяются с теми же разрешениями для других групп ресурсов (кроме `ContosoAzureAdmins` ), добавляя разрешения **участника** в группу безопасности, соответствующую группе ресурсов.
4. Для `ContosoAzureAdmins` группы безопасности они назначают роль **владельца** .

    ![Снимок экрана, на котором показаны локальные группы Azure Active Directory.](./media/contoso-migration-infrastructure/on-premises-ad-groups.png)

    _Рис. 14. Назначение ролей группам безопасности._

## <a name="step-3-design-for-resiliency"></a>Шаг 3. Проектирование для обеспечения устойчивости

### <a name="set-up-regions"></a>Настройка регионов

Ресурсы Azure развертываются в пределах регионов. Регионы организованы в географические области. Требования к местонахождение данных, независимости, соответствие требованиям и устойчивости учитываются в географических границах.

Регион состоит из набора центров обработки данных. Эти центры обработки данных развертываются в пределах периметра с определенной задержкой и соединяются между собой выделенной региональной сетью с низкой задержкой.

Для обеспечения устойчивости каждый регион Azure связывается с другим регионом. Просмотрите дополнительные сведения о [регионах Azure](https://azure.microsoft.com/global-infrastructure/geographies/) и [связывании областей](/azure/best-practices-availability-paired-regions).

Компания Contoso решила использовать `East US 2` (находится в Виргиния) в качестве основного региона и `Central US` (находится в Айова) в качестве дополнительного региона, по следующим причинам:

- Центр обработки данных Contoso находится в Нью-Йорке, поэтому учитывалась задержка при передаче данных в ближайший центр обработки данных.
- `East US 2` содержит все службы и продукты, необходимые компании Contoso. Не все регионы Azure имеют одни и те же продукты и службы. Дополнительные сведения см. в статье [продукты Azure по регионам](https://azure.microsoft.com/global-infrastructure/services/).
- `Central US` — Это парный регион Azure для `East US 2` .

При проектировании гибридной среды специалистам Contoso необходимо учитывать то, как стратегия обеспечения устойчивости и аварийного восстановления впишется в структуру региона. Простейшая стратегия — это развертывание в одном регионе, которое полагается на функции платформы Azure, такие как домены сбоя и региональные пары для обеспечения устойчивости. Наиболее сложная модель является полноценной активной моделью, в которой облачные службы и база данных развертываются и обслуживают пользователей из двух регионов.

Компания Contoso выбрала срединный путь. Он развертывает приложения и ресурсы в основном регионе и сохраняет полную копию инфраструктуры в дополнительном регионе. С этой стратегией копия готова к работе в качестве полной резервной копии, если происходит аварийный или региональный сбой приложения.

### <a name="set-up-availability"></a>Настройка доступности

#### <a name="availability-sets"></a>Группы доступности

Группы доступности помогают защитить приложения и данные от локального аппаратного и сетевого сбоя в центре обработки данных. Группы доступности распределяют виртуальные машины Azure по физическому оборудованию в центре обработки данных.

Домены сбоя представляют базовое оборудование с общим источником питания и сетевым коммутатором в центре обработки данных. Виртуальные машины в группе доступности распределяются по доменам сбоя для снижения простоев, вызванных сбоем одного оборудования или сети.

Домены обновления представляют базовое оборудование, которое может одновременно обслуживаться или перезагружаться. Группы доступности также распределяют виртуальные машины между несколькими доменами обновления, чтобы гарантировать, что хотя бы один экземпляр будет выполняться в любое время.

Компания Contoso реализует группы доступности, когда для рабочих нагрузок виртуальной машины требуется высокий уровень доступности. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure](/azure/virtual-machines/manage-availability).

#### <a name="availability-zones"></a>Зоны доступности

Зоны доступности помогает защитить приложения и данные от сбоев, влияющих на весь центр обработки данных в пределах одного региона.

Каждая зона доступности представляет уникальное физическое расположение в регионе Azure. Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия.

Во всех включенных регионах используется как минимум три отдельные зоны. Физическое разделение зон в пределах региона защищает приложения и данные от сбоев на уровне центров обработки данных.

Contoso будет использовать Зоны доступности каждый раз, когда приложениям требуется более высокий уровень масштабируемости, доступности и устойчивости. Дополнительные сведения см. [в статье регионы и зоны доступности в Azure](/azure/availability-zones/az-overview).

### <a name="configure-backup"></a>Настройка резервного копирования

#### <a name="azure-backup"></a>Azure Backup

Вы можете использовать Azure Backup для резервного копирования и восстановления дисков виртуальных машин Azure.

Azure Backup позволяет автоматически создавать резервные копии образов дисков виртуальных машин, хранящихся в службе хранилища Azure. Резервные копии являются согласованными для приложений, чтобы обеспечить согласованность транзакций с резервными копиями данных и запуск приложений после восстановления.

Azure Backup поддерживает локально избыточное хранилище (LRS) для репликации нескольких копий данных резервных копий в пределах одного центра, если происходит сбой локального оборудования. Если происходит региональный сбой, Azure Backup также поддерживает геоизбыточное хранилище (GRS), которое реплицирует резервные данные во вторичный парный регион.

Azure Backup шифрует данные при передаче с помощью AES-256. Резервные копии неактивных данных шифруются с помощью [шифрования службы хранилища Azure](/azure/storage/common/storage-service-encryption).

Contoso будет использовать Azure Backup с GRS на всех рабочих виртуальных машинах, чтобы обеспечить резервное копирование данных рабочей нагрузки и быстро восстановить их в случае сбоя. Дополнительные сведения см. [в обзоре резервного копирования виртуальных машин Azure](/azure/backup/backup-azure-vms-introduction).

### <a name="set-up-disaster-recovery"></a>Настройка аварийного восстановления

#### <a name="azure-site-recovery"></a>Azure Site Recovery

Azure Site Recovery помогает обеспечить непрерывность бизнес-процессов, обеспечивая выполнение бизнес-приложений и рабочих нагрузок во время региональных сбоев.

Azure Site Recovery постоянно реплицирует виртуальные машины Azure из базы данных-источника в дополнительный регион, обеспечивая функциональные копии в обоих расположениях. В случае сбоя в основном регионе приложение или служба переключит на использование экземпляров виртуальных машин, реплицированных в дополнительном регионе. Эта отработка отказа уменьшает потенциальный перерыв. Когда операции возвращают значение в нормальное состояние, приложения или службы могут восстановить работу на виртуальных машинах в основном регионе.

Компания Contoso реализует [Azure Site Recovery](/azure/site-recovery/site-recovery-overview) для всех рабочих виртуальных машин, используемых в критически важных рабочих нагрузках, что обеспечивает минимальный перерыв во время сбоя в основном регионе.

## <a name="step-4-design-a-network-infrastructure"></a>Шаг 4. Проектирование сетевой инфраструктуры

При наличии регионального дизайна компания Contoso готова рассмотреть стратегию сети. Компании следует выбрать подключение и способ обмена данными между ее локальным центром обработки данных и Azure, а также определить принципы проектирования сетевой инфраструктуры в Azure. В частности, компания Contoso должна:

- **Планирование гибридного подключения к сети.** Определить, как будут соединены сети локальной среды и Azure.
- **Проектирование сетевой инфраструктуры Azure.** Решить, как будут развертываться сети в разных регионах. Как сети будут обмениваться данными в одном и том же регионе и в разных регионах?
- **Разработка и настройка сетей Azure.** Настроить сети и подсети Azure и решить, что будет в них находиться.

### <a name="plan-hybrid-network-connectivity"></a>Планирование возможности подключения к сети в гибридной среде

Компания Contoso считала [несколько архитектур гибридной сети](/azure/architecture/reference-architectures/hybrid-networking/) между Azure и локальным центром обработки данных. Дополнительные сведения см. в статье [Выбор решения для подключения локальной сети к Azure](/azure/architecture/reference-architectures/hybrid-networking/).

Как напоминание, локальная сетевая инфраструктура Contoso в настоящее время состоит из центра обработки данных в Нью-Йорке и локальных ветвей в восточной половине США. Все расположения имеют подключение к Интернету через бизнес-класс. Затем каждая из ветвей подключается к центру обработки данных через VPN-туннель IPsec через Интернет.

![Схема сети Contoso.](./media/contoso-migration-infrastructure/contoso-networking.png)

_Рис. 15. сеть Contoso._

Компания Contoso решила реализовать гибридные подключения следующим образом.

1. Настройте новое VPN-подключение типа "сеть — сеть" между центром обработки данных Contoso в Нью-Йорке и двумя регионами Azure `East US 2` и `Central US` .
2. Привязка трафика филиала для виртуальных сетей в Azure будет проходить через главный центр обработки данных Contoso.
3. Так как Contoso масштабирует развертывание Azure, он установит подключение Azure ExpressRoute между центром обработки данных и регионами Azure. В этом случае Contoso будет хранить VPN-подключение типа "сеть — сеть" только в целях отработки отказа.
    - Узнайте больше о [выборе между гибридным РЕШЕНИЕМ VPN и ExpressRoute](/azure/architecture/reference-architectures/hybrid-networking/).
    - Ознакомьтесь с [месторасположением и возможностями поддержки ExpressRoute](/azure/expressroute/expressroute-locations-providers).

**Только VPN:**

![Снимок экрана, на котором показана VPN-сеть Contoso.](./media/contoso-migration-infrastructure/hybrid-vpn.png)

_Рис. 16. VPN-подключение contoso._

**VPN и ExpressRoute:**

![Снимок экрана, на котором показаны Contoso VPN и ExpressRoute.](./media/contoso-migration-infrastructure/hybrid-vpn-expressroute.png)

_Рис. 17. contoso VPN и ExpressRoute._

### <a name="design-the-azure-network-infrastructure"></a>Проектирование сетевой инфраструктуры Azure

Конфигурация сети компании Contoso должна обеспечивать безопасность и масштабируемость гибридного развертывания. Contoso занимается долгосрочным подходом, создавая виртуальные сети для устойчивых и готовых к работе в Организации. Дополнительные сведения см. в статье [Планирование виртуальных сетей](/azure/virtual-network/virtual-network-vnet-plan-design-arm).

Для подключения двух регионов компания Contoso будет реализовывать модель сети типа "концентратор-концентратор". В каждом регионе она будет использовать звездообразную модель. Для подключения сетей и концентраторов будет использоваться пиринг сетей Azure.

#### <a name="network-peering"></a>Пиринг сетей

[Пиринг виртуальных](/azure/virtual-network/virtual-network-peering-overview) сетей в Azure подключает виртуальные сети и концентраторы. Глобальный пиринг разрешает подключения между виртуальной сетью или концентраторами в разных регионах. Локальный пиринг подключает виртуальные сети в одном регионе.

Пиринг виртуальных сетей предоставляет несколько преимуществ.

- Сетевой трафик между одноранговыми виртуальными сетями является закрытым.
- Трафик между виртуальными сетями хранится в магистральной сети Майкрософт. В связи между виртуальными сетями не требуется общий доступ к Интернету, шлюзам или шифрованию.
- Пиринг обеспечивает подключение между ресурсами в разных виртуальных сетях по умолчанию с низкой задержкой и высокой пропускной способностью.

#### <a name="hub-to-hub-model-across-regions"></a>Модель "концентратор-концентратор" в разных регионах

Contoso развернет концентраторы в каждом регионе. Концентратор — это виртуальная сеть в Azure, которая выступает в качестве центральной точки подключения к локальной сети. Виртуальные сети концентратора будут подключаться друг к другу через глобальную виртуальную сеть, которая соединяет виртуальные сети между регионами Azure. Концентратор в каждом регионе выполняет роль кэширующего узла для непосредственно подключенного к нему концентратора в другом регионе. Концентратор является одноранговым по отношению к каждой сети в своем регионе и может подключаться ко всем сетевым ресурсам.

![Схема глобального пиринга.](./media/contoso-migration-infrastructure/global-peering.png)

_Рис. 18. Глобальный пиринг._

#### <a name="hub-and-spoke-model-within-a-region"></a>Модель "звезда" в пределах региона

В каждом регионе Contoso будет развертывать виртуальные сети для различных целей в виде периферийных сетей из центра регионов. Виртуальные сети в регионе используют пиринг для подключения к концентратору и друг другу.

#### <a name="design-the-hub-network"></a>Проектирование сети-концентратора

В рамках модели "звезда" компании Contoso необходимо подумать о том, как будет маршрутизироваться трафик из локального центра обработки данных и из Интернета. Вот как компания Contoso решила управлять маршрутизацией как для `East US 2` концентраторов, так и для `Central US` :

- Компания Contoso разрабатывает сеть, которая разрешает трафик из Интернета и из корпоративной сети с помощью VPN-подключения к Azure.
- Такая архитектура сети имеет две границы, ненадежную внешнюю зону по периметру и надежную внутреннюю зону.
- Брандмауэр в каждой зоне будет оснащен сетевым адаптером, управляющим доступом к надежным зонам.
- При передаче данных из Интернета:
  - Интернет-трафик будет поступать на общедоступный IP-адрес с балансировкой нагрузки в сети периметра.
  - Этот трафик направляется через брандмауэр и подчиняется правилам брандмауэра.
  - После реализации управления доступом к сети трафик будет переадресован в соответствующее расположение в надежной зоне.
  - Исходящий трафик из виртуальной сети будет направляться в Интернет через определяемые пользователем маршруты. Трафик принудительно проходит через брандмауэр и проверяется в соответствии с политиками contoso.
- При передаче данных из центра обработки данных Contoso:
  - Входящий трафик через VPN типа "сеть — сеть" или ExpressRoute достигает общедоступного IP-адреса VPN-шлюза Azure.
  - Он проходит через брандмауэр, где к нему применяются правила брандмауэра.
  - После применения правил брандмауэра трафик перенаправляется во внутреннюю подсистему балансировки нагрузки (номер SKU уровня "Стандартный") в подсети доверенной внутренней зоны.
  - Исходящий трафик из доверенной подсети в локальный центр обработки данных через VPN направляется через брандмауэр. Правила применяются до того, как трафик переключается через VPN-подключение типа "сеть — сеть".

### <a name="design-and-set-up-azure-networks"></a>Проектирование и настройка сетей Azure

Используя топологию сети и маршрутизации, компания Contoso готова к настройке сетей и подсетей Azure:

<!-- docutune:casing "class-A" "class-B" -->

- Компания Contoso будет реализовывать класс — частную сеть в Azure ( `10.0.0.0/8` ). Это работает из-за локальной среды; в настоящее время он имеет закрытое адресное пространство класса B ( `172.160.0.0/16` ). Компания Contoso может гарантировать, что между диапазонами адресов не будет перекрытия.
- Компания Contoso будет развертывать виртуальные сети как в основном, так и в дополнительном регионах.
- Contoso будет использовать соглашение об именовании, включающее префикс, `VNET` сокращенное название региона `EUS2` или `CUS` . При использовании этого стандарта сети концентраторов будут называться `VNET-HUB-EUS2` в `East US 2` регионе и `VNET-HUB-CUS` в `Central US` регионе.

#### <a name="virtual-networks-in-east-us-2"></a>Виртуальные сети в `East US 2`

`East US 2` — Это основной регион, который компания Contoso будет использовать для развертывания ресурсов и служб. Вот как Contoso будет проектировать сети в этом регионе:

- **Центр:** Виртуальная сеть концентратора в `East US 2` рассматривается как основное подключение Contoso к локальному центру обработки данных.

- **Виртуальные сети:** Периферийные виртуальные сети в `East US 2` можно использовать для изоляции рабочих нагрузок при необходимости. В дополнение к виртуальной сети компании Contoso будет иметь две периферийные виртуальные сети в `East US 2` :

  - `VNET-DEV-EUS2`. Эта виртуальная сеть предоставит команде разработки и тестирования полностью функциональную сеть для проектов разработки. Она будет выступать в качестве рабочей пилотной площадки и использовать инфраструктуру рабочей среды.

  - `VNET-PROD-EUS2`. В этой сети будут размещены рабочие компоненты Azure IaaS.

  Каждая виртуальная сеть будет иметь собственное уникальное адресное пространство без перекрытия. Компания Contoso намеревается настроить маршрутизацию без преобразования сетевых адресов (NAT).

- **Подсети:** Для каждого уровня приложения будет использоваться подсеть в каждой сети. Каждая подсеть в рабочей сети будет иметь подходящую подсеть в виртуальной сети разработки. В рабочей сети есть подсеть для контроллеров домена.

В следующей таблице перечислены виртуальные сети в `East US 2` .

| Виртуальная сеть | Диапазон | Одноранговый узел |
| --- | --- | --- |
| `VNET-HUB-EUS2` | `10.240.0.0/20` | `VNET-HUB-CUS2`, `VNET-DEV-EUS2`, `VNET-PROD-EUS2` |
| `VNET-DEV-EUS2` | `10.245.16.0/20` | `VNET-HUB-EUS2` |
| `VNET-PROD-EUS2` | `10.245.32.0/20` | `VNET-HUB-EUS2`, `VNET-PROD-CUS` |

![Схема модели "звезда" в основном регионе.](./media/contoso-migration-infrastructure/primary-hub-peer.png)

_Рис. 19. модель "звезда"._

#### <a name="subnets-in-the-east-us-2-hub-network-vnet-hub-eus2"></a>Подсети в `East US 2 Hub` сети ( `VNET-HUB-EUS2` )

| Подсеть/зона | CIDR | Пригодные для использования IP-адреса |
| --- | --- | --- |
| `IB-UntrustZone` | `10.240.0.0/24`  | 251 |
| `IB-TrustZone`   | `10.240.1.0/24`  | 251 |
| `OB-UntrustZone` | `10.240.2.0/24`  | 251 |
| `OB-TrustZone`   | `10.240.3.0/24`  | 251 |
| `GatewaySubnet`  | `10.240.10.0/24` | 251 |

#### <a name="subnets-in-the-east-us-2-development-network-vnet-dev-eus2"></a>Подсети в `East US 2` сети разработки ( `VNET-DEV-EUS2` )

Группа разработки использует виртуальную сеть разработки в качестве рабочей пилотной области. Он имеет три подсети:

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `DEV-FE-EUS2` | `10.245.16.0/22` | 1019 | Внешние интерфейсы и виртуальные машины веб-уровня |
| `DEV-APP-EUS2` | `10.245.20.0/22` | 1019 | Виртуальные машины уровня приложений |
| `DEV-DB-EUS2` | `10.245.24.0/23` | 507 | Виртуальные машины баз данных |

#### <a name="subnets-in-the-east-us-2-production-network-vnet-prod-eus2"></a>Подсети в `East US 2` рабочей сети ( `VNET-PROD-EUS2` )

Компоненты Azure IaaS находятся в рабочей сети. Каждый уровень приложения имеет собственную подсеть. Подсети соответствуют параметрам в сети разработки с добавлением подсети для контроллеров домена.

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `PROD-FE-EUS2` | `10.245.32.0/22` | 1019 | Внешние интерфейсы и виртуальные машины веб-уровня |
| `PROD-APP-EUS2` | `10.245.36.0/22` | 1019 | Виртуальные машины уровня приложений |
| `PROD-DB-EUS2` | `10.245.40.0/23` | 507 | Виртуальные машины баз данных |
| `PROD-DC-EUS2` | `10.245.42.0/24` | 251 | Виртуальные машины контроллеров домена |

![Схема сетевой архитектуры концентратора.](./media/contoso-migration-infrastructure/azure-networks-eus2.png)

_Рис. 20. Архитектура сети концентратора._

#### <a name="virtual-networks-in-central-us-secondary-region"></a>Виртуальные сети в `Central US` (дополнительный регион)

`Central US` является дополнительным регионом contoso. Вот как компания Contoso спроектирует сети в этом регионе:

- **Центр:** Виртуальная сеть концентратора в `Central US` рассматривается как вторичная точка подключения к локальному центру обработки данных. Периферийные виртуальные сети в `Central US` можно использовать для изоляции рабочих нагрузок при необходимости, управляемых отдельно от других периферийных серверов.

- **Виртуальные сети:** Contoso будет иметь две виртуальные сети в `Central US` :
  - `VNET-PROD-CUS`— Это Рабочая сеть, которую можно рассматривать как вторичный концентратор.
  - `VNET-ASR-CUS`: Эта виртуальная сеть будет использоваться в качестве расположения, в котором виртуальные машины создаются после отработки отказа из локальной среды, или в качестве расположения для виртуальных машин Azure, которые отправляются из базы данных-источника в дополнительный регион. Эта сеть аналогична рабочим сетям, но без контроллеров домена.

  Каждая виртуальная сеть в регионе будет иметь свое адресное пространство без перекрытия. В Contoso настроят маршрутизацию без NAT.

- **Подсети:** Подсети будут спроектированы так же, как и в `East US 2` .

В следующей таблице перечислены виртуальные сети в `Central US` .

| Виртуальная сеть | Диапазон | Одноранговый узел |
| --- | --- | --- |
| `VNET-HUB-CUS` | `10.250.0.0/20` | `VNET-HUB-EUS2`, `VNET-ASR-CUS`, `VNET-PROD-CUS` |
| `VNET-ASR-CUS` | `10.255.16.0/20` | `VNET-HUB-CUS`, `VNET-PROD-CUS` |
| `VNET-PROD-CUS` | `10.255.32.0/20` | `VNET-HUB-CUS`, `VNET-ASR-CUS`, `VNET-PROD-EUS2` |

![Схема модели "звезда" в парном регионе.](./media/contoso-migration-infrastructure/paired-hub-peer.png)

_Рис. 21. модель-звезда в парном регионе._

#### <a name="subnets-in-the-central-us-hub-network-vnet-hub-cus"></a>Подсети в `Central US` сети центра ( `VNET-HUB-CUS` )

| Подсеть | CIDR | Пригодные для использования IP-адреса |
| --- | --- | --- |
| `IB-UntrustZone` | `10.250.0.0/24` | 251 |
| `IB-TrustZone` | `10.250.1.0/24` | 251 |
| `OB-UntrustZone` | `10.250.2.0/24` | 251 |
| `OB-TrustZone` | `10.250.3.0/24` | 251 |
| `GatewaySubnet` | `10.250.10.0/24` | 251 |

#### <a name="subnets-in-the-central-us-production-network-vnet-prod-cus"></a>Подсети в `Central US` рабочей сети ( `VNET-PROD-CUS` )

Параллельно с рабочей сетью в основном регионе ( `East US 2` ) есть рабочая сеть в дополнительном регионе ( `Central US` ).

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `PROD-FE-CUS` | `10.255.32.0/22` | 1019 | Внешние интерфейсы и виртуальные машины веб-уровня |
| `PROD-APP-CUS` | `10.255.36.0/22` | 1019 | Виртуальные машины уровня приложений |
| `PROD-DB-CUS` | `10.255.40.0/23` | 507 | Виртуальные машины баз данных |
| `PROD-DC-CUS` | `10.255.42.0/24` | 251 | Виртуальные машины контроллеров домена |

#### <a name="subnets-in-the-central-us-failoverrecovery-network-vnet-asr-cus"></a>Подсети в `Central US` сети отработки отказа или восстановления ( `VNET-ASR-CUS` )

`VNET-ASR-CUS`Сеть используется для отработки отказа между регионами. Для репликации и отработки отказа виртуальных машин Azure между регионами будет использоваться Site Recovery. Она также работает как центр обработки данных Contoso в сети Azure для защищенных рабочих нагрузок, которые остаются в локальной среде, но отработки отказа в Azure для аварийного восстановления.

`VNET-ASR-CUS` — Это та же самая базовая подсеть, что и Рабочая виртуальная сеть, в которой `East US 2` нет необходимости в подсети контроллера домена.

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `ASR-FE-CUS` | `10.255.16.0/22` | 1019 | Внешние интерфейсы и виртуальные машины веб-уровня |
| `ASR-APP-CUS` | `10.255.20.0/22` | 1019 | Виртуальные машины уровня приложений |
| `ASR-DB-CUS` | `10.255.24.0/23` | 507 | Виртуальные машины баз данных |

![Схема сетевой архитектуры концентратора.](./media/contoso-migration-infrastructure/azure-networks-cus.png)

_Рис. 22. Архитектура сети концентратора._

#### <a name="configure-peered-connections"></a>Настройка пириговых подключений

Центр в каждом регионе будет соединен с концентратором в другом регионе и ко всем виртуальным сетям в центральном регионе. Эта конфигурация позволяет концентраторам обмениваться данными и просматривать все виртуальные сети в регионе. Обратите внимание, что пиринг создает двустороннее подключение. Первый — от инициирующего узла в первой виртуальной сети, а другой — во второй виртуальной сети.

При гибридном развертывании трафик между кэширующими узлами должен быть доступен через VPN-подключение между локальным центром обработки данных и Azure. Чтобы включить эту возможность, компания Contoso должна использовать определенные параметры для одноранговых соединений. Для подключений из периферийных виртуальных сетей через центр к локальному центру обработки данных компания Contoso должна разрешить перенаправление трафика и переключать VPN-шлюзы.

##### <a name="domain-controller"></a>Контроллер домена

Для контроллеров домена в `VNET-PROD-EUS2` сети компания Contoso хочет, чтобы трафик находящегося между `EUS2` основной или рабочей сетью и VPN-подключением к локальной среде. Для этого администраторы Contoso должны иметь следующие разрешения:

1. Специалисты компании должны **разрешить переадресацию трафика** и **разрешить конфигурации с транзитом через шлюз** для пирингового соединения. В нашем примере это соединение с `VNET-HUB-EUS2` `VNET-PROD-EUS2` .

    ![Снимок экрана, на котором показаны выбранные флажки для разрешения перенаправленного трафика и разрешения транзита шлюза.](./media/contoso-migration-infrastructure/peering1.png)

    _Рис. 23. соединение с одноранговым подключением._

2. **Разрешить перенаправленный трафик** и **использовать удаленные шлюзы** на другой стороне пиринга в соединении от `VNET-PROD-EUS2` к `VNET-HUB-EUS2` .

    ![Снимок экрана, на котором показаны выбранные флажки для разрешения перенаправленного трафика и использования удаленных шлюзов.](./media/contoso-migration-infrastructure/peering2.png)

    _Рис. 24. соединение с одноранговым подключением._

3. В локальной среде они настраивают статический маршрут, который направляет локальный трафик для маршрутизации через VPN-туннель в виртуальную сеть. Настройка завершена на шлюзе, который предоставляет VPN-туннель из Contoso в Azure. Они используют службу маршрутизации и удаленного доступа (RRAS) для статического маршрута.

    ![Снимок экрана, на котором показаны параметры статического маршрута.](./media/contoso-migration-infrastructure/peering3.png)

    _Рис. 25. соединение с одноранговым подключением._

##### <a name="production-networks"></a>Рабочие сети

Из периферийной одноранговой сети невозможно получить доступ к периферийной одноранговой сети в другом регионе через концентратор. Для рабочих сетей Contoso в обоих регионах для просмотра друг друга администраторы Contoso должны создать прямое одноранговое соединение для `VNET-PROD-EUS2` и `VENT-PROD-CUS` .

![Схема создания прямого однорангового соединения.](./media/contoso-migration-infrastructure/peering4.png)

_Рис. 26. Создание прямого однорангового подключения._

### <a name="set-up-dns"></a>Настройка DNS

При развертывании ресурсов в виртуальных сетях можно выбрать один из нескольких вариантов разрешения доменных имен. Вы можете использовать разрешение имен, предоставляемое Azure, или предоставить DNS-серверы для разрешения. Тип используемого разрешения имен зависит от того, как ресурсы должны взаимодействовать друг с другом. Дополнительные сведения о службе Azure DNS см. в этой [статье](/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#azure-provided-name-resolution).

Администраторы Contoso решили, что служба Azure DNS не подходит для гибридной среды. Вместо этого они будут использовать локальные DNS-серверы. Дополнительные сведения:

- Так как это гибридная сеть, все виртуальные машины в локальной среде и в Azure должны иметь возможность разрешения имен для правильной работы. Это означает, что пользовательские параметры DNS должны быть применены ко всем виртуальным сетям.
- В настоящее время Contoso имеет контроллеры домена, развернутые в центре обработки данных Contoso и в филиалах. Основные DNS-серверы: `contosodc1` ( `172.16.0.10` ) и `contosodc2` ( `172.16.0.1` ).
- После развертывания виртуальных сетей локальные контроллеры домена настраиваются в сети как DNS-серверы.
- Если для виртуальной сети указан необязательный настраиваемый DNS-сервер, виртуальный IP-адрес `168.63.129.16` для рекурсивных арбитров конфликтов в Azure должен быть добавлен в список. Для этого Contoso настраивает параметры DNS-сервера в каждой виртуальной сети. Например, настраиваемые параметры DNS для сети будут выглядеть `VNET-HUB-EUS2` следующим образом:

    ![Снимок экрана, показывающий конфигурацию пользовательского DNS.](./media/contoso-migration-infrastructure/custom-dns.png)

    _Рис. 27. Пользовательская служба DNS._

В дополнение к локальным контроллерам домена компания Contoso будет реализовывать четыре контроллера домена для поддержки сетей Azure (по двум для каждого региона):

| Регион | DC | Виртуальная сеть | Подсеть | IP-адрес |
| --- | --- | --- | --- | --- |
| `East US 2` | `contosodc3` | `VNET-PROD-EUS2` | `PROD-DC-EUS2` | `10.245.42.4` |
| `East US 2` | `contosodc4` | `VNET-PROD-EUS2` | `PROD-DC-EUS2` | `10.245.42.5` |
| `Central US` | `contosodc5` | `VNET-PROD-CUS` | `PROD-DC-CUS` | `10.255.42.4` |
| `Central US` | `contosodc6` | `VNET-PROD-CUS` | `PROD-DC-CUS` | `10.255.42.4` |

После развертывания контроллеров домена в локальной среде специалистам Contoso необходимо обновить параметры DNS в сетях обоих регионов, чтобы включить новые контроллеры домена в список DNS-серверов.

#### <a name="set-up-domain-controllers-in-azure"></a>Настройка контроллеров домена в Azure

После обновления параметров сети администраторы Contoso могут приступать к созданию контроллеров домена в Azure.

1. В портал Azure они развертывают новую виртуальную машину Windows Server в соответствующей виртуальной сети.
2. Они [создают группы доступности](/azure/virtual-machines/windows/tutorial-availability-sets) в каждом расположении для виртуальной машины. Группы доступности гарантируют, что структура Azure разделяет виртуальные машины на разные инфраструктуры в регионе Azure. Группы доступности также позволяют Contoso иметь право на поддержку соглашения об уровне обслуживания (SLA) 99,95% для виртуальных машин в Azure.

    ![Снимок экрана, на котором показано создание группы доступности.](./media/contoso-migration-infrastructure/availability-group.png)

    _Рис. 28. Группа доступности._

3. После развертывания виртуальной машины сотрудники компании настраивают для нее сетевой интерфейс. Они устанавливают для частного IP-адреса значение static и указывают допустимый адрес.

    ![Снимок экрана, на котором показано подключение к сетевому интерфейсу виртуальной машины.](./media/contoso-migration-infrastructure/vm-nic.png)

    _Рис. 29. Сетевая карта виртуальной машины._

4. Они присоединяют новый диск данных к виртуальной машине. Этот диск содержит Active Directoryную базу данных и общую папку SYSVOL.

   От размера диска зависит поддерживаемое количество операций ввода-вывода. Со временем размер диска может увеличиваться по мере роста среды.

   > [!NOTE]
   > Диск не должен быть установлен на чтение и запись для кэширования узла. Базы данных Active Directory это не поддерживают.

   ![Снимок экрана, на котором показан диск Active Directory.](./media/contoso-migration-infrastructure/ad-disk.png)

   _Рис. 30. Active Directory диск._

5. После добавления диска он подключается к виртуальной машине службы удаленных рабочих столов и открывает диспетчер сервера.

6. В **службах файлов и хранения** они запускают мастер создания тома. Они гарантируют, что диску назначена буква F или выше на локальной виртуальной машине.

    ![Снимок экрана, на котором показан мастер создания тома.](./media/contoso-migration-infrastructure/volume-wizard.png)

    _Рис. 31. Мастер создания тома._

7. В диспетчере сервера сотрудники компании выбирают роль **Доменные службы Active Directory**. Затем они настраивают виртуальную машину в качестве контроллера домена.

    ![Снимок экрана, на котором показано, как выбрать роль сервера.](./media/contoso-migration-infrastructure/server-role.png)

    _Рис. 32. Добавление роли сервера._

8. После настройки виртуальной машины в качестве контроллера домена и ее перезапуска откройте диспетчер DNS и настройте сопоставитель Azure DNS в качестве сервера пересылки. Это позволяет контроллеру домена переадресовывать в Azure DNS запросы DNS, которые он не может разрешить.

    ![Снимок экрана, показывающий настройку сопоставителя DNS в качестве сервера пересылки.](./media/contoso-migration-infrastructure/dns-forwarder.png)

    _Рис. 33. Настройка распознавателя Azure DNS._

9. Они обновляют пользовательские параметры DNS для каждой виртуальной сети с соответствующим контроллером домена для региона виртуальной сети. Поэтому сотрудники компании добавляют в список локальные контроллеры домена.

### <a name="set-up-active-directory"></a>настроить Active Directory;

Active Directory является критической службой для сети и должна быть правильно настроена. Администраторы Contoso будут создавать сайты Active Directory для центра обработки данных Contoso и для `East US 2` `Central US` регионов и.

1. Они создают два новых сайта ( `AZURE-EUS2` и `AZURE-CUS` ) вместе с сайтом центра обработки данных ( `contoso-datacenter` ).
2. После создания сайтов они создают подсети на сайтах для сопоставления с виртуальными сетями и центром обработки данных.

    ![Снимок экрана, на котором показано создание подсетей центра обработки данных.](./media/contoso-migration-infrastructure/dc-subnets.png)

    _Рис. 34. подсети центра обработки данных._

3. Они создают две связи сайтов для подключения ко всем. После этого контроллеры домена должны быть перемещены в необходимое расположение.

    ![Снимок экрана, на котором показано создание ссылок на центр обработки данных.](./media/contoso-migration-infrastructure/dc-links.png)

    _Рис. 35. ссылки на центр обработки данных._

4. Они подтверждают, что Active Directory топология репликации.

    ![Снимок экрана, на котором показана топология репликации центра обработки данных.](./media/contoso-migration-infrastructure/ad-resolution.png)

    _Рис. 36. репликация центра обработки данных._

После завершения всех действий список контроллеров домена и сайтов отображается в локальной центр администрирования Active Directory.

![Снимок экрана, на котором отображается центр администрирования Active Directory.](./media/contoso-migration-infrastructure/ad-center.png)

_Рис. 37. центр администрирования Active Directory._

## <a name="step-5-plan-for-governance"></a>Шаг 5. Планирование системы управления

Azure предоставляет ряд средств управления, которыми можно воспользоваться в различных службах и на платформе Azure. Дополнительные сведения см. в статье [Параметры управления Azure](/azure/governance/).

Так как она настраивает управление удостоверениями и доступом, компания Contoso уже начала разложить некоторые аспекты управления и безопасности. В общем, необходимо учитывать три области:

- **Политика:** Политика Azure применяет и применяет правила и эффекты к ресурсам, поэтому ресурсы соответствуют корпоративным требованиям и соглашениям об уровне обслуживания.
- **Блокировки:** Azure позволяет блокировать подписки, группы ресурсов и другие ресурсы, чтобы их можно было изменять только с помощью разрешений.
- **Теги:** Ресурсами можно управлять, проводить аудит и управлять ими с помощью тегов. Теги дают возможность связать метаданные ресурсами и предоставляют информацию о ресурсах или владельцах.

### <a name="set-up-policies"></a>Настройка политик

Служба политики Azure оценивает ресурсы путем проверки на соответствие определениям политик. Например, у вас может быть политика, которая допускает только определенные типы виртуальных машин или требует, чтобы ресурсы имели определенный тег.

Политики задают определение политики, а назначение политики определяет область ее применения. Область может варьироваться от группы управления до группы ресурсов. Узнайте, как [создавать политики и управлять ими](/azure/governance/policy/tutorials/create-and-manage).

Contoso хочет начать две политики. Требуется политика, чтобы обеспечить возможность развертывания ресурсов `East US 2` `Central US` только в регионах и. Также требуется политика для ограничения номеров SKU виртуальных машин только утвержденными номерами SKU. Это необходимо, чтобы избежать использования дорогостоящих конфигураций виртуальных машин.

#### <a name="limit-resources-to-regions"></a>Ограничение использования ресурсов в регионах

В Contoso используется встроенное определение политики **Разрешенные расположения**, ограничивающей использование ресурсов в регионах.

1. На портале Azure щелкните **Все службы** и выполните поиск по слову **Политика**.
2. Выберите **назначения**  >  **Назначение политики**.
3. Выберите в списке политик **Разрешенные расположения**.
4. В поле **область** укажите имя подписки Azure и выберите два региона в разрешенных.

    ![Снимок экрана, на котором показаны допустимые расположения, определенные с помощью политики.](./media/contoso-migration-infrastructure/policy-region.png)

    _Рис. 38. Допустимые расположения, определенные с помощью политики._

5. По умолчанию для политики задано значение **Deny**. Этот параметр означает, что если кто-то запускает развертывание в подписке, которая не находится в `East US 2` `Central US` регионе или, развертывание завершится ошибкой. Вот что произойдет, если кто-то в подписке Contoso попытается настроить развертывание в `West US` .

    ![Снимок экрана, показывающий ошибку в политике, завершившейся сбоем.](./media/contoso-migration-infrastructure/policy-failed.png)

    _Рис. 39. неудачная политика._

#### <a name="allow-specific-vm-skus"></a>Разрешение использования виртуальных машин с определенными номерами SKU

Contoso будет использовать встроенное определение политики `Allow virtual machine SKUs` для ограничения типов виртуальных машин, которые могут быть созданы в подписке.

![Снимок экрана, на котором показаны параметры SKU.](./media/contoso-migration-infrastructure/policy-sku.png)

_Рис. 40. номер SKU политики._

#### <a name="check-policy-compliance"></a>Проверка соответствия политикам

Политики вступают в силу незамедлительно, и Contoso может проверить ресурсы на соответствие. На портале Azure выберите ссылку **Соответствие требованиям**. Откроется панель мониторинга "Соответствие требованиям". Для получения дополнительных сведений можно выполнить детализацию.

![Снимок экрана, на котором показана панель мониторинга соответствия.](./media/contoso-migration-infrastructure/policy-compliance.png)

_Рис. 41. соответствие политике._

### <a name="set-up-locks"></a>Настройка блокировок

Для управления системами в Contoso длительное время используется платформа ITIL. Один из важнейших аспектов платформы — возможность управления изменениями, поэтому специалисты Contoso хотят непременно реализовать эту функцию в развертывании Azure.

Contoso [блокирует ресурсы](/azure/azure-resource-manager/management/lock-resources). Любой производственный или компонент отработки отказа должен находиться в группе ресурсов с блокировкой только для чтения. Это означает, что для изменения или удаления производственных элементов полномочные пользователи должны снять блокировку. Группы ресурсов, не являющиеся продукцией, будут иметь `CanNotDelete` блокировки. Это означает, что полномочные пользователи могут читать или изменять ресурсы, но не могут удалять их.

### <a name="set-up-tagging"></a>Настройка тегов

Для отслеживания ресурсов по мере их добавления все большую важность для Contoso будет приобретать возможность связать ресурсы с соответствующим отделом, клиентом и средой. Помимо предоставления сведений о ресурсах и владельцах, теги позволяют компании Contoso объединять и группировать ресурсы, а также использовать эти данные в целях обеспечения гибкости.

Компании Contoso необходимо визуализировать свои активы Azure способом, который имеет смысл для бизнеса, например для роли или отдела. Обратите внимание, что ресурсы, находящиеся в разных группах ресурсов, могут иметь одинаковый тег. Contoso создаст классификацию тегов, чтобы все могли использовать одни и те же теги.

| Имя тега | Значение |
| --- | --- |
| `CostCenter` | 12345: это должно быть допустимое место возникновения затрат из системы SAP. |
| `BusinessUnit` | Имя подразделения (из SAP). Совпадает с `CostCenter` . |
| `ApplicationTeam` | Псевдоним электронной почты команды, которой принадлежит поддержка для приложения. |
| `CatalogName` | Имя приложения или в `SharedServices` соответствии с каталогом услуг, поддерживаемым ресурсом. |
| `ServiceManager` | Псевдоним электронной почты ITIL Service Manager для ресурса. |
| `COBPriority` | Приоритет, установленный компанией для BCDR. Значения от 1 до 5. |
| `ENV` | `DEV`, `STG` и `PROD` являются допустимыми значениями, представляющими разработку, промежуточное хранение и рабочую среду. |

Пример:

![Снимок экрана, на котором показаны Теги Azure.](./media/contoso-migration-infrastructure/azure-tag.png)

_Рис. 42. Теги Azure._

После создания тега компания Contoso вернет и создаст новые определения и назначения политик, чтобы принудительно использовать необходимые теги в Организации.

## <a name="step-6-consider-security"></a>Шаг 6. Учет требований к безопасности

Безопасность в облаке играет критически важную роль, поэтому Azure предоставляет широкий спектр средств и возможностей обеспечения безопасности. Они помогают создавать безопасные решения на защищенной платформе Azure. Дополнительные сведения о безопасности Azure см. в разделе [доверие к облаку](https://azure.microsoft.com/overview/trusted-cloud/) .

Contoso следует учесть несколько аспектов:

- [Центр безопасности Azure](/azure/security-center/security-center-introduction) обеспечивает унифицированное управление безопасностью и Azure Advanced Threat Protection в гибридных облачных рабочих нагрузках. Используйте его для применения политик безопасности в рабочих нагрузках, для ограничения воздействия на угрозы и обнаружения атак и реагирования на них.
- [Группа безопасности сети (NSG)](/azure/virtual-network/network-security-groups-overview) фильтрует сетевой трафик на основе списка правил безопасности, которые разрешают или запрещают сетевой трафик к ресурсам, подключенным к виртуальным сетям в Azure.
- [Шифрование дисков Azure](/azure/security/fundamentals/encryption-atrest) — это возможность, которая позволяет шифровать диски виртуальных машин IaaS под управлением Windows и Linux.

### <a name="work-with-the-azure-security-center"></a>Работа с центром безопасности Azure

Компания Contoso ищет краткий обзор уровня безопасности своего нового гибридного облака, а именно его рабочих нагрузок Azure. Поэтому компания решила реализовать центр безопасности Azure со следующими возможностями:

- Централизованное управление политиками
- Непрерывная оценка
- Практические рекомендации

#### <a name="centralize-policy-management"></a>Централизация управления политиками

Благодаря централизованному управлению политиками Contoso обеспечит соответствие требованиям безопасности за счет централизованного управления политиками безопасности во всей среде. Она может просто и быстро реализовать политику, которая применяется ко всем ресурсам Azure.

![Снимок экрана, на котором показаны параметры политики безопасности.](./media/contoso-migration-infrastructure/security-policy.png)

_Рис. 43. Политика безопасности._

#### <a name="assess-security"></a>Оценка безопасности

Компания Contoso будет использовать преимущества непрерывной оценки безопасности, которая наблюдает за безопасностью компьютеров, сетей, хранилищ, данных и приложений, чтобы выявить потенциальные проблемы безопасности.

Центр безопасности анализирует состояние безопасности ресурсов вычислений, инфраструктуры и данных Contoso. Он также анализирует состояние безопасности приложений и служб Azure. Непрерывная оценка помогает операционной группе компании обнаружить потенциальные проблемы с безопасностью, в том числе системы без обновлений системы безопасности или открытые сетевые порты.

Contoso хочет убедиться, что все виртуальные машины защищены. Это поможет центр безопасности. Он проверяет работоспособность виртуальной машины и создает приоритетные и практические рекомендации по устранению уязвимостей системы безопасности до их использования.

![Снимок экрана, показывающий наблюдение за виртуальными машинами.](./media/contoso-migration-infrastructure/monitoring.png)

_Рис. 44. Мониторинг._

### <a name="work-with-nsgs"></a>Работа с группами безопасности сети

Компания Contoso может ограничить сетевой трафик для ресурсов в виртуальной сети с помощью групп безопасности сети.

Группа безопасности сети содержит список правил безопасности, которые разрешают или запрещают входящий и исходящий трафик в зависимости от IP-адреса источника или назначения, порта и протокола. Если в подсети действуют правила, они применяются ко всем ее ресурсам. Помимо сетевых интерфейсов к ним относятся экземпляры служб Azure, развернутые в подсети.

Группы безопасности приложений (ASG) позволяют настроить сетевую безопасность как естественное расширение структуры приложения. Затем можно сгруппировать виртуальные машины и определить политики безопасности сети на основе этих групп.

Contoso может использовать ASG для повторного использования политики безопасности в масштабе без ручного обслуживания явных IP-адресов. Платформа отвечает за сложность явных IP-адресов и нескольких наборов правил, поэтому Организация может сосредоточиться на бизнес-логике. Компания Contoso может указать ASG в качестве источника и назначения в правиле безопасности. После определения политики безопасности компания Contoso может создавать виртуальные машины и назначать их группе.

Компания Contoso реализует сочетание групп безопасности сети и групп безопасности приложений. Руководителей компании волнует управление группами безопасности сети, Это также беспокоится о чрезмерном группы безопасности сети и повышенной сложности работы персонала. Ниже приведены действия специалистов Contoso:

- Весь входящий и исходящий трафик всех подсетей (Север/Юг) будет подвергаться правилу NSG, за исключением подсетей шлюза в сетях-концентраторах.
- Все брандмауэры или контроллеры домена будут защищены как подсеть группы безопасности сети, так и сетевая карта группы безопасности сети.
- Ко всем приложениям в рабочей среде будут применяться группы безопасности приложений.

Компания Contoso создала модель того, как эта конфигурация безопасности будет искать свои приложения.

![Схема модели безопасности contoso.](./media/contoso-migration-infrastructure/asg.png)

_Рис. 45. модель безопасности._

Группы безопасности сети, связанные с группами безопасности приложений, будут настроены с наименьшими разрешениями. Благодаря этому из одной части сети в другую смогут передаваться только разрешенные пакеты.

| Действие | Имя | Источник | Назначение | Порт |
| --- | --- | --- | --- | --- |
| `Allow` | `AllowInternetToFE` | `VNET-HUB-EUS1`/`IB-TrustZone` | `APP1-FE` | 80, 443 |
| `Allow` | `AllowWebToApp` | `APP1-FE` | `APP1-APP` | 80, 443 |
| `Allow` | `AllowAppToDB` | `APP1-APP` | `APP1-DB` | 1433 |
| `Deny`  | `DenyAllInbound` | Любой | Любой | Любой |

### <a name="encrypt-data"></a>Шифрование данных

Шифрование дисков Azure интегрируется с Azure Key Vault для управления ключами и секретами шифрования дисков для подписки. Это гарантирует, что все данные на дисках виртуальной машины шифруются при хранении в службе хранилища Azure.

Contoso определила, что определенные виртуальные машины требуют шифрования. Contoso будет применять шифрование к виртуальным машинам с клиентами, конфиденциальными или личными данными.

## <a name="conclusion"></a>Заключение

В этой статье компания Contoso настроила инфраструктуру Azure и политику для подписки Azure, гибридное определение, аварийное восстановление, сеть, управление и безопасность.

Не все действия, которые необходимо выполнить, необходимы для миграции в облако. В этом случае компания Contoso запланировала сетевую инфраструктуру, которая может выполнять все виды миграций, в то время как безопасность, устойчивость и масштабируемость.

## <a name="next-steps"></a>Дальнейшие действия

После настройки инфраструктуры Azure компания Contoso готова начать перенос рабочих нагрузок в облако. В разделе [Общие сведения о шаблонах и примерах миграции приведены примеры](./contoso-migration-overview.md#windows-server-workloads) сценариев, использующих этот пример инфраструктуры в качестве цели миграции.
