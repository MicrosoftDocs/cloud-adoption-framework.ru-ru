---
title: Развертывание инфраструктуры миграции
description: Изучите пример, как настроить инфраструктуру Azure для миграции в Azure, используя платформу внедрения облачных технологий для Azure.
author: BrianBlanchard
ms.author: brblanch
ms.date: 10/1/2018
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: a5eb582f994aee6869f9bec0a340b2a966cf1413
ms.sourcegitcommit: 388e32dd4861039149c846c926c0e9230cf28ae3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79140677"
---
<!-- cSpell:ignore CSPs domainname IPAM CIDR Untrust RRAS CONTOSODC sysvol ITIL NSGs ASGs -->

# <a name="deploy-a-migration-infrastructure"></a>Развертывание инфраструктуры миграции

В этой статье описывается, как вымышленная компания Contoso подготавливает свою локальную инфраструктуру к миграции, настраивает инфраструктуру Azure в ходе подготовки к миграции и ведет деловую деятельность в гибридной среде. При использовании этого примера для планирования собственных процессов миграции инфраструктуры учитывайте следующее.

- Архитектура приведенного примера соответствует компании Contoso. Пересмотрите бизнес-потребности, структуру и технические требования своей организации при принятии важных решений об инфраструктуре, касающихся проектирования подписок или сетевой архитектуры.
- Возможно, вам понадобятся не все элементы, описанные в этой статье. Это зависит от стратегии миграции. Например, если Azure используется только для разработки приложений, созданных для облака, возможно, потребуется менее сложная структура сети.

## <a name="overview"></a>Обзор

Перед миграцией в Azure важно подготовить инфраструктуру Azure. Как правило, для этого необходимо уделить особое внимание шести аспектам.

> [!div class="checklist"]
>
> - **Шаг 1. подписки Azure.** Как компания Contoso приобретет платформу и службы Azure и как будет взаимодействовать с ними?
> - **Шаг 2. Гибридная идентификация.** Как будет осуществляться управление доступом к ресурсам Azure и локальным ресурсам после миграции? Как обеспечить поддержку управления идентификацией в облаке или полностью перейти на такое управление?
> - **Шаг 3. аварийное восстановление и устойчивость.** Как в компании Contoso будет обеспечиваться отказоустойчивость приложений и инфраструктуры в случае сбоев и аварийных ситуаций?
> - **Шаг 4. Работа в сети.** Как спроектировать сетевую инфраструктуру и установить соединение между локальным центром обработки данных и Azure?
> - **Шаг 5. безопасность.** Как будет обеспечиваться безопасность развертывания в гибридной среде и в Azure?
> - **Шаг 6. Управление.** Как Contoso будет поддерживать соответствие развертывания требованиям безопасности и системы управления?

## <a name="before-you-start"></a>Перед началом работы

Возможно, прежде чем приступить к изучению инфраструктуры, было бы нелишним получить общее представление о возможностях Azure, которые мы будем обсуждать в этой статье.

- Доступно несколько вариантов приобретения доступа к Azure, в числе которых Оплата по мере использования, Соглашение Enterprise и открытая лицензия от торговых посредников или партнеров корпорации Майкрософт (так называемых поставщиков облачных решений, или CSP). Узнайте больше о [вариантах приобретения](https://azure.microsoft.com/pricing/purchase-options) и [структуре подписок Azure](https://azure.microsoft.com/blog/organizing-subscriptions-and-resource-groups-within-the-enterprise).
- Получите общее представление об [управлении удостоверениями и доступом](https://www.microsoft.com/trustcenter/security/identity) в Azure. В частности, изучите [возможности Azure AD и расширение локальной службы Active Directory для работы в облаке](https://docs.microsoft.com/azure/active-directory/identity-fundamentals). Вы можете загрузить полезную электронную книгу, посвященную [управлению удостоверениями и доступом в гибридной среде](https://azure.microsoft.com/resources/hybrid-cloud-identity).
- Azure предоставляет надежную сетевую инфраструктуру с различными вариантами гибридных подключений. Получите общее представление о [сетевых возможностях и управлении доступом к сети](https://docs.microsoft.com/azure/security/security-network-overview).
- Ознакомьтесь с основами обеспечения [безопасности Azure](https://docs.microsoft.com/azure/security/azure-security) и создания плана [управления](https://docs.microsoft.com/azure/security/governance-in-azure).

## <a name="on-premises-architecture"></a>Локальная архитектура

На схеме ниже показана текущая локальная инфраструктура компании Contoso.

 ![Архитектура Contoso](./media/contoso-migration-infrastructure/contoso-architecture.png)

- У Contoso есть один основной центр обработки данных в Нью-Йорке (на востоке США).
- У компании есть еще три местных филиала на территории США.
- Главный центр обработки данных подключен к Интернету по оптоволоконному соединению Metro Ethernet (500 Мбит/с).
- Каждый филиал подключен локально к Интернету с помощью соединения бизнес-класс и применяет VPN-туннели IPSec для передачи данных в основной центр обработки данных. Это обеспечивает стабильное соединение всей сети и оптимизацию подключения к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. У компании Contoso есть два узла виртуализации ESXi 6.5 под управлением vCenter Server 6.5.
- Для управления удостоверениями в Contoso используется Active Directory, а во внутренней сети применяются DNS-серверы.
- Контроллеры домена в центре обработки данных работают на виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.

## <a name="step-1-buy-and-subscribe-to-azure"></a>Шаг 1. Приобретение Azure и оформление подписки

Contoso необходимо выяснить, как приобрести Azure, разработать подписки и лицензировать службы и ресурсы.

### <a name="buy-azure"></a>Приобретение Azure

Contoso собирается заключить [Соглашение Enterprise (EA)](https://azure.microsoft.com/pricing/enterprise-agreement). В связи с этим компании необходимо заплатить аванс за использование Azure, что, в свою очередь, дает компании Contoso значительные преимущества, в том числе гибкие варианты оплаты и оптимальные цены.

- В Contoso оценили ежегодные затраты на Azure. При подписании соглашения компания Contoso заплатила за первый год в полном объеме.
- Ей необходимо использовать всю сумму аванса до окончания этого года, иначе компания просто потеряет эти деньги.
- Если по какой-либо причине затраты компании превысят размер авансового платежа, корпорация Майкрософт выставит ей счета на эту разницу.
- Тарифы по всем расходам свыше авансовой суммы остаются такими же, как указано в контракте с Contoso. Штраф за превышение отсутствует.

### <a name="manage-subscriptions"></a>Управление подписками

После оплаты Azure Contoso необходимо разобраться, как управлять подписками Azure. Компания Contoso заключила Соглашение Enterprise, поэтому она может настроить неограниченное количество подписок Azure.

- Порядок формирования и использования служб Azure в компании и основная структура управления определяются Соглашением о регистрации Azure Enterprise.
- Для начала компания Contoso определила структуру (так называемый корпоративный каркас) для Соглашения о регистрации Enterprise. Компания Contoso использовала [руководство по формированию шаблонов Azure Enterprise](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-subscription-governance) , чтобы помочь понять и спроектировать шаблон.
- На данном этапе в Contoso решили использовать для управления подписками функциональный подход.
  - У компании будет один отдел ИТ, управляющий бюджетом Azure. Это будет единственная группа с подписками.
  - В будущем компания Contoso расширит эту модель, чтобы к Соглашению о регистрации Enterprise могли также присоединиться другие отделы (корпоративные группы).
  - В ИТ-отделе у Contoso предусмотрено две подписки: рабочая и для разработки.
  - Если в будущем компании Contoso потребуются дополнительные подписки, ей придется управлять доступом, политиками и соответствием требованиям. Для этого будут внедрены [группы управления Azure](https://docs.microsoft.com/azure/azure-resource-manager/management-groups-overview), которые образуют дополнительный уровень над подписками.

  ![Структура предприятия](./media/contoso-migration-infrastructure/enterprise-structure.png)

### <a name="examine-licensing"></a>Изучение вариантов лицензирования

После настройки подписок Contoso может переходить к вопросу лицензирования продуктов корпорации Майкрософт. Стратегия лицензирования будет зависеть от ресурсов, которые Contoso хочет перенести в Azure, а также от выбора и развертывания виртуальных машин и служб Azure.

#### <a name="azure-hybrid-benefit"></a>Преимущество гибридного использования Azure

При развертывании виртуальных машин в Azure стандартные образы включают лицензию, по которой плата за использование программ будет взиматься с Contoso поминутно. Тем не менее компания Contoso — давний клиент корпорации Майкрософт, и у нее есть соглашения EA и Open License с программой Software Assurance (SA).

Преимущество гибридного использования Azure позволяет компании Contoso воспользоваться выгодным методом миграции, обеспечивающим экономию на виртуальных машинах Azure и рабочих нагрузках SQL Server за счет преобразования или повторного использования лицензий на выпуски Windows Server Datacenter и Standard, на которые распространяется действие программы Software Assurance. Это дает Contoso возможность платить за вычислительные ресурсы для виртуальных машин и SQL Server по более низкому тарифу. [Дополнительные сведения](https://azure.microsoft.com/pricing/hybrid-benefit)

#### <a name="license-mobility"></a>Перемещение лицензий

Перемещение лицензий в рамках программы SA позволяет клиентам корпоративного лицензирования Майкрософт разворачивать разрешенные серверные приложения на платформе Azure при наличии действующего покрытия SA. Это избавляет от необходимости приобрести новые лицензии. Поскольку за перемещение плата не взимается, имеющиеся лицензии можно легко развернуть в Azure. [Дополнительные сведения](https://azure.microsoft.com/pricing/license-mobility)

#### <a name="reserve-instances-for-predictable-workloads"></a>Зарезервированные экземпляры для прогнозируемых рабочих нагрузок

Прогнозируемыми называются рабочие нагрузки, которые всегда должны быть доступны на работающих виртуальных машинах. Например, бизнес-приложения, такие как система SAP ERP. С другой стороны, непредсказуемые рабочие нагрузки — это переменные рабочие нагрузки, например виртуальные машины, включаемые в периоды высокой нагрузки и отключаемые, когда нагрузка небольшая.

![Зарезервированный экземпляр](./media/contoso-migration-infrastructure/reserved-instance.png)

Использование зарезервированных экземпляров тех виртуальных машин, обслуживание которых всегда занимает много времени, позволяет Contoso не только воспользоваться скидкой, но и выделять ресурсы в порядке приоритета. Благодаря использованию [зарезервированных экземпляров Azure](https://azure.microsoft.com/pricing/reserved-vm-instances) в сочетании с Преимуществом гибридного использования Azure Contoso может сэкономить до 82 % от суммы регулярной оплаты по мере использования (по состоянию на апрель 2018 г.).

## <a name="step-2-manage-hybrid-identity"></a>Шаг 2. Управление гибридными удостоверениями

Предоставление пользователям контролируемого доступа к ресурсам Azure с помощью Системы управления идентификацией и доступом (IAM) — важный шаг на пути к объединению инфраструктуры Azure.

- В Contoso решают расширить свою локальную службу Active Directory для работы в облачной среде, а не создавать отдельную систему в Azure.
- Для этого создается служба Active Directory на основе Azure.
- У компании Contoso нет подписки на Office 365, поэтому ей нужно подготовить к работе новый экземпляр Azure AD.
- Office 365 использует Azure AD для управления пользователями. Если бы компания Contoso использовала Office 365, у нее уже был бы клиент Azure AD и она могла бы использовать его в качестве основного каталога.
- Ознакомьтесь со статьями [Идентификация в Office 365 и Azure Active Directory](https://support.office.com/article/understanding-office-365-identity-and-azure-active-directory-06a189e7-5ec6-4af2-94bf-a22ea225a7a9) и [Как связать или добавить подписку Azure в Azure Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-how-subscriptions-associated-directory).

### <a name="create-an-azure-ad"></a>Создание Azure AD

Contoso использует выпуск Azure AD Free, который предоставляется вместе с подпиской Azure. Администраторы Contoso настраивают каталог следующим образом.

1. На [портале Azure](https://portal.azure.com) они выбирают пункты **Создать ресурс** > **Удостоверение** > **Azure Active Directory**.
2. В окне **Создание каталога** они указывают имя каталога, первоначальное доменное имя и регион, где необходимо создать каталог Azure AD.

    ![Создание Azure AD](./media/contoso-migration-infrastructure/azure-ad-create.png)

    > [!NOTE]
    > Первоначальное имя создаваемого каталога представлено в формате **доменное_имя.onmicrosoft.com**. Это имя нельзя изменить или удалить. Вместо этого необходимо добавить свое зарегистрированное доменное имя в Azure AD.

### <a name="add-the-domain-name"></a>Добавление доменного имени

Чтобы использовать стандартное доменное имя, администраторам Contoso необходимо добавить его в качестве имени личного домена в Azure AD. Эта возможность позволяет им назначать привычные имена пользователей. Например, пользователь может выполнить вход с использованием адреса электронной почты billg@contoso.com вместо billg@contosomigration.microsoft.com.

Для настройки имени личного домена следует добавить его в каталог, добавить запись DNS и проверить имя в Azure AD.

1. Чтобы добавить домен, специалисты компании выбирают **Пользовательские доменные имена** > **Добавить личный домен**.
2. Чтобы использовать запись DNS в Azure, они регистрируют ее у своего регистратора доменных имен.

    - При этом они записывают сведения о DNS для этого имени, указанные в списке **Имена пользовательских доменов**. Используется запись MX.
    - Для этого компании необходим доступ к DNS-серверу. Они входят в домен Contoso.com и создают запись MX для записи DNS, предоставленной службой Azure AD, используя записанные сведения.

3. После распространения записей DNS в окне сведений об имени они нажимают кнопку **Проверить** для проверки имени личного домена.

     ![DNS в Azure AD](./media/contoso-migration-infrastructure/azure-ad-dns.png)

### <a name="set-up-on-premises-and-azure-groups-and-users"></a>Настройка локальной среды, а также групп и пользователей Azure

После подготовки Azure AD администраторам Contoso необходимо добавить сотрудников в локальные группы Active Directory, которые будут синхронизироваться с Azure Active Directory. Им следует использовать имена локальных групп, которые соответствуют именам групп ресурсов в Azure. Это упрощает определение совпадений в целях синхронизации.

#### <a name="create-resource-groups-in-azure"></a>Создание групп ресурсов в Azure

Группы ресурсов Azure объединяют ресурсы Azure. Идентификатор группы ресурсов позволяет выполнять операции с ресурсами в пределах группы.

- Подписка Azure может иметь несколько групп ресурсов, но группа ресурсов может существовать только в одной подписке.
- Кроме того, у одной группы ресурсов может быть несколько ресурсов, но ресурс может принадлежать только к одной группе.

Общие сведения о том, как администраторы компании Contoso настроили группы ресурсов Azure, представлены в приведенной ниже таблице.

<!-- markdownlint-disable MD033 -->

**группа ресурсов** | **Сведения**
--- | ---
**ContosoCobRG** | Эта группа содержит все ресурсы, связанные с непрерывностью бизнеса (COB). Она включает хранилища, которые Contoso будет использовать для службы Azure Site Recovery, и службу Azure Backup.<br/><br/> В нее также входят ресурсы, используемые для переноса, в том числе Миграция Azure и Azure Database Migration Service.
**ContosoDevRG** | Эта группа содержит ресурсы для разработки и тестирования.
**ContosoFailoverRG** | Эта группа служит площадкой для размещения ресурсов, используемых для выполнения отработки отказа.
**ContosoNetworkingRG** | Эта группа содержит все сетевые ресурсы.
**ContosoRG** | Эта группа содержит ресурсы, связанные с приложениями и базами данных в рабочей среде.

<!-- markdownlint-disable MD026 -->

Группы ресурсов в Azure создаются в соответствии с описанной ниже процедурой.

1. На портале Azure нужно выбрать **Группы ресурсов** и добавить группу.
2. Для каждой группы следует указать имя, подписку, к которой принадлежит группа, и регион.
3. Группы ресурсов отображаются в списке **Группы ресурсов**.

    ![Группы ресурсов](./media/contoso-migration-infrastructure/resource-groups.png)

##### <a name="scale-resource-groups"></a>Масштабирование групп ресурсов

В будущем специалисты Contoso будут добавлять другие группы ресурсов по мере необходимости. Например, они могут определить группу ресурсов для каждого приложения или каждой службы, чтобы независимо контролировать и защищать их.

#### <a name="create-matching-security-groups-on-premises"></a>Создание соответствующих групп безопасности в локальной среде

1. В локальной службе Active Directory администраторы Contoso настраивают группы безопасности, имена которых соответствуют именам групп ресурсов в Azure.

    ![Локальные группы безопасности Active Directory](./media/contoso-migration-infrastructure/on-prem-ad.png)

2. Для управления создаются дополнительные группы, которые будут добавлены во все остальные группы. У этой группы будут права для всех групп ресурсов в Azure. В нее будет добавлено ограниченное число глобальных администраторов.

### <a name="synchronize-active-directory"></a>Синхронизация Active Directory

Contoso требуется предоставить общее удостоверение для доступа к ресурсам в локальной среде и в облаке. Для этого необходимо интегрировать локальную службу Active Directory с Azure AD. В рамках этой модели:

- пользователи и организации могут использовать единое удостоверение для доступа к локальным приложениям и облачным службам, например Office 365, или тысяче других сайтов в Интернете;
- администраторы могут использовать группы в Active Directory для реализации [управления доступом на основе ролей (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal) в Azure.

Для упрощения интеграции Contoso использует [средство Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect). Если установить и настроить это средство на контроллере домена, оно синхронизирует локальные удостоверения Active Directory с Azure AD.

### <a name="download-the-tool"></a>Скачивание средства

1. На портале Azure администраторы Contoso выбирают **Azure Active Directory** > **Azure AD Connect** и загружают последнюю версию средства на сервер, используемый для синхронизации.

    ![Загрузка Azure AD Connect](./media/contoso-migration-infrastructure/download-ad-connect.png)

2. Они начинают установку **AzureADConnect.msi** и выбирают параметр **Использовать быстрые параметры**. Это наиболее распространенный вариант установки, который может применяться для топологии с одним лесом и предполагает использование синхронизации хэша паролей для проверки подлинности.

    ![Мастер Azure AD Connect](./media/contoso-migration-infrastructure/ad-connect-wiz1.png)

3. В окне **Подключение к Azure AD** специалисты компании определяют учетные данные для подключения к Azure AD (в формате admin@contoso.com или admin@contoso.onmicrosoft.com).

    ![Мастер Azure AD Connect](./media/contoso-migration-infrastructure/ad-connect-wiz2.png)

4. В окне **Подключение к Azure AD** они указывают учетные данные для локальной службы Active Directory (в формате CONTOSO\admin или contoso.com\admin).

     ![Мастер Azure AD Connect](./media/contoso-migration-infrastructure/ad-connect-wiz3.png)

5. В окне **Готово к настройке** они выбирают **Запустить синхронизацию сразу после завершения настройки**, чтобы незамедлительно начать синхронизацию. Затем они устанавливают средство.

Обратите внимание на следующее.

- У Contoso есть прямое подключение к Azure. Если локальная служба Active Directory работает через прокси-сервер, прочитайте эту [статью](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-troubleshoot-connectivity).

- После первой синхронизации локальные объекты Active Directory отображаются в каталоге Azure AD.

    ![Локальная служба Active Directory в Azure](./media/contoso-migration-infrastructure/on-prem-ad-groups.png)

- ИТ-отдел Contoso представлен в каждой группе в соответствии со своей ролью.

    ![Локальные члены Active Directory в Azure](./media/contoso-migration-infrastructure/on-prem-ad-group-members.png)

### <a name="set-up-rbac"></a>Настройка RBAC

[Контроль доступа на основе ролей (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal) Azure обеспечивает точное управление доступом в Azure. С помощью RBAC можно предоставлять пользователям именно такой уровень доступа, который необходим для выполнения поставленных перед ними задач. Вы назначаете соответствующую роль RBAC пользователям, группам и приложениям на уровне области. Областью назначения роли может быть подписка, группа ресурсов или отдельный ресурс.

Теперь администраторы Contoso назначают роли группам Active Directory, синхронизированным из локальной среды.

1. В группе ресурсов **ControlCobRG** они выбирают **Управление доступом (IAM)**  > **Добавить назначение ролей**.
2. Они щелкают **Добавить назначение ролей** > **Роль** > **Участник**, а затем выбирают из списка группу **ContosoCobRG**. После этого группа появляется в списке **Выбранные элементы**.
3. Специалисты компании повторяют это действие с теми же разрешениями для других групп ресурсов (за исключением **ContosoAzureAdmins**) и добавляют разрешения "Участник" для учетной записи, соответствующие группе ресурсов.
4. Группе **ContosoAzureAdmins** они назначают роль **Владелец**.

    ![Локальные члены Active Directory в Azure](./media/contoso-migration-infrastructure/on-prem-ad-groups.png)

## <a name="step-3-design-for-resiliency"></a>Шаг 3. Проектирование для обеспечения устойчивости

### <a name="set-up-regions"></a>Настройка регионов

Ресурсы Azure развертываются в пределах регионов.

- Регионы образуют географические области, что гарантирует соблюдение требований к хранению и независимости данных, соответствию нормам и устойчивости в определенных географических границах.
- Регион состоит из совокупности центров обработки данных. Эти центры обработки данных развертываются в пределах периметра с определенной задержкой и соединяются между собой выделенной региональной сетью с низкой задержкой.
- Для обеспечения устойчивости каждый регион Azure связывается с другим регионом.
- Просмотрите дополнительные сведения о [регионах Azure](https://azure.microsoft.com/global-infrastructure/regions) и [связывании областей](https://docs.microsoft.com/azure/best-practices-availability-paired-regions).

В Contoso выбрали в качестве основного региона восточную часть США 2 (находится в Вирджинии), а в качестве дополнительного — центральную часть США (находится в Айове). Такой выбор был сделан по ряду причин.

- Центр обработки данных Contoso находится в Нью-Йорке, поэтому учитывалась задержка при передаче данных в ближайший центр обработки данных.
- В регионе "Восточная часть США 2" имеются все необходимые компании Contoso службы и продукты. Продукты и службы, доступные в различных регионах Azure, могут отличаться. Подробные сведения об этом приведены в статье [Доступность продуктов по регионам](https://azure.microsoft.com/global-infrastructure/services).
- В Azure регион "Центральная часть США" связан с регионом "Восточная часть США 2".

При проектировании гибридной среды специалистам Contoso необходимо учитывать то, как стратегия обеспечения устойчивости и аварийного восстановления впишется в структуру региона. Перед компанией отрываются широкие возможности для выбора стратегии: от развертывания в одном регионе на базе таких возможностей платформы Azure, как домены сбоя и связывание регионов для устойчивости, до применения полной модели "Активный — активный", в рамках которой облачные службы и база данных развертывается в двух регионах, из которых осуществляется обслуживание пользователей.

Компания Contoso выбрала срединный путь. Приложения и ресурсы компании будут развернуты в основном регионе, а копия инфраструктуры останется в дополнительном регионе, чтобы ее можно было использовать в качестве полной резервной копии в случае аварийного завершения работы приложения или сбоя в регионе.

### <a name="set-up-availability"></a>Настройка доступности

**Группы доступности**

Группы доступности помогают защитить приложения и данные от сбоя локального оборудования и сети в центре обработки данных.

- Группы доступности позволяют распределить виртуальные машины Azure между разными физическими устройствами в центре обработки данных.
- Домены сбоя представляют базовое оборудование с общим источником питания и сетевым коммутатором в центре обработки данных. Виртуальные машины в группе доступности распределяются по разным доменам сбоя для снижения простоев, вызываемых сбоем отдельного оборудования или сети.
- Домены обновления представляют базовое оборудование, которое может одновременно обслуживаться или перезагружаться. Группы доступности также позволяют распределить виртуальные машины между несколькими доменами обновления, чтобы гарантировать, что в любой момент времени хотя бы один экземпляр будет выполняться.

Компания Contoso реализует группы доступности, когда для рабочих нагрузок виртуальной машины требуется высокий уровень доступности. [Дополнительные сведения](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability)

**Зоны доступности**

Зоны доступности помогают защитить приложения и данные от сбоев, затрагивающих весь центр обработки данных в пределах одного региона.

- Каждая зона доступности представляет уникальное физическое расположение в пределах региона Azure.
- Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия.
- Во всех включенных регионах используется как минимум три отдельные зоны.
- Физическое разделение зон в пределах региона защищает приложения и данные от сбоев на уровне центров обработки данных.

Contoso развернет зоны доступности, чтобы обеспечить масштабируемость, высокую доступность и устойчивость приложений. [Дополнительные сведения](https://docs.microsoft.com/azure/availability-zones/az-overview)

### <a name="set-up-backup"></a>Настройка резервного копирования

**Azure Backup**

Azure Backup позволяет выполнять резервное копирование и восстановление дисков виртуальных машин Azure.

- Azure Backup позволяет автоматически создавать резервные копии образов дисков виртуальных машин, хранящихся в службе хранилища Azure.
- Резервные копии являются согласованными с приложениями. Это гарантирует, что резервные копии данных являются транзакционно согласованными и после восстановления приложения будут загружены.
- Azure Backup поддерживает локально избыточное хранилище (LRS) для репликации нескольких копий данных резервных копий в пределах одного центра обработки данных в случае сбоя локального оборудования.
- На случай регионального сбоя Azure Backup также поддерживает геоизбыточное хранилище (GRS), реплицируя резервные копии данных в дополнительный сопряженный регион.
- Azure Backup шифрует транзитные данные с помощью алгоритма AES 256. Неактивные данные резервных копий шифруются с помощью [Шифрования службы хранилища (SSE)](https://docs.microsoft.com/azure/storage/common/storage-service-encryption).

Компания Contoso будет использовать Azure Backup с GRS на всех рабочих виртуальных машинах, чтобы обеспечить резервное копирование данных рабочих нагрузок и их быстрое восстановление в случае сбоя или другого нарушения работы. [Дополнительные сведения](https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup)

### <a name="set-up-disaster-recovery"></a>Настройка аварийного восстановления

**Azure Site Recovery**

Azure Site Recovery помогает обеспечить непрерывность бизнеса, сохраняя работоспособность бизнес-приложений и рабочих нагрузок во время региональных сбоев.

- Azure Site Recovery непрерывно реплицирует виртуальные машины Azure из основного региона в дополнительный регион, обеспечивая функциональные копии в обоих расположениях.
- В случае сбоя в основном регионе выполняется отработка отказа приложения или службы, то есть задействуются экземпляры виртуальных машин, реплицированные в дополнительный регион, что сводит к минимуму возможное нарушение работы.
- После возврата к нормальному режиму работы восстанавливается размещение приложений или служб на виртуальных машинах в основном регионе.

Компания Contoso внедрит Azure Site Recovery для всех рабочих виртуальных машин, используемых для критически важных рабочих нагрузок. Это обеспечит минимальный простой при сбое в основном регионе. [Дополнительные сведения](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview)

## <a name="step-4-design-a-network-infrastructure"></a>Шаг 4. Проектирование сетевой инфраструктуры

Так как у компании Contoso уже есть проект инфраструктуры для регионов, она готова к разработке стратегии организации сетевых подключений. Компании следует выбрать подключение и способ обмена данными между ее локальным центром обработки данных и Azure, а также определить принципы проектирования сетевой инфраструктуры в Azure. В частности, компании Contoso необходимо выполнить указанные ниже действия.

- **Планирование возможности подключения к сети в гибридной среде.** Определить, как будут соединены сети локальной среды и Azure.
- **Проектирование сетевой инфраструктуры Azure.** Решить, как будут развертываться сети в разных регионах. Как сети будут взаимодействовать в пределах одного или нескольких регионов?
- **Проектирование и настройка сетей Azure.** Настроить сети и подсети Azure и решить, что будет в них находиться.

### <a name="plan-hybrid-network-connectivity"></a>Планирование возможности подключения к сети в гибридной среде

В Contoso рассмотрели [несколько вариантов архитектуры](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking) для организации гибридных сетевых подключений между Azure и локальным центром обработки данных. Дополнительные сведения см. в статье [Выбор решения для подключения локальной сети к Azure](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/considerations).

Напоминаем, что текущая инфраструктура Contoso в локальной сети состоит из центра обработки данных в Нью-Йорке и локальных филиалов в восточной части США. Во всех расположениях есть подключение к Интернету бизнес-класса. Каждый филиал подключен к центру обработки данных VPN-туннелем IPSec через Интернет.

![Сеть Contoso](./media/contoso-migration-infrastructure/contoso-networking.png)

Компания Contoso решила реализовать гибридные подключения следующим образом.

1. Специалисты компании настроят новое VPN-подключение типа "сеть — сеть" между центром обработки данных Contoso в Нью-Йорке и двумя регионами Azure в восточной части США 2 и центральной части США.
2. Трафик филиала, предназначенный для виртуальных сетей Azure, будет направляться через основной центр обработки данных Contoso.
3. В ходе увеличения масштаба развертывания Azure компания Contoso установит подключение ExpressRoute между центром обработки данных и регионами Azure. В этом случае VPN-подключения типа "сеть-сеть" будут сохранены только для отработки отказа.
    - Дополнительные сведения о выборе между гибридным решением на базе VPN и ExpressRoute см. в [этой статье](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/considerations).
    - Ознакомьтесь с [месторасположением и возможностями поддержки ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-locations-providers).

**Только VPN**

![VPN компании Contoso](./media/contoso-migration-infrastructure/hybrid-vpn.png)

**VPN и ExpressRoute**

![VPN и ExpressRoute компании Contoso](./media/contoso-migration-infrastructure/hybrid-vpn-expressroute.png)

### <a name="design-the-azure-network-infrastructure"></a>Проектирование сетевой инфраструктуры Azure

Конфигурация сети компании Contoso должна обеспечивать безопасность и масштабируемость гибридного развертывания. Компания Contoso занимает долгосрочный подход к этому, создавая виртуальные сети (виртуальных сетей) для устойчивых и готовых к работе в Организации. Подробные сведения о планировании виртуальных сетей см. в этой [статье](https://docs.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm).

Для подключения двух регионов компания Contoso будет реализовывать модель сети типа "концентратор-концентратор":

- В каждом регионе она будет использовать модель "звезда".
- Для подключения сетей и концентраторов будет использоваться пиринг сетей Azure.

#### <a name="network-peering"></a>Пиринг сетей

Пиринг сети Azure подключает виртуальные сети и концентраторы. Глобальный пиринг разрешает подключения между виртуальной сетью или концентраторами в разных регионах. Локальный пиринг подключает виртуальные сети в одном регионе. Пиринг виртуальных сетей предоставляет несколько преимуществ.

- Сетевой трафик между одноранговыми виртуальными сетями остается закрытым.
- Трафик между виртуальными сетями хранится в магистральной сети Майкрософт. При обмене данными между виртуальными сетями не требуется общий доступ к Интернету, шлюзы или шифрование.
- Пиринг обеспечивает подключение по умолчанию между ресурсами в разных виртуальных сетях, характеризующееся низкой задержкой и высокой пропускной способностью.

Подробные сведения о пиринге сетей см. в этой [статье](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview).

#### <a name="hub-to-hub-across-regions"></a>Радиально-узловая топология сети между регионами

Contoso развернет концентраторы в каждом регионе. Концентратор — это виртуальная сеть в Azure, которая выступает в качестве центральной точки подключения к вашей локальной сети. Концентраторы виртуальных сетей будут подключены друг к другу с использованием глобального пиринга виртуальных сетей. Глобальный пиринг виртуальных сетей обеспечивает подключение между виртуальными сетями в разных регионах Azure.

- Концентратор в каждом регионе выполняет роль кэширующего узла для непосредственно подключенного к нему концентратора в другом регионе.
- Концентратор служит кэширующим узлом для всех сетей в своем регионе и может подключаться ко всем сетевым ресурсам.

    ![Глобальный пиринг](./media/contoso-migration-infrastructure/global-peering.png)

#### <a name="hub-and-spoke-model-within-a-region"></a>Модель "звезда" в пределах региона

В каждом регионе Contoso развернет виртуальные сети для различных целей со звездообразным подключением к концентратору региона. Виртуальные сети в регионе используют пиринг для подключения к концентратору и друг другу.

#### <a name="design-the-hub-network"></a>Проектирование сети-концентратора

При использовании модели звездообразного подключения, выбранной Contoso, необходимо продумать маршрутизацию трафика из локального центра обработки данных и из Интернета. Компания Contoso решила реализовать маршрутизацию для концентраторов восточной части США 2 и центральной части США следующим образом:

- В Contoso разрабатывают сеть под названием "обратное полукольцо". Такое название описывает путь, который проходят пакеты при передаче из входящей сети в исходящую.
- Такая архитектура сети имеет две границы, ненадежную внешнюю зону по периметру и надежную внутреннюю зону.
- Брандмауэр в каждой зоне будет оснащен сетевым адаптером, управляющим доступом к надежным зонам.
- При передаче данных из Интернета:
  - Интернет-трафик будет поступать на общедоступный IP-адрес с балансировкой нагрузки в сети периметра.
  - Этот трафик проходит через брандмауэр, где к нему применяются правила брандмауэра.
  - После реализации управления доступом к сети трафик будет переадресован в соответствующее расположение в надежной зоне.
  - Исходящий трафик из виртуальной сети будет направляться в Интернет с использованием определяемых пользователем маршрутов. Трафик принудительно проходит через брандмауэр и проверяется на соответствие политикам Contoso.
- При передаче данных из центра обработки данных Contoso:
  - Входящий трафик через VPN-подключение "сеть — сеть" (или ExpressRoute) поступает на общедоступный IP-адрес шлюза VPN в Azure.
  - Он проходит через брандмауэр, где к нему применяются правила брандмауэра.
  - После применения брандмауэра правил трафик переадресовывается во внутреннюю подсистему балансировки нагрузки (для стандартных номеров SKU) в подсеть надежной внутренней зоны.
  - Исходящий трафик, поступающий из доверенной подсети в локальный центр обработки данных через VPN-подключение, будет проходить через брандмауэр, где к нему будут применяться соответствующие правила перед передачей через VPN-подключения "сеть — сеть".

### <a name="design-and-set-up-azure-networks"></a>Проектирование и настройка сетей Azure

Теперь у компании Contoso есть топология сети и маршрутизации, поэтому специалисты могут приступать к настройке сетей и подсетей Azure.

- Компания реализует частную сеть класса A в Azure (0.0.0.0 127.255.255.255). Этот вариант позволяет избежать перекрытия диапазонов адресов, так как в локальной среде сейчас используется пространство частных адресов класса B (172.160.0/16).
- Специалисты компании намерены развернуть виртуальные сети в основном и дополнительном регионах.
- Они будут использовать соглашение об именовании, которое включает префикс **VNET** и сокращение для региона **EUS2** или **CUS**. При использовании этого стандарта сети-концентраторы будут называться **VNET-HUB-EUS2** (восточная часть США 2) и **VNET-HUB-CUS** (центральная часть США).
- У Contoso нет [решения IPAM](https://docs.microsoft.com/windows-server/networking/technologies/ipam/ipam-top), поэтому компании нужно спланировать сетевую маршрутизацию без преобразования сетевых адресов (NAT).

#### <a name="virtual-networks-in-east-us-2"></a>Виртуальные сети в восточной части США 2

Восточная часть США 2 — основной регион, который Contoso будет использоваться для развертывания ресурсов и служб. Вот как компания Contoso спроектирует сети в этом регионе:

- **Центр:** Виртуальная сеть концентратора в восточной части США 2 является центральной точкой основного подключения к локальному центру обработки данных.
- **Виртуальных сетей:** Лучевой виртуальных сетей в восточной части США 2 можно использовать для изоляции рабочих нагрузок, если это необходимо. Помимо виртуальной сети-концентратора у Contoso в восточной части США 2 есть две периферийные виртуальные сети.
  - **VNET-DEV-EUS2**. Эта виртуальная сеть будет предоставлять отделу разработки и тестирования полностью функциональную сеть для проектов разработки. Она будет выступать в качестве рабочей пилотной площадки и использовать инфраструктуру рабочей среды.
    - **VNET-PROD-EUS2** В этой сети будут размещены рабочие компоненты Azure IaaS.
  - У всех виртуальных сетей будут собственные не перекрывающиеся уникальные адресные пространства. В Contoso намерены настроить маршрутизацию, не требующую NAT.
- **Подсети:**
  - Для каждого уровня приложения в каждой сети будет своя подсеть.
  - Каждая подсеть в рабочей сети должна иметь соответствующую подсеть в виртуальной сети разработки.
  - Кроме того, в рабочей сети имеется подсеть для контроллеров домена.

В следующей таблице кратко описаны виртуальные сети в восточной части США 2.

**Виртуальная сеть** | **Range** | **Кэширующий узел**
--- | --- | ---
**VNET-HUB-EUS2** | 10.240.0.0/20 | VNET-HUB-CUS2, VNET-DEV-EUS2, VNET-PROD-EUS2
**VNET-DEV-EUS2** | 10.245.16.0/20 | VNET-HUB-EUS2
**VNET-PROD-EUS2** | 10.245.32.0/20 | VNET-HUB-EUS2, VNET-PROD-CUS

![Модель "звезда" в основном регионе](./media/contoso-migration-infrastructure/primary-hub-peer.png)

#### <a name="subnets-in-the-east-us-2-hub-network-vnet-hub-eus2"></a>Подсети в сети-концентраторе в восточной части США 2 (VNET-HUB-EUS2)

**Подсеть/зона** | **CIDR** | ** Пригодные для использования IP-адреса
--- | --- | ---
**IB-UntrustZone** | 10.240.0.0/24 | 251
**IB-TrustZone** | 10.240.1.0/24 | 251
**OB-UntrustZone** | 10.240.2.0/24 | 251
**OB-TrustZone** | 10.240.3.0/24 | 251
**GatewaySubnets** | 10.240.10.0/24 | 251

#### <a name="subnets-in-the-east-us-2-dev-network-vnet-dev-eus2"></a>Подсети в сети разработки в восточной части США 2 (VNET-DEV-EUS2)

Виртуальная сеть разработки используется командой разработчиков в качестве рабочей пилотной площадки. Он имеет три подсети:

**Подсеть** | **CIDR** | **Адреса** | **Компоненты в подсети**
--- | --- | --- | ---
**DEV-FE-EUS2** | 10.245.16.0/22 | 1019 | Интерфейсные виртуальные машины или виртуальные машины веб-уровня
**DEV-APP-EUS2** | 10.245.20.0/22 | 1019 | Виртуальные машины уровня приложения
**DEV-DB-EUS2** | 10.245.24.0/23 | 507 | Виртуальные машины баз данных

#### <a name="subnets-in-the-east-us-2-production-network-vnet-prod-eus2"></a>Подсети в рабочей сети в восточной части США 2 (VNET-PROD-EUS2)

Компоненты инфраструктуры как услуги Azure находятся в рабочей сети. Для каждого уровня приложения предусмотрена собственная подсеть. Эти подсети соответствуют подсетям в сети разработки, однако здесь есть также дополнительная подсеть для контроллеров домена.

**Подсеть** | **CIDR** | **Адреса** | **Компоненты в подсети**
--- | --- | --- | ---
**PROD-FE-EUS2** | 10.245.32.0/22 | 1019 | Интерфейсные виртуальные машины или виртуальные машины веб-уровня
**PROD-APP-EUS2** | 10.245.36.0/22 | 1019 | Виртуальные машины уровня приложения
**PROD-DB-EUS2** | 10.245.40.0/23 | 507 | Виртуальные машины баз данных
**PROD-DC-EUS2** | 10.245.42.0/24 | 251 | Виртуальные машины контроллеров домена

![Архитектура сети-концентратора](./media/contoso-migration-infrastructure/azure-networks-eus2.png)

#### <a name="virtual-networks-in-central-us-secondary-region"></a>Виртуальные сети в центральной части США (дополнительный регион)

Центральная часть США — это дополнительный регион Contoso. Вот как компания Contoso спроектирует сети в этом регионе:

- **Центр:** Виртуальная сеть концентратора в восточной части США 2 является центральной точкой подключения к локальному центру обработки данных, а периферийная виртуальных сетей в восточной части США 2 может использоваться для изоляции рабочих нагрузок, если это необходимо, и управляется отдельно от других периферийных зон.
- **Виртуальных сетей:** Компания Contoso будет иметь два виртуальных сетейа в Центральной территории США:
  - VNET-PROD-CUS. Эта виртуальная сеть является рабочей сетью аналогично VNET-PROD_EUS2.
  - VNET-ASR-CUS. В этой виртуальной сети будут создаваться виртуальные машины после отработки отказа из локальной среды, а также размещаться виртуальные машины Azure, которые будут использоваться для переключения с основного на дополнительный регион при отработке отказа. Эта сеть аналогична рабочим сетям, но в ней отсутствуют контроллеры домена.
  - У всех виртуальных сетей в регионе будут собственные не перекрывающиеся адресные пространства. В Contoso настроят маршрутизацию без NAT.
- **Подсети:** Подсети будут спроектированы так же, как и в восточной части США 2. за тем исключением, что здесь компании Contoso не требуется подсеть для контроллеров домена.

В следующей таблице кратко описаны виртуальные сети в центральной части США.

**Виртуальная сеть** | **Range** | **Кэширующий узел**
--- | --- | ---
**VNET-HUB-CUS** | 10.250.0.0/20 | VNET-HUB-EUS2, VNET-ASR-CUS, VNET-PROD-CUS
**VNET-ASR-CUS** | 10.255.16.0/20 | VNET-HUB-CUS, VNET-PROD-CUS
**VNET-PROD-CUS** | 10.255.32.0/20 | VNET-HUB-CUS, VNET-ASR-CUS, VNET-PROD-EUS2

![Модель "звезда" в сопряженном регионе](./media/contoso-migration-infrastructure/paired-hub-peer.png)

#### <a name="subnets-in-the-central-us-hub-network-vnet-hub-cus"></a>Подсети в радиально-кольцевой сети в центральной части США (VNET-HUB-CUS)

**Подсеть** | **CIDR** | **Пригодные для использования IP-адреса**
--- | --- | ---
**IB-UntrustZone** | 10.250.0.0/24 | 251
**IB-TrustZone** | 10.250.1.0/24 | 251
**OB-UntrustZone** | 10.250.2.0/24 | 251
**OB-TrustZone** | 10.250.3.0/24 | 251
**Подсеть шлюза** | 10.250.2.0/24 | 251

#### <a name="subnets-in-the-central-us-production-network-vnet-prod-cus"></a>Подсети в рабочей сети в центральной части США (VNET-PROD-CUS)

Параллельно с рабочей сетью в основном регионе "Восточная часть США 2" имеется рабочая сеть в дополнительном регионе США.

**Подсеть** | **CIDR** | **Адреса** | **Компоненты в подсети**
--- | --- | --- | ---
**PROD-FE-CUS** | 10.255.32.0/22 | 1019 | Интерфейсные виртуальные машины и виртуальные машины веб-уровня
**PROD-APP-CUS** | 10.255.36.0/22 | 1019 | Виртуальные машины уровня приложения
**PROD-DB-CUS** | 10.255.40.0/23 | 507 | Виртуальные машины баз данных
**PROD-DC-CUS** | 10.255.42.0/24 | 251 | Виртуальные машины контроллеров домена

#### <a name="subnets-in-the-central-us-failoverrecovery-network-in-central-us-vnet-asr-cus"></a>Подсети в сети для отработки отказа и восстановления в центральной части США (VNET-ASR-CUS)

Сеть VNET-ASR-CUS используется для отработки отказа между регионами. Для репликации и отработки отказа виртуальных машин Azure между регионами будет использоваться Site Recovery. Эта служба также выполняет функцию Центра обработки данных Contoso для сети Azure и используется для защищенных рабочих нагрузок, которые остаются в локальной среде, но при отработке отказа переносятся в Azure для аварийного восстановления.

VNET-ASR-CUS — это такая же основная подсеть, что и рабочая виртуальная сеть в регионе "Восточная часть США 2", за тем исключением, что в ней компании не требуется подсеть для контроллеров домена.

**Подсеть** | **CIDR** | **Адреса** | **Компоненты в подсети**
--- | --- | --- | ---
**ASR-FE-CUS** | 10.255.16.0/22 | 1019 | Интерфейсные виртуальные машины и виртуальные машины веб-уровня
**ASR-APP-CUS** | 10.255.20.0/22 | 1019 | Виртуальные машины уровня приложения
**ASR-DB-CUS** | 10.255.24.0/23 | 507 | Виртуальные машины баз данных

![Архитектура сети-концентратора](./media/contoso-migration-infrastructure/azure-networks-cus.png)

#### <a name="configure-peered-connections"></a>Настройка пириговых подключений

Концентратор в каждом регионе будет служить кэширующим узлом для концентратора в другом регионе, а также всех виртуальных сетей в пределах своего региона. Это позволяет концентраторам обмениваться данными и получать доступ ко всем виртуальным сетям в пределах региона. Обратите внимание на следующее.

- Пиринг обеспечивает двустороннее соединение: от узла-инициатора в первой виртуальной сети и от узла во второй виртуальной сети.
- При гибридном развертывании трафик между кэширующими узлами должен быть доступен через VPN-подключение между локальным центром обработки данных и Azure. Для этого необходимо установить определенные параметры для пиринговых подключений.

Contoso необходимо разрешить переадресацию трафика и поворот VPN-шлюзов для всех подключений периферийных виртуальных сетей к локальному центру обработки данных через концентратор.

##### <a name="domain-controller"></a>Контроллер домена

Для контроллеров домена в сети VNET-PROD-EUS2 компании Contoso необходимо, чтобы трафик направлялся из концентратора или рабочей сети в регионе EUS2 в локальные среды через VPN-подключение. Для этого администраторам Contoso необходимо разрешить указанные ниже операции.

1. Специалисты компании должны **разрешить переадресацию трафика** и **разрешить конфигурации с транзитом через шлюз** для пирингового соединения. В нашем примере это будет подключение между VNET-HUB-EUS2 и VNET-PROD-EUS2.

    ![Пиринг](./media/contoso-migration-infrastructure/peering1.png)

2. Они также должны **разрешить переадресацию трафика** и **использование удаленных шлюзов** на другой стороне пиринга для подключения VNET-PROD-EUS2 к VNET-HUB-EUS2.

    ![Пиринг](./media/contoso-migration-infrastructure/peering2.png)

3. В локальной среде специалисты компании настроят статический маршрут, по которому локальный трафик будет направляться в виртуальную сеть через VPN-туннель. Настройка будет завершена на шлюзе, который обеспечивает VPN-туннель из Contoso в Azure. Для этого используется RRAS.

    ![Пиринг](./media/contoso-migration-infrastructure/peering3.png)

##### <a name="production-networks"></a>Рабочие сети

Из периферийной одноранговой сети невозможно получить доступ к периферийной одноранговой сети в другом регионе через концентратор.

Для обмена данными между рабочими сетями Contoso в обоих регионах администраторам Contoso необходимо создать прямое пиринговое подключение для VNET-PROD-EUS2 и VENT-PROD-CUS.

![Пиринг](./media/contoso-migration-infrastructure/peering4.png)

### <a name="set-up-dns"></a>Настройка DNS

При развертывании ресурсов в виртуальных сетях можно выбрать один из нескольких вариантов разрешения доменных имен. Можно использовать разрешение имен, предоставляемое Azure или указать DNS-серверы для разрешения. Тип разрешения имен зависит от способа взаимодействия ресурсов друг с другом. Дополнительные сведения о службе Azure DNS см. в этой [статье](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#azure-provided-name-resolution).

Администраторы Contoso решили, что служба Azure DNS не подходит для гибридной среды. Вместо этого они будут использовать локальные DNS-серверы.

- Так как это гибридная сеть, все виртуальные машины в локальной среде и в Azure должны иметь возможность разрешения имен для правильной работы. Это означает, что во всех виртуальных сетях должны быть применены пользовательские параметры DNS.
- Сейчас контроллеры домена Contoso развернуты в центре обработки данных Contoso и в филиалах. Основные DNS-серверы — CONTOSODC1(172.16.0.10) и CONTOSODC2(172.16.0.1).
- При развертывании виртуальных сетей в качестве DNS-сервера в сетях будут настроены локальные контроллеры домена.
- Для этого при использовании пользовательской службы DNS в виртуальной сети в список DNS должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). Для этого Contoso настроит параметры DNS-серверов в каждой виртуальной сети. Ниже приведен пример пользовательских параметров DNS для сети VNET-HUB-EUS2.

    ![Пользовательский DNS](./media/contoso-migration-infrastructure/custom-dns.png)

В дополнение к локальным контроллерам домена компания Contoso будет реализовывать четыре дополнительных контроллера домена для поддержки сетей Azure, по два для каждого региона. Ниже показано, какие компоненты специалисты Contoso развернут в Azure.

**Регион** | **Контроллер домена** | **Виртуальная сеть** | **Подсеть** | **IP-адрес**
--- | --- | --- | --- | ---
EUS2 | CONTOSODC3 | VNET-PROD-EUS2 | PROD-DC-EUS2 | 10.245.42.4
EUS2 | CONTOSODC4 | VNET-PROD-EUS2 | PROD-DC-EUS2 | 10.245.42.5
CUS | CONTOSODC5 | VNET-PROD-CUS | PROD-DC-CUS | 10.255.42.4
CUS | CONTOSODC6 | VNET-PROD-CUS | PROD-DC-CUS | 10.255.42.4

После развертывания контроллеров домена в локальной среде специалистам Contoso необходимо обновить параметры DNS в сетях обоих регионов, чтобы включить новые контроллеры домена в список DNS-серверов.

#### <a name="set-up-domain-controllers-in-azure"></a>Настройка контроллеров домена в Azure

После обновления параметров сети администраторы Contoso могут приступать к созданию контроллеров домена в Azure.

1. Сотрудники компании развернут на портале Azure новую виртуальную машину с Windows Server в соответствующей виртуальной сети.
2. Они создадут в каждом расположении группы доступности для виртуальной машины. Группы доступности используются для следующих задач:

    - разделения виртуальных машины на разные инфраструктуры в регионе Azure с помощью фабрики Azure;
    - обеспечить Contoso право на Соглашение об уровне обслуживания с доступностью в течение 99,95 % времени для виртуальных машин в Azure. [Дополнительные сведения](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-availability-sets)

    ![группа доступности](./media/contoso-migration-infrastructure/availability-group.png)

3. После развертывания виртуальной машины сотрудники компании настраивают для нее сетевой интерфейс. Они выбирают статический частный IP-адрес и указывают для него действительное значение.

    ![Сетевой адаптер виртуальной машины](./media/contoso-migration-infrastructure/vm-nic.png)

4. Теперь они подключают новый диск данных к виртуальной машине. Этот диск содержит базу данных Active Directory и общий ресурс sysvol.
    - От размера диска зависит поддерживаемое количество операций ввода-вывода.
    - Возможно, со временем потребуется увеличить размер диска в связи с увеличением масштабов среды.
    - Чтобы обеспечить кэширование узла, для диска не следует настраивать доступ только для чтения и записи. Базы данных Active Directory это не поддерживают.

     ![Диск Active Directory](./media/contoso-migration-infrastructure/ad-disk.png)

5. После добавления диска сотрудники компании подключаются к виртуальной машине через удаленный рабочий стол и открывают диспетчер сервера.

6. Затем они запускают в разделе **File and Storage Services** (Файловые службы и службы хранилища) мастер создания томов. Это позволяет убедиться, что диску на локальной виртуальной машине назначена буква F: или одна из следующих.

     ![Мастер создания тома](./media/contoso-migration-infrastructure/volume-wizard.png)

7. В диспетчере сервера сотрудники компании выбирают роль **Доменные службы Active Directory**. Затем они настраивают виртуальную машину в качестве контроллера домена.

      ![Роль сервера](./media/contoso-migration-infrastructure/server-role.png)

8. После настройки виртуальной машины в качестве контроллера домена и ее перезагрузки сотрудники компании открывают диспетчер DNS и настраивают сопоставителя Azure DNS в качестве сервера пересылки. Это позволяет контроллеру домена переадресовывать в Azure DNS запросы DNS, которые он не может разрешить.

    ![Сервер пересылки — DNS-сервер перенаправления](./media/contoso-migration-infrastructure/dns-forwarder.png)

9. Теперь следует обновить пользовательские параметры DNS для каждой виртуальной сети с помощью соответствующего контроллера домена для ее региона. Поэтому сотрудники компании добавляют в список локальные контроллеры домена.

### <a name="set-up-active-directory"></a>настроить Active Directory;

Active Directory — это критически важная служба в сети, поэтому ее нужно правильно настроить. Администраторы Contoso создадут сайты Active Directory для центра обработки данных Contoso, а также для регионов EUS2 и CUS.

1. Они создадут две новых площадки (AZURE-EUS2 и AZURE-CUS), а также площадку центра обработки данных (ContosoDatacenter).
2. После создания площадок они создадут в них подсети, соответствующие виртуальным сетям и центру обработки данных.

    ![Подсети контроллеров домена](./media/contoso-migration-infrastructure/dc-subnets.png)

3. Затем они создадут для площадок две связи для подключения всех компонентов. После этого контроллеры домена должны быть перемещены в необходимое расположение.

    ![Связи контроллеров домена](./media/contoso-migration-infrastructure/dc-links.png)

4. После настройки всех компонентов топология репликации Active Directory готова к работе.

    ![Репликация контроллеров домена](./media/contoso-migration-infrastructure/ad-resolution.png)

5. По завершении всех процедур в центре администрирования Active Directory в локальной среде отображается список контроллеров домена и площадок.

    ![Центр администрирования Active Directory](./media/contoso-migration-infrastructure/ad-center.png)

## <a name="step-5-plan-for-governance"></a>Шаг 5. Планирование системы управления

Azure предоставляет ряд средств управления, которыми можно воспользоваться в различных службах и на платформе Azure. Дополнительные сведения см. в статье [Параметры управления Azure](https://docs.microsoft.com/azure/security/governance-in-azure).

Специалисты Contoso уже начали определять некоторые аспекты управления и обеспечения безопасности при настройке удостоверения и управлении доступом. В целом им следует учесть три аспекта:

- **Политика:** Политика Azure применяет и применяет правила и эффекты к ресурсам, чтобы ресурсы оставались совместимыми с корпоративными требованиями и соглашениями об уровне обслуживания.
- **Блокировки:** Azure позволяет блокировать подписки, группы ресурсов и другие ресурсы, чтобы их можно было изменять только с помощью полномочий.
- **Теги:** Ресурсами можно управлять, проводить аудит и управлять ими с помощью тегов. Теги дают возможность связать метаданные ресурсами и предоставляют информацию о ресурсах или владельцах.

### <a name="set-up-policies"></a>Настройка политик

Служба "Политика Azure" выполняет оценку ресурсов, выявляя те из них, которые не соответствуют имеющимся определениям политик. Например, у вас может быть политика, которая разрешает использовать виртуальные машины только определенного типа или требует, чтобы у ресурсов были конкретные теги.

Политики задают определение политики, а назначение политики определяет область ее применения. Область может варьироваться от группы управления до группы ресурсов. Дополнительные сведения о создании политик и управлении ими см. в этой [статье](https://docs.microsoft.com/azure/governance/policy/tutorials/create-and-manage).

Contoso хочет начать несколько политик:

- Требуется политика, чтобы обеспечить возможность развертывания ресурсов только в регионах EUS2 и Cu.
- Требуется разрешить использовать только утвержденные номера SKU. Это необходимо, чтобы избежать использования дорогостоящих конфигураций виртуальных машин.

#### <a name="limit-resources-to-regions"></a>Ограничение использования ресурсов в регионах

В Contoso используется встроенное определение политики **Разрешенные расположения**, ограничивающей использование ресурсов в регионах.

1. На портале Azure щелкните **Все службы** и выполните поиск по слову **Политика**.
2. Выберите **Назначения** > **Назначение политики**.
3. Выберите в списке политик **Разрешенные расположения**.
4. В поле **Область** укажите имя подписки Azure и выберите две области в списке разрешенных.

    ![Разрешенные политикой регионы](./media/contoso-migration-infrastructure/policy-region.png)

5. По умолчанию для политики установлен параметр **Запретить**, поэтому осуществить развертывание по подписке вне региона EUS2 или CUS не удастся. При попытке настроить развертывание в западной части США по подписке Contoso будет получено следующее сообщение.

    ![Сбои политики](./media/contoso-migration-infrastructure/policy-failed.png)

#### <a name="allow-specific-vm-skus"></a>Разрешение использования виртуальных машин с определенными номерами SKU

Contoso будет использовать встроенное определение политики **Allow virtual machines SKUs** (Разрешить номера SKU виртуальных машин) для ограничения типов виртуальных машин, которые могут быть созданы по подписке.

![Номера SKU для политики](./media/contoso-migration-infrastructure/policy-sku.png)

#### <a name="check-policy-compliance"></a>Проверка соответствия политикам

Политики вступают в силу незамедлительно, и Contoso может проверить ресурсы на соответствие.

1. На портале Azure выберите ссылку **Соответствие требованиям**.
2. Откроется панель мониторинга "Соответствие требованиям". Для отображения дополнительных сведений можно детализировать представление.

    ![Соответствие политике](./media/contoso-migration-infrastructure/policy-compliance.png)

### <a name="set-up-locks"></a>Настройка блокировок

Для управления системами в Contoso длительное время используется платформа ITIL. Один из важнейших аспектов платформы — возможность управления изменениями, поэтому специалисты Contoso хотят непременно реализовать эту функцию в развертывании Azure.

Contoso собирается реализовать блокировки следующим образом:

- Любой рабочий компонент или компонент отработки отказа должен находиться в группе ресурсов с блокировкой ReadOnly. Это означает, что для изменения или удаления рабочих элементов необходимо будет снять блокировку.
- Группы ресурсов, не используемых в рабочей среде, будут иметь блокировки CanNotDelete. Это означает, что полномочные пользователи могут читать или изменять ресурсы, но не могут удалить их.

Подробные сведения о блокировках см. в этой [статье](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources).

### <a name="set-up-tagging"></a>Настройка тегов

Для отслеживания ресурсов по мере их добавления все большую важность для Contoso будет приобретать возможность связать ресурсы с соответствующим отделом, клиентом и средой.

Помимо предоставления информации о ресурсах и владельцах, теги предоставляют Contoso возможность объединять и группировать ресурсы, а также использовать эти данные для взимания средств за использование.

Компании Contoso необходимо визуализировать свои ресурсы Azure в удобной для компании форме. Например, по ролям или отделам. Обратите внимание, что ресурсы, находящиеся в разных группах ресурсов, могут иметь одинаковый тег. Contoso создаст простую классификацию тегов, чтобы все использовали одинаковые теги.

**Имя тега** | **Value**
--- | ---
CostCenter | 12345: это должно быть допустимое место возникновения затрат из системы SAP.
BusinessUnit | Имя подразделения (из системы SAP). Соответствует месту возникновения затрат.
ApplicationTeam | Псевдоним электронной почты команды, отвечающей за поддержку приложения.
CatalogName | Имя приложения или общие службы для каждого каталога служб, которые поддерживает ресурс.
ServiceManager | Псевдоним электронной почты ITIL Service Manager для ресурса.
COBPriority | Приоритет, установленный компанией для BCDR. Значения от 1 до 5.
ENV | Возможные значения: DEV, STG, PROD. Представляет среду разработки, промежуточную среду и рабочую среду.

Пример:

 ![Теги Azure](./media/contoso-migration-infrastructure/azure-tag.png)

После создания тега администраторы Contoso вернутся на несколько шагов назад и создадут новые определения и назначения политики Azure, чтобы обеспечить принудительное использование этих обязательных тегов во всей организации.

## <a name="step-6-consider-security"></a>Шаг 6. Учет требований к безопасности

Безопасность в облаке играет критически важную роль, поэтому Azure предоставляет широкий спектр средств и возможностей обеспечения безопасности. Они помогают создавать безопасные решения на защищенной платформе Azure. Дополнительные сведения о безопасности в Azure см. на странице [Уверенная работа в надежном облаке](https://azure.microsoft.com/overview/trusted-cloud).

Contoso следует учесть несколько аспектов:

- **Центр безопасности Azure:** Центр безопасности Azure обеспечивает унифицированное управление безопасностью и расширенную защиту от угроз в гибридных облачных рабочих нагрузках. С помощью центра безопасности можно применять политики безопасности для рабочих нагрузок, ограничить уязвимость перед угрозами, а также выявлять атаки и реагировать на них. [Дополнительные сведения](https://docs.microsoft.com/azure/security-center/security-center-intro)
- **Группы безопасности сети (группы безопасности сети):** NSG — это фильтр (брандмауэр), который содержит список правил безопасности, которые при применении позволяют разрешать или запрещать сетевой трафик к ресурсам, подключенным к Azure виртуальных сетей. [Дополнительные сведения](https://docs.microsoft.com/azure/virtual-network/security-overview)
- **Шифрование данных:** Шифрование дисков Azure — это функция, которая помогает шифровать диски виртуальных машин IaaS под управлением Windows и Linux. [Дополнительные сведения](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)

### <a name="work-with-the-azure-security-center"></a>Работа с центром безопасности Azure

Компании Contoso необходимо получить общее представление об уровне безопасности своего нового гибридного облака и, в частности, рабочих нагрузок Azure. Поэтому компания решила реализовать центр безопасности Azure со следующими возможностями:

- Централизованное управление политиками
- Непрерывная оценка
- Практические рекомендации

#### <a name="centralize-policy-management"></a>Централизация управления политиками

Благодаря централизованному управлению политиками Contoso обеспечит соответствие требованиям безопасности за счет централизованного управления политиками безопасности во всей среде. Они могут легко и быстро реализовать политику, которая применяется ко всем ресурсам Azure.

![Политика безопасности](./media/contoso-migration-infrastructure/security-policy.png)

#### <a name="assess-and-action"></a>Оценка и действие

Компания Contoso будет использовать непрерывную оценку безопасности, которая обеспечивает мониторинг безопасности компьютеров, сетей, хранилищ, данных, а также приложений для обнаружения потенциальных проблем с безопасностью.

- Центр безопасности анализирует состояние безопасности вычислений, инфраструктуры и ресурсов данных Contoso, а также приложений и служб Azure.
- Непрерывная оценка помогает операционной группе компании обнаружить потенциальные проблемы с безопасностью, в том числе системы без обновлений системы безопасности или открытые сетевые порты.
- В частности, специалисты Contoso хотят убедиться, что все виртуальные машины компании защищены. Центр безопасности помогает справиться с этой задачей, проверяя работоспособность виртуальных машин и предоставляя приоритетные и действенные рекомендации по устранению уязвимостей в системе безопасности до того, как ими воспользуются злоумышленники.

![Наблюдение](./media/contoso-migration-infrastructure/monitoring.png)

### <a name="work-with-nsgs"></a>Работа с группами безопасности сети

Компания Contoso может ограничить сетевой трафик ресурсами в виртуальной сети с помощью группы безопасности сети.

- Группа безопасности сети содержит список правил безопасности, которые разрешают или запрещают входящий и исходящий трафик в зависимости от IP-адреса источника или назначения, порта и протокола.
- Если в подсети действуют правила, они применяются ко всем ее ресурсам. Помимо сетевых интерфейсов к ним относятся экземпляры служб Azure, развернутые в подсети.
- Группы безопасности приложений позволяют настроить сетевую безопасность как естественное расширение структуры приложения. Это дает возможность группировать виртуальные машины и определять политики безопасности сети на основе таких групп.
  - Применение группы безопасности приложений позволяет Contoso повторно использовать политику безопасности в нужном масштабе без обслуживания явных IP-адресов вручную. Платформа сама обрабатывает явные IP-адреса и множество наборов правил, позволяя вам сосредоточиться на бизнес-логике.
  - Contoso может указать группу безопасности приложений в правиле безопасности как источник и назначение. После определения политики безопасности Contoso может создать виртуальные машины и назначить группе сетевые адаптеры виртуальной машины.

Компания Contoso реализует сочетание групп безопасности сети и групп безопасности приложений. Руководителей компании волнует управление группами безопасности сети, а также чрезмерное их применение и дополнительные трудности для операционного персонала. Ниже приведены действия специалистов Contoso:

- Весь входящий и исходящий трафик всех подсетей (с севера на юг) будет подчиняться правилу для групп безопасности сети, за исключением GatewaySubnets в сетях-концентраторах.
- Любые брандмауэры и контроллер домена защищаются с помощью групп безопасности сети для подсети и сетевого адаптера.
- Ко всем приложениям в рабочей среде будут применяться группы безопасности приложений.

В Contoso составили модель вышеописанной системы для своих приложений.

![безопасность](./media/contoso-migration-infrastructure/asg.png)

Группы безопасности сети, связанные с группами безопасности приложений, будут настроены с наименьшими разрешениями. Благодаря этому из одной части сети в другую смогут передаваться только разрешенные пакеты.

**Действие** | **Название** | **Source** | **Цель** | **Порт**
--- | --- | --- | --- | ---
Allow | алловинтернеттофе | VNET-HUB-EUS1/IB-TrustZone | APP1-FE 80, 443
Allow | AllowWebToApp | APP1-FE | APP1-APP | 80, 443
Allow | AllowAppToDB | APP1-APP | APP1-DB | 1433
Запрет | DenyAllInbound | Любой | Любой | Любой

### <a name="encrypt-data"></a>Шифрование данных

Шифрование дисков Azure интегрируется в Azure Key Vault, что позволяет управлять секретами и ключами шифрования дисков в подписке Key Vault и контролировать их. Эта служба также обеспечивает шифрование всех неактивных данных на дисках виртуальных машин в службе хранилища Azure.

- Contoso определила, что определенные виртуальные машины требуют шифрования.
- В Contoso будут применять шифрование к виртуальным машинам, в которых хранятся данные клиентов, конфиденциальная информация или данные PPI.

## <a name="conclusion"></a>Заключение

В этой статье описано, как специалисты компании Contoso настроили инфраструктуру и политику Azure для подписки Azure, удостоверения в гибридной среде, аварийного восстановления, сетевого взаимодействия, управления и обеспечения безопасности.

Не все действия, которые необходимо выполнить, необходимы для миграции в облако. В этом случае компания Contoso запланировала сетевую инфраструктуру, которая может выполнять все виды миграций, в то время как безопасность, устойчивость и масштабируемость.

С этой инфраструктурой компания Contoso готова перейти на миграцию и испытать ее.

## <a name="next-steps"></a>Дальнейшие действия

После настройки инфраструктуры Azure компания Contoso готова начать перенос рабочих нагрузок в облако. В разделе [Примеры статей о миграции](./contoso-migration-overview.md#windows-server-workloads) приведено несколько сценариев использования этого примерна инфраструктуры в качестве цели миграции.
