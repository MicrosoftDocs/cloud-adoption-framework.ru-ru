---
title: Развертывание инфраструктуры миграции
description: Узнайте, каким образом компания Contoso настраивает инфраструктуру Azure для миграции в Azure.
author: deltadan
ms.author: abuck
ms.date: 07/01/2020
ms.topic: conceptual
ms.service: cloud-adoption-framework
ms.subservice: migrate
services: azure-migrate
ms.openlocfilehash: 64bda0e0b1cd39bdbc859b55ea52e0d0273bad5b
ms.sourcegitcommit: 84d7bfd11329eb4c151c4c32be5bab6c91f376ed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/10/2020
ms.locfileid: "86234299"
---
<!-- cSpell:ignore untrust CIDR RRAS CONTOSODC sysvol ITIL NSGs ASGs -->

# <a name="deploy-a-migration-infrastructure"></a>Развертывание инфраструктуры миграции

В этой статье описывается, как вымышленная компания Contoso подготавливает свою локальную инфраструктуру к миграции, настраивает инфраструктуру Azure в ходе подготовки к миграции и ведет деловую деятельность в гибридной среде. При использовании этого примера следует учитывать два аспекта, которые помогут спланировать собственные усилия по переносу инфраструктуры. Архитектура приведенного примера соответствует компании Contoso. Пересмотрите бизнес-потребности, структуру и технические требования своей организации при принятии важных решений об инфраструктуре, касающихся проектирования подписок или сетевой архитектуры. Возможно, вам понадобятся не все элементы, описанные в этой статье. Это зависит от стратегии миграции. Например, может потребоваться менее сложная структура сети, если вы создаете только облачные приложения в Azure.

## <a name="overview"></a>Обзор

Перед миграцией в Azure важно подготовить инфраструктуру Azure. Как правило, для этого необходимо уделить особое внимание шести аспектам.

> [!div class="checklist"]
>
> - **Шаг 1. подписки Azure.** Как Contoso будет покупать Azure и взаимодействовать с платформой и службами Azure?
> - **Шаг 2. Гибридная идентификация.** Как будет осуществляться управление доступом к ресурсам Azure и локальным ресурсам после миграции? Как обеспечить поддержку управления идентификацией в облаке или полностью перейти на такое управление?
> - **Шаг 3. аварийное восстановление и устойчивость.** Как компания Contoso обеспечит устойчивость своих приложений и инфраструктуры в случае сбоев и аварийных ситуаций?
> - **Шаг 4. Работа в сети.** Как компания Contoso должна разработать сетевую инфраструктуру и установить подключение между локальным центром обработки данных и Azure?
> - **Шаг 5. безопасность.** Как будет обеспечиваться безопасность гибридного развертывания?
> - **Шаг 6. Управление.** Как Contoso будет поддерживать соответствие развертывания требованиям безопасности и системы управления?

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать просмотр инфраструктуры, ознакомьтесь со сведениями о соответствующих возможностях Azure:

- Существует несколько вариантов приобретения доступа к Azure, включая подписки с оплатой по мере использования, Microsoft Соглашение Enterprise (EA), Open Licensing от торговых посредников Майкрософт или покупки партнеров Майкрософт в программе поставщика облачных решений (CSP). Узнайте больше о [вариантах приобретения](https://azure.microsoft.com/pricing/purchase-options) и [структуре подписок Azure](https://azure.microsoft.com/blog/organizing-subscriptions-and-resource-groups-within-the-enterprise).
- Получите общее представление об [управлении удостоверениями и доступом](https://www.microsoft.com/security/business/identity) в Azure. Узнайте об [Azure AD и расширении локальных Active Directory в облако](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-whatis).
- Azure предоставляет надежную сетевую инфраструктуру с различными вариантами гибридных подключений. Получите общее представление о [сетевых возможностях и управлении доступом к сети](https://docs.microsoft.com/azure/security/security-network-overview).
- Ознакомьтесь с [введением в систему безопасности Azure](https://docs.microsoft.com/azure/security/fundamentals/overview) и Узнайте, как создать план для управления [Azure](https://docs.microsoft.com/azure/governance).

## <a name="on-premises-architecture"></a>Локальная архитектура

На схеме ниже показана текущая локальная инфраструктура компании Contoso.

 ![Архитектура Contoso ](./media/contoso-migration-infrastructure/contoso-architecture.png)
 _рис. 1. локальная архитектура contoso._

- В Восточном США Contoso имеет один главный центр обработки данных, расположенный в городе Нью Йорк.
- У компании есть еще три местных филиала на территории США.
- Главный центр обработки данных подключен к Интернету по оптоволоконному соединению метро Ethernet (500 Мбит/с).
- Каждая ветвь подключается локально к Интернету с помощью подключений к бизнес-классам, а VPN-туннели IPsec возвращаются к основному центру обработки данных. Такой подход позволяет постоянно подключать всю сеть и оптимизировать подключение к Интернету.
- Основной центр обработки данных полностью виртуализирован на базе решений VMware. В Contoso есть два узла виртуализации ESXi 6,5, управляемых vCenter Server 6,5.
- Contoso использует Active Directory для управления удостоверениями и DNS-серверов во внутренней сети.
- Контроллеры домена в центре обработки данных размещены в виртуальных машинах VMware. Контроллеры домена в местных филиалах размещены на физических серверах.

## <a name="step-1-buy-and-subscribe-to-azure"></a>Шаг 1. Приобретение Azure и оформление подписки

Contoso необходимо выяснить, как приобрести Azure, разработать подписки и лицензировать службы и ресурсы.

### <a name="buy-azure"></a>Приобретение Azure

Contoso регистрируется в [Соглашение Enterprise (EA)](https://azure.microsoft.com/pricing/enterprise-agreement). Это соглашение включает в себя предварительные денежные обязательства в Azure, дающего Contoso для получения превосходных преимуществ, включая гибкие варианты выставления счетов и оптимизированные цены.

- В Contoso оценили ежегодные затраты на Azure. При подписании соглашения компания Contoso заплатила за первый год в полном объеме.
- Компания Contoso должна использовать все обязательства до тех пор, пока год не отменяется или теряется значение этих долларов.
- Если по какой-либо причине затраты компании превысят размер авансового платежа, корпорация Майкрософт выставит ей счета на эту разницу.
- Тарифы по всем расходам свыше авансовой суммы остаются такими же, как указано в контракте с Contoso. Штраф за превышение отсутствует.

### <a name="manage-subscriptions"></a>Управление подписками

После оплаты Azure Contoso необходимо разобраться, как управлять подписками Azure. Поскольку компания Contoso имеет соглашение EA, ограничение на количество создаваемых подписок Azure не ограничено.

- Регистрация Соглашение Enterprise Azure определяет, как фигуры компании и используют службы Azure, и определяет основную структуру управления.
- В качестве первого шага компания Contoso определила структуру, известную как корпоративный механизм для регистрации. Компания Contoso использовала [руководство по формированию шаблонов Azure Enterprise](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-subscription-governance) , чтобы помочь понять и спроектировать шаблон.
- На данном этапе в Contoso решили использовать для управления подписками функциональный подход.
  - Внутри предприятия будет использоваться один отдел ИТ, который управляет бюджетом Azure. Это будет единственная группа с подписками.
  - Компания Contoso будет расширять эту модель в будущем, чтобы другие корпоративные группы могли присоединяться в качестве отделов в иерархии регистрации.
  - Внутри ИТ-отдела компания Contoso имеет структурированные две подписки `Production` и `Development` .
  - Если в будущем для компании Contoso требуются дополнительные подписки, необходимо управлять доступом, политиками и соответствием требованиям для этих подписок. Компания Contoso сделает это, представляя [группы управления Azure](https://docs.microsoft.com/azure/azure-resource-manager/management-groups-overview) в качестве дополнительного уровня для подписок.

  ![Иерархия предприятия ](./media/contoso-migration-infrastructure/enterprise-structure.png) _рис. 2. Корпоративная иерархия._

### <a name="examine-licensing"></a>Изучение вариантов лицензирования

После настройки подписок Contoso может переходить к вопросу лицензирования продуктов корпорации Майкрософт. Стратегия лицензирования будет зависеть от ресурсов, которые компания Contoso хочет перенести в Azure, а также о том, как виртуальные машины и службы выбираются и развертываются в Azure.

#### <a name="azure-hybrid-benefit"></a>Преимущество гибридного использования Azure

При развертывании виртуальных машин в Azure стандартные образы включают лицензию, по которой плата за использование программ будет взиматься с Contoso поминутно. Однако компания Contoso была долгосрочным клиентом корпорации Майкрософт и поддерживала EAs и Open Licenses с Software Assurance.

Преимущество гибридного использования Azure предоставляет экономичный метод миграции, позволяя Contoso сохранять данные на виртуальных машинах и SQL Server рабочих нагрузках Azure путем преобразования или повторного использования лицензий Windows Server Datacenter и Standard Edition, охваченных Software Assurance. Это позволяет компании Contoso платить за нижнюю базовую частоту вычислений для виртуальных машин и SQL Server. Дополнительные сведения см. в разделе [преимущество гибридного использования Azure](https://azure.microsoft.com/pricing/hybrid-benefit).

#### <a name="license-mobility"></a>Перемещение лицензий

Перемещение лицензий в рамках Software Assurance позволяет клиентам корпоративного лицензирования Майкрософт, таким как Contoso, гибко развертывать подходящие серверные приложения с активным SA в Azure. Это избавляет от необходимости приобрести новые лицензии. Поскольку за перемещение плата не взимается, имеющиеся лицензии можно легко развернуть в Azure. Дополнительные сведения см. в статье [Перемещение лицензий в рамках программы Software Assurance в Azure](https://azure.microsoft.com/pricing/license-mobility).

#### <a name="reserve-instances-for-predictable-workloads"></a>Зарезервированные экземпляры для прогнозируемых рабочих нагрузок

Прогнозируемые рабочие нагрузки — это те, которые всегда должны быть доступны для виртуальных машин, работающих под управлением, таких как бизнес-приложения, такие как система SAP ERP. С другой стороны, непредсказуемые рабочие нагрузки — это такие переменные, как виртуальные машины, которые находятся в процессе высокой нагрузки и отключены при низкой потребности.

![Azure Reserved Virtual Machine Instances ](./media/contoso-migration-infrastructure/reserved-instance.png)
 _рис. 3. Azure reserved Virtual Machine Instances._

В Exchange для использования зарезервированных экземпляров для конкретных экземпляров виртуальных машин необходимо хранить в течение длительного времени, Contoso может получить как скидку, так и приоритетную емкость. Использование [Azure reserved Virtual Machine Instances](https://azure.microsoft.com/pricing/reserved-vm-instances) вместе с преимущество гибридного использования Azure может сэкономить Contoso до 82 процентов от обычных цен с оплатой по мере использования (по состоянию на апрель 2018).

## <a name="step-2-manage-hybrid-identity"></a>Шаг 2. Управление гибридными удостоверениями

Предоставление пользователям контролируемого доступа к ресурсам Azure с помощью Системы управления идентификацией и доступом (IAM) — важный шаг на пути к объединению инфраструктуры Azure.

- Компания Contoso решает расширить свои локальные Active Directory в облако, а не создавать новую отдельную систему в Azure
- Поскольку компания Contoso еще не использует Office 365, ей необходимо подготавливать экземпляр Azure Active Directory (Azure AD). Если компания Contoso использовала Office 365, у нее уже есть существующий клиент и каталог Azure AD, который может использоваться в качестве своего основного экземпляра Azure AD.
- Дополнительные сведения о [моделях удостоверений Microsoft 365 и Azure Active Directory](https://docs.microsoft.com/office365/enterprise/about-office-365-identity).
- Узнайте, как [связать или добавить подписку Azure в клиент Azure Active Directory](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory).

### <a name="create-an-azure-ad-directory"></a>Создание каталога Azure AD

Contoso использует выпуск Azure AD Free, который предоставляется вместе с подпиской Azure. Администраторы Contoso создают каталог Azure AD:

На [портале Azure](https://portal.azure.com) они выбирают пункты **Создать ресурс** > **Удостоверение** > **Azure Active Directory**.

В поле **создать каталог**укажите имя каталога, исходное доменное имя и регион, в котором должен быть создан каталог.

![Создание каталога Azure AD ](./media/contoso-migration-infrastructure/azure-ad-create.png)
 _рис. 4. Создание каталога Azure AD._

> [!NOTE]
> Созданный каталог имеет исходное доменное имя в форме `domain-name.onmicrosoft.com` . Это имя нельзя изменить или удалить. Вместо этого необходимо добавить свое зарегистрированное доменное имя в Azure AD.

### <a name="add-the-domain-name"></a>Добавление доменного имени

Чтобы использовать стандартное доменное имя, администраторам Contoso необходимо добавить его в качестве имени личного домена в Azure AD. Эта возможность позволяет им назначать привычные имена пользователей. Например, пользователь может войти, используя адрес электронной почты, `billg@contoso.com` а не `billg@contosomigration.microsoft.com` .

Чтобы настроить пользовательское доменное имя, добавьте его в каталог, добавьте запись DNS, а затем проверьте имя в Azure AD.

1. В области **пользовательские доменные имена**  >  **добавьте личный домен**, чтобы добавить домен.
2. Чтобы использовать DNS-запись в Azure, необходимо зарегистрировать ее в регистраторе домена.

    - При этом они записывают сведения о DNS для этого имени, указанные в списке **Имена пользовательских доменов**. Он использует MX-запись.
    - Для этого компании необходим доступ к DNS-серверу. Они входят в `contoso.com` домен и создают новую запись MX для записи DNS, предоставленной Azure AD, с помощью указанных здесь сведений.

3. После распространения записей DNS выберите **проверить** , чтобы проверить имя личного домена в имени сведений для домена.

     ![Azure AD DNS ](./media/contoso-migration-infrastructure/azure-ad-dns.png) _рис. 5. Проверка доменного имени._

### <a name="set-up-on-premises-and-azure-groups-and-users"></a>Настройка локальной среды, а также групп и пользователей Azure

Теперь, когда каталог Azure AD установлен, администраторам Contoso необходимо добавить сотрудников в локальные Active Directory группы, которые будут синхронизироваться с Azure AD. Им следует использовать имена локальных групп, которые соответствуют именам групп ресурсов в Azure. Это упрощает определение совпадений в целях синхронизации.

#### <a name="create-resource-groups-in-azure"></a>Создание групп ресурсов в Azure

Группы ресурсов Azure объединяют ресурсы Azure. Идентификатор группы ресурсов позволяет выполнять операции с ресурсами в пределах группы. Подписка Azure может иметь несколько групп ресурсов. Группа ресурсов существует в одной подписке. Кроме того, одна группа ресурсов может иметь несколько ресурсов. Ресурс принадлежит к одной группе ресурсов. Администраторы Contoso настроили группы ресурсов Azure, как показано в следующей таблице.

| Группа ресурсов | Сведения |
| --- | --- |
| `ContosoCobRG` | Эта группа содержит все ресурсы, связанные с непрерывностью бизнеса. Она включает хранилища, которые Contoso будет использовать для службы Azure Site Recovery, и службу Azure Backup. <br><br> Сюда также входят ресурсы, используемые для миграции, включая Azure Migration and Azure Database Migration Service. |
| `ContosoDevRG` | Эта группа содержит ресурсы для разработки и тестирования. |
| `ContosoFailoverRG` | Эта группа служит площадкой для размещения ресурсов, используемых для выполнения отработки отказа. |
| `ContosoNetworkingRG` | Эта группа содержит все сетевые ресурсы. |
| `ContosoRG` | Эта группа содержит ресурсы, связанные с рабочими приложениями и базами данных. |

Группы ресурсов в Azure создаются в соответствии с описанной ниже процедурой.

1. На портале Azure нужно выбрать **Группы ресурсов** и добавить группу.
2. Для каждой группы указываются имя, подписка, к которой принадлежит группа, и регион.
3. Группы ресурсов отображаются в списке **Группы ресурсов**.

  ![Группы ресурсов ](./media/contoso-migration-infrastructure/resource-groups.png)
   _рис. 6. группы ресурсов._

##### <a name="scale-resource-groups"></a>Масштабирование групп ресурсов

В будущем специалисты Contoso будут добавлять другие группы ресурсов по мере необходимости. Например, они могут определить группу ресурсов для каждого приложения или службы, чтобы каждый мог управляться и защищаться независимо друг от друга.

#### <a name="create-matching-security-groups-on-premises"></a>Создание соответствующих групп безопасности в локальной среде

В локальной службе Active Directory администраторы Contoso настраивают группы безопасности, имена которых соответствуют именам групп ресурсов в Azure.

![Локальные Active Directory группы безопасности ](./media/contoso-migration-infrastructure/on-premises-ad.png)
 _рис. 7. локальные Active Directory группы безопасности._

Для управления создаются дополнительные группы, которые будут добавлены во все остальные группы. У этой группы будут права для всех групп ресурсов в Azure. В эту группу будет добавлено ограниченное число глобальных администраторов.

### <a name="synchronize-active-directory"></a>Синхронизация Active Directory

Contoso требуется предоставить общее удостоверение для доступа к ресурсам в локальной среде и в облаке. Для этого необходимо интегрировать локальную службу Active Directory с Azure AD. Эта модель позволяет пользователям и организациям использовать единое удостоверение для доступа к локальным приложениям и облачным службам, таким как Office 365 или тысячи других сайтов в Интернете. Администраторы могут использовать группы в Active Directory для реализации [управления доступом на основе ролей (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal) в Azure.

Для упрощения интеграции Contoso использует [средство Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect). При установке и настройке средства на контроллере домена он синхронизирует локальные удостоверения Active Directory с Azure AD.

### <a name="download-the-tool"></a>Скачивание средства

1. В портал Azure администраторы Contoso переходят на **Azure Active Directory**  >  **Azure AD Connect** и скачайте последнюю версию средства на сервер, который они используют для синхронизации.

    ![Загрузка Azure AD Connect ](./media/contoso-migration-infrastructure/download-ad-connect.png) _рис. 8. Загрузка Azure AD Connect._

2. Они начинают `AzureADConnect.msi` установку с помощью стандартных **параметров**. Это наиболее распространенная установка, которую можно использовать для топологии с одним лесом с синхронизацией хэша паролей для проверки подлинности.

    ![Мастер Azure AD Connect ](./media/contoso-migration-infrastructure/ad-connect-wiz1.png) _рис. 9. Мастер Azure AD Connect._

3. При **подключении к Azure AD**они указывают учетные данные для подключения к Azure AD (в форме `admin@contoso.com` или `admin@contoso.onmicrosoft.com` ).

    ![Мастер Azure AD Connect: подключение к Azure AD ](./media/contoso-migration-infrastructure/ad-connect-wiz2.png) _рис. 10. Мастер Azure AD Connect: подключение к Azure AD._

4. В окне **Подключение к AD DS**они указывают учетные данные для локального каталога (в форме `CONTOSO\admin` или `contoso.com\admin` ).

     ![Мастер Azure AD Connect: подключение к AD DS ](./media/contoso-migration-infrastructure/ad-connect-wiz3.png) _рис. 11. Мастер Azure AD Connect: подключение к AD DS._

5. В окне **Готово к настройке** они выбирают **Запустить синхронизацию сразу после завершения настройки**, чтобы незамедлительно начать синхронизацию. Затем они устанавливают средство.

    Обратите внимание на следующее.

    - У Contoso есть прямое подключение к Azure. Если локальная Active Directory находится за прокси-сервером, ознакомьтесь с [разрешениями устранение неполадок с подключением к Azure AD](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-troubleshoot-connectivity).

    - После первой синхронизации локальные объекты Active Directory отображаются в каталоге Azure AD.

      ![Локальные Active Directory объекты, видимые в Azure AD ](./media/contoso-migration-infrastructure/on-premises-ad-groups.png)
     _рис. 12. локальные Active Directory объекты, видимые в Azure AD._

    - Группа Contoso IT представлена в каждой группе и основана на ее роли.

      ![Членство в группе ](./media/contoso-migration-infrastructure/on-premises-ad-group-members.png)
     _рис. 13. членство в группе._

### <a name="set-up-rbac"></a>Настройка RBAC

Azure [RBAC](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal) обеспечивает детальное управление доступом для Azure. С помощью RBAC можно предоставлять пользователям именно такой уровень доступа, который необходим для выполнения поставленных перед ними задач. Вы назначаете соответствующую роль RBAC пользователям, группам и приложениям на уровне области. Областью назначения роли может быть подписка, группа ресурсов или отдельный ресурс.

Администраторы Contoso назначают роли группам Active Directory, которые они синхронизированы из локальной среды.

1. В `ControlCobRG` группе ресурсов они выбирают пункт **Управление доступом (IAM)**  >  **добавить назначение ролей**.
2. Участник роли **Добавить роль назначения ролей**  >  **Role**  >  **Contributor**выбирает `ContosoCobRG` группу безопасности из списка. После этого группа появляется в списке **Выбранные элементы**.
3. Они повторяются с теми же разрешениями для других групп ресурсов (кроме `ContosoAzureAdmins` ) путем добавления `Contributor` разрешений в группу безопасности, которая соответствует группе ресурсов.
4. Для `ContosoAzureAdmins` группы безопасности они назначают `Owner` роль.

    ![Локальные группы Azure AD ](./media/contoso-migration-infrastructure/on-premises-ad-groups.png) _рис. 14. Назначение ролей группам безопасности._

## <a name="step-3-design-for-resiliency"></a>Шаг 3. Проектирование для обеспечения устойчивости

### <a name="set-up-regions"></a>Настройка регионов

Ресурсы Azure развертываются в пределах регионов.

- Регионы организованы в географических регионах, а требования к местонахождение данных, независимости, соответствия требованиям и устойчивости учитываются в географических границах.
- Регион состоит из совокупности центров обработки данных. Эти центры обработки данных развертываются в пределах периметра с определенной задержкой и соединяются между собой выделенной региональной сетью с низкой задержкой.
- Для обеспечения устойчивости каждый регион Azure связывается с другим регионом.
- Просмотрите дополнительные сведения о [регионах Azure](https://azure.microsoft.com/global-infrastructure/regions) и [связывании областей](https://docs.microsoft.com/azure/best-practices-availability-paired-regions).

Компания Contoso решила использовать `East US 2` (находится в Виргиния) в качестве основного региона и `Central US` (находится в Айова) в качестве дополнительного региона по нескольким причинам.

- Центр обработки данных Contoso находится в Нью-Йорке, поэтому учитывалась задержка при передаче данных в ближайший центр обработки данных.
- `East US 2`содержит все службы и продукты, необходимые компании Contoso. Не все регионы Azure имеют одни и те же продукты и службы. Дополнительные сведения см. в статье [продукты Azure по регионам](https://azure.microsoft.com/global-infrastructure/services).
- `Central US`— Это парный регион Azure для `East US 2` .

При проектировании гибридной среды специалистам Contoso необходимо учитывать то, как стратегия обеспечения устойчивости и аварийного восстановления впишется в структуру региона. Стратегии могут варьироваться от развертывания в одном регионе, которое использует функции платформы Azure, такие как домены сбоя и региональные пары для обеспечения устойчивости, до полной активной модели, в которой развертываются и обслуживаются пользователи из двух регионов.

Компания Contoso выбрала срединный путь. Он развертывает приложения и ресурсы в основном регионе и сохраняет полную копию инфраструктуры в дополнительном регионе, чтобы она была готова к работе в качестве полной резервной копии, если происходит завершение работы приложения или регионального сбоя.

### <a name="set-up-availability"></a>Настройка доступности

**Группы доступности:**

Группы доступности помогают защитить приложения и данные от сбоя локального оборудования и сети в центре обработки данных.

- Группы доступности позволяют распределить виртуальные машины Azure между разными физическими устройствами в центре обработки данных.
- Домены сбоя представляют базовое оборудование с общим источником питания и сетевым коммутатором в центре обработки данных. Виртуальные машины в группе доступности распределяются по разным доменам сбоя для снижения простоев, вызываемых сбоем отдельного оборудования или сети.
- Домены обновления представляют базовое оборудование, которое может одновременно обслуживаться или перезагружаться. Группы доступности также позволяют распределить виртуальные машины между несколькими доменами обновления, чтобы гарантировать, что в любой момент времени хотя бы один экземпляр будет выполняться.

Компания Contoso реализует группы доступности, когда для рабочих нагрузок виртуальной машины требуется высокий уровень доступности. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability).

**Зоны доступности:**

Зоны доступности помогает защитить приложения и данные от сбоев, затрагивающих весь центр обработки данных в пределах одного региона.

- Каждая зона доступности представляет уникальное физическое расположение в регионе Azure.
- Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия.
- Во всех включенных регионах используется как минимум три отдельные зоны.
- Физическое разделение зон в пределах региона защищает приложения и данные от сбоев на уровне центров обработки данных.

Contoso будет использовать Зоны доступности каждый раз, когда приложениям требуется большая масштабируемость, доступность и устойчивость. Дополнительные сведения см. [в статье регионы и зоны доступности в Azure](https://docs.microsoft.com/azure/availability-zones/az-overview).

### <a name="configure-backup"></a>Настройка резервного копирования

**Azure Backup:**

Azure Backup позволяет выполнять резервное копирование и восстановление дисков виртуальных машин Azure.

- Azure Backup позволяет автоматически создавать резервные копии образов дисков виртуальных машин, хранящихся в службе хранилища Azure.
- Резервные копии являются согласованными с приложениями. Это гарантирует, что резервные копии данных являются транзакционно согласованными и после восстановления приложения будут загружены.
- Azure Backup поддерживает локально избыточное хранилище (LRS) для репликации нескольких копий данных резервных копий в пределах одного центра, если происходит сбой локального оборудования.
- Если происходит региональный сбой, Azure Backup также поддерживает геоизбыточное хранилище (GRS), репликацию резервных данных в дополнительный парный регион.
- Azure Backup шифрует транзитные данные с помощью AES-256. Резервные копии неактивных данных шифруются с помощью [шифрования службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-service-encryption).

Contoso будет использовать Azure Backup с GRS на всех рабочих виртуальных машинах, чтобы обеспечить резервное копирование данных рабочей нагрузки и быстро восстановить их в случае сбоя. Дополнительные сведения см. [в обзоре резервного копирования виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-introduction).

### <a name="set-up-disaster-recovery"></a>Настройка аварийного восстановления

**Azure Site Recovery:**

Azure Site Recovery помогает обеспечить непрерывность бизнес-процессов, обеспечивая выполнение бизнес-приложений и рабочих нагрузок во время региональных сбоев.

- Azure Site Recovery постоянно реплицирует виртуальные машины Azure из базы данных-источника в дополнительный регион, обеспечивая функциональные копии в обоих расположениях.
- В случае сбоя в основном регионе ваше приложение или служба переключаются на использование экземпляров виртуальных машин, реплицированных в дополнительном регионе, что сводит к минимуму вероятность нарушения работы.
- После возврата к нормальному режиму работы восстанавливается размещение приложений или служб на виртуальных машинах в основном регионе.

Компания Contoso реализует [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview) для всех рабочих виртуальных машин, используемых в критически важных рабочих нагрузках, что обеспечивает минимальный перерыв во время сбоя в основном регионе.

## <a name="step-4-design-a-network-infrastructure"></a>Шаг 4. Проектирование сетевой инфраструктуры

Так как у компании Contoso уже есть проект инфраструктуры для регионов, она готова к разработке стратегии организации сетевых подключений. Компании следует выбрать подключение и способ обмена данными между ее локальным центром обработки данных и Azure, а также определить принципы проектирования сетевой инфраструктуры в Azure. В частности, компании Contoso необходимо выполнить указанные ниже действия.

- **Планирование гибридного подключения к сети.** Определить, как будут соединены сети локальной среды и Azure.
- **Проектирование сетевой инфраструктуры Azure.** Решить, как будут развертываться сети в разных регионах. Как сети будут взаимодействовать в пределах одного или нескольких регионов?
- **Разработка и настройка сетей Azure.** Настроить сети и подсети Azure и решить, что будет в них находиться.

### <a name="plan-hybrid-network-connectivity"></a>Планирование возможности подключения к сети в гибридной среде

В Contoso рассмотрели [несколько вариантов архитектуры](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking) для организации гибридных сетевых подключений между Azure и локальным центром обработки данных. Дополнительные сведения см. в статье [Выбор решения для подключения локальной сети к Azure](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/considerations).

Как напоминание, локальная сетевая инфраструктура Contoso в настоящее время состоит из центра обработки данных в Нью-Йорке и локальных ветвей в восточной половине США. Во всех расположениях есть подключение к Интернету бизнес-класса. Затем каждая из ветвей подключается к центру обработки данных через VPN-туннель IPsec через Интернет.

![Contoso Network ](./media/contoso-migration-infrastructure/contoso-networking.png)
 _рис. 15. сеть Contoso._

Компания Contoso решила реализовать гибридные подключения следующим образом.

1. Настройте новое VPN-подключение типа "сеть — сеть" между центром обработки данных Contoso в Нью-Йорке и двумя регионами Azure `East US 2` и `Central US` .
2. Привязка трафика филиала для виртуальных сетей в Azure будет проходить через главный центр обработки данных Contoso.
3. В ходе увеличения масштаба развертывания Azure компания Contoso установит подключение ExpressRoute между центром обработки данных и регионами Azure. В этом случае Contoso будет хранить VPN-подключение типа "сеть — сеть" только в целях отработки отказа.
    - Узнайте больше о [выборе между гибридным РЕШЕНИЕМ VPN и ExpressRoute](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/considerations).
    - Ознакомьтесь с [месторасположением и возможностями поддержки ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-locations-providers).

**Только VPN:**

![Contoso VPN ](./media/contoso-migration-infrastructure/hybrid-vpn.png)
 _рис. 16. VPN-подключение contoso._

**VPN и ExpressRoute:**

![Contoso VPN и ExpressRoute ](./media/contoso-migration-infrastructure/hybrid-vpn-expressroute.png)
 _рис. 17. contoso VPN и expressroute._

### <a name="design-the-azure-network-infrastructure"></a>Проектирование сетевой инфраструктуры Azure

Конфигурация сети компании Contoso должна обеспечивать безопасность и масштабируемость гибридного развертывания. Contoso занимается долгосрочным подходом, создавая виртуальные сети для устойчивых и готовых к работе в Организации. Дополнительные сведения см. в статье [Планирование виртуальных сетей](https://docs.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm).

Для подключения двух регионов компания Contoso будет реализовывать модель сети типа "концентратор-концентратор". В каждом регионе она будет использовать звездообразную модель. Для подключения сетей и концентраторов будет использоваться пиринг сетей Azure.

#### <a name="network-peering"></a>Пиринг сетей

[Пиринг виртуальных](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) сетей в Azure подключает виртуальные сети и концентраторы. Глобальный пиринг разрешает подключения между виртуальной сетью или концентраторами в разных регионах. Локальный пиринг подключает виртуальные сети в одном регионе. Пиринг виртуальных сетей предоставляет несколько преимуществ.

- Сетевой трафик между одноранговыми виртуальными сетями остается закрытым.
- Трафик между виртуальными сетями хранится в магистральной сети Майкрософт. При обмене данными между виртуальными сетями не требуется общий доступ к Интернету, шлюзы или шифрование.
- Пиринг обеспечивает подключение по умолчанию между ресурсами в разных виртуальных сетях, характеризующееся низкой задержкой и высокой пропускной способностью.

#### <a name="hub-to-hub-across-regions"></a>Радиально-узловая топология сети между регионами

Contoso развернет концентраторы в каждом регионе. Концентратор — это виртуальная сеть в Azure, которая выступает в качестве центральной точки подключения к локальной сети. Концентратор виртуальных сетей будет подключаться друг к другу через глобальную пиринг виртуальных сетей, который подключает виртуальных сетей между регионами Azure. Концентратор в каждом регионе выполняет роль кэширующего узла для непосредственно подключенного к нему концентратора в другом регионе. Концентратор является одноранговым по отношению к каждой сети в своем регионе и может подключаться ко всем сетевым ресурсам.

![Глобальный пиринг ](./media/contoso-migration-infrastructure/global-peering.png)
 _, рис. 18. Глобальный пиринг._

#### <a name="hub-and-spoke-model-within-a-region"></a>Модель "звезда" в пределах региона

В каждом регионе Contoso будет развертывать виртуальных сетей для различных целей в качестве периферийных сетей из центра регионов. Виртуальных сетей в пределах региона использует пиринг для подключения к концентратору и друг другу.

#### <a name="design-the-hub-network"></a>Проектирование сети-концентратора

В модели концентратора и звезды, выбранной компанией Contoso, необходимо подумать о том, как будет маршрутизироваться трафик из локального центра обработки данных и из Интернета. Вот как компания Contoso решила управлять маршрутизацией как для `East US 2` концентраторов, так и для `Central US` :

- Компания Contoso разрабатывает сеть, которая разрешает трафик из Интернета, а также из корпоративной сети, используя VPN-подключение к Azure.
- Такая архитектура сети имеет две границы, ненадежную внешнюю зону по периметру и надежную внутреннюю зону.
- Брандмауэр в каждой зоне будет оснащен сетевым адаптером, управляющим доступом к надежным зонам.
- При передаче данных из Интернета:
  - Интернет-трафик будет поступать на общедоступный IP-адрес с балансировкой нагрузки в сети периметра.
  - Этот трафик направляется через брандмауэр и подчиняется правилам брандмауэра.
  - После реализации управления доступом к сети трафик будет переадресован в соответствующее расположение в надежной зоне.
  - Исходящий трафик из виртуальной сети будет направляться в Интернет с использованием определяемых пользователем маршрутов. Трафик принудительно проходит через брандмауэр и проверяется в соответствии с политиками contoso.
- При передаче данных из центра обработки данных Contoso:
  - Входящий трафик через VPN типа "сеть — сеть" или ExpressRoute достигает общедоступного IP-адреса VPN-шлюза Azure.
  - Он проходит через брандмауэр, где к нему применяются правила брандмауэра.
  - После применения брандмауэра правил трафик переадресовывается во внутреннюю подсистему балансировки нагрузки (для стандартных номеров SKU) в подсеть надежной внутренней зоны.
  - Исходящий трафик из доверенной подсети в локальный центр обработки данных через VPN направляется через брандмауэр и правила, применяемые перед подключением VPN типа "сеть — сеть".

### <a name="design-and-set-up-azure-networks"></a>Проектирование и настройка сетей Azure

Теперь у компании Contoso есть топология сети и маршрутизации, поэтому специалисты могут приступать к настройке сетей и подсетей Azure.

<!-- docsTest:ignore "class B" -->

- Компания Contoso будет реализовывать класс с частной сетью в Azure ( `10.0.0.0/8` ). Это работает так же, как в локальной среде, в настоящее время имеет закрытое адресное пространство класса B ( `172.160.0.0/16` ), поэтому компания Contoso может гарантировать, что между диапазонами адресов не будет перекрытия.
- Компания Contoso будет развертывать виртуальных сетей как в основном, так и в дополнительном регионах.
- Contoso будет использовать соглашение об именовании, включающее префикс, `VNET` сокращенное название региона `EUS2` или `CUS` . При использовании этого стандарта сети концентраторов будут называться `VNET-HUB-EUS2` в `East US 2` регионе и `VNET-HUB-CUS` в `Central US` регионе.

#### <a name="virtual-networks-in-east-us-2"></a>Виртуальные сети в`East US 2`

`East US 2`— Это основной регион, который компания Contoso будет использовать для развертывания ресурсов и служб. Вот как Contoso будет проектировать сети в этом регионе:

- **Центр:** Виртуальная сеть концентратора в `East US 2` считается своим основным подключением к локальному центру обработки данных.
- **Виртуальные сети:** Периферийный виртуальных сетей в `East US 2` может использоваться для изоляции рабочих нагрузок, если это необходимо. В дополнение к виртуальной сети Hub компания Contoso будет иметь два виртуальных сетейа в `East US 2` :
  - `VNET-DEV-EUS2`. Эта виртуальная сеть предоставит команде разработки и тестирования полностью функциональную сеть для проектов разработки. Она будет выступать в качестве рабочей пилотной площадки и использовать инфраструктуру рабочей среды.
    - `VNET-PROD-EUS2`. В этой сети будут размещены рабочие компоненты Azure IaaS.
  - Каждая виртуальная сеть будет иметь собственное уникальное адресное пространство без перекрытия. В Contoso намерены настроить маршрутизацию, не требующую NAT.
- **Подсети**
  - Для каждого уровня приложения будет использоваться подсеть в каждой сети.
  - Каждая подсеть в рабочей сети будет иметь подходящую подсеть в виртуальной среде разработки.
  - Кроме того, в рабочей сети есть подсеть для контроллеров домена.

Виртуальных сетей в приведены `East US 2` в следующей таблице.

| Виртуальная сеть | Диапазон | Одноранговый узел |
| --- | --- | --- |
| `VNET-HUB-EUS2` | `10.240.0.0/20` | `VNET-HUB-CUS2`, `VNET-DEV-EUS2`, `VNET-PROD-EUS2` |
| `VNET-DEV-EUS2` | `10.245.16.0/20` | `VNET-HUB-EUS2` |
| `VNET-PROD-EUS2` | `10.245.32.0/20` | `VNET-HUB-EUS2`, `VNET-PROD-CUS` |

![Модель "звезда" в основном регионе ](./media/contoso-migration-infrastructure/primary-hub-peer.png)
 _рис. 19. модель "звезда"._

#### <a name="subnets-in-the-east-us-2-hub-network-vnet-hub-eus2"></a>Подсети в `East US 2 Hub` сети ( `VNET-HUB-EUS2` )

| Подсеть/зона | CIDR | Пригодные для использования IP-адреса |
| --- | --- | --- |
| `IB-UntrustZone` | `10.240.0.0/24`  | 251 |
| `IB-TrustZone`   | `10.240.1.0/24`  | 251 |
| `OB-UntrustZone` | `10.240.2.0/24`  | 251 |
| `OB-TrustZone`   | `10.240.3.0/24`  | 251 |
| `GatewaySubnet`  | `10.240.10.0/24` | 251 |

#### <a name="subnets-in-the-east-us-2-development-network-vnet-dev-eus2"></a>Подсети в `East US 2` сети разработки ( `VNET-DEV-EUS2` )

Виртуальная сеть разработки используется группой разработчиков в качестве рабочей пилотной области. Он имеет три подсети:

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `DEV-FE-EUS2` | `10.245.16.0/22` | 1019 | Интерфейсные виртуальные машины и виртуальные машины веб-уровня |
| `DEV-APP-EUS2` | `10.245.20.0/22` | 1019 | Виртуальные машины уровня приложения |
| `DEV-DB-EUS2` | `10.245.24.0/23` | 507 | Виртуальные машины баз данных |

#### <a name="subnets-in-the-east-us-2-production-network-vnet-prod-eus2"></a>Подсети в `East US 2` рабочей сети ( `VNET-PROD-EUS2` )

Компоненты Azure IaaS находятся в рабочей сети. Каждый уровень приложения имеет собственную подсеть. Подсети соответствуют параметрам в сети разработки с добавлением подсети для контроллеров домена.

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `PROD-FE-EUS2` | `10.245.32.0/22` | 1019 | Интерфейсные виртуальные машины или виртуальные машины веб-уровня |
| `PROD-APP-EUS2` | `10.245.36.0/22` | 1019 | Виртуальные машины уровня приложения |
| `PROD-DB-EUS2` | `10.245.40.0/23` | 507 | Виртуальные машины баз данных |
| `PROD-DC-EUS2` | `10.245.42.0/24` | 251 | Виртуальные машины контроллеров домена |

![Архитектура сети концентратора ](./media/contoso-migration-infrastructure/azure-networks-eus2.png)
 _рис. 20. Архитектура сети концентратора._

#### <a name="virtual-networks-in-central-us-secondary-region"></a>Виртуальные сети в `Central US` (дополнительный регион)

`Central US`является дополнительным регионом contoso. Вот как компания Contoso спроектирует сети в этом регионе:

- **Центр:** Виртуальная сеть концентратора в `Central US` рассматривается как вторичная точка подключения к локальному центру обработки данных, а периферийная виртуальных сетей в `Central US` может использоваться для изоляции рабочих нагрузок при необходимости, управляемой отдельно от других периферийных зон.
- **Виртуальных сетей:** Contoso будет иметь два виртуальных сетей в `Central US` :
  - `VNET-PROD-CUS`: Эта виртуальная сеть является рабочей сетью и может рассматриваться как вторичный концентратор.
  - `VNET-ASR-CUS`. Эта виртуальная сеть будет использоваться в качестве расположения, в котором виртуальные машины создаются после отработки отказа из локальной среды, или в качестве расположения для виртуальных машин Azure, которые отправляются из базы данных-источника в дополнительный регион. Эта сеть аналогична рабочим сетям, но без контроллеров домена.
  - Каждая виртуальная сеть в регионе будет иметь свое адресное пространство без перекрытия. В Contoso настроят маршрутизацию без NAT.
- **Подсети:** Подсети будут спроектированы так же, как и в `East US 2` .

Виртуальных сетей в представлен `Central US` в следующей таблице.

| Виртуальная сеть | Диапазон | Одноранговый узел |
| --- | --- | --- |
| `VNET-HUB-CUS` | `10.250.0.0/20` | `VNET-HUB-EUS2`, `VNET-ASR-CUS`, `VNET-PROD-CUS` |
| `VNET-ASR-CUS` | `10.255.16.0/20` | `VNET-HUB-CUS`, `VNET-PROD-CUS` |
| `VNET-PROD-CUS` | `10.255.32.0/20` | `VNET-HUB-CUS`, `VNET-ASR-CUS`, `VNET-PROD-EUS2` |

![Модель "звезда" в парном регионе ](./media/contoso-migration-infrastructure/paired-hub-peer.png)
 _рис. 21. модель "звезда" в парном регионе._

#### <a name="subnets-in-the-central-us-hub-network-vnet-hub-cus"></a>Подсети в центральной сети центра США ( `VNET-HUB-CUS` )

| Подсеть | CIDR | Пригодные для использования IP-адреса |
| --- | --- | --- |
| `IB-UntrustZone` | `10.250.0.0/24` | 251 |
| `IB-TrustZone` | `10.250.1.0/24` | 251 |
| `OB-UntrustZone` | `10.250.2.0/24` | 251 |
| `OB-TrustZone` | `10.250.3.0/24` | 251 |
| `GatewaySubnet` | `10.250.2.0/24` | 251 |

#### <a name="subnets-in-the-central-us-production-network-vnet-prod-cus"></a>Подсети в Центральной рабочей сети США ( `VNET-PROD-CUS` )

Параллельно с рабочей сетью в основном регионе ( `East US 2` ) есть рабочая сеть в дополнительном регионе ( `Central US` ).

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `PROD-FE-CUS` | `10.255.32.0/22` | 1019 | Интерфейсные виртуальные машины и виртуальные машины веб-уровня |
| `PROD-APP-CUS` | `10.255.36.0/22` | 1019 | Виртуальные машины уровня приложения |
| `PROD-DB-CUS` | `10.255.40.0/23` | 507 | Виртуальные машины баз данных |
| `PROD-DC-CUS` | `10.255.42.0/24` | 251 | Виртуальные машины контроллеров домена |

#### <a name="subnets-in-the-central-us-failoverrecovery-network-in-central-us-vnet-asr-cus"></a>Подсети в центральной сети для отработки отказа и восстановления в центральной области США ( `VNET-ASR-CUS` )

`VNET-ASR-CUS`Сеть используется для отработки отказа между регионами. Для репликации и отработки отказа виртуальных машин Azure между регионами будет использоваться Site Recovery. Она также работает как центр обработки данных Contoso в сети Azure для защищенных рабочих нагрузок, которые остаются в локальной среде, но отработки отказа в Azure для аварийного восстановления.

`VNET-ASR-CUS`— Это та же самая базовая подсеть, что и Рабочая виртуальная сеть в восточной части США 2, но без необходимости подсети контроллера домена.

| Подсеть | CIDR | Адреса | Компоненты в подсети |
| --- | --- | --- | --- |
| `ASR-FE-CUS` | `10.255.16.0/22` | 1019 | Интерфейсные виртуальные машины и виртуальные машины веб-уровня |
| `ASR-APP-CUS` | `10.255.20.0/22` | 1019 | Виртуальные машины уровня приложения |
| `ASR-DB-CUS` | `10.255.24.0/23` | 507 | Виртуальные машины баз данных |

![Архитектура сети центра ](./media/contoso-migration-infrastructure/azure-networks-cus.png)
 _рис. 22. Архитектура сети концентратора._

#### <a name="configure-peered-connections"></a>Настройка пириговых подключений

Центр в каждом регионе будет соединен с концентратором в другом регионе и ко всем виртуальных сетей в центральном регионе. Это позволяет концентраторам обмениваться данными и просматривать все виртуальных сетей в пределах региона. Обратите внимание, что пиринг создает двустороннее подключение — одно из инициирующих узлов в первой виртуальной сети, а другое — во второй. При гибридном развертывании трафик между кэширующими узлами должен быть доступен через VPN-подключение между локальным центром обработки данных и Azure. Для этого необходимо установить определенные параметры для пиринговых подключений. Для любых подключений из периферийной виртуальных сетей через центр к локальному центру обработки данных компания Contoso должна разрешить перенаправление трафика и поверх VPN-шлюзов.

##### <a name="domain-controller"></a>Контроллер домена

Для контроллеров домена в `VNET-PROD-EUS2` сети компания Contoso хочет, чтобы трафик находящегося между `EUS2` основной или рабочей сетью и VPN-подключением к локальной среде. Для этого администраторы Contoso должны иметь следующие разрешения:

1. Специалисты компании должны **разрешить переадресацию трафика** и **разрешить конфигурации с транзитом через шлюз** для пирингового соединения. В нашем примере это будет `VNET-HUB-EUS2` `VNET-PROD-EUS2` соединение.

    ![Пиринг ](./media/contoso-migration-infrastructure/peering1.png) _рис. 23. соединение с одноранговым подключением._

2. **Разрешить перенаправленный трафик** и **использовать удаленные шлюзы** на другой стороне пиринга для `VNET-PROD-EUS2` `VNET-HUB-EUS2` подключения к.

    ![Пиринг ](./media/contoso-migration-infrastructure/peering2.png) _, рисунок 24. соединение с одноранговым подключением._

3. В локальной среде они настраивают статический маршрут, который направляет локальный трафик для маршрутизации через VPN-туннель в виртуальную сеть. Настройка будет завершена на шлюзе, который обеспечивает VPN-туннель из Contoso в Azure. Для этого используется RRAS.

    ![Пиринг ](./media/contoso-migration-infrastructure/peering3.png) _на рис. 25. соединение с одноранговым подключением._

##### <a name="production-networks"></a>Рабочие сети

Из периферийной одноранговой сети невозможно получить доступ к периферийной одноранговой сети в другом регионе через концентратор. Для рабочих сетей Contoso в обоих регионах для просмотра друг друга администраторы Contoso должны создать прямое одноранговое соединение для `VNET-PROD-EUS2` и `VENT-PROD-CUS` .

![Пиринг ](./media/contoso-migration-infrastructure/peering4.png)
 _рис. 26. Создание прямого однорангового подключения._

### <a name="set-up-dns"></a>Настройка DNS

При развертывании ресурсов в виртуальных сетях можно выбрать один из нескольких вариантов разрешения доменных имен. Вы можете использовать разрешение имен, предоставляемое Azure, или предоставить DNS-серверы для разрешения. Тип разрешения имен зависит от способа взаимодействия ресурсов друг с другом. Дополнительные сведения о службе Azure DNS см. в этой [статье](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#azure-provided-name-resolution).

Администраторы Contoso решили, что служба Azure DNS не подходит для гибридной среды. Вместо этого они будут использовать локальные DNS-серверы.

<!-- docsTest:ignore "on premises" -->

- Так как это гибридная сеть, все виртуальные машины в локальной среде и в Azure должны иметь возможность разрешения имен для правильной работы. Это означает, что во всех виртуальных сетях должны быть применены пользовательские параметры DNS.
- Сейчас контроллеры домена Contoso развернуты в центре обработки данных Contoso и в филиалах. Основные DNS-серверы: `contosodc1` ( `172.16.0.10` ) и `contosodc2` ( `172.16.0.1` ).
- После развертывания виртуальных сетей локальные контроллеры домена настраиваются в сети как DNS-серверы.
- Если для виртуальной сети указан необязательный настраиваемый DNS-сервер, виртуальный IP-адрес `168.63.129.16` для рекурсивных арбитров конфликтов в Azure должен быть добавлен в список. Для этого Contoso настроит параметры DNS-серверов в каждой виртуальной сети. Например, настраиваемые параметры DNS для сети будут выглядеть `VNET-HUB-EUS2` следующим образом:

    ![Пользовательский DNS-сервер ](./media/contoso-migration-infrastructure/custom-dns.png) _рис. 27. ПОЛЬЗОВАТЕЛЬСКАЯ служба DNS._

В дополнение к локальным контроллерам домена компания Contoso будет реализовывать четыре дополнительных контроллера домена для поддержки сетей Azure, по два для каждого региона. Это то, что Contoso будет развертывать в Azure:

| Регион | DC | Виртуальная сеть | Подсеть | IP-адрес |
| --- | --- | --- | --- | --- |
| `East US 2` | `contosodc3` | `VNET-PROD-EUS2` | `PROD-DC-EUS2` | `10.245.42.4` |
| `East US 2` | `contosodc4` | `VNET-PROD-EUS2` | `PROD-DC-EUS2` | `10.245.42.5` |
| `Central US` | `contosodc5` | `VNET-PROD-CUS` | `PROD-DC-CUS` | `10.255.42.4` |
| `Central US` | `contosodc6` | `VNET-PROD-CUS` | `PROD-DC-CUS` | `10.255.42.4` |

После развертывания контроллеров домена в локальной среде специалистам Contoso необходимо обновить параметры DNS в сетях обоих регионов, чтобы включить новые контроллеры домена в список DNS-серверов.

#### <a name="set-up-domain-controllers-in-azure"></a>Настройка контроллеров домена в Azure

После обновления параметров сети администраторы Contoso могут приступать к созданию контроллеров домена в Azure.

1. Сотрудники компании развернут на портале Azure новую виртуальную машину с Windows Server в соответствующей виртуальной сети.
2. Они [создают группы доступности](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-availability-sets) в каждом расположении для виртуальной машины. Группы доступности гарантируют, что структура Azure разделяет виртуальные машины на разные инфраструктуры в регионе Azure и позволяет Contoso иметь право на соглашение об уровне обслуживания на 99,95% для виртуальных машин в Azure.

    ![Набор доступности ](./media/contoso-migration-infrastructure/availability-group.png) _рис. 28. Группа доступности._

3. После развертывания виртуальной машины сотрудники компании настраивают для нее сетевой интерфейс. Они устанавливают для частного IP-адреса значение static и указывают допустимый адрес.

    ![Подключение сетевого интерфейса виртуальной машины (NIC) ](./media/contoso-migration-infrastructure/vm-nic.png) _рис. 29. Сетевая карта виртуальной машины._

4. Они присоединяют новый диск данных к виртуальной машине. Этот диск содержит Active Directoryную базу данных и общую папку SYSVOL.
    - От размера диска зависит поддерживаемое количество операций ввода-вывода.
    - Возможно, со временем потребуется увеличить размер диска в связи с увеличением масштабов среды.
    - Для кэширования узла не следует задавать диск для чтения и записи. Базы данных Active Directory это не поддерживают.

     ![Active Directory диск ](./media/contoso-migration-infrastructure/ad-disk.png)
     _рис. 30. диск Active Directory._

5. После добавления диска он подключается к виртуальной машине службы удаленных рабочих столов и открывает диспетчер сервера.

6. Затем в **файлах и службах хранилища**они запускают мастер создания тома, гарантируя, что диску назначена буква F: или выше на локальной виртуальной машине.

     ![Мастер создания тома ](./media/contoso-migration-infrastructure/volume-wizard.png) _рис. 31. Мастер создания тома._

7. В диспетчере сервера сотрудники компании выбирают роль **Доменные службы Active Directory**. Затем они настраивают виртуальную машину в качестве контроллера домена.

      ![Роль сервера ](./media/contoso-migration-infrastructure/server-role.png) _рис. 32. Добавление роли сервера._

8. После того как виртуальная машина будет настроена в качестве контроллера домена и перезагружена, она откроет диспетчер DNS и настроит Azure DNS сопоставитель в качестве сервера пересылки. Это позволяет контроллеру домена переадресовывать в Azure DNS запросы DNS, которые он не может разрешить.

    ![DNS-сервер пересылки ](./media/contoso-migration-infrastructure/dns-forwarder.png) _рис. 33. Настройка Azure DNS револвер._

9. Теперь следует обновить пользовательские параметры DNS для каждой виртуальной сети с помощью соответствующего контроллера домена для ее региона. Поэтому сотрудники компании добавляют в список локальные контроллеры домена.

### <a name="set-up-active-directory"></a>настроить Active Directory;

Active Directory является критической службой в сети и должна быть правильно настроена. Администраторы Contoso будут создавать сайты Active Directory для центра обработки данных Contoso и для `East US 2` `Central US` регионов и.

1. Они создают два новых сайта ( `AZURE-EUS2` и `AZURE-CUS` ) вместе с сайтом центра обработки данных ( `contoso-datacenter` ).
2. После создания площадок они создадут в них подсети, соответствующие виртуальным сетям и центру обработки данных.

    ![Подсети центра обработки данных ](./media/contoso-migration-infrastructure/dc-subnets.png) _рис. 34. подсети центра обработки данных._

3. Затем они создадут для площадок две связи для подключения всех компонентов. После этого контроллеры домена должны быть перемещены в необходимое расположение.

    ![Ссылки на центр обработки данных ](./media/contoso-migration-infrastructure/dc-links.png) _рис. 35. ссылки на центр обработки данных._

4. После настройки всех компонентов топология репликации Active Directory готова к работе.

    ![Репликация центра обработки данных ](./media/contoso-migration-infrastructure/ad-resolution.png) _рис. 36. репликация центра обработки данных._

5. После завершения всех действий список контроллеров домена и сайтов отображается в локальной центр администрирования Active Directory.

    ![Центр администрирования Active Directory ](./media/contoso-migration-infrastructure/ad-center.png) _рис. 37. Центр администрирования Active Directory._

## <a name="step-5-plan-for-governance"></a>Шаг 5. Планирование системы управления

Azure предоставляет ряд средств управления, которыми можно воспользоваться в различных службах и на платформе Azure. Дополнительные сведения см. в статье [Параметры управления Azure](https://docs.microsoft.com/azure/security/governance-in-azure).

Специалисты Contoso уже начали определять некоторые аспекты управления и обеспечения безопасности при настройке удостоверения и управлении доступом. В целом им следует учесть три аспекта:

- **Политика:** Политика Azure применяет и применяет правила и эффекты к ресурсам для обеспечения соответствия корпоративным требованиям и соглашениям об уровне обслуживания.
- **Блокировки:** Azure позволяет блокировать подписки, группы ресурсов и другие ресурсы, чтобы их можно было изменять только с помощью полномочий.
- **Теги:** Ресурсами можно управлять, проводить аудит и управлять ими с помощью тегов. Теги дают возможность связать метаданные ресурсами и предоставляют информацию о ресурсах или владельцах.

### <a name="set-up-policies"></a>Настройка политик

Служба "Политика Azure" выполняет оценку ресурсов, выявляя те из них, которые не соответствуют имеющимся определениям политик. Например, у вас может быть политика, которая допускает только определенные типы виртуальных машин или требует, чтобы ресурсы имели определенный тег.

Политики задают определение политики, а назначение политики определяет область ее применения. Область может варьироваться от группы управления до группы ресурсов. Дополнительные сведения о создании политик и управлении ими см. в этой [статье](https://docs.microsoft.com/azure/governance/policy/tutorials/create-and-manage).

Contoso хочет начать две политики. Требуется политика, позволяющая развертывать ресурсы `East US 2` только в регионах и, `Central US` а также в политике для ограничения номеров SKU виртуальных машин только утвержденными номерами SKU. Это необходимо, чтобы избежать использования дорогостоящих конфигураций виртуальных машин.

#### <a name="limit-resources-to-regions"></a>Ограничение использования ресурсов в регионах

В Contoso используется встроенное определение политики **Разрешенные расположения**, ограничивающей использование ресурсов в регионах.

1. На портале Azure щелкните **Все службы** и выполните поиск по слову **Политика**.
2. Выберите **назначения**  >  **Назначение политики**.
3. Выберите в списке политик **Разрешенные расположения**.
4. В поле **Область** укажите имя подписки Azure и выберите две области в списке разрешенных.

    ![Допустимые расположения, определенные с помощью политики ](./media/contoso-migration-infrastructure/policy-region.png) _рис. 38. Допустимые расположения, определенные с помощью политики._

5. По умолчанию для политики задано значение **Deny**, означающее, что если кто-то запускает развертывание в подписке, которая не находится в `East US 2` `Central US` регионе или, развертывание завершается ошибкой. Вот что произойдет, если кто-то в подписке Contoso попытается настроить развертывание в `West US` .

    ![Сбой политики, ](./media/contoso-migration-infrastructure/policy-failed.png) _Рисунок 39: неудачная политика._

#### <a name="allow-specific-vm-skus"></a>Разрешение использования виртуальных машин с определенными номерами SKU

Contoso будет использовать встроенное определение политики `Allow virtual machine SKUs` для ограничения типов виртуальных машин, которые могут быть созданы в подписке.

![SKU политики ](./media/contoso-migration-infrastructure/policy-sku.png)
 _рис. 40. номер SKU политики._

#### <a name="check-policy-compliance"></a>Проверка соответствия политикам

Политики вступают в силу незамедлительно, и Contoso может проверить ресурсы на соответствие. На портале Azure выберите ссылку **Соответствие требованиям**. Откроется панель мониторинга "Соответствие требованиям". Для отображения дополнительных сведений можно детализировать представление.

  ![Соответствие политике ](./media/contoso-migration-infrastructure/policy-compliance.png) _рис. 41. соответствие политике._

### <a name="set-up-locks"></a>Настройка блокировок

Для управления системами в Contoso длительное время используется платформа ITIL. Один из важнейших аспектов платформы — возможность управления изменениями, поэтому специалисты Contoso хотят непременно реализовать эту функцию в развертывании Azure.

Contoso [блокирует ресурсы](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources). Любой производственный или компонент отработки отказа должен находиться в группе ресурсов с блокировкой ReadOnly. Это означает, что для изменения или удаления рабочих элементов необходимо будет снять блокировку. Группы ресурсов, не являющиеся продукцией, будут иметь `CanNotDelete` блокировки. Это означает, что полномочные пользователи могут читать или изменять ресурсы, но не могут удалять их.

### <a name="set-up-tagging"></a>Настройка тегов

Для отслеживания ресурсов по мере их добавления все большую важность для Contoso будет приобретать возможность связать ресурсы с соответствующим отделом, клиентом и средой.

Помимо предоставления сведений о ресурсах и владельцах, теги позволяют компании Contoso объединять и группировать ресурсы, а также использовать эти данные в целях обеспечения гибкости.

Компании Contoso необходимо визуализировать свои активы Azure способом, который имеет смысл для бизнеса, например для роли или отдела. Обратите внимание, что ресурсы, находящиеся в разных группах ресурсов, могут иметь одинаковый тег. Contoso создаст классификацию тегов, чтобы все могли использовать одни и те же теги.

| Имя тега | Значение |
| --- | --- |
| `CostCenter` | 12345: это должно быть допустимое место возникновения затрат из системы SAP. |
| `BusinessUnit` | Имя подразделения (из системы SAP). Совпадает с `CostCenter` . |
| `ApplicationTeam` | Псевдоним электронной почты команды, которой принадлежит поддержка для приложения. |
| `CatalogName` | Имя приложения или `SharedServices` для каталога услуг, который поддерживает ресурс. |
| `ServiceManager` | Псевдоним электронной почты ITIL Service Manager для ресурса. |
| `COBPriority` | Приоритет, установленный компанией для BCDR. Значения от 1 до 5. |
| `ENV` | `DEV`, `STG` и `PROD` являются допустимыми значениями, представляющими разработку, промежуточное хранение и рабочую среду. |

Вот несколько примеров:

 ![Теги Azure ](./media/contoso-migration-infrastructure/azure-tag.png)
 _рис. 42. Теги Azure._

После создания тега компания Contoso вернет и создаст новые определения и назначения политик, чтобы принудительно использовать необходимые теги в Организации.

## <a name="step-6-consider-security"></a>Шаг 6. Учет требований к безопасности

Безопасность в облаке играет критически важную роль, поэтому Azure предоставляет широкий спектр средств и возможностей обеспечения безопасности. Они помогают создавать безопасные решения на защищенной платформе Azure. Дополнительные сведения о безопасности Azure см. [в разделе уверенность в надежном облаке](https://azure.microsoft.com/overview/trusted-cloud) .

Contoso следует учесть несколько аспектов:

- **Центр безопасности Azure.** [Центр безопасности Azure](https://docs.microsoft.com/azure/security-center/security-center-intro) обеспечивает унифицированное управление безопасностью и Azure Advanced Threat Protection в гибридных облачных рабочих нагрузках. Используйте его для применения политик безопасности в рабочих нагрузках, для ограничения воздействия на угрозы и обнаружения атак и реагирования на них.
- **Группы безопасности сети:** [Группа безопасности сети (NSG)](https://docs.microsoft.com/azure/virtual-network/security-overview) фильтрует сетевой трафик на основе списка правил безопасности, позволяющих или запрещать сетевой трафик к ресурсам, подключенным к Azure виртуальных сетей.
- **Шифрование данных.** [Шифрование дисков Azure](https://docs.microsoft.com/azure/security/fundamentals/encryption-atrest) — это возможность, которая позволяет шифровать диски виртуальных машин IaaS под управлением Windows и Linux.

### <a name="work-with-the-azure-security-center"></a>Работа с центром безопасности Azure

Компания Contoso ищет краткий обзор уровня безопасности своего нового гибридного облака, а именно его рабочих нагрузок Azure. Поэтому компания решила реализовать центр безопасности Azure со следующими возможностями:

- Централизованное управление политиками
- Непрерывная оценка
- Практические рекомендации

#### <a name="centralize-policy-management"></a>Централизация управления политиками

Благодаря централизованному управлению политиками Contoso обеспечит соответствие требованиям безопасности за счет централизованного управления политиками безопасности во всей среде. Она может просто и быстро реализовать политику, которая применяется ко всем ресурсам Azure.

![Политика безопасности ](./media/contoso-migration-infrastructure/security-policy.png)
 _рис. 43. Политика безопасности._

#### <a name="assess-and-action"></a>Оценка и действие

Компания Contoso будет использовать преимущества непрерывной оценки безопасности, которая наблюдает за безопасностью компьютеров, сетей, хранилищ, данных и приложений, чтобы выявить потенциальные проблемы безопасности.

- Центр безопасности анализирует состояние безопасности ресурсов вычислений, инфраструктуры и данных Contoso, а также состояние безопасности приложений и служб Azure.
- Непрерывная оценка помогает операционной группе компании обнаружить потенциальные проблемы с безопасностью, в том числе системы без обновлений системы безопасности или открытые сетевые порты.
- Contoso хочет убедиться, что все виртуальные машины защищены. Центр безопасности помогает справиться с этой задачей, проверяя работоспособность виртуальных машин и предоставляя приоритетные и действенные рекомендации по устранению уязвимостей в системе безопасности до того, как ими воспользуются злоумышленники.

![Мониторинг ](./media/contoso-migration-infrastructure/monitoring.png)
 _рис. 44. Мониторинг._

### <a name="work-with-nsgs"></a>Работа с группами безопасности сети

Компания Contoso может ограничить сетевой трафик ресурсами в виртуальной сети с помощью группы безопасности сети.

- Группа безопасности сети содержит список правил безопасности, которые разрешают или запрещают входящий и исходящий трафик в зависимости от IP-адреса источника или назначения, порта и протокола.
- Если в подсети действуют правила, они применяются ко всем ее ресурсам. Помимо сетевых интерфейсов к ним относятся экземпляры служб Azure, развернутые в подсети.
- Группы безопасности приложений (ASG) позволяют настроить сетевую безопасность как естественное расширение структуры приложения, что позволяет группировать виртуальные машины и определять политики безопасности сети на основе этих групп ASG, чтобы компания Contoso повторно использовала политику безопасности в масштабе без ручного обслуживания явных IP-адресов. Платформа сама обрабатывает явные IP-адреса и множество наборов правил, позволяя вам сосредоточиться на бизнес-логике. Компания Contoso может указать ASG в качестве источника и назначения в правиле безопасности. После определения политики безопасности компания Contoso может создавать виртуальные машины и назначать их группе.

Компания Contoso реализует сочетание групп безопасности сети и групп безопасности приложений. Руководителей компании волнует управление группами безопасности сети, Это также беспокоится о чрезмерном группы безопасности сети и повышенной сложности работы персонала. Ниже приведены действия специалистов Contoso:

- Весь входящий и исходящий трафик всех подсетей (Север/Юг) будет подвергаться правилу NSG, за исключением подсетей шлюза в сетях-концентраторах.
- Любые брандмауэры и контроллер домена защищаются с помощью групп безопасности сети для подсети и сетевого адаптера.
- Ко всем приложениям в рабочей среде будут применяться группы безопасности приложений.

В Contoso составили модель вышеописанной системы для своих приложений.

![Модель безопасности ](./media/contoso-migration-infrastructure/asg.png)
 _рис. 45. модель безопасности._

Группы безопасности сети, связанные с группами безопасности приложений, будут настроены с наименьшими разрешениями. Благодаря этому из одной части сети в другую смогут передаваться только разрешенные пакеты.

| Действие | Имя | Источник | Назначение | Порт |
| --- | --- | --- | --- | --- |
| `Allow` | `AllowInternetToFE` | `VNET-HUB-EUS1`/`IB-TrustZone` | `APP1-FE` | 80, 443 |
| `Allow` | `AllowWebToApp` | `APP1-FE` | `APP1-APP` | 80, 443 |
| `Allow` | `AllowAppToDB` | `APP1-APP` | `APP1-DB` | 1433 |
| `Deny`  | `DenyAllInbound` | Любой | Любой | Любой |

### <a name="encrypt-data"></a>Шифрование данных

Шифрование дисков Azure интегрируется с Azure Key Vault для управления ключами и секретами шифрования дисков для подписки. Это гарантирует, что все данные на дисках виртуальной машины шифруются при хранении в службе хранилища Azure. Contoso определила, что определенные виртуальные машины требуют шифрования. Contoso будет применять шифрование к виртуальным машинам с клиентами, конфиденциальными или личными данными.

## <a name="conclusion"></a>Заключение

В этой статье описано, как специалисты компании Contoso настроили инфраструктуру и политику Azure для подписки Azure, удостоверения в гибридной среде, аварийного восстановления, сетевого взаимодействия, управления и обеспечения безопасности.

Не все действия, которые необходимо выполнить, необходимы для миграции в облако. В этом случае компания Contoso запланировала сетевую инфраструктуру, которая может выполнять все виды миграций, в то время как безопасность, устойчивость и масштабируемость.

С этой инфраструктурой компания Contoso готова перейти на миграцию и испытать ее.

## <a name="next-steps"></a>Дальнейшие действия

После настройки инфраструктуры Azure компания Contoso готова начать перенос рабочих нагрузок в облако. В разделе [Примеры статей о миграции](./contoso-migration-overview.md#windows-server-workloads) приведено несколько сценариев использования этого примерна инфраструктуры в качестве цели миграции.
